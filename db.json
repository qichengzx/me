{"meta":{"version":1,"warehouse":"2.2.0"},"models":{"Asset":[{"_id":"source/images/geolocation.png","path":"images/geolocation.png","modified":1,"renderable":0},{"_id":"source/images/golang.png","path":"images/golang.png","modified":1,"renderable":0},{"_id":"source/images/mysql-row_number-session-variables.jpg","path":"images/mysql-row_number-session-variables.jpg","modified":1,"renderable":0},{"_id":"source/images/discuz/201510148054_136.jpg","path":"images/discuz/201510148054_136.jpg","modified":1,"renderable":0},{"_id":"source/images/dropbox/20130702165945-558672261.jpg","path":"images/dropbox/20130702165945-558672261.jpg","modified":1,"renderable":0},{"_id":"source/images/go/best-url-shortener-to-make-earn-money.png","path":"images/go/best-url-shortener-to-make-earn-money.png","modified":1,"renderable":0},{"_id":"source/images/go/networktimeline.png","path":"images/go/networktimeline.png","modified":1,"renderable":0},{"_id":"source/images/go/serverpush.svg","path":"images/go/serverpush.svg","modified":1,"renderable":0},{"_id":"source/images/mysql-row-number/mysql-row_number-payments-table.jpg","path":"images/mysql-row-number/mysql-row_number-payments-table.jpg","modified":1,"renderable":0},{"_id":"source/images/mysql-row-number/mysql-row_number-per-group.jpg","path":"images/mysql-row-number/mysql-row_number-per-group.jpg","modified":1,"renderable":0},{"_id":"source/images/rabbitmq/bindings.png","path":"images/rabbitmq/bindings.png","modified":1,"renderable":0},{"_id":"source/images/rabbitmq/consumer.png","path":"images/rabbitmq/consumer.png","modified":1,"renderable":0},{"_id":"source/images/rabbitmq/direct-exchange-multiple.png","path":"images/rabbitmq/direct-exchange-multiple.png","modified":1,"renderable":0},{"_id":"source/images/rabbitmq/direct-exchange.png","path":"images/rabbitmq/direct-exchange.png","modified":1,"renderable":0},{"_id":"source/images/rabbitmq/exchanges.png","path":"images/rabbitmq/exchanges.png","modified":1,"renderable":0},{"_id":"source/images/rabbitmq/prefetch-count.png","path":"images/rabbitmq/prefetch-count.png","modified":1,"renderable":0},{"_id":"source/images/rabbitmq/producer.png","path":"images/rabbitmq/producer.png","modified":1,"renderable":0},{"_id":"source/images/rabbitmq/python-five.png","path":"images/rabbitmq/python-five.png","modified":1,"renderable":0},{"_id":"source/images/rabbitmq/python-four.png","path":"images/rabbitmq/python-four.png","modified":1,"renderable":0},{"_id":"source/images/rabbitmq/python-one.png","path":"images/rabbitmq/python-one.png","modified":1,"renderable":0},{"_id":"source/images/rabbitmq/python-six.png","path":"images/rabbitmq/python-six.png","modified":1,"renderable":0},{"_id":"source/images/rabbitmq/python-three-overall.png","path":"images/rabbitmq/python-three-overall.png","modified":1,"renderable":0},{"_id":"source/images/rabbitmq/python-two.png","path":"images/rabbitmq/python-two.png","modified":1,"renderable":0},{"_id":"source/images/rabbitmq/queue.png","path":"images/rabbitmq/queue.png","modified":1,"renderable":0},{"_id":"source/images/rabbitmq/receiving.png","path":"images/rabbitmq/receiving.png","modified":1,"renderable":0},{"_id":"source/images/rabbitmq/sending.png","path":"images/rabbitmq/sending.png","modified":1,"renderable":0},{"_id":"source/images/redis/redis-300dpi.png","path":"images/redis/redis-300dpi.png","modified":1,"renderable":0},{"_id":"themes/landscape/source/css/style.styl","path":"css/style.styl","modified":1,"renderable":1},{"_id":"themes/landscape/source/fancybox/blank.gif","path":"fancybox/blank.gif","modified":1,"renderable":1},{"_id":"themes/landscape/source/fancybox/fancybox_loading.gif","path":"fancybox/fancybox_loading.gif","modified":1,"renderable":1},{"_id":"themes/landscape/source/fancybox/fancybox_loading@2x.gif","path":"fancybox/fancybox_loading@2x.gif","modified":1,"renderable":1},{"_id":"themes/landscape/source/fancybox/fancybox_overlay.png","path":"fancybox/fancybox_overlay.png","modified":1,"renderable":1},{"_id":"themes/landscape/source/fancybox/fancybox_sprite.png","path":"fancybox/fancybox_sprite.png","modified":1,"renderable":1},{"_id":"themes/landscape/source/fancybox/fancybox_sprite@2x.png","path":"fancybox/fancybox_sprite@2x.png","modified":1,"renderable":1},{"_id":"themes/landscape/source/fancybox/jquery.fancybox.css","path":"fancybox/jquery.fancybox.css","modified":1,"renderable":1},{"_id":"themes/landscape/source/fancybox/jquery.fancybox.pack.js","path":"fancybox/jquery.fancybox.pack.js","modified":1,"renderable":1},{"_id":"themes/landscape/source/fancybox/jquery.fancybox.js","path":"fancybox/jquery.fancybox.js","modified":1,"renderable":1},{"_id":"themes/landscape/source/js/script.js","path":"js/script.js","modified":1,"renderable":1},{"_id":"source/images/backup-database-with-crontab/crontab.jpg","path":"images/backup-database-with-crontab/crontab.jpg","modified":1,"renderable":0},{"_id":"source/images/go/golang-angular2-chat.gif","path":"images/go/golang-angular2-chat.gif","modified":1,"renderable":0},{"_id":"themes/landscape/source/css/fonts/fontawesome-webfont.eot","path":"css/fonts/fontawesome-webfont.eot","modified":1,"renderable":1},{"_id":"themes/landscape/source/css/fonts/FontAwesome.otf","path":"css/fonts/FontAwesome.otf","modified":1,"renderable":1},{"_id":"themes/landscape/source/css/fonts/fontawesome-webfont.woff","path":"css/fonts/fontawesome-webfont.woff","modified":1,"renderable":1},{"_id":"themes/landscape/source/fancybox/helpers/fancybox_buttons.png","path":"fancybox/helpers/fancybox_buttons.png","modified":1,"renderable":1},{"_id":"themes/landscape/source/fancybox/helpers/jquery.fancybox-buttons.css","path":"fancybox/helpers/jquery.fancybox-buttons.css","modified":1,"renderable":1},{"_id":"themes/landscape/source/fancybox/helpers/jquery.fancybox-buttons.js","path":"fancybox/helpers/jquery.fancybox-buttons.js","modified":1,"renderable":1},{"_id":"themes/landscape/source/fancybox/helpers/jquery.fancybox-media.js","path":"fancybox/helpers/jquery.fancybox-media.js","modified":1,"renderable":1},{"_id":"themes/landscape/source/fancybox/helpers/jquery.fancybox-thumbs.css","path":"fancybox/helpers/jquery.fancybox-thumbs.css","modified":1,"renderable":1},{"_id":"themes/landscape/source/fancybox/helpers/jquery.fancybox-thumbs.js","path":"fancybox/helpers/jquery.fancybox-thumbs.js","modified":1,"renderable":1},{"_id":"source/images/BEEC6560-EC03-4027-969D-DBB584A47E69.png","path":"images/BEEC6560-EC03-4027-969D-DBB584A47E69.png","modified":1,"renderable":0},{"_id":"themes/landscape/source/css/fonts/fontawesome-webfont.ttf","path":"css/fonts/fontawesome-webfont.ttf","modified":1,"renderable":1},{"_id":"themes/landscape/source/css/fonts/fontawesome-webfont.svg","path":"css/fonts/fontawesome-webfont.svg","modified":1,"renderable":1},{"_id":"themes/landscape/source/css/images/banner.jpg","path":"css/images/banner.jpg","modified":1,"renderable":1},{"_id":"source/images/php/think201-emergence-of-php7.jpg","path":"images/php/think201-emergence-of-php7.jpg","modified":1,"renderable":0},{"_id":"source/images/go/toutiao.gif","path":"images/go/toutiao.gif","modified":1,"renderable":0}],"Cache":[{"_id":"source/.DS_Store","hash":"1bf9d6a2427bf3a3f7d01157a3b8ccd48862db29","modified":1506242759000},{"_id":"source/.Ulysses-Group.plist","hash":"1e2a5cf475cc6b8b7ca4fcbbc929f79891e9032e","modified":1461751585000},{"_id":"source/.UlyssesRoot","hash":"ca47d5f9247abae24e8ab045999e80b57d1f5e69","modified":1461751585000},{"_id":"themes/landscape/.DS_Store","hash":"b1b3eea9286e4b1aeffb9dd4a16664d52155f105","modified":1461413425000},{"_id":"themes/landscape/Gruntfile.js","hash":"71adaeaac1f3cc56e36c49d549b8d8a72235c9b9","modified":1446904948000},{"_id":"themes/landscape/LICENSE","hash":"c480fce396b23997ee23cc535518ffaaf7f458f8","modified":1446904948000},{"_id":"themes/landscape/README.md","hash":"c7e83cfe8f2c724fc9cac32bd71bb5faf9ceeddb","modified":1446904948000},{"_id":"themes/landscape/_config.yml","hash":"08cc9a62547f027499e2db05836fed697894235c","modified":1447221556000},{"_id":"themes/landscape/package.json","hash":"85358dc34311c6662e841584e206a4679183943f","modified":1446904948000},{"_id":"source/_draft/.Ulysses-Group.plist","hash":"6876b7e627014d2ddb97827053966a2e3f600e4d","modified":1461751585000},{"_id":"source/_draft/.DS_Store","hash":"e30658bb85269f16a1f2b1ae2b875c17217e2f55","modified":1490359470000},{"_id":"source/_draft/create-a-single-page-app-with-go-echo-and-vue.md","hash":"f0b4ba842bff2a8dd55b7990f61c551fc4fdecff","modified":1480841253000},{"_id":"source/_draft/docker-php.md","hash":"bed334015d9b02b71beb5ecb0885bb2c640e53dc","modified":1465628227000},{"_id":"source/_draft/function is_id_card.md","hash":"2dbdda8ed01cd488319a15ee8f0f8a5f30d433d4","modified":1462629975000},{"_id":"source/_draft/install-hifone.md","hash":"0b48bc683399196e516930fd53376114e94485fb","modified":1483358213000},{"_id":"source/_draft/js-.md","hash":"d2586d8c056a73c63c9556fe1f29d32778857172","modified":1447768969000},{"_id":"source/_draft/olympics.md","hash":"c8db994b94a117631f12e306eba0aa522dc14565","modified":1470451227000},{"_id":"source/_draft/sql.md","hash":"4c3a4ab56eb6af846f53fd759bd43f366456e6dd","modified":1456480632000},{"_id":"source/_posts/.DS_Store","hash":"7d39aecc6705dbfa73382630f4510d545b8badc5","modified":1506167601000},{"_id":"source/_posts/.Ulysses-Group.plist","hash":"a2e560ae4a692cf24d3b19bf883eb9aa8ccc93c3","modified":1498575183000},{"_id":"source/_posts/HTTP2-Server-Push.md","hash":"c47011404b425374adb6d4eb8716142d15103f62","modified":1498960842000},{"_id":"source/_posts/Hello-Go.md","hash":"53c2c825e5e97dc7db4de338de512ce147eab072","modified":1473585669000},{"_id":"source/_posts/MySQL实现row_number .md","hash":"4aa835090a46fdb6d6dec367aa0f1e2eb75e2698","modified":1454495240000},{"_id":"source/_posts/MySql-row_number-part-2.md","hash":"1802be092580994c75855619d75f0b40f393e438","modified":1456371321000},{"_id":"source/_posts/React-Native-Fetch.md","hash":"7f714c0d9c3daf6d3758684f27e48d72a283b0d4","modified":1446951113000},{"_id":"source/_posts/Set Up a Private Git Server on a VPS.md","hash":"80238c5b0e79e45b187c6fdc66db2beac009e04c","modified":1446950536000},{"_id":"source/_posts/a-piece-of-interesting-code-of-js-for-function.md","hash":"5bb534dd4eed3a600c59ddcbb82ad63236d02dee","modified":1456391814000},{"_id":"source/_posts/a-sample-redis-queue.md","hash":"e999f8fbbb949981ffb7b83b105036319518efcd","modified":1463293508000},{"_id":"source/_posts/backup-database-with-crontab.md","hash":"b95d7677a81c9946c8b99cc68c40014a9a1eedfb","modified":1461413244000},{"_id":"source/_posts/beego-in-docker.md","hash":"6625e1bbb18f61cd306bed77216ebe64de67de82","modified":1477795767000},{"_id":"source/_posts/cant-post-iqiyi-video-to-discuz.md","hash":"cac938e815268f3f5ccbe8a09eaa36823347508a","modified":1462705045000},{"_id":"source/_posts/convert-xml-to-json-in-golang.md","hash":"1536282410480fc5446293400f7aa65695d7d1c9","modified":1474204745000},{"_id":"source/_posts/custom-data-pagination-in-laravel-with-arrays.md","hash":"706f4ada7080e092db3025e2e49344aec33cdbc0","modified":1477795384000},{"_id":"source/_posts/create-real-time-chat-app-golang-angular-2-websockets.md","hash":"be726a39f40f30ffb33f9cd9093394de2c2adf30","modified":1500092069000},{"_id":"source/_posts/dropbox-sync-hexo-and-autobuild-itself.md","hash":"13a24e0999b201c94ad4f8529913a5df4c1630a2","modified":1450511401000},{"_id":"source/_posts/dropbox-sync-hexo-article.md","hash":"61156aa90ad07a3e6bf232c2028d16db2aafe34f","modified":1461413290000},{"_id":"source/_posts/echarts-pie.md","hash":"47fbb5291371f44ccdb88af9c260f82bcda1b298","modified":1453213504000},{"_id":"source/_posts/export-results-of-mysql-to-excel.md","hash":"a8e91cfdb497d15133dfcf36d16306ca6d7ec893","modified":1448113800000},{"_id":"source/_posts/go-qiubai.md","hash":"07f7ea3168c038cc331783df84ddc0f93ea2b1b4","modified":1506169628000},{"_id":"source/_posts/hello-world.md","hash":"a2f85773fb1f96703fc1946fd2df37a5f382f758","modified":1446950108000},{"_id":"source/_posts/insert-filter-in-beego.md","hash":"be7a69c2d66f282c427e2cf0265781b613a55195","modified":1498575191000},{"_id":"source/_posts/install-yaf-on-mac.md","hash":"ccc8c6c641cd1c9f739ec1cce6e7bac11d7d7bca","modified":1480511797000},{"_id":"source/_posts/js-names.md","hash":"3f00d9d839f57a3a91e819ed7214c34469b731d3","modified":1447856500000},{"_id":"source/_posts/nodejs-mysql.md","hash":"ad297f9134c68757f200c7e5aad7974251ed1d74","modified":1449152647000},{"_id":"source/_posts/leetcode-array-partition-i.md","hash":"dba7f0c43d9d58b8dc622ade7326375ad3760af2","modified":1502592842000},{"_id":"source/_posts/order-by-distance-in-mysql.md","hash":"dd086f63b8a6cbe03dc85793724ff390104d5f10","modified":1498573553000},{"_id":"source/_posts/php-post-file-with-curl.md","hash":"f9d13dbbb5488ed65ebd48f9102674a4a5813deb","modified":1467508440000},{"_id":"source/_posts/php-rabbitmq-tutorial-five.md","hash":"b335168d8efc8b44d938b7091c9770002950c690","modified":1462629975000},{"_id":"source/_posts/php-rabbitmq-tutorial-one.md","hash":"085a0b5e3571c58e003f07293259931e39522443","modified":1462629975000},{"_id":"source/_posts/php-rabbitmq-tutorial-four.md","hash":"369b9f83e028cffb442421f24cb6a16f766572a0","modified":1462629975000},{"_id":"source/_posts/php-rabbitmq-tutorial-six.md","hash":"713375758576d02bf690937b171dc6d56d312262","modified":1462630107000},{"_id":"source/_posts/php-rabbitmq-tutorial-three.md","hash":"3fc9365a0c23622e7a327db5d27246e8b98cd90e","modified":1462629975000},{"_id":"source/_posts/php-rabbitmq-tutorial-two.md","hash":"2839e73204450b007638ce908a4140ef466c660b","modified":1462629975000},{"_id":"source/_posts/php-use-pdo-cache-query-result-with-redis.md","hash":"4b5e5e3425e42d47ee2b1b69639ee43e6918b5fb","modified":1449365461000},{"_id":"source/_posts/placeholder-animate.md","hash":"db6da6445381f0b6d5e9d743ee1aac6b668bf503","modified":1452605604000},{"_id":"source/_posts/redis-geo-with-redigo-in-golang-part-1.md","hash":"dc4b67e4d33be31efa9958309c41c37e0253563a","modified":1506162233000},{"_id":"source/_posts/redis-geo-with-redigo-in-golang-part-2.md","hash":"1e112c5bd8b5ca9f1563580ff5dea5b43a07550c","modified":1506246542000},{"_id":"source/_posts/redis-geo-with-redigo-in-golang-part-3.md","hash":"afbb5e536ab0030845c4fdeda3557ed0a176910d","modified":1506515671000},{"_id":"source/_posts/secure-your-website-with-lets-encrypt.md","hash":"243000fdc130254c8b9fb22634d3ce2dd2e49654","modified":1450531905000},{"_id":"source/_posts/shortlen-url-by-go.md","hash":"4f6ef348a63da633868fcca4922955316b3bc15d","modified":1482848811000},{"_id":"source/_posts/time-widget-for-hexo.md","hash":"9bb8f0f98b1314b186e72b324b24074764a4a362","modified":1447234085000},{"_id":"source/_posts/toutiao-images-spider-by-golang.md","hash":"54f6036483bc19c50fba4b1c810604cede7ebac1","modified":1481895483000},{"_id":"source/images/.DS_Store","hash":"52c534511b9b8b802e35b1c5772ac0d7209a80c5","modified":1498573144000},{"_id":"source/images/.Ulysses-Group.plist","hash":"7f5579678d61c1b478ba3bbc6d7b474911bc457f","modified":1461752525000},{"_id":"source/images/geolocation.png","hash":"190311aa97f9109d02efbf2532dff7b00513d7f7","modified":1498572714000},{"_id":"source/images/golang.png","hash":"77a68c8e17a485d0ce129715fce4d46c7ea9d124","modified":1474083040000},{"_id":"source/images/mysql-row_number-session-variables.jpg","hash":"bd377ee5ba40e7f3652623b4ddaffc79adb3185f","modified":1458657491000},{"_id":"source/static/.DS_Store","hash":"1429b9c08aeb8c15b3499d150e011720f8ff275c","modified":1473592614000},{"_id":"source/static/.Ulysses-Group.plist","hash":"6afc039d1f0001ae7c40c17908ce3422238933e9","modified":1461751585000},{"_id":"themes/landscape/layout/.DS_Store","hash":"95505c4ed521e67bb8624ab0e58f7f42681a3e21","modified":1453258572000},{"_id":"themes/landscape/layout/archive.ejs","hash":"2703b07cc8ac64ae46d1d263f4653013c7e1666b","modified":1446904948000},{"_id":"themes/landscape/layout/category.ejs","hash":"765426a9c8236828dc34759e604cc2c52292835a","modified":1446904948000},{"_id":"themes/landscape/layout/index.ejs","hash":"aa1b4456907bdb43e629be3931547e2d29ac58c8","modified":1446904948000},{"_id":"themes/landscape/layout/layout.ejs","hash":"f155824ca6130080bb057fa3e868a743c69c4cf5","modified":1446904948000},{"_id":"themes/landscape/layout/page.ejs","hash":"7d80e4e36b14d30a7cd2ac1f61376d9ebf264e8b","modified":1446904948000},{"_id":"themes/landscape/layout/post.ejs","hash":"7d80e4e36b14d30a7cd2ac1f61376d9ebf264e8b","modified":1446904948000},{"_id":"themes/landscape/layout/tag.ejs","hash":"eaa7b4ccb2ca7befb90142e4e68995fb1ea68b2e","modified":1446904948000},{"_id":"themes/landscape/scripts/.DS_Store","hash":"fe424674c982006112a8fc98bc971c9063e86dcc","modified":1461413425000},{"_id":"themes/landscape/scripts/fancybox.js","hash":"aa411cd072399df1ddc8e2181a3204678a5177d9","modified":1446904948000},{"_id":"themes/landscape/source/.DS_Store","hash":"f30ccb10baee9919713fa5d32ee7bddb0837a13e","modified":1453356781000},{"_id":"source/_posts/images/.DS_Store","hash":"f2e8c306d47c7d9a30cfd215910cc539d24e6427","modified":1474083295000},{"_id":"source/_posts/images/.Ulysses-Group.plist","hash":"afe320d56181f401ab1bf2155c15f26d62d19a98","modified":1461751585000},{"_id":"source/_posts/images/mysql-row_number-session-variables.jpg","hash":"bd377ee5ba40e7f3652623b4ddaffc79adb3185f","modified":1458657491000},{"_id":"source/images/discuz/201510148054_136.jpg","hash":"79167c00b9ec2c9a43e4185c6b16c24673afb826","modified":1462704248000},{"_id":"source/images/dropbox/20130702165945-558672261.jpg","hash":"98f5d7135501a705f3f462870706d5f578bded36","modified":1461413310000},{"_id":"source/images/go/best-url-shortener-to-make-earn-money.png","hash":"cd440d67b00fa4f5af7ebe0526c1e6d465a36616","modified":1482848038000},{"_id":"source/images/go/networktimeline.png","hash":"7abf025a474eaad8a92cd11697670b4e4204f525","modified":1498923277000},{"_id":"source/images/go/serverpush.svg","hash":"4624d00ec6083911df14d1d978585c550c40e5d5","modified":1498922319000},{"_id":"source/images/mysql-row-number/.Ulysses-Group.plist","hash":"14200f753de6885dafd397a35bd78b20c4012280","modified":1460642350000},{"_id":"source/images/mysql-row-number/mysql-row_number-payments-table.jpg","hash":"4b364113e62a4f651ad3c996b1190ea0835997b5","modified":1456308181000},{"_id":"source/images/mysql-row-number/mysql-row_number-per-group.jpg","hash":"1828463d30d31bd64dca509fda58eb0f69a2264e","modified":1456367414000},{"_id":"source/images/php/.DS_Store","hash":"df2fbeb1400acda0909a32c1cf6bf492f1121e07","modified":1498573152000},{"_id":"source/images/rabbitmq/.DS_Store","hash":"0668f92b503205f075174ef29dde4c4d4189a5c3","modified":1462632495000},{"_id":"source/images/rabbitmq/.Ulysses-Group.plist","hash":"14200f753de6885dafd397a35bd78b20c4012280","modified":1460642350000},{"_id":"source/images/rabbitmq/bindings.png","hash":"8e4ef985ee8748a28ec78ef2a20a6f0df776a1c3","modified":1458657250000},{"_id":"source/images/rabbitmq/consumer.png","hash":"a539ac951a0cc71fb7d816415ec9aea432ed023f","modified":1457336555000},{"_id":"source/images/rabbitmq/direct-exchange-multiple.png","hash":"7d4ec53397fec3fdec003e512821677a01d93347","modified":1461492942000},{"_id":"source/images/rabbitmq/direct-exchange.png","hash":"5930f4ad16f3ae7b1dfe3d022f38db510b5bb119","modified":1461489787000},{"_id":"source/images/rabbitmq/exchanges.png","hash":"35112ed9950e806fefec8d0d98f6820582f8eed2","modified":1458655469000},{"_id":"source/images/rabbitmq/prefetch-count.png","hash":"95ccffa61abe852f75b4c078bdc9fac4e7f308a5","modified":1460875057000},{"_id":"source/images/rabbitmq/producer.png","hash":"a7fa166089fd4e9d87ecf1c0e6ae852552832a7e","modified":1457336546000},{"_id":"source/images/rabbitmq/python-five.png","hash":"c8ef4fdd704d7cd7d8ca8a782cff7a39680836c1","modified":1462236883000},{"_id":"source/images/rabbitmq/python-four.png","hash":"8853dc0c66f3742a115ecb6caa126cf907de774d","modified":1461592757000},{"_id":"source/images/rabbitmq/python-one.png","hash":"ce4caf7652d730fc2e3d6e75ed1ec0dc11c93166","modified":1457337589000},{"_id":"source/images/rabbitmq/python-six.png","hash":"072886302a6c7b4845dbcc4169994b2f67eab097","modified":1462629975000},{"_id":"source/images/rabbitmq/python-three-overall.png","hash":"89cc2bde76df92fe0f9e6acb1c9711cf8ae9eca9","modified":1461412537000},{"_id":"source/images/rabbitmq/python-two.png","hash":"e8aceb1782673af6a34d3b2133785caf8b8ef5a2","modified":1460875126000},{"_id":"source/images/rabbitmq/queue.png","hash":"f27586f970888b0311df6bdf971c43f7af2e0d4b","modified":1457336551000},{"_id":"source/images/rabbitmq/receiving.png","hash":"cc4f260212af5829f14336f14eeff1d33c919bfe","modified":1457358255000},{"_id":"source/images/rabbitmq/sending.png","hash":"007b8d064558478c7e96128df720e5ab7988f938","modified":1457357890000},{"_id":"source/images/redis/redis-300dpi.png","hash":"147705873d68eadbcd28e037bbd89d14f0b6cb09","modified":1463293480000},{"_id":"source/static/js/.DS_Store","hash":"df2fbeb1400acda0909a32c1cf6bf492f1121e07","modified":1473594933000},{"_id":"source/static/js/.Ulysses-Group.plist","hash":"535d9ff6fd5c05bf026a79ea07d32c2d65fb7ca3","modified":1461751585000},{"_id":"themes/landscape/layout/_partial/.DS_Store","hash":"c08a40c3b469153e56b06a64ca69a0c2ee878d40","modified":1453256408000},{"_id":"themes/landscape/layout/_partial/after-footer.ejs","hash":"15aef68f33978ebc5915ab457014b9084d540f59","modified":1498961020000},{"_id":"themes/landscape/layout/_partial/archive-post.ejs","hash":"c7a71425a946d05414c069ec91811b5c09a92c47","modified":1446946820000},{"_id":"themes/landscape/layout/_partial/archive.ejs","hash":"d7de6421497ffaf65e4f5fe4bed71fcea51fde80","modified":1446904948000},{"_id":"themes/landscape/layout/_partial/article.ejs","hash":"edd5b47992f18a4b1451daff118be5a837fd4b5e","modified":1498961036000},{"_id":"themes/landscape/layout/_partial/footer.ejs","hash":"3479e4a68c31dbee6f9eb385998a9f51449413cc","modified":1481978146000},{"_id":"themes/landscape/layout/_partial/google-analytics.ejs","hash":"f921e7f9223d7c95165e0f835f353b2938e40c45","modified":1446904948000},{"_id":"themes/landscape/layout/_partial/head.ejs","hash":"570056b15f9352710ddae64fe02777ebb258b7d9","modified":1483357190000},{"_id":"themes/landscape/layout/_partial/header.ejs","hash":"6387a93dad7c3d778eb91e3821852fbf6813880c","modified":1446904948000},{"_id":"themes/landscape/layout/_partial/mobile-nav.ejs","hash":"e952a532dfc583930a666b9d4479c32d4a84b44e","modified":1446904948000},{"_id":"themes/landscape/layout/_partial/sidebar.ejs","hash":"930da35cc2d447a92e5ee8f835735e6fd2232469","modified":1446904948000},{"_id":"themes/landscape/layout/_widget/archive.ejs","hash":"985fbeb01142b9d526cda8ebc372c1d361d69a6b","modified":1446904948000},{"_id":"themes/landscape/layout/_widget/category.ejs","hash":"36ab37878129d152e3cbdeb839c08e52af1acd58","modified":1446904948000},{"_id":"themes/landscape/layout/_widget/clock.ejs","hash":"e7da70219d455c7082b9a4be12f1b823effa790e","modified":1481978187000},{"_id":"themes/landscape/layout/_widget/recent_posts.ejs","hash":"feba7c00fa59ba13bf870b358a499fde4473d335","modified":1446904948000},{"_id":"themes/landscape/layout/_widget/tag.ejs","hash":"b3f321ddda6be2702a286d5b11af9533509506fb","modified":1446904948000},{"_id":"themes/landscape/layout/_widget/tagcloud.ejs","hash":"34dc8cdd96cdb41dd11cb7513f13714373e5104a","modified":1446904948000},{"_id":"themes/landscape/source/css/.DS_Store","hash":"90ea9ac439158fc131a4ac2eda185843f5e6d1b0","modified":1453356812000},{"_id":"themes/landscape/source/css/_extend.styl","hash":"222fbe6d222531d61c1ef0f868c90f747b1c2ced","modified":1446904948000},{"_id":"themes/landscape/source/css/_variables.styl","hash":"5e37a6571caf87149af83ac1cc0cdef99f117350","modified":1453356857000},{"_id":"themes/landscape/source/css/style.styl","hash":"a70d9c44dac348d742702f6ba87e5bb3084d65db","modified":1446904948000},{"_id":"themes/landscape/source/fancybox/blank.gif","hash":"2daeaa8b5f19f0bc209d976c02bd6acb51b00b0a","modified":1446904948000},{"_id":"themes/landscape/source/fancybox/fancybox_loading.gif","hash":"1a755fb2599f3a313cc6cfdb14df043f8c14a99c","modified":1446904948000},{"_id":"themes/landscape/source/fancybox/fancybox_loading@2x.gif","hash":"273b123496a42ba45c3416adb027cd99745058b0","modified":1446904948000},{"_id":"themes/landscape/source/fancybox/fancybox_overlay.png","hash":"b3a4ee645ba494f52840ef8412015ba0f465dbe0","modified":1446904948000},{"_id":"themes/landscape/source/fancybox/fancybox_sprite.png","hash":"17df19f97628e77be09c352bf27425faea248251","modified":1446904948000},{"_id":"themes/landscape/source/fancybox/fancybox_sprite@2x.png","hash":"30c58913f327e28f466a00f4c1ac8001b560aed8","modified":1446904948000},{"_id":"themes/landscape/source/fancybox/jquery.fancybox.css","hash":"aaa582fb9eb4b7092dc69fcb2d5b1c20cca58ab6","modified":1446904948000},{"_id":"themes/landscape/source/fancybox/jquery.fancybox.pack.js","hash":"9e0d51ca1dbe66f6c0c7aefd552dc8122e694a6e","modified":1446904948000},{"_id":"themes/landscape/source/fancybox/jquery.fancybox.js","hash":"d08b03a42d5c4ba456ef8ba33116fdbb7a9cabed","modified":1446904948000},{"_id":"themes/landscape/source/js/script.js","hash":"763d10ac32044b3ca142fe5ffd5fdcb96376708a","modified":1447221581000},{"_id":"source/static/js/jquery.min.js","hash":"c72c1735b4d903d90dd51225ebefb8c74ebbc51f","modified":1473592495000},{"_id":"source/_posts/images/rabbitmq/.DS_Store","hash":"158e3bdd36d3abc5e77bcf43c49686b390b5f66e","modified":1461413164000},{"_id":"source/_posts/images/rabbitmq/.Ulysses-Group.plist","hash":"14200f753de6885dafd397a35bd78b20c4012280","modified":1460642350000},{"_id":"source/_posts/images/rabbitmq/consumer.png","hash":"a539ac951a0cc71fb7d816415ec9aea432ed023f","modified":1457336555000},{"_id":"source/_posts/images/rabbitmq/bindings.png","hash":"8e4ef985ee8748a28ec78ef2a20a6f0df776a1c3","modified":1458657250000},{"_id":"source/_posts/images/rabbitmq/exchanges.png","hash":"35112ed9950e806fefec8d0d98f6820582f8eed2","modified":1458655469000},{"_id":"source/_posts/images/rabbitmq/prefetch-count.png","hash":"95ccffa61abe852f75b4c078bdc9fac4e7f308a5","modified":1460875057000},{"_id":"source/_posts/images/rabbitmq/producer.png","hash":"a7fa166089fd4e9d87ecf1c0e6ae852552832a7e","modified":1457336546000},{"_id":"source/_posts/images/rabbitmq/python-one.png","hash":"ce4caf7652d730fc2e3d6e75ed1ec0dc11c93166","modified":1457337589000},{"_id":"source/_posts/images/rabbitmq/python-two.png","hash":"e8aceb1782673af6a34d3b2133785caf8b8ef5a2","modified":1460875126000},{"_id":"source/_posts/images/rabbitmq/queue.png","hash":"f27586f970888b0311df6bdf971c43f7af2e0d4b","modified":1457336551000},{"_id":"source/images/backup-database-with-crontab/crontab.jpg","hash":"8986572fb1d8dc02cdeba92422bdfb25db37bac3","modified":1461413221000},{"_id":"source/images/go/golang-angular2-chat.gif","hash":"3c1e599e894d5d9c9c376d873823f8520042a55c","modified":1500084125000},{"_id":"themes/landscape/layout/_partial/post/category.ejs","hash":"c6bcd0e04271ffca81da25bcff5adf3d46f02fc0","modified":1446904948000},{"_id":"themes/landscape/layout/_partial/post/date.ejs","hash":"6197802873157656e3077c5099a7dda3d3b01c29","modified":1446904948000},{"_id":"themes/landscape/layout/_partial/post/gallery.ejs","hash":"3d9d81a3c693ff2378ef06ddb6810254e509de5b","modified":1446904948000},{"_id":"themes/landscape/layout/_partial/post/nav.ejs","hash":"f26d30355ba9144c51e700e8edc6a4ab6144ff9a","modified":1446904948000},{"_id":"themes/landscape/layout/_partial/post/tag.ejs","hash":"2fcb0bf9c8847a644167a27824c9bb19ac74dd14","modified":1446904948000},{"_id":"themes/landscape/layout/_partial/post/title.ejs","hash":"2f275739b6f1193c123646a5a31f37d48644c667","modified":1446904948000},{"_id":"themes/landscape/source/css/_partial/.DS_Store","hash":"13c0cd42622b15a05429e8cce236700a9d6081fa","modified":1453356812000},{"_id":"themes/landscape/source/css/_partial/archive.styl","hash":"db15f5677dc68f1730e82190bab69c24611ca292","modified":1446904948000},{"_id":"themes/landscape/source/css/_partial/article.styl","hash":"10685f8787a79f79c9a26c2f943253450c498e3e","modified":1446904948000},{"_id":"themes/landscape/source/css/_partial/comment.styl","hash":"79d280d8d203abb3bd933ca9b8e38c78ec684987","modified":1446904948000},{"_id":"themes/landscape/source/css/_partial/footer.styl","hash":"e35a060b8512031048919709a8e7b1ec0e40bc1b","modified":1446904948000},{"_id":"themes/landscape/source/css/_partial/header.styl","hash":"85ab11e082f4dd86dde72bed653d57ec5381f30c","modified":1446904948000},{"_id":"themes/landscape/source/css/_partial/highlight.styl","hash":"36eefe6332b86b66023a9884b754d305235846b4","modified":1446904948000},{"_id":"themes/landscape/source/css/_partial/mobile.styl","hash":"a399cf9e1e1cec3e4269066e2948d7ae5854d745","modified":1453356829000},{"_id":"themes/landscape/source/css/_partial/sidebar-aside.styl","hash":"890349df5145abf46ce7712010c89237900b3713","modified":1446904948000},{"_id":"themes/landscape/source/css/_partial/sidebar-bottom.styl","hash":"bc5487b9a0bfe5f745423331824d3f3637ccd430","modified":1446904948000},{"_id":"themes/landscape/source/css/_partial/sidebar.styl","hash":"f092c620089a6832c2f95253811a70c12da60940","modified":1447221410000},{"_id":"themes/landscape/source/css/_partial/time.styl","hash":"5ec17131aad42e62f2ba1ad3290f0b34bd4e4152","modified":1447221355000},{"_id":"themes/landscape/source/css/_util/grid.styl","hash":"0bf55ee5d09f193e249083602ac5fcdb1e571aed","modified":1446904948000},{"_id":"themes/landscape/source/css/_util/mixin.styl","hash":"44f32767d9fd3c1c08a60d91f181ee53c8f0dbb3","modified":1446904948000},{"_id":"themes/landscape/source/css/fonts/fontawesome-webfont.eot","hash":"7619748fe34c64fb157a57f6d4ef3678f63a8f5e","modified":1446904948000},{"_id":"themes/landscape/source/css/fonts/FontAwesome.otf","hash":"b5b4f9be85f91f10799e87a083da1d050f842734","modified":1446904948000},{"_id":"themes/landscape/source/css/fonts/fontawesome-webfont.woff","hash":"04c3bf56d87a0828935bd6b4aee859995f321693","modified":1446904948000},{"_id":"themes/landscape/source/fancybox/helpers/fancybox_buttons.png","hash":"e385b139516c6813dcd64b8fc431c364ceafe5f3","modified":1446904948000},{"_id":"themes/landscape/source/fancybox/helpers/jquery.fancybox-buttons.css","hash":"1a9d8e5c22b371fcc69d4dbbb823d9c39f04c0c8","modified":1446904948000},{"_id":"themes/landscape/source/fancybox/helpers/jquery.fancybox-buttons.js","hash":"dc3645529a4bf72983a39fa34c1eb9146e082019","modified":1446904948000},{"_id":"themes/landscape/source/fancybox/helpers/jquery.fancybox-media.js","hash":"294420f9ff20f4e3584d212b0c262a00a96ecdb3","modified":1446904948000},{"_id":"themes/landscape/source/fancybox/helpers/jquery.fancybox-thumbs.css","hash":"4ac329c16a5277592fc12a37cca3d72ca4ec292f","modified":1446904948000},{"_id":"themes/landscape/source/fancybox/helpers/jquery.fancybox-thumbs.js","hash":"47da1ae5401c24b5c17cc18e2730780f5c1a7a0c","modified":1446904948000},{"_id":"source/images/BEEC6560-EC03-4027-969D-DBB584A47E69.png","hash":"0d40297e3a5bb4698c304eb031f5444cbeb41729","modified":1458657486000},{"_id":"themes/landscape/source/css/fonts/fontawesome-webfont.ttf","hash":"7f09c97f333917034ad08fa7295e916c9f72fd3f","modified":1446904948000},{"_id":"source/_posts/images/BEEC6560-EC03-4027-969D-DBB584A47E69.png","hash":"0d40297e3a5bb4698c304eb031f5444cbeb41729","modified":1458657486000},{"_id":"themes/landscape/source/css/fonts/fontawesome-webfont.svg","hash":"46fcc0194d75a0ddac0a038aee41b23456784814","modified":1446904948000},{"_id":"themes/landscape/source/css/images/banner.jpg","hash":"843d9d47bf2b7b75495db11b3d765efaaae442a9","modified":1446904948000},{"_id":"source/images/php/think201-emergence-of-php7.jpg","hash":"3824234a45ff52d9ff84ec0da53cb0e53e4d681d","modified":1480511797000},{"_id":"source/images/go/toutiao.gif","hash":"6f216bd5ef0632146018346c804186beb84b5705","modified":1481895483000}],"Category":[{"name":"golang","_id":"cj830jvcy0002ul0r0q35ffni"},{"name":"mysql","_id":"cj830jvda000cul0rt6fq41om"},{"name":"javascript","_id":"cj830jvdh000oul0rdgtuqr7e"},{"name":"php","_id":"cj830jvdn000wul0r5fr74bn5"},{"name":"linux","_id":"cj830jvdr0014ul0rhm684gy3"}],"Data":[],"Page":[{"_content":"/*! jQuery v3.1.0 | (c) jQuery Foundation | jquery.org/license */\n!function(a,b){\"use strict\";\"object\"==typeof module&&\"object\"==typeof module.exports?module.exports=a.document?b(a,!0):function(a){if(!a.document)throw new Error(\"jQuery requires a window with a document\");return b(a)}:b(a)}(\"undefined\"!=typeof window?window:this,function(a,b){\"use strict\";var c=[],d=a.document,e=Object.getPrototypeOf,f=c.slice,g=c.concat,h=c.push,i=c.indexOf,j={},k=j.toString,l=j.hasOwnProperty,m=l.toString,n=m.call(Object),o={};function p(a,b){b=b||d;var c=b.createElement(\"script\");c.text=a,b.head.appendChild(c).parentNode.removeChild(c)}var q=\"3.1.0\",r=function(a,b){return new r.fn.init(a,b)},s=/^[\\s\\uFEFF\\xA0]+|[\\s\\uFEFF\\xA0]+$/g,t=/^-ms-/,u=/-([a-z])/g,v=function(a,b){return b.toUpperCase()};r.fn=r.prototype={jquery:q,constructor:r,length:0,toArray:function(){return f.call(this)},get:function(a){return null!=a?a<0?this[a+this.length]:this[a]:f.call(this)},pushStack:function(a){var b=r.merge(this.constructor(),a);return b.prevObject=this,b},each:function(a){return r.each(this,a)},map:function(a){return this.pushStack(r.map(this,function(b,c){return a.call(b,c,b)}))},slice:function(){return this.pushStack(f.apply(this,arguments))},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},eq:function(a){var b=this.length,c=+a+(a<0?b:0);return this.pushStack(c>=0&&c<b?[this[c]]:[])},end:function(){return this.prevObject||this.constructor()},push:h,sort:c.sort,splice:c.splice},r.extend=r.fn.extend=function(){var a,b,c,d,e,f,g=arguments[0]||{},h=1,i=arguments.length,j=!1;for(\"boolean\"==typeof g&&(j=g,g=arguments[h]||{},h++),\"object\"==typeof g||r.isFunction(g)||(g={}),h===i&&(g=this,h--);h<i;h++)if(null!=(a=arguments[h]))for(b in a)c=g[b],d=a[b],g!==d&&(j&&d&&(r.isPlainObject(d)||(e=r.isArray(d)))?(e?(e=!1,f=c&&r.isArray(c)?c:[]):f=c&&r.isPlainObject(c)?c:{},g[b]=r.extend(j,f,d)):void 0!==d&&(g[b]=d));return g},r.extend({expando:\"jQuery\"+(q+Math.random()).replace(/\\D/g,\"\"),isReady:!0,error:function(a){throw new Error(a)},noop:function(){},isFunction:function(a){return\"function\"===r.type(a)},isArray:Array.isArray,isWindow:function(a){return null!=a&&a===a.window},isNumeric:function(a){var b=r.type(a);return(\"number\"===b||\"string\"===b)&&!isNaN(a-parseFloat(a))},isPlainObject:function(a){var b,c;return!(!a||\"[object Object]\"!==k.call(a))&&(!(b=e(a))||(c=l.call(b,\"constructor\")&&b.constructor,\"function\"==typeof c&&m.call(c)===n))},isEmptyObject:function(a){var b;for(b in a)return!1;return!0},type:function(a){return null==a?a+\"\":\"object\"==typeof a||\"function\"==typeof a?j[k.call(a)]||\"object\":typeof a},globalEval:function(a){p(a)},camelCase:function(a){return a.replace(t,\"ms-\").replace(u,v)},nodeName:function(a,b){return a.nodeName&&a.nodeName.toLowerCase()===b.toLowerCase()},each:function(a,b){var c,d=0;if(w(a)){for(c=a.length;d<c;d++)if(b.call(a[d],d,a[d])===!1)break}else for(d in a)if(b.call(a[d],d,a[d])===!1)break;return a},trim:function(a){return null==a?\"\":(a+\"\").replace(s,\"\")},makeArray:function(a,b){var c=b||[];return null!=a&&(w(Object(a))?r.merge(c,\"string\"==typeof a?[a]:a):h.call(c,a)),c},inArray:function(a,b,c){return null==b?-1:i.call(b,a,c)},merge:function(a,b){for(var c=+b.length,d=0,e=a.length;d<c;d++)a[e++]=b[d];return a.length=e,a},grep:function(a,b,c){for(var d,e=[],f=0,g=a.length,h=!c;f<g;f++)d=!b(a[f],f),d!==h&&e.push(a[f]);return e},map:function(a,b,c){var d,e,f=0,h=[];if(w(a))for(d=a.length;f<d;f++)e=b(a[f],f,c),null!=e&&h.push(e);else for(f in a)e=b(a[f],f,c),null!=e&&h.push(e);return g.apply([],h)},guid:1,proxy:function(a,b){var c,d,e;if(\"string\"==typeof b&&(c=a[b],b=a,a=c),r.isFunction(a))return d=f.call(arguments,2),e=function(){return a.apply(b||this,d.concat(f.call(arguments)))},e.guid=a.guid=a.guid||r.guid++,e},now:Date.now,support:o}),\"function\"==typeof Symbol&&(r.fn[Symbol.iterator]=c[Symbol.iterator]),r.each(\"Boolean Number String Function Array Date RegExp Object Error Symbol\".split(\" \"),function(a,b){j[\"[object \"+b+\"]\"]=b.toLowerCase()});function w(a){var b=!!a&&\"length\"in a&&a.length,c=r.type(a);return\"function\"!==c&&!r.isWindow(a)&&(\"array\"===c||0===b||\"number\"==typeof b&&b>0&&b-1 in a)}var x=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u=\"sizzle\"+1*new Date,v=a.document,w=0,x=0,y=ha(),z=ha(),A=ha(),B=function(a,b){return a===b&&(l=!0),0},C={}.hasOwnProperty,D=[],E=D.pop,F=D.push,G=D.push,H=D.slice,I=function(a,b){for(var c=0,d=a.length;c<d;c++)if(a[c]===b)return c;return-1},J=\"checked|selected|async|autofocus|autoplay|controls|defer|disabled|hidden|ismap|loop|multiple|open|readonly|required|scoped\",K=\"[\\\\x20\\\\t\\\\r\\\\n\\\\f]\",L=\"(?:\\\\\\\\.|[\\\\w-]|[^\\0-\\\\xa0])+\",M=\"\\\\[\"+K+\"*(\"+L+\")(?:\"+K+\"*([*^$|!~]?=)\"+K+\"*(?:'((?:\\\\\\\\.|[^\\\\\\\\'])*)'|\\\"((?:\\\\\\\\.|[^\\\\\\\\\\\"])*)\\\"|(\"+L+\"))|)\"+K+\"*\\\\]\",N=\":(\"+L+\")(?:\\\\((('((?:\\\\\\\\.|[^\\\\\\\\'])*)'|\\\"((?:\\\\\\\\.|[^\\\\\\\\\\\"])*)\\\")|((?:\\\\\\\\.|[^\\\\\\\\()[\\\\]]|\"+M+\")*)|.*)\\\\)|)\",O=new RegExp(K+\"+\",\"g\"),P=new RegExp(\"^\"+K+\"+|((?:^|[^\\\\\\\\])(?:\\\\\\\\.)*)\"+K+\"+$\",\"g\"),Q=new RegExp(\"^\"+K+\"*,\"+K+\"*\"),R=new RegExp(\"^\"+K+\"*([>+~]|\"+K+\")\"+K+\"*\"),S=new RegExp(\"=\"+K+\"*([^\\\\]'\\\"]*?)\"+K+\"*\\\\]\",\"g\"),T=new RegExp(N),U=new RegExp(\"^\"+L+\"$\"),V={ID:new RegExp(\"^#(\"+L+\")\"),CLASS:new RegExp(\"^\\\\.(\"+L+\")\"),TAG:new RegExp(\"^(\"+L+\"|[*])\"),ATTR:new RegExp(\"^\"+M),PSEUDO:new RegExp(\"^\"+N),CHILD:new RegExp(\"^:(only|first|last|nth|nth-last)-(child|of-type)(?:\\\\(\"+K+\"*(even|odd|(([+-]|)(\\\\d*)n|)\"+K+\"*(?:([+-]|)\"+K+\"*(\\\\d+)|))\"+K+\"*\\\\)|)\",\"i\"),bool:new RegExp(\"^(?:\"+J+\")$\",\"i\"),needsContext:new RegExp(\"^\"+K+\"*[>+~]|:(even|odd|eq|gt|lt|nth|first|last)(?:\\\\(\"+K+\"*((?:-\\\\d)?\\\\d*)\"+K+\"*\\\\)|)(?=[^-]|$)\",\"i\")},W=/^(?:input|select|textarea|button)$/i,X=/^h\\d$/i,Y=/^[^{]+\\{\\s*\\[native \\w/,Z=/^(?:#([\\w-]+)|(\\w+)|\\.([\\w-]+))$/,$=/[+~]/,_=new RegExp(\"\\\\\\\\([\\\\da-f]{1,6}\"+K+\"?|(\"+K+\")|.)\",\"ig\"),aa=function(a,b,c){var d=\"0x\"+b-65536;return d!==d||c?b:d<0?String.fromCharCode(d+65536):String.fromCharCode(d>>10|55296,1023&d|56320)},ba=/([\\0-\\x1f\\x7f]|^-?\\d)|^-$|[^\\x80-\\uFFFF\\w-]/g,ca=function(a,b){return b?\"\\0\"===a?\"\\ufffd\":a.slice(0,-1)+\"\\\\\"+a.charCodeAt(a.length-1).toString(16)+\" \":\"\\\\\"+a},da=function(){m()},ea=ta(function(a){return a.disabled===!0},{dir:\"parentNode\",next:\"legend\"});try{G.apply(D=H.call(v.childNodes),v.childNodes),D[v.childNodes.length].nodeType}catch(fa){G={apply:D.length?function(a,b){F.apply(a,H.call(b))}:function(a,b){var c=a.length,d=0;while(a[c++]=b[d++]);a.length=c-1}}}function ga(a,b,d,e){var f,h,j,k,l,o,r,s=b&&b.ownerDocument,w=b?b.nodeType:9;if(d=d||[],\"string\"!=typeof a||!a||1!==w&&9!==w&&11!==w)return d;if(!e&&((b?b.ownerDocument||b:v)!==n&&m(b),b=b||n,p)){if(11!==w&&(l=Z.exec(a)))if(f=l[1]){if(9===w){if(!(j=b.getElementById(f)))return d;if(j.id===f)return d.push(j),d}else if(s&&(j=s.getElementById(f))&&t(b,j)&&j.id===f)return d.push(j),d}else{if(l[2])return G.apply(d,b.getElementsByTagName(a)),d;if((f=l[3])&&c.getElementsByClassName&&b.getElementsByClassName)return G.apply(d,b.getElementsByClassName(f)),d}if(c.qsa&&!A[a+\" \"]&&(!q||!q.test(a))){if(1!==w)s=b,r=a;else if(\"object\"!==b.nodeName.toLowerCase()){(k=b.getAttribute(\"id\"))?k=k.replace(ba,ca):b.setAttribute(\"id\",k=u),o=g(a),h=o.length;while(h--)o[h]=\"#\"+k+\" \"+sa(o[h]);r=o.join(\",\"),s=$.test(a)&&qa(b.parentNode)||b}if(r)try{return G.apply(d,s.querySelectorAll(r)),d}catch(x){}finally{k===u&&b.removeAttribute(\"id\")}}}return i(a.replace(P,\"$1\"),b,d,e)}function ha(){var a=[];function b(c,e){return a.push(c+\" \")>d.cacheLength&&delete b[a.shift()],b[c+\" \"]=e}return b}function ia(a){return a[u]=!0,a}function ja(a){var b=n.createElement(\"fieldset\");try{return!!a(b)}catch(c){return!1}finally{b.parentNode&&b.parentNode.removeChild(b),b=null}}function ka(a,b){var c=a.split(\"|\"),e=c.length;while(e--)d.attrHandle[c[e]]=b}function la(a,b){var c=b&&a,d=c&&1===a.nodeType&&1===b.nodeType&&a.sourceIndex-b.sourceIndex;if(d)return d;if(c)while(c=c.nextSibling)if(c===b)return-1;return a?1:-1}function ma(a){return function(b){var c=b.nodeName.toLowerCase();return\"input\"===c&&b.type===a}}function na(a){return function(b){var c=b.nodeName.toLowerCase();return(\"input\"===c||\"button\"===c)&&b.type===a}}function oa(a){return function(b){return\"label\"in b&&b.disabled===a||\"form\"in b&&b.disabled===a||\"form\"in b&&b.disabled===!1&&(b.isDisabled===a||b.isDisabled!==!a&&(\"label\"in b||!ea(b))!==a)}}function pa(a){return ia(function(b){return b=+b,ia(function(c,d){var e,f=a([],c.length,b),g=f.length;while(g--)c[e=f[g]]&&(c[e]=!(d[e]=c[e]))})})}function qa(a){return a&&\"undefined\"!=typeof a.getElementsByTagName&&a}c=ga.support={},f=ga.isXML=function(a){var b=a&&(a.ownerDocument||a).documentElement;return!!b&&\"HTML\"!==b.nodeName},m=ga.setDocument=function(a){var b,e,g=a?a.ownerDocument||a:v;return g!==n&&9===g.nodeType&&g.documentElement?(n=g,o=n.documentElement,p=!f(n),v!==n&&(e=n.defaultView)&&e.top!==e&&(e.addEventListener?e.addEventListener(\"unload\",da,!1):e.attachEvent&&e.attachEvent(\"onunload\",da)),c.attributes=ja(function(a){return a.className=\"i\",!a.getAttribute(\"className\")}),c.getElementsByTagName=ja(function(a){return a.appendChild(n.createComment(\"\")),!a.getElementsByTagName(\"*\").length}),c.getElementsByClassName=Y.test(n.getElementsByClassName),c.getById=ja(function(a){return o.appendChild(a).id=u,!n.getElementsByName||!n.getElementsByName(u).length}),c.getById?(d.find.ID=function(a,b){if(\"undefined\"!=typeof b.getElementById&&p){var c=b.getElementById(a);return c?[c]:[]}},d.filter.ID=function(a){var b=a.replace(_,aa);return function(a){return a.getAttribute(\"id\")===b}}):(delete d.find.ID,d.filter.ID=function(a){var b=a.replace(_,aa);return function(a){var c=\"undefined\"!=typeof a.getAttributeNode&&a.getAttributeNode(\"id\");return c&&c.value===b}}),d.find.TAG=c.getElementsByTagName?function(a,b){return\"undefined\"!=typeof b.getElementsByTagName?b.getElementsByTagName(a):c.qsa?b.querySelectorAll(a):void 0}:function(a,b){var c,d=[],e=0,f=b.getElementsByTagName(a);if(\"*\"===a){while(c=f[e++])1===c.nodeType&&d.push(c);return d}return f},d.find.CLASS=c.getElementsByClassName&&function(a,b){if(\"undefined\"!=typeof b.getElementsByClassName&&p)return b.getElementsByClassName(a)},r=[],q=[],(c.qsa=Y.test(n.querySelectorAll))&&(ja(function(a){o.appendChild(a).innerHTML=\"<a id='\"+u+\"'></a><select id='\"+u+\"-\\r\\\\' msallowcapture=''><option selected=''></option></select>\",a.querySelectorAll(\"[msallowcapture^='']\").length&&q.push(\"[*^$]=\"+K+\"*(?:''|\\\"\\\")\"),a.querySelectorAll(\"[selected]\").length||q.push(\"\\\\[\"+K+\"*(?:value|\"+J+\")\"),a.querySelectorAll(\"[id~=\"+u+\"-]\").length||q.push(\"~=\"),a.querySelectorAll(\":checked\").length||q.push(\":checked\"),a.querySelectorAll(\"a#\"+u+\"+*\").length||q.push(\".#.+[+~]\")}),ja(function(a){a.innerHTML=\"<a href='' disabled='disabled'></a><select disabled='disabled'><option/></select>\";var b=n.createElement(\"input\");b.setAttribute(\"type\",\"hidden\"),a.appendChild(b).setAttribute(\"name\",\"D\"),a.querySelectorAll(\"[name=d]\").length&&q.push(\"name\"+K+\"*[*^$|!~]?=\"),2!==a.querySelectorAll(\":enabled\").length&&q.push(\":enabled\",\":disabled\"),o.appendChild(a).disabled=!0,2!==a.querySelectorAll(\":disabled\").length&&q.push(\":enabled\",\":disabled\"),a.querySelectorAll(\"*,:x\"),q.push(\",.*:\")})),(c.matchesSelector=Y.test(s=o.matches||o.webkitMatchesSelector||o.mozMatchesSelector||o.oMatchesSelector||o.msMatchesSelector))&&ja(function(a){c.disconnectedMatch=s.call(a,\"*\"),s.call(a,\"[s!='']:x\"),r.push(\"!=\",N)}),q=q.length&&new RegExp(q.join(\"|\")),r=r.length&&new RegExp(r.join(\"|\")),b=Y.test(o.compareDocumentPosition),t=b||Y.test(o.contains)?function(a,b){var c=9===a.nodeType?a.documentElement:a,d=b&&b.parentNode;return a===d||!(!d||1!==d.nodeType||!(c.contains?c.contains(d):a.compareDocumentPosition&&16&a.compareDocumentPosition(d)))}:function(a,b){if(b)while(b=b.parentNode)if(b===a)return!0;return!1},B=b?function(a,b){if(a===b)return l=!0,0;var d=!a.compareDocumentPosition-!b.compareDocumentPosition;return d?d:(d=(a.ownerDocument||a)===(b.ownerDocument||b)?a.compareDocumentPosition(b):1,1&d||!c.sortDetached&&b.compareDocumentPosition(a)===d?a===n||a.ownerDocument===v&&t(v,a)?-1:b===n||b.ownerDocument===v&&t(v,b)?1:k?I(k,a)-I(k,b):0:4&d?-1:1)}:function(a,b){if(a===b)return l=!0,0;var c,d=0,e=a.parentNode,f=b.parentNode,g=[a],h=[b];if(!e||!f)return a===n?-1:b===n?1:e?-1:f?1:k?I(k,a)-I(k,b):0;if(e===f)return la(a,b);c=a;while(c=c.parentNode)g.unshift(c);c=b;while(c=c.parentNode)h.unshift(c);while(g[d]===h[d])d++;return d?la(g[d],h[d]):g[d]===v?-1:h[d]===v?1:0},n):n},ga.matches=function(a,b){return ga(a,null,null,b)},ga.matchesSelector=function(a,b){if((a.ownerDocument||a)!==n&&m(a),b=b.replace(S,\"='$1']\"),c.matchesSelector&&p&&!A[b+\" \"]&&(!r||!r.test(b))&&(!q||!q.test(b)))try{var d=s.call(a,b);if(d||c.disconnectedMatch||a.document&&11!==a.document.nodeType)return d}catch(e){}return ga(b,n,null,[a]).length>0},ga.contains=function(a,b){return(a.ownerDocument||a)!==n&&m(a),t(a,b)},ga.attr=function(a,b){(a.ownerDocument||a)!==n&&m(a);var e=d.attrHandle[b.toLowerCase()],f=e&&C.call(d.attrHandle,b.toLowerCase())?e(a,b,!p):void 0;return void 0!==f?f:c.attributes||!p?a.getAttribute(b):(f=a.getAttributeNode(b))&&f.specified?f.value:null},ga.escape=function(a){return(a+\"\").replace(ba,ca)},ga.error=function(a){throw new Error(\"Syntax error, unrecognized expression: \"+a)},ga.uniqueSort=function(a){var b,d=[],e=0,f=0;if(l=!c.detectDuplicates,k=!c.sortStable&&a.slice(0),a.sort(B),l){while(b=a[f++])b===a[f]&&(e=d.push(f));while(e--)a.splice(d[e],1)}return k=null,a},e=ga.getText=function(a){var b,c=\"\",d=0,f=a.nodeType;if(f){if(1===f||9===f||11===f){if(\"string\"==typeof a.textContent)return a.textContent;for(a=a.firstChild;a;a=a.nextSibling)c+=e(a)}else if(3===f||4===f)return a.nodeValue}else while(b=a[d++])c+=e(b);return c},d=ga.selectors={cacheLength:50,createPseudo:ia,match:V,attrHandle:{},find:{},relative:{\">\":{dir:\"parentNode\",first:!0},\" \":{dir:\"parentNode\"},\"+\":{dir:\"previousSibling\",first:!0},\"~\":{dir:\"previousSibling\"}},preFilter:{ATTR:function(a){return a[1]=a[1].replace(_,aa),a[3]=(a[3]||a[4]||a[5]||\"\").replace(_,aa),\"~=\"===a[2]&&(a[3]=\" \"+a[3]+\" \"),a.slice(0,4)},CHILD:function(a){return a[1]=a[1].toLowerCase(),\"nth\"===a[1].slice(0,3)?(a[3]||ga.error(a[0]),a[4]=+(a[4]?a[5]+(a[6]||1):2*(\"even\"===a[3]||\"odd\"===a[3])),a[5]=+(a[7]+a[8]||\"odd\"===a[3])):a[3]&&ga.error(a[0]),a},PSEUDO:function(a){var b,c=!a[6]&&a[2];return V.CHILD.test(a[0])?null:(a[3]?a[2]=a[4]||a[5]||\"\":c&&T.test(c)&&(b=g(c,!0))&&(b=c.indexOf(\")\",c.length-b)-c.length)&&(a[0]=a[0].slice(0,b),a[2]=c.slice(0,b)),a.slice(0,3))}},filter:{TAG:function(a){var b=a.replace(_,aa).toLowerCase();return\"*\"===a?function(){return!0}:function(a){return a.nodeName&&a.nodeName.toLowerCase()===b}},CLASS:function(a){var b=y[a+\" \"];return b||(b=new RegExp(\"(^|\"+K+\")\"+a+\"(\"+K+\"|$)\"))&&y(a,function(a){return b.test(\"string\"==typeof a.className&&a.className||\"undefined\"!=typeof a.getAttribute&&a.getAttribute(\"class\")||\"\")})},ATTR:function(a,b,c){return function(d){var e=ga.attr(d,a);return null==e?\"!=\"===b:!b||(e+=\"\",\"=\"===b?e===c:\"!=\"===b?e!==c:\"^=\"===b?c&&0===e.indexOf(c):\"*=\"===b?c&&e.indexOf(c)>-1:\"$=\"===b?c&&e.slice(-c.length)===c:\"~=\"===b?(\" \"+e.replace(O,\" \")+\" \").indexOf(c)>-1:\"|=\"===b&&(e===c||e.slice(0,c.length+1)===c+\"-\"))}},CHILD:function(a,b,c,d,e){var f=\"nth\"!==a.slice(0,3),g=\"last\"!==a.slice(-4),h=\"of-type\"===b;return 1===d&&0===e?function(a){return!!a.parentNode}:function(b,c,i){var j,k,l,m,n,o,p=f!==g?\"nextSibling\":\"previousSibling\",q=b.parentNode,r=h&&b.nodeName.toLowerCase(),s=!i&&!h,t=!1;if(q){if(f){while(p){m=b;while(m=m[p])if(h?m.nodeName.toLowerCase()===r:1===m.nodeType)return!1;o=p=\"only\"===a&&!o&&\"nextSibling\"}return!0}if(o=[g?q.firstChild:q.lastChild],g&&s){m=q,l=m[u]||(m[u]={}),k=l[m.uniqueID]||(l[m.uniqueID]={}),j=k[a]||[],n=j[0]===w&&j[1],t=n&&j[2],m=n&&q.childNodes[n];while(m=++n&&m&&m[p]||(t=n=0)||o.pop())if(1===m.nodeType&&++t&&m===b){k[a]=[w,n,t];break}}else if(s&&(m=b,l=m[u]||(m[u]={}),k=l[m.uniqueID]||(l[m.uniqueID]={}),j=k[a]||[],n=j[0]===w&&j[1],t=n),t===!1)while(m=++n&&m&&m[p]||(t=n=0)||o.pop())if((h?m.nodeName.toLowerCase()===r:1===m.nodeType)&&++t&&(s&&(l=m[u]||(m[u]={}),k=l[m.uniqueID]||(l[m.uniqueID]={}),k[a]=[w,t]),m===b))break;return t-=e,t===d||t%d===0&&t/d>=0}}},PSEUDO:function(a,b){var c,e=d.pseudos[a]||d.setFilters[a.toLowerCase()]||ga.error(\"unsupported pseudo: \"+a);return e[u]?e(b):e.length>1?(c=[a,a,\"\",b],d.setFilters.hasOwnProperty(a.toLowerCase())?ia(function(a,c){var d,f=e(a,b),g=f.length;while(g--)d=I(a,f[g]),a[d]=!(c[d]=f[g])}):function(a){return e(a,0,c)}):e}},pseudos:{not:ia(function(a){var b=[],c=[],d=h(a.replace(P,\"$1\"));return d[u]?ia(function(a,b,c,e){var f,g=d(a,null,e,[]),h=a.length;while(h--)(f=g[h])&&(a[h]=!(b[h]=f))}):function(a,e,f){return b[0]=a,d(b,null,f,c),b[0]=null,!c.pop()}}),has:ia(function(a){return function(b){return ga(a,b).length>0}}),contains:ia(function(a){return a=a.replace(_,aa),function(b){return(b.textContent||b.innerText||e(b)).indexOf(a)>-1}}),lang:ia(function(a){return U.test(a||\"\")||ga.error(\"unsupported lang: \"+a),a=a.replace(_,aa).toLowerCase(),function(b){var c;do if(c=p?b.lang:b.getAttribute(\"xml:lang\")||b.getAttribute(\"lang\"))return c=c.toLowerCase(),c===a||0===c.indexOf(a+\"-\");while((b=b.parentNode)&&1===b.nodeType);return!1}}),target:function(b){var c=a.location&&a.location.hash;return c&&c.slice(1)===b.id},root:function(a){return a===o},focus:function(a){return a===n.activeElement&&(!n.hasFocus||n.hasFocus())&&!!(a.type||a.href||~a.tabIndex)},enabled:oa(!1),disabled:oa(!0),checked:function(a){var b=a.nodeName.toLowerCase();return\"input\"===b&&!!a.checked||\"option\"===b&&!!a.selected},selected:function(a){return a.parentNode&&a.parentNode.selectedIndex,a.selected===!0},empty:function(a){for(a=a.firstChild;a;a=a.nextSibling)if(a.nodeType<6)return!1;return!0},parent:function(a){return!d.pseudos.empty(a)},header:function(a){return X.test(a.nodeName)},input:function(a){return W.test(a.nodeName)},button:function(a){var b=a.nodeName.toLowerCase();return\"input\"===b&&\"button\"===a.type||\"button\"===b},text:function(a){var b;return\"input\"===a.nodeName.toLowerCase()&&\"text\"===a.type&&(null==(b=a.getAttribute(\"type\"))||\"text\"===b.toLowerCase())},first:pa(function(){return[0]}),last:pa(function(a,b){return[b-1]}),eq:pa(function(a,b,c){return[c<0?c+b:c]}),even:pa(function(a,b){for(var c=0;c<b;c+=2)a.push(c);return a}),odd:pa(function(a,b){for(var c=1;c<b;c+=2)a.push(c);return a}),lt:pa(function(a,b,c){for(var d=c<0?c+b:c;--d>=0;)a.push(d);return a}),gt:pa(function(a,b,c){for(var d=c<0?c+b:c;++d<b;)a.push(d);return a})}},d.pseudos.nth=d.pseudos.eq;for(b in{radio:!0,checkbox:!0,file:!0,password:!0,image:!0})d.pseudos[b]=ma(b);for(b in{submit:!0,reset:!0})d.pseudos[b]=na(b);function ra(){}ra.prototype=d.filters=d.pseudos,d.setFilters=new ra,g=ga.tokenize=function(a,b){var c,e,f,g,h,i,j,k=z[a+\" \"];if(k)return b?0:k.slice(0);h=a,i=[],j=d.preFilter;while(h){c&&!(e=Q.exec(h))||(e&&(h=h.slice(e[0].length)||h),i.push(f=[])),c=!1,(e=R.exec(h))&&(c=e.shift(),f.push({value:c,type:e[0].replace(P,\" \")}),h=h.slice(c.length));for(g in d.filter)!(e=V[g].exec(h))||j[g]&&!(e=j[g](e))||(c=e.shift(),f.push({value:c,type:g,matches:e}),h=h.slice(c.length));if(!c)break}return b?h.length:h?ga.error(a):z(a,i).slice(0)};function sa(a){for(var b=0,c=a.length,d=\"\";b<c;b++)d+=a[b].value;return d}function ta(a,b,c){var d=b.dir,e=b.next,f=e||d,g=c&&\"parentNode\"===f,h=x++;return b.first?function(b,c,e){while(b=b[d])if(1===b.nodeType||g)return a(b,c,e)}:function(b,c,i){var j,k,l,m=[w,h];if(i){while(b=b[d])if((1===b.nodeType||g)&&a(b,c,i))return!0}else while(b=b[d])if(1===b.nodeType||g)if(l=b[u]||(b[u]={}),k=l[b.uniqueID]||(l[b.uniqueID]={}),e&&e===b.nodeName.toLowerCase())b=b[d]||b;else{if((j=k[f])&&j[0]===w&&j[1]===h)return m[2]=j[2];if(k[f]=m,m[2]=a(b,c,i))return!0}}}function ua(a){return a.length>1?function(b,c,d){var e=a.length;while(e--)if(!a[e](b,c,d))return!1;return!0}:a[0]}function va(a,b,c){for(var d=0,e=b.length;d<e;d++)ga(a,b[d],c);return c}function wa(a,b,c,d,e){for(var f,g=[],h=0,i=a.length,j=null!=b;h<i;h++)(f=a[h])&&(c&&!c(f,d,e)||(g.push(f),j&&b.push(h)));return g}function xa(a,b,c,d,e,f){return d&&!d[u]&&(d=xa(d)),e&&!e[u]&&(e=xa(e,f)),ia(function(f,g,h,i){var j,k,l,m=[],n=[],o=g.length,p=f||va(b||\"*\",h.nodeType?[h]:h,[]),q=!a||!f&&b?p:wa(p,m,a,h,i),r=c?e||(f?a:o||d)?[]:g:q;if(c&&c(q,r,h,i),d){j=wa(r,n),d(j,[],h,i),k=j.length;while(k--)(l=j[k])&&(r[n[k]]=!(q[n[k]]=l))}if(f){if(e||a){if(e){j=[],k=r.length;while(k--)(l=r[k])&&j.push(q[k]=l);e(null,r=[],j,i)}k=r.length;while(k--)(l=r[k])&&(j=e?I(f,l):m[k])>-1&&(f[j]=!(g[j]=l))}}else r=wa(r===g?r.splice(o,r.length):r),e?e(null,g,r,i):G.apply(g,r)})}function ya(a){for(var b,c,e,f=a.length,g=d.relative[a[0].type],h=g||d.relative[\" \"],i=g?1:0,k=ta(function(a){return a===b},h,!0),l=ta(function(a){return I(b,a)>-1},h,!0),m=[function(a,c,d){var e=!g&&(d||c!==j)||((b=c).nodeType?k(a,c,d):l(a,c,d));return b=null,e}];i<f;i++)if(c=d.relative[a[i].type])m=[ta(ua(m),c)];else{if(c=d.filter[a[i].type].apply(null,a[i].matches),c[u]){for(e=++i;e<f;e++)if(d.relative[a[e].type])break;return xa(i>1&&ua(m),i>1&&sa(a.slice(0,i-1).concat({value:\" \"===a[i-2].type?\"*\":\"\"})).replace(P,\"$1\"),c,i<e&&ya(a.slice(i,e)),e<f&&ya(a=a.slice(e)),e<f&&sa(a))}m.push(c)}return ua(m)}function za(a,b){var c=b.length>0,e=a.length>0,f=function(f,g,h,i,k){var l,o,q,r=0,s=\"0\",t=f&&[],u=[],v=j,x=f||e&&d.find.TAG(\"*\",k),y=w+=null==v?1:Math.random()||.1,z=x.length;for(k&&(j=g===n||g||k);s!==z&&null!=(l=x[s]);s++){if(e&&l){o=0,g||l.ownerDocument===n||(m(l),h=!p);while(q=a[o++])if(q(l,g||n,h)){i.push(l);break}k&&(w=y)}c&&((l=!q&&l)&&r--,f&&t.push(l))}if(r+=s,c&&s!==r){o=0;while(q=b[o++])q(t,u,g,h);if(f){if(r>0)while(s--)t[s]||u[s]||(u[s]=E.call(i));u=wa(u)}G.apply(i,u),k&&!f&&u.length>0&&r+b.length>1&&ga.uniqueSort(i)}return k&&(w=y,j=v),t};return c?ia(f):f}return h=ga.compile=function(a,b){var c,d=[],e=[],f=A[a+\" \"];if(!f){b||(b=g(a)),c=b.length;while(c--)f=ya(b[c]),f[u]?d.push(f):e.push(f);f=A(a,za(e,d)),f.selector=a}return f},i=ga.select=function(a,b,e,f){var i,j,k,l,m,n=\"function\"==typeof a&&a,o=!f&&g(a=n.selector||a);if(e=e||[],1===o.length){if(j=o[0]=o[0].slice(0),j.length>2&&\"ID\"===(k=j[0]).type&&c.getById&&9===b.nodeType&&p&&d.relative[j[1].type]){if(b=(d.find.ID(k.matches[0].replace(_,aa),b)||[])[0],!b)return e;n&&(b=b.parentNode),a=a.slice(j.shift().value.length)}i=V.needsContext.test(a)?0:j.length;while(i--){if(k=j[i],d.relative[l=k.type])break;if((m=d.find[l])&&(f=m(k.matches[0].replace(_,aa),$.test(j[0].type)&&qa(b.parentNode)||b))){if(j.splice(i,1),a=f.length&&sa(j),!a)return G.apply(e,f),e;break}}}return(n||h(a,o))(f,b,!p,e,!b||$.test(a)&&qa(b.parentNode)||b),e},c.sortStable=u.split(\"\").sort(B).join(\"\")===u,c.detectDuplicates=!!l,m(),c.sortDetached=ja(function(a){return 1&a.compareDocumentPosition(n.createElement(\"fieldset\"))}),ja(function(a){return a.innerHTML=\"<a href='#'></a>\",\"#\"===a.firstChild.getAttribute(\"href\")})||ka(\"type|href|height|width\",function(a,b,c){if(!c)return a.getAttribute(b,\"type\"===b.toLowerCase()?1:2)}),c.attributes&&ja(function(a){return a.innerHTML=\"<input/>\",a.firstChild.setAttribute(\"value\",\"\"),\"\"===a.firstChild.getAttribute(\"value\")})||ka(\"value\",function(a,b,c){if(!c&&\"input\"===a.nodeName.toLowerCase())return a.defaultValue}),ja(function(a){return null==a.getAttribute(\"disabled\")})||ka(J,function(a,b,c){var d;if(!c)return a[b]===!0?b.toLowerCase():(d=a.getAttributeNode(b))&&d.specified?d.value:null}),ga}(a);r.find=x,r.expr=x.selectors,r.expr[\":\"]=r.expr.pseudos,r.uniqueSort=r.unique=x.uniqueSort,r.text=x.getText,r.isXMLDoc=x.isXML,r.contains=x.contains,r.escapeSelector=x.escape;var y=function(a,b,c){var d=[],e=void 0!==c;while((a=a[b])&&9!==a.nodeType)if(1===a.nodeType){if(e&&r(a).is(c))break;d.push(a)}return d},z=function(a,b){for(var c=[];a;a=a.nextSibling)1===a.nodeType&&a!==b&&c.push(a);return c},A=r.expr.match.needsContext,B=/^<([a-z][^\\/\\0>:\\x20\\t\\r\\n\\f]*)[\\x20\\t\\r\\n\\f]*\\/?>(?:<\\/\\1>|)$/i,C=/^.[^:#\\[\\.,]*$/;function D(a,b,c){if(r.isFunction(b))return r.grep(a,function(a,d){return!!b.call(a,d,a)!==c});if(b.nodeType)return r.grep(a,function(a){return a===b!==c});if(\"string\"==typeof b){if(C.test(b))return r.filter(b,a,c);b=r.filter(b,a)}return r.grep(a,function(a){return i.call(b,a)>-1!==c&&1===a.nodeType})}r.filter=function(a,b,c){var d=b[0];return c&&(a=\":not(\"+a+\")\"),1===b.length&&1===d.nodeType?r.find.matchesSelector(d,a)?[d]:[]:r.find.matches(a,r.grep(b,function(a){return 1===a.nodeType}))},r.fn.extend({find:function(a){var b,c,d=this.length,e=this;if(\"string\"!=typeof a)return this.pushStack(r(a).filter(function(){for(b=0;b<d;b++)if(r.contains(e[b],this))return!0}));for(c=this.pushStack([]),b=0;b<d;b++)r.find(a,e[b],c);return d>1?r.uniqueSort(c):c},filter:function(a){return this.pushStack(D(this,a||[],!1))},not:function(a){return this.pushStack(D(this,a||[],!0))},is:function(a){return!!D(this,\"string\"==typeof a&&A.test(a)?r(a):a||[],!1).length}});var E,F=/^(?:\\s*(<[\\w\\W]+>)[^>]*|#([\\w-]+))$/,G=r.fn.init=function(a,b,c){var e,f;if(!a)return this;if(c=c||E,\"string\"==typeof a){if(e=\"<\"===a[0]&&\">\"===a[a.length-1]&&a.length>=3?[null,a,null]:F.exec(a),!e||!e[1]&&b)return!b||b.jquery?(b||c).find(a):this.constructor(b).find(a);if(e[1]){if(b=b instanceof r?b[0]:b,r.merge(this,r.parseHTML(e[1],b&&b.nodeType?b.ownerDocument||b:d,!0)),B.test(e[1])&&r.isPlainObject(b))for(e in b)r.isFunction(this[e])?this[e](b[e]):this.attr(e,b[e]);return this}return f=d.getElementById(e[2]),f&&(this[0]=f,this.length=1),this}return a.nodeType?(this[0]=a,this.length=1,this):r.isFunction(a)?void 0!==c.ready?c.ready(a):a(r):r.makeArray(a,this)};G.prototype=r.fn,E=r(d);var H=/^(?:parents|prev(?:Until|All))/,I={children:!0,contents:!0,next:!0,prev:!0};r.fn.extend({has:function(a){var b=r(a,this),c=b.length;return this.filter(function(){for(var a=0;a<c;a++)if(r.contains(this,b[a]))return!0})},closest:function(a,b){var c,d=0,e=this.length,f=[],g=\"string\"!=typeof a&&r(a);if(!A.test(a))for(;d<e;d++)for(c=this[d];c&&c!==b;c=c.parentNode)if(c.nodeType<11&&(g?g.index(c)>-1:1===c.nodeType&&r.find.matchesSelector(c,a))){f.push(c);break}return this.pushStack(f.length>1?r.uniqueSort(f):f)},index:function(a){return a?\"string\"==typeof a?i.call(r(a),this[0]):i.call(this,a.jquery?a[0]:a):this[0]&&this[0].parentNode?this.first().prevAll().length:-1},add:function(a,b){return this.pushStack(r.uniqueSort(r.merge(this.get(),r(a,b))))},addBack:function(a){return this.add(null==a?this.prevObject:this.prevObject.filter(a))}});function J(a,b){while((a=a[b])&&1!==a.nodeType);return a}r.each({parent:function(a){var b=a.parentNode;return b&&11!==b.nodeType?b:null},parents:function(a){return y(a,\"parentNode\")},parentsUntil:function(a,b,c){return y(a,\"parentNode\",c)},next:function(a){return J(a,\"nextSibling\")},prev:function(a){return J(a,\"previousSibling\")},nextAll:function(a){return y(a,\"nextSibling\")},prevAll:function(a){return y(a,\"previousSibling\")},nextUntil:function(a,b,c){return y(a,\"nextSibling\",c)},prevUntil:function(a,b,c){return y(a,\"previousSibling\",c)},siblings:function(a){return z((a.parentNode||{}).firstChild,a)},children:function(a){return z(a.firstChild)},contents:function(a){return a.contentDocument||r.merge([],a.childNodes)}},function(a,b){r.fn[a]=function(c,d){var e=r.map(this,b,c);return\"Until\"!==a.slice(-5)&&(d=c),d&&\"string\"==typeof d&&(e=r.filter(d,e)),this.length>1&&(I[a]||r.uniqueSort(e),H.test(a)&&e.reverse()),this.pushStack(e)}});var K=/\\S+/g;function L(a){var b={};return r.each(a.match(K)||[],function(a,c){b[c]=!0}),b}r.Callbacks=function(a){a=\"string\"==typeof a?L(a):r.extend({},a);var b,c,d,e,f=[],g=[],h=-1,i=function(){for(e=a.once,d=b=!0;g.length;h=-1){c=g.shift();while(++h<f.length)f[h].apply(c[0],c[1])===!1&&a.stopOnFalse&&(h=f.length,c=!1)}a.memory||(c=!1),b=!1,e&&(f=c?[]:\"\")},j={add:function(){return f&&(c&&!b&&(h=f.length-1,g.push(c)),function d(b){r.each(b,function(b,c){r.isFunction(c)?a.unique&&j.has(c)||f.push(c):c&&c.length&&\"string\"!==r.type(c)&&d(c)})}(arguments),c&&!b&&i()),this},remove:function(){return r.each(arguments,function(a,b){var c;while((c=r.inArray(b,f,c))>-1)f.splice(c,1),c<=h&&h--}),this},has:function(a){return a?r.inArray(a,f)>-1:f.length>0},empty:function(){return f&&(f=[]),this},disable:function(){return e=g=[],f=c=\"\",this},disabled:function(){return!f},lock:function(){return e=g=[],c||b||(f=c=\"\"),this},locked:function(){return!!e},fireWith:function(a,c){return e||(c=c||[],c=[a,c.slice?c.slice():c],g.push(c),b||i()),this},fire:function(){return j.fireWith(this,arguments),this},fired:function(){return!!d}};return j};function M(a){return a}function N(a){throw a}function O(a,b,c){var d;try{a&&r.isFunction(d=a.promise)?d.call(a).done(b).fail(c):a&&r.isFunction(d=a.then)?d.call(a,b,c):b.call(void 0,a)}catch(a){c.call(void 0,a)}}r.extend({Deferred:function(b){var c=[[\"notify\",\"progress\",r.Callbacks(\"memory\"),r.Callbacks(\"memory\"),2],[\"resolve\",\"done\",r.Callbacks(\"once memory\"),r.Callbacks(\"once memory\"),0,\"resolved\"],[\"reject\",\"fail\",r.Callbacks(\"once memory\"),r.Callbacks(\"once memory\"),1,\"rejected\"]],d=\"pending\",e={state:function(){return d},always:function(){return f.done(arguments).fail(arguments),this},\"catch\":function(a){return e.then(null,a)},pipe:function(){var a=arguments;return r.Deferred(function(b){r.each(c,function(c,d){var e=r.isFunction(a[d[4]])&&a[d[4]];f[d[1]](function(){var a=e&&e.apply(this,arguments);a&&r.isFunction(a.promise)?a.promise().progress(b.notify).done(b.resolve).fail(b.reject):b[d[0]+\"With\"](this,e?[a]:arguments)})}),a=null}).promise()},then:function(b,d,e){var f=0;function g(b,c,d,e){return function(){var h=this,i=arguments,j=function(){var a,j;if(!(b<f)){if(a=d.apply(h,i),a===c.promise())throw new TypeError(\"Thenable self-resolution\");j=a&&(\"object\"==typeof a||\"function\"==typeof a)&&a.then,r.isFunction(j)?e?j.call(a,g(f,c,M,e),g(f,c,N,e)):(f++,j.call(a,g(f,c,M,e),g(f,c,N,e),g(f,c,M,c.notifyWith))):(d!==M&&(h=void 0,i=[a]),(e||c.resolveWith)(h,i))}},k=e?j:function(){try{j()}catch(a){r.Deferred.exceptionHook&&r.Deferred.exceptionHook(a,k.stackTrace),b+1>=f&&(d!==N&&(h=void 0,i=[a]),c.rejectWith(h,i))}};b?k():(r.Deferred.getStackHook&&(k.stackTrace=r.Deferred.getStackHook()),a.setTimeout(k))}}return r.Deferred(function(a){c[0][3].add(g(0,a,r.isFunction(e)?e:M,a.notifyWith)),c[1][3].add(g(0,a,r.isFunction(b)?b:M)),c[2][3].add(g(0,a,r.isFunction(d)?d:N))}).promise()},promise:function(a){return null!=a?r.extend(a,e):e}},f={};return r.each(c,function(a,b){var g=b[2],h=b[5];e[b[1]]=g.add,h&&g.add(function(){d=h},c[3-a][2].disable,c[0][2].lock),g.add(b[3].fire),f[b[0]]=function(){return f[b[0]+\"With\"](this===f?void 0:this,arguments),this},f[b[0]+\"With\"]=g.fireWith}),e.promise(f),b&&b.call(f,f),f},when:function(a){var b=arguments.length,c=b,d=Array(c),e=f.call(arguments),g=r.Deferred(),h=function(a){return function(c){d[a]=this,e[a]=arguments.length>1?f.call(arguments):c,--b||g.resolveWith(d,e)}};if(b<=1&&(O(a,g.done(h(c)).resolve,g.reject),\"pending\"===g.state()||r.isFunction(e[c]&&e[c].then)))return g.then();while(c--)O(e[c],h(c),g.reject);return g.promise()}});var P=/^(Eval|Internal|Range|Reference|Syntax|Type|URI)Error$/;r.Deferred.exceptionHook=function(b,c){a.console&&a.console.warn&&b&&P.test(b.name)&&a.console.warn(\"jQuery.Deferred exception: \"+b.message,b.stack,c)},r.readyException=function(b){a.setTimeout(function(){throw b})};var Q=r.Deferred();r.fn.ready=function(a){return Q.then(a)[\"catch\"](function(a){r.readyException(a)}),this},r.extend({isReady:!1,readyWait:1,holdReady:function(a){a?r.readyWait++:r.ready(!0)},ready:function(a){(a===!0?--r.readyWait:r.isReady)||(r.isReady=!0,a!==!0&&--r.readyWait>0||Q.resolveWith(d,[r]))}}),r.ready.then=Q.then;function R(){d.removeEventListener(\"DOMContentLoaded\",R),a.removeEventListener(\"load\",R),r.ready()}\"complete\"===d.readyState||\"loading\"!==d.readyState&&!d.documentElement.doScroll?a.setTimeout(r.ready):(d.addEventListener(\"DOMContentLoaded\",R),a.addEventListener(\"load\",R));var S=function(a,b,c,d,e,f,g){var h=0,i=a.length,j=null==c;if(\"object\"===r.type(c)){e=!0;for(h in c)S(a,b,h,c[h],!0,f,g)}else if(void 0!==d&&(e=!0,\nr.isFunction(d)||(g=!0),j&&(g?(b.call(a,d),b=null):(j=b,b=function(a,b,c){return j.call(r(a),c)})),b))for(;h<i;h++)b(a[h],c,g?d:d.call(a[h],h,b(a[h],c)));return e?a:j?b.call(a):i?b(a[0],c):f},T=function(a){return 1===a.nodeType||9===a.nodeType||!+a.nodeType};function U(){this.expando=r.expando+U.uid++}U.uid=1,U.prototype={cache:function(a){var b=a[this.expando];return b||(b={},T(a)&&(a.nodeType?a[this.expando]=b:Object.defineProperty(a,this.expando,{value:b,configurable:!0}))),b},set:function(a,b,c){var d,e=this.cache(a);if(\"string\"==typeof b)e[r.camelCase(b)]=c;else for(d in b)e[r.camelCase(d)]=b[d];return e},get:function(a,b){return void 0===b?this.cache(a):a[this.expando]&&a[this.expando][r.camelCase(b)]},access:function(a,b,c){return void 0===b||b&&\"string\"==typeof b&&void 0===c?this.get(a,b):(this.set(a,b,c),void 0!==c?c:b)},remove:function(a,b){var c,d=a[this.expando];if(void 0!==d){if(void 0!==b){r.isArray(b)?b=b.map(r.camelCase):(b=r.camelCase(b),b=b in d?[b]:b.match(K)||[]),c=b.length;while(c--)delete d[b[c]]}(void 0===b||r.isEmptyObject(d))&&(a.nodeType?a[this.expando]=void 0:delete a[this.expando])}},hasData:function(a){var b=a[this.expando];return void 0!==b&&!r.isEmptyObject(b)}};var V=new U,W=new U,X=/^(?:\\{[\\w\\W]*\\}|\\[[\\w\\W]*\\])$/,Y=/[A-Z]/g;function Z(a,b,c){var d;if(void 0===c&&1===a.nodeType)if(d=\"data-\"+b.replace(Y,\"-$&\").toLowerCase(),c=a.getAttribute(d),\"string\"==typeof c){try{c=\"true\"===c||\"false\"!==c&&(\"null\"===c?null:+c+\"\"===c?+c:X.test(c)?JSON.parse(c):c)}catch(e){}W.set(a,b,c)}else c=void 0;return c}r.extend({hasData:function(a){return W.hasData(a)||V.hasData(a)},data:function(a,b,c){return W.access(a,b,c)},removeData:function(a,b){W.remove(a,b)},_data:function(a,b,c){return V.access(a,b,c)},_removeData:function(a,b){V.remove(a,b)}}),r.fn.extend({data:function(a,b){var c,d,e,f=this[0],g=f&&f.attributes;if(void 0===a){if(this.length&&(e=W.get(f),1===f.nodeType&&!V.get(f,\"hasDataAttrs\"))){c=g.length;while(c--)g[c]&&(d=g[c].name,0===d.indexOf(\"data-\")&&(d=r.camelCase(d.slice(5)),Z(f,d,e[d])));V.set(f,\"hasDataAttrs\",!0)}return e}return\"object\"==typeof a?this.each(function(){W.set(this,a)}):S(this,function(b){var c;if(f&&void 0===b){if(c=W.get(f,a),void 0!==c)return c;if(c=Z(f,a),void 0!==c)return c}else this.each(function(){W.set(this,a,b)})},null,b,arguments.length>1,null,!0)},removeData:function(a){return this.each(function(){W.remove(this,a)})}}),r.extend({queue:function(a,b,c){var d;if(a)return b=(b||\"fx\")+\"queue\",d=V.get(a,b),c&&(!d||r.isArray(c)?d=V.access(a,b,r.makeArray(c)):d.push(c)),d||[]},dequeue:function(a,b){b=b||\"fx\";var c=r.queue(a,b),d=c.length,e=c.shift(),f=r._queueHooks(a,b),g=function(){r.dequeue(a,b)};\"inprogress\"===e&&(e=c.shift(),d--),e&&(\"fx\"===b&&c.unshift(\"inprogress\"),delete f.stop,e.call(a,g,f)),!d&&f&&f.empty.fire()},_queueHooks:function(a,b){var c=b+\"queueHooks\";return V.get(a,c)||V.access(a,c,{empty:r.Callbacks(\"once memory\").add(function(){V.remove(a,[b+\"queue\",c])})})}}),r.fn.extend({queue:function(a,b){var c=2;return\"string\"!=typeof a&&(b=a,a=\"fx\",c--),arguments.length<c?r.queue(this[0],a):void 0===b?this:this.each(function(){var c=r.queue(this,a,b);r._queueHooks(this,a),\"fx\"===a&&\"inprogress\"!==c[0]&&r.dequeue(this,a)})},dequeue:function(a){return this.each(function(){r.dequeue(this,a)})},clearQueue:function(a){return this.queue(a||\"fx\",[])},promise:function(a,b){var c,d=1,e=r.Deferred(),f=this,g=this.length,h=function(){--d||e.resolveWith(f,[f])};\"string\"!=typeof a&&(b=a,a=void 0),a=a||\"fx\";while(g--)c=V.get(f[g],a+\"queueHooks\"),c&&c.empty&&(d++,c.empty.add(h));return h(),e.promise(b)}});var $=/[+-]?(?:\\d*\\.|)\\d+(?:[eE][+-]?\\d+|)/.source,_=new RegExp(\"^(?:([+-])=|)(\"+$+\")([a-z%]*)$\",\"i\"),aa=[\"Top\",\"Right\",\"Bottom\",\"Left\"],ba=function(a,b){return a=b||a,\"none\"===a.style.display||\"\"===a.style.display&&r.contains(a.ownerDocument,a)&&\"none\"===r.css(a,\"display\")},ca=function(a,b,c,d){var e,f,g={};for(f in b)g[f]=a.style[f],a.style[f]=b[f];e=c.apply(a,d||[]);for(f in b)a.style[f]=g[f];return e};function da(a,b,c,d){var e,f=1,g=20,h=d?function(){return d.cur()}:function(){return r.css(a,b,\"\")},i=h(),j=c&&c[3]||(r.cssNumber[b]?\"\":\"px\"),k=(r.cssNumber[b]||\"px\"!==j&&+i)&&_.exec(r.css(a,b));if(k&&k[3]!==j){j=j||k[3],c=c||[],k=+i||1;do f=f||\".5\",k/=f,r.style(a,b,k+j);while(f!==(f=h()/i)&&1!==f&&--g)}return c&&(k=+k||+i||0,e=c[1]?k+(c[1]+1)*c[2]:+c[2],d&&(d.unit=j,d.start=k,d.end=e)),e}var ea={};function fa(a){var b,c=a.ownerDocument,d=a.nodeName,e=ea[d];return e?e:(b=c.body.appendChild(c.createElement(d)),e=r.css(b,\"display\"),b.parentNode.removeChild(b),\"none\"===e&&(e=\"block\"),ea[d]=e,e)}function ga(a,b){for(var c,d,e=[],f=0,g=a.length;f<g;f++)d=a[f],d.style&&(c=d.style.display,b?(\"none\"===c&&(e[f]=V.get(d,\"display\")||null,e[f]||(d.style.display=\"\")),\"\"===d.style.display&&ba(d)&&(e[f]=fa(d))):\"none\"!==c&&(e[f]=\"none\",V.set(d,\"display\",c)));for(f=0;f<g;f++)null!=e[f]&&(a[f].style.display=e[f]);return a}r.fn.extend({show:function(){return ga(this,!0)},hide:function(){return ga(this)},toggle:function(a){return\"boolean\"==typeof a?a?this.show():this.hide():this.each(function(){ba(this)?r(this).show():r(this).hide()})}});var ha=/^(?:checkbox|radio)$/i,ia=/<([a-z][^\\/\\0>\\x20\\t\\r\\n\\f]+)/i,ja=/^$|\\/(?:java|ecma)script/i,ka={option:[1,\"<select multiple='multiple'>\",\"</select>\"],thead:[1,\"<table>\",\"</table>\"],col:[2,\"<table><colgroup>\",\"</colgroup></table>\"],tr:[2,\"<table><tbody>\",\"</tbody></table>\"],td:[3,\"<table><tbody><tr>\",\"</tr></tbody></table>\"],_default:[0,\"\",\"\"]};ka.optgroup=ka.option,ka.tbody=ka.tfoot=ka.colgroup=ka.caption=ka.thead,ka.th=ka.td;function la(a,b){var c=\"undefined\"!=typeof a.getElementsByTagName?a.getElementsByTagName(b||\"*\"):\"undefined\"!=typeof a.querySelectorAll?a.querySelectorAll(b||\"*\"):[];return void 0===b||b&&r.nodeName(a,b)?r.merge([a],c):c}function ma(a,b){for(var c=0,d=a.length;c<d;c++)V.set(a[c],\"globalEval\",!b||V.get(b[c],\"globalEval\"))}var na=/<|&#?\\w+;/;function oa(a,b,c,d,e){for(var f,g,h,i,j,k,l=b.createDocumentFragment(),m=[],n=0,o=a.length;n<o;n++)if(f=a[n],f||0===f)if(\"object\"===r.type(f))r.merge(m,f.nodeType?[f]:f);else if(na.test(f)){g=g||l.appendChild(b.createElement(\"div\")),h=(ia.exec(f)||[\"\",\"\"])[1].toLowerCase(),i=ka[h]||ka._default,g.innerHTML=i[1]+r.htmlPrefilter(f)+i[2],k=i[0];while(k--)g=g.lastChild;r.merge(m,g.childNodes),g=l.firstChild,g.textContent=\"\"}else m.push(b.createTextNode(f));l.textContent=\"\",n=0;while(f=m[n++])if(d&&r.inArray(f,d)>-1)e&&e.push(f);else if(j=r.contains(f.ownerDocument,f),g=la(l.appendChild(f),\"script\"),j&&ma(g),c){k=0;while(f=g[k++])ja.test(f.type||\"\")&&c.push(f)}return l}!function(){var a=d.createDocumentFragment(),b=a.appendChild(d.createElement(\"div\")),c=d.createElement(\"input\");c.setAttribute(\"type\",\"radio\"),c.setAttribute(\"checked\",\"checked\"),c.setAttribute(\"name\",\"t\"),b.appendChild(c),o.checkClone=b.cloneNode(!0).cloneNode(!0).lastChild.checked,b.innerHTML=\"<textarea>x</textarea>\",o.noCloneChecked=!!b.cloneNode(!0).lastChild.defaultValue}();var pa=d.documentElement,qa=/^key/,ra=/^(?:mouse|pointer|contextmenu|drag|drop)|click/,sa=/^([^.]*)(?:\\.(.+)|)/;function ta(){return!0}function ua(){return!1}function va(){try{return d.activeElement}catch(a){}}function wa(a,b,c,d,e,f){var g,h;if(\"object\"==typeof b){\"string\"!=typeof c&&(d=d||c,c=void 0);for(h in b)wa(a,h,c,d,b[h],f);return a}if(null==d&&null==e?(e=c,d=c=void 0):null==e&&(\"string\"==typeof c?(e=d,d=void 0):(e=d,d=c,c=void 0)),e===!1)e=ua;else if(!e)return a;return 1===f&&(g=e,e=function(a){return r().off(a),g.apply(this,arguments)},e.guid=g.guid||(g.guid=r.guid++)),a.each(function(){r.event.add(this,b,e,d,c)})}r.event={global:{},add:function(a,b,c,d,e){var f,g,h,i,j,k,l,m,n,o,p,q=V.get(a);if(q){c.handler&&(f=c,c=f.handler,e=f.selector),e&&r.find.matchesSelector(pa,e),c.guid||(c.guid=r.guid++),(i=q.events)||(i=q.events={}),(g=q.handle)||(g=q.handle=function(b){return\"undefined\"!=typeof r&&r.event.triggered!==b.type?r.event.dispatch.apply(a,arguments):void 0}),b=(b||\"\").match(K)||[\"\"],j=b.length;while(j--)h=sa.exec(b[j])||[],n=p=h[1],o=(h[2]||\"\").split(\".\").sort(),n&&(l=r.event.special[n]||{},n=(e?l.delegateType:l.bindType)||n,l=r.event.special[n]||{},k=r.extend({type:n,origType:p,data:d,handler:c,guid:c.guid,selector:e,needsContext:e&&r.expr.match.needsContext.test(e),namespace:o.join(\".\")},f),(m=i[n])||(m=i[n]=[],m.delegateCount=0,l.setup&&l.setup.call(a,d,o,g)!==!1||a.addEventListener&&a.addEventListener(n,g)),l.add&&(l.add.call(a,k),k.handler.guid||(k.handler.guid=c.guid)),e?m.splice(m.delegateCount++,0,k):m.push(k),r.event.global[n]=!0)}},remove:function(a,b,c,d,e){var f,g,h,i,j,k,l,m,n,o,p,q=V.hasData(a)&&V.get(a);if(q&&(i=q.events)){b=(b||\"\").match(K)||[\"\"],j=b.length;while(j--)if(h=sa.exec(b[j])||[],n=p=h[1],o=(h[2]||\"\").split(\".\").sort(),n){l=r.event.special[n]||{},n=(d?l.delegateType:l.bindType)||n,m=i[n]||[],h=h[2]&&new RegExp(\"(^|\\\\.)\"+o.join(\"\\\\.(?:.*\\\\.|)\")+\"(\\\\.|$)\"),g=f=m.length;while(f--)k=m[f],!e&&p!==k.origType||c&&c.guid!==k.guid||h&&!h.test(k.namespace)||d&&d!==k.selector&&(\"**\"!==d||!k.selector)||(m.splice(f,1),k.selector&&m.delegateCount--,l.remove&&l.remove.call(a,k));g&&!m.length&&(l.teardown&&l.teardown.call(a,o,q.handle)!==!1||r.removeEvent(a,n,q.handle),delete i[n])}else for(n in i)r.event.remove(a,n+b[j],c,d,!0);r.isEmptyObject(i)&&V.remove(a,\"handle events\")}},dispatch:function(a){var b=r.event.fix(a),c,d,e,f,g,h,i=new Array(arguments.length),j=(V.get(this,\"events\")||{})[b.type]||[],k=r.event.special[b.type]||{};for(i[0]=b,c=1;c<arguments.length;c++)i[c]=arguments[c];if(b.delegateTarget=this,!k.preDispatch||k.preDispatch.call(this,b)!==!1){h=r.event.handlers.call(this,b,j),c=0;while((f=h[c++])&&!b.isPropagationStopped()){b.currentTarget=f.elem,d=0;while((g=f.handlers[d++])&&!b.isImmediatePropagationStopped())b.rnamespace&&!b.rnamespace.test(g.namespace)||(b.handleObj=g,b.data=g.data,e=((r.event.special[g.origType]||{}).handle||g.handler).apply(f.elem,i),void 0!==e&&(b.result=e)===!1&&(b.preventDefault(),b.stopPropagation()))}return k.postDispatch&&k.postDispatch.call(this,b),b.result}},handlers:function(a,b){var c,d,e,f,g=[],h=b.delegateCount,i=a.target;if(h&&i.nodeType&&(\"click\"!==a.type||isNaN(a.button)||a.button<1))for(;i!==this;i=i.parentNode||this)if(1===i.nodeType&&(i.disabled!==!0||\"click\"!==a.type)){for(d=[],c=0;c<h;c++)f=b[c],e=f.selector+\" \",void 0===d[e]&&(d[e]=f.needsContext?r(e,this).index(i)>-1:r.find(e,this,null,[i]).length),d[e]&&d.push(f);d.length&&g.push({elem:i,handlers:d})}return h<b.length&&g.push({elem:this,handlers:b.slice(h)}),g},addProp:function(a,b){Object.defineProperty(r.Event.prototype,a,{enumerable:!0,configurable:!0,get:r.isFunction(b)?function(){if(this.originalEvent)return b(this.originalEvent)}:function(){if(this.originalEvent)return this.originalEvent[a]},set:function(b){Object.defineProperty(this,a,{enumerable:!0,configurable:!0,writable:!0,value:b})}})},fix:function(a){return a[r.expando]?a:new r.Event(a)},special:{load:{noBubble:!0},focus:{trigger:function(){if(this!==va()&&this.focus)return this.focus(),!1},delegateType:\"focusin\"},blur:{trigger:function(){if(this===va()&&this.blur)return this.blur(),!1},delegateType:\"focusout\"},click:{trigger:function(){if(\"checkbox\"===this.type&&this.click&&r.nodeName(this,\"input\"))return this.click(),!1},_default:function(a){return r.nodeName(a.target,\"a\")}},beforeunload:{postDispatch:function(a){void 0!==a.result&&a.originalEvent&&(a.originalEvent.returnValue=a.result)}}}},r.removeEvent=function(a,b,c){a.removeEventListener&&a.removeEventListener(b,c)},r.Event=function(a,b){return this instanceof r.Event?(a&&a.type?(this.originalEvent=a,this.type=a.type,this.isDefaultPrevented=a.defaultPrevented||void 0===a.defaultPrevented&&a.returnValue===!1?ta:ua,this.target=a.target&&3===a.target.nodeType?a.target.parentNode:a.target,this.currentTarget=a.currentTarget,this.relatedTarget=a.relatedTarget):this.type=a,b&&r.extend(this,b),this.timeStamp=a&&a.timeStamp||r.now(),void(this[r.expando]=!0)):new r.Event(a,b)},r.Event.prototype={constructor:r.Event,isDefaultPrevented:ua,isPropagationStopped:ua,isImmediatePropagationStopped:ua,isSimulated:!1,preventDefault:function(){var a=this.originalEvent;this.isDefaultPrevented=ta,a&&!this.isSimulated&&a.preventDefault()},stopPropagation:function(){var a=this.originalEvent;this.isPropagationStopped=ta,a&&!this.isSimulated&&a.stopPropagation()},stopImmediatePropagation:function(){var a=this.originalEvent;this.isImmediatePropagationStopped=ta,a&&!this.isSimulated&&a.stopImmediatePropagation(),this.stopPropagation()}},r.each({altKey:!0,bubbles:!0,cancelable:!0,changedTouches:!0,ctrlKey:!0,detail:!0,eventPhase:!0,metaKey:!0,pageX:!0,pageY:!0,shiftKey:!0,view:!0,\"char\":!0,charCode:!0,key:!0,keyCode:!0,button:!0,buttons:!0,clientX:!0,clientY:!0,offsetX:!0,offsetY:!0,pointerId:!0,pointerType:!0,screenX:!0,screenY:!0,targetTouches:!0,toElement:!0,touches:!0,which:function(a){var b=a.button;return null==a.which&&qa.test(a.type)?null!=a.charCode?a.charCode:a.keyCode:!a.which&&void 0!==b&&ra.test(a.type)?1&b?1:2&b?3:4&b?2:0:a.which}},r.event.addProp),r.each({mouseenter:\"mouseover\",mouseleave:\"mouseout\",pointerenter:\"pointerover\",pointerleave:\"pointerout\"},function(a,b){r.event.special[a]={delegateType:b,bindType:b,handle:function(a){var c,d=this,e=a.relatedTarget,f=a.handleObj;return e&&(e===d||r.contains(d,e))||(a.type=f.origType,c=f.handler.apply(this,arguments),a.type=b),c}}}),r.fn.extend({on:function(a,b,c,d){return wa(this,a,b,c,d)},one:function(a,b,c,d){return wa(this,a,b,c,d,1)},off:function(a,b,c){var d,e;if(a&&a.preventDefault&&a.handleObj)return d=a.handleObj,r(a.delegateTarget).off(d.namespace?d.origType+\".\"+d.namespace:d.origType,d.selector,d.handler),this;if(\"object\"==typeof a){for(e in a)this.off(e,b,a[e]);return this}return b!==!1&&\"function\"!=typeof b||(c=b,b=void 0),c===!1&&(c=ua),this.each(function(){r.event.remove(this,a,c,b)})}});var xa=/<(?!area|br|col|embed|hr|img|input|link|meta|param)(([a-z][^\\/\\0>\\x20\\t\\r\\n\\f]*)[^>]*)\\/>/gi,ya=/<script|<style|<link/i,za=/checked\\s*(?:[^=]|=\\s*.checked.)/i,Aa=/^true\\/(.*)/,Ba=/^\\s*<!(?:\\[CDATA\\[|--)|(?:\\]\\]|--)>\\s*$/g;function Ca(a,b){return r.nodeName(a,\"table\")&&r.nodeName(11!==b.nodeType?b:b.firstChild,\"tr\")?a.getElementsByTagName(\"tbody\")[0]||a:a}function Da(a){return a.type=(null!==a.getAttribute(\"type\"))+\"/\"+a.type,a}function Ea(a){var b=Aa.exec(a.type);return b?a.type=b[1]:a.removeAttribute(\"type\"),a}function Fa(a,b){var c,d,e,f,g,h,i,j;if(1===b.nodeType){if(V.hasData(a)&&(f=V.access(a),g=V.set(b,f),j=f.events)){delete g.handle,g.events={};for(e in j)for(c=0,d=j[e].length;c<d;c++)r.event.add(b,e,j[e][c])}W.hasData(a)&&(h=W.access(a),i=r.extend({},h),W.set(b,i))}}function Ga(a,b){var c=b.nodeName.toLowerCase();\"input\"===c&&ha.test(a.type)?b.checked=a.checked:\"input\"!==c&&\"textarea\"!==c||(b.defaultValue=a.defaultValue)}function Ha(a,b,c,d){b=g.apply([],b);var e,f,h,i,j,k,l=0,m=a.length,n=m-1,q=b[0],s=r.isFunction(q);if(s||m>1&&\"string\"==typeof q&&!o.checkClone&&za.test(q))return a.each(function(e){var f=a.eq(e);s&&(b[0]=q.call(this,e,f.html())),Ha(f,b,c,d)});if(m&&(e=oa(b,a[0].ownerDocument,!1,a,d),f=e.firstChild,1===e.childNodes.length&&(e=f),f||d)){for(h=r.map(la(e,\"script\"),Da),i=h.length;l<m;l++)j=e,l!==n&&(j=r.clone(j,!0,!0),i&&r.merge(h,la(j,\"script\"))),c.call(a[l],j,l);if(i)for(k=h[h.length-1].ownerDocument,r.map(h,Ea),l=0;l<i;l++)j=h[l],ja.test(j.type||\"\")&&!V.access(j,\"globalEval\")&&r.contains(k,j)&&(j.src?r._evalUrl&&r._evalUrl(j.src):p(j.textContent.replace(Ba,\"\"),k))}return a}function Ia(a,b,c){for(var d,e=b?r.filter(b,a):a,f=0;null!=(d=e[f]);f++)c||1!==d.nodeType||r.cleanData(la(d)),d.parentNode&&(c&&r.contains(d.ownerDocument,d)&&ma(la(d,\"script\")),d.parentNode.removeChild(d));return a}r.extend({htmlPrefilter:function(a){return a.replace(xa,\"<$1></$2>\")},clone:function(a,b,c){var d,e,f,g,h=a.cloneNode(!0),i=r.contains(a.ownerDocument,a);if(!(o.noCloneChecked||1!==a.nodeType&&11!==a.nodeType||r.isXMLDoc(a)))for(g=la(h),f=la(a),d=0,e=f.length;d<e;d++)Ga(f[d],g[d]);if(b)if(c)for(f=f||la(a),g=g||la(h),d=0,e=f.length;d<e;d++)Fa(f[d],g[d]);else Fa(a,h);return g=la(h,\"script\"),g.length>0&&ma(g,!i&&la(a,\"script\")),h},cleanData:function(a){for(var b,c,d,e=r.event.special,f=0;void 0!==(c=a[f]);f++)if(T(c)){if(b=c[V.expando]){if(b.events)for(d in b.events)e[d]?r.event.remove(c,d):r.removeEvent(c,d,b.handle);c[V.expando]=void 0}c[W.expando]&&(c[W.expando]=void 0)}}}),r.fn.extend({detach:function(a){return Ia(this,a,!0)},remove:function(a){return Ia(this,a)},text:function(a){return S(this,function(a){return void 0===a?r.text(this):this.empty().each(function(){1!==this.nodeType&&11!==this.nodeType&&9!==this.nodeType||(this.textContent=a)})},null,a,arguments.length)},append:function(){return Ha(this,arguments,function(a){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var b=Ca(this,a);b.appendChild(a)}})},prepend:function(){return Ha(this,arguments,function(a){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var b=Ca(this,a);b.insertBefore(a,b.firstChild)}})},before:function(){return Ha(this,arguments,function(a){this.parentNode&&this.parentNode.insertBefore(a,this)})},after:function(){return Ha(this,arguments,function(a){this.parentNode&&this.parentNode.insertBefore(a,this.nextSibling)})},empty:function(){for(var a,b=0;null!=(a=this[b]);b++)1===a.nodeType&&(r.cleanData(la(a,!1)),a.textContent=\"\");return this},clone:function(a,b){return a=null!=a&&a,b=null==b?a:b,this.map(function(){return r.clone(this,a,b)})},html:function(a){return S(this,function(a){var b=this[0]||{},c=0,d=this.length;if(void 0===a&&1===b.nodeType)return b.innerHTML;if(\"string\"==typeof a&&!ya.test(a)&&!ka[(ia.exec(a)||[\"\",\"\"])[1].toLowerCase()]){a=r.htmlPrefilter(a);try{for(;c<d;c++)b=this[c]||{},1===b.nodeType&&(r.cleanData(la(b,!1)),b.innerHTML=a);b=0}catch(e){}}b&&this.empty().append(a)},null,a,arguments.length)},replaceWith:function(){var a=[];return Ha(this,arguments,function(b){var c=this.parentNode;r.inArray(this,a)<0&&(r.cleanData(la(this)),c&&c.replaceChild(b,this))},a)}}),r.each({appendTo:\"append\",prependTo:\"prepend\",insertBefore:\"before\",insertAfter:\"after\",replaceAll:\"replaceWith\"},function(a,b){r.fn[a]=function(a){for(var c,d=[],e=r(a),f=e.length-1,g=0;g<=f;g++)c=g===f?this:this.clone(!0),r(e[g])[b](c),h.apply(d,c.get());return this.pushStack(d)}});var Ja=/^margin/,Ka=new RegExp(\"^(\"+$+\")(?!px)[a-z%]+$\",\"i\"),La=function(b){var c=b.ownerDocument.defaultView;return c&&c.opener||(c=a),c.getComputedStyle(b)};!function(){function b(){if(i){i.style.cssText=\"box-sizing:border-box;position:relative;display:block;margin:auto;border:1px;padding:1px;top:1%;width:50%\",i.innerHTML=\"\",pa.appendChild(h);var b=a.getComputedStyle(i);c=\"1%\"!==b.top,g=\"2px\"===b.marginLeft,e=\"4px\"===b.width,i.style.marginRight=\"50%\",f=\"4px\"===b.marginRight,pa.removeChild(h),i=null}}var c,e,f,g,h=d.createElement(\"div\"),i=d.createElement(\"div\");i.style&&(i.style.backgroundClip=\"content-box\",i.cloneNode(!0).style.backgroundClip=\"\",o.clearCloneStyle=\"content-box\"===i.style.backgroundClip,h.style.cssText=\"border:0;width:8px;height:0;top:0;left:-9999px;padding:0;margin-top:1px;position:absolute\",h.appendChild(i),r.extend(o,{pixelPosition:function(){return b(),c},boxSizingReliable:function(){return b(),e},pixelMarginRight:function(){return b(),f},reliableMarginLeft:function(){return b(),g}}))}();function Ma(a,b,c){var d,e,f,g,h=a.style;return c=c||La(a),c&&(g=c.getPropertyValue(b)||c[b],\"\"!==g||r.contains(a.ownerDocument,a)||(g=r.style(a,b)),!o.pixelMarginRight()&&Ka.test(g)&&Ja.test(b)&&(d=h.width,e=h.minWidth,f=h.maxWidth,h.minWidth=h.maxWidth=h.width=g,g=c.width,h.width=d,h.minWidth=e,h.maxWidth=f)),void 0!==g?g+\"\":g}function Na(a,b){return{get:function(){return a()?void delete this.get:(this.get=b).apply(this,arguments)}}}var Oa=/^(none|table(?!-c[ea]).+)/,Pa={position:\"absolute\",visibility:\"hidden\",display:\"block\"},Qa={letterSpacing:\"0\",fontWeight:\"400\"},Ra=[\"Webkit\",\"Moz\",\"ms\"],Sa=d.createElement(\"div\").style;function Ta(a){if(a in Sa)return a;var b=a[0].toUpperCase()+a.slice(1),c=Ra.length;while(c--)if(a=Ra[c]+b,a in Sa)return a}function Ua(a,b,c){var d=_.exec(b);return d?Math.max(0,d[2]-(c||0))+(d[3]||\"px\"):b}function Va(a,b,c,d,e){for(var f=c===(d?\"border\":\"content\")?4:\"width\"===b?1:0,g=0;f<4;f+=2)\"margin\"===c&&(g+=r.css(a,c+aa[f],!0,e)),d?(\"content\"===c&&(g-=r.css(a,\"padding\"+aa[f],!0,e)),\"margin\"!==c&&(g-=r.css(a,\"border\"+aa[f]+\"Width\",!0,e))):(g+=r.css(a,\"padding\"+aa[f],!0,e),\"padding\"!==c&&(g+=r.css(a,\"border\"+aa[f]+\"Width\",!0,e)));return g}function Wa(a,b,c){var d,e=!0,f=La(a),g=\"border-box\"===r.css(a,\"boxSizing\",!1,f);if(a.getClientRects().length&&(d=a.getBoundingClientRect()[b]),d<=0||null==d){if(d=Ma(a,b,f),(d<0||null==d)&&(d=a.style[b]),Ka.test(d))return d;e=g&&(o.boxSizingReliable()||d===a.style[b]),d=parseFloat(d)||0}return d+Va(a,b,c||(g?\"border\":\"content\"),e,f)+\"px\"}r.extend({cssHooks:{opacity:{get:function(a,b){if(b){var c=Ma(a,\"opacity\");return\"\"===c?\"1\":c}}}},cssNumber:{animationIterationCount:!0,columnCount:!0,fillOpacity:!0,flexGrow:!0,flexShrink:!0,fontWeight:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,widows:!0,zIndex:!0,zoom:!0},cssProps:{\"float\":\"cssFloat\"},style:function(a,b,c,d){if(a&&3!==a.nodeType&&8!==a.nodeType&&a.style){var e,f,g,h=r.camelCase(b),i=a.style;return b=r.cssProps[h]||(r.cssProps[h]=Ta(h)||h),g=r.cssHooks[b]||r.cssHooks[h],void 0===c?g&&\"get\"in g&&void 0!==(e=g.get(a,!1,d))?e:i[b]:(f=typeof c,\"string\"===f&&(e=_.exec(c))&&e[1]&&(c=da(a,b,e),f=\"number\"),null!=c&&c===c&&(\"number\"===f&&(c+=e&&e[3]||(r.cssNumber[h]?\"\":\"px\")),o.clearCloneStyle||\"\"!==c||0!==b.indexOf(\"background\")||(i[b]=\"inherit\"),g&&\"set\"in g&&void 0===(c=g.set(a,c,d))||(i[b]=c)),void 0)}},css:function(a,b,c,d){var e,f,g,h=r.camelCase(b);return b=r.cssProps[h]||(r.cssProps[h]=Ta(h)||h),g=r.cssHooks[b]||r.cssHooks[h],g&&\"get\"in g&&(e=g.get(a,!0,c)),void 0===e&&(e=Ma(a,b,d)),\"normal\"===e&&b in Qa&&(e=Qa[b]),\"\"===c||c?(f=parseFloat(e),c===!0||isFinite(f)?f||0:e):e}}),r.each([\"height\",\"width\"],function(a,b){r.cssHooks[b]={get:function(a,c,d){if(c)return!Oa.test(r.css(a,\"display\"))||a.getClientRects().length&&a.getBoundingClientRect().width?Wa(a,b,d):ca(a,Pa,function(){return Wa(a,b,d)})},set:function(a,c,d){var e,f=d&&La(a),g=d&&Va(a,b,d,\"border-box\"===r.css(a,\"boxSizing\",!1,f),f);return g&&(e=_.exec(c))&&\"px\"!==(e[3]||\"px\")&&(a.style[b]=c,c=r.css(a,b)),Ua(a,c,g)}}}),r.cssHooks.marginLeft=Na(o.reliableMarginLeft,function(a,b){if(b)return(parseFloat(Ma(a,\"marginLeft\"))||a.getBoundingClientRect().left-ca(a,{marginLeft:0},function(){return a.getBoundingClientRect().left}))+\"px\"}),r.each({margin:\"\",padding:\"\",border:\"Width\"},function(a,b){r.cssHooks[a+b]={expand:function(c){for(var d=0,e={},f=\"string\"==typeof c?c.split(\" \"):[c];d<4;d++)e[a+aa[d]+b]=f[d]||f[d-2]||f[0];return e}},Ja.test(a)||(r.cssHooks[a+b].set=Ua)}),r.fn.extend({css:function(a,b){return S(this,function(a,b,c){var d,e,f={},g=0;if(r.isArray(b)){for(d=La(a),e=b.length;g<e;g++)f[b[g]]=r.css(a,b[g],!1,d);return f}return void 0!==c?r.style(a,b,c):r.css(a,b)},a,b,arguments.length>1)}});function Xa(a,b,c,d,e){return new Xa.prototype.init(a,b,c,d,e)}r.Tween=Xa,Xa.prototype={constructor:Xa,init:function(a,b,c,d,e,f){this.elem=a,this.prop=c,this.easing=e||r.easing._default,this.options=b,this.start=this.now=this.cur(),this.end=d,this.unit=f||(r.cssNumber[c]?\"\":\"px\")},cur:function(){var a=Xa.propHooks[this.prop];return a&&a.get?a.get(this):Xa.propHooks._default.get(this)},run:function(a){var b,c=Xa.propHooks[this.prop];return this.options.duration?this.pos=b=r.easing[this.easing](a,this.options.duration*a,0,1,this.options.duration):this.pos=b=a,this.now=(this.end-this.start)*b+this.start,this.options.step&&this.options.step.call(this.elem,this.now,this),c&&c.set?c.set(this):Xa.propHooks._default.set(this),this}},Xa.prototype.init.prototype=Xa.prototype,Xa.propHooks={_default:{get:function(a){var b;return 1!==a.elem.nodeType||null!=a.elem[a.prop]&&null==a.elem.style[a.prop]?a.elem[a.prop]:(b=r.css(a.elem,a.prop,\"\"),b&&\"auto\"!==b?b:0)},set:function(a){r.fx.step[a.prop]?r.fx.step[a.prop](a):1!==a.elem.nodeType||null==a.elem.style[r.cssProps[a.prop]]&&!r.cssHooks[a.prop]?a.elem[a.prop]=a.now:r.style(a.elem,a.prop,a.now+a.unit)}}},Xa.propHooks.scrollTop=Xa.propHooks.scrollLeft={set:function(a){a.elem.nodeType&&a.elem.parentNode&&(a.elem[a.prop]=a.now)}},r.easing={linear:function(a){return a},swing:function(a){return.5-Math.cos(a*Math.PI)/2},_default:\"swing\"},r.fx=Xa.prototype.init,r.fx.step={};var Ya,Za,$a=/^(?:toggle|show|hide)$/,_a=/queueHooks$/;function ab(){Za&&(a.requestAnimationFrame(ab),r.fx.tick())}function bb(){return a.setTimeout(function(){Ya=void 0}),Ya=r.now()}function cb(a,b){var c,d=0,e={height:a};for(b=b?1:0;d<4;d+=2-b)c=aa[d],e[\"margin\"+c]=e[\"padding\"+c]=a;return b&&(e.opacity=e.width=a),e}function db(a,b,c){for(var d,e=(gb.tweeners[b]||[]).concat(gb.tweeners[\"*\"]),f=0,g=e.length;f<g;f++)if(d=e[f].call(c,b,a))return d}function eb(a,b,c){var d,e,f,g,h,i,j,k,l=\"width\"in b||\"height\"in b,m=this,n={},o=a.style,p=a.nodeType&&ba(a),q=V.get(a,\"fxshow\");c.queue||(g=r._queueHooks(a,\"fx\"),null==g.unqueued&&(g.unqueued=0,h=g.empty.fire,g.empty.fire=function(){g.unqueued||h()}),g.unqueued++,m.always(function(){m.always(function(){g.unqueued--,r.queue(a,\"fx\").length||g.empty.fire()})}));for(d in b)if(e=b[d],$a.test(e)){if(delete b[d],f=f||\"toggle\"===e,e===(p?\"hide\":\"show\")){if(\"show\"!==e||!q||void 0===q[d])continue;p=!0}n[d]=q&&q[d]||r.style(a,d)}if(i=!r.isEmptyObject(b),i||!r.isEmptyObject(n)){l&&1===a.nodeType&&(c.overflow=[o.overflow,o.overflowX,o.overflowY],j=q&&q.display,null==j&&(j=V.get(a,\"display\")),k=r.css(a,\"display\"),\"none\"===k&&(j?k=j:(ga([a],!0),j=a.style.display||j,k=r.css(a,\"display\"),ga([a]))),(\"inline\"===k||\"inline-block\"===k&&null!=j)&&\"none\"===r.css(a,\"float\")&&(i||(m.done(function(){o.display=j}),null==j&&(k=o.display,j=\"none\"===k?\"\":k)),o.display=\"inline-block\")),c.overflow&&(o.overflow=\"hidden\",m.always(function(){o.overflow=c.overflow[0],o.overflowX=c.overflow[1],o.overflowY=c.overflow[2]})),i=!1;for(d in n)i||(q?\"hidden\"in q&&(p=q.hidden):q=V.access(a,\"fxshow\",{display:j}),f&&(q.hidden=!p),p&&ga([a],!0),m.done(function(){p||ga([a]),V.remove(a,\"fxshow\");for(d in n)r.style(a,d,n[d])})),i=db(p?q[d]:0,d,m),d in q||(q[d]=i.start,p&&(i.end=i.start,i.start=0))}}function fb(a,b){var c,d,e,f,g;for(c in a)if(d=r.camelCase(c),e=b[d],f=a[c],r.isArray(f)&&(e=f[1],f=a[c]=f[0]),c!==d&&(a[d]=f,delete a[c]),g=r.cssHooks[d],g&&\"expand\"in g){f=g.expand(f),delete a[d];for(c in f)c in a||(a[c]=f[c],b[c]=e)}else b[d]=e}function gb(a,b,c){var d,e,f=0,g=gb.prefilters.length,h=r.Deferred().always(function(){delete i.elem}),i=function(){if(e)return!1;for(var b=Ya||bb(),c=Math.max(0,j.startTime+j.duration-b),d=c/j.duration||0,f=1-d,g=0,i=j.tweens.length;g<i;g++)j.tweens[g].run(f);return h.notifyWith(a,[j,f,c]),f<1&&i?c:(h.resolveWith(a,[j]),!1)},j=h.promise({elem:a,props:r.extend({},b),opts:r.extend(!0,{specialEasing:{},easing:r.easing._default},c),originalProperties:b,originalOptions:c,startTime:Ya||bb(),duration:c.duration,tweens:[],createTween:function(b,c){var d=r.Tween(a,j.opts,b,c,j.opts.specialEasing[b]||j.opts.easing);return j.tweens.push(d),d},stop:function(b){var c=0,d=b?j.tweens.length:0;if(e)return this;for(e=!0;c<d;c++)j.tweens[c].run(1);return b?(h.notifyWith(a,[j,1,0]),h.resolveWith(a,[j,b])):h.rejectWith(a,[j,b]),this}}),k=j.props;for(fb(k,j.opts.specialEasing);f<g;f++)if(d=gb.prefilters[f].call(j,a,k,j.opts))return r.isFunction(d.stop)&&(r._queueHooks(j.elem,j.opts.queue).stop=r.proxy(d.stop,d)),d;return r.map(k,db,j),r.isFunction(j.opts.start)&&j.opts.start.call(a,j),r.fx.timer(r.extend(i,{elem:a,anim:j,queue:j.opts.queue})),j.progress(j.opts.progress).done(j.opts.done,j.opts.complete).fail(j.opts.fail).always(j.opts.always)}r.Animation=r.extend(gb,{tweeners:{\"*\":[function(a,b){var c=this.createTween(a,b);return da(c.elem,a,_.exec(b),c),c}]},tweener:function(a,b){r.isFunction(a)?(b=a,a=[\"*\"]):a=a.match(K);for(var c,d=0,e=a.length;d<e;d++)c=a[d],gb.tweeners[c]=gb.tweeners[c]||[],gb.tweeners[c].unshift(b)},prefilters:[eb],prefilter:function(a,b){b?gb.prefilters.unshift(a):gb.prefilters.push(a)}}),r.speed=function(a,b,c){var e=a&&\"object\"==typeof a?r.extend({},a):{complete:c||!c&&b||r.isFunction(a)&&a,duration:a,easing:c&&b||b&&!r.isFunction(b)&&b};return r.fx.off||d.hidden?e.duration=0:e.duration=\"number\"==typeof e.duration?e.duration:e.duration in r.fx.speeds?r.fx.speeds[e.duration]:r.fx.speeds._default,null!=e.queue&&e.queue!==!0||(e.queue=\"fx\"),e.old=e.complete,e.complete=function(){r.isFunction(e.old)&&e.old.call(this),e.queue&&r.dequeue(this,e.queue)},e},r.fn.extend({fadeTo:function(a,b,c,d){return this.filter(ba).css(\"opacity\",0).show().end().animate({opacity:b},a,c,d)},animate:function(a,b,c,d){var e=r.isEmptyObject(a),f=r.speed(b,c,d),g=function(){var b=gb(this,r.extend({},a),f);(e||V.get(this,\"finish\"))&&b.stop(!0)};return g.finish=g,e||f.queue===!1?this.each(g):this.queue(f.queue,g)},stop:function(a,b,c){var d=function(a){var b=a.stop;delete a.stop,b(c)};return\"string\"!=typeof a&&(c=b,b=a,a=void 0),b&&a!==!1&&this.queue(a||\"fx\",[]),this.each(function(){var b=!0,e=null!=a&&a+\"queueHooks\",f=r.timers,g=V.get(this);if(e)g[e]&&g[e].stop&&d(g[e]);else for(e in g)g[e]&&g[e].stop&&_a.test(e)&&d(g[e]);for(e=f.length;e--;)f[e].elem!==this||null!=a&&f[e].queue!==a||(f[e].anim.stop(c),b=!1,f.splice(e,1));!b&&c||r.dequeue(this,a)})},finish:function(a){return a!==!1&&(a=a||\"fx\"),this.each(function(){var b,c=V.get(this),d=c[a+\"queue\"],e=c[a+\"queueHooks\"],f=r.timers,g=d?d.length:0;for(c.finish=!0,r.queue(this,a,[]),e&&e.stop&&e.stop.call(this,!0),b=f.length;b--;)f[b].elem===this&&f[b].queue===a&&(f[b].anim.stop(!0),f.splice(b,1));for(b=0;b<g;b++)d[b]&&d[b].finish&&d[b].finish.call(this);delete c.finish})}}),r.each([\"toggle\",\"show\",\"hide\"],function(a,b){var c=r.fn[b];r.fn[b]=function(a,d,e){return null==a||\"boolean\"==typeof a?c.apply(this,arguments):this.animate(cb(b,!0),a,d,e)}}),r.each({slideDown:cb(\"show\"),slideUp:cb(\"hide\"),slideToggle:cb(\"toggle\"),fadeIn:{opacity:\"show\"},fadeOut:{opacity:\"hide\"},fadeToggle:{opacity:\"toggle\"}},function(a,b){r.fn[a]=function(a,c,d){return this.animate(b,a,c,d)}}),r.timers=[],r.fx.tick=function(){var a,b=0,c=r.timers;for(Ya=r.now();b<c.length;b++)a=c[b],a()||c[b]!==a||c.splice(b--,1);c.length||r.fx.stop(),Ya=void 0},r.fx.timer=function(a){r.timers.push(a),a()?r.fx.start():r.timers.pop()},r.fx.interval=13,r.fx.start=function(){Za||(Za=a.requestAnimationFrame?a.requestAnimationFrame(ab):a.setInterval(r.fx.tick,r.fx.interval))},r.fx.stop=function(){a.cancelAnimationFrame?a.cancelAnimationFrame(Za):a.clearInterval(Za),Za=null},r.fx.speeds={slow:600,fast:200,_default:400},r.fn.delay=function(b,c){return b=r.fx?r.fx.speeds[b]||b:b,c=c||\"fx\",this.queue(c,function(c,d){var e=a.setTimeout(c,b);d.stop=function(){a.clearTimeout(e)}})},function(){var a=d.createElement(\"input\"),b=d.createElement(\"select\"),c=b.appendChild(d.createElement(\"option\"));a.type=\"checkbox\",o.checkOn=\"\"!==a.value,o.optSelected=c.selected,a=d.createElement(\"input\"),a.value=\"t\",a.type=\"radio\",o.radioValue=\"t\"===a.value}();var hb,ib=r.expr.attrHandle;r.fn.extend({attr:function(a,b){return S(this,r.attr,a,b,arguments.length>1)},removeAttr:function(a){return this.each(function(){r.removeAttr(this,a)})}}),r.extend({attr:function(a,b,c){var d,e,f=a.nodeType;if(3!==f&&8!==f&&2!==f)return\"undefined\"==typeof a.getAttribute?r.prop(a,b,c):(1===f&&r.isXMLDoc(a)||(e=r.attrHooks[b.toLowerCase()]||(r.expr.match.bool.test(b)?hb:void 0)),void 0!==c?null===c?void r.removeAttr(a,b):e&&\"set\"in e&&void 0!==(d=e.set(a,c,b))?d:(a.setAttribute(b,c+\"\"),c):e&&\"get\"in e&&null!==(d=e.get(a,b))?d:(d=r.find.attr(a,b),null==d?void 0:d))},attrHooks:{type:{set:function(a,b){if(!o.radioValue&&\"radio\"===b&&r.nodeName(a,\"input\")){var c=a.value;return a.setAttribute(\"type\",b),c&&(a.value=c),b}}}},removeAttr:function(a,b){var c,d=0,e=b&&b.match(K);\nif(e&&1===a.nodeType)while(c=e[d++])a.removeAttribute(c)}}),hb={set:function(a,b,c){return b===!1?r.removeAttr(a,c):a.setAttribute(c,c),c}},r.each(r.expr.match.bool.source.match(/\\w+/g),function(a,b){var c=ib[b]||r.find.attr;ib[b]=function(a,b,d){var e,f,g=b.toLowerCase();return d||(f=ib[g],ib[g]=e,e=null!=c(a,b,d)?g:null,ib[g]=f),e}});var jb=/^(?:input|select|textarea|button)$/i,kb=/^(?:a|area)$/i;r.fn.extend({prop:function(a,b){return S(this,r.prop,a,b,arguments.length>1)},removeProp:function(a){return this.each(function(){delete this[r.propFix[a]||a]})}}),r.extend({prop:function(a,b,c){var d,e,f=a.nodeType;if(3!==f&&8!==f&&2!==f)return 1===f&&r.isXMLDoc(a)||(b=r.propFix[b]||b,e=r.propHooks[b]),void 0!==c?e&&\"set\"in e&&void 0!==(d=e.set(a,c,b))?d:a[b]=c:e&&\"get\"in e&&null!==(d=e.get(a,b))?d:a[b]},propHooks:{tabIndex:{get:function(a){var b=r.find.attr(a,\"tabindex\");return b?parseInt(b,10):jb.test(a.nodeName)||kb.test(a.nodeName)&&a.href?0:-1}}},propFix:{\"for\":\"htmlFor\",\"class\":\"className\"}}),o.optSelected||(r.propHooks.selected={get:function(a){var b=a.parentNode;return b&&b.parentNode&&b.parentNode.selectedIndex,null},set:function(a){var b=a.parentNode;b&&(b.selectedIndex,b.parentNode&&b.parentNode.selectedIndex)}}),r.each([\"tabIndex\",\"readOnly\",\"maxLength\",\"cellSpacing\",\"cellPadding\",\"rowSpan\",\"colSpan\",\"useMap\",\"frameBorder\",\"contentEditable\"],function(){r.propFix[this.toLowerCase()]=this});var lb=/[\\t\\r\\n\\f]/g;function mb(a){return a.getAttribute&&a.getAttribute(\"class\")||\"\"}r.fn.extend({addClass:function(a){var b,c,d,e,f,g,h,i=0;if(r.isFunction(a))return this.each(function(b){r(this).addClass(a.call(this,b,mb(this)))});if(\"string\"==typeof a&&a){b=a.match(K)||[];while(c=this[i++])if(e=mb(c),d=1===c.nodeType&&(\" \"+e+\" \").replace(lb,\" \")){g=0;while(f=b[g++])d.indexOf(\" \"+f+\" \")<0&&(d+=f+\" \");h=r.trim(d),e!==h&&c.setAttribute(\"class\",h)}}return this},removeClass:function(a){var b,c,d,e,f,g,h,i=0;if(r.isFunction(a))return this.each(function(b){r(this).removeClass(a.call(this,b,mb(this)))});if(!arguments.length)return this.attr(\"class\",\"\");if(\"string\"==typeof a&&a){b=a.match(K)||[];while(c=this[i++])if(e=mb(c),d=1===c.nodeType&&(\" \"+e+\" \").replace(lb,\" \")){g=0;while(f=b[g++])while(d.indexOf(\" \"+f+\" \")>-1)d=d.replace(\" \"+f+\" \",\" \");h=r.trim(d),e!==h&&c.setAttribute(\"class\",h)}}return this},toggleClass:function(a,b){var c=typeof a;return\"boolean\"==typeof b&&\"string\"===c?b?this.addClass(a):this.removeClass(a):r.isFunction(a)?this.each(function(c){r(this).toggleClass(a.call(this,c,mb(this),b),b)}):this.each(function(){var b,d,e,f;if(\"string\"===c){d=0,e=r(this),f=a.match(K)||[];while(b=f[d++])e.hasClass(b)?e.removeClass(b):e.addClass(b)}else void 0!==a&&\"boolean\"!==c||(b=mb(this),b&&V.set(this,\"__className__\",b),this.setAttribute&&this.setAttribute(\"class\",b||a===!1?\"\":V.get(this,\"__className__\")||\"\"))})},hasClass:function(a){var b,c,d=0;b=\" \"+a+\" \";while(c=this[d++])if(1===c.nodeType&&(\" \"+mb(c)+\" \").replace(lb,\" \").indexOf(b)>-1)return!0;return!1}});var nb=/\\r/g,ob=/[\\x20\\t\\r\\n\\f]+/g;r.fn.extend({val:function(a){var b,c,d,e=this[0];{if(arguments.length)return d=r.isFunction(a),this.each(function(c){var e;1===this.nodeType&&(e=d?a.call(this,c,r(this).val()):a,null==e?e=\"\":\"number\"==typeof e?e+=\"\":r.isArray(e)&&(e=r.map(e,function(a){return null==a?\"\":a+\"\"})),b=r.valHooks[this.type]||r.valHooks[this.nodeName.toLowerCase()],b&&\"set\"in b&&void 0!==b.set(this,e,\"value\")||(this.value=e))});if(e)return b=r.valHooks[e.type]||r.valHooks[e.nodeName.toLowerCase()],b&&\"get\"in b&&void 0!==(c=b.get(e,\"value\"))?c:(c=e.value,\"string\"==typeof c?c.replace(nb,\"\"):null==c?\"\":c)}}}),r.extend({valHooks:{option:{get:function(a){var b=r.find.attr(a,\"value\");return null!=b?b:r.trim(r.text(a)).replace(ob,\" \")}},select:{get:function(a){for(var b,c,d=a.options,e=a.selectedIndex,f=\"select-one\"===a.type,g=f?null:[],h=f?e+1:d.length,i=e<0?h:f?e:0;i<h;i++)if(c=d[i],(c.selected||i===e)&&!c.disabled&&(!c.parentNode.disabled||!r.nodeName(c.parentNode,\"optgroup\"))){if(b=r(c).val(),f)return b;g.push(b)}return g},set:function(a,b){var c,d,e=a.options,f=r.makeArray(b),g=e.length;while(g--)d=e[g],(d.selected=r.inArray(r.valHooks.option.get(d),f)>-1)&&(c=!0);return c||(a.selectedIndex=-1),f}}}}),r.each([\"radio\",\"checkbox\"],function(){r.valHooks[this]={set:function(a,b){if(r.isArray(b))return a.checked=r.inArray(r(a).val(),b)>-1}},o.checkOn||(r.valHooks[this].get=function(a){return null===a.getAttribute(\"value\")?\"on\":a.value})});var pb=/^(?:focusinfocus|focusoutblur)$/;r.extend(r.event,{trigger:function(b,c,e,f){var g,h,i,j,k,m,n,o=[e||d],p=l.call(b,\"type\")?b.type:b,q=l.call(b,\"namespace\")?b.namespace.split(\".\"):[];if(h=i=e=e||d,3!==e.nodeType&&8!==e.nodeType&&!pb.test(p+r.event.triggered)&&(p.indexOf(\".\")>-1&&(q=p.split(\".\"),p=q.shift(),q.sort()),k=p.indexOf(\":\")<0&&\"on\"+p,b=b[r.expando]?b:new r.Event(p,\"object\"==typeof b&&b),b.isTrigger=f?2:3,b.namespace=q.join(\".\"),b.rnamespace=b.namespace?new RegExp(\"(^|\\\\.)\"+q.join(\"\\\\.(?:.*\\\\.|)\")+\"(\\\\.|$)\"):null,b.result=void 0,b.target||(b.target=e),c=null==c?[b]:r.makeArray(c,[b]),n=r.event.special[p]||{},f||!n.trigger||n.trigger.apply(e,c)!==!1)){if(!f&&!n.noBubble&&!r.isWindow(e)){for(j=n.delegateType||p,pb.test(j+p)||(h=h.parentNode);h;h=h.parentNode)o.push(h),i=h;i===(e.ownerDocument||d)&&o.push(i.defaultView||i.parentWindow||a)}g=0;while((h=o[g++])&&!b.isPropagationStopped())b.type=g>1?j:n.bindType||p,m=(V.get(h,\"events\")||{})[b.type]&&V.get(h,\"handle\"),m&&m.apply(h,c),m=k&&h[k],m&&m.apply&&T(h)&&(b.result=m.apply(h,c),b.result===!1&&b.preventDefault());return b.type=p,f||b.isDefaultPrevented()||n._default&&n._default.apply(o.pop(),c)!==!1||!T(e)||k&&r.isFunction(e[p])&&!r.isWindow(e)&&(i=e[k],i&&(e[k]=null),r.event.triggered=p,e[p](),r.event.triggered=void 0,i&&(e[k]=i)),b.result}},simulate:function(a,b,c){var d=r.extend(new r.Event,c,{type:a,isSimulated:!0});r.event.trigger(d,null,b)}}),r.fn.extend({trigger:function(a,b){return this.each(function(){r.event.trigger(a,b,this)})},triggerHandler:function(a,b){var c=this[0];if(c)return r.event.trigger(a,b,c,!0)}}),r.each(\"blur focus focusin focusout resize scroll click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup contextmenu\".split(\" \"),function(a,b){r.fn[b]=function(a,c){return arguments.length>0?this.on(b,null,a,c):this.trigger(b)}}),r.fn.extend({hover:function(a,b){return this.mouseenter(a).mouseleave(b||a)}}),o.focusin=\"onfocusin\"in a,o.focusin||r.each({focus:\"focusin\",blur:\"focusout\"},function(a,b){var c=function(a){r.event.simulate(b,a.target,r.event.fix(a))};r.event.special[b]={setup:function(){var d=this.ownerDocument||this,e=V.access(d,b);e||d.addEventListener(a,c,!0),V.access(d,b,(e||0)+1)},teardown:function(){var d=this.ownerDocument||this,e=V.access(d,b)-1;e?V.access(d,b,e):(d.removeEventListener(a,c,!0),V.remove(d,b))}}});var qb=a.location,rb=r.now(),sb=/\\?/;r.parseXML=function(b){var c;if(!b||\"string\"!=typeof b)return null;try{c=(new a.DOMParser).parseFromString(b,\"text/xml\")}catch(d){c=void 0}return c&&!c.getElementsByTagName(\"parsererror\").length||r.error(\"Invalid XML: \"+b),c};var tb=/\\[\\]$/,ub=/\\r?\\n/g,vb=/^(?:submit|button|image|reset|file)$/i,wb=/^(?:input|select|textarea|keygen)/i;function xb(a,b,c,d){var e;if(r.isArray(b))r.each(b,function(b,e){c||tb.test(a)?d(a,e):xb(a+\"[\"+(\"object\"==typeof e&&null!=e?b:\"\")+\"]\",e,c,d)});else if(c||\"object\"!==r.type(b))d(a,b);else for(e in b)xb(a+\"[\"+e+\"]\",b[e],c,d)}r.param=function(a,b){var c,d=[],e=function(a,b){var c=r.isFunction(b)?b():b;d[d.length]=encodeURIComponent(a)+\"=\"+encodeURIComponent(null==c?\"\":c)};if(r.isArray(a)||a.jquery&&!r.isPlainObject(a))r.each(a,function(){e(this.name,this.value)});else for(c in a)xb(c,a[c],b,e);return d.join(\"&\")},r.fn.extend({serialize:function(){return r.param(this.serializeArray())},serializeArray:function(){return this.map(function(){var a=r.prop(this,\"elements\");return a?r.makeArray(a):this}).filter(function(){var a=this.type;return this.name&&!r(this).is(\":disabled\")&&wb.test(this.nodeName)&&!vb.test(a)&&(this.checked||!ha.test(a))}).map(function(a,b){var c=r(this).val();return null==c?null:r.isArray(c)?r.map(c,function(a){return{name:b.name,value:a.replace(ub,\"\\r\\n\")}}):{name:b.name,value:c.replace(ub,\"\\r\\n\")}}).get()}});var yb=/%20/g,zb=/#.*$/,Ab=/([?&])_=[^&]*/,Bb=/^(.*?):[ \\t]*([^\\r\\n]*)$/gm,Cb=/^(?:about|app|app-storage|.+-extension|file|res|widget):$/,Db=/^(?:GET|HEAD)$/,Eb=/^\\/\\//,Fb={},Gb={},Hb=\"*/\".concat(\"*\"),Ib=d.createElement(\"a\");Ib.href=qb.href;function Jb(a){return function(b,c){\"string\"!=typeof b&&(c=b,b=\"*\");var d,e=0,f=b.toLowerCase().match(K)||[];if(r.isFunction(c))while(d=f[e++])\"+\"===d[0]?(d=d.slice(1)||\"*\",(a[d]=a[d]||[]).unshift(c)):(a[d]=a[d]||[]).push(c)}}function Kb(a,b,c,d){var e={},f=a===Gb;function g(h){var i;return e[h]=!0,r.each(a[h]||[],function(a,h){var j=h(b,c,d);return\"string\"!=typeof j||f||e[j]?f?!(i=j):void 0:(b.dataTypes.unshift(j),g(j),!1)}),i}return g(b.dataTypes[0])||!e[\"*\"]&&g(\"*\")}function Lb(a,b){var c,d,e=r.ajaxSettings.flatOptions||{};for(c in b)void 0!==b[c]&&((e[c]?a:d||(d={}))[c]=b[c]);return d&&r.extend(!0,a,d),a}function Mb(a,b,c){var d,e,f,g,h=a.contents,i=a.dataTypes;while(\"*\"===i[0])i.shift(),void 0===d&&(d=a.mimeType||b.getResponseHeader(\"Content-Type\"));if(d)for(e in h)if(h[e]&&h[e].test(d)){i.unshift(e);break}if(i[0]in c)f=i[0];else{for(e in c){if(!i[0]||a.converters[e+\" \"+i[0]]){f=e;break}g||(g=e)}f=f||g}if(f)return f!==i[0]&&i.unshift(f),c[f]}function Nb(a,b,c,d){var e,f,g,h,i,j={},k=a.dataTypes.slice();if(k[1])for(g in a.converters)j[g.toLowerCase()]=a.converters[g];f=k.shift();while(f)if(a.responseFields[f]&&(c[a.responseFields[f]]=b),!i&&d&&a.dataFilter&&(b=a.dataFilter(b,a.dataType)),i=f,f=k.shift())if(\"*\"===f)f=i;else if(\"*\"!==i&&i!==f){if(g=j[i+\" \"+f]||j[\"* \"+f],!g)for(e in j)if(h=e.split(\" \"),h[1]===f&&(g=j[i+\" \"+h[0]]||j[\"* \"+h[0]])){g===!0?g=j[e]:j[e]!==!0&&(f=h[0],k.unshift(h[1]));break}if(g!==!0)if(g&&a[\"throws\"])b=g(b);else try{b=g(b)}catch(l){return{state:\"parsererror\",error:g?l:\"No conversion from \"+i+\" to \"+f}}}return{state:\"success\",data:b}}r.extend({active:0,lastModified:{},etag:{},ajaxSettings:{url:qb.href,type:\"GET\",isLocal:Cb.test(qb.protocol),global:!0,processData:!0,async:!0,contentType:\"application/x-www-form-urlencoded; charset=UTF-8\",accepts:{\"*\":Hb,text:\"text/plain\",html:\"text/html\",xml:\"application/xml, text/xml\",json:\"application/json, text/javascript\"},contents:{xml:/\\bxml\\b/,html:/\\bhtml/,json:/\\bjson\\b/},responseFields:{xml:\"responseXML\",text:\"responseText\",json:\"responseJSON\"},converters:{\"* text\":String,\"text html\":!0,\"text json\":JSON.parse,\"text xml\":r.parseXML},flatOptions:{url:!0,context:!0}},ajaxSetup:function(a,b){return b?Lb(Lb(a,r.ajaxSettings),b):Lb(r.ajaxSettings,a)},ajaxPrefilter:Jb(Fb),ajaxTransport:Jb(Gb),ajax:function(b,c){\"object\"==typeof b&&(c=b,b=void 0),c=c||{};var e,f,g,h,i,j,k,l,m,n,o=r.ajaxSetup({},c),p=o.context||o,q=o.context&&(p.nodeType||p.jquery)?r(p):r.event,s=r.Deferred(),t=r.Callbacks(\"once memory\"),u=o.statusCode||{},v={},w={},x=\"canceled\",y={readyState:0,getResponseHeader:function(a){var b;if(k){if(!h){h={};while(b=Bb.exec(g))h[b[1].toLowerCase()]=b[2]}b=h[a.toLowerCase()]}return null==b?null:b},getAllResponseHeaders:function(){return k?g:null},setRequestHeader:function(a,b){return null==k&&(a=w[a.toLowerCase()]=w[a.toLowerCase()]||a,v[a]=b),this},overrideMimeType:function(a){return null==k&&(o.mimeType=a),this},statusCode:function(a){var b;if(a)if(k)y.always(a[y.status]);else for(b in a)u[b]=[u[b],a[b]];return this},abort:function(a){var b=a||x;return e&&e.abort(b),A(0,b),this}};if(s.promise(y),o.url=((b||o.url||qb.href)+\"\").replace(Eb,qb.protocol+\"//\"),o.type=c.method||c.type||o.method||o.type,o.dataTypes=(o.dataType||\"*\").toLowerCase().match(K)||[\"\"],null==o.crossDomain){j=d.createElement(\"a\");try{j.href=o.url,j.href=j.href,o.crossDomain=Ib.protocol+\"//\"+Ib.host!=j.protocol+\"//\"+j.host}catch(z){o.crossDomain=!0}}if(o.data&&o.processData&&\"string\"!=typeof o.data&&(o.data=r.param(o.data,o.traditional)),Kb(Fb,o,c,y),k)return y;l=r.event&&o.global,l&&0===r.active++&&r.event.trigger(\"ajaxStart\"),o.type=o.type.toUpperCase(),o.hasContent=!Db.test(o.type),f=o.url.replace(zb,\"\"),o.hasContent?o.data&&o.processData&&0===(o.contentType||\"\").indexOf(\"application/x-www-form-urlencoded\")&&(o.data=o.data.replace(yb,\"+\")):(n=o.url.slice(f.length),o.data&&(f+=(sb.test(f)?\"&\":\"?\")+o.data,delete o.data),o.cache===!1&&(f=f.replace(Ab,\"\"),n=(sb.test(f)?\"&\":\"?\")+\"_=\"+rb++ +n),o.url=f+n),o.ifModified&&(r.lastModified[f]&&y.setRequestHeader(\"If-Modified-Since\",r.lastModified[f]),r.etag[f]&&y.setRequestHeader(\"If-None-Match\",r.etag[f])),(o.data&&o.hasContent&&o.contentType!==!1||c.contentType)&&y.setRequestHeader(\"Content-Type\",o.contentType),y.setRequestHeader(\"Accept\",o.dataTypes[0]&&o.accepts[o.dataTypes[0]]?o.accepts[o.dataTypes[0]]+(\"*\"!==o.dataTypes[0]?\", \"+Hb+\"; q=0.01\":\"\"):o.accepts[\"*\"]);for(m in o.headers)y.setRequestHeader(m,o.headers[m]);if(o.beforeSend&&(o.beforeSend.call(p,y,o)===!1||k))return y.abort();if(x=\"abort\",t.add(o.complete),y.done(o.success),y.fail(o.error),e=Kb(Gb,o,c,y)){if(y.readyState=1,l&&q.trigger(\"ajaxSend\",[y,o]),k)return y;o.async&&o.timeout>0&&(i=a.setTimeout(function(){y.abort(\"timeout\")},o.timeout));try{k=!1,e.send(v,A)}catch(z){if(k)throw z;A(-1,z)}}else A(-1,\"No Transport\");function A(b,c,d,h){var j,m,n,v,w,x=c;k||(k=!0,i&&a.clearTimeout(i),e=void 0,g=h||\"\",y.readyState=b>0?4:0,j=b>=200&&b<300||304===b,d&&(v=Mb(o,y,d)),v=Nb(o,v,y,j),j?(o.ifModified&&(w=y.getResponseHeader(\"Last-Modified\"),w&&(r.lastModified[f]=w),w=y.getResponseHeader(\"etag\"),w&&(r.etag[f]=w)),204===b||\"HEAD\"===o.type?x=\"nocontent\":304===b?x=\"notmodified\":(x=v.state,m=v.data,n=v.error,j=!n)):(n=x,!b&&x||(x=\"error\",b<0&&(b=0))),y.status=b,y.statusText=(c||x)+\"\",j?s.resolveWith(p,[m,x,y]):s.rejectWith(p,[y,x,n]),y.statusCode(u),u=void 0,l&&q.trigger(j?\"ajaxSuccess\":\"ajaxError\",[y,o,j?m:n]),t.fireWith(p,[y,x]),l&&(q.trigger(\"ajaxComplete\",[y,o]),--r.active||r.event.trigger(\"ajaxStop\")))}return y},getJSON:function(a,b,c){return r.get(a,b,c,\"json\")},getScript:function(a,b){return r.get(a,void 0,b,\"script\")}}),r.each([\"get\",\"post\"],function(a,b){r[b]=function(a,c,d,e){return r.isFunction(c)&&(e=e||d,d=c,c=void 0),r.ajax(r.extend({url:a,type:b,dataType:e,data:c,success:d},r.isPlainObject(a)&&a))}}),r._evalUrl=function(a){return r.ajax({url:a,type:\"GET\",dataType:\"script\",cache:!0,async:!1,global:!1,\"throws\":!0})},r.fn.extend({wrapAll:function(a){var b;return this[0]&&(r.isFunction(a)&&(a=a.call(this[0])),b=r(a,this[0].ownerDocument).eq(0).clone(!0),this[0].parentNode&&b.insertBefore(this[0]),b.map(function(){var a=this;while(a.firstElementChild)a=a.firstElementChild;return a}).append(this)),this},wrapInner:function(a){return r.isFunction(a)?this.each(function(b){r(this).wrapInner(a.call(this,b))}):this.each(function(){var b=r(this),c=b.contents();c.length?c.wrapAll(a):b.append(a)})},wrap:function(a){var b=r.isFunction(a);return this.each(function(c){r(this).wrapAll(b?a.call(this,c):a)})},unwrap:function(a){return this.parent(a).not(\"body\").each(function(){r(this).replaceWith(this.childNodes)}),this}}),r.expr.pseudos.hidden=function(a){return!r.expr.pseudos.visible(a)},r.expr.pseudos.visible=function(a){return!!(a.offsetWidth||a.offsetHeight||a.getClientRects().length)},r.ajaxSettings.xhr=function(){try{return new a.XMLHttpRequest}catch(b){}};var Ob={0:200,1223:204},Pb=r.ajaxSettings.xhr();o.cors=!!Pb&&\"withCredentials\"in Pb,o.ajax=Pb=!!Pb,r.ajaxTransport(function(b){var c,d;if(o.cors||Pb&&!b.crossDomain)return{send:function(e,f){var g,h=b.xhr();if(h.open(b.type,b.url,b.async,b.username,b.password),b.xhrFields)for(g in b.xhrFields)h[g]=b.xhrFields[g];b.mimeType&&h.overrideMimeType&&h.overrideMimeType(b.mimeType),b.crossDomain||e[\"X-Requested-With\"]||(e[\"X-Requested-With\"]=\"XMLHttpRequest\");for(g in e)h.setRequestHeader(g,e[g]);c=function(a){return function(){c&&(c=d=h.onload=h.onerror=h.onabort=h.onreadystatechange=null,\"abort\"===a?h.abort():\"error\"===a?\"number\"!=typeof h.status?f(0,\"error\"):f(h.status,h.statusText):f(Ob[h.status]||h.status,h.statusText,\"text\"!==(h.responseType||\"text\")||\"string\"!=typeof h.responseText?{binary:h.response}:{text:h.responseText},h.getAllResponseHeaders()))}},h.onload=c(),d=h.onerror=c(\"error\"),void 0!==h.onabort?h.onabort=d:h.onreadystatechange=function(){4===h.readyState&&a.setTimeout(function(){c&&d()})},c=c(\"abort\");try{h.send(b.hasContent&&b.data||null)}catch(i){if(c)throw i}},abort:function(){c&&c()}}}),r.ajaxPrefilter(function(a){a.crossDomain&&(a.contents.script=!1)}),r.ajaxSetup({accepts:{script:\"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript\"},contents:{script:/\\b(?:java|ecma)script\\b/},converters:{\"text script\":function(a){return r.globalEval(a),a}}}),r.ajaxPrefilter(\"script\",function(a){void 0===a.cache&&(a.cache=!1),a.crossDomain&&(a.type=\"GET\")}),r.ajaxTransport(\"script\",function(a){if(a.crossDomain){var b,c;return{send:function(e,f){b=r(\"<script>\").prop({charset:a.scriptCharset,src:a.url}).on(\"load error\",c=function(a){b.remove(),c=null,a&&f(\"error\"===a.type?404:200,a.type)}),d.head.appendChild(b[0])},abort:function(){c&&c()}}}});var Qb=[],Rb=/(=)\\?(?=&|$)|\\?\\?/;r.ajaxSetup({jsonp:\"callback\",jsonpCallback:function(){var a=Qb.pop()||r.expando+\"_\"+rb++;return this[a]=!0,a}}),r.ajaxPrefilter(\"json jsonp\",function(b,c,d){var e,f,g,h=b.jsonp!==!1&&(Rb.test(b.url)?\"url\":\"string\"==typeof b.data&&0===(b.contentType||\"\").indexOf(\"application/x-www-form-urlencoded\")&&Rb.test(b.data)&&\"data\");if(h||\"jsonp\"===b.dataTypes[0])return e=b.jsonpCallback=r.isFunction(b.jsonpCallback)?b.jsonpCallback():b.jsonpCallback,h?b[h]=b[h].replace(Rb,\"$1\"+e):b.jsonp!==!1&&(b.url+=(sb.test(b.url)?\"&\":\"?\")+b.jsonp+\"=\"+e),b.converters[\"script json\"]=function(){return g||r.error(e+\" was not called\"),g[0]},b.dataTypes[0]=\"json\",f=a[e],a[e]=function(){g=arguments},d.always(function(){void 0===f?r(a).removeProp(e):a[e]=f,b[e]&&(b.jsonpCallback=c.jsonpCallback,Qb.push(e)),g&&r.isFunction(f)&&f(g[0]),g=f=void 0}),\"script\"}),o.createHTMLDocument=function(){var a=d.implementation.createHTMLDocument(\"\").body;return a.innerHTML=\"<form></form><form></form>\",2===a.childNodes.length}(),r.parseHTML=function(a,b,c){if(\"string\"!=typeof a)return[];\"boolean\"==typeof b&&(c=b,b=!1);var e,f,g;return b||(o.createHTMLDocument?(b=d.implementation.createHTMLDocument(\"\"),e=b.createElement(\"base\"),e.href=d.location.href,b.head.appendChild(e)):b=d),f=B.exec(a),g=!c&&[],f?[b.createElement(f[1])]:(f=oa([a],b,g),g&&g.length&&r(g).remove(),r.merge([],f.childNodes))},r.fn.load=function(a,b,c){var d,e,f,g=this,h=a.indexOf(\" \");return h>-1&&(d=r.trim(a.slice(h)),a=a.slice(0,h)),r.isFunction(b)?(c=b,b=void 0):b&&\"object\"==typeof b&&(e=\"POST\"),g.length>0&&r.ajax({url:a,type:e||\"GET\",dataType:\"html\",data:b}).done(function(a){f=arguments,g.html(d?r(\"<div>\").append(r.parseHTML(a)).find(d):a)}).always(c&&function(a,b){g.each(function(){c.apply(this,f||[a.responseText,b,a])})}),this},r.each([\"ajaxStart\",\"ajaxStop\",\"ajaxComplete\",\"ajaxError\",\"ajaxSuccess\",\"ajaxSend\"],function(a,b){r.fn[b]=function(a){return this.on(b,a)}}),r.expr.pseudos.animated=function(a){return r.grep(r.timers,function(b){return a===b.elem}).length};function Sb(a){return r.isWindow(a)?a:9===a.nodeType&&a.defaultView}r.offset={setOffset:function(a,b,c){var d,e,f,g,h,i,j,k=r.css(a,\"position\"),l=r(a),m={};\"static\"===k&&(a.style.position=\"relative\"),h=l.offset(),f=r.css(a,\"top\"),i=r.css(a,\"left\"),j=(\"absolute\"===k||\"fixed\"===k)&&(f+i).indexOf(\"auto\")>-1,j?(d=l.position(),g=d.top,e=d.left):(g=parseFloat(f)||0,e=parseFloat(i)||0),r.isFunction(b)&&(b=b.call(a,c,r.extend({},h))),null!=b.top&&(m.top=b.top-h.top+g),null!=b.left&&(m.left=b.left-h.left+e),\"using\"in b?b.using.call(a,m):l.css(m)}},r.fn.extend({offset:function(a){if(arguments.length)return void 0===a?this:this.each(function(b){r.offset.setOffset(this,a,b)});var b,c,d,e,f=this[0];if(f)return f.getClientRects().length?(d=f.getBoundingClientRect(),d.width||d.height?(e=f.ownerDocument,c=Sb(e),b=e.documentElement,{top:d.top+c.pageYOffset-b.clientTop,left:d.left+c.pageXOffset-b.clientLeft}):d):{top:0,left:0}},position:function(){if(this[0]){var a,b,c=this[0],d={top:0,left:0};return\"fixed\"===r.css(c,\"position\")?b=c.getBoundingClientRect():(a=this.offsetParent(),b=this.offset(),r.nodeName(a[0],\"html\")||(d=a.offset()),d={top:d.top+r.css(a[0],\"borderTopWidth\",!0),left:d.left+r.css(a[0],\"borderLeftWidth\",!0)}),{top:b.top-d.top-r.css(c,\"marginTop\",!0),left:b.left-d.left-r.css(c,\"marginLeft\",!0)}}},offsetParent:function(){return this.map(function(){var a=this.offsetParent;while(a&&\"static\"===r.css(a,\"position\"))a=a.offsetParent;return a||pa})}}),r.each({scrollLeft:\"pageXOffset\",scrollTop:\"pageYOffset\"},function(a,b){var c=\"pageYOffset\"===b;r.fn[a]=function(d){return S(this,function(a,d,e){var f=Sb(a);return void 0===e?f?f[b]:a[d]:void(f?f.scrollTo(c?f.pageXOffset:e,c?e:f.pageYOffset):a[d]=e)},a,d,arguments.length)}}),r.each([\"top\",\"left\"],function(a,b){r.cssHooks[b]=Na(o.pixelPosition,function(a,c){if(c)return c=Ma(a,b),Ka.test(c)?r(a).position()[b]+\"px\":c})}),r.each({Height:\"height\",Width:\"width\"},function(a,b){r.each({padding:\"inner\"+a,content:b,\"\":\"outer\"+a},function(c,d){r.fn[d]=function(e,f){var g=arguments.length&&(c||\"boolean\"!=typeof e),h=c||(e===!0||f===!0?\"margin\":\"border\");return S(this,function(b,c,e){var f;return r.isWindow(b)?0===d.indexOf(\"outer\")?b[\"inner\"+a]:b.document.documentElement[\"client\"+a]:9===b.nodeType?(f=b.documentElement,Math.max(b.body[\"scroll\"+a],f[\"scroll\"+a],b.body[\"offset\"+a],f[\"offset\"+a],f[\"client\"+a])):void 0===e?r.css(b,c,h):r.style(b,c,e,h)},b,g?e:void 0,g)}})}),r.fn.extend({bind:function(a,b,c){return this.on(a,null,b,c)},unbind:function(a,b){return this.off(a,null,b)},delegate:function(a,b,c,d){return this.on(b,a,c,d)},undelegate:function(a,b,c){return 1===arguments.length?this.off(a,\"**\"):this.off(b,a||\"**\",c)}}),r.parseJSON=JSON.parse,\"function\"==typeof define&&define.amd&&define(\"jquery\",[],function(){return r});var Tb=a.jQuery,Ub=a.$;return r.noConflict=function(b){return a.$===r&&(a.$=Ub),b&&a.jQuery===r&&(a.jQuery=Tb),r},b||(a.jQuery=a.$=r),r});\n","source":"static/js/jquery.min.js","raw":"/*! jQuery v3.1.0 | (c) jQuery Foundation | jquery.org/license */\n!function(a,b){\"use strict\";\"object\"==typeof module&&\"object\"==typeof module.exports?module.exports=a.document?b(a,!0):function(a){if(!a.document)throw new Error(\"jQuery requires a window with a document\");return b(a)}:b(a)}(\"undefined\"!=typeof window?window:this,function(a,b){\"use strict\";var c=[],d=a.document,e=Object.getPrototypeOf,f=c.slice,g=c.concat,h=c.push,i=c.indexOf,j={},k=j.toString,l=j.hasOwnProperty,m=l.toString,n=m.call(Object),o={};function p(a,b){b=b||d;var c=b.createElement(\"script\");c.text=a,b.head.appendChild(c).parentNode.removeChild(c)}var q=\"3.1.0\",r=function(a,b){return new r.fn.init(a,b)},s=/^[\\s\\uFEFF\\xA0]+|[\\s\\uFEFF\\xA0]+$/g,t=/^-ms-/,u=/-([a-z])/g,v=function(a,b){return b.toUpperCase()};r.fn=r.prototype={jquery:q,constructor:r,length:0,toArray:function(){return f.call(this)},get:function(a){return null!=a?a<0?this[a+this.length]:this[a]:f.call(this)},pushStack:function(a){var b=r.merge(this.constructor(),a);return b.prevObject=this,b},each:function(a){return r.each(this,a)},map:function(a){return this.pushStack(r.map(this,function(b,c){return a.call(b,c,b)}))},slice:function(){return this.pushStack(f.apply(this,arguments))},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},eq:function(a){var b=this.length,c=+a+(a<0?b:0);return this.pushStack(c>=0&&c<b?[this[c]]:[])},end:function(){return this.prevObject||this.constructor()},push:h,sort:c.sort,splice:c.splice},r.extend=r.fn.extend=function(){var a,b,c,d,e,f,g=arguments[0]||{},h=1,i=arguments.length,j=!1;for(\"boolean\"==typeof g&&(j=g,g=arguments[h]||{},h++),\"object\"==typeof g||r.isFunction(g)||(g={}),h===i&&(g=this,h--);h<i;h++)if(null!=(a=arguments[h]))for(b in a)c=g[b],d=a[b],g!==d&&(j&&d&&(r.isPlainObject(d)||(e=r.isArray(d)))?(e?(e=!1,f=c&&r.isArray(c)?c:[]):f=c&&r.isPlainObject(c)?c:{},g[b]=r.extend(j,f,d)):void 0!==d&&(g[b]=d));return g},r.extend({expando:\"jQuery\"+(q+Math.random()).replace(/\\D/g,\"\"),isReady:!0,error:function(a){throw new Error(a)},noop:function(){},isFunction:function(a){return\"function\"===r.type(a)},isArray:Array.isArray,isWindow:function(a){return null!=a&&a===a.window},isNumeric:function(a){var b=r.type(a);return(\"number\"===b||\"string\"===b)&&!isNaN(a-parseFloat(a))},isPlainObject:function(a){var b,c;return!(!a||\"[object Object]\"!==k.call(a))&&(!(b=e(a))||(c=l.call(b,\"constructor\")&&b.constructor,\"function\"==typeof c&&m.call(c)===n))},isEmptyObject:function(a){var b;for(b in a)return!1;return!0},type:function(a){return null==a?a+\"\":\"object\"==typeof a||\"function\"==typeof a?j[k.call(a)]||\"object\":typeof a},globalEval:function(a){p(a)},camelCase:function(a){return a.replace(t,\"ms-\").replace(u,v)},nodeName:function(a,b){return a.nodeName&&a.nodeName.toLowerCase()===b.toLowerCase()},each:function(a,b){var c,d=0;if(w(a)){for(c=a.length;d<c;d++)if(b.call(a[d],d,a[d])===!1)break}else for(d in a)if(b.call(a[d],d,a[d])===!1)break;return a},trim:function(a){return null==a?\"\":(a+\"\").replace(s,\"\")},makeArray:function(a,b){var c=b||[];return null!=a&&(w(Object(a))?r.merge(c,\"string\"==typeof a?[a]:a):h.call(c,a)),c},inArray:function(a,b,c){return null==b?-1:i.call(b,a,c)},merge:function(a,b){for(var c=+b.length,d=0,e=a.length;d<c;d++)a[e++]=b[d];return a.length=e,a},grep:function(a,b,c){for(var d,e=[],f=0,g=a.length,h=!c;f<g;f++)d=!b(a[f],f),d!==h&&e.push(a[f]);return e},map:function(a,b,c){var d,e,f=0,h=[];if(w(a))for(d=a.length;f<d;f++)e=b(a[f],f,c),null!=e&&h.push(e);else for(f in a)e=b(a[f],f,c),null!=e&&h.push(e);return g.apply([],h)},guid:1,proxy:function(a,b){var c,d,e;if(\"string\"==typeof b&&(c=a[b],b=a,a=c),r.isFunction(a))return d=f.call(arguments,2),e=function(){return a.apply(b||this,d.concat(f.call(arguments)))},e.guid=a.guid=a.guid||r.guid++,e},now:Date.now,support:o}),\"function\"==typeof Symbol&&(r.fn[Symbol.iterator]=c[Symbol.iterator]),r.each(\"Boolean Number String Function Array Date RegExp Object Error Symbol\".split(\" \"),function(a,b){j[\"[object \"+b+\"]\"]=b.toLowerCase()});function w(a){var b=!!a&&\"length\"in a&&a.length,c=r.type(a);return\"function\"!==c&&!r.isWindow(a)&&(\"array\"===c||0===b||\"number\"==typeof b&&b>0&&b-1 in a)}var x=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u=\"sizzle\"+1*new Date,v=a.document,w=0,x=0,y=ha(),z=ha(),A=ha(),B=function(a,b){return a===b&&(l=!0),0},C={}.hasOwnProperty,D=[],E=D.pop,F=D.push,G=D.push,H=D.slice,I=function(a,b){for(var c=0,d=a.length;c<d;c++)if(a[c]===b)return c;return-1},J=\"checked|selected|async|autofocus|autoplay|controls|defer|disabled|hidden|ismap|loop|multiple|open|readonly|required|scoped\",K=\"[\\\\x20\\\\t\\\\r\\\\n\\\\f]\",L=\"(?:\\\\\\\\.|[\\\\w-]|[^\\0-\\\\xa0])+\",M=\"\\\\[\"+K+\"*(\"+L+\")(?:\"+K+\"*([*^$|!~]?=)\"+K+\"*(?:'((?:\\\\\\\\.|[^\\\\\\\\'])*)'|\\\"((?:\\\\\\\\.|[^\\\\\\\\\\\"])*)\\\"|(\"+L+\"))|)\"+K+\"*\\\\]\",N=\":(\"+L+\")(?:\\\\((('((?:\\\\\\\\.|[^\\\\\\\\'])*)'|\\\"((?:\\\\\\\\.|[^\\\\\\\\\\\"])*)\\\")|((?:\\\\\\\\.|[^\\\\\\\\()[\\\\]]|\"+M+\")*)|.*)\\\\)|)\",O=new RegExp(K+\"+\",\"g\"),P=new RegExp(\"^\"+K+\"+|((?:^|[^\\\\\\\\])(?:\\\\\\\\.)*)\"+K+\"+$\",\"g\"),Q=new RegExp(\"^\"+K+\"*,\"+K+\"*\"),R=new RegExp(\"^\"+K+\"*([>+~]|\"+K+\")\"+K+\"*\"),S=new RegExp(\"=\"+K+\"*([^\\\\]'\\\"]*?)\"+K+\"*\\\\]\",\"g\"),T=new RegExp(N),U=new RegExp(\"^\"+L+\"$\"),V={ID:new RegExp(\"^#(\"+L+\")\"),CLASS:new RegExp(\"^\\\\.(\"+L+\")\"),TAG:new RegExp(\"^(\"+L+\"|[*])\"),ATTR:new RegExp(\"^\"+M),PSEUDO:new RegExp(\"^\"+N),CHILD:new RegExp(\"^:(only|first|last|nth|nth-last)-(child|of-type)(?:\\\\(\"+K+\"*(even|odd|(([+-]|)(\\\\d*)n|)\"+K+\"*(?:([+-]|)\"+K+\"*(\\\\d+)|))\"+K+\"*\\\\)|)\",\"i\"),bool:new RegExp(\"^(?:\"+J+\")$\",\"i\"),needsContext:new RegExp(\"^\"+K+\"*[>+~]|:(even|odd|eq|gt|lt|nth|first|last)(?:\\\\(\"+K+\"*((?:-\\\\d)?\\\\d*)\"+K+\"*\\\\)|)(?=[^-]|$)\",\"i\")},W=/^(?:input|select|textarea|button)$/i,X=/^h\\d$/i,Y=/^[^{]+\\{\\s*\\[native \\w/,Z=/^(?:#([\\w-]+)|(\\w+)|\\.([\\w-]+))$/,$=/[+~]/,_=new RegExp(\"\\\\\\\\([\\\\da-f]{1,6}\"+K+\"?|(\"+K+\")|.)\",\"ig\"),aa=function(a,b,c){var d=\"0x\"+b-65536;return d!==d||c?b:d<0?String.fromCharCode(d+65536):String.fromCharCode(d>>10|55296,1023&d|56320)},ba=/([\\0-\\x1f\\x7f]|^-?\\d)|^-$|[^\\x80-\\uFFFF\\w-]/g,ca=function(a,b){return b?\"\\0\"===a?\"\\ufffd\":a.slice(0,-1)+\"\\\\\"+a.charCodeAt(a.length-1).toString(16)+\" \":\"\\\\\"+a},da=function(){m()},ea=ta(function(a){return a.disabled===!0},{dir:\"parentNode\",next:\"legend\"});try{G.apply(D=H.call(v.childNodes),v.childNodes),D[v.childNodes.length].nodeType}catch(fa){G={apply:D.length?function(a,b){F.apply(a,H.call(b))}:function(a,b){var c=a.length,d=0;while(a[c++]=b[d++]);a.length=c-1}}}function ga(a,b,d,e){var f,h,j,k,l,o,r,s=b&&b.ownerDocument,w=b?b.nodeType:9;if(d=d||[],\"string\"!=typeof a||!a||1!==w&&9!==w&&11!==w)return d;if(!e&&((b?b.ownerDocument||b:v)!==n&&m(b),b=b||n,p)){if(11!==w&&(l=Z.exec(a)))if(f=l[1]){if(9===w){if(!(j=b.getElementById(f)))return d;if(j.id===f)return d.push(j),d}else if(s&&(j=s.getElementById(f))&&t(b,j)&&j.id===f)return d.push(j),d}else{if(l[2])return G.apply(d,b.getElementsByTagName(a)),d;if((f=l[3])&&c.getElementsByClassName&&b.getElementsByClassName)return G.apply(d,b.getElementsByClassName(f)),d}if(c.qsa&&!A[a+\" \"]&&(!q||!q.test(a))){if(1!==w)s=b,r=a;else if(\"object\"!==b.nodeName.toLowerCase()){(k=b.getAttribute(\"id\"))?k=k.replace(ba,ca):b.setAttribute(\"id\",k=u),o=g(a),h=o.length;while(h--)o[h]=\"#\"+k+\" \"+sa(o[h]);r=o.join(\",\"),s=$.test(a)&&qa(b.parentNode)||b}if(r)try{return G.apply(d,s.querySelectorAll(r)),d}catch(x){}finally{k===u&&b.removeAttribute(\"id\")}}}return i(a.replace(P,\"$1\"),b,d,e)}function ha(){var a=[];function b(c,e){return a.push(c+\" \")>d.cacheLength&&delete b[a.shift()],b[c+\" \"]=e}return b}function ia(a){return a[u]=!0,a}function ja(a){var b=n.createElement(\"fieldset\");try{return!!a(b)}catch(c){return!1}finally{b.parentNode&&b.parentNode.removeChild(b),b=null}}function ka(a,b){var c=a.split(\"|\"),e=c.length;while(e--)d.attrHandle[c[e]]=b}function la(a,b){var c=b&&a,d=c&&1===a.nodeType&&1===b.nodeType&&a.sourceIndex-b.sourceIndex;if(d)return d;if(c)while(c=c.nextSibling)if(c===b)return-1;return a?1:-1}function ma(a){return function(b){var c=b.nodeName.toLowerCase();return\"input\"===c&&b.type===a}}function na(a){return function(b){var c=b.nodeName.toLowerCase();return(\"input\"===c||\"button\"===c)&&b.type===a}}function oa(a){return function(b){return\"label\"in b&&b.disabled===a||\"form\"in b&&b.disabled===a||\"form\"in b&&b.disabled===!1&&(b.isDisabled===a||b.isDisabled!==!a&&(\"label\"in b||!ea(b))!==a)}}function pa(a){return ia(function(b){return b=+b,ia(function(c,d){var e,f=a([],c.length,b),g=f.length;while(g--)c[e=f[g]]&&(c[e]=!(d[e]=c[e]))})})}function qa(a){return a&&\"undefined\"!=typeof a.getElementsByTagName&&a}c=ga.support={},f=ga.isXML=function(a){var b=a&&(a.ownerDocument||a).documentElement;return!!b&&\"HTML\"!==b.nodeName},m=ga.setDocument=function(a){var b,e,g=a?a.ownerDocument||a:v;return g!==n&&9===g.nodeType&&g.documentElement?(n=g,o=n.documentElement,p=!f(n),v!==n&&(e=n.defaultView)&&e.top!==e&&(e.addEventListener?e.addEventListener(\"unload\",da,!1):e.attachEvent&&e.attachEvent(\"onunload\",da)),c.attributes=ja(function(a){return a.className=\"i\",!a.getAttribute(\"className\")}),c.getElementsByTagName=ja(function(a){return a.appendChild(n.createComment(\"\")),!a.getElementsByTagName(\"*\").length}),c.getElementsByClassName=Y.test(n.getElementsByClassName),c.getById=ja(function(a){return o.appendChild(a).id=u,!n.getElementsByName||!n.getElementsByName(u).length}),c.getById?(d.find.ID=function(a,b){if(\"undefined\"!=typeof b.getElementById&&p){var c=b.getElementById(a);return c?[c]:[]}},d.filter.ID=function(a){var b=a.replace(_,aa);return function(a){return a.getAttribute(\"id\")===b}}):(delete d.find.ID,d.filter.ID=function(a){var b=a.replace(_,aa);return function(a){var c=\"undefined\"!=typeof a.getAttributeNode&&a.getAttributeNode(\"id\");return c&&c.value===b}}),d.find.TAG=c.getElementsByTagName?function(a,b){return\"undefined\"!=typeof b.getElementsByTagName?b.getElementsByTagName(a):c.qsa?b.querySelectorAll(a):void 0}:function(a,b){var c,d=[],e=0,f=b.getElementsByTagName(a);if(\"*\"===a){while(c=f[e++])1===c.nodeType&&d.push(c);return d}return f},d.find.CLASS=c.getElementsByClassName&&function(a,b){if(\"undefined\"!=typeof b.getElementsByClassName&&p)return b.getElementsByClassName(a)},r=[],q=[],(c.qsa=Y.test(n.querySelectorAll))&&(ja(function(a){o.appendChild(a).innerHTML=\"<a id='\"+u+\"'></a><select id='\"+u+\"-\\r\\\\' msallowcapture=''><option selected=''></option></select>\",a.querySelectorAll(\"[msallowcapture^='']\").length&&q.push(\"[*^$]=\"+K+\"*(?:''|\\\"\\\")\"),a.querySelectorAll(\"[selected]\").length||q.push(\"\\\\[\"+K+\"*(?:value|\"+J+\")\"),a.querySelectorAll(\"[id~=\"+u+\"-]\").length||q.push(\"~=\"),a.querySelectorAll(\":checked\").length||q.push(\":checked\"),a.querySelectorAll(\"a#\"+u+\"+*\").length||q.push(\".#.+[+~]\")}),ja(function(a){a.innerHTML=\"<a href='' disabled='disabled'></a><select disabled='disabled'><option/></select>\";var b=n.createElement(\"input\");b.setAttribute(\"type\",\"hidden\"),a.appendChild(b).setAttribute(\"name\",\"D\"),a.querySelectorAll(\"[name=d]\").length&&q.push(\"name\"+K+\"*[*^$|!~]?=\"),2!==a.querySelectorAll(\":enabled\").length&&q.push(\":enabled\",\":disabled\"),o.appendChild(a).disabled=!0,2!==a.querySelectorAll(\":disabled\").length&&q.push(\":enabled\",\":disabled\"),a.querySelectorAll(\"*,:x\"),q.push(\",.*:\")})),(c.matchesSelector=Y.test(s=o.matches||o.webkitMatchesSelector||o.mozMatchesSelector||o.oMatchesSelector||o.msMatchesSelector))&&ja(function(a){c.disconnectedMatch=s.call(a,\"*\"),s.call(a,\"[s!='']:x\"),r.push(\"!=\",N)}),q=q.length&&new RegExp(q.join(\"|\")),r=r.length&&new RegExp(r.join(\"|\")),b=Y.test(o.compareDocumentPosition),t=b||Y.test(o.contains)?function(a,b){var c=9===a.nodeType?a.documentElement:a,d=b&&b.parentNode;return a===d||!(!d||1!==d.nodeType||!(c.contains?c.contains(d):a.compareDocumentPosition&&16&a.compareDocumentPosition(d)))}:function(a,b){if(b)while(b=b.parentNode)if(b===a)return!0;return!1},B=b?function(a,b){if(a===b)return l=!0,0;var d=!a.compareDocumentPosition-!b.compareDocumentPosition;return d?d:(d=(a.ownerDocument||a)===(b.ownerDocument||b)?a.compareDocumentPosition(b):1,1&d||!c.sortDetached&&b.compareDocumentPosition(a)===d?a===n||a.ownerDocument===v&&t(v,a)?-1:b===n||b.ownerDocument===v&&t(v,b)?1:k?I(k,a)-I(k,b):0:4&d?-1:1)}:function(a,b){if(a===b)return l=!0,0;var c,d=0,e=a.parentNode,f=b.parentNode,g=[a],h=[b];if(!e||!f)return a===n?-1:b===n?1:e?-1:f?1:k?I(k,a)-I(k,b):0;if(e===f)return la(a,b);c=a;while(c=c.parentNode)g.unshift(c);c=b;while(c=c.parentNode)h.unshift(c);while(g[d]===h[d])d++;return d?la(g[d],h[d]):g[d]===v?-1:h[d]===v?1:0},n):n},ga.matches=function(a,b){return ga(a,null,null,b)},ga.matchesSelector=function(a,b){if((a.ownerDocument||a)!==n&&m(a),b=b.replace(S,\"='$1']\"),c.matchesSelector&&p&&!A[b+\" \"]&&(!r||!r.test(b))&&(!q||!q.test(b)))try{var d=s.call(a,b);if(d||c.disconnectedMatch||a.document&&11!==a.document.nodeType)return d}catch(e){}return ga(b,n,null,[a]).length>0},ga.contains=function(a,b){return(a.ownerDocument||a)!==n&&m(a),t(a,b)},ga.attr=function(a,b){(a.ownerDocument||a)!==n&&m(a);var e=d.attrHandle[b.toLowerCase()],f=e&&C.call(d.attrHandle,b.toLowerCase())?e(a,b,!p):void 0;return void 0!==f?f:c.attributes||!p?a.getAttribute(b):(f=a.getAttributeNode(b))&&f.specified?f.value:null},ga.escape=function(a){return(a+\"\").replace(ba,ca)},ga.error=function(a){throw new Error(\"Syntax error, unrecognized expression: \"+a)},ga.uniqueSort=function(a){var b,d=[],e=0,f=0;if(l=!c.detectDuplicates,k=!c.sortStable&&a.slice(0),a.sort(B),l){while(b=a[f++])b===a[f]&&(e=d.push(f));while(e--)a.splice(d[e],1)}return k=null,a},e=ga.getText=function(a){var b,c=\"\",d=0,f=a.nodeType;if(f){if(1===f||9===f||11===f){if(\"string\"==typeof a.textContent)return a.textContent;for(a=a.firstChild;a;a=a.nextSibling)c+=e(a)}else if(3===f||4===f)return a.nodeValue}else while(b=a[d++])c+=e(b);return c},d=ga.selectors={cacheLength:50,createPseudo:ia,match:V,attrHandle:{},find:{},relative:{\">\":{dir:\"parentNode\",first:!0},\" \":{dir:\"parentNode\"},\"+\":{dir:\"previousSibling\",first:!0},\"~\":{dir:\"previousSibling\"}},preFilter:{ATTR:function(a){return a[1]=a[1].replace(_,aa),a[3]=(a[3]||a[4]||a[5]||\"\").replace(_,aa),\"~=\"===a[2]&&(a[3]=\" \"+a[3]+\" \"),a.slice(0,4)},CHILD:function(a){return a[1]=a[1].toLowerCase(),\"nth\"===a[1].slice(0,3)?(a[3]||ga.error(a[0]),a[4]=+(a[4]?a[5]+(a[6]||1):2*(\"even\"===a[3]||\"odd\"===a[3])),a[5]=+(a[7]+a[8]||\"odd\"===a[3])):a[3]&&ga.error(a[0]),a},PSEUDO:function(a){var b,c=!a[6]&&a[2];return V.CHILD.test(a[0])?null:(a[3]?a[2]=a[4]||a[5]||\"\":c&&T.test(c)&&(b=g(c,!0))&&(b=c.indexOf(\")\",c.length-b)-c.length)&&(a[0]=a[0].slice(0,b),a[2]=c.slice(0,b)),a.slice(0,3))}},filter:{TAG:function(a){var b=a.replace(_,aa).toLowerCase();return\"*\"===a?function(){return!0}:function(a){return a.nodeName&&a.nodeName.toLowerCase()===b}},CLASS:function(a){var b=y[a+\" \"];return b||(b=new RegExp(\"(^|\"+K+\")\"+a+\"(\"+K+\"|$)\"))&&y(a,function(a){return b.test(\"string\"==typeof a.className&&a.className||\"undefined\"!=typeof a.getAttribute&&a.getAttribute(\"class\")||\"\")})},ATTR:function(a,b,c){return function(d){var e=ga.attr(d,a);return null==e?\"!=\"===b:!b||(e+=\"\",\"=\"===b?e===c:\"!=\"===b?e!==c:\"^=\"===b?c&&0===e.indexOf(c):\"*=\"===b?c&&e.indexOf(c)>-1:\"$=\"===b?c&&e.slice(-c.length)===c:\"~=\"===b?(\" \"+e.replace(O,\" \")+\" \").indexOf(c)>-1:\"|=\"===b&&(e===c||e.slice(0,c.length+1)===c+\"-\"))}},CHILD:function(a,b,c,d,e){var f=\"nth\"!==a.slice(0,3),g=\"last\"!==a.slice(-4),h=\"of-type\"===b;return 1===d&&0===e?function(a){return!!a.parentNode}:function(b,c,i){var j,k,l,m,n,o,p=f!==g?\"nextSibling\":\"previousSibling\",q=b.parentNode,r=h&&b.nodeName.toLowerCase(),s=!i&&!h,t=!1;if(q){if(f){while(p){m=b;while(m=m[p])if(h?m.nodeName.toLowerCase()===r:1===m.nodeType)return!1;o=p=\"only\"===a&&!o&&\"nextSibling\"}return!0}if(o=[g?q.firstChild:q.lastChild],g&&s){m=q,l=m[u]||(m[u]={}),k=l[m.uniqueID]||(l[m.uniqueID]={}),j=k[a]||[],n=j[0]===w&&j[1],t=n&&j[2],m=n&&q.childNodes[n];while(m=++n&&m&&m[p]||(t=n=0)||o.pop())if(1===m.nodeType&&++t&&m===b){k[a]=[w,n,t];break}}else if(s&&(m=b,l=m[u]||(m[u]={}),k=l[m.uniqueID]||(l[m.uniqueID]={}),j=k[a]||[],n=j[0]===w&&j[1],t=n),t===!1)while(m=++n&&m&&m[p]||(t=n=0)||o.pop())if((h?m.nodeName.toLowerCase()===r:1===m.nodeType)&&++t&&(s&&(l=m[u]||(m[u]={}),k=l[m.uniqueID]||(l[m.uniqueID]={}),k[a]=[w,t]),m===b))break;return t-=e,t===d||t%d===0&&t/d>=0}}},PSEUDO:function(a,b){var c,e=d.pseudos[a]||d.setFilters[a.toLowerCase()]||ga.error(\"unsupported pseudo: \"+a);return e[u]?e(b):e.length>1?(c=[a,a,\"\",b],d.setFilters.hasOwnProperty(a.toLowerCase())?ia(function(a,c){var d,f=e(a,b),g=f.length;while(g--)d=I(a,f[g]),a[d]=!(c[d]=f[g])}):function(a){return e(a,0,c)}):e}},pseudos:{not:ia(function(a){var b=[],c=[],d=h(a.replace(P,\"$1\"));return d[u]?ia(function(a,b,c,e){var f,g=d(a,null,e,[]),h=a.length;while(h--)(f=g[h])&&(a[h]=!(b[h]=f))}):function(a,e,f){return b[0]=a,d(b,null,f,c),b[0]=null,!c.pop()}}),has:ia(function(a){return function(b){return ga(a,b).length>0}}),contains:ia(function(a){return a=a.replace(_,aa),function(b){return(b.textContent||b.innerText||e(b)).indexOf(a)>-1}}),lang:ia(function(a){return U.test(a||\"\")||ga.error(\"unsupported lang: \"+a),a=a.replace(_,aa).toLowerCase(),function(b){var c;do if(c=p?b.lang:b.getAttribute(\"xml:lang\")||b.getAttribute(\"lang\"))return c=c.toLowerCase(),c===a||0===c.indexOf(a+\"-\");while((b=b.parentNode)&&1===b.nodeType);return!1}}),target:function(b){var c=a.location&&a.location.hash;return c&&c.slice(1)===b.id},root:function(a){return a===o},focus:function(a){return a===n.activeElement&&(!n.hasFocus||n.hasFocus())&&!!(a.type||a.href||~a.tabIndex)},enabled:oa(!1),disabled:oa(!0),checked:function(a){var b=a.nodeName.toLowerCase();return\"input\"===b&&!!a.checked||\"option\"===b&&!!a.selected},selected:function(a){return a.parentNode&&a.parentNode.selectedIndex,a.selected===!0},empty:function(a){for(a=a.firstChild;a;a=a.nextSibling)if(a.nodeType<6)return!1;return!0},parent:function(a){return!d.pseudos.empty(a)},header:function(a){return X.test(a.nodeName)},input:function(a){return W.test(a.nodeName)},button:function(a){var b=a.nodeName.toLowerCase();return\"input\"===b&&\"button\"===a.type||\"button\"===b},text:function(a){var b;return\"input\"===a.nodeName.toLowerCase()&&\"text\"===a.type&&(null==(b=a.getAttribute(\"type\"))||\"text\"===b.toLowerCase())},first:pa(function(){return[0]}),last:pa(function(a,b){return[b-1]}),eq:pa(function(a,b,c){return[c<0?c+b:c]}),even:pa(function(a,b){for(var c=0;c<b;c+=2)a.push(c);return a}),odd:pa(function(a,b){for(var c=1;c<b;c+=2)a.push(c);return a}),lt:pa(function(a,b,c){for(var d=c<0?c+b:c;--d>=0;)a.push(d);return a}),gt:pa(function(a,b,c){for(var d=c<0?c+b:c;++d<b;)a.push(d);return a})}},d.pseudos.nth=d.pseudos.eq;for(b in{radio:!0,checkbox:!0,file:!0,password:!0,image:!0})d.pseudos[b]=ma(b);for(b in{submit:!0,reset:!0})d.pseudos[b]=na(b);function ra(){}ra.prototype=d.filters=d.pseudos,d.setFilters=new ra,g=ga.tokenize=function(a,b){var c,e,f,g,h,i,j,k=z[a+\" \"];if(k)return b?0:k.slice(0);h=a,i=[],j=d.preFilter;while(h){c&&!(e=Q.exec(h))||(e&&(h=h.slice(e[0].length)||h),i.push(f=[])),c=!1,(e=R.exec(h))&&(c=e.shift(),f.push({value:c,type:e[0].replace(P,\" \")}),h=h.slice(c.length));for(g in d.filter)!(e=V[g].exec(h))||j[g]&&!(e=j[g](e))||(c=e.shift(),f.push({value:c,type:g,matches:e}),h=h.slice(c.length));if(!c)break}return b?h.length:h?ga.error(a):z(a,i).slice(0)};function sa(a){for(var b=0,c=a.length,d=\"\";b<c;b++)d+=a[b].value;return d}function ta(a,b,c){var d=b.dir,e=b.next,f=e||d,g=c&&\"parentNode\"===f,h=x++;return b.first?function(b,c,e){while(b=b[d])if(1===b.nodeType||g)return a(b,c,e)}:function(b,c,i){var j,k,l,m=[w,h];if(i){while(b=b[d])if((1===b.nodeType||g)&&a(b,c,i))return!0}else while(b=b[d])if(1===b.nodeType||g)if(l=b[u]||(b[u]={}),k=l[b.uniqueID]||(l[b.uniqueID]={}),e&&e===b.nodeName.toLowerCase())b=b[d]||b;else{if((j=k[f])&&j[0]===w&&j[1]===h)return m[2]=j[2];if(k[f]=m,m[2]=a(b,c,i))return!0}}}function ua(a){return a.length>1?function(b,c,d){var e=a.length;while(e--)if(!a[e](b,c,d))return!1;return!0}:a[0]}function va(a,b,c){for(var d=0,e=b.length;d<e;d++)ga(a,b[d],c);return c}function wa(a,b,c,d,e){for(var f,g=[],h=0,i=a.length,j=null!=b;h<i;h++)(f=a[h])&&(c&&!c(f,d,e)||(g.push(f),j&&b.push(h)));return g}function xa(a,b,c,d,e,f){return d&&!d[u]&&(d=xa(d)),e&&!e[u]&&(e=xa(e,f)),ia(function(f,g,h,i){var j,k,l,m=[],n=[],o=g.length,p=f||va(b||\"*\",h.nodeType?[h]:h,[]),q=!a||!f&&b?p:wa(p,m,a,h,i),r=c?e||(f?a:o||d)?[]:g:q;if(c&&c(q,r,h,i),d){j=wa(r,n),d(j,[],h,i),k=j.length;while(k--)(l=j[k])&&(r[n[k]]=!(q[n[k]]=l))}if(f){if(e||a){if(e){j=[],k=r.length;while(k--)(l=r[k])&&j.push(q[k]=l);e(null,r=[],j,i)}k=r.length;while(k--)(l=r[k])&&(j=e?I(f,l):m[k])>-1&&(f[j]=!(g[j]=l))}}else r=wa(r===g?r.splice(o,r.length):r),e?e(null,g,r,i):G.apply(g,r)})}function ya(a){for(var b,c,e,f=a.length,g=d.relative[a[0].type],h=g||d.relative[\" \"],i=g?1:0,k=ta(function(a){return a===b},h,!0),l=ta(function(a){return I(b,a)>-1},h,!0),m=[function(a,c,d){var e=!g&&(d||c!==j)||((b=c).nodeType?k(a,c,d):l(a,c,d));return b=null,e}];i<f;i++)if(c=d.relative[a[i].type])m=[ta(ua(m),c)];else{if(c=d.filter[a[i].type].apply(null,a[i].matches),c[u]){for(e=++i;e<f;e++)if(d.relative[a[e].type])break;return xa(i>1&&ua(m),i>1&&sa(a.slice(0,i-1).concat({value:\" \"===a[i-2].type?\"*\":\"\"})).replace(P,\"$1\"),c,i<e&&ya(a.slice(i,e)),e<f&&ya(a=a.slice(e)),e<f&&sa(a))}m.push(c)}return ua(m)}function za(a,b){var c=b.length>0,e=a.length>0,f=function(f,g,h,i,k){var l,o,q,r=0,s=\"0\",t=f&&[],u=[],v=j,x=f||e&&d.find.TAG(\"*\",k),y=w+=null==v?1:Math.random()||.1,z=x.length;for(k&&(j=g===n||g||k);s!==z&&null!=(l=x[s]);s++){if(e&&l){o=0,g||l.ownerDocument===n||(m(l),h=!p);while(q=a[o++])if(q(l,g||n,h)){i.push(l);break}k&&(w=y)}c&&((l=!q&&l)&&r--,f&&t.push(l))}if(r+=s,c&&s!==r){o=0;while(q=b[o++])q(t,u,g,h);if(f){if(r>0)while(s--)t[s]||u[s]||(u[s]=E.call(i));u=wa(u)}G.apply(i,u),k&&!f&&u.length>0&&r+b.length>1&&ga.uniqueSort(i)}return k&&(w=y,j=v),t};return c?ia(f):f}return h=ga.compile=function(a,b){var c,d=[],e=[],f=A[a+\" \"];if(!f){b||(b=g(a)),c=b.length;while(c--)f=ya(b[c]),f[u]?d.push(f):e.push(f);f=A(a,za(e,d)),f.selector=a}return f},i=ga.select=function(a,b,e,f){var i,j,k,l,m,n=\"function\"==typeof a&&a,o=!f&&g(a=n.selector||a);if(e=e||[],1===o.length){if(j=o[0]=o[0].slice(0),j.length>2&&\"ID\"===(k=j[0]).type&&c.getById&&9===b.nodeType&&p&&d.relative[j[1].type]){if(b=(d.find.ID(k.matches[0].replace(_,aa),b)||[])[0],!b)return e;n&&(b=b.parentNode),a=a.slice(j.shift().value.length)}i=V.needsContext.test(a)?0:j.length;while(i--){if(k=j[i],d.relative[l=k.type])break;if((m=d.find[l])&&(f=m(k.matches[0].replace(_,aa),$.test(j[0].type)&&qa(b.parentNode)||b))){if(j.splice(i,1),a=f.length&&sa(j),!a)return G.apply(e,f),e;break}}}return(n||h(a,o))(f,b,!p,e,!b||$.test(a)&&qa(b.parentNode)||b),e},c.sortStable=u.split(\"\").sort(B).join(\"\")===u,c.detectDuplicates=!!l,m(),c.sortDetached=ja(function(a){return 1&a.compareDocumentPosition(n.createElement(\"fieldset\"))}),ja(function(a){return a.innerHTML=\"<a href='#'></a>\",\"#\"===a.firstChild.getAttribute(\"href\")})||ka(\"type|href|height|width\",function(a,b,c){if(!c)return a.getAttribute(b,\"type\"===b.toLowerCase()?1:2)}),c.attributes&&ja(function(a){return a.innerHTML=\"<input/>\",a.firstChild.setAttribute(\"value\",\"\"),\"\"===a.firstChild.getAttribute(\"value\")})||ka(\"value\",function(a,b,c){if(!c&&\"input\"===a.nodeName.toLowerCase())return a.defaultValue}),ja(function(a){return null==a.getAttribute(\"disabled\")})||ka(J,function(a,b,c){var d;if(!c)return a[b]===!0?b.toLowerCase():(d=a.getAttributeNode(b))&&d.specified?d.value:null}),ga}(a);r.find=x,r.expr=x.selectors,r.expr[\":\"]=r.expr.pseudos,r.uniqueSort=r.unique=x.uniqueSort,r.text=x.getText,r.isXMLDoc=x.isXML,r.contains=x.contains,r.escapeSelector=x.escape;var y=function(a,b,c){var d=[],e=void 0!==c;while((a=a[b])&&9!==a.nodeType)if(1===a.nodeType){if(e&&r(a).is(c))break;d.push(a)}return d},z=function(a,b){for(var c=[];a;a=a.nextSibling)1===a.nodeType&&a!==b&&c.push(a);return c},A=r.expr.match.needsContext,B=/^<([a-z][^\\/\\0>:\\x20\\t\\r\\n\\f]*)[\\x20\\t\\r\\n\\f]*\\/?>(?:<\\/\\1>|)$/i,C=/^.[^:#\\[\\.,]*$/;function D(a,b,c){if(r.isFunction(b))return r.grep(a,function(a,d){return!!b.call(a,d,a)!==c});if(b.nodeType)return r.grep(a,function(a){return a===b!==c});if(\"string\"==typeof b){if(C.test(b))return r.filter(b,a,c);b=r.filter(b,a)}return r.grep(a,function(a){return i.call(b,a)>-1!==c&&1===a.nodeType})}r.filter=function(a,b,c){var d=b[0];return c&&(a=\":not(\"+a+\")\"),1===b.length&&1===d.nodeType?r.find.matchesSelector(d,a)?[d]:[]:r.find.matches(a,r.grep(b,function(a){return 1===a.nodeType}))},r.fn.extend({find:function(a){var b,c,d=this.length,e=this;if(\"string\"!=typeof a)return this.pushStack(r(a).filter(function(){for(b=0;b<d;b++)if(r.contains(e[b],this))return!0}));for(c=this.pushStack([]),b=0;b<d;b++)r.find(a,e[b],c);return d>1?r.uniqueSort(c):c},filter:function(a){return this.pushStack(D(this,a||[],!1))},not:function(a){return this.pushStack(D(this,a||[],!0))},is:function(a){return!!D(this,\"string\"==typeof a&&A.test(a)?r(a):a||[],!1).length}});var E,F=/^(?:\\s*(<[\\w\\W]+>)[^>]*|#([\\w-]+))$/,G=r.fn.init=function(a,b,c){var e,f;if(!a)return this;if(c=c||E,\"string\"==typeof a){if(e=\"<\"===a[0]&&\">\"===a[a.length-1]&&a.length>=3?[null,a,null]:F.exec(a),!e||!e[1]&&b)return!b||b.jquery?(b||c).find(a):this.constructor(b).find(a);if(e[1]){if(b=b instanceof r?b[0]:b,r.merge(this,r.parseHTML(e[1],b&&b.nodeType?b.ownerDocument||b:d,!0)),B.test(e[1])&&r.isPlainObject(b))for(e in b)r.isFunction(this[e])?this[e](b[e]):this.attr(e,b[e]);return this}return f=d.getElementById(e[2]),f&&(this[0]=f,this.length=1),this}return a.nodeType?(this[0]=a,this.length=1,this):r.isFunction(a)?void 0!==c.ready?c.ready(a):a(r):r.makeArray(a,this)};G.prototype=r.fn,E=r(d);var H=/^(?:parents|prev(?:Until|All))/,I={children:!0,contents:!0,next:!0,prev:!0};r.fn.extend({has:function(a){var b=r(a,this),c=b.length;return this.filter(function(){for(var a=0;a<c;a++)if(r.contains(this,b[a]))return!0})},closest:function(a,b){var c,d=0,e=this.length,f=[],g=\"string\"!=typeof a&&r(a);if(!A.test(a))for(;d<e;d++)for(c=this[d];c&&c!==b;c=c.parentNode)if(c.nodeType<11&&(g?g.index(c)>-1:1===c.nodeType&&r.find.matchesSelector(c,a))){f.push(c);break}return this.pushStack(f.length>1?r.uniqueSort(f):f)},index:function(a){return a?\"string\"==typeof a?i.call(r(a),this[0]):i.call(this,a.jquery?a[0]:a):this[0]&&this[0].parentNode?this.first().prevAll().length:-1},add:function(a,b){return this.pushStack(r.uniqueSort(r.merge(this.get(),r(a,b))))},addBack:function(a){return this.add(null==a?this.prevObject:this.prevObject.filter(a))}});function J(a,b){while((a=a[b])&&1!==a.nodeType);return a}r.each({parent:function(a){var b=a.parentNode;return b&&11!==b.nodeType?b:null},parents:function(a){return y(a,\"parentNode\")},parentsUntil:function(a,b,c){return y(a,\"parentNode\",c)},next:function(a){return J(a,\"nextSibling\")},prev:function(a){return J(a,\"previousSibling\")},nextAll:function(a){return y(a,\"nextSibling\")},prevAll:function(a){return y(a,\"previousSibling\")},nextUntil:function(a,b,c){return y(a,\"nextSibling\",c)},prevUntil:function(a,b,c){return y(a,\"previousSibling\",c)},siblings:function(a){return z((a.parentNode||{}).firstChild,a)},children:function(a){return z(a.firstChild)},contents:function(a){return a.contentDocument||r.merge([],a.childNodes)}},function(a,b){r.fn[a]=function(c,d){var e=r.map(this,b,c);return\"Until\"!==a.slice(-5)&&(d=c),d&&\"string\"==typeof d&&(e=r.filter(d,e)),this.length>1&&(I[a]||r.uniqueSort(e),H.test(a)&&e.reverse()),this.pushStack(e)}});var K=/\\S+/g;function L(a){var b={};return r.each(a.match(K)||[],function(a,c){b[c]=!0}),b}r.Callbacks=function(a){a=\"string\"==typeof a?L(a):r.extend({},a);var b,c,d,e,f=[],g=[],h=-1,i=function(){for(e=a.once,d=b=!0;g.length;h=-1){c=g.shift();while(++h<f.length)f[h].apply(c[0],c[1])===!1&&a.stopOnFalse&&(h=f.length,c=!1)}a.memory||(c=!1),b=!1,e&&(f=c?[]:\"\")},j={add:function(){return f&&(c&&!b&&(h=f.length-1,g.push(c)),function d(b){r.each(b,function(b,c){r.isFunction(c)?a.unique&&j.has(c)||f.push(c):c&&c.length&&\"string\"!==r.type(c)&&d(c)})}(arguments),c&&!b&&i()),this},remove:function(){return r.each(arguments,function(a,b){var c;while((c=r.inArray(b,f,c))>-1)f.splice(c,1),c<=h&&h--}),this},has:function(a){return a?r.inArray(a,f)>-1:f.length>0},empty:function(){return f&&(f=[]),this},disable:function(){return e=g=[],f=c=\"\",this},disabled:function(){return!f},lock:function(){return e=g=[],c||b||(f=c=\"\"),this},locked:function(){return!!e},fireWith:function(a,c){return e||(c=c||[],c=[a,c.slice?c.slice():c],g.push(c),b||i()),this},fire:function(){return j.fireWith(this,arguments),this},fired:function(){return!!d}};return j};function M(a){return a}function N(a){throw a}function O(a,b,c){var d;try{a&&r.isFunction(d=a.promise)?d.call(a).done(b).fail(c):a&&r.isFunction(d=a.then)?d.call(a,b,c):b.call(void 0,a)}catch(a){c.call(void 0,a)}}r.extend({Deferred:function(b){var c=[[\"notify\",\"progress\",r.Callbacks(\"memory\"),r.Callbacks(\"memory\"),2],[\"resolve\",\"done\",r.Callbacks(\"once memory\"),r.Callbacks(\"once memory\"),0,\"resolved\"],[\"reject\",\"fail\",r.Callbacks(\"once memory\"),r.Callbacks(\"once memory\"),1,\"rejected\"]],d=\"pending\",e={state:function(){return d},always:function(){return f.done(arguments).fail(arguments),this},\"catch\":function(a){return e.then(null,a)},pipe:function(){var a=arguments;return r.Deferred(function(b){r.each(c,function(c,d){var e=r.isFunction(a[d[4]])&&a[d[4]];f[d[1]](function(){var a=e&&e.apply(this,arguments);a&&r.isFunction(a.promise)?a.promise().progress(b.notify).done(b.resolve).fail(b.reject):b[d[0]+\"With\"](this,e?[a]:arguments)})}),a=null}).promise()},then:function(b,d,e){var f=0;function g(b,c,d,e){return function(){var h=this,i=arguments,j=function(){var a,j;if(!(b<f)){if(a=d.apply(h,i),a===c.promise())throw new TypeError(\"Thenable self-resolution\");j=a&&(\"object\"==typeof a||\"function\"==typeof a)&&a.then,r.isFunction(j)?e?j.call(a,g(f,c,M,e),g(f,c,N,e)):(f++,j.call(a,g(f,c,M,e),g(f,c,N,e),g(f,c,M,c.notifyWith))):(d!==M&&(h=void 0,i=[a]),(e||c.resolveWith)(h,i))}},k=e?j:function(){try{j()}catch(a){r.Deferred.exceptionHook&&r.Deferred.exceptionHook(a,k.stackTrace),b+1>=f&&(d!==N&&(h=void 0,i=[a]),c.rejectWith(h,i))}};b?k():(r.Deferred.getStackHook&&(k.stackTrace=r.Deferred.getStackHook()),a.setTimeout(k))}}return r.Deferred(function(a){c[0][3].add(g(0,a,r.isFunction(e)?e:M,a.notifyWith)),c[1][3].add(g(0,a,r.isFunction(b)?b:M)),c[2][3].add(g(0,a,r.isFunction(d)?d:N))}).promise()},promise:function(a){return null!=a?r.extend(a,e):e}},f={};return r.each(c,function(a,b){var g=b[2],h=b[5];e[b[1]]=g.add,h&&g.add(function(){d=h},c[3-a][2].disable,c[0][2].lock),g.add(b[3].fire),f[b[0]]=function(){return f[b[0]+\"With\"](this===f?void 0:this,arguments),this},f[b[0]+\"With\"]=g.fireWith}),e.promise(f),b&&b.call(f,f),f},when:function(a){var b=arguments.length,c=b,d=Array(c),e=f.call(arguments),g=r.Deferred(),h=function(a){return function(c){d[a]=this,e[a]=arguments.length>1?f.call(arguments):c,--b||g.resolveWith(d,e)}};if(b<=1&&(O(a,g.done(h(c)).resolve,g.reject),\"pending\"===g.state()||r.isFunction(e[c]&&e[c].then)))return g.then();while(c--)O(e[c],h(c),g.reject);return g.promise()}});var P=/^(Eval|Internal|Range|Reference|Syntax|Type|URI)Error$/;r.Deferred.exceptionHook=function(b,c){a.console&&a.console.warn&&b&&P.test(b.name)&&a.console.warn(\"jQuery.Deferred exception: \"+b.message,b.stack,c)},r.readyException=function(b){a.setTimeout(function(){throw b})};var Q=r.Deferred();r.fn.ready=function(a){return Q.then(a)[\"catch\"](function(a){r.readyException(a)}),this},r.extend({isReady:!1,readyWait:1,holdReady:function(a){a?r.readyWait++:r.ready(!0)},ready:function(a){(a===!0?--r.readyWait:r.isReady)||(r.isReady=!0,a!==!0&&--r.readyWait>0||Q.resolveWith(d,[r]))}}),r.ready.then=Q.then;function R(){d.removeEventListener(\"DOMContentLoaded\",R),a.removeEventListener(\"load\",R),r.ready()}\"complete\"===d.readyState||\"loading\"!==d.readyState&&!d.documentElement.doScroll?a.setTimeout(r.ready):(d.addEventListener(\"DOMContentLoaded\",R),a.addEventListener(\"load\",R));var S=function(a,b,c,d,e,f,g){var h=0,i=a.length,j=null==c;if(\"object\"===r.type(c)){e=!0;for(h in c)S(a,b,h,c[h],!0,f,g)}else if(void 0!==d&&(e=!0,\nr.isFunction(d)||(g=!0),j&&(g?(b.call(a,d),b=null):(j=b,b=function(a,b,c){return j.call(r(a),c)})),b))for(;h<i;h++)b(a[h],c,g?d:d.call(a[h],h,b(a[h],c)));return e?a:j?b.call(a):i?b(a[0],c):f},T=function(a){return 1===a.nodeType||9===a.nodeType||!+a.nodeType};function U(){this.expando=r.expando+U.uid++}U.uid=1,U.prototype={cache:function(a){var b=a[this.expando];return b||(b={},T(a)&&(a.nodeType?a[this.expando]=b:Object.defineProperty(a,this.expando,{value:b,configurable:!0}))),b},set:function(a,b,c){var d,e=this.cache(a);if(\"string\"==typeof b)e[r.camelCase(b)]=c;else for(d in b)e[r.camelCase(d)]=b[d];return e},get:function(a,b){return void 0===b?this.cache(a):a[this.expando]&&a[this.expando][r.camelCase(b)]},access:function(a,b,c){return void 0===b||b&&\"string\"==typeof b&&void 0===c?this.get(a,b):(this.set(a,b,c),void 0!==c?c:b)},remove:function(a,b){var c,d=a[this.expando];if(void 0!==d){if(void 0!==b){r.isArray(b)?b=b.map(r.camelCase):(b=r.camelCase(b),b=b in d?[b]:b.match(K)||[]),c=b.length;while(c--)delete d[b[c]]}(void 0===b||r.isEmptyObject(d))&&(a.nodeType?a[this.expando]=void 0:delete a[this.expando])}},hasData:function(a){var b=a[this.expando];return void 0!==b&&!r.isEmptyObject(b)}};var V=new U,W=new U,X=/^(?:\\{[\\w\\W]*\\}|\\[[\\w\\W]*\\])$/,Y=/[A-Z]/g;function Z(a,b,c){var d;if(void 0===c&&1===a.nodeType)if(d=\"data-\"+b.replace(Y,\"-$&\").toLowerCase(),c=a.getAttribute(d),\"string\"==typeof c){try{c=\"true\"===c||\"false\"!==c&&(\"null\"===c?null:+c+\"\"===c?+c:X.test(c)?JSON.parse(c):c)}catch(e){}W.set(a,b,c)}else c=void 0;return c}r.extend({hasData:function(a){return W.hasData(a)||V.hasData(a)},data:function(a,b,c){return W.access(a,b,c)},removeData:function(a,b){W.remove(a,b)},_data:function(a,b,c){return V.access(a,b,c)},_removeData:function(a,b){V.remove(a,b)}}),r.fn.extend({data:function(a,b){var c,d,e,f=this[0],g=f&&f.attributes;if(void 0===a){if(this.length&&(e=W.get(f),1===f.nodeType&&!V.get(f,\"hasDataAttrs\"))){c=g.length;while(c--)g[c]&&(d=g[c].name,0===d.indexOf(\"data-\")&&(d=r.camelCase(d.slice(5)),Z(f,d,e[d])));V.set(f,\"hasDataAttrs\",!0)}return e}return\"object\"==typeof a?this.each(function(){W.set(this,a)}):S(this,function(b){var c;if(f&&void 0===b){if(c=W.get(f,a),void 0!==c)return c;if(c=Z(f,a),void 0!==c)return c}else this.each(function(){W.set(this,a,b)})},null,b,arguments.length>1,null,!0)},removeData:function(a){return this.each(function(){W.remove(this,a)})}}),r.extend({queue:function(a,b,c){var d;if(a)return b=(b||\"fx\")+\"queue\",d=V.get(a,b),c&&(!d||r.isArray(c)?d=V.access(a,b,r.makeArray(c)):d.push(c)),d||[]},dequeue:function(a,b){b=b||\"fx\";var c=r.queue(a,b),d=c.length,e=c.shift(),f=r._queueHooks(a,b),g=function(){r.dequeue(a,b)};\"inprogress\"===e&&(e=c.shift(),d--),e&&(\"fx\"===b&&c.unshift(\"inprogress\"),delete f.stop,e.call(a,g,f)),!d&&f&&f.empty.fire()},_queueHooks:function(a,b){var c=b+\"queueHooks\";return V.get(a,c)||V.access(a,c,{empty:r.Callbacks(\"once memory\").add(function(){V.remove(a,[b+\"queue\",c])})})}}),r.fn.extend({queue:function(a,b){var c=2;return\"string\"!=typeof a&&(b=a,a=\"fx\",c--),arguments.length<c?r.queue(this[0],a):void 0===b?this:this.each(function(){var c=r.queue(this,a,b);r._queueHooks(this,a),\"fx\"===a&&\"inprogress\"!==c[0]&&r.dequeue(this,a)})},dequeue:function(a){return this.each(function(){r.dequeue(this,a)})},clearQueue:function(a){return this.queue(a||\"fx\",[])},promise:function(a,b){var c,d=1,e=r.Deferred(),f=this,g=this.length,h=function(){--d||e.resolveWith(f,[f])};\"string\"!=typeof a&&(b=a,a=void 0),a=a||\"fx\";while(g--)c=V.get(f[g],a+\"queueHooks\"),c&&c.empty&&(d++,c.empty.add(h));return h(),e.promise(b)}});var $=/[+-]?(?:\\d*\\.|)\\d+(?:[eE][+-]?\\d+|)/.source,_=new RegExp(\"^(?:([+-])=|)(\"+$+\")([a-z%]*)$\",\"i\"),aa=[\"Top\",\"Right\",\"Bottom\",\"Left\"],ba=function(a,b){return a=b||a,\"none\"===a.style.display||\"\"===a.style.display&&r.contains(a.ownerDocument,a)&&\"none\"===r.css(a,\"display\")},ca=function(a,b,c,d){var e,f,g={};for(f in b)g[f]=a.style[f],a.style[f]=b[f];e=c.apply(a,d||[]);for(f in b)a.style[f]=g[f];return e};function da(a,b,c,d){var e,f=1,g=20,h=d?function(){return d.cur()}:function(){return r.css(a,b,\"\")},i=h(),j=c&&c[3]||(r.cssNumber[b]?\"\":\"px\"),k=(r.cssNumber[b]||\"px\"!==j&&+i)&&_.exec(r.css(a,b));if(k&&k[3]!==j){j=j||k[3],c=c||[],k=+i||1;do f=f||\".5\",k/=f,r.style(a,b,k+j);while(f!==(f=h()/i)&&1!==f&&--g)}return c&&(k=+k||+i||0,e=c[1]?k+(c[1]+1)*c[2]:+c[2],d&&(d.unit=j,d.start=k,d.end=e)),e}var ea={};function fa(a){var b,c=a.ownerDocument,d=a.nodeName,e=ea[d];return e?e:(b=c.body.appendChild(c.createElement(d)),e=r.css(b,\"display\"),b.parentNode.removeChild(b),\"none\"===e&&(e=\"block\"),ea[d]=e,e)}function ga(a,b){for(var c,d,e=[],f=0,g=a.length;f<g;f++)d=a[f],d.style&&(c=d.style.display,b?(\"none\"===c&&(e[f]=V.get(d,\"display\")||null,e[f]||(d.style.display=\"\")),\"\"===d.style.display&&ba(d)&&(e[f]=fa(d))):\"none\"!==c&&(e[f]=\"none\",V.set(d,\"display\",c)));for(f=0;f<g;f++)null!=e[f]&&(a[f].style.display=e[f]);return a}r.fn.extend({show:function(){return ga(this,!0)},hide:function(){return ga(this)},toggle:function(a){return\"boolean\"==typeof a?a?this.show():this.hide():this.each(function(){ba(this)?r(this).show():r(this).hide()})}});var ha=/^(?:checkbox|radio)$/i,ia=/<([a-z][^\\/\\0>\\x20\\t\\r\\n\\f]+)/i,ja=/^$|\\/(?:java|ecma)script/i,ka={option:[1,\"<select multiple='multiple'>\",\"</select>\"],thead:[1,\"<table>\",\"</table>\"],col:[2,\"<table><colgroup>\",\"</colgroup></table>\"],tr:[2,\"<table><tbody>\",\"</tbody></table>\"],td:[3,\"<table><tbody><tr>\",\"</tr></tbody></table>\"],_default:[0,\"\",\"\"]};ka.optgroup=ka.option,ka.tbody=ka.tfoot=ka.colgroup=ka.caption=ka.thead,ka.th=ka.td;function la(a,b){var c=\"undefined\"!=typeof a.getElementsByTagName?a.getElementsByTagName(b||\"*\"):\"undefined\"!=typeof a.querySelectorAll?a.querySelectorAll(b||\"*\"):[];return void 0===b||b&&r.nodeName(a,b)?r.merge([a],c):c}function ma(a,b){for(var c=0,d=a.length;c<d;c++)V.set(a[c],\"globalEval\",!b||V.get(b[c],\"globalEval\"))}var na=/<|&#?\\w+;/;function oa(a,b,c,d,e){for(var f,g,h,i,j,k,l=b.createDocumentFragment(),m=[],n=0,o=a.length;n<o;n++)if(f=a[n],f||0===f)if(\"object\"===r.type(f))r.merge(m,f.nodeType?[f]:f);else if(na.test(f)){g=g||l.appendChild(b.createElement(\"div\")),h=(ia.exec(f)||[\"\",\"\"])[1].toLowerCase(),i=ka[h]||ka._default,g.innerHTML=i[1]+r.htmlPrefilter(f)+i[2],k=i[0];while(k--)g=g.lastChild;r.merge(m,g.childNodes),g=l.firstChild,g.textContent=\"\"}else m.push(b.createTextNode(f));l.textContent=\"\",n=0;while(f=m[n++])if(d&&r.inArray(f,d)>-1)e&&e.push(f);else if(j=r.contains(f.ownerDocument,f),g=la(l.appendChild(f),\"script\"),j&&ma(g),c){k=0;while(f=g[k++])ja.test(f.type||\"\")&&c.push(f)}return l}!function(){var a=d.createDocumentFragment(),b=a.appendChild(d.createElement(\"div\")),c=d.createElement(\"input\");c.setAttribute(\"type\",\"radio\"),c.setAttribute(\"checked\",\"checked\"),c.setAttribute(\"name\",\"t\"),b.appendChild(c),o.checkClone=b.cloneNode(!0).cloneNode(!0).lastChild.checked,b.innerHTML=\"<textarea>x</textarea>\",o.noCloneChecked=!!b.cloneNode(!0).lastChild.defaultValue}();var pa=d.documentElement,qa=/^key/,ra=/^(?:mouse|pointer|contextmenu|drag|drop)|click/,sa=/^([^.]*)(?:\\.(.+)|)/;function ta(){return!0}function ua(){return!1}function va(){try{return d.activeElement}catch(a){}}function wa(a,b,c,d,e,f){var g,h;if(\"object\"==typeof b){\"string\"!=typeof c&&(d=d||c,c=void 0);for(h in b)wa(a,h,c,d,b[h],f);return a}if(null==d&&null==e?(e=c,d=c=void 0):null==e&&(\"string\"==typeof c?(e=d,d=void 0):(e=d,d=c,c=void 0)),e===!1)e=ua;else if(!e)return a;return 1===f&&(g=e,e=function(a){return r().off(a),g.apply(this,arguments)},e.guid=g.guid||(g.guid=r.guid++)),a.each(function(){r.event.add(this,b,e,d,c)})}r.event={global:{},add:function(a,b,c,d,e){var f,g,h,i,j,k,l,m,n,o,p,q=V.get(a);if(q){c.handler&&(f=c,c=f.handler,e=f.selector),e&&r.find.matchesSelector(pa,e),c.guid||(c.guid=r.guid++),(i=q.events)||(i=q.events={}),(g=q.handle)||(g=q.handle=function(b){return\"undefined\"!=typeof r&&r.event.triggered!==b.type?r.event.dispatch.apply(a,arguments):void 0}),b=(b||\"\").match(K)||[\"\"],j=b.length;while(j--)h=sa.exec(b[j])||[],n=p=h[1],o=(h[2]||\"\").split(\".\").sort(),n&&(l=r.event.special[n]||{},n=(e?l.delegateType:l.bindType)||n,l=r.event.special[n]||{},k=r.extend({type:n,origType:p,data:d,handler:c,guid:c.guid,selector:e,needsContext:e&&r.expr.match.needsContext.test(e),namespace:o.join(\".\")},f),(m=i[n])||(m=i[n]=[],m.delegateCount=0,l.setup&&l.setup.call(a,d,o,g)!==!1||a.addEventListener&&a.addEventListener(n,g)),l.add&&(l.add.call(a,k),k.handler.guid||(k.handler.guid=c.guid)),e?m.splice(m.delegateCount++,0,k):m.push(k),r.event.global[n]=!0)}},remove:function(a,b,c,d,e){var f,g,h,i,j,k,l,m,n,o,p,q=V.hasData(a)&&V.get(a);if(q&&(i=q.events)){b=(b||\"\").match(K)||[\"\"],j=b.length;while(j--)if(h=sa.exec(b[j])||[],n=p=h[1],o=(h[2]||\"\").split(\".\").sort(),n){l=r.event.special[n]||{},n=(d?l.delegateType:l.bindType)||n,m=i[n]||[],h=h[2]&&new RegExp(\"(^|\\\\.)\"+o.join(\"\\\\.(?:.*\\\\.|)\")+\"(\\\\.|$)\"),g=f=m.length;while(f--)k=m[f],!e&&p!==k.origType||c&&c.guid!==k.guid||h&&!h.test(k.namespace)||d&&d!==k.selector&&(\"**\"!==d||!k.selector)||(m.splice(f,1),k.selector&&m.delegateCount--,l.remove&&l.remove.call(a,k));g&&!m.length&&(l.teardown&&l.teardown.call(a,o,q.handle)!==!1||r.removeEvent(a,n,q.handle),delete i[n])}else for(n in i)r.event.remove(a,n+b[j],c,d,!0);r.isEmptyObject(i)&&V.remove(a,\"handle events\")}},dispatch:function(a){var b=r.event.fix(a),c,d,e,f,g,h,i=new Array(arguments.length),j=(V.get(this,\"events\")||{})[b.type]||[],k=r.event.special[b.type]||{};for(i[0]=b,c=1;c<arguments.length;c++)i[c]=arguments[c];if(b.delegateTarget=this,!k.preDispatch||k.preDispatch.call(this,b)!==!1){h=r.event.handlers.call(this,b,j),c=0;while((f=h[c++])&&!b.isPropagationStopped()){b.currentTarget=f.elem,d=0;while((g=f.handlers[d++])&&!b.isImmediatePropagationStopped())b.rnamespace&&!b.rnamespace.test(g.namespace)||(b.handleObj=g,b.data=g.data,e=((r.event.special[g.origType]||{}).handle||g.handler).apply(f.elem,i),void 0!==e&&(b.result=e)===!1&&(b.preventDefault(),b.stopPropagation()))}return k.postDispatch&&k.postDispatch.call(this,b),b.result}},handlers:function(a,b){var c,d,e,f,g=[],h=b.delegateCount,i=a.target;if(h&&i.nodeType&&(\"click\"!==a.type||isNaN(a.button)||a.button<1))for(;i!==this;i=i.parentNode||this)if(1===i.nodeType&&(i.disabled!==!0||\"click\"!==a.type)){for(d=[],c=0;c<h;c++)f=b[c],e=f.selector+\" \",void 0===d[e]&&(d[e]=f.needsContext?r(e,this).index(i)>-1:r.find(e,this,null,[i]).length),d[e]&&d.push(f);d.length&&g.push({elem:i,handlers:d})}return h<b.length&&g.push({elem:this,handlers:b.slice(h)}),g},addProp:function(a,b){Object.defineProperty(r.Event.prototype,a,{enumerable:!0,configurable:!0,get:r.isFunction(b)?function(){if(this.originalEvent)return b(this.originalEvent)}:function(){if(this.originalEvent)return this.originalEvent[a]},set:function(b){Object.defineProperty(this,a,{enumerable:!0,configurable:!0,writable:!0,value:b})}})},fix:function(a){return a[r.expando]?a:new r.Event(a)},special:{load:{noBubble:!0},focus:{trigger:function(){if(this!==va()&&this.focus)return this.focus(),!1},delegateType:\"focusin\"},blur:{trigger:function(){if(this===va()&&this.blur)return this.blur(),!1},delegateType:\"focusout\"},click:{trigger:function(){if(\"checkbox\"===this.type&&this.click&&r.nodeName(this,\"input\"))return this.click(),!1},_default:function(a){return r.nodeName(a.target,\"a\")}},beforeunload:{postDispatch:function(a){void 0!==a.result&&a.originalEvent&&(a.originalEvent.returnValue=a.result)}}}},r.removeEvent=function(a,b,c){a.removeEventListener&&a.removeEventListener(b,c)},r.Event=function(a,b){return this instanceof r.Event?(a&&a.type?(this.originalEvent=a,this.type=a.type,this.isDefaultPrevented=a.defaultPrevented||void 0===a.defaultPrevented&&a.returnValue===!1?ta:ua,this.target=a.target&&3===a.target.nodeType?a.target.parentNode:a.target,this.currentTarget=a.currentTarget,this.relatedTarget=a.relatedTarget):this.type=a,b&&r.extend(this,b),this.timeStamp=a&&a.timeStamp||r.now(),void(this[r.expando]=!0)):new r.Event(a,b)},r.Event.prototype={constructor:r.Event,isDefaultPrevented:ua,isPropagationStopped:ua,isImmediatePropagationStopped:ua,isSimulated:!1,preventDefault:function(){var a=this.originalEvent;this.isDefaultPrevented=ta,a&&!this.isSimulated&&a.preventDefault()},stopPropagation:function(){var a=this.originalEvent;this.isPropagationStopped=ta,a&&!this.isSimulated&&a.stopPropagation()},stopImmediatePropagation:function(){var a=this.originalEvent;this.isImmediatePropagationStopped=ta,a&&!this.isSimulated&&a.stopImmediatePropagation(),this.stopPropagation()}},r.each({altKey:!0,bubbles:!0,cancelable:!0,changedTouches:!0,ctrlKey:!0,detail:!0,eventPhase:!0,metaKey:!0,pageX:!0,pageY:!0,shiftKey:!0,view:!0,\"char\":!0,charCode:!0,key:!0,keyCode:!0,button:!0,buttons:!0,clientX:!0,clientY:!0,offsetX:!0,offsetY:!0,pointerId:!0,pointerType:!0,screenX:!0,screenY:!0,targetTouches:!0,toElement:!0,touches:!0,which:function(a){var b=a.button;return null==a.which&&qa.test(a.type)?null!=a.charCode?a.charCode:a.keyCode:!a.which&&void 0!==b&&ra.test(a.type)?1&b?1:2&b?3:4&b?2:0:a.which}},r.event.addProp),r.each({mouseenter:\"mouseover\",mouseleave:\"mouseout\",pointerenter:\"pointerover\",pointerleave:\"pointerout\"},function(a,b){r.event.special[a]={delegateType:b,bindType:b,handle:function(a){var c,d=this,e=a.relatedTarget,f=a.handleObj;return e&&(e===d||r.contains(d,e))||(a.type=f.origType,c=f.handler.apply(this,arguments),a.type=b),c}}}),r.fn.extend({on:function(a,b,c,d){return wa(this,a,b,c,d)},one:function(a,b,c,d){return wa(this,a,b,c,d,1)},off:function(a,b,c){var d,e;if(a&&a.preventDefault&&a.handleObj)return d=a.handleObj,r(a.delegateTarget).off(d.namespace?d.origType+\".\"+d.namespace:d.origType,d.selector,d.handler),this;if(\"object\"==typeof a){for(e in a)this.off(e,b,a[e]);return this}return b!==!1&&\"function\"!=typeof b||(c=b,b=void 0),c===!1&&(c=ua),this.each(function(){r.event.remove(this,a,c,b)})}});var xa=/<(?!area|br|col|embed|hr|img|input|link|meta|param)(([a-z][^\\/\\0>\\x20\\t\\r\\n\\f]*)[^>]*)\\/>/gi,ya=/<script|<style|<link/i,za=/checked\\s*(?:[^=]|=\\s*.checked.)/i,Aa=/^true\\/(.*)/,Ba=/^\\s*<!(?:\\[CDATA\\[|--)|(?:\\]\\]|--)>\\s*$/g;function Ca(a,b){return r.nodeName(a,\"table\")&&r.nodeName(11!==b.nodeType?b:b.firstChild,\"tr\")?a.getElementsByTagName(\"tbody\")[0]||a:a}function Da(a){return a.type=(null!==a.getAttribute(\"type\"))+\"/\"+a.type,a}function Ea(a){var b=Aa.exec(a.type);return b?a.type=b[1]:a.removeAttribute(\"type\"),a}function Fa(a,b){var c,d,e,f,g,h,i,j;if(1===b.nodeType){if(V.hasData(a)&&(f=V.access(a),g=V.set(b,f),j=f.events)){delete g.handle,g.events={};for(e in j)for(c=0,d=j[e].length;c<d;c++)r.event.add(b,e,j[e][c])}W.hasData(a)&&(h=W.access(a),i=r.extend({},h),W.set(b,i))}}function Ga(a,b){var c=b.nodeName.toLowerCase();\"input\"===c&&ha.test(a.type)?b.checked=a.checked:\"input\"!==c&&\"textarea\"!==c||(b.defaultValue=a.defaultValue)}function Ha(a,b,c,d){b=g.apply([],b);var e,f,h,i,j,k,l=0,m=a.length,n=m-1,q=b[0],s=r.isFunction(q);if(s||m>1&&\"string\"==typeof q&&!o.checkClone&&za.test(q))return a.each(function(e){var f=a.eq(e);s&&(b[0]=q.call(this,e,f.html())),Ha(f,b,c,d)});if(m&&(e=oa(b,a[0].ownerDocument,!1,a,d),f=e.firstChild,1===e.childNodes.length&&(e=f),f||d)){for(h=r.map(la(e,\"script\"),Da),i=h.length;l<m;l++)j=e,l!==n&&(j=r.clone(j,!0,!0),i&&r.merge(h,la(j,\"script\"))),c.call(a[l],j,l);if(i)for(k=h[h.length-1].ownerDocument,r.map(h,Ea),l=0;l<i;l++)j=h[l],ja.test(j.type||\"\")&&!V.access(j,\"globalEval\")&&r.contains(k,j)&&(j.src?r._evalUrl&&r._evalUrl(j.src):p(j.textContent.replace(Ba,\"\"),k))}return a}function Ia(a,b,c){for(var d,e=b?r.filter(b,a):a,f=0;null!=(d=e[f]);f++)c||1!==d.nodeType||r.cleanData(la(d)),d.parentNode&&(c&&r.contains(d.ownerDocument,d)&&ma(la(d,\"script\")),d.parentNode.removeChild(d));return a}r.extend({htmlPrefilter:function(a){return a.replace(xa,\"<$1></$2>\")},clone:function(a,b,c){var d,e,f,g,h=a.cloneNode(!0),i=r.contains(a.ownerDocument,a);if(!(o.noCloneChecked||1!==a.nodeType&&11!==a.nodeType||r.isXMLDoc(a)))for(g=la(h),f=la(a),d=0,e=f.length;d<e;d++)Ga(f[d],g[d]);if(b)if(c)for(f=f||la(a),g=g||la(h),d=0,e=f.length;d<e;d++)Fa(f[d],g[d]);else Fa(a,h);return g=la(h,\"script\"),g.length>0&&ma(g,!i&&la(a,\"script\")),h},cleanData:function(a){for(var b,c,d,e=r.event.special,f=0;void 0!==(c=a[f]);f++)if(T(c)){if(b=c[V.expando]){if(b.events)for(d in b.events)e[d]?r.event.remove(c,d):r.removeEvent(c,d,b.handle);c[V.expando]=void 0}c[W.expando]&&(c[W.expando]=void 0)}}}),r.fn.extend({detach:function(a){return Ia(this,a,!0)},remove:function(a){return Ia(this,a)},text:function(a){return S(this,function(a){return void 0===a?r.text(this):this.empty().each(function(){1!==this.nodeType&&11!==this.nodeType&&9!==this.nodeType||(this.textContent=a)})},null,a,arguments.length)},append:function(){return Ha(this,arguments,function(a){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var b=Ca(this,a);b.appendChild(a)}})},prepend:function(){return Ha(this,arguments,function(a){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var b=Ca(this,a);b.insertBefore(a,b.firstChild)}})},before:function(){return Ha(this,arguments,function(a){this.parentNode&&this.parentNode.insertBefore(a,this)})},after:function(){return Ha(this,arguments,function(a){this.parentNode&&this.parentNode.insertBefore(a,this.nextSibling)})},empty:function(){for(var a,b=0;null!=(a=this[b]);b++)1===a.nodeType&&(r.cleanData(la(a,!1)),a.textContent=\"\");return this},clone:function(a,b){return a=null!=a&&a,b=null==b?a:b,this.map(function(){return r.clone(this,a,b)})},html:function(a){return S(this,function(a){var b=this[0]||{},c=0,d=this.length;if(void 0===a&&1===b.nodeType)return b.innerHTML;if(\"string\"==typeof a&&!ya.test(a)&&!ka[(ia.exec(a)||[\"\",\"\"])[1].toLowerCase()]){a=r.htmlPrefilter(a);try{for(;c<d;c++)b=this[c]||{},1===b.nodeType&&(r.cleanData(la(b,!1)),b.innerHTML=a);b=0}catch(e){}}b&&this.empty().append(a)},null,a,arguments.length)},replaceWith:function(){var a=[];return Ha(this,arguments,function(b){var c=this.parentNode;r.inArray(this,a)<0&&(r.cleanData(la(this)),c&&c.replaceChild(b,this))},a)}}),r.each({appendTo:\"append\",prependTo:\"prepend\",insertBefore:\"before\",insertAfter:\"after\",replaceAll:\"replaceWith\"},function(a,b){r.fn[a]=function(a){for(var c,d=[],e=r(a),f=e.length-1,g=0;g<=f;g++)c=g===f?this:this.clone(!0),r(e[g])[b](c),h.apply(d,c.get());return this.pushStack(d)}});var Ja=/^margin/,Ka=new RegExp(\"^(\"+$+\")(?!px)[a-z%]+$\",\"i\"),La=function(b){var c=b.ownerDocument.defaultView;return c&&c.opener||(c=a),c.getComputedStyle(b)};!function(){function b(){if(i){i.style.cssText=\"box-sizing:border-box;position:relative;display:block;margin:auto;border:1px;padding:1px;top:1%;width:50%\",i.innerHTML=\"\",pa.appendChild(h);var b=a.getComputedStyle(i);c=\"1%\"!==b.top,g=\"2px\"===b.marginLeft,e=\"4px\"===b.width,i.style.marginRight=\"50%\",f=\"4px\"===b.marginRight,pa.removeChild(h),i=null}}var c,e,f,g,h=d.createElement(\"div\"),i=d.createElement(\"div\");i.style&&(i.style.backgroundClip=\"content-box\",i.cloneNode(!0).style.backgroundClip=\"\",o.clearCloneStyle=\"content-box\"===i.style.backgroundClip,h.style.cssText=\"border:0;width:8px;height:0;top:0;left:-9999px;padding:0;margin-top:1px;position:absolute\",h.appendChild(i),r.extend(o,{pixelPosition:function(){return b(),c},boxSizingReliable:function(){return b(),e},pixelMarginRight:function(){return b(),f},reliableMarginLeft:function(){return b(),g}}))}();function Ma(a,b,c){var d,e,f,g,h=a.style;return c=c||La(a),c&&(g=c.getPropertyValue(b)||c[b],\"\"!==g||r.contains(a.ownerDocument,a)||(g=r.style(a,b)),!o.pixelMarginRight()&&Ka.test(g)&&Ja.test(b)&&(d=h.width,e=h.minWidth,f=h.maxWidth,h.minWidth=h.maxWidth=h.width=g,g=c.width,h.width=d,h.minWidth=e,h.maxWidth=f)),void 0!==g?g+\"\":g}function Na(a,b){return{get:function(){return a()?void delete this.get:(this.get=b).apply(this,arguments)}}}var Oa=/^(none|table(?!-c[ea]).+)/,Pa={position:\"absolute\",visibility:\"hidden\",display:\"block\"},Qa={letterSpacing:\"0\",fontWeight:\"400\"},Ra=[\"Webkit\",\"Moz\",\"ms\"],Sa=d.createElement(\"div\").style;function Ta(a){if(a in Sa)return a;var b=a[0].toUpperCase()+a.slice(1),c=Ra.length;while(c--)if(a=Ra[c]+b,a in Sa)return a}function Ua(a,b,c){var d=_.exec(b);return d?Math.max(0,d[2]-(c||0))+(d[3]||\"px\"):b}function Va(a,b,c,d,e){for(var f=c===(d?\"border\":\"content\")?4:\"width\"===b?1:0,g=0;f<4;f+=2)\"margin\"===c&&(g+=r.css(a,c+aa[f],!0,e)),d?(\"content\"===c&&(g-=r.css(a,\"padding\"+aa[f],!0,e)),\"margin\"!==c&&(g-=r.css(a,\"border\"+aa[f]+\"Width\",!0,e))):(g+=r.css(a,\"padding\"+aa[f],!0,e),\"padding\"!==c&&(g+=r.css(a,\"border\"+aa[f]+\"Width\",!0,e)));return g}function Wa(a,b,c){var d,e=!0,f=La(a),g=\"border-box\"===r.css(a,\"boxSizing\",!1,f);if(a.getClientRects().length&&(d=a.getBoundingClientRect()[b]),d<=0||null==d){if(d=Ma(a,b,f),(d<0||null==d)&&(d=a.style[b]),Ka.test(d))return d;e=g&&(o.boxSizingReliable()||d===a.style[b]),d=parseFloat(d)||0}return d+Va(a,b,c||(g?\"border\":\"content\"),e,f)+\"px\"}r.extend({cssHooks:{opacity:{get:function(a,b){if(b){var c=Ma(a,\"opacity\");return\"\"===c?\"1\":c}}}},cssNumber:{animationIterationCount:!0,columnCount:!0,fillOpacity:!0,flexGrow:!0,flexShrink:!0,fontWeight:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,widows:!0,zIndex:!0,zoom:!0},cssProps:{\"float\":\"cssFloat\"},style:function(a,b,c,d){if(a&&3!==a.nodeType&&8!==a.nodeType&&a.style){var e,f,g,h=r.camelCase(b),i=a.style;return b=r.cssProps[h]||(r.cssProps[h]=Ta(h)||h),g=r.cssHooks[b]||r.cssHooks[h],void 0===c?g&&\"get\"in g&&void 0!==(e=g.get(a,!1,d))?e:i[b]:(f=typeof c,\"string\"===f&&(e=_.exec(c))&&e[1]&&(c=da(a,b,e),f=\"number\"),null!=c&&c===c&&(\"number\"===f&&(c+=e&&e[3]||(r.cssNumber[h]?\"\":\"px\")),o.clearCloneStyle||\"\"!==c||0!==b.indexOf(\"background\")||(i[b]=\"inherit\"),g&&\"set\"in g&&void 0===(c=g.set(a,c,d))||(i[b]=c)),void 0)}},css:function(a,b,c,d){var e,f,g,h=r.camelCase(b);return b=r.cssProps[h]||(r.cssProps[h]=Ta(h)||h),g=r.cssHooks[b]||r.cssHooks[h],g&&\"get\"in g&&(e=g.get(a,!0,c)),void 0===e&&(e=Ma(a,b,d)),\"normal\"===e&&b in Qa&&(e=Qa[b]),\"\"===c||c?(f=parseFloat(e),c===!0||isFinite(f)?f||0:e):e}}),r.each([\"height\",\"width\"],function(a,b){r.cssHooks[b]={get:function(a,c,d){if(c)return!Oa.test(r.css(a,\"display\"))||a.getClientRects().length&&a.getBoundingClientRect().width?Wa(a,b,d):ca(a,Pa,function(){return Wa(a,b,d)})},set:function(a,c,d){var e,f=d&&La(a),g=d&&Va(a,b,d,\"border-box\"===r.css(a,\"boxSizing\",!1,f),f);return g&&(e=_.exec(c))&&\"px\"!==(e[3]||\"px\")&&(a.style[b]=c,c=r.css(a,b)),Ua(a,c,g)}}}),r.cssHooks.marginLeft=Na(o.reliableMarginLeft,function(a,b){if(b)return(parseFloat(Ma(a,\"marginLeft\"))||a.getBoundingClientRect().left-ca(a,{marginLeft:0},function(){return a.getBoundingClientRect().left}))+\"px\"}),r.each({margin:\"\",padding:\"\",border:\"Width\"},function(a,b){r.cssHooks[a+b]={expand:function(c){for(var d=0,e={},f=\"string\"==typeof c?c.split(\" \"):[c];d<4;d++)e[a+aa[d]+b]=f[d]||f[d-2]||f[0];return e}},Ja.test(a)||(r.cssHooks[a+b].set=Ua)}),r.fn.extend({css:function(a,b){return S(this,function(a,b,c){var d,e,f={},g=0;if(r.isArray(b)){for(d=La(a),e=b.length;g<e;g++)f[b[g]]=r.css(a,b[g],!1,d);return f}return void 0!==c?r.style(a,b,c):r.css(a,b)},a,b,arguments.length>1)}});function Xa(a,b,c,d,e){return new Xa.prototype.init(a,b,c,d,e)}r.Tween=Xa,Xa.prototype={constructor:Xa,init:function(a,b,c,d,e,f){this.elem=a,this.prop=c,this.easing=e||r.easing._default,this.options=b,this.start=this.now=this.cur(),this.end=d,this.unit=f||(r.cssNumber[c]?\"\":\"px\")},cur:function(){var a=Xa.propHooks[this.prop];return a&&a.get?a.get(this):Xa.propHooks._default.get(this)},run:function(a){var b,c=Xa.propHooks[this.prop];return this.options.duration?this.pos=b=r.easing[this.easing](a,this.options.duration*a,0,1,this.options.duration):this.pos=b=a,this.now=(this.end-this.start)*b+this.start,this.options.step&&this.options.step.call(this.elem,this.now,this),c&&c.set?c.set(this):Xa.propHooks._default.set(this),this}},Xa.prototype.init.prototype=Xa.prototype,Xa.propHooks={_default:{get:function(a){var b;return 1!==a.elem.nodeType||null!=a.elem[a.prop]&&null==a.elem.style[a.prop]?a.elem[a.prop]:(b=r.css(a.elem,a.prop,\"\"),b&&\"auto\"!==b?b:0)},set:function(a){r.fx.step[a.prop]?r.fx.step[a.prop](a):1!==a.elem.nodeType||null==a.elem.style[r.cssProps[a.prop]]&&!r.cssHooks[a.prop]?a.elem[a.prop]=a.now:r.style(a.elem,a.prop,a.now+a.unit)}}},Xa.propHooks.scrollTop=Xa.propHooks.scrollLeft={set:function(a){a.elem.nodeType&&a.elem.parentNode&&(a.elem[a.prop]=a.now)}},r.easing={linear:function(a){return a},swing:function(a){return.5-Math.cos(a*Math.PI)/2},_default:\"swing\"},r.fx=Xa.prototype.init,r.fx.step={};var Ya,Za,$a=/^(?:toggle|show|hide)$/,_a=/queueHooks$/;function ab(){Za&&(a.requestAnimationFrame(ab),r.fx.tick())}function bb(){return a.setTimeout(function(){Ya=void 0}),Ya=r.now()}function cb(a,b){var c,d=0,e={height:a};for(b=b?1:0;d<4;d+=2-b)c=aa[d],e[\"margin\"+c]=e[\"padding\"+c]=a;return b&&(e.opacity=e.width=a),e}function db(a,b,c){for(var d,e=(gb.tweeners[b]||[]).concat(gb.tweeners[\"*\"]),f=0,g=e.length;f<g;f++)if(d=e[f].call(c,b,a))return d}function eb(a,b,c){var d,e,f,g,h,i,j,k,l=\"width\"in b||\"height\"in b,m=this,n={},o=a.style,p=a.nodeType&&ba(a),q=V.get(a,\"fxshow\");c.queue||(g=r._queueHooks(a,\"fx\"),null==g.unqueued&&(g.unqueued=0,h=g.empty.fire,g.empty.fire=function(){g.unqueued||h()}),g.unqueued++,m.always(function(){m.always(function(){g.unqueued--,r.queue(a,\"fx\").length||g.empty.fire()})}));for(d in b)if(e=b[d],$a.test(e)){if(delete b[d],f=f||\"toggle\"===e,e===(p?\"hide\":\"show\")){if(\"show\"!==e||!q||void 0===q[d])continue;p=!0}n[d]=q&&q[d]||r.style(a,d)}if(i=!r.isEmptyObject(b),i||!r.isEmptyObject(n)){l&&1===a.nodeType&&(c.overflow=[o.overflow,o.overflowX,o.overflowY],j=q&&q.display,null==j&&(j=V.get(a,\"display\")),k=r.css(a,\"display\"),\"none\"===k&&(j?k=j:(ga([a],!0),j=a.style.display||j,k=r.css(a,\"display\"),ga([a]))),(\"inline\"===k||\"inline-block\"===k&&null!=j)&&\"none\"===r.css(a,\"float\")&&(i||(m.done(function(){o.display=j}),null==j&&(k=o.display,j=\"none\"===k?\"\":k)),o.display=\"inline-block\")),c.overflow&&(o.overflow=\"hidden\",m.always(function(){o.overflow=c.overflow[0],o.overflowX=c.overflow[1],o.overflowY=c.overflow[2]})),i=!1;for(d in n)i||(q?\"hidden\"in q&&(p=q.hidden):q=V.access(a,\"fxshow\",{display:j}),f&&(q.hidden=!p),p&&ga([a],!0),m.done(function(){p||ga([a]),V.remove(a,\"fxshow\");for(d in n)r.style(a,d,n[d])})),i=db(p?q[d]:0,d,m),d in q||(q[d]=i.start,p&&(i.end=i.start,i.start=0))}}function fb(a,b){var c,d,e,f,g;for(c in a)if(d=r.camelCase(c),e=b[d],f=a[c],r.isArray(f)&&(e=f[1],f=a[c]=f[0]),c!==d&&(a[d]=f,delete a[c]),g=r.cssHooks[d],g&&\"expand\"in g){f=g.expand(f),delete a[d];for(c in f)c in a||(a[c]=f[c],b[c]=e)}else b[d]=e}function gb(a,b,c){var d,e,f=0,g=gb.prefilters.length,h=r.Deferred().always(function(){delete i.elem}),i=function(){if(e)return!1;for(var b=Ya||bb(),c=Math.max(0,j.startTime+j.duration-b),d=c/j.duration||0,f=1-d,g=0,i=j.tweens.length;g<i;g++)j.tweens[g].run(f);return h.notifyWith(a,[j,f,c]),f<1&&i?c:(h.resolveWith(a,[j]),!1)},j=h.promise({elem:a,props:r.extend({},b),opts:r.extend(!0,{specialEasing:{},easing:r.easing._default},c),originalProperties:b,originalOptions:c,startTime:Ya||bb(),duration:c.duration,tweens:[],createTween:function(b,c){var d=r.Tween(a,j.opts,b,c,j.opts.specialEasing[b]||j.opts.easing);return j.tweens.push(d),d},stop:function(b){var c=0,d=b?j.tweens.length:0;if(e)return this;for(e=!0;c<d;c++)j.tweens[c].run(1);return b?(h.notifyWith(a,[j,1,0]),h.resolveWith(a,[j,b])):h.rejectWith(a,[j,b]),this}}),k=j.props;for(fb(k,j.opts.specialEasing);f<g;f++)if(d=gb.prefilters[f].call(j,a,k,j.opts))return r.isFunction(d.stop)&&(r._queueHooks(j.elem,j.opts.queue).stop=r.proxy(d.stop,d)),d;return r.map(k,db,j),r.isFunction(j.opts.start)&&j.opts.start.call(a,j),r.fx.timer(r.extend(i,{elem:a,anim:j,queue:j.opts.queue})),j.progress(j.opts.progress).done(j.opts.done,j.opts.complete).fail(j.opts.fail).always(j.opts.always)}r.Animation=r.extend(gb,{tweeners:{\"*\":[function(a,b){var c=this.createTween(a,b);return da(c.elem,a,_.exec(b),c),c}]},tweener:function(a,b){r.isFunction(a)?(b=a,a=[\"*\"]):a=a.match(K);for(var c,d=0,e=a.length;d<e;d++)c=a[d],gb.tweeners[c]=gb.tweeners[c]||[],gb.tweeners[c].unshift(b)},prefilters:[eb],prefilter:function(a,b){b?gb.prefilters.unshift(a):gb.prefilters.push(a)}}),r.speed=function(a,b,c){var e=a&&\"object\"==typeof a?r.extend({},a):{complete:c||!c&&b||r.isFunction(a)&&a,duration:a,easing:c&&b||b&&!r.isFunction(b)&&b};return r.fx.off||d.hidden?e.duration=0:e.duration=\"number\"==typeof e.duration?e.duration:e.duration in r.fx.speeds?r.fx.speeds[e.duration]:r.fx.speeds._default,null!=e.queue&&e.queue!==!0||(e.queue=\"fx\"),e.old=e.complete,e.complete=function(){r.isFunction(e.old)&&e.old.call(this),e.queue&&r.dequeue(this,e.queue)},e},r.fn.extend({fadeTo:function(a,b,c,d){return this.filter(ba).css(\"opacity\",0).show().end().animate({opacity:b},a,c,d)},animate:function(a,b,c,d){var e=r.isEmptyObject(a),f=r.speed(b,c,d),g=function(){var b=gb(this,r.extend({},a),f);(e||V.get(this,\"finish\"))&&b.stop(!0)};return g.finish=g,e||f.queue===!1?this.each(g):this.queue(f.queue,g)},stop:function(a,b,c){var d=function(a){var b=a.stop;delete a.stop,b(c)};return\"string\"!=typeof a&&(c=b,b=a,a=void 0),b&&a!==!1&&this.queue(a||\"fx\",[]),this.each(function(){var b=!0,e=null!=a&&a+\"queueHooks\",f=r.timers,g=V.get(this);if(e)g[e]&&g[e].stop&&d(g[e]);else for(e in g)g[e]&&g[e].stop&&_a.test(e)&&d(g[e]);for(e=f.length;e--;)f[e].elem!==this||null!=a&&f[e].queue!==a||(f[e].anim.stop(c),b=!1,f.splice(e,1));!b&&c||r.dequeue(this,a)})},finish:function(a){return a!==!1&&(a=a||\"fx\"),this.each(function(){var b,c=V.get(this),d=c[a+\"queue\"],e=c[a+\"queueHooks\"],f=r.timers,g=d?d.length:0;for(c.finish=!0,r.queue(this,a,[]),e&&e.stop&&e.stop.call(this,!0),b=f.length;b--;)f[b].elem===this&&f[b].queue===a&&(f[b].anim.stop(!0),f.splice(b,1));for(b=0;b<g;b++)d[b]&&d[b].finish&&d[b].finish.call(this);delete c.finish})}}),r.each([\"toggle\",\"show\",\"hide\"],function(a,b){var c=r.fn[b];r.fn[b]=function(a,d,e){return null==a||\"boolean\"==typeof a?c.apply(this,arguments):this.animate(cb(b,!0),a,d,e)}}),r.each({slideDown:cb(\"show\"),slideUp:cb(\"hide\"),slideToggle:cb(\"toggle\"),fadeIn:{opacity:\"show\"},fadeOut:{opacity:\"hide\"},fadeToggle:{opacity:\"toggle\"}},function(a,b){r.fn[a]=function(a,c,d){return this.animate(b,a,c,d)}}),r.timers=[],r.fx.tick=function(){var a,b=0,c=r.timers;for(Ya=r.now();b<c.length;b++)a=c[b],a()||c[b]!==a||c.splice(b--,1);c.length||r.fx.stop(),Ya=void 0},r.fx.timer=function(a){r.timers.push(a),a()?r.fx.start():r.timers.pop()},r.fx.interval=13,r.fx.start=function(){Za||(Za=a.requestAnimationFrame?a.requestAnimationFrame(ab):a.setInterval(r.fx.tick,r.fx.interval))},r.fx.stop=function(){a.cancelAnimationFrame?a.cancelAnimationFrame(Za):a.clearInterval(Za),Za=null},r.fx.speeds={slow:600,fast:200,_default:400},r.fn.delay=function(b,c){return b=r.fx?r.fx.speeds[b]||b:b,c=c||\"fx\",this.queue(c,function(c,d){var e=a.setTimeout(c,b);d.stop=function(){a.clearTimeout(e)}})},function(){var a=d.createElement(\"input\"),b=d.createElement(\"select\"),c=b.appendChild(d.createElement(\"option\"));a.type=\"checkbox\",o.checkOn=\"\"!==a.value,o.optSelected=c.selected,a=d.createElement(\"input\"),a.value=\"t\",a.type=\"radio\",o.radioValue=\"t\"===a.value}();var hb,ib=r.expr.attrHandle;r.fn.extend({attr:function(a,b){return S(this,r.attr,a,b,arguments.length>1)},removeAttr:function(a){return this.each(function(){r.removeAttr(this,a)})}}),r.extend({attr:function(a,b,c){var d,e,f=a.nodeType;if(3!==f&&8!==f&&2!==f)return\"undefined\"==typeof a.getAttribute?r.prop(a,b,c):(1===f&&r.isXMLDoc(a)||(e=r.attrHooks[b.toLowerCase()]||(r.expr.match.bool.test(b)?hb:void 0)),void 0!==c?null===c?void r.removeAttr(a,b):e&&\"set\"in e&&void 0!==(d=e.set(a,c,b))?d:(a.setAttribute(b,c+\"\"),c):e&&\"get\"in e&&null!==(d=e.get(a,b))?d:(d=r.find.attr(a,b),null==d?void 0:d))},attrHooks:{type:{set:function(a,b){if(!o.radioValue&&\"radio\"===b&&r.nodeName(a,\"input\")){var c=a.value;return a.setAttribute(\"type\",b),c&&(a.value=c),b}}}},removeAttr:function(a,b){var c,d=0,e=b&&b.match(K);\nif(e&&1===a.nodeType)while(c=e[d++])a.removeAttribute(c)}}),hb={set:function(a,b,c){return b===!1?r.removeAttr(a,c):a.setAttribute(c,c),c}},r.each(r.expr.match.bool.source.match(/\\w+/g),function(a,b){var c=ib[b]||r.find.attr;ib[b]=function(a,b,d){var e,f,g=b.toLowerCase();return d||(f=ib[g],ib[g]=e,e=null!=c(a,b,d)?g:null,ib[g]=f),e}});var jb=/^(?:input|select|textarea|button)$/i,kb=/^(?:a|area)$/i;r.fn.extend({prop:function(a,b){return S(this,r.prop,a,b,arguments.length>1)},removeProp:function(a){return this.each(function(){delete this[r.propFix[a]||a]})}}),r.extend({prop:function(a,b,c){var d,e,f=a.nodeType;if(3!==f&&8!==f&&2!==f)return 1===f&&r.isXMLDoc(a)||(b=r.propFix[b]||b,e=r.propHooks[b]),void 0!==c?e&&\"set\"in e&&void 0!==(d=e.set(a,c,b))?d:a[b]=c:e&&\"get\"in e&&null!==(d=e.get(a,b))?d:a[b]},propHooks:{tabIndex:{get:function(a){var b=r.find.attr(a,\"tabindex\");return b?parseInt(b,10):jb.test(a.nodeName)||kb.test(a.nodeName)&&a.href?0:-1}}},propFix:{\"for\":\"htmlFor\",\"class\":\"className\"}}),o.optSelected||(r.propHooks.selected={get:function(a){var b=a.parentNode;return b&&b.parentNode&&b.parentNode.selectedIndex,null},set:function(a){var b=a.parentNode;b&&(b.selectedIndex,b.parentNode&&b.parentNode.selectedIndex)}}),r.each([\"tabIndex\",\"readOnly\",\"maxLength\",\"cellSpacing\",\"cellPadding\",\"rowSpan\",\"colSpan\",\"useMap\",\"frameBorder\",\"contentEditable\"],function(){r.propFix[this.toLowerCase()]=this});var lb=/[\\t\\r\\n\\f]/g;function mb(a){return a.getAttribute&&a.getAttribute(\"class\")||\"\"}r.fn.extend({addClass:function(a){var b,c,d,e,f,g,h,i=0;if(r.isFunction(a))return this.each(function(b){r(this).addClass(a.call(this,b,mb(this)))});if(\"string\"==typeof a&&a){b=a.match(K)||[];while(c=this[i++])if(e=mb(c),d=1===c.nodeType&&(\" \"+e+\" \").replace(lb,\" \")){g=0;while(f=b[g++])d.indexOf(\" \"+f+\" \")<0&&(d+=f+\" \");h=r.trim(d),e!==h&&c.setAttribute(\"class\",h)}}return this},removeClass:function(a){var b,c,d,e,f,g,h,i=0;if(r.isFunction(a))return this.each(function(b){r(this).removeClass(a.call(this,b,mb(this)))});if(!arguments.length)return this.attr(\"class\",\"\");if(\"string\"==typeof a&&a){b=a.match(K)||[];while(c=this[i++])if(e=mb(c),d=1===c.nodeType&&(\" \"+e+\" \").replace(lb,\" \")){g=0;while(f=b[g++])while(d.indexOf(\" \"+f+\" \")>-1)d=d.replace(\" \"+f+\" \",\" \");h=r.trim(d),e!==h&&c.setAttribute(\"class\",h)}}return this},toggleClass:function(a,b){var c=typeof a;return\"boolean\"==typeof b&&\"string\"===c?b?this.addClass(a):this.removeClass(a):r.isFunction(a)?this.each(function(c){r(this).toggleClass(a.call(this,c,mb(this),b),b)}):this.each(function(){var b,d,e,f;if(\"string\"===c){d=0,e=r(this),f=a.match(K)||[];while(b=f[d++])e.hasClass(b)?e.removeClass(b):e.addClass(b)}else void 0!==a&&\"boolean\"!==c||(b=mb(this),b&&V.set(this,\"__className__\",b),this.setAttribute&&this.setAttribute(\"class\",b||a===!1?\"\":V.get(this,\"__className__\")||\"\"))})},hasClass:function(a){var b,c,d=0;b=\" \"+a+\" \";while(c=this[d++])if(1===c.nodeType&&(\" \"+mb(c)+\" \").replace(lb,\" \").indexOf(b)>-1)return!0;return!1}});var nb=/\\r/g,ob=/[\\x20\\t\\r\\n\\f]+/g;r.fn.extend({val:function(a){var b,c,d,e=this[0];{if(arguments.length)return d=r.isFunction(a),this.each(function(c){var e;1===this.nodeType&&(e=d?a.call(this,c,r(this).val()):a,null==e?e=\"\":\"number\"==typeof e?e+=\"\":r.isArray(e)&&(e=r.map(e,function(a){return null==a?\"\":a+\"\"})),b=r.valHooks[this.type]||r.valHooks[this.nodeName.toLowerCase()],b&&\"set\"in b&&void 0!==b.set(this,e,\"value\")||(this.value=e))});if(e)return b=r.valHooks[e.type]||r.valHooks[e.nodeName.toLowerCase()],b&&\"get\"in b&&void 0!==(c=b.get(e,\"value\"))?c:(c=e.value,\"string\"==typeof c?c.replace(nb,\"\"):null==c?\"\":c)}}}),r.extend({valHooks:{option:{get:function(a){var b=r.find.attr(a,\"value\");return null!=b?b:r.trim(r.text(a)).replace(ob,\" \")}},select:{get:function(a){for(var b,c,d=a.options,e=a.selectedIndex,f=\"select-one\"===a.type,g=f?null:[],h=f?e+1:d.length,i=e<0?h:f?e:0;i<h;i++)if(c=d[i],(c.selected||i===e)&&!c.disabled&&(!c.parentNode.disabled||!r.nodeName(c.parentNode,\"optgroup\"))){if(b=r(c).val(),f)return b;g.push(b)}return g},set:function(a,b){var c,d,e=a.options,f=r.makeArray(b),g=e.length;while(g--)d=e[g],(d.selected=r.inArray(r.valHooks.option.get(d),f)>-1)&&(c=!0);return c||(a.selectedIndex=-1),f}}}}),r.each([\"radio\",\"checkbox\"],function(){r.valHooks[this]={set:function(a,b){if(r.isArray(b))return a.checked=r.inArray(r(a).val(),b)>-1}},o.checkOn||(r.valHooks[this].get=function(a){return null===a.getAttribute(\"value\")?\"on\":a.value})});var pb=/^(?:focusinfocus|focusoutblur)$/;r.extend(r.event,{trigger:function(b,c,e,f){var g,h,i,j,k,m,n,o=[e||d],p=l.call(b,\"type\")?b.type:b,q=l.call(b,\"namespace\")?b.namespace.split(\".\"):[];if(h=i=e=e||d,3!==e.nodeType&&8!==e.nodeType&&!pb.test(p+r.event.triggered)&&(p.indexOf(\".\")>-1&&(q=p.split(\".\"),p=q.shift(),q.sort()),k=p.indexOf(\":\")<0&&\"on\"+p,b=b[r.expando]?b:new r.Event(p,\"object\"==typeof b&&b),b.isTrigger=f?2:3,b.namespace=q.join(\".\"),b.rnamespace=b.namespace?new RegExp(\"(^|\\\\.)\"+q.join(\"\\\\.(?:.*\\\\.|)\")+\"(\\\\.|$)\"):null,b.result=void 0,b.target||(b.target=e),c=null==c?[b]:r.makeArray(c,[b]),n=r.event.special[p]||{},f||!n.trigger||n.trigger.apply(e,c)!==!1)){if(!f&&!n.noBubble&&!r.isWindow(e)){for(j=n.delegateType||p,pb.test(j+p)||(h=h.parentNode);h;h=h.parentNode)o.push(h),i=h;i===(e.ownerDocument||d)&&o.push(i.defaultView||i.parentWindow||a)}g=0;while((h=o[g++])&&!b.isPropagationStopped())b.type=g>1?j:n.bindType||p,m=(V.get(h,\"events\")||{})[b.type]&&V.get(h,\"handle\"),m&&m.apply(h,c),m=k&&h[k],m&&m.apply&&T(h)&&(b.result=m.apply(h,c),b.result===!1&&b.preventDefault());return b.type=p,f||b.isDefaultPrevented()||n._default&&n._default.apply(o.pop(),c)!==!1||!T(e)||k&&r.isFunction(e[p])&&!r.isWindow(e)&&(i=e[k],i&&(e[k]=null),r.event.triggered=p,e[p](),r.event.triggered=void 0,i&&(e[k]=i)),b.result}},simulate:function(a,b,c){var d=r.extend(new r.Event,c,{type:a,isSimulated:!0});r.event.trigger(d,null,b)}}),r.fn.extend({trigger:function(a,b){return this.each(function(){r.event.trigger(a,b,this)})},triggerHandler:function(a,b){var c=this[0];if(c)return r.event.trigger(a,b,c,!0)}}),r.each(\"blur focus focusin focusout resize scroll click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup contextmenu\".split(\" \"),function(a,b){r.fn[b]=function(a,c){return arguments.length>0?this.on(b,null,a,c):this.trigger(b)}}),r.fn.extend({hover:function(a,b){return this.mouseenter(a).mouseleave(b||a)}}),o.focusin=\"onfocusin\"in a,o.focusin||r.each({focus:\"focusin\",blur:\"focusout\"},function(a,b){var c=function(a){r.event.simulate(b,a.target,r.event.fix(a))};r.event.special[b]={setup:function(){var d=this.ownerDocument||this,e=V.access(d,b);e||d.addEventListener(a,c,!0),V.access(d,b,(e||0)+1)},teardown:function(){var d=this.ownerDocument||this,e=V.access(d,b)-1;e?V.access(d,b,e):(d.removeEventListener(a,c,!0),V.remove(d,b))}}});var qb=a.location,rb=r.now(),sb=/\\?/;r.parseXML=function(b){var c;if(!b||\"string\"!=typeof b)return null;try{c=(new a.DOMParser).parseFromString(b,\"text/xml\")}catch(d){c=void 0}return c&&!c.getElementsByTagName(\"parsererror\").length||r.error(\"Invalid XML: \"+b),c};var tb=/\\[\\]$/,ub=/\\r?\\n/g,vb=/^(?:submit|button|image|reset|file)$/i,wb=/^(?:input|select|textarea|keygen)/i;function xb(a,b,c,d){var e;if(r.isArray(b))r.each(b,function(b,e){c||tb.test(a)?d(a,e):xb(a+\"[\"+(\"object\"==typeof e&&null!=e?b:\"\")+\"]\",e,c,d)});else if(c||\"object\"!==r.type(b))d(a,b);else for(e in b)xb(a+\"[\"+e+\"]\",b[e],c,d)}r.param=function(a,b){var c,d=[],e=function(a,b){var c=r.isFunction(b)?b():b;d[d.length]=encodeURIComponent(a)+\"=\"+encodeURIComponent(null==c?\"\":c)};if(r.isArray(a)||a.jquery&&!r.isPlainObject(a))r.each(a,function(){e(this.name,this.value)});else for(c in a)xb(c,a[c],b,e);return d.join(\"&\")},r.fn.extend({serialize:function(){return r.param(this.serializeArray())},serializeArray:function(){return this.map(function(){var a=r.prop(this,\"elements\");return a?r.makeArray(a):this}).filter(function(){var a=this.type;return this.name&&!r(this).is(\":disabled\")&&wb.test(this.nodeName)&&!vb.test(a)&&(this.checked||!ha.test(a))}).map(function(a,b){var c=r(this).val();return null==c?null:r.isArray(c)?r.map(c,function(a){return{name:b.name,value:a.replace(ub,\"\\r\\n\")}}):{name:b.name,value:c.replace(ub,\"\\r\\n\")}}).get()}});var yb=/%20/g,zb=/#.*$/,Ab=/([?&])_=[^&]*/,Bb=/^(.*?):[ \\t]*([^\\r\\n]*)$/gm,Cb=/^(?:about|app|app-storage|.+-extension|file|res|widget):$/,Db=/^(?:GET|HEAD)$/,Eb=/^\\/\\//,Fb={},Gb={},Hb=\"*/\".concat(\"*\"),Ib=d.createElement(\"a\");Ib.href=qb.href;function Jb(a){return function(b,c){\"string\"!=typeof b&&(c=b,b=\"*\");var d,e=0,f=b.toLowerCase().match(K)||[];if(r.isFunction(c))while(d=f[e++])\"+\"===d[0]?(d=d.slice(1)||\"*\",(a[d]=a[d]||[]).unshift(c)):(a[d]=a[d]||[]).push(c)}}function Kb(a,b,c,d){var e={},f=a===Gb;function g(h){var i;return e[h]=!0,r.each(a[h]||[],function(a,h){var j=h(b,c,d);return\"string\"!=typeof j||f||e[j]?f?!(i=j):void 0:(b.dataTypes.unshift(j),g(j),!1)}),i}return g(b.dataTypes[0])||!e[\"*\"]&&g(\"*\")}function Lb(a,b){var c,d,e=r.ajaxSettings.flatOptions||{};for(c in b)void 0!==b[c]&&((e[c]?a:d||(d={}))[c]=b[c]);return d&&r.extend(!0,a,d),a}function Mb(a,b,c){var d,e,f,g,h=a.contents,i=a.dataTypes;while(\"*\"===i[0])i.shift(),void 0===d&&(d=a.mimeType||b.getResponseHeader(\"Content-Type\"));if(d)for(e in h)if(h[e]&&h[e].test(d)){i.unshift(e);break}if(i[0]in c)f=i[0];else{for(e in c){if(!i[0]||a.converters[e+\" \"+i[0]]){f=e;break}g||(g=e)}f=f||g}if(f)return f!==i[0]&&i.unshift(f),c[f]}function Nb(a,b,c,d){var e,f,g,h,i,j={},k=a.dataTypes.slice();if(k[1])for(g in a.converters)j[g.toLowerCase()]=a.converters[g];f=k.shift();while(f)if(a.responseFields[f]&&(c[a.responseFields[f]]=b),!i&&d&&a.dataFilter&&(b=a.dataFilter(b,a.dataType)),i=f,f=k.shift())if(\"*\"===f)f=i;else if(\"*\"!==i&&i!==f){if(g=j[i+\" \"+f]||j[\"* \"+f],!g)for(e in j)if(h=e.split(\" \"),h[1]===f&&(g=j[i+\" \"+h[0]]||j[\"* \"+h[0]])){g===!0?g=j[e]:j[e]!==!0&&(f=h[0],k.unshift(h[1]));break}if(g!==!0)if(g&&a[\"throws\"])b=g(b);else try{b=g(b)}catch(l){return{state:\"parsererror\",error:g?l:\"No conversion from \"+i+\" to \"+f}}}return{state:\"success\",data:b}}r.extend({active:0,lastModified:{},etag:{},ajaxSettings:{url:qb.href,type:\"GET\",isLocal:Cb.test(qb.protocol),global:!0,processData:!0,async:!0,contentType:\"application/x-www-form-urlencoded; charset=UTF-8\",accepts:{\"*\":Hb,text:\"text/plain\",html:\"text/html\",xml:\"application/xml, text/xml\",json:\"application/json, text/javascript\"},contents:{xml:/\\bxml\\b/,html:/\\bhtml/,json:/\\bjson\\b/},responseFields:{xml:\"responseXML\",text:\"responseText\",json:\"responseJSON\"},converters:{\"* text\":String,\"text html\":!0,\"text json\":JSON.parse,\"text xml\":r.parseXML},flatOptions:{url:!0,context:!0}},ajaxSetup:function(a,b){return b?Lb(Lb(a,r.ajaxSettings),b):Lb(r.ajaxSettings,a)},ajaxPrefilter:Jb(Fb),ajaxTransport:Jb(Gb),ajax:function(b,c){\"object\"==typeof b&&(c=b,b=void 0),c=c||{};var e,f,g,h,i,j,k,l,m,n,o=r.ajaxSetup({},c),p=o.context||o,q=o.context&&(p.nodeType||p.jquery)?r(p):r.event,s=r.Deferred(),t=r.Callbacks(\"once memory\"),u=o.statusCode||{},v={},w={},x=\"canceled\",y={readyState:0,getResponseHeader:function(a){var b;if(k){if(!h){h={};while(b=Bb.exec(g))h[b[1].toLowerCase()]=b[2]}b=h[a.toLowerCase()]}return null==b?null:b},getAllResponseHeaders:function(){return k?g:null},setRequestHeader:function(a,b){return null==k&&(a=w[a.toLowerCase()]=w[a.toLowerCase()]||a,v[a]=b),this},overrideMimeType:function(a){return null==k&&(o.mimeType=a),this},statusCode:function(a){var b;if(a)if(k)y.always(a[y.status]);else for(b in a)u[b]=[u[b],a[b]];return this},abort:function(a){var b=a||x;return e&&e.abort(b),A(0,b),this}};if(s.promise(y),o.url=((b||o.url||qb.href)+\"\").replace(Eb,qb.protocol+\"//\"),o.type=c.method||c.type||o.method||o.type,o.dataTypes=(o.dataType||\"*\").toLowerCase().match(K)||[\"\"],null==o.crossDomain){j=d.createElement(\"a\");try{j.href=o.url,j.href=j.href,o.crossDomain=Ib.protocol+\"//\"+Ib.host!=j.protocol+\"//\"+j.host}catch(z){o.crossDomain=!0}}if(o.data&&o.processData&&\"string\"!=typeof o.data&&(o.data=r.param(o.data,o.traditional)),Kb(Fb,o,c,y),k)return y;l=r.event&&o.global,l&&0===r.active++&&r.event.trigger(\"ajaxStart\"),o.type=o.type.toUpperCase(),o.hasContent=!Db.test(o.type),f=o.url.replace(zb,\"\"),o.hasContent?o.data&&o.processData&&0===(o.contentType||\"\").indexOf(\"application/x-www-form-urlencoded\")&&(o.data=o.data.replace(yb,\"+\")):(n=o.url.slice(f.length),o.data&&(f+=(sb.test(f)?\"&\":\"?\")+o.data,delete o.data),o.cache===!1&&(f=f.replace(Ab,\"\"),n=(sb.test(f)?\"&\":\"?\")+\"_=\"+rb++ +n),o.url=f+n),o.ifModified&&(r.lastModified[f]&&y.setRequestHeader(\"If-Modified-Since\",r.lastModified[f]),r.etag[f]&&y.setRequestHeader(\"If-None-Match\",r.etag[f])),(o.data&&o.hasContent&&o.contentType!==!1||c.contentType)&&y.setRequestHeader(\"Content-Type\",o.contentType),y.setRequestHeader(\"Accept\",o.dataTypes[0]&&o.accepts[o.dataTypes[0]]?o.accepts[o.dataTypes[0]]+(\"*\"!==o.dataTypes[0]?\", \"+Hb+\"; q=0.01\":\"\"):o.accepts[\"*\"]);for(m in o.headers)y.setRequestHeader(m,o.headers[m]);if(o.beforeSend&&(o.beforeSend.call(p,y,o)===!1||k))return y.abort();if(x=\"abort\",t.add(o.complete),y.done(o.success),y.fail(o.error),e=Kb(Gb,o,c,y)){if(y.readyState=1,l&&q.trigger(\"ajaxSend\",[y,o]),k)return y;o.async&&o.timeout>0&&(i=a.setTimeout(function(){y.abort(\"timeout\")},o.timeout));try{k=!1,e.send(v,A)}catch(z){if(k)throw z;A(-1,z)}}else A(-1,\"No Transport\");function A(b,c,d,h){var j,m,n,v,w,x=c;k||(k=!0,i&&a.clearTimeout(i),e=void 0,g=h||\"\",y.readyState=b>0?4:0,j=b>=200&&b<300||304===b,d&&(v=Mb(o,y,d)),v=Nb(o,v,y,j),j?(o.ifModified&&(w=y.getResponseHeader(\"Last-Modified\"),w&&(r.lastModified[f]=w),w=y.getResponseHeader(\"etag\"),w&&(r.etag[f]=w)),204===b||\"HEAD\"===o.type?x=\"nocontent\":304===b?x=\"notmodified\":(x=v.state,m=v.data,n=v.error,j=!n)):(n=x,!b&&x||(x=\"error\",b<0&&(b=0))),y.status=b,y.statusText=(c||x)+\"\",j?s.resolveWith(p,[m,x,y]):s.rejectWith(p,[y,x,n]),y.statusCode(u),u=void 0,l&&q.trigger(j?\"ajaxSuccess\":\"ajaxError\",[y,o,j?m:n]),t.fireWith(p,[y,x]),l&&(q.trigger(\"ajaxComplete\",[y,o]),--r.active||r.event.trigger(\"ajaxStop\")))}return y},getJSON:function(a,b,c){return r.get(a,b,c,\"json\")},getScript:function(a,b){return r.get(a,void 0,b,\"script\")}}),r.each([\"get\",\"post\"],function(a,b){r[b]=function(a,c,d,e){return r.isFunction(c)&&(e=e||d,d=c,c=void 0),r.ajax(r.extend({url:a,type:b,dataType:e,data:c,success:d},r.isPlainObject(a)&&a))}}),r._evalUrl=function(a){return r.ajax({url:a,type:\"GET\",dataType:\"script\",cache:!0,async:!1,global:!1,\"throws\":!0})},r.fn.extend({wrapAll:function(a){var b;return this[0]&&(r.isFunction(a)&&(a=a.call(this[0])),b=r(a,this[0].ownerDocument).eq(0).clone(!0),this[0].parentNode&&b.insertBefore(this[0]),b.map(function(){var a=this;while(a.firstElementChild)a=a.firstElementChild;return a}).append(this)),this},wrapInner:function(a){return r.isFunction(a)?this.each(function(b){r(this).wrapInner(a.call(this,b))}):this.each(function(){var b=r(this),c=b.contents();c.length?c.wrapAll(a):b.append(a)})},wrap:function(a){var b=r.isFunction(a);return this.each(function(c){r(this).wrapAll(b?a.call(this,c):a)})},unwrap:function(a){return this.parent(a).not(\"body\").each(function(){r(this).replaceWith(this.childNodes)}),this}}),r.expr.pseudos.hidden=function(a){return!r.expr.pseudos.visible(a)},r.expr.pseudos.visible=function(a){return!!(a.offsetWidth||a.offsetHeight||a.getClientRects().length)},r.ajaxSettings.xhr=function(){try{return new a.XMLHttpRequest}catch(b){}};var Ob={0:200,1223:204},Pb=r.ajaxSettings.xhr();o.cors=!!Pb&&\"withCredentials\"in Pb,o.ajax=Pb=!!Pb,r.ajaxTransport(function(b){var c,d;if(o.cors||Pb&&!b.crossDomain)return{send:function(e,f){var g,h=b.xhr();if(h.open(b.type,b.url,b.async,b.username,b.password),b.xhrFields)for(g in b.xhrFields)h[g]=b.xhrFields[g];b.mimeType&&h.overrideMimeType&&h.overrideMimeType(b.mimeType),b.crossDomain||e[\"X-Requested-With\"]||(e[\"X-Requested-With\"]=\"XMLHttpRequest\");for(g in e)h.setRequestHeader(g,e[g]);c=function(a){return function(){c&&(c=d=h.onload=h.onerror=h.onabort=h.onreadystatechange=null,\"abort\"===a?h.abort():\"error\"===a?\"number\"!=typeof h.status?f(0,\"error\"):f(h.status,h.statusText):f(Ob[h.status]||h.status,h.statusText,\"text\"!==(h.responseType||\"text\")||\"string\"!=typeof h.responseText?{binary:h.response}:{text:h.responseText},h.getAllResponseHeaders()))}},h.onload=c(),d=h.onerror=c(\"error\"),void 0!==h.onabort?h.onabort=d:h.onreadystatechange=function(){4===h.readyState&&a.setTimeout(function(){c&&d()})},c=c(\"abort\");try{h.send(b.hasContent&&b.data||null)}catch(i){if(c)throw i}},abort:function(){c&&c()}}}),r.ajaxPrefilter(function(a){a.crossDomain&&(a.contents.script=!1)}),r.ajaxSetup({accepts:{script:\"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript\"},contents:{script:/\\b(?:java|ecma)script\\b/},converters:{\"text script\":function(a){return r.globalEval(a),a}}}),r.ajaxPrefilter(\"script\",function(a){void 0===a.cache&&(a.cache=!1),a.crossDomain&&(a.type=\"GET\")}),r.ajaxTransport(\"script\",function(a){if(a.crossDomain){var b,c;return{send:function(e,f){b=r(\"<script>\").prop({charset:a.scriptCharset,src:a.url}).on(\"load error\",c=function(a){b.remove(),c=null,a&&f(\"error\"===a.type?404:200,a.type)}),d.head.appendChild(b[0])},abort:function(){c&&c()}}}});var Qb=[],Rb=/(=)\\?(?=&|$)|\\?\\?/;r.ajaxSetup({jsonp:\"callback\",jsonpCallback:function(){var a=Qb.pop()||r.expando+\"_\"+rb++;return this[a]=!0,a}}),r.ajaxPrefilter(\"json jsonp\",function(b,c,d){var e,f,g,h=b.jsonp!==!1&&(Rb.test(b.url)?\"url\":\"string\"==typeof b.data&&0===(b.contentType||\"\").indexOf(\"application/x-www-form-urlencoded\")&&Rb.test(b.data)&&\"data\");if(h||\"jsonp\"===b.dataTypes[0])return e=b.jsonpCallback=r.isFunction(b.jsonpCallback)?b.jsonpCallback():b.jsonpCallback,h?b[h]=b[h].replace(Rb,\"$1\"+e):b.jsonp!==!1&&(b.url+=(sb.test(b.url)?\"&\":\"?\")+b.jsonp+\"=\"+e),b.converters[\"script json\"]=function(){return g||r.error(e+\" was not called\"),g[0]},b.dataTypes[0]=\"json\",f=a[e],a[e]=function(){g=arguments},d.always(function(){void 0===f?r(a).removeProp(e):a[e]=f,b[e]&&(b.jsonpCallback=c.jsonpCallback,Qb.push(e)),g&&r.isFunction(f)&&f(g[0]),g=f=void 0}),\"script\"}),o.createHTMLDocument=function(){var a=d.implementation.createHTMLDocument(\"\").body;return a.innerHTML=\"<form></form><form></form>\",2===a.childNodes.length}(),r.parseHTML=function(a,b,c){if(\"string\"!=typeof a)return[];\"boolean\"==typeof b&&(c=b,b=!1);var e,f,g;return b||(o.createHTMLDocument?(b=d.implementation.createHTMLDocument(\"\"),e=b.createElement(\"base\"),e.href=d.location.href,b.head.appendChild(e)):b=d),f=B.exec(a),g=!c&&[],f?[b.createElement(f[1])]:(f=oa([a],b,g),g&&g.length&&r(g).remove(),r.merge([],f.childNodes))},r.fn.load=function(a,b,c){var d,e,f,g=this,h=a.indexOf(\" \");return h>-1&&(d=r.trim(a.slice(h)),a=a.slice(0,h)),r.isFunction(b)?(c=b,b=void 0):b&&\"object\"==typeof b&&(e=\"POST\"),g.length>0&&r.ajax({url:a,type:e||\"GET\",dataType:\"html\",data:b}).done(function(a){f=arguments,g.html(d?r(\"<div>\").append(r.parseHTML(a)).find(d):a)}).always(c&&function(a,b){g.each(function(){c.apply(this,f||[a.responseText,b,a])})}),this},r.each([\"ajaxStart\",\"ajaxStop\",\"ajaxComplete\",\"ajaxError\",\"ajaxSuccess\",\"ajaxSend\"],function(a,b){r.fn[b]=function(a){return this.on(b,a)}}),r.expr.pseudos.animated=function(a){return r.grep(r.timers,function(b){return a===b.elem}).length};function Sb(a){return r.isWindow(a)?a:9===a.nodeType&&a.defaultView}r.offset={setOffset:function(a,b,c){var d,e,f,g,h,i,j,k=r.css(a,\"position\"),l=r(a),m={};\"static\"===k&&(a.style.position=\"relative\"),h=l.offset(),f=r.css(a,\"top\"),i=r.css(a,\"left\"),j=(\"absolute\"===k||\"fixed\"===k)&&(f+i).indexOf(\"auto\")>-1,j?(d=l.position(),g=d.top,e=d.left):(g=parseFloat(f)||0,e=parseFloat(i)||0),r.isFunction(b)&&(b=b.call(a,c,r.extend({},h))),null!=b.top&&(m.top=b.top-h.top+g),null!=b.left&&(m.left=b.left-h.left+e),\"using\"in b?b.using.call(a,m):l.css(m)}},r.fn.extend({offset:function(a){if(arguments.length)return void 0===a?this:this.each(function(b){r.offset.setOffset(this,a,b)});var b,c,d,e,f=this[0];if(f)return f.getClientRects().length?(d=f.getBoundingClientRect(),d.width||d.height?(e=f.ownerDocument,c=Sb(e),b=e.documentElement,{top:d.top+c.pageYOffset-b.clientTop,left:d.left+c.pageXOffset-b.clientLeft}):d):{top:0,left:0}},position:function(){if(this[0]){var a,b,c=this[0],d={top:0,left:0};return\"fixed\"===r.css(c,\"position\")?b=c.getBoundingClientRect():(a=this.offsetParent(),b=this.offset(),r.nodeName(a[0],\"html\")||(d=a.offset()),d={top:d.top+r.css(a[0],\"borderTopWidth\",!0),left:d.left+r.css(a[0],\"borderLeftWidth\",!0)}),{top:b.top-d.top-r.css(c,\"marginTop\",!0),left:b.left-d.left-r.css(c,\"marginLeft\",!0)}}},offsetParent:function(){return this.map(function(){var a=this.offsetParent;while(a&&\"static\"===r.css(a,\"position\"))a=a.offsetParent;return a||pa})}}),r.each({scrollLeft:\"pageXOffset\",scrollTop:\"pageYOffset\"},function(a,b){var c=\"pageYOffset\"===b;r.fn[a]=function(d){return S(this,function(a,d,e){var f=Sb(a);return void 0===e?f?f[b]:a[d]:void(f?f.scrollTo(c?f.pageXOffset:e,c?e:f.pageYOffset):a[d]=e)},a,d,arguments.length)}}),r.each([\"top\",\"left\"],function(a,b){r.cssHooks[b]=Na(o.pixelPosition,function(a,c){if(c)return c=Ma(a,b),Ka.test(c)?r(a).position()[b]+\"px\":c})}),r.each({Height:\"height\",Width:\"width\"},function(a,b){r.each({padding:\"inner\"+a,content:b,\"\":\"outer\"+a},function(c,d){r.fn[d]=function(e,f){var g=arguments.length&&(c||\"boolean\"!=typeof e),h=c||(e===!0||f===!0?\"margin\":\"border\");return S(this,function(b,c,e){var f;return r.isWindow(b)?0===d.indexOf(\"outer\")?b[\"inner\"+a]:b.document.documentElement[\"client\"+a]:9===b.nodeType?(f=b.documentElement,Math.max(b.body[\"scroll\"+a],f[\"scroll\"+a],b.body[\"offset\"+a],f[\"offset\"+a],f[\"client\"+a])):void 0===e?r.css(b,c,h):r.style(b,c,e,h)},b,g?e:void 0,g)}})}),r.fn.extend({bind:function(a,b,c){return this.on(a,null,b,c)},unbind:function(a,b){return this.off(a,null,b)},delegate:function(a,b,c,d){return this.on(b,a,c,d)},undelegate:function(a,b,c){return 1===arguments.length?this.off(a,\"**\"):this.off(b,a||\"**\",c)}}),r.parseJSON=JSON.parse,\"function\"==typeof define&&define.amd&&define(\"jquery\",[],function(){return r});var Tb=a.jQuery,Ub=a.$;return r.noConflict=function(b){return a.$===r&&(a.$=Ub),b&&a.jQuery===r&&(a.jQuery=Tb),r},b||(a.jQuery=a.$=r),r});\n","date":"2016-09-11T11:16:55.000Z","updated":"2016-09-11T11:14:55.000Z","path":"static/js/jquery.min.js","layout":"false","title":"","comments":1,"_id":"cj830jvfq006jul0rj4tpxdb1","content":"/*! jQuery v3.1.0 | (c) jQuery Foundation | jquery.org/license */\n!function(a,b){\"use strict\";\"object\"==typeof module&&\"object\"==typeof module.exports?module.exports=a.document?b(a,!0):function(a){if(!a.document)throw new Error(\"jQuery requires a window with a document\");return b(a)}:b(a)}(\"undefined\"!=typeof window?window:this,function(a,b){\"use strict\";var c=[],d=a.document,e=Object.getPrototypeOf,f=c.slice,g=c.concat,h=c.push,i=c.indexOf,j={},k=j.toString,l=j.hasOwnProperty,m=l.toString,n=m.call(Object),o={};function p(a,b){b=b||d;var c=b.createElement(\"script\");c.text=a,b.head.appendChild(c).parentNode.removeChild(c)}var q=\"3.1.0\",r=function(a,b){return new r.fn.init(a,b)},s=/^[\\s\\uFEFF\\xA0]+|[\\s\\uFEFF\\xA0]+$/g,t=/^-ms-/,u=/-([a-z])/g,v=function(a,b){return b.toUpperCase()};r.fn=r.prototype={jquery:q,constructor:r,length:0,toArray:function(){return f.call(this)},get:function(a){return null!=a?a<0?this[a+this.length]:this[a]:f.call(this)},pushstack:function(a){var b=\"r.merge(this.constructor(),a);return\" b.prevobject=\"this,b},each:function(a){return\" r.each(this,a)},map:function(a){return=\"\" this.pushstack(r.map(this,function(b,c){return=\"\" a.call(b,c,b)}))},slice:function(){return=\"\" this.pushstack(f.apply(this,arguments))},first:function(){return=\"\" this.eq(0)},last:function(){return=\"\" this.eq(-1)},eq:function(a){var=\"\" this.pushstack(c=\"\">=0&&c<b?[this[c]]:[])},end:function(){return this.prevobject||this.constructor()},push:h,sort:c.sort,splice:c.splice},r.extend=\"r.fn.extend=function(){var\" a,b,c,d,e,f,g=\"arguments[0]||{},h=1,i=arguments.length,j=!1;for(\"boolean\"==typeof\" g&&(j=\"g,g=arguments[h]||{},h++),\"object\"==typeof\" g||r.isfunction(g)||(g=\"{}),h===i&&(g=this,h--);h<i;h++)if(null!=(a=arguments[h]))for(b\" in=\"\" a)c=\"g[b],d=a[b],g!==d&&(j&&d&&(r.isPlainObject(d)||(e=r.isArray(d)))?(e?(e=!1,f=c&&r.isArray(c)?c:[]):f=c&&r.isPlainObject(c)?c:{},g[b]=r.extend(j,f,d)):void\" 0!=\"=d&&(g[b]=d));return\" g},r.extend({expando:\"jquery\"+(q+math.random()).replace(=\"\" \\d=\"\" g,\"\"),isready:!0,error:function(a){throw=\"\" new=\"\" error(a)},noop:function(){},isfunction:function(a){return\"function\"=\"==r.type(a)},isArray:Array.isArray,isWindow:function(a){return\" null!=\"a&&a===a.window},isNumeric:function(a){var\" b=\"r.type(a);return(\"number\"===b||\"string\"===b)&&!isNaN(a-parseFloat(a))},isPlainObject:function(a){var\" b,c;return!(!a||\"[object=\"\" object]\"!=\"=k.call(a))&&(!(b=e(a))||(c=l.call(b,\"constructor\")&&b.constructor,\"function\"==typeof\" c&&m.call(c)=\"==n))},isEmptyObject:function(a){var\" b;for(b=\"\" a)return!1;return!0},type:function(a){return=\"\" null=\"=a?a+\"\":\"object\"==typeof\" a||\"function\"=\"=typeof\" a?j[k.call(a)]||\"object\":typeof=\"\" a},globaleval:function(a){p(a)},camelcase:function(a){return=\"\" a.replace(t,\"ms-\").replace(u,v)},nodename:function(a,b){return=\"\" a.nodename&&a.nodename.tolowercase()=\"==b.toLowerCase()},each:function(a,b){var\" c,d=\"0;if(w(a)){for(c=a.length;d<c;d++)if(b.call(a[d],d,a[d])===!1)break}else\" for(d=\"\" a)if(b.call(a[d],d,a[d])=\"==!1)break;return\" a},trim:function(a){return=\"\" c=\"b||[];return\" a?[a]:a):h.call(c,a)),c},inarray:function(a,b,c){return=\"\" a.length=\"e,a},grep:function(a,b,c){for(var\" d,e=\"[],f=0,g=a.length,h=!c;f<g;f++)d=!b(a[f],f),d!==h&&e.push(a[f]);return\" e},map:function(a,b,c){var=\"\" d,e,f=\"0,h=[];if(w(a))for(d=a.length;f<d;f++)e=b(a[f],f,c),null!=e&&h.push(e);else\" for(f=\"\" a)e=\"b(a[f],f,c),null!=e&&h.push(e);return\" g.apply([],h)},guid:1,proxy:function(a,b){var=\"\" c,d,e;if(\"string\"=\"=typeof\" b&&(c=\"a[b],b=a,a=c),r.isFunction(a))return\" d=\"f.call(arguments,2),e=function(){return\" a.apply(b||this,d.concat(f.call(arguments)))},e.guid=\"a.guid=a.guid||r.guid++,e},now:Date.now,support:o}),\"function\"==typeof\" symbol&&(r.fn[symbol.iterator]=\"c[Symbol.iterator]),r.each(\"Boolean\" number=\"\" string=\"\" function=\"\" array=\"\" date=\"\" regexp=\"\" object=\"\" error=\"\" symbol\".split(\"=\"\" \"),function(a,b){j[\"[object=\"\" \"+b+\"]\"]=\"b.toLowerCase()});function\" w(a){var=\"\" a&&a.length,c=\"r.type(a);return\"function\"!==c&&!r.isWindow(a)&&(\"array\"===c||0===b||\"number\"==typeof\" b&&b=\"\">0&&b-1 in a)}var x=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u=\"sizzle\"+1*new Date,v=a.document,w=0,x=0,y=ha(),z=ha(),A=ha(),B=function(a,b){return a===b&&(l=!0),0},C={}.hasOwnProperty,D=[],E=D.pop,F=D.push,G=D.push,H=D.slice,I=function(a,b){for(var c=0,d=a.length;c<d;c++)if(a[c]===b)return c;return-1},j=\"checked|selected|async|autofocus|autoplay|controls|defer|disabled|hidden|ismap|loop|multiple|open|readonly|required|scoped\" ,k=\"[\\\\x20\\\\t\\\\r\\\\n\\\\f]\" ,l=\"(?:\\\\\\\\.|[\\\\w-]|[^\\0-\\\\xa0])+\" ,m=\"\\\\[\" +k+\"*(\"+l+\")(?:\"+k+\"*([*^$|!~]?=\")\"+K+\"*(?:'((?:\\\\\\\\.|[^\\\\\\\\'])*)'|\\\"((?:\\\\\\\\.|[^\\\\\\\\\\\"])*)\\\"|(\"+L+\"))|)\"+K+\"*\\\\]\",N=\":(\"+L+\")(?:\\\\((('((?:\\\\\\\\.|[^\\\\\\\\'])*)'|\\\"((?:\\\\\\\\.|[^\\\\\\\\\\\"])*)\\\")|((?:\\\\\\\\.|[^\\\\\\\\()[\\\\]]|\"+M+\")*)|.*)\\\\)|)\",O=new\" regexp(k+\"+\",\"g\"),p=\"new\" regexp(\"^\"+k+\"+|((?:^|[^\\\\\\\\])(?:\\\\\\\\.)*)\"+k+\"+$\",\"g\"),q=\"new\" regexp(\"^\"+k+\"*,\"+k+\"*\"),r=\"new\" regexp(\"^\"+k+\"*([=\"\">+~]|\"+K+\")\"+K+\"*\"),S=new RegExp(\"=\"+K+\"*([^\\\\]'\\\"]*?)\"+K+\"*\\\\]\",\"g\"),T=new RegExp(N),U=new RegExp(\"^\"+L+\"$\"),V={ID:new RegExp(\"^#(\"+L+\")\"),CLASS:new RegExp(\"^\\\\.(\"+L+\")\"),TAG:new RegExp(\"^(\"+L+\"|[*])\"),ATTR:new RegExp(\"^\"+M),PSEUDO:new RegExp(\"^\"+N),CHILD:new RegExp(\"^:(only|first|last|nth|nth-last)-(child|of-type)(?:\\\\(\"+K+\"*(even|odd|(([+-]|)(\\\\d*)n|)\"+K+\"*(?:([+-]|)\"+K+\"*(\\\\d+)|))\"+K+\"*\\\\)|)\",\"i\"),bool:new RegExp(\"^(?:\"+J+\")$\",\"i\"),needsContext:new RegExp(\"^\"+K+\"*[>+~]|:(even|odd|eq|gt|lt|nth|first|last)(?:\\\\(\"+K+\"*((?:-\\\\d)?\\\\d*)\"+K+\"*\\\\)|)(?=[^-]|$)\",\"i\")},W=/^(?:input|select|textarea|button)$/i,X=/^h\\d$/i,Y=/^[^{]+\\{\\s*\\[native \\w/,Z=/^(?:#([\\w-]+)|(\\w+)|\\.([\\w-]+))$/,$=/[+~]/,_=new RegExp(\"\\\\\\\\([\\\\da-f]{1,6}\"+K+\"?|(\"+K+\")|.)\",\"ig\"),aa=function(a,b,c){var d=\"0x\"+b-65536;return d!==d||c?b:d<0?string.fromcharcode(d+65536):string.fromcharcode(d>>10|55296,1023&d|56320)},ba=/([\\0-\\x1f\\x7f]|^-?\\d)|^-$|[^\\x80-\\uFFFF\\w-]/g,ca=function(a,b){return b?\"\\0\"===a?\"\\ufffd\":a.slice(0,-1)+\"\\\\\"+a.charCodeAt(a.length-1).toString(16)+\" \":\"\\\\\"+a},da=function(){m()},ea=ta(function(a){return a.disabled===!0},{dir:\"parentNode\",next:\"legend\"});try{G.apply(D=H.call(v.childNodes),v.childNodes),D[v.childNodes.length].nodeType}catch(fa){G={apply:D.length?function(a,b){F.apply(a,H.call(b))}:function(a,b){var c=a.length,d=0;while(a[c++]=b[d++]);a.length=c-1}}}function ga(a,b,d,e){var f,h,j,k,l,o,r,s=b&&b.ownerDocument,w=b?b.nodeType:9;if(d=d||[],\"string\"!=typeof a||!a||1!==w&&9!==w&&11!==w)return d;if(!e&&((b?b.ownerDocument||b:v)!==n&&m(b),b=b||n,p)){if(11!==w&&(l=Z.exec(a)))if(f=l[1]){if(9===w){if(!(j=b.getElementById(f)))return d;if(j.id===f)return d.push(j),d}else if(s&&(j=s.getElementById(f))&&t(b,j)&&j.id===f)return d.push(j),d}else{if(l[2])return G.apply(d,b.getElementsByTagName(a)),d;if((f=l[3])&&c.getElementsByClassName&&b.getElementsByClassName)return G.apply(d,b.getElementsByClassName(f)),d}if(c.qsa&&!A[a+\" \"]&&(!q||!q.test(a))){if(1!==w)s=b,r=a;else if(\"object\"!==b.nodeName.toLowerCase()){(k=b.getAttribute(\"id\"))?k=k.replace(ba,ca):b.setAttribute(\"id\",k=u),o=g(a),h=o.length;while(h--)o[h]=\"#\"+k+\" \"+sa(o[h]);r=o.join(\",\"),s=$.test(a)&&qa(b.parentNode)||b}if(r)try{return G.apply(d,s.querySelectorAll(r)),d}catch(x){}finally{k===u&&b.removeAttribute(\"id\")}}}return i(a.replace(P,\"$1\"),b,d,e)}function ha(){var a=[];function b(c,e){return a.push(c+\" \")>d.cacheLength&&delete b[a.shift()],b[c+\" \"]=e}return b}function ia(a){return a[u]=!0,a}function ja(a){var b=n.createElement(\"fieldset\");try{return!!a(b)}catch(c){return!1}finally{b.parentNode&&b.parentNode.removeChild(b),b=null}}function ka(a,b){var c=a.split(\"|\"),e=c.length;while(e--)d.attrHandle[c[e]]=b}function la(a,b){var c=b&&a,d=c&&1===a.nodeType&&1===b.nodeType&&a.sourceIndex-b.sourceIndex;if(d)return d;if(c)while(c=c.nextSibling)if(c===b)return-1;return a?1:-1}function ma(a){return function(b){var c=b.nodeName.toLowerCase();return\"input\"===c&&b.type===a}}function na(a){return function(b){var c=b.nodeName.toLowerCase();return(\"input\"===c||\"button\"===c)&&b.type===a}}function oa(a){return function(b){return\"label\"in b&&b.disabled===a||\"form\"in b&&b.disabled===a||\"form\"in b&&b.disabled===!1&&(b.isDisabled===a||b.isDisabled!==!a&&(\"label\"in b||!ea(b))!==a)}}function pa(a){return ia(function(b){return b=+b,ia(function(c,d){var e,f=a([],c.length,b),g=f.length;while(g--)c[e=f[g]]&&(c[e]=!(d[e]=c[e]))})})}function qa(a){return a&&\"undefined\"!=typeof a.getElementsByTagName&&a}c=ga.support={},f=ga.isXML=function(a){var b=a&&(a.ownerDocument||a).documentElement;return!!b&&\"HTML\"!==b.nodeName},m=ga.setDocument=function(a){var b,e,g=a?a.ownerDocument||a:v;return g!==n&&9===g.nodeType&&g.documentElement?(n=g,o=n.documentElement,p=!f(n),v!==n&&(e=n.defaultView)&&e.top!==e&&(e.addEventListener?e.addEventListener(\"unload\",da,!1):e.attachEvent&&e.attachEvent(\"onunload\",da)),c.attributes=ja(function(a){return a.className=\"i\",!a.getAttribute(\"className\")}),c.getElementsByTagName=ja(function(a){return a.appendChild(n.createComment(\"\")),!a.getElementsByTagName(\"*\").length}),c.getElementsByClassName=Y.test(n.getElementsByClassName),c.getById=ja(function(a){return o.appendChild(a).id=u,!n.getElementsByName||!n.getElementsByName(u).length}),c.getById?(d.find.ID=function(a,b){if(\"undefined\"!=typeof b.getElementById&&p){var c=b.getElementById(a);return c?[c]:[]}},d.filter.ID=function(a){var b=a.replace(_,aa);return function(a){return a.getAttribute(\"id\")===b}}):(delete d.find.ID,d.filter.ID=function(a){var b=a.replace(_,aa);return function(a){var c=\"undefined\"!=typeof a.getAttributeNode&&a.getAttributeNode(\"id\");return c&&c.value===b}}),d.find.TAG=c.getElementsByTagName?function(a,b){return\"undefined\"!=typeof b.getElementsByTagName?b.getElementsByTagName(a):c.qsa?b.querySelectorAll(a):void 0}:function(a,b){var c,d=[],e=0,f=b.getElementsByTagName(a);if(\"*\"===a){while(c=f[e++])1===c.nodeType&&d.push(c);return d}return f},d.find.CLASS=c.getElementsByClassName&&function(a,b){if(\"undefined\"!=typeof b.getElementsByClassName&&p)return b.getElementsByClassName(a)},r=[],q=[],(c.qsa=Y.test(n.querySelectorAll))&&(ja(function(a){o.appendChild(a).innerHTML=\"<a id=\"\"+u+\"\"></a><select id=\"\"+u+\"-\\r\\\\\" msallowcapture=\"\"><option selected></option></select>\",a.querySelectorAll(\"[msallowcapture^='']\").length&&q.push(\"[*^$]=\"+K+\"*(?:''|\\\"\\\")\"),a.querySelectorAll(\"[selected]\").length||q.push(\"\\\\[\"+K+\"*(?:value|\"+J+\")\"),a.querySelectorAll(\"[id~=\"+u+\"-]\").length||q.push(\"~=\"),a.querySelectorAll(\":checked\").length||q.push(\":checked\"),a.querySelectorAll(\"a#\"+u+\"+*\").length||q.push(\".#.+[+~]\")}),ja(function(a){a.innerHTML=\"<a href=\"\" disabled=\"disabled\"></a><select disabled=\"disabled\"><option></option></select>\";var b=n.createElement(\"input\");b.setAttribute(\"type\",\"hidden\"),a.appendChild(b).setAttribute(\"name\",\"D\"),a.querySelectorAll(\"[name=d]\").length&&q.push(\"name\"+K+\"*[*^$|!~]?=\"),2!==a.querySelectorAll(\":enabled\").length&&q.push(\":enabled\",\":disabled\"),o.appendChild(a).disabled=!0,2!==a.querySelectorAll(\":disabled\").length&&q.push(\":enabled\",\":disabled\"),a.querySelectorAll(\"*,:x\"),q.push(\",.*:\")})),(c.matchesSelector=Y.test(s=o.matches||o.webkitMatchesSelector||o.mozMatchesSelector||o.oMatchesSelector||o.msMatchesSelector))&&ja(function(a){c.disconnectedMatch=s.call(a,\"*\"),s.call(a,\"[s!='']:x\"),r.push(\"!=\",N)}),q=q.length&&new RegExp(q.join(\"|\")),r=r.length&&new RegExp(r.join(\"|\")),b=Y.test(o.compareDocumentPosition),t=b||Y.test(o.contains)?function(a,b){var c=9===a.nodeType?a.documentElement:a,d=b&&b.parentNode;return a===d||!(!d||1!==d.nodeType||!(c.contains?c.contains(d):a.compareDocumentPosition&&16&a.compareDocumentPosition(d)))}:function(a,b){if(b)while(b=b.parentNode)if(b===a)return!0;return!1},B=b?function(a,b){if(a===b)return l=!0,0;var d=!a.compareDocumentPosition-!b.compareDocumentPosition;return d?d:(d=(a.ownerDocument||a)===(b.ownerDocument||b)?a.compareDocumentPosition(b):1,1&d||!c.sortDetached&&b.compareDocumentPosition(a)===d?a===n||a.ownerDocument===v&&t(v,a)?-1:b===n||b.ownerDocument===v&&t(v,b)?1:k?I(k,a)-I(k,b):0:4&d?-1:1)}:function(a,b){if(a===b)return l=!0,0;var c,d=0,e=a.parentNode,f=b.parentNode,g=[a],h=[b];if(!e||!f)return a===n?-1:b===n?1:e?-1:f?1:k?I(k,a)-I(k,b):0;if(e===f)return la(a,b);c=a;while(c=c.parentNode)g.unshift(c);c=b;while(c=c.parentNode)h.unshift(c);while(g[d]===h[d])d++;return d?la(g[d],h[d]):g[d]===v?-1:h[d]===v?1:0},n):n},ga.matches=function(a,b){return ga(a,null,null,b)},ga.matchesSelector=function(a,b){if((a.ownerDocument||a)!==n&&m(a),b=b.replace(S,\"='$1']\"),c.matchesSelector&&p&&!A[b+\" \"]&&(!r||!r.test(b))&&(!q||!q.test(b)))try{var d=s.call(a,b);if(d||c.disconnectedMatch||a.document&&11!==a.document.nodeType)return d}catch(e){}return ga(b,n,null,[a]).length>0},ga.contains=function(a,b){return(a.ownerDocument||a)!==n&&m(a),t(a,b)},ga.attr=function(a,b){(a.ownerDocument||a)!==n&&m(a);var e=d.attrHandle[b.toLowerCase()],f=e&&C.call(d.attrHandle,b.toLowerCase())?e(a,b,!p):void 0;return void 0!==f?f:c.attributes||!p?a.getAttribute(b):(f=a.getAttributeNode(b))&&f.specified?f.value:null},ga.escape=function(a){return(a+\"\").replace(ba,ca)},ga.error=function(a){throw new Error(\"Syntax error, unrecognized expression: \"+a)},ga.uniqueSort=function(a){var b,d=[],e=0,f=0;if(l=!c.detectDuplicates,k=!c.sortStable&&a.slice(0),a.sort(B),l){while(b=a[f++])b===a[f]&&(e=d.push(f));while(e--)a.splice(d[e],1)}return k=null,a},e=ga.getText=function(a){var b,c=\"\",d=0,f=a.nodeType;if(f){if(1===f||9===f||11===f){if(\"string\"==typeof a.textContent)return a.textContent;for(a=a.firstChild;a;a=a.nextSibling)c+=e(a)}else if(3===f||4===f)return a.nodeValue}else while(b=a[d++])c+=e(b);return c},d=ga.selectors={cacheLength:50,createPseudo:ia,match:V,attrHandle:{},find:{},relative:{\">\":{dir:\"parentNode\",first:!0},\" \":{dir:\"parentNode\"},\"+\":{dir:\"previousSibling\",first:!0},\"~\":{dir:\"previousSibling\"}},preFilter:{ATTR:function(a){return a[1]=a[1].replace(_,aa),a[3]=(a[3]||a[4]||a[5]||\"\").replace(_,aa),\"~=\"===a[2]&&(a[3]=\" \"+a[3]+\" \"),a.slice(0,4)},CHILD:function(a){return a[1]=a[1].toLowerCase(),\"nth\"===a[1].slice(0,3)?(a[3]||ga.error(a[0]),a[4]=+(a[4]?a[5]+(a[6]||1):2*(\"even\"===a[3]||\"odd\"===a[3])),a[5]=+(a[7]+a[8]||\"odd\"===a[3])):a[3]&&ga.error(a[0]),a},PSEUDO:function(a){var b,c=!a[6]&&a[2];return V.CHILD.test(a[0])?null:(a[3]?a[2]=a[4]||a[5]||\"\":c&&T.test(c)&&(b=g(c,!0))&&(b=c.indexOf(\")\",c.length-b)-c.length)&&(a[0]=a[0].slice(0,b),a[2]=c.slice(0,b)),a.slice(0,3))}},filter:{TAG:function(a){var b=a.replace(_,aa).toLowerCase();return\"*\"===a?function(){return!0}:function(a){return a.nodeName&&a.nodeName.toLowerCase()===b}},CLASS:function(a){var b=y[a+\" \"];return b||(b=new RegExp(\"(^|\"+K+\")\"+a+\"(\"+K+\"|$)\"))&&y(a,function(a){return b.test(\"string\"==typeof a.className&&a.className||\"undefined\"!=typeof a.getAttribute&&a.getAttribute(\"class\")||\"\")})},ATTR:function(a,b,c){return function(d){var e=ga.attr(d,a);return null==e?\"!=\"===b:!b||(e+=\"\",\"=\"===b?e===c:\"!=\"===b?e!==c:\"^=\"===b?c&&0===e.indexOf(c):\"*=\"===b?c&&e.indexOf(c)>-1:\"$=\"===b?c&&e.slice(-c.length)===c:\"~=\"===b?(\" \"+e.replace(O,\" \")+\" \").indexOf(c)>-1:\"|=\"===b&&(e===c||e.slice(0,c.length+1)===c+\"-\"))}},CHILD:function(a,b,c,d,e){var f=\"nth\"!==a.slice(0,3),g=\"last\"!==a.slice(-4),h=\"of-type\"===b;return 1===d&&0===e?function(a){return!!a.parentNode}:function(b,c,i){var j,k,l,m,n,o,p=f!==g?\"nextSibling\":\"previousSibling\",q=b.parentNode,r=h&&b.nodeName.toLowerCase(),s=!i&&!h,t=!1;if(q){if(f){while(p){m=b;while(m=m[p])if(h?m.nodeName.toLowerCase()===r:1===m.nodeType)return!1;o=p=\"only\"===a&&!o&&\"nextSibling\"}return!0}if(o=[g?q.firstChild:q.lastChild],g&&s){m=q,l=m[u]||(m[u]={}),k=l[m.uniqueID]||(l[m.uniqueID]={}),j=k[a]||[],n=j[0]===w&&j[1],t=n&&j[2],m=n&&q.childNodes[n];while(m=++n&&m&&m[p]||(t=n=0)||o.pop())if(1===m.nodeType&&++t&&m===b){k[a]=[w,n,t];break}}else if(s&&(m=b,l=m[u]||(m[u]={}),k=l[m.uniqueID]||(l[m.uniqueID]={}),j=k[a]||[],n=j[0]===w&&j[1],t=n),t===!1)while(m=++n&&m&&m[p]||(t=n=0)||o.pop())if((h?m.nodeName.toLowerCase()===r:1===m.nodeType)&&++t&&(s&&(l=m[u]||(m[u]={}),k=l[m.uniqueID]||(l[m.uniqueID]={}),k[a]=[w,t]),m===b))break;return t-=e,t===d||t%d===0&&t/d>=0}}},PSEUDO:function(a,b){var c,e=d.pseudos[a]||d.setFilters[a.toLowerCase()]||ga.error(\"unsupported pseudo: \"+a);return e[u]?e(b):e.length>1?(c=[a,a,\"\",b],d.setFilters.hasOwnProperty(a.toLowerCase())?ia(function(a,c){var d,f=e(a,b),g=f.length;while(g--)d=I(a,f[g]),a[d]=!(c[d]=f[g])}):function(a){return e(a,0,c)}):e}},pseudos:{not:ia(function(a){var b=[],c=[],d=h(a.replace(P,\"$1\"));return d[u]?ia(function(a,b,c,e){var f,g=d(a,null,e,[]),h=a.length;while(h--)(f=g[h])&&(a[h]=!(b[h]=f))}):function(a,e,f){return b[0]=a,d(b,null,f,c),b[0]=null,!c.pop()}}),has:ia(function(a){return function(b){return ga(a,b).length>0}}),contains:ia(function(a){return a=a.replace(_,aa),function(b){return(b.textContent||b.innerText||e(b)).indexOf(a)>-1}}),lang:ia(function(a){return U.test(a||\"\")||ga.error(\"unsupported lang: \"+a),a=a.replace(_,aa).toLowerCase(),function(b){var c;do if(c=p?b.lang:b.getAttribute(\"xml:lang\")||b.getAttribute(\"lang\"))return c=c.toLowerCase(),c===a||0===c.indexOf(a+\"-\");while((b=b.parentNode)&&1===b.nodeType);return!1}}),target:function(b){var c=a.location&&a.location.hash;return c&&c.slice(1)===b.id},root:function(a){return a===o},focus:function(a){return a===n.activeElement&&(!n.hasFocus||n.hasFocus())&&!!(a.type||a.href||~a.tabIndex)},enabled:oa(!1),disabled:oa(!0),checked:function(a){var b=a.nodeName.toLowerCase();return\"input\"===b&&!!a.checked||\"option\"===b&&!!a.selected},selected:function(a){return a.parentNode&&a.parentNode.selectedIndex,a.selected===!0},empty:function(a){for(a=a.firstChild;a;a=a.nextSibling)if(a.nodeType<6)return!1;return!0},parent:function(a){return!d.pseudos.empty(a)},header:function(a){return x.test(a.nodename)},input:function(a){return=\"\" w.test(a.nodename)},button:function(a){var=\"\" b=\"a.nodeName.toLowerCase();return\"input\"===b&&\"button\"===a.type||\"button\"===b},text:function(a){var\" b;return\"input\"=\"==a.nodeName.toLowerCase()&&\"text\"===a.type&&(null==(b=a.getAttribute(\"type\"))||\"text\"===b.toLowerCase())},first:pa(function(){return[0]}),last:pa(function(a,b){return[b-1]}),eq:pa(function(a,b,c){return[c<0?c+b:c]}),even:pa(function(a,b){for(var\" c=\"0;c<b;c+=2)a.push(c);return\" a}),odd:pa(function(a,b){for(var=\"\" a}),lt:pa(function(a,b,c){for(var=\"\" d=\"c<0?c+b:c;--d\">=0;)a.push(d);return a}),gt:pa(function(a,b,c){for(var d=c<0?c+b:c;++d<b;)a.push(d);return a})}},d.pseudos.nth=\"d.pseudos.eq;for(b\" in{radio:!0,checkbox:!0,file:!0,password:!0,image:!0})d.pseudos[b]=\"ma(b);for(b\" in{submit:!0,reset:!0})d.pseudos[b]=\"na(b);function\" ra(){}ra.prototype=\"d.filters=d.pseudos,d.setFilters=new\" ra,g=\"ga.tokenize=function(a,b){var\" c,e,f,g,h,i,j,k=\"z[a+\"\" \"];if(k)return=\"\" b?0:k.slice(0);h=\"a,i=[],j=d.preFilter;while(h){c&&!(e=Q.exec(h))||(e&&(h=h.slice(e[0].length)||h),i.push(f=[])),c=!1,(e=R.exec(h))&&(c=e.shift(),f.push({value:c,type:e[0].replace(P,\"\" \")}),h=\"h.slice(c.length));for(g\" in=\"\" d.filter)!(e=\"V[g].exec(h))||j[g]&&!(e=j[g](e))||(c=e.shift(),f.push({value:c,type:g,matches:e}),h=h.slice(c.length));if(!c)break}return\" b?h.length:h?ga.error(a):z(a,i).slice(0)};function=\"\" sa(a){for(var=\"\" b=\"0,c=a.length,d=\"\";b<c;b++)d+=a[b].value;return\" d}function=\"\" ta(a,b,c){var=\"\" d=\"b.dir,e=b.next,f=e||d,g=c&&\"parentNode\"===f,h=x++;return\" b.first?function(b,c,e){while(b=\"b[d])if(1===b.nodeType||g)return\" a(b,c,e)}:function(b,c,i){var=\"\" j,k,l,m=\"[w,h];if(i){while(b=b[d])if((1===b.nodeType||g)&&a(b,c,i))return!0}else\" while(b=\"b[d])if(1===b.nodeType||g)if(l=b[u]||(b[u]={}),k=l[b.uniqueID]||(l[b.uniqueID]={}),e&&e===b.nodeName.toLowerCase())b=b[d]||b;else{if((j=k[f])&&j[0]===w&&j[1]===h)return\" m[2]=\"j[2];if(k[f]=m,m[2]=a(b,c,i))return!0}}}function\" ua(a){return=\"\" a.length=\"\">1?function(b,c,d){var e=a.length;while(e--)if(!a[e](b,c,d))return!1;return!0}:a[0]}function va(a,b,c){for(var d=0,e=b.length;d<e;d++)ga(a,b[d],c);return c}function=\"\" wa(a,b,c,d,e){for(var=\"\" f,g=\"[],h=0,i=a.length,j=null!=b;h<i;h++)(f=a[h])&&(c&&!c(f,d,e)||(g.push(f),j&&b.push(h)));return\" g}function=\"\" xa(a,b,c,d,e,f){return=\"\" d&&!d[u]&&(d=\"xa(d)),e&&!e[u]&&(e=xa(e,f)),ia(function(f,g,h,i){var\" j,k,l,m=\"[],n=[],o=g.length,p=f||va(b||\"*\",h.nodeType?[h]:h,[]),q=!a||!f&&b?p:wa(p,m,a,h,i),r=c?e||(f?a:o||d)?[]:g:q;if(c&&c(q,r,h,i),d){j=wa(r,n),d(j,[],h,i),k=j.length;while(k--)(l=j[k])&&(r[n[k]]=!(q[n[k]]=l))}if(f){if(e||a){if(e){j=[],k=r.length;while(k--)(l=r[k])&&j.push(q[k]=l);e(null,r=[],j,i)}k=r.length;while(k--)(l=r[k])&&(j=e?I(f,l):m[k])\">-1&&(f[j]=!(g[j]=l))}}else r=wa(r===g?r.splice(o,r.length):r),e?e(null,g,r,i):G.apply(g,r)})}function ya(a){for(var b,c,e,f=a.length,g=d.relative[a[0].type],h=g||d.relative[\" \"],i=g?1:0,k=ta(function(a){return a===b},h,!0),l=ta(function(a){return I(b,a)>-1},h,!0),m=[function(a,c,d){var e=!g&&(d||c!==j)||((b=c).nodeType?k(a,c,d):l(a,c,d));return b=null,e}];i<f;i++)if(c=d.relative[a[i].type])m=[ta(ua(m),c)];else{if(c=d.filter[a[i].type].apply(null,a[i].matches),c[u]){for(e=++i;e<f;e++)if(d.relative[a[e].type])break;return xa(i=\"\">1&&ua(m),i>1&&sa(a.slice(0,i-1).concat({value:\" \"===a[i-2].type?\"*\":\"\"})).replace(P,\"$1\"),c,i<e&&ya(a.slice(i,e)),e<f&&ya(a=a.slice(e)),e<f&&sa(a))}m.push(c)}return ua(m)}function=\"\" za(a,b){var=\"\" c=\"b.length\">0,e=a.length>0,f=function(f,g,h,i,k){var l,o,q,r=0,s=\"0\",t=f&&[],u=[],v=j,x=f||e&&d.find.TAG(\"*\",k),y=w+=null==v?1:Math.random()||.1,z=x.length;for(k&&(j=g===n||g||k);s!==z&&null!=(l=x[s]);s++){if(e&&l){o=0,g||l.ownerDocument===n||(m(l),h=!p);while(q=a[o++])if(q(l,g||n,h)){i.push(l);break}k&&(w=y)}c&&((l=!q&&l)&&r--,f&&t.push(l))}if(r+=s,c&&s!==r){o=0;while(q=b[o++])q(t,u,g,h);if(f){if(r>0)while(s--)t[s]||u[s]||(u[s]=E.call(i));u=wa(u)}G.apply(i,u),k&&!f&&u.length>0&&r+b.length>1&&ga.uniqueSort(i)}return k&&(w=y,j=v),t};return c?ia(f):f}return h=ga.compile=function(a,b){var c,d=[],e=[],f=A[a+\" \"];if(!f){b||(b=g(a)),c=b.length;while(c--)f=ya(b[c]),f[u]?d.push(f):e.push(f);f=A(a,za(e,d)),f.selector=a}return f},i=ga.select=function(a,b,e,f){var i,j,k,l,m,n=\"function\"==typeof a&&a,o=!f&&g(a=n.selector||a);if(e=e||[],1===o.length){if(j=o[0]=o[0].slice(0),j.length>2&&\"ID\"===(k=j[0]).type&&c.getById&&9===b.nodeType&&p&&d.relative[j[1].type]){if(b=(d.find.ID(k.matches[0].replace(_,aa),b)||[])[0],!b)return e;n&&(b=b.parentNode),a=a.slice(j.shift().value.length)}i=V.needsContext.test(a)?0:j.length;while(i--){if(k=j[i],d.relative[l=k.type])break;if((m=d.find[l])&&(f=m(k.matches[0].replace(_,aa),$.test(j[0].type)&&qa(b.parentNode)||b))){if(j.splice(i,1),a=f.length&&sa(j),!a)return G.apply(e,f),e;break}}}return(n||h(a,o))(f,b,!p,e,!b||$.test(a)&&qa(b.parentNode)||b),e},c.sortStable=u.split(\"\").sort(B).join(\"\")===u,c.detectDuplicates=!!l,m(),c.sortDetached=ja(function(a){return 1&a.compareDocumentPosition(n.createElement(\"fieldset\"))}),ja(function(a){return a.innerHTML=\"<a href=\"#\"></a>\",\"#\"===a.firstChild.getAttribute(\"href\")})||ka(\"type|href|height|width\",function(a,b,c){if(!c)return a.getAttribute(b,\"type\"===b.toLowerCase()?1:2)}),c.attributes&&ja(function(a){return a.innerHTML=\"<input>\",a.firstChild.setAttribute(\"value\",\"\"),\"\"===a.firstChild.getAttribute(\"value\")})||ka(\"value\",function(a,b,c){if(!c&&\"input\"===a.nodeName.toLowerCase())return a.defaultValue}),ja(function(a){return null==a.getAttribute(\"disabled\")})||ka(J,function(a,b,c){var d;if(!c)return a[b]===!0?b.toLowerCase():(d=a.getAttributeNode(b))&&d.specified?d.value:null}),ga}(a);r.find=x,r.expr=x.selectors,r.expr[\":\"]=r.expr.pseudos,r.uniqueSort=r.unique=x.uniqueSort,r.text=x.getText,r.isXMLDoc=x.isXML,r.contains=x.contains,r.escapeSelector=x.escape;var y=function(a,b,c){var d=[],e=void 0!==c;while((a=a[b])&&9!==a.nodeType)if(1===a.nodeType){if(e&&r(a).is(c))break;d.push(a)}return d},z=function(a,b){for(var c=[];a;a=a.nextSibling)1===a.nodeType&&a!==b&&c.push(a);return c},A=r.expr.match.needsContext,B=/^<([a-z][^\\ \\0=\"\">:\\x20\\t\\r\\n\\f]*)[\\x20\\t\\r\\n\\f]*\\/?>(?:<\\ \\1=\"\">|)$/i,C=/^.[^:#\\[\\.,]*$/;function D(a,b,c){if(r.isFunction(b))return r.grep(a,function(a,d){return!!b.call(a,d,a)!==c});if(b.nodeType)return r.grep(a,function(a){return a===b!==c});if(\"string\"==typeof b){if(C.test(b))return r.filter(b,a,c);b=r.filter(b,a)}return r.grep(a,function(a){return i.call(b,a)>-1!==c&&1===a.nodeType})}r.filter=function(a,b,c){var d=b[0];return c&&(a=\":not(\"+a+\")\"),1===b.length&&1===d.nodeType?r.find.matchesSelector(d,a)?[d]:[]:r.find.matches(a,r.grep(b,function(a){return 1===a.nodeType}))},r.fn.extend({find:function(a){var b,c,d=this.length,e=this;if(\"string\"!=typeof a)return this.pushStack(r(a).filter(function(){for(b=0;b<d;b++)if(r.contains(e[b],this))return!0}));for(c=this.pushstack([]),b=0;b<d;b++)r.find(a,e[b],c);return d=\"\">1?r.uniqueSort(c):c},filter:function(a){return this.pushStack(D(this,a||[],!1))},not:function(a){return this.pushStack(D(this,a||[],!0))},is:function(a){return!!D(this,\"string\"==typeof a&&A.test(a)?r(a):a||[],!1).length}});var E,F=/^(?:\\s*(<[\\w\\w]+>)[^>]*|#([\\w-]+))$/,G=r.fn.init=function(a,b,c){var e,f;if(!a)return this;if(c=c||E,\"string\"==typeof a){if(e=\"<\"===a[0]&&\">\"===a[a.length-1]&&a.length>=3?[null,a,null]:F.exec(a),!e||!e[1]&&b)return!b||b.jquery?(b||c).find(a):this.constructor(b).find(a);if(e[1]){if(b=b instanceof r?b[0]:b,r.merge(this,r.parseHTML(e[1],b&&b.nodeType?b.ownerDocument||b:d,!0)),B.test(e[1])&&r.isPlainObject(b))for(e in b)r.isFunction(this[e])?this[e](b[e]):this.attr(e,b[e]);return this}return f=d.getElementById(e[2]),f&&(this[0]=f,this.length=1),this}return a.nodeType?(this[0]=a,this.length=1,this):r.isFunction(a)?void 0!==c.ready?c.ready(a):a(r):r.makeArray(a,this)};G.prototype=r.fn,E=r(d);var H=/^(?:parents|prev(?:Until|All))/,I={children:!0,contents:!0,next:!0,prev:!0};r.fn.extend({has:function(a){var b=r(a,this),c=b.length;return this.filter(function(){for(var a=0;a<c;a++)if(r.contains(this,b[a]))return!0})},closest:function(a,b){var c,d=\"0,e=this.length,f=[],g=\"string\"!=typeof\" a&&r(a);if(!a.test(a))for(;d<e;d++)for(c=\"this[d];c&&c!==b;c=c.parentNode)if(c.nodeType<11&&(g?g.index(c)\">-1:1===c.nodeType&&r.find.matchesSelector(c,a))){f.push(c);break}return this.pushStack(f.length>1?r.uniqueSort(f):f)},index:function(a){return a?\"string\"==typeof a?i.call(r(a),this[0]):i.call(this,a.jquery?a[0]:a):this[0]&&this[0].parentNode?this.first().prevAll().length:-1},add:function(a,b){return this.pushStack(r.uniqueSort(r.merge(this.get(),r(a,b))))},addBack:function(a){return this.add(null==a?this.prevObject:this.prevObject.filter(a))}});function J(a,b){while((a=a[b])&&1!==a.nodeType);return a}r.each({parent:function(a){var b=a.parentNode;return b&&11!==b.nodeType?b:null},parents:function(a){return y(a,\"parentNode\")},parentsUntil:function(a,b,c){return y(a,\"parentNode\",c)},next:function(a){return J(a,\"nextSibling\")},prev:function(a){return J(a,\"previousSibling\")},nextAll:function(a){return y(a,\"nextSibling\")},prevAll:function(a){return y(a,\"previousSibling\")},nextUntil:function(a,b,c){return y(a,\"nextSibling\",c)},prevUntil:function(a,b,c){return y(a,\"previousSibling\",c)},siblings:function(a){return z((a.parentNode||{}).firstChild,a)},children:function(a){return z(a.firstChild)},contents:function(a){return a.contentDocument||r.merge([],a.childNodes)}},function(a,b){r.fn[a]=function(c,d){var e=r.map(this,b,c);return\"Until\"!==a.slice(-5)&&(d=c),d&&\"string\"==typeof d&&(e=r.filter(d,e)),this.length>1&&(I[a]||r.uniqueSort(e),H.test(a)&&e.reverse()),this.pushStack(e)}});var K=/\\S+/g;function L(a){var b={};return r.each(a.match(K)||[],function(a,c){b[c]=!0}),b}r.Callbacks=function(a){a=\"string\"==typeof a?L(a):r.extend({},a);var b,c,d,e,f=[],g=[],h=-1,i=function(){for(e=a.once,d=b=!0;g.length;h=-1){c=g.shift();while(++h<f.length)f[h].apply(c[0],c[1])===!1&&a.stoponfalse&&(h=f.length,c=!1)}a.memory||(c=!1),b=!1,e&&(f=c?[]:\"\")},j={add:function(){return f&&(c&&!b&&(h=\"f.length-1,g.push(c)),function\" d(b){r.each(b,function(b,c){r.isfunction(c)?a.unique&&j.has(c)||f.push(c):c&&c.length&&\"string\"!=\"=r.type(c)&&d(c)})}(arguments),c&&!b&&i()),this},remove:function(){return\" r.each(arguments,function(a,b){var=\"\" c;while((c=\"r.inArray(b,f,c))\">-1)f.splice(c,1),c<=h&&h--}),this},has:function(a){return a?r.inarray(a,f)=\"\">-1:f.length>0},empty:function(){return f&&(f=[]),this},disable:function(){return e=g=[],f=c=\"\",this},disabled:function(){return!f},lock:function(){return e=g=[],c||b||(f=c=\"\"),this},locked:function(){return!!e},fireWith:function(a,c){return e||(c=c||[],c=[a,c.slice?c.slice():c],g.push(c),b||i()),this},fire:function(){return j.fireWith(this,arguments),this},fired:function(){return!!d}};return j};function M(a){return a}function N(a){throw a}function O(a,b,c){var d;try{a&&r.isFunction(d=a.promise)?d.call(a).done(b).fail(c):a&&r.isFunction(d=a.then)?d.call(a,b,c):b.call(void 0,a)}catch(a){c.call(void 0,a)}}r.extend({Deferred:function(b){var c=[[\"notify\",\"progress\",r.Callbacks(\"memory\"),r.Callbacks(\"memory\"),2],[\"resolve\",\"done\",r.Callbacks(\"once memory\"),r.Callbacks(\"once memory\"),0,\"resolved\"],[\"reject\",\"fail\",r.Callbacks(\"once memory\"),r.Callbacks(\"once memory\"),1,\"rejected\"]],d=\"pending\",e={state:function(){return d},always:function(){return f.done(arguments).fail(arguments),this},\"catch\":function(a){return e.then(null,a)},pipe:function(){var a=arguments;return r.Deferred(function(b){r.each(c,function(c,d){var e=r.isFunction(a[d[4]])&&a[d[4]];f[d[1]](function(){var a=e&&e.apply(this,arguments);a&&r.isFunction(a.promise)?a.promise().progress(b.notify).done(b.resolve).fail(b.reject):b[d[0]+\"With\"](this,e?[a]:arguments)})}),a=null}).promise()},then:function(b,d,e){var f=0;function g(b,c,d,e){return function(){var h=this,i=arguments,j=function(){var a,j;if(!(b<f)){if(a=d.apply(h,i),a===c.promise())throw new=\"\" typeerror(\"thenable=\"\" self-resolution\");j=\"a&&(\"object\"==typeof\" a||\"function\"=\"=typeof\" a)&&a.then,r.isfunction(j)?e?j.call(a,g(f,c,m,e),g(f,c,n,e)):(f++,j.call(a,g(f,c,m,e),g(f,c,n,e),g(f,c,m,c.notifywith))):(d!=\"=M&&(h=void\" 0,i=\"[a]),(e||c.resolveWith)(h,i))}},k=e?j:function(){try{j()}catch(a){r.Deferred.exceptionHook&&r.Deferred.exceptionHook(a,k.stackTrace),b+1\">=f&&(d!==N&&(h=void 0,i=[a]),c.rejectWith(h,i))}};b?k():(r.Deferred.getStackHook&&(k.stackTrace=r.Deferred.getStackHook()),a.setTimeout(k))}}return r.Deferred(function(a){c[0][3].add(g(0,a,r.isFunction(e)?e:M,a.notifyWith)),c[1][3].add(g(0,a,r.isFunction(b)?b:M)),c[2][3].add(g(0,a,r.isFunction(d)?d:N))}).promise()},promise:function(a){return null!=a?r.extend(a,e):e}},f={};return r.each(c,function(a,b){var g=b[2],h=b[5];e[b[1]]=g.add,h&&g.add(function(){d=h},c[3-a][2].disable,c[0][2].lock),g.add(b[3].fire),f[b[0]]=function(){return f[b[0]+\"With\"](this===f?void 0:this,arguments),this},f[b[0]+\"With\"]=g.fireWith}),e.promise(f),b&&b.call(f,f),f},when:function(a){var b=arguments.length,c=b,d=Array(c),e=f.call(arguments),g=r.Deferred(),h=function(a){return function(c){d[a]=this,e[a]=arguments.length>1?f.call(arguments):c,--b||g.resolveWith(d,e)}};if(b<=1&&(o(a,g.done(h(c)).resolve,g.reject),\"pending\"===g.state()||r.isfunction(e[c]&&e[c].then)))return g.then();while(c--)o(e[c],h(c),g.reject);return=\"\" g.promise()}});var=\"\" p=\"/^(Eval|Internal|Range|Reference|Syntax|Type|URI)Error$/;r.Deferred.exceptionHook=function(b,c){a.console&&a.console.warn&&b&&P.test(b.name)&&a.console.warn(\"jQuery.Deferred\" exception:=\"\" \"+b.message,b.stack,c)},r.readyexception=\"function(b){a.setTimeout(function(){throw\" b})};var=\"\" q=\"r.Deferred();r.fn.ready=function(a){return\" q.then(a)[\"catch\"](function(a){r.readyexception(a)}),this},r.extend({isready:!1,readywait:1,holdready:function(a){a?r.readywait++:r.ready(!0)},ready:function(a){(a=\"==!0?--r.readyWait:r.isReady)||(r.isReady=!0,a!==!0&&--r.readyWait\">0||Q.resolveWith(d,[r]))}}),r.ready.then=Q.then;function R(){d.removeEventListener(\"DOMContentLoaded\",R),a.removeEventListener(\"load\",R),r.ready()}\"complete\"===d.readyState||\"loading\"!==d.readyState&&!d.documentElement.doScroll?a.setTimeout(r.ready):(d.addEventListener(\"DOMContentLoaded\",R),a.addEventListener(\"load\",R));var S=function(a,b,c,d,e,f,g){var h=0,i=a.length,j=null==c;if(\"object\"===r.type(c)){e=!0;for(h in c)S(a,b,h,c[h],!0,f,g)}else if(void 0!==d&&(e=!0,\nr.isFunction(d)||(g=!0),j&&(g?(b.call(a,d),b=null):(j=b,b=function(a,b,c){return j.call(r(a),c)})),b))for(;h<i;h++)b(a[h],c,g?d:d.call(a[h],h,b(a[h],c)));return 0=\"==b?this.cache(a):a[this.expando]&&a[this.expando][r.camelCase(b)]},access:function(a,b,c){return\" 1=\"==a.nodeType||9===a.nodeType||!+a.nodeType};function\" e?a:j?b.call(a):i?b(a[0],c):f},t=\"function(a){return\" u(){this.expando=\"r.expando+U.uid++}U.uid=1,U.prototype={cache:function(a){var\" b=\"a[this.expando];return\" b||(b=\"{},T(a)&&(a.nodeType?a[this.expando]=b:Object.defineProperty(a,this.expando,{value:b,configurable:!0}))),b},set:function(a,b,c){var\" d,e=\"this.cache(a);if(\"string\"==typeof\" b)e[r.camelcase(b)]=\"c;else\" for(d=\"\" in=\"\" b)e[r.camelcase(d)]=\"b[d];return\" e},get:function(a,b){return=\"\" void=\"\" b&&void=\"\" 0!=\"=c?c:b)},remove:function(a,b){var\" c,d=\"a[this.expando];if(void\" d?[b]:b.match(k)||[]),c=\"b.length;while(c--)delete\" d[b[c]]}(void=\"\" 0:delete=\"\" a[this.expando])}},hasdata:function(a){var=\"\" v=\"new\" u,w=\"new\" u,x=\"/^(?:\\{[\\w\\W]*\\}|\\[[\\w\\W]*\\])$/,Y=/[A-Z]/g;function\" z(a,b,c){var=\"\" d;if(void=\"\" c){try{c=\"true\" ==\"=c||\"false\"!==c&&(\"null\"===c?null:+c+\"\"===c?+c:X.test(c)?JSON.parse(c):c)}catch(e){}W.set(a,b,c)}else\" c=\"void\" 0;return=\"\" c}r.extend({hasdata:function(a){return=\"\" w.hasdata(a)||v.hasdata(a)},data:function(a,b,c){return=\"\" w.access(a,b,c)},removedata:function(a,b){w.remove(a,b)},_data:function(a,b,c){return=\"\" v.access(a,b,c)},_removedata:function(a,b){v.remove(a,b)}}),r.fn.extend({data:function(a,b){var=\"\" c,d,e,f=\"this[0],g=f&&f.attributes;if(void\" e}return\"object\"=\"=typeof\" a?this.each(function(){w.set(this,a)}):s(this,function(b){var=\"\" c;if(f&&void=\"\" c;if(c=\"Z(f,a),void\" c}else=\"\" this.each(function(){w.set(this,a,b)})},null,b,arguments.length=\"\">1,null,!0)},removeData:function(a){return this.each(function(){W.remove(this,a)})}}),r.extend({queue:function(a,b,c){var d;if(a)return b=(b||\"fx\")+\"queue\",d=V.get(a,b),c&&(!d||r.isArray(c)?d=V.access(a,b,r.makeArray(c)):d.push(c)),d||[]},dequeue:function(a,b){b=b||\"fx\";var c=r.queue(a,b),d=c.length,e=c.shift(),f=r._queueHooks(a,b),g=function(){r.dequeue(a,b)};\"inprogress\"===e&&(e=c.shift(),d--),e&&(\"fx\"===b&&c.unshift(\"inprogress\"),delete f.stop,e.call(a,g,f)),!d&&f&&f.empty.fire()},_queueHooks:function(a,b){var c=b+\"queueHooks\";return V.get(a,c)||V.access(a,c,{empty:r.Callbacks(\"once memory\").add(function(){V.remove(a,[b+\"queue\",c])})})}}),r.fn.extend({queue:function(a,b){var c=2;return\"string\"!=typeof a&&(b=a,a=\"fx\",c--),arguments.length<c?r.queue(this[0],a):void 0=\"==b?this:this.each(function(){var\" c=\"r.queue(this,a,b);r._queueHooks(this,a),\"fx\"===a&&\"inprogress\"!==c[0]&&r.dequeue(this,a)})},dequeue:function(a){return\" this.each(function(){r.dequeue(this,a)})},clearqueue:function(a){return=\"\" this.queue(a||\"fx\",[])},promise:function(a,b){var=\"\" c,d=\"1,e=r.Deferred(),f=this,g=this.length,h=function(){--d||e.resolveWith(f,[f])};\"string\"!=typeof\" a&&(b=\"a,a=void\" 0),a=\"a||\"fx\";while(g--)c=V.get(f[g],a+\"queueHooks\"),c&&c.empty&&(d++,c.empty.add(h));return\" h(),e.promise(b)}});var=\"\" $=\"/[+-]?(?:\\d*\\.|)\\d+(?:[eE][+-]?\\d+|)/.source,_=new\" regexp(\"^(?:([+-])=\"|)(\"+$+\")([a-z%]*)$\",\"i\"),aa=[\"Top\",\"Right\",\"Bottom\",\"Left\"],ba=function(a,b){return\" a=\"b||a,\"none\"===a.style.display||\"\"===a.style.display&&r.contains(a.ownerDocument,a)&&\"none\"===r.css(a,\"display\")},ca=function(a,b,c,d){var\" e,f,g=\"{};for(f\" in=\"\" b)g[f]=\"a.style[f],a.style[f]=b[f];e=c.apply(a,d||[]);for(f\" b)a.style[f]=\"g[f];return\" e};function=\"\" da(a,b,c,d){var=\"\" e,f=\"1,g=20,h=d?function(){return\" d.cur()}:function(){return=\"\" r.css(a,b,\"\")},i=\"h(),j=c&&c[3]||(r.cssNumber[b]?\"\":\"px\"),k=(r.cssNumber[b]||\"px\"!==j&&+i)&&_.exec(r.css(a,b));if(k&&k[3]!==j){j=j||k[3],c=c||[],k=+i||1;do\" f=\"f||\".5\",k/=f,r.style(a,b,k+j);while(f!==(f=h()/i)&&1!==f&&--g)}return\" c&&(k=\"+k||+i||0,e=c[1]?k+(c[1]+1)*c[2]:+c[2],d&&(d.unit=j,d.start=k,d.end=e)),e}var\" ea=\"{};function\" fa(a){var=\"\" b,c=\"a.ownerDocument,d=a.nodeName,e=ea[d];return\" e?e:(b=\"c.body.appendChild(c.createElement(d)),e=r.css(b,\"display\"),b.parentNode.removeChild(b),\"none\"===e&&(e=\"block\"),ea[d]=e,e)}function\" ga(a,b){for(var=\"\" c,d,e=\"[],f=0,g=a.length;f<g;f++)d=a[f],d.style&&(c=d.style.display,b?(\"none\"===c&&(e[f]=V.get(d,\"display\")||null,e[f]||(d.style.display=\"\")),\"\"===d.style.display&&ba(d)&&(e[f]=fa(d))):\"none\"!==c&&(e[f]=\"none\",V.set(d,\"display\",c)));for(f=0;f<g;f++)null!=e[f]&&(a[f].style.display=e[f]);return\" a}r.fn.extend({show:function(){return=\"\" ga(this,!0)},hide:function(){return=\"\" ga(this)},toggle:function(a){return\"boolean\"=\"=typeof\" a?a?this.show():this.hide():this.each(function(){ba(this)?r(this).show():r(this).hide()})}});var=\"\" ha=\"/^(?:checkbox|radio)$/i,ia=/<([a-z][^\\/\\0\">\\x20\\t\\r\\n\\f]+)/i,ja=/^$|\\/(?:java|ecma)script/i,ka={option:[1,\"<select multiple=\"multiple\">\",\"</select>\"],thead:[1,\"<table>\",\"</table>\"],col:[2,\"<table><colgroup>\",\"</colgroup></table>\"],tr:[2,\"<table><tbody>\",\"</tbody></table>\"],td:[3,\"<table><tbody><tr>\",\"</tr></tbody></table>\"],_default:[0,\"\",\"\"]};ka.optgroup=ka.option,ka.tbody=ka.tfoot=ka.colgroup=ka.caption=ka.thead,ka.th=ka.td;function la(a,b){var c=\"undefined\"!=typeof a.getElementsByTagName?a.getElementsByTagName(b||\"*\"):\"undefined\"!=typeof a.querySelectorAll?a.querySelectorAll(b||\"*\"):[];return void 0===b||b&&r.nodeName(a,b)?r.merge([a],c):c}function ma(a,b){for(var c=0,d=a.length;c<d;c++)v.set(a[c],\"globaleval\",!b||v.get(b[c],\"globaleval\"))}var na=\"/<|&#?\\w+;/;function\" oa(a,b,c,d,e){for(var=\"\" f,g,h,i,j,k,l=\"b.createDocumentFragment(),m=[],n=0,o=a.length;n<o;n++)if(f=a[n],f||0===f)if(\"object\"===r.type(f))r.merge(m,f.nodeType?[f]:f);else\" if(na.test(f)){g=\"g||l.appendChild(b.createElement(\"div\")),h=(ia.exec(f)||[\"\",\"\"])[1].toLowerCase(),i=ka[h]||ka._default,g.innerHTML=i[1]+r.htmlPrefilter(f)+i[2],k=i[0];while(k--)g=g.lastChild;r.merge(m,g.childNodes),g=l.firstChild,g.textContent=\"\"}else\" m.push(b.createtextnode(f));l.textcontent=\"\" ,n=\"0;while(f=m[n++])if(d&&r.inArray(f,d)\">-1)e&&e.push(f);else if(j=r.contains(f.ownerDocument,f),g=la(l.appendChild(f),\"script\"),j&&ma(g),c){k=0;while(f=g[k++])ja.test(f.type||\"\")&&c.push(f)}return l}!function(){var a=d.createDocumentFragment(),b=a.appendChild(d.createElement(\"div\")),c=d.createElement(\"input\");c.setAttribute(\"type\",\"radio\"),c.setAttribute(\"checked\",\"checked\"),c.setAttribute(\"name\",\"t\"),b.appendChild(c),o.checkClone=b.cloneNode(!0).cloneNode(!0).lastChild.checked,b.innerHTML=\"<textarea>x</textarea>\",o.noCloneChecked=!!b.cloneNode(!0).lastChild.defaultValue}();var pa=d.documentElement,qa=/^key/,ra=/^(?:mouse|pointer|contextmenu|drag|drop)|click/,sa=/^([^.]*)(?:\\.(.+)|)/;function ta(){return!0}function ua(){return!1}function va(){try{return d.activeElement}catch(a){}}function wa(a,b,c,d,e,f){var g,h;if(\"object\"==typeof b){\"string\"!=typeof c&&(d=d||c,c=void 0);for(h in b)wa(a,h,c,d,b[h],f);return a}if(null==d&&null==e?(e=c,d=c=void 0):null==e&&(\"string\"==typeof c?(e=d,d=void 0):(e=d,d=c,c=void 0)),e===!1)e=ua;else if(!e)return a;return 1===f&&(g=e,e=function(a){return r().off(a),g.apply(this,arguments)},e.guid=g.guid||(g.guid=r.guid++)),a.each(function(){r.event.add(this,b,e,d,c)})}r.event={global:{},add:function(a,b,c,d,e){var f,g,h,i,j,k,l,m,n,o,p,q=V.get(a);if(q){c.handler&&(f=c,c=f.handler,e=f.selector),e&&r.find.matchesSelector(pa,e),c.guid||(c.guid=r.guid++),(i=q.events)||(i=q.events={}),(g=q.handle)||(g=q.handle=function(b){return\"undefined\"!=typeof r&&r.event.triggered!==b.type?r.event.dispatch.apply(a,arguments):void 0}),b=(b||\"\").match(K)||[\"\"],j=b.length;while(j--)h=sa.exec(b[j])||[],n=p=h[1],o=(h[2]||\"\").split(\".\").sort(),n&&(l=r.event.special[n]||{},n=(e?l.delegateType:l.bindType)||n,l=r.event.special[n]||{},k=r.extend({type:n,origType:p,data:d,handler:c,guid:c.guid,selector:e,needsContext:e&&r.expr.match.needsContext.test(e),namespace:o.join(\".\")},f),(m=i[n])||(m=i[n]=[],m.delegateCount=0,l.setup&&l.setup.call(a,d,o,g)!==!1||a.addEventListener&&a.addEventListener(n,g)),l.add&&(l.add.call(a,k),k.handler.guid||(k.handler.guid=c.guid)),e?m.splice(m.delegateCount++,0,k):m.push(k),r.event.global[n]=!0)}},remove:function(a,b,c,d,e){var f,g,h,i,j,k,l,m,n,o,p,q=V.hasData(a)&&V.get(a);if(q&&(i=q.events)){b=(b||\"\").match(K)||[\"\"],j=b.length;while(j--)if(h=sa.exec(b[j])||[],n=p=h[1],o=(h[2]||\"\").split(\".\").sort(),n){l=r.event.special[n]||{},n=(d?l.delegateType:l.bindType)||n,m=i[n]||[],h=h[2]&&new RegExp(\"(^|\\\\.)\"+o.join(\"\\\\.(?:.*\\\\.|)\")+\"(\\\\.|$)\"),g=f=m.length;while(f--)k=m[f],!e&&p!==k.origType||c&&c.guid!==k.guid||h&&!h.test(k.namespace)||d&&d!==k.selector&&(\"**\"!==d||!k.selector)||(m.splice(f,1),k.selector&&m.delegateCount--,l.remove&&l.remove.call(a,k));g&&!m.length&&(l.teardown&&l.teardown.call(a,o,q.handle)!==!1||r.removeEvent(a,n,q.handle),delete i[n])}else for(n in i)r.event.remove(a,n+b[j],c,d,!0);r.isEmptyObject(i)&&V.remove(a,\"handle events\")}},dispatch:function(a){var b=r.event.fix(a),c,d,e,f,g,h,i=new Array(arguments.length),j=(V.get(this,\"events\")||{})[b.type]||[],k=r.event.special[b.type]||{};for(i[0]=b,c=1;c<arguments.length;c++)i[c]=arguments[c];if(b.delegatetarget=this,!k.predispatch||k.predispatch.call(this,b)!==!1){h=r.event.handlers.call(this,b,j),c=0;while((f=h[c++])&&!b.ispropagationstopped()){b.currenttarget=f.elem,d=0;while((g=f.handlers[d++])&&!b.isimmediatepropagationstopped())b.rnamespace&&!b.rnamespace.test(g.namespace)||(b.handleobj=g,b.data=g.data,e=((r.event.special[g.origtype]||{}).handle||g.handler).apply(f.elem,i),void 0=\"==d[e]&&(d[e]=f.needsContext?r(e,this).index(i)\" 0!=\"=e&&(b.result=e)===!1&&(b.preventDefault(),b.stopPropagation()))}return\" k.postdispatch&&k.postdispatch.call(this,b),b.result}},handlers:function(a,b){var=\"\" c,d,e,f,g=\"[],h=b.delegateCount,i=a.target;if(h&&i.nodeType&&(\"click\"!==a.type||isNaN(a.button)||a.button<1))for(;i!==this;i=i.parentNode||this)if(1===i.nodeType&&(i.disabled!==!0||\"click\"!==a.type)){for(d=[],c=0;c<h;c++)f=b[c],e=f.selector+\"\" \",void=\"\">-1:r.find(e,this,null,[i]).length),d[e]&&d.push(f);d.length&&g.push({elem:i,handlers:d})}return h<b.length&&g.push({elem:this,handlers:b.slice(h)}),g},addprop:function(a,b){object.defineproperty(r.event.prototype,a,{enumerable:!0,configurable:!0,get:r.isfunction(b)?function(){if(this.originalevent)return 0=\"==a.defaultPrevented&&a.returnValue===!1?ta:ua,this.target=a.target&&3===a.target.nodeType?a.target.parentNode:a.target,this.currentTarget=a.currentTarget,this.relatedTarget=a.relatedTarget):this.type=a,b&&r.extend(this,b),this.timeStamp=a&&a.timeStamp||r.now(),void(this[r.expando]=!0)):new\" b(this.originalevent)}:function(){if(this.originalevent)return=\"\" this.originalevent[a]},set:function(b){object.defineproperty(this,a,{enumerable:!0,configurable:!0,writable:!0,value:b})}})},fix:function(a){return=\"\" a[r.expando]?a:new=\"\" r.event(a)},special:{load:{nobubble:!0},focus:{trigger:function(){if(this!=\"=va()&&this.focus)return\" this.focus(),!1},delegatetype:\"focusin\"},blur:{trigger:function(){if(this=\"==va()&&this.blur)return\" this.blur(),!1},delegatetype:\"focusout\"},click:{trigger:function(){if(\"checkbox\"=\"==this.type&&this.click&&r.nodeName(this,\"input\"))return\" this.click(),!1},_default:function(a){return=\"\" r.nodename(a.target,\"a\")}},beforeunload:{postdispatch:function(a){void=\"\" 0!=\"=a.result&&a.originalEvent&&(a.originalEvent.returnValue=a.result)}}}},r.removeEvent=function(a,b,c){a.removeEventListener&&a.removeEventListener(b,c)},r.Event=function(a,b){return\" this=\"\" instanceof=\"\" r.event?(a&&a.type?(this.originalevent=\"a,this.type=a.type,this.isDefaultPrevented=a.defaultPrevented||void\" r.event(a,b)},r.event.prototype=\"{constructor:r.Event,isDefaultPrevented:ua,isPropagationStopped:ua,isImmediatePropagationStopped:ua,isSimulated:!1,preventDefault:function(){var\" a=\"this.originalEvent;this.isDefaultPrevented=ta,a&&!this.isSimulated&&a.preventDefault()},stopPropagation:function(){var\" b=\"a.button;return\" null=\"=a.which&&qa.test(a.type)?null!=a.charCode?a.charCode:a.keyCode:!a.which&&void\" c,d=\"this,e=a.relatedTarget,f=a.handleObj;return\" e&&(e=\"==d||r.contains(d,e))||(a.type=f.origType,c=f.handler.apply(this,arguments),a.type=b),c}}}),r.fn.extend({on:function(a,b,c,d){return\" wa(this,a,b,c,d)},one:function(a,b,c,d){return=\"\" wa(this,a,b,c,d,1)},off:function(a,b,c){var=\"\" d,e;if(a&&a.preventdefault&&a.handleobj)return=\"\" d=\"a.handleObj,r(a.delegateTarget).off(d.namespace?d.origType+\".\"+d.namespace:d.origType,d.selector,d.handler),this;if(\"object\"==typeof\" a){for(e=\"\" in=\"\" a)this.off(e,b,a[e]);return=\"\" this}return=\"\" b!=\"=!1&&\"function\"!=typeof\" b||(c=\"b,b=void\" 0),c=\"==!1&&(c=ua),this.each(function(){r.event.remove(this,a,c,b)})}});var\" xa=\"/<(?!area|br|col|embed|hr|img|input|link|meta|param)(([a-z][^\\/\\0\">\\x20\\t\\r\\n\\f]*)[^>]*)\\/>/gi,ya=/<script|<style|<link i,za=\"/checked\\s*(?:[^=]|=\\s*.checked.)/i,Aa=/^true\\/(.*)/,Ba=/^\\s*<!(?:\\[CDATA\\[|--)|(?:\\]\\]|--)\">\\s*$/g;function Ca(a,b){return r.nodeName(a,\"table\")&&r.nodeName(11!==b.nodeType?b:b.firstChild,\"tr\")?a.getElementsByTagName(\"tbody\")[0]||a:a}function Da(a){return a.type=(null!==a.getAttribute(\"type\"))+\"/\"+a.type,a}function Ea(a){var b=Aa.exec(a.type);return b?a.type=b[1]:a.removeAttribute(\"type\"),a}function Fa(a,b){var c,d,e,f,g,h,i,j;if(1===b.nodeType){if(V.hasData(a)&&(f=V.access(a),g=V.set(b,f),j=f.events)){delete g.handle,g.events={};for(e in j)for(c=0,d=j[e].length;c<d;c++)r.event.add(b,e,j[e][c])}w.hasdata(a)&&(h=w.access(a),i=r.extend({},h),w.set(b,i))}}function ga(a,b){var=\"\" c=\"b.nodeName.toLowerCase();\"input\"===c&&ha.test(a.type)?b.checked=a.checked:\"input\"!==c&&\"textarea\"!==c||(b.defaultValue=a.defaultValue)}function\" ha(a,b,c,d){b=\"g.apply([],b);var\" e,f,h,i,j,k,l=\"0,m=a.length,n=m-1,q=b[0],s=r.isFunction(q);if(s||m\">1&&\"string\"==typeof q&&!o.checkClone&&za.test(q))return a.each(function(e){var f=a.eq(e);s&&(b[0]=q.call(this,e,f.html())),Ha(f,b,c,d)});if(m&&(e=oa(b,a[0].ownerDocument,!1,a,d),f=e.firstChild,1===e.childNodes.length&&(e=f),f||d)){for(h=r.map(la(e,\"script\"),Da),i=h.length;l<m;l++)j=e,l!==n&&(j=r.clone(j,!0,!0),i&&r.merge(h,la(j,\"script\"))),c.call(a[l],j,l);if(i)for(k=h[h.length-1].ownerdocument,r.map(h,ea),l=0;l<i;l++)j=h[l],ja.test(j.type||\"\")&&!v.access(j,\"globaleval\")&&r.contains(k,j)&&(j.src?r._evalurl&&r._evalurl(j.src):p(j.textcontent.replace(ba,\"\"),k))}return a}function=\"\" ia(a,b,c){for(var=\"\" d,e=\"b?r.filter(b,a):a,f=0;null!=(d=e[f]);f++)c||1!==d.nodeType||r.cleanData(la(d)),d.parentNode&&(c&&r.contains(d.ownerDocument,d)&&ma(la(d,\"script\")),d.parentNode.removeChild(d));return\" a}r.extend({htmlprefilter:function(a){return=\"\" a.replace(xa,\"<$1=\"\">\")},clone:function(a,b,c){var d,e,f,g,h=a.cloneNode(!0),i=r.contains(a.ownerDocument,a);if(!(o.noCloneChecked||1!==a.nodeType&&11!==a.nodeType||r.isXMLDoc(a)))for(g=la(h),f=la(a),d=0,e=f.length;d<e;d++)ga(f[d],g[d]);if(b)if(c)for(f=f||la(a),g=g||la(h),d=0,e=f.length;d<e;d++)fa(f[d],g[d]);else fa(a,h);return=\"\" g=\"la(h,\"script\"),g.length\">0&&ma(g,!i&&la(a,\"script\")),h},cleanData:function(a){for(var b,c,d,e=r.event.special,f=0;void 0!==(c=a[f]);f++)if(T(c)){if(b=c[V.expando]){if(b.events)for(d in b.events)e[d]?r.event.remove(c,d):r.removeEvent(c,d,b.handle);c[V.expando]=void 0}c[W.expando]&&(c[W.expando]=void 0)}}}),r.fn.extend({detach:function(a){return Ia(this,a,!0)},remove:function(a){return Ia(this,a)},text:function(a){return S(this,function(a){return void 0===a?r.text(this):this.empty().each(function(){1!==this.nodeType&&11!==this.nodeType&&9!==this.nodeType||(this.textContent=a)})},null,a,arguments.length)},append:function(){return Ha(this,arguments,function(a){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var b=Ca(this,a);b.appendChild(a)}})},prepend:function(){return Ha(this,arguments,function(a){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var b=Ca(this,a);b.insertBefore(a,b.firstChild)}})},before:function(){return Ha(this,arguments,function(a){this.parentNode&&this.parentNode.insertBefore(a,this)})},after:function(){return Ha(this,arguments,function(a){this.parentNode&&this.parentNode.insertBefore(a,this.nextSibling)})},empty:function(){for(var a,b=0;null!=(a=this[b]);b++)1===a.nodeType&&(r.cleanData(la(a,!1)),a.textContent=\"\");return this},clone:function(a,b){return a=null!=a&&a,b=null==b?a:b,this.map(function(){return r.clone(this,a,b)})},html:function(a){return S(this,function(a){var b=this[0]||{},c=0,d=this.length;if(void 0===a&&1===b.nodeType)return b.innerHTML;if(\"string\"==typeof a&&!ya.test(a)&&!ka[(ia.exec(a)||[\"\",\"\"])[1].toLowerCase()]){a=r.htmlPrefilter(a);try{for(;c<d;c++)b=this[c]||{},1===b.nodetype&&(r.cleandata(la(b,!1)),b.innerhtml=a);b=0}catch(e){}}b&&this.empty().append(a)},null,a,arguments.length)},replacewith:function(){var 0=\"==c?g&&\"get\"in\" a=\"[];return\" ha(this,arguments,function(b){var=\"\" c=\"this.parentNode;r.inArray(this,a)<0&&(r.cleanData(la(this)),c&&c.replaceChild(b,this))},a)}}),r.each({appendTo:\"append\",prependTo:\"prepend\",insertBefore:\"before\",insertAfter:\"after\",replaceAll:\"replaceWith\"},function(a,b){r.fn[a]=function(a){for(var\" c,d=\"[],e=r(a),f=e.length-1,g=0;g<=f;g++)c=g===f?this:this.clone(!0),r(e[g])[b](c),h.apply(d,c.get());return\" this.pushstack(d)}});var=\"\" ja=\"/^margin/,Ka=new\" regexp(\"^(\"+$+\")(?!px)[a-z%]+$\",\"i\"),la=\"function(b){var\" c&&c.opener||(c=\"a),c.getComputedStyle(b)};!function(){function\" b(){if(i){i.style.csstext=\"box-sizing:border-box;position:relative;display:block;margin:auto;border:1px;padding:1px;top:1%;width:50%\" ,i.innerhtml=\"\" ,pa.appendchild(h);var=\"\" b=\"a.getComputedStyle(i);c=\"1%\"!==b.top,g=\"2px\"===b.marginLeft,e=\"4px\"===b.width,i.style.marginRight=\"50%\",f=\"4px\"===b.marginRight,pa.removeChild(h),i=null}}var\" c,e,f,g,h=\"d.createElement(\"div\"),i=d.createElement(\"div\");i.style&&(i.style.backgroundClip=\"content-box\",i.cloneNode(!0).style.backgroundClip=\"\",o.clearCloneStyle=\"content-box\"===i.style.backgroundClip,h.style.cssText=\"border:0;width:8px;height:0;top:0;left:-9999px;padding:0;margin-top:1px;position:absolute\",h.appendChild(i),r.extend(o,{pixelPosition:function(){return\" b(),c},boxsizingreliable:function(){return=\"\" b(),e},pixelmarginright:function(){return=\"\" b(),f},reliablemarginleft:function(){return=\"\" b(),g}}))}();function=\"\" ma(a,b,c){var=\"\" d,e,f,g,h=\"a.style;return\" 0!=\"=g?g+\"\":g}function\" na(a,b){return{get:function(){return=\"\" a()?void=\"\" delete=\"\" this.get:(this.get=\"b).apply(this,arguments)}}}var\" oa=\"/^(none|table(?!-c[ea]).+)/,Pa={position:\"absolute\",visibility:\"hidden\",display:\"block\"},Qa={letterSpacing:\"0\",fontWeight:\"400\"},Ra=[\"Webkit\",\"Moz\",\"ms\"],Sa=d.createElement(\"div\").style;function\" ta(a){if(a=\"\" in=\"\" sa)return=\"\" a;var=\"\" a}function=\"\" ua(a,b,c){var=\"\" d=\"_.exec(b);return\" d?math.max(0,d[2]-(c||0))+(d[3]||\"px\"):b}function=\"\" va(a,b,c,d,e){for(var=\"\" f=\"c===(d?\"border\":\"content\")?4:\"width\"===b?1:0,g=0;f<4;f+=2)\"margin\"===c&&(g+=r.css(a,c+aa[f],!0,e)),d?(\"content\"===c&&(g-=r.css(a,\"padding\"+aa[f],!0,e)),\"margin\"!==c&&(g-=r.css(a,\"border\"+aa[f]+\"Width\",!0,e))):(g+=r.css(a,\"padding\"+aa[f],!0,e),\"padding\"!==c&&(g+=r.css(a,\"border\"+aa[f]+\"Width\",!0,e)));return\" g}function=\"\" wa(a,b,c){var=\"\" d,e=\"!0,f=La(a),g=\"border-box\"===r.css(a,\"boxSizing\",!1,f);if(a.getClientRects().length&&(d=a.getBoundingClientRect()[b]),d<=0||null==d){if(d=Ma(a,b,f),(d<0||null==d)&&(d=a.style[b]),Ka.test(d))return\" d;e=\"g&&(o.boxSizingReliable()||d===a.style[b]),d=parseFloat(d)||0}return\" d+va(a,b,c||(g?\"border\":\"content\"),e,f)+\"px\"}r.extend({csshooks:{opacity:{get:function(a,b){if(b){var=\"\" e,f,g,h=\"r.camelCase(b),i=a.style;return\" g&&void=\"\" c,\"string\"=\"==f&&(e=_.exec(c))&&e[1]&&(c=da(a,b,e),f=\"number\"),null!=c&&c===c&&(\"number\"===f&&(c+=e&&e[3]||(r.cssNumber[h]?\"\":\"px\")),o.clearCloneStyle||\"\"!==c||0!==b.indexOf(\"background\")||(i[b]=\"inherit\"),g&&\"set\"in\" 0)}},css:function(a,b,c,d){var=\"\" g&&(e=\"g.get(a,!0,c)),void\" qa&&(e=\"Qa[b]),\"\"===c||c?(f=parseFloat(e),c===!0||isFinite(f)?f||0:e):e}}),r.each([\"height\",\"width\"],function(a,b){r.cssHooks[b]={get:function(a,c,d){if(c)return!Oa.test(r.css(a,\"display\"))||a.getClientRects().length&&a.getBoundingClientRect().width?Wa(a,b,d):ca(a,Pa,function(){return\" wa(a,b,d)})},set:function(a,c,d){var=\"\" e,f=\"d&&La(a),g=d&&Va(a,b,d,\"border-box\"===r.css(a,\"boxSizing\",!1,f),f);return\" a.getboundingclientrect().left}))+\"px\"}),r.each({margin:\"\",padding:\"\",border:\"width\"},function(a,b){r.csshooks[a+b]=\"{expand:function(c){for(var\" c?c.split(\"=\"\" \"):[c];d<4;d++)e[a+aa[d]+b]=\"f[d]||f[d-2]||f[0];return\" e}},ja.test(a)||(r.csshooks[a+b].set=\"Ua)}),r.fn.extend({css:function(a,b){return\" s(this,function(a,b,c){var=\"\" d,e,f=\"{},g=0;if(r.isArray(b)){for(d=La(a),e=b.length;g<e;g++)f[b[g]]=r.css(a,b[g],!1,d);return\" f}return=\"\" void=\"\">1)}});function Xa(a,b,c,d,e){return new Xa.prototype.init(a,b,c,d,e)}r.Tween=Xa,Xa.prototype={constructor:Xa,init:function(a,b,c,d,e,f){this.elem=a,this.prop=c,this.easing=e||r.easing._default,this.options=b,this.start=this.now=this.cur(),this.end=d,this.unit=f||(r.cssNumber[c]?\"\":\"px\")},cur:function(){var a=Xa.propHooks[this.prop];return a&&a.get?a.get(this):Xa.propHooks._default.get(this)},run:function(a){var b,c=Xa.propHooks[this.prop];return this.options.duration?this.pos=b=r.easing[this.easing](a,this.options.duration*a,0,1,this.options.duration):this.pos=b=a,this.now=(this.end-this.start)*b+this.start,this.options.step&&this.options.step.call(this.elem,this.now,this),c&&c.set?c.set(this):Xa.propHooks._default.set(this),this}},Xa.prototype.init.prototype=Xa.prototype,Xa.propHooks={_default:{get:function(a){var b;return 1!==a.elem.nodeType||null!=a.elem[a.prop]&&null==a.elem.style[a.prop]?a.elem[a.prop]:(b=r.css(a.elem,a.prop,\"\"),b&&\"auto\"!==b?b:0)},set:function(a){r.fx.step[a.prop]?r.fx.step[a.prop](a):1!==a.elem.nodeType||null==a.elem.style[r.cssProps[a.prop]]&&!r.cssHooks[a.prop]?a.elem[a.prop]=a.now:r.style(a.elem,a.prop,a.now+a.unit)}}},Xa.propHooks.scrollTop=Xa.propHooks.scrollLeft={set:function(a){a.elem.nodeType&&a.elem.parentNode&&(a.elem[a.prop]=a.now)}},r.easing={linear:function(a){return a},swing:function(a){return.5-Math.cos(a*Math.PI)/2},_default:\"swing\"},r.fx=Xa.prototype.init,r.fx.step={};var Ya,Za,$a=/^(?:toggle|show|hide)$/,_a=/queueHooks$/;function ab(){Za&&(a.requestAnimationFrame(ab),r.fx.tick())}function bb(){return a.setTimeout(function(){Ya=void 0}),Ya=r.now()}function cb(a,b){var c,d=0,e={height:a};for(b=b?1:0;d<4;d+=2-b)c=aa[d],e[\"margin\"+c]=e[\"padding\"+c]=a;return 0=\"==q[d])continue;p=!0}n[d]=q&&q[d]||r.style(a,d)}if(i=!r.isEmptyObject(b),i||!r.isEmptyObject(n)){l&&1===a.nodeType&&(c.overflow=[o.overflow,o.overflowX,o.overflowY],j=q&&q.display,null==j&&(j=V.get(a,\"display\")),k=r.css(a,\"display\"),\"none\"===k&&(j?k=j:(ga([a],!0),j=a.style.display||j,k=r.css(a,\"display\"),ga([a]))),(\"inline\"===k||\"inline-block\"===k&&null!=j)&&\"none\"===r.css(a,\"float\")&&(i||(m.done(function(){o.display=j}),null==j&&(k=o.display,j=\"none\"===k?\"\":k)),o.display=\"inline-block\")),c.overflow&&(o.overflow=\"hidden\",m.always(function(){o.overflow=c.overflow[0],o.overflowX=c.overflow[1],o.overflowY=c.overflow[2]})),i=!1;for(d\" b&&(e.opacity=\"e.width=a),e}function\" db(a,b,c){for(var=\"\" d,e=\"(gb.tweeners[b]||[]).concat(gb.tweeners[\"*\"]),f=0,g=e.length;f<g;f++)if(d=e[f].call(c,b,a))return\" d}function=\"\" eb(a,b,c){var=\"\" d,e,f,g,h,i,j,k,l=\"width\" in=\"\" b||\"height\"in=\"\" b,m=\"this,n={},o=a.style,p=a.nodeType&&ba(a),q=V.get(a,\"fxshow\");c.queue||(g=r._queueHooks(a,\"fx\"),null==g.unqueued&&(g.unqueued=0,h=g.empty.fire,g.empty.fire=function(){g.unqueued||h()}),g.unqueued++,m.always(function(){m.always(function(){g.unqueued--,r.queue(a,\"fx\").length||g.empty.fire()})}));for(d\" b)if(e=\"b[d],$a.test(e)){if(delete\" b[d],f=\"f||\"toggle\"===e,e===(p?\"hide\":\"show\")){if(\"show\"!==e||!q||void\" n)i||(q?\"hidden\"in=\"\" q&&(p=\"q.hidden):q=V.access(a,\"fxshow\",{display:j}),f&&(q.hidden=!p),p&&ga([a],!0),m.done(function(){p||ga([a]),V.remove(a,\"fxshow\");for(d\" n)r.style(a,d,n[d])})),i=\"db(p?q[d]:0,d,m),d\" q||(q[d]=\"i.start,p&&(i.end=i.start,i.start=0))}}function\" fb(a,b){var=\"\" c,d,e,f,g;for(c=\"\" a)if(d=\"r.camelCase(c),e=b[d],f=a[c],r.isArray(f)&&(e=f[1],f=a[c]=f[0]),c!==d&&(a[d]=f,delete\" a[c]),g=\"r.cssHooks[d],g&&\"expand\"in\" g){f=\"g.expand(f),delete\" a[d];for(c=\"\" f)c=\"\" a||(a[c]=\"f[c],b[c]=e)}else\" b[d]=\"e}function\" gb(a,b,c){var=\"\" d,e,f=\"0,g=gb.prefilters.length,h=r.Deferred().always(function(){delete\" i.elem}),i=\"function(){if(e)return!1;for(var\" b=\"Ya||bb(),c=Math.max(0,j.startTime+j.duration-b),d=c/j.duration||0,f=1-d,g=0,i=j.tweens.length;g<i;g++)j.tweens[g].run(f);return\" h.notifywith(a,[j,f,c]),f<1&&i?c:(h.resolvewith(a,[j]),!1)},j=\"h.promise({elem:a,props:r.extend({},b),opts:r.extend(!0,{specialEasing:{},easing:r.easing._default},c),originalProperties:b,originalOptions:c,startTime:Ya||bb(),duration:c.duration,tweens:[],createTween:function(b,c){var\" d=\"r.Tween(a,j.opts,b,c,j.opts.specialEasing[b]||j.opts.easing);return\" j.tweens.push(d),d},stop:function(b){var=\"\" c=\"0,d=b?j.tweens.length:0;if(e)return\" this;for(e=\"!0;c<d;c++)j.tweens[c].run(1);return\" b?(h.notifywith(a,[j,1,0]),h.resolvewith(a,[j,b])):h.rejectwith(a,[j,b]),this}}),k=\"j.props;for(fb(k,j.opts.specialEasing);f<g;f++)if(d=gb.prefilters[f].call(j,a,k,j.opts))return\" r.isfunction(d.stop)&&(r._queuehooks(j.elem,j.opts.queue).stop=\"r.proxy(d.stop,d)),d;return\" r.map(k,db,j),r.isfunction(j.opts.start)&&j.opts.start.call(a,j),r.fx.timer(r.extend(i,{elem:a,anim:j,queue:j.opts.queue})),j.progress(j.opts.progress).done(j.opts.done,j.opts.complete).fail(j.opts.fail).always(j.opts.always)}r.animation=\"r.extend(gb,{tweeners:{\"*\":[function(a,b){var\" da(c.elem,a,_.exec(b),c),c}]},tweener:function(a,b){r.isfunction(a)?(b=\"a,a=[\"*\"]):a=a.match(K);for(var\" c,d=\"0,e=a.length;d<e;d++)c=a[d],gb.tweeners[c]=gb.tweeners[c]||[],gb.tweeners[c].unshift(b)},prefilters:[eb],prefilter:function(a,b){b?gb.prefilters.unshift(a):gb.prefilters.push(a)}}),r.speed=function(a,b,c){var\" e=\"a&&\"object\"==typeof\" a?r.extend({},a):{complete:c||!c&&b||r.isfunction(a)&&a,duration:a,easing:c&&b||b&&!r.isfunction(b)&&b};return=\"\" r.fx.off||d.hidden?e.duration=\"0:e.duration=\"number\"==typeof\" e.duration?e.duration:e.duration=\"\" r.fx.speeds?r.fx.speeds[e.duration]:r.fx.speeds._default,null!=\"e.queue&&e.queue!==!0||(e.queue=\"fx\"),e.old=e.complete,e.complete=function(){r.isFunction(e.old)&&e.old.call(this),e.queue&&r.dequeue(this,e.queue)},e},r.fn.extend({fadeTo:function(a,b,c,d){return\" this.filter(ba).css(\"opacity\",0).show().end().animate({opacity:b},a,c,d)},animate:function(a,b,c,d){var=\"\" g.finish=\"g,e||f.queue===!1?this.each(g):this.queue(f.queue,g)},stop:function(a,b,c){var\" a.stop,b(c)};return\"string\"!=\"typeof\" a&&(c=\"b,b=a,a=void\" 0),b&&a!=\"=!1&&this.queue(a||\"fx\",[]),this.each(function(){var\" for(e=\"\" g)g[e]&&g[e].stop&&_a.test(e)&&d(g[e]);for(e=\"f.length;e--;)f[e].elem!==this||null!=a&&f[e].queue!==a||(f[e].anim.stop(c),b=!1,f.splice(e,1));!b&&c||r.dequeue(this,a)})},finish:function(a){return\" a!=\"=!1&&(a=a||\"fx\"),this.each(function(){var\" b,c=\"V.get(this),d=c[a+\"queue\"],e=c[a+\"queueHooks\"],f=r.timers,g=d?d.length:0;for(c.finish=!0,r.queue(this,a,[]),e&&e.stop&&e.stop.call(this,!0),b=f.length;b--;)f[b].elem===this&&f[b].queue===a&&(f[b].anim.stop(!0),f.splice(b,1));for(b=0;b<g;b++)d[b]&&d[b].finish&&d[b].finish.call(this);delete\" c.finish})}}),r.each([\"toggle\",\"show\",\"hide\"],function(a,b){var=\"\" null=\"=a||\"boolean\"==typeof\" a?c.apply(this,arguments):this.animate(cb(b,!0),a,d,e)}}),r.each({slidedown:cb(\"show\"),slideup:cb(\"hide\"),slidetoggle:cb(\"toggle\"),fadein:{opacity:\"show\"},fadeout:{opacity:\"hide\"},fadetoggle:{opacity:\"toggle\"}},function(a,b){r.fn[a]=\"function(a,c,d){return\" this.animate(b,a,c,d)}}),r.timers=\"[],r.fx.tick=function(){var\" a,b=\"0,c=r.timers;for(Ya=r.now();b<c.length;b++)a=c[b],a()||c[b]!==a||c.splice(b--,1);c.length||r.fx.stop(),Ya=void\" 0},r.fx.timer=\"function(a){r.timers.push(a),a()?r.fx.start():r.timers.pop()},r.fx.interval=13,r.fx.start=function(){Za||(Za=a.requestAnimationFrame?a.requestAnimationFrame(ab):a.setInterval(r.fx.tick,r.fx.interval))},r.fx.stop=function(){a.cancelAnimationFrame?a.cancelAnimationFrame(Za):a.clearInterval(Za),Za=null},r.fx.speeds={slow:600,fast:200,_default:400},r.fn.delay=function(b,c){return\" a=\"d.createElement(\"input\"),b=d.createElement(\"select\"),c=b.appendChild(d.createElement(\"option\"));a.type=\"checkbox\",o.checkOn=\"\"!==a.value,o.optSelected=c.selected,a=d.createElement(\"input\"),a.value=\"t\",a.type=\"radio\",o.radioValue=\"t\"===a.value}();var\" hb,ib=\"r.expr.attrHandle;r.fn.extend({attr:function(a,b){return\" s(this,r.attr,a,b,arguments.length=\"\">1)},removeAttr:function(a){return this.each(function(){r.removeAttr(this,a)})}}),r.extend({attr:function(a,b,c){var d,e,f=a.nodeType;if(3!==f&&8!==f&&2!==f)return\"undefined\"==typeof a.getAttribute?r.prop(a,b,c):(1===f&&r.isXMLDoc(a)||(e=r.attrHooks[b.toLowerCase()]||(r.expr.match.bool.test(b)?hb:void 0)),void 0!==c?null===c?void r.removeAttr(a,b):e&&\"set\"in e&&void 0!==(d=e.set(a,c,b))?d:(a.setAttribute(b,c+\"\"),c):e&&\"get\"in e&&null!==(d=e.get(a,b))?d:(d=r.find.attr(a,b),null==d?void 0:d))},attrHooks:{type:{set:function(a,b){if(!o.radioValue&&\"radio\"===b&&r.nodeName(a,\"input\")){var c=a.value;return a.setAttribute(\"type\",b),c&&(a.value=c),b}}}},removeAttr:function(a,b){var c,d=0,e=b&&b.match(K);\nif(e&&1===a.nodeType)while(c=e[d++])a.removeAttribute(c)}}),hb={set:function(a,b,c){return b===!1?r.removeAttr(a,c):a.setAttribute(c,c),c}},r.each(r.expr.match.bool.source.match(/\\w+/g),function(a,b){var c=ib[b]||r.find.attr;ib[b]=function(a,b,d){var e,f,g=b.toLowerCase();return d||(f=ib[g],ib[g]=e,e=null!=c(a,b,d)?g:null,ib[g]=f),e}});var jb=/^(?:input|select|textarea|button)$/i,kb=/^(?:a|area)$/i;r.fn.extend({prop:function(a,b){return S(this,r.prop,a,b,arguments.length>1)},removeProp:function(a){return this.each(function(){delete this[r.propFix[a]||a]})}}),r.extend({prop:function(a,b,c){var d,e,f=a.nodeType;if(3!==f&&8!==f&&2!==f)return 1===f&&r.isXMLDoc(a)||(b=r.propFix[b]||b,e=r.propHooks[b]),void 0!==c?e&&\"set\"in e&&void 0!==(d=e.set(a,c,b))?d:a[b]=c:e&&\"get\"in e&&null!==(d=e.get(a,b))?d:a[b]},propHooks:{tabIndex:{get:function(a){var b=r.find.attr(a,\"tabindex\");return b?parseInt(b,10):jb.test(a.nodeName)||kb.test(a.nodeName)&&a.href?0:-1}}},propFix:{\"for\":\"htmlFor\",\"class\":\"className\"}}),o.optSelected||(r.propHooks.selected={get:function(a){var b=a.parentNode;return b&&b.parentNode&&b.parentNode.selectedIndex,null},set:function(a){var b=a.parentNode;b&&(b.selectedIndex,b.parentNode&&b.parentNode.selectedIndex)}}),r.each([\"tabIndex\",\"readOnly\",\"maxLength\",\"cellSpacing\",\"cellPadding\",\"rowSpan\",\"colSpan\",\"useMap\",\"frameBorder\",\"contentEditable\"],function(){r.propFix[this.toLowerCase()]=this});var lb=/[\\t\\r\\n\\f]/g;function mb(a){return a.getAttribute&&a.getAttribute(\"class\")||\"\"}r.fn.extend({addClass:function(a){var b,c,d,e,f,g,h,i=0;if(r.isFunction(a))return this.each(function(b){r(this).addClass(a.call(this,b,mb(this)))});if(\"string\"==typeof a&&a){b=a.match(K)||[];while(c=this[i++])if(e=mb(c),d=1===c.nodeType&&(\" \"+e+\" \").replace(lb,\" \")){g=0;while(f=b[g++])d.indexOf(\" \"+f+\" \")<0&&(d+=f+\" \");h=\"r.trim(d),e!==h&&c.setAttribute(\"class\",h)}}return\" this},removeclass:function(a){var=\"\" b,c,d,e,f,g,h,i=\"0;if(r.isFunction(a))return\" this.each(function(b){r(this).removeclass(a.call(this,b,mb(this)))});if(!arguments.length)return=\"\" this.attr(\"class\",\"\");if(\"string\"=\"=typeof\" a&&a){b=\"a.match(K)||[];while(c=this[i++])if(e=mb(c),d=1===c.nodeType&&(\"\" \"+e+\"=\"\" \").replace(lb,\"=\"\" \")){g=\"0;while(f=b[g++])while(d.indexOf(\"\" \"+f+\"=\"\" \")=\"\">-1)d=d.replace(\" \"+f+\" \",\" \");h=r.trim(d),e!==h&&c.setAttribute(\"class\",h)}}return this},toggleClass:function(a,b){var c=typeof a;return\"boolean\"==typeof b&&\"string\"===c?b?this.addClass(a):this.removeClass(a):r.isFunction(a)?this.each(function(c){r(this).toggleClass(a.call(this,c,mb(this),b),b)}):this.each(function(){var b,d,e,f;if(\"string\"===c){d=0,e=r(this),f=a.match(K)||[];while(b=f[d++])e.hasClass(b)?e.removeClass(b):e.addClass(b)}else void 0!==a&&\"boolean\"!==c||(b=mb(this),b&&V.set(this,\"__className__\",b),this.setAttribute&&this.setAttribute(\"class\",b||a===!1?\"\":V.get(this,\"__className__\")||\"\"))})},hasClass:function(a){var b,c,d=0;b=\" \"+a+\" \";while(c=this[d++])if(1===c.nodeType&&(\" \"+mb(c)+\" \").replace(lb,\" \").indexOf(b)>-1)return!0;return!1}});var nb=/\\r/g,ob=/[\\x20\\t\\r\\n\\f]+/g;r.fn.extend({val:function(a){var b,c,d,e=this[0];{if(arguments.length)return d=r.isFunction(a),this.each(function(c){var e;1===this.nodeType&&(e=d?a.call(this,c,r(this).val()):a,null==e?e=\"\":\"number\"==typeof e?e+=\"\":r.isArray(e)&&(e=r.map(e,function(a){return null==a?\"\":a+\"\"})),b=r.valHooks[this.type]||r.valHooks[this.nodeName.toLowerCase()],b&&\"set\"in b&&void 0!==b.set(this,e,\"value\")||(this.value=e))});if(e)return b=r.valHooks[e.type]||r.valHooks[e.nodeName.toLowerCase()],b&&\"get\"in b&&void 0!==(c=b.get(e,\"value\"))?c:(c=e.value,\"string\"==typeof c?c.replace(nb,\"\"):null==c?\"\":c)}}}),r.extend({valHooks:{option:{get:function(a){var b=r.find.attr(a,\"value\");return null!=b?b:r.trim(r.text(a)).replace(ob,\" \")}},select:{get:function(a){for(var b,c,d=a.options,e=a.selectedIndex,f=\"select-one\"===a.type,g=f?null:[],h=f?e+1:d.length,i=e<0?h:f?e:0;i<h;i++)if(c=d[i],(c.selected||i===e)&&!c.disabled&&(!c.parentnode.disabled||!r.nodename(c.parentnode,\"optgroup\"))){if(b=r(c).val(),f)return b;g.push(b)}return=\"\" g},set:function(a,b){var=\"\" c,d,e=\"a.options,f=r.makeArray(b),g=e.length;while(g--)d=e[g],(d.selected=r.inArray(r.valHooks.option.get(d),f)\">-1)&&(c=!0);return c||(a.selectedIndex=-1),f}}}}),r.each([\"radio\",\"checkbox\"],function(){r.valHooks[this]={set:function(a,b){if(r.isArray(b))return a.checked=r.inArray(r(a).val(),b)>-1}},o.checkOn||(r.valHooks[this].get=function(a){return null===a.getAttribute(\"value\")?\"on\":a.value})});var pb=/^(?:focusinfocus|focusoutblur)$/;r.extend(r.event,{trigger:function(b,c,e,f){var g,h,i,j,k,m,n,o=[e||d],p=l.call(b,\"type\")?b.type:b,q=l.call(b,\"namespace\")?b.namespace.split(\".\"):[];if(h=i=e=e||d,3!==e.nodeType&&8!==e.nodeType&&!pb.test(p+r.event.triggered)&&(p.indexOf(\".\")>-1&&(q=p.split(\".\"),p=q.shift(),q.sort()),k=p.indexOf(\":\")<0&&\"on\"+p,b=b[r.expando]?b:new r.event(p,\"object\"=\"=typeof\" b&&b),b.istrigger=\"f?2:3,b.namespace=q.join(\".\"),b.rnamespace=b.namespace?new\" regexp(\"(^|\\\\.)\"+q.join(\"\\\\.(?:.*\\\\.|)\")+\"(\\\\.|$)\"):null,b.result=\"void\" 0,b.target||(b.target=\"e),c=null==c?[b]:r.makeArray(c,[b]),n=r.event.special[p]||{},f||!n.trigger||n.trigger.apply(e,c)!==!1)){if(!f&&!n.noBubble&&!r.isWindow(e)){for(j=n.delegateType||p,pb.test(j+p)||(h=h.parentNode);h;h=h.parentNode)o.push(h),i=h;i===(e.ownerDocument||d)&&o.push(i.defaultView||i.parentWindow||a)}g=0;while((h=o[g++])&&!b.isPropagationStopped())b.type=g\">1?j:n.bindType||p,m=(V.get(h,\"events\")||{})[b.type]&&V.get(h,\"handle\"),m&&m.apply(h,c),m=k&&h[k],m&&m.apply&&T(h)&&(b.result=m.apply(h,c),b.result===!1&&b.preventDefault());return b.type=p,f||b.isDefaultPrevented()||n._default&&n._default.apply(o.pop(),c)!==!1||!T(e)||k&&r.isFunction(e[p])&&!r.isWindow(e)&&(i=e[k],i&&(e[k]=null),r.event.triggered=p,e[p](),r.event.triggered=void 0,i&&(e[k]=i)),b.result}},simulate:function(a,b,c){var d=r.extend(new r.Event,c,{type:a,isSimulated:!0});r.event.trigger(d,null,b)}}),r.fn.extend({trigger:function(a,b){return this.each(function(){r.event.trigger(a,b,this)})},triggerHandler:function(a,b){var c=this[0];if(c)return r.event.trigger(a,b,c,!0)}}),r.each(\"blur focus focusin focusout resize scroll click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup contextmenu\".split(\" \"),function(a,b){r.fn[b]=function(a,c){return arguments.length>0?this.on(b,null,a,c):this.trigger(b)}}),r.fn.extend({hover:function(a,b){return this.mouseenter(a).mouseleave(b||a)}}),o.focusin=\"onfocusin\"in a,o.focusin||r.each({focus:\"focusin\",blur:\"focusout\"},function(a,b){var c=function(a){r.event.simulate(b,a.target,r.event.fix(a))};r.event.special[b]={setup:function(){var d=this.ownerDocument||this,e=V.access(d,b);e||d.addEventListener(a,c,!0),V.access(d,b,(e||0)+1)},teardown:function(){var d=this.ownerDocument||this,e=V.access(d,b)-1;e?V.access(d,b,e):(d.removeEventListener(a,c,!0),V.remove(d,b))}}});var qb=a.location,rb=r.now(),sb=/\\?/;r.parseXML=function(b){var c;if(!b||\"string\"!=typeof b)return null;try{c=(new a.DOMParser).parseFromString(b,\"text/xml\")}catch(d){c=void 0}return c&&!c.getElementsByTagName(\"parsererror\").length||r.error(\"Invalid XML: \"+b),c};var tb=/\\[\\]$/,ub=/\\r?\\n/g,vb=/^(?:submit|button|image|reset|file)$/i,wb=/^(?:input|select|textarea|keygen)/i;function xb(a,b,c,d){var e;if(r.isArray(b))r.each(b,function(b,e){c||tb.test(a)?d(a,e):xb(a+\"[\"+(\"object\"==typeof e&&null!=e?b:\"\")+\"]\",e,c,d)});else if(c||\"object\"!==r.type(b))d(a,b);else for(e in b)xb(a+\"[\"+e+\"]\",b[e],c,d)}r.param=function(a,b){var c,d=[],e=function(a,b){var c=r.isFunction(b)?b():b;d[d.length]=encodeURIComponent(a)+\"=\"+encodeURIComponent(null==c?\"\":c)};if(r.isArray(a)||a.jquery&&!r.isPlainObject(a))r.each(a,function(){e(this.name,this.value)});else for(c in a)xb(c,a[c],b,e);return d.join(\"&\")},r.fn.extend({serialize:function(){return r.param(this.serializeArray())},serializeArray:function(){return this.map(function(){var a=r.prop(this,\"elements\");return a?r.makeArray(a):this}).filter(function(){var a=this.type;return this.name&&!r(this).is(\":disabled\")&&wb.test(this.nodeName)&&!vb.test(a)&&(this.checked||!ha.test(a))}).map(function(a,b){var c=r(this).val();return null==c?null:r.isArray(c)?r.map(c,function(a){return{name:b.name,value:a.replace(ub,\"\\r\\n\")}}):{name:b.name,value:c.replace(ub,\"\\r\\n\")}}).get()}});var yb=/%20/g,zb=/#.*$/,Ab=/([?&])_=[^&]*/,Bb=/^(.*?):[ \\t]*([^\\r\\n]*)$/gm,Cb=/^(?:about|app|app-storage|.+-extension|file|res|widget):$/,Db=/^(?:GET|HEAD)$/,Eb=/^\\/\\//,Fb={},Gb={},Hb=\"*/\".concat(\"*\"),Ib=d.createElement(\"a\");Ib.href=qb.href;function Jb(a){return function(b,c){\"string\"!=typeof b&&(c=b,b=\"*\");var d,e=0,f=b.toLowerCase().match(K)||[];if(r.isFunction(c))while(d=f[e++])\"+\"===d[0]?(d=d.slice(1)||\"*\",(a[d]=a[d]||[]).unshift(c)):(a[d]=a[d]||[]).push(c)}}function Kb(a,b,c,d){var e={},f=a===Gb;function g(h){var i;return e[h]=!0,r.each(a[h]||[],function(a,h){var j=h(b,c,d);return\"string\"!=typeof j||f||e[j]?f?!(i=j):void 0:(b.dataTypes.unshift(j),g(j),!1)}),i}return g(b.dataTypes[0])||!e[\"*\"]&&g(\"*\")}function Lb(a,b){var c,d,e=r.ajaxSettings.flatOptions||{};for(c in b)void 0!==b[c]&&((e[c]?a:d||(d={}))[c]=b[c]);return d&&r.extend(!0,a,d),a}function Mb(a,b,c){var d,e,f,g,h=a.contents,i=a.dataTypes;while(\"*\"===i[0])i.shift(),void 0===d&&(d=a.mimeType||b.getResponseHeader(\"Content-Type\"));if(d)for(e in h)if(h[e]&&h[e].test(d)){i.unshift(e);break}if(i[0]in c)f=i[0];else{for(e in c){if(!i[0]||a.converters[e+\" \"+i[0]]){f=e;break}g||(g=e)}f=f||g}if(f)return f!==i[0]&&i.unshift(f),c[f]}function Nb(a,b,c,d){var e,f,g,h,i,j={},k=a.dataTypes.slice();if(k[1])for(g in a.converters)j[g.toLowerCase()]=a.converters[g];f=k.shift();while(f)if(a.responseFields[f]&&(c[a.responseFields[f]]=b),!i&&d&&a.dataFilter&&(b=a.dataFilter(b,a.dataType)),i=f,f=k.shift())if(\"*\"===f)f=i;else if(\"*\"!==i&&i!==f){if(g=j[i+\" \"+f]||j[\"* \"+f],!g)for(e in j)if(h=e.split(\" \"),h[1]===f&&(g=j[i+\" \"+h[0]]||j[\"* \"+h[0]])){g===!0?g=j[e]:j[e]!==!0&&(f=h[0],k.unshift(h[1]));break}if(g!==!0)if(g&&a[\"throws\"])b=g(b);else try{b=g(b)}catch(l){return{state:\"parsererror\",error:g?l:\"No conversion from \"+i+\" to \"+f}}}return{state:\"success\",data:b}}r.extend({active:0,lastModified:{},etag:{},ajaxSettings:{url:qb.href,type:\"GET\",isLocal:Cb.test(qb.protocol),global:!0,processData:!0,async:!0,contentType:\"application/x-www-form-urlencoded; charset=UTF-8\",accepts:{\"*\":Hb,text:\"text/plain\",html:\"text/html\",xml:\"application/xml, text/xml\",json:\"application/json, text/javascript\"},contents:{xml:/\\bxml\\b/,html:/\\bhtml/,json:/\\bjson\\b/},responseFields:{xml:\"responseXML\",text:\"responseText\",json:\"responseJSON\"},converters:{\"* text\":String,\"text html\":!0,\"text json\":JSON.parse,\"text xml\":r.parseXML},flatOptions:{url:!0,context:!0}},ajaxSetup:function(a,b){return b?Lb(Lb(a,r.ajaxSettings),b):Lb(r.ajaxSettings,a)},ajaxPrefilter:Jb(Fb),ajaxTransport:Jb(Gb),ajax:function(b,c){\"object\"==typeof b&&(c=b,b=void 0),c=c||{};var e,f,g,h,i,j,k,l,m,n,o=r.ajaxSetup({},c),p=o.context||o,q=o.context&&(p.nodeType||p.jquery)?r(p):r.event,s=r.Deferred(),t=r.Callbacks(\"once memory\"),u=o.statusCode||{},v={},w={},x=\"canceled\",y={readyState:0,getResponseHeader:function(a){var b;if(k){if(!h){h={};while(b=Bb.exec(g))h[b[1].toLowerCase()]=b[2]}b=h[a.toLowerCase()]}return null==b?null:b},getAllResponseHeaders:function(){return k?g:null},setRequestHeader:function(a,b){return null==k&&(a=w[a.toLowerCase()]=w[a.toLowerCase()]||a,v[a]=b),this},overrideMimeType:function(a){return null==k&&(o.mimeType=a),this},statusCode:function(a){var b;if(a)if(k)y.always(a[y.status]);else for(b in a)u[b]=[u[b],a[b]];return this},abort:function(a){var b=a||x;return e&&e.abort(b),A(0,b),this}};if(s.promise(y),o.url=((b||o.url||qb.href)+\"\").replace(Eb,qb.protocol+\"//\"),o.type=c.method||c.type||o.method||o.type,o.dataTypes=(o.dataType||\"*\").toLowerCase().match(K)||[\"\"],null==o.crossDomain){j=d.createElement(\"a\");try{j.href=o.url,j.href=j.href,o.crossDomain=Ib.protocol+\"//\"+Ib.host!=j.protocol+\"//\"+j.host}catch(z){o.crossDomain=!0}}if(o.data&&o.processData&&\"string\"!=typeof o.data&&(o.data=r.param(o.data,o.traditional)),Kb(Fb,o,c,y),k)return y;l=r.event&&o.global,l&&0===r.active++&&r.event.trigger(\"ajaxStart\"),o.type=o.type.toUpperCase(),o.hasContent=!Db.test(o.type),f=o.url.replace(zb,\"\"),o.hasContent?o.data&&o.processData&&0===(o.contentType||\"\").indexOf(\"application/x-www-form-urlencoded\")&&(o.data=o.data.replace(yb,\"+\")):(n=o.url.slice(f.length),o.data&&(f+=(sb.test(f)?\"&\":\"?\")+o.data,delete o.data),o.cache===!1&&(f=f.replace(Ab,\"\"),n=(sb.test(f)?\"&\":\"?\")+\"_=\"+rb++ +n),o.url=f+n),o.ifModified&&(r.lastModified[f]&&y.setRequestHeader(\"If-Modified-Since\",r.lastModified[f]),r.etag[f]&&y.setRequestHeader(\"If-None-Match\",r.etag[f])),(o.data&&o.hasContent&&o.contentType!==!1||c.contentType)&&y.setRequestHeader(\"Content-Type\",o.contentType),y.setRequestHeader(\"Accept\",o.dataTypes[0]&&o.accepts[o.dataTypes[0]]?o.accepts[o.dataTypes[0]]+(\"*\"!==o.dataTypes[0]?\", \"+Hb+\"; q=0.01\":\"\"):o.accepts[\"*\"]);for(m in o.headers)y.setRequestHeader(m,o.headers[m]);if(o.beforeSend&&(o.beforeSend.call(p,y,o)===!1||k))return y.abort();if(x=\"abort\",t.add(o.complete),y.done(o.success),y.fail(o.error),e=Kb(Gb,o,c,y)){if(y.readyState=1,l&&q.trigger(\"ajaxSend\",[y,o]),k)return y;o.async&&o.timeout>0&&(i=a.setTimeout(function(){y.abort(\"timeout\")},o.timeout));try{k=!1,e.send(v,A)}catch(z){if(k)throw z;A(-1,z)}}else A(-1,\"No Transport\");function A(b,c,d,h){var j,m,n,v,w,x=c;k||(k=!0,i&&a.clearTimeout(i),e=void 0,g=h||\"\",y.readyState=b>0?4:0,j=b>=200&&b<300||304===b,d&&(v=mb(o,y,d)),v=nb(o,v,y,j),j?(o.ifmodified&&(w=y.getresponseheader(\"last-modified\"),w&&(r.lastmodified[f]=w),w=y.getresponseheader(\"etag\"),w&&(r.etag[f]=w)),204===b||\"head\"===o.type?x=\"nocontent\":304===b?x=\"notmodified\":(x=v.state,m=v.data,n=v.error,j=!n)):(n=x,!b&&x||(x=\"error\",b<0&&(b=0))),y.status=b,y.statustext=(c||x)+\"\",j?s.resolvewith(p,[m,x,y]):s.rejectwith(p,[y,x,n]),y.statuscode(u),u=void 0=\"==a.cache&&(a.cache=!1),a.crossDomain&&(a.type=\"GET\")}),r.ajaxTransport(\"script\",function(a){if(a.crossDomain){var\" 0,l&&q.trigger(j?\"ajaxsuccess\":\"ajaxerror\",[y,o,j?m:n]),t.firewith(p,[y,x]),l&&(q.trigger(\"ajaxcomplete\",[y,o]),--r.active||r.event.trigger(\"ajaxstop\")))}return=\"\" y},getjson:function(a,b,c){return=\"\" r.get(a,b,c,\"json\")},getscript:function(a,b){return=\"\" r.get(a,void=\"\" 0,b,\"script\")}}),r.each([\"get\",\"post\"],function(a,b){r[b]=\"function(a,c,d,e){return\" r.isfunction(c)&&(e=\"e||d,d=c,c=void\" 0),r.ajax(r.extend({url:a,type:b,datatype:e,data:c,success:d},r.isplainobject(a)&&a))}}),r._evalurl=\"function(a){return\" r.ajax({url:a,type:\"get\",datatype:\"script\",cache:!0,async:!1,global:!1,\"throws\":!0})},r.fn.extend({wrapall:function(a){var=\"\" b;return=\"\" this[0]&&(r.isfunction(a)&&(a=\"a.call(this[0])),b=r(a,this[0].ownerDocument).eq(0).clone(!0),this[0].parentNode&&b.insertBefore(this[0]),b.map(function(){var\" a=\"this;while(a.firstElementChild)a=a.firstElementChild;return\" a}).append(this)),this},wrapinner:function(a){return=\"\" r.isfunction(a)?this.each(function(b){r(this).wrapinner(a.call(this,b))}):this.each(function(){var=\"\" b=\"r(this),c=b.contents();c.length?c.wrapAll(a):b.append(a)})},wrap:function(a){var\" this.each(function(c){r(this).wrapall(b?a.call(this,c):a)})},unwrap:function(a){return=\"\" this.parent(a).not(\"body\").each(function(){r(this).replacewith(this.childnodes)}),this}}),r.expr.pseudos.hidden=\"function(a){return!r.expr.pseudos.visible(a)},r.expr.pseudos.visible=function(a){return!!(a.offsetWidth||a.offsetHeight||a.getClientRects().length)},r.ajaxSettings.xhr=function(){try{return\" new=\"\" a.xmlhttprequest}catch(b){}};var=\"\" ob=\"{0:200,1223:204},Pb=r.ajaxSettings.xhr();o.cors=!!Pb&&\"withCredentials\"in\" pb,o.ajax=\"Pb=!!Pb,r.ajaxTransport(function(b){var\" c,d;if(o.cors||pb&&!b.crossdomain)return{send:function(e,f){var=\"\" g,h=\"b.xhr();if(h.open(b.type,b.url,b.async,b.username,b.password),b.xhrFields)for(g\" in=\"\" b.xhrfields)h[g]=\"b.xhrFields[g];b.mimeType&&h.overrideMimeType&&h.overrideMimeType(b.mimeType),b.crossDomain||e[\"X-Requested-With\"]||(e[\"X-Requested-With\"]=\"XMLHttpRequest\");for(g\" e)h.setrequestheader(g,e[g]);c=\"function(a){return\" function(){c&&(c=\"d=h.onload=h.onerror=h.onabort=h.onreadystatechange=null,\"abort\"===a?h.abort():\"error\"===a?\"number\"!=typeof\" h.status?f(0,\"error\"):f(h.status,h.statustext):f(ob[h.status]||h.status,h.statustext,\"text\"!=\"=(h.responseType||\"text\")||\"string\"!=typeof\" h.responsetext?{binary:h.response}:{text:h.responsetext},h.getallresponseheaders()))}},h.onload=\"c(),d=h.onerror=c(\"error\"),void\" 0!=\"=h.onabort?h.onabort=d:h.onreadystatechange=function(){4===h.readyState&&a.setTimeout(function(){c&&d()})},c=c(\"abort\");try{h.send(b.hasContent&&b.data||null)}catch(i){if(c)throw\" i}},abort:function(){c&&c()}}}),r.ajaxprefilter(function(a){a.crossdomain&&(a.contents.script=\"!1)}),r.ajaxSetup({accepts:{script:\"text/javascript,\" application=\"\" javascript,=\"\" ecmascript,=\"\" x-ecmascript\"},contents:{script:=\"\" \\b(?:java|ecma)script\\b=\"\" },converters:{\"text=\"\" script\":function(a){return=\"\" r.globaleval(a),a}}}),r.ajaxprefilter(\"script\",function(a){void=\"\" b,c;return{send:function(e,f){b=\"r(\"<script\">\").prop({charset:a.scriptCharset,src:a.url}).on(\"load error\",c=function(a){b.remove(),c=null,a&&f(\"error\"===a.type?404:200,a.type)}),d.head.appendChild(b[0])},abort:function(){c&&c()}}}});var Qb=[],Rb=/(=)\\?(?=&|$)|\\?\\?/;r.ajaxSetup({jsonp:\"callback\",jsonpCallback:function(){var a=Qb.pop()||r.expando+\"_\"+rb++;return this[a]=!0,a}}),r.ajaxPrefilter(\"json jsonp\",function(b,c,d){var e,f,g,h=b.jsonp!==!1&&(Rb.test(b.url)?\"url\":\"string\"==typeof b.data&&0===(b.contentType||\"\").indexOf(\"application/x-www-form-urlencoded\")&&Rb.test(b.data)&&\"data\");if(h||\"jsonp\"===b.dataTypes[0])return e=b.jsonpCallback=r.isFunction(b.jsonpCallback)?b.jsonpCallback():b.jsonpCallback,h?b[h]=b[h].replace(Rb,\"$1\"+e):b.jsonp!==!1&&(b.url+=(sb.test(b.url)?\"&\":\"?\")+b.jsonp+\"=\"+e),b.converters[\"script json\"]=function(){return g||r.error(e+\" was not called\"),g[0]},b.dataTypes[0]=\"json\",f=a[e],a[e]=function(){g=arguments},d.always(function(){void 0===f?r(a).removeProp(e):a[e]=f,b[e]&&(b.jsonpCallback=c.jsonpCallback,Qb.push(e)),g&&r.isFunction(f)&&f(g[0]),g=f=void 0}),\"script\"}),o.createHTMLDocument=function(){var a=d.implementation.createHTMLDocument(\"\").body;return a.innerHTML=\"<form></form><form></form>\",2===a.childNodes.length}(),r.parseHTML=function(a,b,c){if(\"string\"!=typeof a)return[];\"boolean\"==typeof b&&(c=b,b=!1);var e,f,g;return b||(o.createHTMLDocument?(b=d.implementation.createHTMLDocument(\"\"),e=b.createElement(\"base\"),e.href=d.location.href,b.head.appendChild(e)):b=d),f=B.exec(a),g=!c&&[],f?[b.createElement(f[1])]:(f=oa([a],b,g),g&&g.length&&r(g).remove(),r.merge([],f.childNodes))},r.fn.load=function(a,b,c){var d,e,f,g=this,h=a.indexOf(\" \");return h>-1&&(d=r.trim(a.slice(h)),a=a.slice(0,h)),r.isFunction(b)?(c=b,b=void 0):b&&\"object\"==typeof b&&(e=\"POST\"),g.length>0&&r.ajax({url:a,type:e||\"GET\",dataType:\"html\",data:b}).done(function(a){f=arguments,g.html(d?r(\"<div>\").append(r.parseHTML(a)).find(d):a)}).always(c&&function(a,b){g.each(function(){c.apply(this,f||[a.responseText,b,a])})}),this},r.each([\"ajaxStart\",\"ajaxStop\",\"ajaxComplete\",\"ajaxError\",\"ajaxSuccess\",\"ajaxSend\"],function(a,b){r.fn[b]=function(a){return this.on(b,a)}}),r.expr.pseudos.animated=function(a){return r.grep(r.timers,function(b){return a===b.elem}).length};function Sb(a){return r.isWindow(a)?a:9===a.nodeType&&a.defaultView}r.offset={setOffset:function(a,b,c){var d,e,f,g,h,i,j,k=r.css(a,\"position\"),l=r(a),m={};\"static\"===k&&(a.style.position=\"relative\"),h=l.offset(),f=r.css(a,\"top\"),i=r.css(a,\"left\"),j=(\"absolute\"===k||\"fixed\"===k)&&(f+i).indexOf(\"auto\")>-1,j?(d=l.position(),g=d.top,e=d.left):(g=parseFloat(f)||0,e=parseFloat(i)||0),r.isFunction(b)&&(b=b.call(a,c,r.extend({},h))),null!=b.top&&(m.top=b.top-h.top+g),null!=b.left&&(m.left=b.left-h.left+e),\"using\"in b?b.using.call(a,m):l.css(m)}},r.fn.extend({offset:function(a){if(arguments.length)return void 0===a?this:this.each(function(b){r.offset.setOffset(this,a,b)});var b,c,d,e,f=this[0];if(f)return f.getClientRects().length?(d=f.getBoundingClientRect(),d.width||d.height?(e=f.ownerDocument,c=Sb(e),b=e.documentElement,{top:d.top+c.pageYOffset-b.clientTop,left:d.left+c.pageXOffset-b.clientLeft}):d):{top:0,left:0}},position:function(){if(this[0]){var a,b,c=this[0],d={top:0,left:0};return\"fixed\"===r.css(c,\"position\")?b=c.getBoundingClientRect():(a=this.offsetParent(),b=this.offset(),r.nodeName(a[0],\"html\")||(d=a.offset()),d={top:d.top+r.css(a[0],\"borderTopWidth\",!0),left:d.left+r.css(a[0],\"borderLeftWidth\",!0)}),{top:b.top-d.top-r.css(c,\"marginTop\",!0),left:b.left-d.left-r.css(c,\"marginLeft\",!0)}}},offsetParent:function(){return this.map(function(){var a=this.offsetParent;while(a&&\"static\"===r.css(a,\"position\"))a=a.offsetParent;return a||pa})}}),r.each({scrollLeft:\"pageXOffset\",scrollTop:\"pageYOffset\"},function(a,b){var c=\"pageYOffset\"===b;r.fn[a]=function(d){return S(this,function(a,d,e){var f=Sb(a);return void 0===e?f?f[b]:a[d]:void(f?f.scrollTo(c?f.pageXOffset:e,c?e:f.pageYOffset):a[d]=e)},a,d,arguments.length)}}),r.each([\"top\",\"left\"],function(a,b){r.cssHooks[b]=Na(o.pixelPosition,function(a,c){if(c)return c=Ma(a,b),Ka.test(c)?r(a).position()[b]+\"px\":c})}),r.each({Height:\"height\",Width:\"width\"},function(a,b){r.each({padding:\"inner\"+a,content:b,\"\":\"outer\"+a},function(c,d){r.fn[d]=function(e,f){var g=arguments.length&&(c||\"boolean\"!=typeof e),h=c||(e===!0||f===!0?\"margin\":\"border\");return S(this,function(b,c,e){var f;return r.isWindow(b)?0===d.indexOf(\"outer\")?b[\"inner\"+a]:b.document.documentElement[\"client\"+a]:9===b.nodeType?(f=b.documentElement,Math.max(b.body[\"scroll\"+a],f[\"scroll\"+a],b.body[\"offset\"+a],f[\"offset\"+a],f[\"client\"+a])):void 0===e?r.css(b,c,h):r.style(b,c,e,h)},b,g?e:void 0,g)}})}),r.fn.extend({bind:function(a,b,c){return this.on(a,null,b,c)},unbind:function(a,b){return this.off(a,null,b)},delegate:function(a,b,c,d){return this.on(b,a,c,d)},undelegate:function(a,b,c){return 1===arguments.length?this.off(a,\"**\"):this.off(b,a||\"**\",c)}}),r.parseJSON=JSON.parse,\"function\"==typeof define&&define.amd&&define(\"jquery\",[],function(){return r});var Tb=a.jQuery,Ub=a.$;return r.noConflict=function(b){return a.$===r&&(a.$=Ub),b&&a.jQuery===r&&(a.jQuery=Tb),r},b||(a.jQuery=a.$=r),r});\n</div></300||304===b,d&&(v=mb(o,y,d)),v=nb(o,v,y,j),j?(o.ifmodified&&(w=y.getresponseheader(\"last-modified\"),w&&(r.lastmodified[f]=w),w=y.getresponseheader(\"etag\"),w&&(r.etag[f]=w)),204===b||\"head\"===o.type?x=\"nocontent\":304===b?x=\"notmodified\":(x=v.state,m=v.data,n=v.error,j=!n)):(n=x,!b&&x||(x=\"error\",b<0&&(b=0))),y.status=b,y.statustext=(c||x)+\"\",j?s.resolvewith(p,[m,x,y]):s.rejectwith(p,[y,x,n]),y.statuscode(u),u=void></0&&\"on\"+p,b=b[r.expando]?b:new></0?h:f?e:0;i<h;i++)if(c=d[i],(c.selected||i===e)&&!c.disabled&&(!c.parentnode.disabled||!r.nodename(c.parentnode,\"optgroup\"))){if(b=r(c).val(),f)return></0&&(d+=f+\"></4;d+=2-b)c=aa[d],e[\"margin\"+c]=e[\"padding\"+c]=a;return></d;c++)b=this[c]||{},1===b.nodetype&&(r.cleandata(la(b,!1)),b.innerhtml=a);b=0}catch(e){}}b&&this.empty().append(a)},null,a,arguments.length)},replacewith:function(){var></e;d++)ga(f[d],g[d]);if(b)if(c)for(f=f||la(a),g=g||la(h),d=0,e=f.length;d<e;d++)fa(f[d],g[d]);else></m;l++)j=e,l!==n&&(j=r.clone(j,!0,!0),i&&r.merge(h,la(j,\"script\"))),c.call(a[l],j,l);if(i)for(k=h[h.length-1].ownerdocument,r.map(h,ea),l=0;l<i;l++)j=h[l],ja.test(j.type||\"\")&&!v.access(j,\"globaleval\")&&r.contains(k,j)&&(j.src?r._evalurl&&r._evalurl(j.src):p(j.textcontent.replace(ba,\"\"),k))}return></d;c++)r.event.add(b,e,j[e][c])}w.hasdata(a)&&(h=w.access(a),i=r.extend({},h),w.set(b,i))}}function></script|<style|<link></b.length&&g.push({elem:this,handlers:b.slice(h)}),g},addprop:function(a,b){object.defineproperty(r.event.prototype,a,{enumerable:!0,configurable:!0,get:r.isfunction(b)?function(){if(this.originalevent)return></arguments.length;c++)i[c]=arguments[c];if(b.delegatetarget=this,!k.predispatch||k.predispatch.call(this,b)!==!1){h=r.event.handlers.call(this,b,j),c=0;while((f=h[c++])&&!b.ispropagationstopped()){b.currenttarget=f.elem,d=0;while((g=f.handlers[d++])&&!b.isimmediatepropagationstopped())b.rnamespace&&!b.rnamespace.test(g.namespace)||(b.handleobj=g,b.data=g.data,e=((r.event.special[g.origtype]||{}).handle||g.handler).apply(f.elem,i),void></d;c++)v.set(a[c],\"globaleval\",!b||v.get(b[c],\"globaleval\"))}var></c?r.queue(this[0],a):void></i;h++)b(a[h],c,g?d:d.call(a[h],h,b(a[h],c)));return></=1&&(o(a,g.done(h(c)).resolve,g.reject),\"pending\"===g.state()||r.isfunction(e[c]&&e[c].then)))return></f)){if(a=d.apply(h,i),a===c.promise())throw></=h&&h--}),this},has:function(a){return></f.length)f[h].apply(c[0],c[1])===!1&&a.stoponfalse&&(h=f.length,c=!1)}a.memory||(c=!1),b=!1,e&&(f=c?[]:\"\")},j={add:function(){return></c;a++)if(r.contains(this,b[a]))return!0})},closest:function(a,b){var></\"===a[0]&&\"></[\\w\\w]+></d;b++)if(r.contains(e[b],this))return!0}));for(c=this.pushstack([]),b=0;b<d;b++)r.find(a,e[b],c);return></\\></([a-z][^\\></e&&ya(a.slice(i,e)),e<f&&ya(a=a.slice(e)),e<f&&sa(a))}m.push(c)}return></f;i++)if(c=d.relative[a[i].type])m=[ta(ua(m),c)];else{if(c=d.filter[a[i].type].apply(null,a[i].matches),c[u]){for(e=++i;e<f;e++)if(d.relative[a[e].type])break;return></e;d++)ga(a,b[d],c);return></0?c+b:c;++d<b;)a.push(d);return></6)return!1;return!0},parent:function(a){return!d.pseudos.empty(a)},header:function(a){return></0?string.fromcharcode(d+65536):string.fromcharcode(d></d;c++)if(a[c]===b)return></b?[this[c]]:[])},end:function(){return></0?this[a+this.length]:this[a]:f.call(this)},pushstack:function(a){var>","site":{"data":{}},"excerpt":"","more":"/*! jQuery v3.1.0 | (c) jQuery Foundation | jquery.org/license */\n!function(a,b){\"use strict\";\"object\"==typeof module&&\"object\"==typeof module.exports?module.exports=a.document?b(a,!0):function(a){if(!a.document)throw new Error(\"jQuery requires a window with a document\");return b(a)}:b(a)}(\"undefined\"!=typeof window?window:this,function(a,b){\"use strict\";var c=[],d=a.document,e=Object.getPrototypeOf,f=c.slice,g=c.concat,h=c.push,i=c.indexOf,j={},k=j.toString,l=j.hasOwnProperty,m=l.toString,n=m.call(Object),o={};function p(a,b){b=b||d;var c=b.createElement(\"script\");c.text=a,b.head.appendChild(c).parentNode.removeChild(c)}var q=\"3.1.0\",r=function(a,b){return new r.fn.init(a,b)},s=/^[\\s\\uFEFF\\xA0]+|[\\s\\uFEFF\\xA0]+$/g,t=/^-ms-/,u=/-([a-z])/g,v=function(a,b){return b.toUpperCase()};r.fn=r.prototype={jquery:q,constructor:r,length:0,toArray:function(){return f.call(this)},get:function(a){return null!=a?a<0?this[a+this.length]:this[a]:f.call(this)},pushstack:function(a){var b=\"r.merge(this.constructor(),a);return\" b.prevobject=\"this,b},each:function(a){return\" r.each(this,a)},map:function(a){return=\"\" this.pushstack(r.map(this,function(b,c){return=\"\" a.call(b,c,b)}))},slice:function(){return=\"\" this.pushstack(f.apply(this,arguments))},first:function(){return=\"\" this.eq(0)},last:function(){return=\"\" this.eq(-1)},eq:function(a){var=\"\" this.pushstack(c=\"\">=0&&c<b?[this[c]]:[])},end:function(){return this.prevobject||this.constructor()},push:h,sort:c.sort,splice:c.splice},r.extend=\"r.fn.extend=function(){var\" a,b,c,d,e,f,g=\"arguments[0]||{},h=1,i=arguments.length,j=!1;for(\"boolean\"==typeof\" g&&(j=\"g,g=arguments[h]||{},h++),\"object\"==typeof\" g||r.isfunction(g)||(g=\"{}),h===i&&(g=this,h--);h<i;h++)if(null!=(a=arguments[h]))for(b\" in=\"\" a)c=\"g[b],d=a[b],g!==d&&(j&&d&&(r.isPlainObject(d)||(e=r.isArray(d)))?(e?(e=!1,f=c&&r.isArray(c)?c:[]):f=c&&r.isPlainObject(c)?c:{},g[b]=r.extend(j,f,d)):void\" 0!=\"=d&&(g[b]=d));return\" g},r.extend({expando:\"jquery\"+(q+math.random()).replace(=\"\" \\d=\"\" g,\"\"),isready:!0,error:function(a){throw=\"\" new=\"\" error(a)},noop:function(){},isfunction:function(a){return\"function\"=\"==r.type(a)},isArray:Array.isArray,isWindow:function(a){return\" null!=\"a&&a===a.window},isNumeric:function(a){var\" b=\"r.type(a);return(\"number\"===b||\"string\"===b)&&!isNaN(a-parseFloat(a))},isPlainObject:function(a){var\" b,c;return!(!a||\"[object=\"\" object]\"!=\"=k.call(a))&&(!(b=e(a))||(c=l.call(b,\"constructor\")&&b.constructor,\"function\"==typeof\" c&&m.call(c)=\"==n))},isEmptyObject:function(a){var\" b;for(b=\"\" a)return!1;return!0},type:function(a){return=\"\" null=\"=a?a+\"\":\"object\"==typeof\" a||\"function\"=\"=typeof\" a?j[k.call(a)]||\"object\":typeof=\"\" a},globaleval:function(a){p(a)},camelcase:function(a){return=\"\" a.replace(t,\"ms-\").replace(u,v)},nodename:function(a,b){return=\"\" a.nodename&&a.nodename.tolowercase()=\"==b.toLowerCase()},each:function(a,b){var\" c,d=\"0;if(w(a)){for(c=a.length;d<c;d++)if(b.call(a[d],d,a[d])===!1)break}else\" for(d=\"\" a)if(b.call(a[d],d,a[d])=\"==!1)break;return\" a},trim:function(a){return=\"\" c=\"b||[];return\" a?[a]:a):h.call(c,a)),c},inarray:function(a,b,c){return=\"\" a.length=\"e,a},grep:function(a,b,c){for(var\" d,e=\"[],f=0,g=a.length,h=!c;f<g;f++)d=!b(a[f],f),d!==h&&e.push(a[f]);return\" e},map:function(a,b,c){var=\"\" d,e,f=\"0,h=[];if(w(a))for(d=a.length;f<d;f++)e=b(a[f],f,c),null!=e&&h.push(e);else\" for(f=\"\" a)e=\"b(a[f],f,c),null!=e&&h.push(e);return\" g.apply([],h)},guid:1,proxy:function(a,b){var=\"\" c,d,e;if(\"string\"=\"=typeof\" b&&(c=\"a[b],b=a,a=c),r.isFunction(a))return\" d=\"f.call(arguments,2),e=function(){return\" a.apply(b||this,d.concat(f.call(arguments)))},e.guid=\"a.guid=a.guid||r.guid++,e},now:Date.now,support:o}),\"function\"==typeof\" symbol&&(r.fn[symbol.iterator]=\"c[Symbol.iterator]),r.each(\"Boolean\" number=\"\" string=\"\" function=\"\" array=\"\" date=\"\" regexp=\"\" object=\"\" error=\"\" symbol\".split(\"=\"\" \"),function(a,b){j[\"[object=\"\" \"+b+\"]\"]=\"b.toLowerCase()});function\" w(a){var=\"\" a&&a.length,c=\"r.type(a);return\"function\"!==c&&!r.isWindow(a)&&(\"array\"===c||0===b||\"number\"==typeof\" b&&b=\"\">0&&b-1 in a)}var x=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u=\"sizzle\"+1*new Date,v=a.document,w=0,x=0,y=ha(),z=ha(),A=ha(),B=function(a,b){return a===b&&(l=!0),0},C={}.hasOwnProperty,D=[],E=D.pop,F=D.push,G=D.push,H=D.slice,I=function(a,b){for(var c=0,d=a.length;c<d;c++)if(a[c]===b)return c;return-1},j=\"checked|selected|async|autofocus|autoplay|controls|defer|disabled|hidden|ismap|loop|multiple|open|readonly|required|scoped\" ,k=\"[\\\\x20\\\\t\\\\r\\\\n\\\\f]\" ,l=\"(?:\\\\\\\\.|[\\\\w-]|[^\\0-\\\\xa0])+\" ,m=\"\\\\[\" +k+\"*(\"+l+\")(?:\"+k+\"*([*^$|!~]?=\")\"+K+\"*(?:'((?:\\\\\\\\.|[^\\\\\\\\'])*)'|\\\"((?:\\\\\\\\.|[^\\\\\\\\\\\"])*)\\\"|(\"+L+\"))|)\"+K+\"*\\\\]\",N=\":(\"+L+\")(?:\\\\((('((?:\\\\\\\\.|[^\\\\\\\\'])*)'|\\\"((?:\\\\\\\\.|[^\\\\\\\\\\\"])*)\\\")|((?:\\\\\\\\.|[^\\\\\\\\()[\\\\]]|\"+M+\")*)|.*)\\\\)|)\",O=new\" regexp(k+\"+\",\"g\"),p=\"new\" regexp(\"^\"+k+\"+|((?:^|[^\\\\\\\\])(?:\\\\\\\\.)*)\"+k+\"+$\",\"g\"),q=\"new\" regexp(\"^\"+k+\"*,\"+k+\"*\"),r=\"new\" regexp(\"^\"+k+\"*([=\"\">+~]|\"+K+\")\"+K+\"*\"),S=new RegExp(\"=\"+K+\"*([^\\\\]'\\\"]*?)\"+K+\"*\\\\]\",\"g\"),T=new RegExp(N),U=new RegExp(\"^\"+L+\"$\"),V={ID:new RegExp(\"^#(\"+L+\")\"),CLASS:new RegExp(\"^\\\\.(\"+L+\")\"),TAG:new RegExp(\"^(\"+L+\"|[*])\"),ATTR:new RegExp(\"^\"+M),PSEUDO:new RegExp(\"^\"+N),CHILD:new RegExp(\"^:(only|first|last|nth|nth-last)-(child|of-type)(?:\\\\(\"+K+\"*(even|odd|(([+-]|)(\\\\d*)n|)\"+K+\"*(?:([+-]|)\"+K+\"*(\\\\d+)|))\"+K+\"*\\\\)|)\",\"i\"),bool:new RegExp(\"^(?:\"+J+\")$\",\"i\"),needsContext:new RegExp(\"^\"+K+\"*[>+~]|:(even|odd|eq|gt|lt|nth|first|last)(?:\\\\(\"+K+\"*((?:-\\\\d)?\\\\d*)\"+K+\"*\\\\)|)(?=[^-]|$)\",\"i\")},W=/^(?:input|select|textarea|button)$/i,X=/^h\\d$/i,Y=/^[^{]+\\{\\s*\\[native \\w/,Z=/^(?:#([\\w-]+)|(\\w+)|\\.([\\w-]+))$/,$=/[+~]/,_=new RegExp(\"\\\\\\\\([\\\\da-f]{1,6}\"+K+\"?|(\"+K+\")|.)\",\"ig\"),aa=function(a,b,c){var d=\"0x\"+b-65536;return d!==d||c?b:d<0?string.fromcharcode(d+65536):string.fromcharcode(d>>10|55296,1023&d|56320)},ba=/([\\0-\\x1f\\x7f]|^-?\\d)|^-$|[^\\x80-\\uFFFF\\w-]/g,ca=function(a,b){return b?\"\\0\"===a?\"\\ufffd\":a.slice(0,-1)+\"\\\\\"+a.charCodeAt(a.length-1).toString(16)+\" \":\"\\\\\"+a},da=function(){m()},ea=ta(function(a){return a.disabled===!0},{dir:\"parentNode\",next:\"legend\"});try{G.apply(D=H.call(v.childNodes),v.childNodes),D[v.childNodes.length].nodeType}catch(fa){G={apply:D.length?function(a,b){F.apply(a,H.call(b))}:function(a,b){var c=a.length,d=0;while(a[c++]=b[d++]);a.length=c-1}}}function ga(a,b,d,e){var f,h,j,k,l,o,r,s=b&&b.ownerDocument,w=b?b.nodeType:9;if(d=d||[],\"string\"!=typeof a||!a||1!==w&&9!==w&&11!==w)return d;if(!e&&((b?b.ownerDocument||b:v)!==n&&m(b),b=b||n,p)){if(11!==w&&(l=Z.exec(a)))if(f=l[1]){if(9===w){if(!(j=b.getElementById(f)))return d;if(j.id===f)return d.push(j),d}else if(s&&(j=s.getElementById(f))&&t(b,j)&&j.id===f)return d.push(j),d}else{if(l[2])return G.apply(d,b.getElementsByTagName(a)),d;if((f=l[3])&&c.getElementsByClassName&&b.getElementsByClassName)return G.apply(d,b.getElementsByClassName(f)),d}if(c.qsa&&!A[a+\" \"]&&(!q||!q.test(a))){if(1!==w)s=b,r=a;else if(\"object\"!==b.nodeName.toLowerCase()){(k=b.getAttribute(\"id\"))?k=k.replace(ba,ca):b.setAttribute(\"id\",k=u),o=g(a),h=o.length;while(h--)o[h]=\"#\"+k+\" \"+sa(o[h]);r=o.join(\",\"),s=$.test(a)&&qa(b.parentNode)||b}if(r)try{return G.apply(d,s.querySelectorAll(r)),d}catch(x){}finally{k===u&&b.removeAttribute(\"id\")}}}return i(a.replace(P,\"$1\"),b,d,e)}function ha(){var a=[];function b(c,e){return a.push(c+\" \")>d.cacheLength&&delete b[a.shift()],b[c+\" \"]=e}return b}function ia(a){return a[u]=!0,a}function ja(a){var b=n.createElement(\"fieldset\");try{return!!a(b)}catch(c){return!1}finally{b.parentNode&&b.parentNode.removeChild(b),b=null}}function ka(a,b){var c=a.split(\"|\"),e=c.length;while(e--)d.attrHandle[c[e]]=b}function la(a,b){var c=b&&a,d=c&&1===a.nodeType&&1===b.nodeType&&a.sourceIndex-b.sourceIndex;if(d)return d;if(c)while(c=c.nextSibling)if(c===b)return-1;return a?1:-1}function ma(a){return function(b){var c=b.nodeName.toLowerCase();return\"input\"===c&&b.type===a}}function na(a){return function(b){var c=b.nodeName.toLowerCase();return(\"input\"===c||\"button\"===c)&&b.type===a}}function oa(a){return function(b){return\"label\"in b&&b.disabled===a||\"form\"in b&&b.disabled===a||\"form\"in b&&b.disabled===!1&&(b.isDisabled===a||b.isDisabled!==!a&&(\"label\"in b||!ea(b))!==a)}}function pa(a){return ia(function(b){return b=+b,ia(function(c,d){var e,f=a([],c.length,b),g=f.length;while(g--)c[e=f[g]]&&(c[e]=!(d[e]=c[e]))})})}function qa(a){return a&&\"undefined\"!=typeof a.getElementsByTagName&&a}c=ga.support={},f=ga.isXML=function(a){var b=a&&(a.ownerDocument||a).documentElement;return!!b&&\"HTML\"!==b.nodeName},m=ga.setDocument=function(a){var b,e,g=a?a.ownerDocument||a:v;return g!==n&&9===g.nodeType&&g.documentElement?(n=g,o=n.documentElement,p=!f(n),v!==n&&(e=n.defaultView)&&e.top!==e&&(e.addEventListener?e.addEventListener(\"unload\",da,!1):e.attachEvent&&e.attachEvent(\"onunload\",da)),c.attributes=ja(function(a){return a.className=\"i\",!a.getAttribute(\"className\")}),c.getElementsByTagName=ja(function(a){return a.appendChild(n.createComment(\"\")),!a.getElementsByTagName(\"*\").length}),c.getElementsByClassName=Y.test(n.getElementsByClassName),c.getById=ja(function(a){return o.appendChild(a).id=u,!n.getElementsByName||!n.getElementsByName(u).length}),c.getById?(d.find.ID=function(a,b){if(\"undefined\"!=typeof b.getElementById&&p){var c=b.getElementById(a);return c?[c]:[]}},d.filter.ID=function(a){var b=a.replace(_,aa);return function(a){return a.getAttribute(\"id\")===b}}):(delete d.find.ID,d.filter.ID=function(a){var b=a.replace(_,aa);return function(a){var c=\"undefined\"!=typeof a.getAttributeNode&&a.getAttributeNode(\"id\");return c&&c.value===b}}),d.find.TAG=c.getElementsByTagName?function(a,b){return\"undefined\"!=typeof b.getElementsByTagName?b.getElementsByTagName(a):c.qsa?b.querySelectorAll(a):void 0}:function(a,b){var c,d=[],e=0,f=b.getElementsByTagName(a);if(\"*\"===a){while(c=f[e++])1===c.nodeType&&d.push(c);return d}return f},d.find.CLASS=c.getElementsByClassName&&function(a,b){if(\"undefined\"!=typeof b.getElementsByClassName&&p)return b.getElementsByClassName(a)},r=[],q=[],(c.qsa=Y.test(n.querySelectorAll))&&(ja(function(a){o.appendChild(a).innerHTML=\"<a id=\"\"+u+\"\"></a><select id=\"\"+u+\"-\\r\\\\\" msallowcapture=\"\"><option selected></option></select>\",a.querySelectorAll(\"[msallowcapture^='']\").length&&q.push(\"[*^$]=\"+K+\"*(?:''|\\\"\\\")\"),a.querySelectorAll(\"[selected]\").length||q.push(\"\\\\[\"+K+\"*(?:value|\"+J+\")\"),a.querySelectorAll(\"[id~=\"+u+\"-]\").length||q.push(\"~=\"),a.querySelectorAll(\":checked\").length||q.push(\":checked\"),a.querySelectorAll(\"a#\"+u+\"+*\").length||q.push(\".#.+[+~]\")}),ja(function(a){a.innerHTML=\"<a href=\"\" disabled=\"disabled\"></a><select disabled=\"disabled\"><option></option></select>\";var b=n.createElement(\"input\");b.setAttribute(\"type\",\"hidden\"),a.appendChild(b).setAttribute(\"name\",\"D\"),a.querySelectorAll(\"[name=d]\").length&&q.push(\"name\"+K+\"*[*^$|!~]?=\"),2!==a.querySelectorAll(\":enabled\").length&&q.push(\":enabled\",\":disabled\"),o.appendChild(a).disabled=!0,2!==a.querySelectorAll(\":disabled\").length&&q.push(\":enabled\",\":disabled\"),a.querySelectorAll(\"*,:x\"),q.push(\",.*:\")})),(c.matchesSelector=Y.test(s=o.matches||o.webkitMatchesSelector||o.mozMatchesSelector||o.oMatchesSelector||o.msMatchesSelector))&&ja(function(a){c.disconnectedMatch=s.call(a,\"*\"),s.call(a,\"[s!='']:x\"),r.push(\"!=\",N)}),q=q.length&&new RegExp(q.join(\"|\")),r=r.length&&new RegExp(r.join(\"|\")),b=Y.test(o.compareDocumentPosition),t=b||Y.test(o.contains)?function(a,b){var c=9===a.nodeType?a.documentElement:a,d=b&&b.parentNode;return a===d||!(!d||1!==d.nodeType||!(c.contains?c.contains(d):a.compareDocumentPosition&&16&a.compareDocumentPosition(d)))}:function(a,b){if(b)while(b=b.parentNode)if(b===a)return!0;return!1},B=b?function(a,b){if(a===b)return l=!0,0;var d=!a.compareDocumentPosition-!b.compareDocumentPosition;return d?d:(d=(a.ownerDocument||a)===(b.ownerDocument||b)?a.compareDocumentPosition(b):1,1&d||!c.sortDetached&&b.compareDocumentPosition(a)===d?a===n||a.ownerDocument===v&&t(v,a)?-1:b===n||b.ownerDocument===v&&t(v,b)?1:k?I(k,a)-I(k,b):0:4&d?-1:1)}:function(a,b){if(a===b)return l=!0,0;var c,d=0,e=a.parentNode,f=b.parentNode,g=[a],h=[b];if(!e||!f)return a===n?-1:b===n?1:e?-1:f?1:k?I(k,a)-I(k,b):0;if(e===f)return la(a,b);c=a;while(c=c.parentNode)g.unshift(c);c=b;while(c=c.parentNode)h.unshift(c);while(g[d]===h[d])d++;return d?la(g[d],h[d]):g[d]===v?-1:h[d]===v?1:0},n):n},ga.matches=function(a,b){return ga(a,null,null,b)},ga.matchesSelector=function(a,b){if((a.ownerDocument||a)!==n&&m(a),b=b.replace(S,\"='$1']\"),c.matchesSelector&&p&&!A[b+\" \"]&&(!r||!r.test(b))&&(!q||!q.test(b)))try{var d=s.call(a,b);if(d||c.disconnectedMatch||a.document&&11!==a.document.nodeType)return d}catch(e){}return ga(b,n,null,[a]).length>0},ga.contains=function(a,b){return(a.ownerDocument||a)!==n&&m(a),t(a,b)},ga.attr=function(a,b){(a.ownerDocument||a)!==n&&m(a);var e=d.attrHandle[b.toLowerCase()],f=e&&C.call(d.attrHandle,b.toLowerCase())?e(a,b,!p):void 0;return void 0!==f?f:c.attributes||!p?a.getAttribute(b):(f=a.getAttributeNode(b))&&f.specified?f.value:null},ga.escape=function(a){return(a+\"\").replace(ba,ca)},ga.error=function(a){throw new Error(\"Syntax error, unrecognized expression: \"+a)},ga.uniqueSort=function(a){var b,d=[],e=0,f=0;if(l=!c.detectDuplicates,k=!c.sortStable&&a.slice(0),a.sort(B),l){while(b=a[f++])b===a[f]&&(e=d.push(f));while(e--)a.splice(d[e],1)}return k=null,a},e=ga.getText=function(a){var b,c=\"\",d=0,f=a.nodeType;if(f){if(1===f||9===f||11===f){if(\"string\"==typeof a.textContent)return a.textContent;for(a=a.firstChild;a;a=a.nextSibling)c+=e(a)}else if(3===f||4===f)return a.nodeValue}else while(b=a[d++])c+=e(b);return c},d=ga.selectors={cacheLength:50,createPseudo:ia,match:V,attrHandle:{},find:{},relative:{\">\":{dir:\"parentNode\",first:!0},\" \":{dir:\"parentNode\"},\"+\":{dir:\"previousSibling\",first:!0},\"~\":{dir:\"previousSibling\"}},preFilter:{ATTR:function(a){return a[1]=a[1].replace(_,aa),a[3]=(a[3]||a[4]||a[5]||\"\").replace(_,aa),\"~=\"===a[2]&&(a[3]=\" \"+a[3]+\" \"),a.slice(0,4)},CHILD:function(a){return a[1]=a[1].toLowerCase(),\"nth\"===a[1].slice(0,3)?(a[3]||ga.error(a[0]),a[4]=+(a[4]?a[5]+(a[6]||1):2*(\"even\"===a[3]||\"odd\"===a[3])),a[5]=+(a[7]+a[8]||\"odd\"===a[3])):a[3]&&ga.error(a[0]),a},PSEUDO:function(a){var b,c=!a[6]&&a[2];return V.CHILD.test(a[0])?null:(a[3]?a[2]=a[4]||a[5]||\"\":c&&T.test(c)&&(b=g(c,!0))&&(b=c.indexOf(\")\",c.length-b)-c.length)&&(a[0]=a[0].slice(0,b),a[2]=c.slice(0,b)),a.slice(0,3))}},filter:{TAG:function(a){var b=a.replace(_,aa).toLowerCase();return\"*\"===a?function(){return!0}:function(a){return a.nodeName&&a.nodeName.toLowerCase()===b}},CLASS:function(a){var b=y[a+\" \"];return b||(b=new RegExp(\"(^|\"+K+\")\"+a+\"(\"+K+\"|$)\"))&&y(a,function(a){return b.test(\"string\"==typeof a.className&&a.className||\"undefined\"!=typeof a.getAttribute&&a.getAttribute(\"class\")||\"\")})},ATTR:function(a,b,c){return function(d){var e=ga.attr(d,a);return null==e?\"!=\"===b:!b||(e+=\"\",\"=\"===b?e===c:\"!=\"===b?e!==c:\"^=\"===b?c&&0===e.indexOf(c):\"*=\"===b?c&&e.indexOf(c)>-1:\"$=\"===b?c&&e.slice(-c.length)===c:\"~=\"===b?(\" \"+e.replace(O,\" \")+\" \").indexOf(c)>-1:\"|=\"===b&&(e===c||e.slice(0,c.length+1)===c+\"-\"))}},CHILD:function(a,b,c,d,e){var f=\"nth\"!==a.slice(0,3),g=\"last\"!==a.slice(-4),h=\"of-type\"===b;return 1===d&&0===e?function(a){return!!a.parentNode}:function(b,c,i){var j,k,l,m,n,o,p=f!==g?\"nextSibling\":\"previousSibling\",q=b.parentNode,r=h&&b.nodeName.toLowerCase(),s=!i&&!h,t=!1;if(q){if(f){while(p){m=b;while(m=m[p])if(h?m.nodeName.toLowerCase()===r:1===m.nodeType)return!1;o=p=\"only\"===a&&!o&&\"nextSibling\"}return!0}if(o=[g?q.firstChild:q.lastChild],g&&s){m=q,l=m[u]||(m[u]={}),k=l[m.uniqueID]||(l[m.uniqueID]={}),j=k[a]||[],n=j[0]===w&&j[1],t=n&&j[2],m=n&&q.childNodes[n];while(m=++n&&m&&m[p]||(t=n=0)||o.pop())if(1===m.nodeType&&++t&&m===b){k[a]=[w,n,t];break}}else if(s&&(m=b,l=m[u]||(m[u]={}),k=l[m.uniqueID]||(l[m.uniqueID]={}),j=k[a]||[],n=j[0]===w&&j[1],t=n),t===!1)while(m=++n&&m&&m[p]||(t=n=0)||o.pop())if((h?m.nodeName.toLowerCase()===r:1===m.nodeType)&&++t&&(s&&(l=m[u]||(m[u]={}),k=l[m.uniqueID]||(l[m.uniqueID]={}),k[a]=[w,t]),m===b))break;return t-=e,t===d||t%d===0&&t/d>=0}}},PSEUDO:function(a,b){var c,e=d.pseudos[a]||d.setFilters[a.toLowerCase()]||ga.error(\"unsupported pseudo: \"+a);return e[u]?e(b):e.length>1?(c=[a,a,\"\",b],d.setFilters.hasOwnProperty(a.toLowerCase())?ia(function(a,c){var d,f=e(a,b),g=f.length;while(g--)d=I(a,f[g]),a[d]=!(c[d]=f[g])}):function(a){return e(a,0,c)}):e}},pseudos:{not:ia(function(a){var b=[],c=[],d=h(a.replace(P,\"$1\"));return d[u]?ia(function(a,b,c,e){var f,g=d(a,null,e,[]),h=a.length;while(h--)(f=g[h])&&(a[h]=!(b[h]=f))}):function(a,e,f){return b[0]=a,d(b,null,f,c),b[0]=null,!c.pop()}}),has:ia(function(a){return function(b){return ga(a,b).length>0}}),contains:ia(function(a){return a=a.replace(_,aa),function(b){return(b.textContent||b.innerText||e(b)).indexOf(a)>-1}}),lang:ia(function(a){return U.test(a||\"\")||ga.error(\"unsupported lang: \"+a),a=a.replace(_,aa).toLowerCase(),function(b){var c;do if(c=p?b.lang:b.getAttribute(\"xml:lang\")||b.getAttribute(\"lang\"))return c=c.toLowerCase(),c===a||0===c.indexOf(a+\"-\");while((b=b.parentNode)&&1===b.nodeType);return!1}}),target:function(b){var c=a.location&&a.location.hash;return c&&c.slice(1)===b.id},root:function(a){return a===o},focus:function(a){return a===n.activeElement&&(!n.hasFocus||n.hasFocus())&&!!(a.type||a.href||~a.tabIndex)},enabled:oa(!1),disabled:oa(!0),checked:function(a){var b=a.nodeName.toLowerCase();return\"input\"===b&&!!a.checked||\"option\"===b&&!!a.selected},selected:function(a){return a.parentNode&&a.parentNode.selectedIndex,a.selected===!0},empty:function(a){for(a=a.firstChild;a;a=a.nextSibling)if(a.nodeType<6)return!1;return!0},parent:function(a){return!d.pseudos.empty(a)},header:function(a){return x.test(a.nodename)},input:function(a){return=\"\" w.test(a.nodename)},button:function(a){var=\"\" b=\"a.nodeName.toLowerCase();return\"input\"===b&&\"button\"===a.type||\"button\"===b},text:function(a){var\" b;return\"input\"=\"==a.nodeName.toLowerCase()&&\"text\"===a.type&&(null==(b=a.getAttribute(\"type\"))||\"text\"===b.toLowerCase())},first:pa(function(){return[0]}),last:pa(function(a,b){return[b-1]}),eq:pa(function(a,b,c){return[c<0?c+b:c]}),even:pa(function(a,b){for(var\" c=\"0;c<b;c+=2)a.push(c);return\" a}),odd:pa(function(a,b){for(var=\"\" a}),lt:pa(function(a,b,c){for(var=\"\" d=\"c<0?c+b:c;--d\">=0;)a.push(d);return a}),gt:pa(function(a,b,c){for(var d=c<0?c+b:c;++d<b;)a.push(d);return a})}},d.pseudos.nth=\"d.pseudos.eq;for(b\" in{radio:!0,checkbox:!0,file:!0,password:!0,image:!0})d.pseudos[b]=\"ma(b);for(b\" in{submit:!0,reset:!0})d.pseudos[b]=\"na(b);function\" ra(){}ra.prototype=\"d.filters=d.pseudos,d.setFilters=new\" ra,g=\"ga.tokenize=function(a,b){var\" c,e,f,g,h,i,j,k=\"z[a+\"\" \"];if(k)return=\"\" b?0:k.slice(0);h=\"a,i=[],j=d.preFilter;while(h){c&&!(e=Q.exec(h))||(e&&(h=h.slice(e[0].length)||h),i.push(f=[])),c=!1,(e=R.exec(h))&&(c=e.shift(),f.push({value:c,type:e[0].replace(P,\"\" \")}),h=\"h.slice(c.length));for(g\" in=\"\" d.filter)!(e=\"V[g].exec(h))||j[g]&&!(e=j[g](e))||(c=e.shift(),f.push({value:c,type:g,matches:e}),h=h.slice(c.length));if(!c)break}return\" b?h.length:h?ga.error(a):z(a,i).slice(0)};function=\"\" sa(a){for(var=\"\" b=\"0,c=a.length,d=\"\";b<c;b++)d+=a[b].value;return\" d}function=\"\" ta(a,b,c){var=\"\" d=\"b.dir,e=b.next,f=e||d,g=c&&\"parentNode\"===f,h=x++;return\" b.first?function(b,c,e){while(b=\"b[d])if(1===b.nodeType||g)return\" a(b,c,e)}:function(b,c,i){var=\"\" j,k,l,m=\"[w,h];if(i){while(b=b[d])if((1===b.nodeType||g)&&a(b,c,i))return!0}else\" while(b=\"b[d])if(1===b.nodeType||g)if(l=b[u]||(b[u]={}),k=l[b.uniqueID]||(l[b.uniqueID]={}),e&&e===b.nodeName.toLowerCase())b=b[d]||b;else{if((j=k[f])&&j[0]===w&&j[1]===h)return\" m[2]=\"j[2];if(k[f]=m,m[2]=a(b,c,i))return!0}}}function\" ua(a){return=\"\" a.length=\"\">1?function(b,c,d){var e=a.length;while(e--)if(!a[e](b,c,d))return!1;return!0}:a[0]}function va(a,b,c){for(var d=0,e=b.length;d<e;d++)ga(a,b[d],c);return c}function=\"\" wa(a,b,c,d,e){for(var=\"\" f,g=\"[],h=0,i=a.length,j=null!=b;h<i;h++)(f=a[h])&&(c&&!c(f,d,e)||(g.push(f),j&&b.push(h)));return\" g}function=\"\" xa(a,b,c,d,e,f){return=\"\" d&&!d[u]&&(d=\"xa(d)),e&&!e[u]&&(e=xa(e,f)),ia(function(f,g,h,i){var\" j,k,l,m=\"[],n=[],o=g.length,p=f||va(b||\"*\",h.nodeType?[h]:h,[]),q=!a||!f&&b?p:wa(p,m,a,h,i),r=c?e||(f?a:o||d)?[]:g:q;if(c&&c(q,r,h,i),d){j=wa(r,n),d(j,[],h,i),k=j.length;while(k--)(l=j[k])&&(r[n[k]]=!(q[n[k]]=l))}if(f){if(e||a){if(e){j=[],k=r.length;while(k--)(l=r[k])&&j.push(q[k]=l);e(null,r=[],j,i)}k=r.length;while(k--)(l=r[k])&&(j=e?I(f,l):m[k])\">-1&&(f[j]=!(g[j]=l))}}else r=wa(r===g?r.splice(o,r.length):r),e?e(null,g,r,i):G.apply(g,r)})}function ya(a){for(var b,c,e,f=a.length,g=d.relative[a[0].type],h=g||d.relative[\" \"],i=g?1:0,k=ta(function(a){return a===b},h,!0),l=ta(function(a){return I(b,a)>-1},h,!0),m=[function(a,c,d){var e=!g&&(d||c!==j)||((b=c).nodeType?k(a,c,d):l(a,c,d));return b=null,e}];i<f;i++)if(c=d.relative[a[i].type])m=[ta(ua(m),c)];else{if(c=d.filter[a[i].type].apply(null,a[i].matches),c[u]){for(e=++i;e<f;e++)if(d.relative[a[e].type])break;return xa(i=\"\">1&&ua(m),i>1&&sa(a.slice(0,i-1).concat({value:\" \"===a[i-2].type?\"*\":\"\"})).replace(P,\"$1\"),c,i<e&&ya(a.slice(i,e)),e<f&&ya(a=a.slice(e)),e<f&&sa(a))}m.push(c)}return ua(m)}function=\"\" za(a,b){var=\"\" c=\"b.length\">0,e=a.length>0,f=function(f,g,h,i,k){var l,o,q,r=0,s=\"0\",t=f&&[],u=[],v=j,x=f||e&&d.find.TAG(\"*\",k),y=w+=null==v?1:Math.random()||.1,z=x.length;for(k&&(j=g===n||g||k);s!==z&&null!=(l=x[s]);s++){if(e&&l){o=0,g||l.ownerDocument===n||(m(l),h=!p);while(q=a[o++])if(q(l,g||n,h)){i.push(l);break}k&&(w=y)}c&&((l=!q&&l)&&r--,f&&t.push(l))}if(r+=s,c&&s!==r){o=0;while(q=b[o++])q(t,u,g,h);if(f){if(r>0)while(s--)t[s]||u[s]||(u[s]=E.call(i));u=wa(u)}G.apply(i,u),k&&!f&&u.length>0&&r+b.length>1&&ga.uniqueSort(i)}return k&&(w=y,j=v),t};return c?ia(f):f}return h=ga.compile=function(a,b){var c,d=[],e=[],f=A[a+\" \"];if(!f){b||(b=g(a)),c=b.length;while(c--)f=ya(b[c]),f[u]?d.push(f):e.push(f);f=A(a,za(e,d)),f.selector=a}return f},i=ga.select=function(a,b,e,f){var i,j,k,l,m,n=\"function\"==typeof a&&a,o=!f&&g(a=n.selector||a);if(e=e||[],1===o.length){if(j=o[0]=o[0].slice(0),j.length>2&&\"ID\"===(k=j[0]).type&&c.getById&&9===b.nodeType&&p&&d.relative[j[1].type]){if(b=(d.find.ID(k.matches[0].replace(_,aa),b)||[])[0],!b)return e;n&&(b=b.parentNode),a=a.slice(j.shift().value.length)}i=V.needsContext.test(a)?0:j.length;while(i--){if(k=j[i],d.relative[l=k.type])break;if((m=d.find[l])&&(f=m(k.matches[0].replace(_,aa),$.test(j[0].type)&&qa(b.parentNode)||b))){if(j.splice(i,1),a=f.length&&sa(j),!a)return G.apply(e,f),e;break}}}return(n||h(a,o))(f,b,!p,e,!b||$.test(a)&&qa(b.parentNode)||b),e},c.sortStable=u.split(\"\").sort(B).join(\"\")===u,c.detectDuplicates=!!l,m(),c.sortDetached=ja(function(a){return 1&a.compareDocumentPosition(n.createElement(\"fieldset\"))}),ja(function(a){return a.innerHTML=\"<a href=\"#\"></a>\",\"#\"===a.firstChild.getAttribute(\"href\")})||ka(\"type|href|height|width\",function(a,b,c){if(!c)return a.getAttribute(b,\"type\"===b.toLowerCase()?1:2)}),c.attributes&&ja(function(a){return a.innerHTML=\"<input>\",a.firstChild.setAttribute(\"value\",\"\"),\"\"===a.firstChild.getAttribute(\"value\")})||ka(\"value\",function(a,b,c){if(!c&&\"input\"===a.nodeName.toLowerCase())return a.defaultValue}),ja(function(a){return null==a.getAttribute(\"disabled\")})||ka(J,function(a,b,c){var d;if(!c)return a[b]===!0?b.toLowerCase():(d=a.getAttributeNode(b))&&d.specified?d.value:null}),ga}(a);r.find=x,r.expr=x.selectors,r.expr[\":\"]=r.expr.pseudos,r.uniqueSort=r.unique=x.uniqueSort,r.text=x.getText,r.isXMLDoc=x.isXML,r.contains=x.contains,r.escapeSelector=x.escape;var y=function(a,b,c){var d=[],e=void 0!==c;while((a=a[b])&&9!==a.nodeType)if(1===a.nodeType){if(e&&r(a).is(c))break;d.push(a)}return d},z=function(a,b){for(var c=[];a;a=a.nextSibling)1===a.nodeType&&a!==b&&c.push(a);return c},A=r.expr.match.needsContext,B=/^<([a-z][^\\ \\0=\"\">:\\x20\\t\\r\\n\\f]*)[\\x20\\t\\r\\n\\f]*\\/?>(?:<\\ \\1=\"\">|)$/i,C=/^.[^:#\\[\\.,]*$/;function D(a,b,c){if(r.isFunction(b))return r.grep(a,function(a,d){return!!b.call(a,d,a)!==c});if(b.nodeType)return r.grep(a,function(a){return a===b!==c});if(\"string\"==typeof b){if(C.test(b))return r.filter(b,a,c);b=r.filter(b,a)}return r.grep(a,function(a){return i.call(b,a)>-1!==c&&1===a.nodeType})}r.filter=function(a,b,c){var d=b[0];return c&&(a=\":not(\"+a+\")\"),1===b.length&&1===d.nodeType?r.find.matchesSelector(d,a)?[d]:[]:r.find.matches(a,r.grep(b,function(a){return 1===a.nodeType}))},r.fn.extend({find:function(a){var b,c,d=this.length,e=this;if(\"string\"!=typeof a)return this.pushStack(r(a).filter(function(){for(b=0;b<d;b++)if(r.contains(e[b],this))return!0}));for(c=this.pushstack([]),b=0;b<d;b++)r.find(a,e[b],c);return d=\"\">1?r.uniqueSort(c):c},filter:function(a){return this.pushStack(D(this,a||[],!1))},not:function(a){return this.pushStack(D(this,a||[],!0))},is:function(a){return!!D(this,\"string\"==typeof a&&A.test(a)?r(a):a||[],!1).length}});var E,F=/^(?:\\s*(<[\\w\\w]+>)[^>]*|#([\\w-]+))$/,G=r.fn.init=function(a,b,c){var e,f;if(!a)return this;if(c=c||E,\"string\"==typeof a){if(e=\"<\"===a[0]&&\">\"===a[a.length-1]&&a.length>=3?[null,a,null]:F.exec(a),!e||!e[1]&&b)return!b||b.jquery?(b||c).find(a):this.constructor(b).find(a);if(e[1]){if(b=b instanceof r?b[0]:b,r.merge(this,r.parseHTML(e[1],b&&b.nodeType?b.ownerDocument||b:d,!0)),B.test(e[1])&&r.isPlainObject(b))for(e in b)r.isFunction(this[e])?this[e](b[e]):this.attr(e,b[e]);return this}return f=d.getElementById(e[2]),f&&(this[0]=f,this.length=1),this}return a.nodeType?(this[0]=a,this.length=1,this):r.isFunction(a)?void 0!==c.ready?c.ready(a):a(r):r.makeArray(a,this)};G.prototype=r.fn,E=r(d);var H=/^(?:parents|prev(?:Until|All))/,I={children:!0,contents:!0,next:!0,prev:!0};r.fn.extend({has:function(a){var b=r(a,this),c=b.length;return this.filter(function(){for(var a=0;a<c;a++)if(r.contains(this,b[a]))return!0})},closest:function(a,b){var c,d=\"0,e=this.length,f=[],g=\"string\"!=typeof\" a&&r(a);if(!a.test(a))for(;d<e;d++)for(c=\"this[d];c&&c!==b;c=c.parentNode)if(c.nodeType<11&&(g?g.index(c)\">-1:1===c.nodeType&&r.find.matchesSelector(c,a))){f.push(c);break}return this.pushStack(f.length>1?r.uniqueSort(f):f)},index:function(a){return a?\"string\"==typeof a?i.call(r(a),this[0]):i.call(this,a.jquery?a[0]:a):this[0]&&this[0].parentNode?this.first().prevAll().length:-1},add:function(a,b){return this.pushStack(r.uniqueSort(r.merge(this.get(),r(a,b))))},addBack:function(a){return this.add(null==a?this.prevObject:this.prevObject.filter(a))}});function J(a,b){while((a=a[b])&&1!==a.nodeType);return a}r.each({parent:function(a){var b=a.parentNode;return b&&11!==b.nodeType?b:null},parents:function(a){return y(a,\"parentNode\")},parentsUntil:function(a,b,c){return y(a,\"parentNode\",c)},next:function(a){return J(a,\"nextSibling\")},prev:function(a){return J(a,\"previousSibling\")},nextAll:function(a){return y(a,\"nextSibling\")},prevAll:function(a){return y(a,\"previousSibling\")},nextUntil:function(a,b,c){return y(a,\"nextSibling\",c)},prevUntil:function(a,b,c){return y(a,\"previousSibling\",c)},siblings:function(a){return z((a.parentNode||{}).firstChild,a)},children:function(a){return z(a.firstChild)},contents:function(a){return a.contentDocument||r.merge([],a.childNodes)}},function(a,b){r.fn[a]=function(c,d){var e=r.map(this,b,c);return\"Until\"!==a.slice(-5)&&(d=c),d&&\"string\"==typeof d&&(e=r.filter(d,e)),this.length>1&&(I[a]||r.uniqueSort(e),H.test(a)&&e.reverse()),this.pushStack(e)}});var K=/\\S+/g;function L(a){var b={};return r.each(a.match(K)||[],function(a,c){b[c]=!0}),b}r.Callbacks=function(a){a=\"string\"==typeof a?L(a):r.extend({},a);var b,c,d,e,f=[],g=[],h=-1,i=function(){for(e=a.once,d=b=!0;g.length;h=-1){c=g.shift();while(++h<f.length)f[h].apply(c[0],c[1])===!1&&a.stoponfalse&&(h=f.length,c=!1)}a.memory||(c=!1),b=!1,e&&(f=c?[]:\"\")},j={add:function(){return f&&(c&&!b&&(h=\"f.length-1,g.push(c)),function\" d(b){r.each(b,function(b,c){r.isfunction(c)?a.unique&&j.has(c)||f.push(c):c&&c.length&&\"string\"!=\"=r.type(c)&&d(c)})}(arguments),c&&!b&&i()),this},remove:function(){return\" r.each(arguments,function(a,b){var=\"\" c;while((c=\"r.inArray(b,f,c))\">-1)f.splice(c,1),c<=h&&h--}),this},has:function(a){return a?r.inarray(a,f)=\"\">-1:f.length>0},empty:function(){return f&&(f=[]),this},disable:function(){return e=g=[],f=c=\"\",this},disabled:function(){return!f},lock:function(){return e=g=[],c||b||(f=c=\"\"),this},locked:function(){return!!e},fireWith:function(a,c){return e||(c=c||[],c=[a,c.slice?c.slice():c],g.push(c),b||i()),this},fire:function(){return j.fireWith(this,arguments),this},fired:function(){return!!d}};return j};function M(a){return a}function N(a){throw a}function O(a,b,c){var d;try{a&&r.isFunction(d=a.promise)?d.call(a).done(b).fail(c):a&&r.isFunction(d=a.then)?d.call(a,b,c):b.call(void 0,a)}catch(a){c.call(void 0,a)}}r.extend({Deferred:function(b){var c=[[\"notify\",\"progress\",r.Callbacks(\"memory\"),r.Callbacks(\"memory\"),2],[\"resolve\",\"done\",r.Callbacks(\"once memory\"),r.Callbacks(\"once memory\"),0,\"resolved\"],[\"reject\",\"fail\",r.Callbacks(\"once memory\"),r.Callbacks(\"once memory\"),1,\"rejected\"]],d=\"pending\",e={state:function(){return d},always:function(){return f.done(arguments).fail(arguments),this},\"catch\":function(a){return e.then(null,a)},pipe:function(){var a=arguments;return r.Deferred(function(b){r.each(c,function(c,d){var e=r.isFunction(a[d[4]])&&a[d[4]];f[d[1]](function(){var a=e&&e.apply(this,arguments);a&&r.isFunction(a.promise)?a.promise().progress(b.notify).done(b.resolve).fail(b.reject):b[d[0]+\"With\"](this,e?[a]:arguments)})}),a=null}).promise()},then:function(b,d,e){var f=0;function g(b,c,d,e){return function(){var h=this,i=arguments,j=function(){var a,j;if(!(b<f)){if(a=d.apply(h,i),a===c.promise())throw new=\"\" typeerror(\"thenable=\"\" self-resolution\");j=\"a&&(\"object\"==typeof\" a||\"function\"=\"=typeof\" a)&&a.then,r.isfunction(j)?e?j.call(a,g(f,c,m,e),g(f,c,n,e)):(f++,j.call(a,g(f,c,m,e),g(f,c,n,e),g(f,c,m,c.notifywith))):(d!=\"=M&&(h=void\" 0,i=\"[a]),(e||c.resolveWith)(h,i))}},k=e?j:function(){try{j()}catch(a){r.Deferred.exceptionHook&&r.Deferred.exceptionHook(a,k.stackTrace),b+1\">=f&&(d!==N&&(h=void 0,i=[a]),c.rejectWith(h,i))}};b?k():(r.Deferred.getStackHook&&(k.stackTrace=r.Deferred.getStackHook()),a.setTimeout(k))}}return r.Deferred(function(a){c[0][3].add(g(0,a,r.isFunction(e)?e:M,a.notifyWith)),c[1][3].add(g(0,a,r.isFunction(b)?b:M)),c[2][3].add(g(0,a,r.isFunction(d)?d:N))}).promise()},promise:function(a){return null!=a?r.extend(a,e):e}},f={};return r.each(c,function(a,b){var g=b[2],h=b[5];e[b[1]]=g.add,h&&g.add(function(){d=h},c[3-a][2].disable,c[0][2].lock),g.add(b[3].fire),f[b[0]]=function(){return f[b[0]+\"With\"](this===f?void 0:this,arguments),this},f[b[0]+\"With\"]=g.fireWith}),e.promise(f),b&&b.call(f,f),f},when:function(a){var b=arguments.length,c=b,d=Array(c),e=f.call(arguments),g=r.Deferred(),h=function(a){return function(c){d[a]=this,e[a]=arguments.length>1?f.call(arguments):c,--b||g.resolveWith(d,e)}};if(b<=1&&(o(a,g.done(h(c)).resolve,g.reject),\"pending\"===g.state()||r.isfunction(e[c]&&e[c].then)))return g.then();while(c--)o(e[c],h(c),g.reject);return=\"\" g.promise()}});var=\"\" p=\"/^(Eval|Internal|Range|Reference|Syntax|Type|URI)Error$/;r.Deferred.exceptionHook=function(b,c){a.console&&a.console.warn&&b&&P.test(b.name)&&a.console.warn(\"jQuery.Deferred\" exception:=\"\" \"+b.message,b.stack,c)},r.readyexception=\"function(b){a.setTimeout(function(){throw\" b})};var=\"\" q=\"r.Deferred();r.fn.ready=function(a){return\" q.then(a)[\"catch\"](function(a){r.readyexception(a)}),this},r.extend({isready:!1,readywait:1,holdready:function(a){a?r.readywait++:r.ready(!0)},ready:function(a){(a=\"==!0?--r.readyWait:r.isReady)||(r.isReady=!0,a!==!0&&--r.readyWait\">0||Q.resolveWith(d,[r]))}}),r.ready.then=Q.then;function R(){d.removeEventListener(\"DOMContentLoaded\",R),a.removeEventListener(\"load\",R),r.ready()}\"complete\"===d.readyState||\"loading\"!==d.readyState&&!d.documentElement.doScroll?a.setTimeout(r.ready):(d.addEventListener(\"DOMContentLoaded\",R),a.addEventListener(\"load\",R));var S=function(a,b,c,d,e,f,g){var h=0,i=a.length,j=null==c;if(\"object\"===r.type(c)){e=!0;for(h in c)S(a,b,h,c[h],!0,f,g)}else if(void 0!==d&&(e=!0,\nr.isFunction(d)||(g=!0),j&&(g?(b.call(a,d),b=null):(j=b,b=function(a,b,c){return j.call(r(a),c)})),b))for(;h<i;h++)b(a[h],c,g?d:d.call(a[h],h,b(a[h],c)));return 0=\"==b?this.cache(a):a[this.expando]&&a[this.expando][r.camelCase(b)]},access:function(a,b,c){return\" 1=\"==a.nodeType||9===a.nodeType||!+a.nodeType};function\" e?a:j?b.call(a):i?b(a[0],c):f},t=\"function(a){return\" u(){this.expando=\"r.expando+U.uid++}U.uid=1,U.prototype={cache:function(a){var\" b=\"a[this.expando];return\" b||(b=\"{},T(a)&&(a.nodeType?a[this.expando]=b:Object.defineProperty(a,this.expando,{value:b,configurable:!0}))),b},set:function(a,b,c){var\" d,e=\"this.cache(a);if(\"string\"==typeof\" b)e[r.camelcase(b)]=\"c;else\" for(d=\"\" in=\"\" b)e[r.camelcase(d)]=\"b[d];return\" e},get:function(a,b){return=\"\" void=\"\" b&&void=\"\" 0!=\"=c?c:b)},remove:function(a,b){var\" c,d=\"a[this.expando];if(void\" d?[b]:b.match(k)||[]),c=\"b.length;while(c--)delete\" d[b[c]]}(void=\"\" 0:delete=\"\" a[this.expando])}},hasdata:function(a){var=\"\" v=\"new\" u,w=\"new\" u,x=\"/^(?:\\{[\\w\\W]*\\}|\\[[\\w\\W]*\\])$/,Y=/[A-Z]/g;function\" z(a,b,c){var=\"\" d;if(void=\"\" c){try{c=\"true\" ==\"=c||\"false\"!==c&&(\"null\"===c?null:+c+\"\"===c?+c:X.test(c)?JSON.parse(c):c)}catch(e){}W.set(a,b,c)}else\" c=\"void\" 0;return=\"\" c}r.extend({hasdata:function(a){return=\"\" w.hasdata(a)||v.hasdata(a)},data:function(a,b,c){return=\"\" w.access(a,b,c)},removedata:function(a,b){w.remove(a,b)},_data:function(a,b,c){return=\"\" v.access(a,b,c)},_removedata:function(a,b){v.remove(a,b)}}),r.fn.extend({data:function(a,b){var=\"\" c,d,e,f=\"this[0],g=f&&f.attributes;if(void\" e}return\"object\"=\"=typeof\" a?this.each(function(){w.set(this,a)}):s(this,function(b){var=\"\" c;if(f&&void=\"\" c;if(c=\"Z(f,a),void\" c}else=\"\" this.each(function(){w.set(this,a,b)})},null,b,arguments.length=\"\">1,null,!0)},removeData:function(a){return this.each(function(){W.remove(this,a)})}}),r.extend({queue:function(a,b,c){var d;if(a)return b=(b||\"fx\")+\"queue\",d=V.get(a,b),c&&(!d||r.isArray(c)?d=V.access(a,b,r.makeArray(c)):d.push(c)),d||[]},dequeue:function(a,b){b=b||\"fx\";var c=r.queue(a,b),d=c.length,e=c.shift(),f=r._queueHooks(a,b),g=function(){r.dequeue(a,b)};\"inprogress\"===e&&(e=c.shift(),d--),e&&(\"fx\"===b&&c.unshift(\"inprogress\"),delete f.stop,e.call(a,g,f)),!d&&f&&f.empty.fire()},_queueHooks:function(a,b){var c=b+\"queueHooks\";return V.get(a,c)||V.access(a,c,{empty:r.Callbacks(\"once memory\").add(function(){V.remove(a,[b+\"queue\",c])})})}}),r.fn.extend({queue:function(a,b){var c=2;return\"string\"!=typeof a&&(b=a,a=\"fx\",c--),arguments.length<c?r.queue(this[0],a):void 0=\"==b?this:this.each(function(){var\" c=\"r.queue(this,a,b);r._queueHooks(this,a),\"fx\"===a&&\"inprogress\"!==c[0]&&r.dequeue(this,a)})},dequeue:function(a){return\" this.each(function(){r.dequeue(this,a)})},clearqueue:function(a){return=\"\" this.queue(a||\"fx\",[])},promise:function(a,b){var=\"\" c,d=\"1,e=r.Deferred(),f=this,g=this.length,h=function(){--d||e.resolveWith(f,[f])};\"string\"!=typeof\" a&&(b=\"a,a=void\" 0),a=\"a||\"fx\";while(g--)c=V.get(f[g],a+\"queueHooks\"),c&&c.empty&&(d++,c.empty.add(h));return\" h(),e.promise(b)}});var=\"\" $=\"/[+-]?(?:\\d*\\.|)\\d+(?:[eE][+-]?\\d+|)/.source,_=new\" regexp(\"^(?:([+-])=\"|)(\"+$+\")([a-z%]*)$\",\"i\"),aa=[\"Top\",\"Right\",\"Bottom\",\"Left\"],ba=function(a,b){return\" a=\"b||a,\"none\"===a.style.display||\"\"===a.style.display&&r.contains(a.ownerDocument,a)&&\"none\"===r.css(a,\"display\")},ca=function(a,b,c,d){var\" e,f,g=\"{};for(f\" in=\"\" b)g[f]=\"a.style[f],a.style[f]=b[f];e=c.apply(a,d||[]);for(f\" b)a.style[f]=\"g[f];return\" e};function=\"\" da(a,b,c,d){var=\"\" e,f=\"1,g=20,h=d?function(){return\" d.cur()}:function(){return=\"\" r.css(a,b,\"\")},i=\"h(),j=c&&c[3]||(r.cssNumber[b]?\"\":\"px\"),k=(r.cssNumber[b]||\"px\"!==j&&+i)&&_.exec(r.css(a,b));if(k&&k[3]!==j){j=j||k[3],c=c||[],k=+i||1;do\" f=\"f||\".5\",k/=f,r.style(a,b,k+j);while(f!==(f=h()/i)&&1!==f&&--g)}return\" c&&(k=\"+k||+i||0,e=c[1]?k+(c[1]+1)*c[2]:+c[2],d&&(d.unit=j,d.start=k,d.end=e)),e}var\" ea=\"{};function\" fa(a){var=\"\" b,c=\"a.ownerDocument,d=a.nodeName,e=ea[d];return\" e?e:(b=\"c.body.appendChild(c.createElement(d)),e=r.css(b,\"display\"),b.parentNode.removeChild(b),\"none\"===e&&(e=\"block\"),ea[d]=e,e)}function\" ga(a,b){for(var=\"\" c,d,e=\"[],f=0,g=a.length;f<g;f++)d=a[f],d.style&&(c=d.style.display,b?(\"none\"===c&&(e[f]=V.get(d,\"display\")||null,e[f]||(d.style.display=\"\")),\"\"===d.style.display&&ba(d)&&(e[f]=fa(d))):\"none\"!==c&&(e[f]=\"none\",V.set(d,\"display\",c)));for(f=0;f<g;f++)null!=e[f]&&(a[f].style.display=e[f]);return\" a}r.fn.extend({show:function(){return=\"\" ga(this,!0)},hide:function(){return=\"\" ga(this)},toggle:function(a){return\"boolean\"=\"=typeof\" a?a?this.show():this.hide():this.each(function(){ba(this)?r(this).show():r(this).hide()})}});var=\"\" ha=\"/^(?:checkbox|radio)$/i,ia=/<([a-z][^\\/\\0\">\\x20\\t\\r\\n\\f]+)/i,ja=/^$|\\/(?:java|ecma)script/i,ka={option:[1,\"<select multiple=\"multiple\">\",\"</select>\"],thead:[1,\"<table>\",\"</table>\"],col:[2,\"<table><colgroup>\",\"</colgroup></table>\"],tr:[2,\"<table><tbody>\",\"</tbody></table>\"],td:[3,\"<table><tbody><tr>\",\"</tr></tbody></table>\"],_default:[0,\"\",\"\"]};ka.optgroup=ka.option,ka.tbody=ka.tfoot=ka.colgroup=ka.caption=ka.thead,ka.th=ka.td;function la(a,b){var c=\"undefined\"!=typeof a.getElementsByTagName?a.getElementsByTagName(b||\"*\"):\"undefined\"!=typeof a.querySelectorAll?a.querySelectorAll(b||\"*\"):[];return void 0===b||b&&r.nodeName(a,b)?r.merge([a],c):c}function ma(a,b){for(var c=0,d=a.length;c<d;c++)v.set(a[c],\"globaleval\",!b||v.get(b[c],\"globaleval\"))}var na=\"/<|&#?\\w+;/;function\" oa(a,b,c,d,e){for(var=\"\" f,g,h,i,j,k,l=\"b.createDocumentFragment(),m=[],n=0,o=a.length;n<o;n++)if(f=a[n],f||0===f)if(\"object\"===r.type(f))r.merge(m,f.nodeType?[f]:f);else\" if(na.test(f)){g=\"g||l.appendChild(b.createElement(\"div\")),h=(ia.exec(f)||[\"\",\"\"])[1].toLowerCase(),i=ka[h]||ka._default,g.innerHTML=i[1]+r.htmlPrefilter(f)+i[2],k=i[0];while(k--)g=g.lastChild;r.merge(m,g.childNodes),g=l.firstChild,g.textContent=\"\"}else\" m.push(b.createtextnode(f));l.textcontent=\"\" ,n=\"0;while(f=m[n++])if(d&&r.inArray(f,d)\">-1)e&&e.push(f);else if(j=r.contains(f.ownerDocument,f),g=la(l.appendChild(f),\"script\"),j&&ma(g),c){k=0;while(f=g[k++])ja.test(f.type||\"\")&&c.push(f)}return l}!function(){var a=d.createDocumentFragment(),b=a.appendChild(d.createElement(\"div\")),c=d.createElement(\"input\");c.setAttribute(\"type\",\"radio\"),c.setAttribute(\"checked\",\"checked\"),c.setAttribute(\"name\",\"t\"),b.appendChild(c),o.checkClone=b.cloneNode(!0).cloneNode(!0).lastChild.checked,b.innerHTML=\"<textarea>x</textarea>\",o.noCloneChecked=!!b.cloneNode(!0).lastChild.defaultValue}();var pa=d.documentElement,qa=/^key/,ra=/^(?:mouse|pointer|contextmenu|drag|drop)|click/,sa=/^([^.]*)(?:\\.(.+)|)/;function ta(){return!0}function ua(){return!1}function va(){try{return d.activeElement}catch(a){}}function wa(a,b,c,d,e,f){var g,h;if(\"object\"==typeof b){\"string\"!=typeof c&&(d=d||c,c=void 0);for(h in b)wa(a,h,c,d,b[h],f);return a}if(null==d&&null==e?(e=c,d=c=void 0):null==e&&(\"string\"==typeof c?(e=d,d=void 0):(e=d,d=c,c=void 0)),e===!1)e=ua;else if(!e)return a;return 1===f&&(g=e,e=function(a){return r().off(a),g.apply(this,arguments)},e.guid=g.guid||(g.guid=r.guid++)),a.each(function(){r.event.add(this,b,e,d,c)})}r.event={global:{},add:function(a,b,c,d,e){var f,g,h,i,j,k,l,m,n,o,p,q=V.get(a);if(q){c.handler&&(f=c,c=f.handler,e=f.selector),e&&r.find.matchesSelector(pa,e),c.guid||(c.guid=r.guid++),(i=q.events)||(i=q.events={}),(g=q.handle)||(g=q.handle=function(b){return\"undefined\"!=typeof r&&r.event.triggered!==b.type?r.event.dispatch.apply(a,arguments):void 0}),b=(b||\"\").match(K)||[\"\"],j=b.length;while(j--)h=sa.exec(b[j])||[],n=p=h[1],o=(h[2]||\"\").split(\".\").sort(),n&&(l=r.event.special[n]||{},n=(e?l.delegateType:l.bindType)||n,l=r.event.special[n]||{},k=r.extend({type:n,origType:p,data:d,handler:c,guid:c.guid,selector:e,needsContext:e&&r.expr.match.needsContext.test(e),namespace:o.join(\".\")},f),(m=i[n])||(m=i[n]=[],m.delegateCount=0,l.setup&&l.setup.call(a,d,o,g)!==!1||a.addEventListener&&a.addEventListener(n,g)),l.add&&(l.add.call(a,k),k.handler.guid||(k.handler.guid=c.guid)),e?m.splice(m.delegateCount++,0,k):m.push(k),r.event.global[n]=!0)}},remove:function(a,b,c,d,e){var f,g,h,i,j,k,l,m,n,o,p,q=V.hasData(a)&&V.get(a);if(q&&(i=q.events)){b=(b||\"\").match(K)||[\"\"],j=b.length;while(j--)if(h=sa.exec(b[j])||[],n=p=h[1],o=(h[2]||\"\").split(\".\").sort(),n){l=r.event.special[n]||{},n=(d?l.delegateType:l.bindType)||n,m=i[n]||[],h=h[2]&&new RegExp(\"(^|\\\\.)\"+o.join(\"\\\\.(?:.*\\\\.|)\")+\"(\\\\.|$)\"),g=f=m.length;while(f--)k=m[f],!e&&p!==k.origType||c&&c.guid!==k.guid||h&&!h.test(k.namespace)||d&&d!==k.selector&&(\"**\"!==d||!k.selector)||(m.splice(f,1),k.selector&&m.delegateCount--,l.remove&&l.remove.call(a,k));g&&!m.length&&(l.teardown&&l.teardown.call(a,o,q.handle)!==!1||r.removeEvent(a,n,q.handle),delete i[n])}else for(n in i)r.event.remove(a,n+b[j],c,d,!0);r.isEmptyObject(i)&&V.remove(a,\"handle events\")}},dispatch:function(a){var b=r.event.fix(a),c,d,e,f,g,h,i=new Array(arguments.length),j=(V.get(this,\"events\")||{})[b.type]||[],k=r.event.special[b.type]||{};for(i[0]=b,c=1;c<arguments.length;c++)i[c]=arguments[c];if(b.delegatetarget=this,!k.predispatch||k.predispatch.call(this,b)!==!1){h=r.event.handlers.call(this,b,j),c=0;while((f=h[c++])&&!b.ispropagationstopped()){b.currenttarget=f.elem,d=0;while((g=f.handlers[d++])&&!b.isimmediatepropagationstopped())b.rnamespace&&!b.rnamespace.test(g.namespace)||(b.handleobj=g,b.data=g.data,e=((r.event.special[g.origtype]||{}).handle||g.handler).apply(f.elem,i),void 0=\"==d[e]&&(d[e]=f.needsContext?r(e,this).index(i)\" 0!=\"=e&&(b.result=e)===!1&&(b.preventDefault(),b.stopPropagation()))}return\" k.postdispatch&&k.postdispatch.call(this,b),b.result}},handlers:function(a,b){var=\"\" c,d,e,f,g=\"[],h=b.delegateCount,i=a.target;if(h&&i.nodeType&&(\"click\"!==a.type||isNaN(a.button)||a.button<1))for(;i!==this;i=i.parentNode||this)if(1===i.nodeType&&(i.disabled!==!0||\"click\"!==a.type)){for(d=[],c=0;c<h;c++)f=b[c],e=f.selector+\"\" \",void=\"\">-1:r.find(e,this,null,[i]).length),d[e]&&d.push(f);d.length&&g.push({elem:i,handlers:d})}return h<b.length&&g.push({elem:this,handlers:b.slice(h)}),g},addprop:function(a,b){object.defineproperty(r.event.prototype,a,{enumerable:!0,configurable:!0,get:r.isfunction(b)?function(){if(this.originalevent)return 0=\"==a.defaultPrevented&&a.returnValue===!1?ta:ua,this.target=a.target&&3===a.target.nodeType?a.target.parentNode:a.target,this.currentTarget=a.currentTarget,this.relatedTarget=a.relatedTarget):this.type=a,b&&r.extend(this,b),this.timeStamp=a&&a.timeStamp||r.now(),void(this[r.expando]=!0)):new\" b(this.originalevent)}:function(){if(this.originalevent)return=\"\" this.originalevent[a]},set:function(b){object.defineproperty(this,a,{enumerable:!0,configurable:!0,writable:!0,value:b})}})},fix:function(a){return=\"\" a[r.expando]?a:new=\"\" r.event(a)},special:{load:{nobubble:!0},focus:{trigger:function(){if(this!=\"=va()&&this.focus)return\" this.focus(),!1},delegatetype:\"focusin\"},blur:{trigger:function(){if(this=\"==va()&&this.blur)return\" this.blur(),!1},delegatetype:\"focusout\"},click:{trigger:function(){if(\"checkbox\"=\"==this.type&&this.click&&r.nodeName(this,\"input\"))return\" this.click(),!1},_default:function(a){return=\"\" r.nodename(a.target,\"a\")}},beforeunload:{postdispatch:function(a){void=\"\" 0!=\"=a.result&&a.originalEvent&&(a.originalEvent.returnValue=a.result)}}}},r.removeEvent=function(a,b,c){a.removeEventListener&&a.removeEventListener(b,c)},r.Event=function(a,b){return\" this=\"\" instanceof=\"\" r.event?(a&&a.type?(this.originalevent=\"a,this.type=a.type,this.isDefaultPrevented=a.defaultPrevented||void\" r.event(a,b)},r.event.prototype=\"{constructor:r.Event,isDefaultPrevented:ua,isPropagationStopped:ua,isImmediatePropagationStopped:ua,isSimulated:!1,preventDefault:function(){var\" a=\"this.originalEvent;this.isDefaultPrevented=ta,a&&!this.isSimulated&&a.preventDefault()},stopPropagation:function(){var\" b=\"a.button;return\" null=\"=a.which&&qa.test(a.type)?null!=a.charCode?a.charCode:a.keyCode:!a.which&&void\" c,d=\"this,e=a.relatedTarget,f=a.handleObj;return\" e&&(e=\"==d||r.contains(d,e))||(a.type=f.origType,c=f.handler.apply(this,arguments),a.type=b),c}}}),r.fn.extend({on:function(a,b,c,d){return\" wa(this,a,b,c,d)},one:function(a,b,c,d){return=\"\" wa(this,a,b,c,d,1)},off:function(a,b,c){var=\"\" d,e;if(a&&a.preventdefault&&a.handleobj)return=\"\" d=\"a.handleObj,r(a.delegateTarget).off(d.namespace?d.origType+\".\"+d.namespace:d.origType,d.selector,d.handler),this;if(\"object\"==typeof\" a){for(e=\"\" in=\"\" a)this.off(e,b,a[e]);return=\"\" this}return=\"\" b!=\"=!1&&\"function\"!=typeof\" b||(c=\"b,b=void\" 0),c=\"==!1&&(c=ua),this.each(function(){r.event.remove(this,a,c,b)})}});var\" xa=\"/<(?!area|br|col|embed|hr|img|input|link|meta|param)(([a-z][^\\/\\0\">\\x20\\t\\r\\n\\f]*)[^>]*)\\/>/gi,ya=/<script|<style|<link i,za=\"/checked\\s*(?:[^=]|=\\s*.checked.)/i,Aa=/^true\\/(.*)/,Ba=/^\\s*<!(?:\\[CDATA\\[|--)|(?:\\]\\]|--)\">\\s*$/g;function Ca(a,b){return r.nodeName(a,\"table\")&&r.nodeName(11!==b.nodeType?b:b.firstChild,\"tr\")?a.getElementsByTagName(\"tbody\")[0]||a:a}function Da(a){return a.type=(null!==a.getAttribute(\"type\"))+\"/\"+a.type,a}function Ea(a){var b=Aa.exec(a.type);return b?a.type=b[1]:a.removeAttribute(\"type\"),a}function Fa(a,b){var c,d,e,f,g,h,i,j;if(1===b.nodeType){if(V.hasData(a)&&(f=V.access(a),g=V.set(b,f),j=f.events)){delete g.handle,g.events={};for(e in j)for(c=0,d=j[e].length;c<d;c++)r.event.add(b,e,j[e][c])}w.hasdata(a)&&(h=w.access(a),i=r.extend({},h),w.set(b,i))}}function ga(a,b){var=\"\" c=\"b.nodeName.toLowerCase();\"input\"===c&&ha.test(a.type)?b.checked=a.checked:\"input\"!==c&&\"textarea\"!==c||(b.defaultValue=a.defaultValue)}function\" ha(a,b,c,d){b=\"g.apply([],b);var\" e,f,h,i,j,k,l=\"0,m=a.length,n=m-1,q=b[0],s=r.isFunction(q);if(s||m\">1&&\"string\"==typeof q&&!o.checkClone&&za.test(q))return a.each(function(e){var f=a.eq(e);s&&(b[0]=q.call(this,e,f.html())),Ha(f,b,c,d)});if(m&&(e=oa(b,a[0].ownerDocument,!1,a,d),f=e.firstChild,1===e.childNodes.length&&(e=f),f||d)){for(h=r.map(la(e,\"script\"),Da),i=h.length;l<m;l++)j=e,l!==n&&(j=r.clone(j,!0,!0),i&&r.merge(h,la(j,\"script\"))),c.call(a[l],j,l);if(i)for(k=h[h.length-1].ownerdocument,r.map(h,ea),l=0;l<i;l++)j=h[l],ja.test(j.type||\"\")&&!v.access(j,\"globaleval\")&&r.contains(k,j)&&(j.src?r._evalurl&&r._evalurl(j.src):p(j.textcontent.replace(ba,\"\"),k))}return a}function=\"\" ia(a,b,c){for(var=\"\" d,e=\"b?r.filter(b,a):a,f=0;null!=(d=e[f]);f++)c||1!==d.nodeType||r.cleanData(la(d)),d.parentNode&&(c&&r.contains(d.ownerDocument,d)&&ma(la(d,\"script\")),d.parentNode.removeChild(d));return\" a}r.extend({htmlprefilter:function(a){return=\"\" a.replace(xa,\"<$1=\"\">\")},clone:function(a,b,c){var d,e,f,g,h=a.cloneNode(!0),i=r.contains(a.ownerDocument,a);if(!(o.noCloneChecked||1!==a.nodeType&&11!==a.nodeType||r.isXMLDoc(a)))for(g=la(h),f=la(a),d=0,e=f.length;d<e;d++)ga(f[d],g[d]);if(b)if(c)for(f=f||la(a),g=g||la(h),d=0,e=f.length;d<e;d++)fa(f[d],g[d]);else fa(a,h);return=\"\" g=\"la(h,\"script\"),g.length\">0&&ma(g,!i&&la(a,\"script\")),h},cleanData:function(a){for(var b,c,d,e=r.event.special,f=0;void 0!==(c=a[f]);f++)if(T(c)){if(b=c[V.expando]){if(b.events)for(d in b.events)e[d]?r.event.remove(c,d):r.removeEvent(c,d,b.handle);c[V.expando]=void 0}c[W.expando]&&(c[W.expando]=void 0)}}}),r.fn.extend({detach:function(a){return Ia(this,a,!0)},remove:function(a){return Ia(this,a)},text:function(a){return S(this,function(a){return void 0===a?r.text(this):this.empty().each(function(){1!==this.nodeType&&11!==this.nodeType&&9!==this.nodeType||(this.textContent=a)})},null,a,arguments.length)},append:function(){return Ha(this,arguments,function(a){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var b=Ca(this,a);b.appendChild(a)}})},prepend:function(){return Ha(this,arguments,function(a){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var b=Ca(this,a);b.insertBefore(a,b.firstChild)}})},before:function(){return Ha(this,arguments,function(a){this.parentNode&&this.parentNode.insertBefore(a,this)})},after:function(){return Ha(this,arguments,function(a){this.parentNode&&this.parentNode.insertBefore(a,this.nextSibling)})},empty:function(){for(var a,b=0;null!=(a=this[b]);b++)1===a.nodeType&&(r.cleanData(la(a,!1)),a.textContent=\"\");return this},clone:function(a,b){return a=null!=a&&a,b=null==b?a:b,this.map(function(){return r.clone(this,a,b)})},html:function(a){return S(this,function(a){var b=this[0]||{},c=0,d=this.length;if(void 0===a&&1===b.nodeType)return b.innerHTML;if(\"string\"==typeof a&&!ya.test(a)&&!ka[(ia.exec(a)||[\"\",\"\"])[1].toLowerCase()]){a=r.htmlPrefilter(a);try{for(;c<d;c++)b=this[c]||{},1===b.nodetype&&(r.cleandata(la(b,!1)),b.innerhtml=a);b=0}catch(e){}}b&&this.empty().append(a)},null,a,arguments.length)},replacewith:function(){var 0=\"==c?g&&\"get\"in\" a=\"[];return\" ha(this,arguments,function(b){var=\"\" c=\"this.parentNode;r.inArray(this,a)<0&&(r.cleanData(la(this)),c&&c.replaceChild(b,this))},a)}}),r.each({appendTo:\"append\",prependTo:\"prepend\",insertBefore:\"before\",insertAfter:\"after\",replaceAll:\"replaceWith\"},function(a,b){r.fn[a]=function(a){for(var\" c,d=\"[],e=r(a),f=e.length-1,g=0;g<=f;g++)c=g===f?this:this.clone(!0),r(e[g])[b](c),h.apply(d,c.get());return\" this.pushstack(d)}});var=\"\" ja=\"/^margin/,Ka=new\" regexp(\"^(\"+$+\")(?!px)[a-z%]+$\",\"i\"),la=\"function(b){var\" c&&c.opener||(c=\"a),c.getComputedStyle(b)};!function(){function\" b(){if(i){i.style.csstext=\"box-sizing:border-box;position:relative;display:block;margin:auto;border:1px;padding:1px;top:1%;width:50%\" ,i.innerhtml=\"\" ,pa.appendchild(h);var=\"\" b=\"a.getComputedStyle(i);c=\"1%\"!==b.top,g=\"2px\"===b.marginLeft,e=\"4px\"===b.width,i.style.marginRight=\"50%\",f=\"4px\"===b.marginRight,pa.removeChild(h),i=null}}var\" c,e,f,g,h=\"d.createElement(\"div\"),i=d.createElement(\"div\");i.style&&(i.style.backgroundClip=\"content-box\",i.cloneNode(!0).style.backgroundClip=\"\",o.clearCloneStyle=\"content-box\"===i.style.backgroundClip,h.style.cssText=\"border:0;width:8px;height:0;top:0;left:-9999px;padding:0;margin-top:1px;position:absolute\",h.appendChild(i),r.extend(o,{pixelPosition:function(){return\" b(),c},boxsizingreliable:function(){return=\"\" b(),e},pixelmarginright:function(){return=\"\" b(),f},reliablemarginleft:function(){return=\"\" b(),g}}))}();function=\"\" ma(a,b,c){var=\"\" d,e,f,g,h=\"a.style;return\" 0!=\"=g?g+\"\":g}function\" na(a,b){return{get:function(){return=\"\" a()?void=\"\" delete=\"\" this.get:(this.get=\"b).apply(this,arguments)}}}var\" oa=\"/^(none|table(?!-c[ea]).+)/,Pa={position:\"absolute\",visibility:\"hidden\",display:\"block\"},Qa={letterSpacing:\"0\",fontWeight:\"400\"},Ra=[\"Webkit\",\"Moz\",\"ms\"],Sa=d.createElement(\"div\").style;function\" ta(a){if(a=\"\" in=\"\" sa)return=\"\" a;var=\"\" a}function=\"\" ua(a,b,c){var=\"\" d=\"_.exec(b);return\" d?math.max(0,d[2]-(c||0))+(d[3]||\"px\"):b}function=\"\" va(a,b,c,d,e){for(var=\"\" f=\"c===(d?\"border\":\"content\")?4:\"width\"===b?1:0,g=0;f<4;f+=2)\"margin\"===c&&(g+=r.css(a,c+aa[f],!0,e)),d?(\"content\"===c&&(g-=r.css(a,\"padding\"+aa[f],!0,e)),\"margin\"!==c&&(g-=r.css(a,\"border\"+aa[f]+\"Width\",!0,e))):(g+=r.css(a,\"padding\"+aa[f],!0,e),\"padding\"!==c&&(g+=r.css(a,\"border\"+aa[f]+\"Width\",!0,e)));return\" g}function=\"\" wa(a,b,c){var=\"\" d,e=\"!0,f=La(a),g=\"border-box\"===r.css(a,\"boxSizing\",!1,f);if(a.getClientRects().length&&(d=a.getBoundingClientRect()[b]),d<=0||null==d){if(d=Ma(a,b,f),(d<0||null==d)&&(d=a.style[b]),Ka.test(d))return\" d;e=\"g&&(o.boxSizingReliable()||d===a.style[b]),d=parseFloat(d)||0}return\" d+va(a,b,c||(g?\"border\":\"content\"),e,f)+\"px\"}r.extend({csshooks:{opacity:{get:function(a,b){if(b){var=\"\" e,f,g,h=\"r.camelCase(b),i=a.style;return\" g&&void=\"\" c,\"string\"=\"==f&&(e=_.exec(c))&&e[1]&&(c=da(a,b,e),f=\"number\"),null!=c&&c===c&&(\"number\"===f&&(c+=e&&e[3]||(r.cssNumber[h]?\"\":\"px\")),o.clearCloneStyle||\"\"!==c||0!==b.indexOf(\"background\")||(i[b]=\"inherit\"),g&&\"set\"in\" 0)}},css:function(a,b,c,d){var=\"\" g&&(e=\"g.get(a,!0,c)),void\" qa&&(e=\"Qa[b]),\"\"===c||c?(f=parseFloat(e),c===!0||isFinite(f)?f||0:e):e}}),r.each([\"height\",\"width\"],function(a,b){r.cssHooks[b]={get:function(a,c,d){if(c)return!Oa.test(r.css(a,\"display\"))||a.getClientRects().length&&a.getBoundingClientRect().width?Wa(a,b,d):ca(a,Pa,function(){return\" wa(a,b,d)})},set:function(a,c,d){var=\"\" e,f=\"d&&La(a),g=d&&Va(a,b,d,\"border-box\"===r.css(a,\"boxSizing\",!1,f),f);return\" a.getboundingclientrect().left}))+\"px\"}),r.each({margin:\"\",padding:\"\",border:\"width\"},function(a,b){r.csshooks[a+b]=\"{expand:function(c){for(var\" c?c.split(\"=\"\" \"):[c];d<4;d++)e[a+aa[d]+b]=\"f[d]||f[d-2]||f[0];return\" e}},ja.test(a)||(r.csshooks[a+b].set=\"Ua)}),r.fn.extend({css:function(a,b){return\" s(this,function(a,b,c){var=\"\" d,e,f=\"{},g=0;if(r.isArray(b)){for(d=La(a),e=b.length;g<e;g++)f[b[g]]=r.css(a,b[g],!1,d);return\" f}return=\"\" void=\"\">1)}});function Xa(a,b,c,d,e){return new Xa.prototype.init(a,b,c,d,e)}r.Tween=Xa,Xa.prototype={constructor:Xa,init:function(a,b,c,d,e,f){this.elem=a,this.prop=c,this.easing=e||r.easing._default,this.options=b,this.start=this.now=this.cur(),this.end=d,this.unit=f||(r.cssNumber[c]?\"\":\"px\")},cur:function(){var a=Xa.propHooks[this.prop];return a&&a.get?a.get(this):Xa.propHooks._default.get(this)},run:function(a){var b,c=Xa.propHooks[this.prop];return this.options.duration?this.pos=b=r.easing[this.easing](a,this.options.duration*a,0,1,this.options.duration):this.pos=b=a,this.now=(this.end-this.start)*b+this.start,this.options.step&&this.options.step.call(this.elem,this.now,this),c&&c.set?c.set(this):Xa.propHooks._default.set(this),this}},Xa.prototype.init.prototype=Xa.prototype,Xa.propHooks={_default:{get:function(a){var b;return 1!==a.elem.nodeType||null!=a.elem[a.prop]&&null==a.elem.style[a.prop]?a.elem[a.prop]:(b=r.css(a.elem,a.prop,\"\"),b&&\"auto\"!==b?b:0)},set:function(a){r.fx.step[a.prop]?r.fx.step[a.prop](a):1!==a.elem.nodeType||null==a.elem.style[r.cssProps[a.prop]]&&!r.cssHooks[a.prop]?a.elem[a.prop]=a.now:r.style(a.elem,a.prop,a.now+a.unit)}}},Xa.propHooks.scrollTop=Xa.propHooks.scrollLeft={set:function(a){a.elem.nodeType&&a.elem.parentNode&&(a.elem[a.prop]=a.now)}},r.easing={linear:function(a){return a},swing:function(a){return.5-Math.cos(a*Math.PI)/2},_default:\"swing\"},r.fx=Xa.prototype.init,r.fx.step={};var Ya,Za,$a=/^(?:toggle|show|hide)$/,_a=/queueHooks$/;function ab(){Za&&(a.requestAnimationFrame(ab),r.fx.tick())}function bb(){return a.setTimeout(function(){Ya=void 0}),Ya=r.now()}function cb(a,b){var c,d=0,e={height:a};for(b=b?1:0;d<4;d+=2-b)c=aa[d],e[\"margin\"+c]=e[\"padding\"+c]=a;return 0=\"==q[d])continue;p=!0}n[d]=q&&q[d]||r.style(a,d)}if(i=!r.isEmptyObject(b),i||!r.isEmptyObject(n)){l&&1===a.nodeType&&(c.overflow=[o.overflow,o.overflowX,o.overflowY],j=q&&q.display,null==j&&(j=V.get(a,\"display\")),k=r.css(a,\"display\"),\"none\"===k&&(j?k=j:(ga([a],!0),j=a.style.display||j,k=r.css(a,\"display\"),ga([a]))),(\"inline\"===k||\"inline-block\"===k&&null!=j)&&\"none\"===r.css(a,\"float\")&&(i||(m.done(function(){o.display=j}),null==j&&(k=o.display,j=\"none\"===k?\"\":k)),o.display=\"inline-block\")),c.overflow&&(o.overflow=\"hidden\",m.always(function(){o.overflow=c.overflow[0],o.overflowX=c.overflow[1],o.overflowY=c.overflow[2]})),i=!1;for(d\" b&&(e.opacity=\"e.width=a),e}function\" db(a,b,c){for(var=\"\" d,e=\"(gb.tweeners[b]||[]).concat(gb.tweeners[\"*\"]),f=0,g=e.length;f<g;f++)if(d=e[f].call(c,b,a))return\" d}function=\"\" eb(a,b,c){var=\"\" d,e,f,g,h,i,j,k,l=\"width\" in=\"\" b||\"height\"in=\"\" b,m=\"this,n={},o=a.style,p=a.nodeType&&ba(a),q=V.get(a,\"fxshow\");c.queue||(g=r._queueHooks(a,\"fx\"),null==g.unqueued&&(g.unqueued=0,h=g.empty.fire,g.empty.fire=function(){g.unqueued||h()}),g.unqueued++,m.always(function(){m.always(function(){g.unqueued--,r.queue(a,\"fx\").length||g.empty.fire()})}));for(d\" b)if(e=\"b[d],$a.test(e)){if(delete\" b[d],f=\"f||\"toggle\"===e,e===(p?\"hide\":\"show\")){if(\"show\"!==e||!q||void\" n)i||(q?\"hidden\"in=\"\" q&&(p=\"q.hidden):q=V.access(a,\"fxshow\",{display:j}),f&&(q.hidden=!p),p&&ga([a],!0),m.done(function(){p||ga([a]),V.remove(a,\"fxshow\");for(d\" n)r.style(a,d,n[d])})),i=\"db(p?q[d]:0,d,m),d\" q||(q[d]=\"i.start,p&&(i.end=i.start,i.start=0))}}function\" fb(a,b){var=\"\" c,d,e,f,g;for(c=\"\" a)if(d=\"r.camelCase(c),e=b[d],f=a[c],r.isArray(f)&&(e=f[1],f=a[c]=f[0]),c!==d&&(a[d]=f,delete\" a[c]),g=\"r.cssHooks[d],g&&\"expand\"in\" g){f=\"g.expand(f),delete\" a[d];for(c=\"\" f)c=\"\" a||(a[c]=\"f[c],b[c]=e)}else\" b[d]=\"e}function\" gb(a,b,c){var=\"\" d,e,f=\"0,g=gb.prefilters.length,h=r.Deferred().always(function(){delete\" i.elem}),i=\"function(){if(e)return!1;for(var\" b=\"Ya||bb(),c=Math.max(0,j.startTime+j.duration-b),d=c/j.duration||0,f=1-d,g=0,i=j.tweens.length;g<i;g++)j.tweens[g].run(f);return\" h.notifywith(a,[j,f,c]),f<1&&i?c:(h.resolvewith(a,[j]),!1)},j=\"h.promise({elem:a,props:r.extend({},b),opts:r.extend(!0,{specialEasing:{},easing:r.easing._default},c),originalProperties:b,originalOptions:c,startTime:Ya||bb(),duration:c.duration,tweens:[],createTween:function(b,c){var\" d=\"r.Tween(a,j.opts,b,c,j.opts.specialEasing[b]||j.opts.easing);return\" j.tweens.push(d),d},stop:function(b){var=\"\" c=\"0,d=b?j.tweens.length:0;if(e)return\" this;for(e=\"!0;c<d;c++)j.tweens[c].run(1);return\" b?(h.notifywith(a,[j,1,0]),h.resolvewith(a,[j,b])):h.rejectwith(a,[j,b]),this}}),k=\"j.props;for(fb(k,j.opts.specialEasing);f<g;f++)if(d=gb.prefilters[f].call(j,a,k,j.opts))return\" r.isfunction(d.stop)&&(r._queuehooks(j.elem,j.opts.queue).stop=\"r.proxy(d.stop,d)),d;return\" r.map(k,db,j),r.isfunction(j.opts.start)&&j.opts.start.call(a,j),r.fx.timer(r.extend(i,{elem:a,anim:j,queue:j.opts.queue})),j.progress(j.opts.progress).done(j.opts.done,j.opts.complete).fail(j.opts.fail).always(j.opts.always)}r.animation=\"r.extend(gb,{tweeners:{\"*\":[function(a,b){var\" da(c.elem,a,_.exec(b),c),c}]},tweener:function(a,b){r.isfunction(a)?(b=\"a,a=[\"*\"]):a=a.match(K);for(var\" c,d=\"0,e=a.length;d<e;d++)c=a[d],gb.tweeners[c]=gb.tweeners[c]||[],gb.tweeners[c].unshift(b)},prefilters:[eb],prefilter:function(a,b){b?gb.prefilters.unshift(a):gb.prefilters.push(a)}}),r.speed=function(a,b,c){var\" e=\"a&&\"object\"==typeof\" a?r.extend({},a):{complete:c||!c&&b||r.isfunction(a)&&a,duration:a,easing:c&&b||b&&!r.isfunction(b)&&b};return=\"\" r.fx.off||d.hidden?e.duration=\"0:e.duration=\"number\"==typeof\" e.duration?e.duration:e.duration=\"\" r.fx.speeds?r.fx.speeds[e.duration]:r.fx.speeds._default,null!=\"e.queue&&e.queue!==!0||(e.queue=\"fx\"),e.old=e.complete,e.complete=function(){r.isFunction(e.old)&&e.old.call(this),e.queue&&r.dequeue(this,e.queue)},e},r.fn.extend({fadeTo:function(a,b,c,d){return\" this.filter(ba).css(\"opacity\",0).show().end().animate({opacity:b},a,c,d)},animate:function(a,b,c,d){var=\"\" g.finish=\"g,e||f.queue===!1?this.each(g):this.queue(f.queue,g)},stop:function(a,b,c){var\" a.stop,b(c)};return\"string\"!=\"typeof\" a&&(c=\"b,b=a,a=void\" 0),b&&a!=\"=!1&&this.queue(a||\"fx\",[]),this.each(function(){var\" for(e=\"\" g)g[e]&&g[e].stop&&_a.test(e)&&d(g[e]);for(e=\"f.length;e--;)f[e].elem!==this||null!=a&&f[e].queue!==a||(f[e].anim.stop(c),b=!1,f.splice(e,1));!b&&c||r.dequeue(this,a)})},finish:function(a){return\" a!=\"=!1&&(a=a||\"fx\"),this.each(function(){var\" b,c=\"V.get(this),d=c[a+\"queue\"],e=c[a+\"queueHooks\"],f=r.timers,g=d?d.length:0;for(c.finish=!0,r.queue(this,a,[]),e&&e.stop&&e.stop.call(this,!0),b=f.length;b--;)f[b].elem===this&&f[b].queue===a&&(f[b].anim.stop(!0),f.splice(b,1));for(b=0;b<g;b++)d[b]&&d[b].finish&&d[b].finish.call(this);delete\" c.finish})}}),r.each([\"toggle\",\"show\",\"hide\"],function(a,b){var=\"\" null=\"=a||\"boolean\"==typeof\" a?c.apply(this,arguments):this.animate(cb(b,!0),a,d,e)}}),r.each({slidedown:cb(\"show\"),slideup:cb(\"hide\"),slidetoggle:cb(\"toggle\"),fadein:{opacity:\"show\"},fadeout:{opacity:\"hide\"},fadetoggle:{opacity:\"toggle\"}},function(a,b){r.fn[a]=\"function(a,c,d){return\" this.animate(b,a,c,d)}}),r.timers=\"[],r.fx.tick=function(){var\" a,b=\"0,c=r.timers;for(Ya=r.now();b<c.length;b++)a=c[b],a()||c[b]!==a||c.splice(b--,1);c.length||r.fx.stop(),Ya=void\" 0},r.fx.timer=\"function(a){r.timers.push(a),a()?r.fx.start():r.timers.pop()},r.fx.interval=13,r.fx.start=function(){Za||(Za=a.requestAnimationFrame?a.requestAnimationFrame(ab):a.setInterval(r.fx.tick,r.fx.interval))},r.fx.stop=function(){a.cancelAnimationFrame?a.cancelAnimationFrame(Za):a.clearInterval(Za),Za=null},r.fx.speeds={slow:600,fast:200,_default:400},r.fn.delay=function(b,c){return\" a=\"d.createElement(\"input\"),b=d.createElement(\"select\"),c=b.appendChild(d.createElement(\"option\"));a.type=\"checkbox\",o.checkOn=\"\"!==a.value,o.optSelected=c.selected,a=d.createElement(\"input\"),a.value=\"t\",a.type=\"radio\",o.radioValue=\"t\"===a.value}();var\" hb,ib=\"r.expr.attrHandle;r.fn.extend({attr:function(a,b){return\" s(this,r.attr,a,b,arguments.length=\"\">1)},removeAttr:function(a){return this.each(function(){r.removeAttr(this,a)})}}),r.extend({attr:function(a,b,c){var d,e,f=a.nodeType;if(3!==f&&8!==f&&2!==f)return\"undefined\"==typeof a.getAttribute?r.prop(a,b,c):(1===f&&r.isXMLDoc(a)||(e=r.attrHooks[b.toLowerCase()]||(r.expr.match.bool.test(b)?hb:void 0)),void 0!==c?null===c?void r.removeAttr(a,b):e&&\"set\"in e&&void 0!==(d=e.set(a,c,b))?d:(a.setAttribute(b,c+\"\"),c):e&&\"get\"in e&&null!==(d=e.get(a,b))?d:(d=r.find.attr(a,b),null==d?void 0:d))},attrHooks:{type:{set:function(a,b){if(!o.radioValue&&\"radio\"===b&&r.nodeName(a,\"input\")){var c=a.value;return a.setAttribute(\"type\",b),c&&(a.value=c),b}}}},removeAttr:function(a,b){var c,d=0,e=b&&b.match(K);\nif(e&&1===a.nodeType)while(c=e[d++])a.removeAttribute(c)}}),hb={set:function(a,b,c){return b===!1?r.removeAttr(a,c):a.setAttribute(c,c),c}},r.each(r.expr.match.bool.source.match(/\\w+/g),function(a,b){var c=ib[b]||r.find.attr;ib[b]=function(a,b,d){var e,f,g=b.toLowerCase();return d||(f=ib[g],ib[g]=e,e=null!=c(a,b,d)?g:null,ib[g]=f),e}});var jb=/^(?:input|select|textarea|button)$/i,kb=/^(?:a|area)$/i;r.fn.extend({prop:function(a,b){return S(this,r.prop,a,b,arguments.length>1)},removeProp:function(a){return this.each(function(){delete this[r.propFix[a]||a]})}}),r.extend({prop:function(a,b,c){var d,e,f=a.nodeType;if(3!==f&&8!==f&&2!==f)return 1===f&&r.isXMLDoc(a)||(b=r.propFix[b]||b,e=r.propHooks[b]),void 0!==c?e&&\"set\"in e&&void 0!==(d=e.set(a,c,b))?d:a[b]=c:e&&\"get\"in e&&null!==(d=e.get(a,b))?d:a[b]},propHooks:{tabIndex:{get:function(a){var b=r.find.attr(a,\"tabindex\");return b?parseInt(b,10):jb.test(a.nodeName)||kb.test(a.nodeName)&&a.href?0:-1}}},propFix:{\"for\":\"htmlFor\",\"class\":\"className\"}}),o.optSelected||(r.propHooks.selected={get:function(a){var b=a.parentNode;return b&&b.parentNode&&b.parentNode.selectedIndex,null},set:function(a){var b=a.parentNode;b&&(b.selectedIndex,b.parentNode&&b.parentNode.selectedIndex)}}),r.each([\"tabIndex\",\"readOnly\",\"maxLength\",\"cellSpacing\",\"cellPadding\",\"rowSpan\",\"colSpan\",\"useMap\",\"frameBorder\",\"contentEditable\"],function(){r.propFix[this.toLowerCase()]=this});var lb=/[\\t\\r\\n\\f]/g;function mb(a){return a.getAttribute&&a.getAttribute(\"class\")||\"\"}r.fn.extend({addClass:function(a){var b,c,d,e,f,g,h,i=0;if(r.isFunction(a))return this.each(function(b){r(this).addClass(a.call(this,b,mb(this)))});if(\"string\"==typeof a&&a){b=a.match(K)||[];while(c=this[i++])if(e=mb(c),d=1===c.nodeType&&(\" \"+e+\" \").replace(lb,\" \")){g=0;while(f=b[g++])d.indexOf(\" \"+f+\" \")<0&&(d+=f+\" \");h=\"r.trim(d),e!==h&&c.setAttribute(\"class\",h)}}return\" this},removeclass:function(a){var=\"\" b,c,d,e,f,g,h,i=\"0;if(r.isFunction(a))return\" this.each(function(b){r(this).removeclass(a.call(this,b,mb(this)))});if(!arguments.length)return=\"\" this.attr(\"class\",\"\");if(\"string\"=\"=typeof\" a&&a){b=\"a.match(K)||[];while(c=this[i++])if(e=mb(c),d=1===c.nodeType&&(\"\" \"+e+\"=\"\" \").replace(lb,\"=\"\" \")){g=\"0;while(f=b[g++])while(d.indexOf(\"\" \"+f+\"=\"\" \")=\"\">-1)d=d.replace(\" \"+f+\" \",\" \");h=r.trim(d),e!==h&&c.setAttribute(\"class\",h)}}return this},toggleClass:function(a,b){var c=typeof a;return\"boolean\"==typeof b&&\"string\"===c?b?this.addClass(a):this.removeClass(a):r.isFunction(a)?this.each(function(c){r(this).toggleClass(a.call(this,c,mb(this),b),b)}):this.each(function(){var b,d,e,f;if(\"string\"===c){d=0,e=r(this),f=a.match(K)||[];while(b=f[d++])e.hasClass(b)?e.removeClass(b):e.addClass(b)}else void 0!==a&&\"boolean\"!==c||(b=mb(this),b&&V.set(this,\"__className__\",b),this.setAttribute&&this.setAttribute(\"class\",b||a===!1?\"\":V.get(this,\"__className__\")||\"\"))})},hasClass:function(a){var b,c,d=0;b=\" \"+a+\" \";while(c=this[d++])if(1===c.nodeType&&(\" \"+mb(c)+\" \").replace(lb,\" \").indexOf(b)>-1)return!0;return!1}});var nb=/\\r/g,ob=/[\\x20\\t\\r\\n\\f]+/g;r.fn.extend({val:function(a){var b,c,d,e=this[0];{if(arguments.length)return d=r.isFunction(a),this.each(function(c){var e;1===this.nodeType&&(e=d?a.call(this,c,r(this).val()):a,null==e?e=\"\":\"number\"==typeof e?e+=\"\":r.isArray(e)&&(e=r.map(e,function(a){return null==a?\"\":a+\"\"})),b=r.valHooks[this.type]||r.valHooks[this.nodeName.toLowerCase()],b&&\"set\"in b&&void 0!==b.set(this,e,\"value\")||(this.value=e))});if(e)return b=r.valHooks[e.type]||r.valHooks[e.nodeName.toLowerCase()],b&&\"get\"in b&&void 0!==(c=b.get(e,\"value\"))?c:(c=e.value,\"string\"==typeof c?c.replace(nb,\"\"):null==c?\"\":c)}}}),r.extend({valHooks:{option:{get:function(a){var b=r.find.attr(a,\"value\");return null!=b?b:r.trim(r.text(a)).replace(ob,\" \")}},select:{get:function(a){for(var b,c,d=a.options,e=a.selectedIndex,f=\"select-one\"===a.type,g=f?null:[],h=f?e+1:d.length,i=e<0?h:f?e:0;i<h;i++)if(c=d[i],(c.selected||i===e)&&!c.disabled&&(!c.parentnode.disabled||!r.nodename(c.parentnode,\"optgroup\"))){if(b=r(c).val(),f)return b;g.push(b)}return=\"\" g},set:function(a,b){var=\"\" c,d,e=\"a.options,f=r.makeArray(b),g=e.length;while(g--)d=e[g],(d.selected=r.inArray(r.valHooks.option.get(d),f)\">-1)&&(c=!0);return c||(a.selectedIndex=-1),f}}}}),r.each([\"radio\",\"checkbox\"],function(){r.valHooks[this]={set:function(a,b){if(r.isArray(b))return a.checked=r.inArray(r(a).val(),b)>-1}},o.checkOn||(r.valHooks[this].get=function(a){return null===a.getAttribute(\"value\")?\"on\":a.value})});var pb=/^(?:focusinfocus|focusoutblur)$/;r.extend(r.event,{trigger:function(b,c,e,f){var g,h,i,j,k,m,n,o=[e||d],p=l.call(b,\"type\")?b.type:b,q=l.call(b,\"namespace\")?b.namespace.split(\".\"):[];if(h=i=e=e||d,3!==e.nodeType&&8!==e.nodeType&&!pb.test(p+r.event.triggered)&&(p.indexOf(\".\")>-1&&(q=p.split(\".\"),p=q.shift(),q.sort()),k=p.indexOf(\":\")<0&&\"on\"+p,b=b[r.expando]?b:new r.event(p,\"object\"=\"=typeof\" b&&b),b.istrigger=\"f?2:3,b.namespace=q.join(\".\"),b.rnamespace=b.namespace?new\" regexp(\"(^|\\\\.)\"+q.join(\"\\\\.(?:.*\\\\.|)\")+\"(\\\\.|$)\"):null,b.result=\"void\" 0,b.target||(b.target=\"e),c=null==c?[b]:r.makeArray(c,[b]),n=r.event.special[p]||{},f||!n.trigger||n.trigger.apply(e,c)!==!1)){if(!f&&!n.noBubble&&!r.isWindow(e)){for(j=n.delegateType||p,pb.test(j+p)||(h=h.parentNode);h;h=h.parentNode)o.push(h),i=h;i===(e.ownerDocument||d)&&o.push(i.defaultView||i.parentWindow||a)}g=0;while((h=o[g++])&&!b.isPropagationStopped())b.type=g\">1?j:n.bindType||p,m=(V.get(h,\"events\")||{})[b.type]&&V.get(h,\"handle\"),m&&m.apply(h,c),m=k&&h[k],m&&m.apply&&T(h)&&(b.result=m.apply(h,c),b.result===!1&&b.preventDefault());return b.type=p,f||b.isDefaultPrevented()||n._default&&n._default.apply(o.pop(),c)!==!1||!T(e)||k&&r.isFunction(e[p])&&!r.isWindow(e)&&(i=e[k],i&&(e[k]=null),r.event.triggered=p,e[p](),r.event.triggered=void 0,i&&(e[k]=i)),b.result}},simulate:function(a,b,c){var d=r.extend(new r.Event,c,{type:a,isSimulated:!0});r.event.trigger(d,null,b)}}),r.fn.extend({trigger:function(a,b){return this.each(function(){r.event.trigger(a,b,this)})},triggerHandler:function(a,b){var c=this[0];if(c)return r.event.trigger(a,b,c,!0)}}),r.each(\"blur focus focusin focusout resize scroll click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup contextmenu\".split(\" \"),function(a,b){r.fn[b]=function(a,c){return arguments.length>0?this.on(b,null,a,c):this.trigger(b)}}),r.fn.extend({hover:function(a,b){return this.mouseenter(a).mouseleave(b||a)}}),o.focusin=\"onfocusin\"in a,o.focusin||r.each({focus:\"focusin\",blur:\"focusout\"},function(a,b){var c=function(a){r.event.simulate(b,a.target,r.event.fix(a))};r.event.special[b]={setup:function(){var d=this.ownerDocument||this,e=V.access(d,b);e||d.addEventListener(a,c,!0),V.access(d,b,(e||0)+1)},teardown:function(){var d=this.ownerDocument||this,e=V.access(d,b)-1;e?V.access(d,b,e):(d.removeEventListener(a,c,!0),V.remove(d,b))}}});var qb=a.location,rb=r.now(),sb=/\\?/;r.parseXML=function(b){var c;if(!b||\"string\"!=typeof b)return null;try{c=(new a.DOMParser).parseFromString(b,\"text/xml\")}catch(d){c=void 0}return c&&!c.getElementsByTagName(\"parsererror\").length||r.error(\"Invalid XML: \"+b),c};var tb=/\\[\\]$/,ub=/\\r?\\n/g,vb=/^(?:submit|button|image|reset|file)$/i,wb=/^(?:input|select|textarea|keygen)/i;function xb(a,b,c,d){var e;if(r.isArray(b))r.each(b,function(b,e){c||tb.test(a)?d(a,e):xb(a+\"[\"+(\"object\"==typeof e&&null!=e?b:\"\")+\"]\",e,c,d)});else if(c||\"object\"!==r.type(b))d(a,b);else for(e in b)xb(a+\"[\"+e+\"]\",b[e],c,d)}r.param=function(a,b){var c,d=[],e=function(a,b){var c=r.isFunction(b)?b():b;d[d.length]=encodeURIComponent(a)+\"=\"+encodeURIComponent(null==c?\"\":c)};if(r.isArray(a)||a.jquery&&!r.isPlainObject(a))r.each(a,function(){e(this.name,this.value)});else for(c in a)xb(c,a[c],b,e);return d.join(\"&\")},r.fn.extend({serialize:function(){return r.param(this.serializeArray())},serializeArray:function(){return this.map(function(){var a=r.prop(this,\"elements\");return a?r.makeArray(a):this}).filter(function(){var a=this.type;return this.name&&!r(this).is(\":disabled\")&&wb.test(this.nodeName)&&!vb.test(a)&&(this.checked||!ha.test(a))}).map(function(a,b){var c=r(this).val();return null==c?null:r.isArray(c)?r.map(c,function(a){return{name:b.name,value:a.replace(ub,\"\\r\\n\")}}):{name:b.name,value:c.replace(ub,\"\\r\\n\")}}).get()}});var yb=/%20/g,zb=/#.*$/,Ab=/([?&])_=[^&]*/,Bb=/^(.*?):[ \\t]*([^\\r\\n]*)$/gm,Cb=/^(?:about|app|app-storage|.+-extension|file|res|widget):$/,Db=/^(?:GET|HEAD)$/,Eb=/^\\/\\//,Fb={},Gb={},Hb=\"*/\".concat(\"*\"),Ib=d.createElement(\"a\");Ib.href=qb.href;function Jb(a){return function(b,c){\"string\"!=typeof b&&(c=b,b=\"*\");var d,e=0,f=b.toLowerCase().match(K)||[];if(r.isFunction(c))while(d=f[e++])\"+\"===d[0]?(d=d.slice(1)||\"*\",(a[d]=a[d]||[]).unshift(c)):(a[d]=a[d]||[]).push(c)}}function Kb(a,b,c,d){var e={},f=a===Gb;function g(h){var i;return e[h]=!0,r.each(a[h]||[],function(a,h){var j=h(b,c,d);return\"string\"!=typeof j||f||e[j]?f?!(i=j):void 0:(b.dataTypes.unshift(j),g(j),!1)}),i}return g(b.dataTypes[0])||!e[\"*\"]&&g(\"*\")}function Lb(a,b){var c,d,e=r.ajaxSettings.flatOptions||{};for(c in b)void 0!==b[c]&&((e[c]?a:d||(d={}))[c]=b[c]);return d&&r.extend(!0,a,d),a}function Mb(a,b,c){var d,e,f,g,h=a.contents,i=a.dataTypes;while(\"*\"===i[0])i.shift(),void 0===d&&(d=a.mimeType||b.getResponseHeader(\"Content-Type\"));if(d)for(e in h)if(h[e]&&h[e].test(d)){i.unshift(e);break}if(i[0]in c)f=i[0];else{for(e in c){if(!i[0]||a.converters[e+\" \"+i[0]]){f=e;break}g||(g=e)}f=f||g}if(f)return f!==i[0]&&i.unshift(f),c[f]}function Nb(a,b,c,d){var e,f,g,h,i,j={},k=a.dataTypes.slice();if(k[1])for(g in a.converters)j[g.toLowerCase()]=a.converters[g];f=k.shift();while(f)if(a.responseFields[f]&&(c[a.responseFields[f]]=b),!i&&d&&a.dataFilter&&(b=a.dataFilter(b,a.dataType)),i=f,f=k.shift())if(\"*\"===f)f=i;else if(\"*\"!==i&&i!==f){if(g=j[i+\" \"+f]||j[\"* \"+f],!g)for(e in j)if(h=e.split(\" \"),h[1]===f&&(g=j[i+\" \"+h[0]]||j[\"* \"+h[0]])){g===!0?g=j[e]:j[e]!==!0&&(f=h[0],k.unshift(h[1]));break}if(g!==!0)if(g&&a[\"throws\"])b=g(b);else try{b=g(b)}catch(l){return{state:\"parsererror\",error:g?l:\"No conversion from \"+i+\" to \"+f}}}return{state:\"success\",data:b}}r.extend({active:0,lastModified:{},etag:{},ajaxSettings:{url:qb.href,type:\"GET\",isLocal:Cb.test(qb.protocol),global:!0,processData:!0,async:!0,contentType:\"application/x-www-form-urlencoded; charset=UTF-8\",accepts:{\"*\":Hb,text:\"text/plain\",html:\"text/html\",xml:\"application/xml, text/xml\",json:\"application/json, text/javascript\"},contents:{xml:/\\bxml\\b/,html:/\\bhtml/,json:/\\bjson\\b/},responseFields:{xml:\"responseXML\",text:\"responseText\",json:\"responseJSON\"},converters:{\"* text\":String,\"text html\":!0,\"text json\":JSON.parse,\"text xml\":r.parseXML},flatOptions:{url:!0,context:!0}},ajaxSetup:function(a,b){return b?Lb(Lb(a,r.ajaxSettings),b):Lb(r.ajaxSettings,a)},ajaxPrefilter:Jb(Fb),ajaxTransport:Jb(Gb),ajax:function(b,c){\"object\"==typeof b&&(c=b,b=void 0),c=c||{};var e,f,g,h,i,j,k,l,m,n,o=r.ajaxSetup({},c),p=o.context||o,q=o.context&&(p.nodeType||p.jquery)?r(p):r.event,s=r.Deferred(),t=r.Callbacks(\"once memory\"),u=o.statusCode||{},v={},w={},x=\"canceled\",y={readyState:0,getResponseHeader:function(a){var b;if(k){if(!h){h={};while(b=Bb.exec(g))h[b[1].toLowerCase()]=b[2]}b=h[a.toLowerCase()]}return null==b?null:b},getAllResponseHeaders:function(){return k?g:null},setRequestHeader:function(a,b){return null==k&&(a=w[a.toLowerCase()]=w[a.toLowerCase()]||a,v[a]=b),this},overrideMimeType:function(a){return null==k&&(o.mimeType=a),this},statusCode:function(a){var b;if(a)if(k)y.always(a[y.status]);else for(b in a)u[b]=[u[b],a[b]];return this},abort:function(a){var b=a||x;return e&&e.abort(b),A(0,b),this}};if(s.promise(y),o.url=((b||o.url||qb.href)+\"\").replace(Eb,qb.protocol+\"//\"),o.type=c.method||c.type||o.method||o.type,o.dataTypes=(o.dataType||\"*\").toLowerCase().match(K)||[\"\"],null==o.crossDomain){j=d.createElement(\"a\");try{j.href=o.url,j.href=j.href,o.crossDomain=Ib.protocol+\"//\"+Ib.host!=j.protocol+\"//\"+j.host}catch(z){o.crossDomain=!0}}if(o.data&&o.processData&&\"string\"!=typeof o.data&&(o.data=r.param(o.data,o.traditional)),Kb(Fb,o,c,y),k)return y;l=r.event&&o.global,l&&0===r.active++&&r.event.trigger(\"ajaxStart\"),o.type=o.type.toUpperCase(),o.hasContent=!Db.test(o.type),f=o.url.replace(zb,\"\"),o.hasContent?o.data&&o.processData&&0===(o.contentType||\"\").indexOf(\"application/x-www-form-urlencoded\")&&(o.data=o.data.replace(yb,\"+\")):(n=o.url.slice(f.length),o.data&&(f+=(sb.test(f)?\"&\":\"?\")+o.data,delete o.data),o.cache===!1&&(f=f.replace(Ab,\"\"),n=(sb.test(f)?\"&\":\"?\")+\"_=\"+rb++ +n),o.url=f+n),o.ifModified&&(r.lastModified[f]&&y.setRequestHeader(\"If-Modified-Since\",r.lastModified[f]),r.etag[f]&&y.setRequestHeader(\"If-None-Match\",r.etag[f])),(o.data&&o.hasContent&&o.contentType!==!1||c.contentType)&&y.setRequestHeader(\"Content-Type\",o.contentType),y.setRequestHeader(\"Accept\",o.dataTypes[0]&&o.accepts[o.dataTypes[0]]?o.accepts[o.dataTypes[0]]+(\"*\"!==o.dataTypes[0]?\", \"+Hb+\"; q=0.01\":\"\"):o.accepts[\"*\"]);for(m in o.headers)y.setRequestHeader(m,o.headers[m]);if(o.beforeSend&&(o.beforeSend.call(p,y,o)===!1||k))return y.abort();if(x=\"abort\",t.add(o.complete),y.done(o.success),y.fail(o.error),e=Kb(Gb,o,c,y)){if(y.readyState=1,l&&q.trigger(\"ajaxSend\",[y,o]),k)return y;o.async&&o.timeout>0&&(i=a.setTimeout(function(){y.abort(\"timeout\")},o.timeout));try{k=!1,e.send(v,A)}catch(z){if(k)throw z;A(-1,z)}}else A(-1,\"No Transport\");function A(b,c,d,h){var j,m,n,v,w,x=c;k||(k=!0,i&&a.clearTimeout(i),e=void 0,g=h||\"\",y.readyState=b>0?4:0,j=b>=200&&b<300||304===b,d&&(v=mb(o,y,d)),v=nb(o,v,y,j),j?(o.ifmodified&&(w=y.getresponseheader(\"last-modified\"),w&&(r.lastmodified[f]=w),w=y.getresponseheader(\"etag\"),w&&(r.etag[f]=w)),204===b||\"head\"===o.type?x=\"nocontent\":304===b?x=\"notmodified\":(x=v.state,m=v.data,n=v.error,j=!n)):(n=x,!b&&x||(x=\"error\",b<0&&(b=0))),y.status=b,y.statustext=(c||x)+\"\",j?s.resolvewith(p,[m,x,y]):s.rejectwith(p,[y,x,n]),y.statuscode(u),u=void 0=\"==a.cache&&(a.cache=!1),a.crossDomain&&(a.type=\"GET\")}),r.ajaxTransport(\"script\",function(a){if(a.crossDomain){var\" 0,l&&q.trigger(j?\"ajaxsuccess\":\"ajaxerror\",[y,o,j?m:n]),t.firewith(p,[y,x]),l&&(q.trigger(\"ajaxcomplete\",[y,o]),--r.active||r.event.trigger(\"ajaxstop\")))}return=\"\" y},getjson:function(a,b,c){return=\"\" r.get(a,b,c,\"json\")},getscript:function(a,b){return=\"\" r.get(a,void=\"\" 0,b,\"script\")}}),r.each([\"get\",\"post\"],function(a,b){r[b]=\"function(a,c,d,e){return\" r.isfunction(c)&&(e=\"e||d,d=c,c=void\" 0),r.ajax(r.extend({url:a,type:b,datatype:e,data:c,success:d},r.isplainobject(a)&&a))}}),r._evalurl=\"function(a){return\" r.ajax({url:a,type:\"get\",datatype:\"script\",cache:!0,async:!1,global:!1,\"throws\":!0})},r.fn.extend({wrapall:function(a){var=\"\" b;return=\"\" this[0]&&(r.isfunction(a)&&(a=\"a.call(this[0])),b=r(a,this[0].ownerDocument).eq(0).clone(!0),this[0].parentNode&&b.insertBefore(this[0]),b.map(function(){var\" a=\"this;while(a.firstElementChild)a=a.firstElementChild;return\" a}).append(this)),this},wrapinner:function(a){return=\"\" r.isfunction(a)?this.each(function(b){r(this).wrapinner(a.call(this,b))}):this.each(function(){var=\"\" b=\"r(this),c=b.contents();c.length?c.wrapAll(a):b.append(a)})},wrap:function(a){var\" this.each(function(c){r(this).wrapall(b?a.call(this,c):a)})},unwrap:function(a){return=\"\" this.parent(a).not(\"body\").each(function(){r(this).replacewith(this.childnodes)}),this}}),r.expr.pseudos.hidden=\"function(a){return!r.expr.pseudos.visible(a)},r.expr.pseudos.visible=function(a){return!!(a.offsetWidth||a.offsetHeight||a.getClientRects().length)},r.ajaxSettings.xhr=function(){try{return\" new=\"\" a.xmlhttprequest}catch(b){}};var=\"\" ob=\"{0:200,1223:204},Pb=r.ajaxSettings.xhr();o.cors=!!Pb&&\"withCredentials\"in\" pb,o.ajax=\"Pb=!!Pb,r.ajaxTransport(function(b){var\" c,d;if(o.cors||pb&&!b.crossdomain)return{send:function(e,f){var=\"\" g,h=\"b.xhr();if(h.open(b.type,b.url,b.async,b.username,b.password),b.xhrFields)for(g\" in=\"\" b.xhrfields)h[g]=\"b.xhrFields[g];b.mimeType&&h.overrideMimeType&&h.overrideMimeType(b.mimeType),b.crossDomain||e[\"X-Requested-With\"]||(e[\"X-Requested-With\"]=\"XMLHttpRequest\");for(g\" e)h.setrequestheader(g,e[g]);c=\"function(a){return\" function(){c&&(c=\"d=h.onload=h.onerror=h.onabort=h.onreadystatechange=null,\"abort\"===a?h.abort():\"error\"===a?\"number\"!=typeof\" h.status?f(0,\"error\"):f(h.status,h.statustext):f(ob[h.status]||h.status,h.statustext,\"text\"!=\"=(h.responseType||\"text\")||\"string\"!=typeof\" h.responsetext?{binary:h.response}:{text:h.responsetext},h.getallresponseheaders()))}},h.onload=\"c(),d=h.onerror=c(\"error\"),void\" 0!=\"=h.onabort?h.onabort=d:h.onreadystatechange=function(){4===h.readyState&&a.setTimeout(function(){c&&d()})},c=c(\"abort\");try{h.send(b.hasContent&&b.data||null)}catch(i){if(c)throw\" i}},abort:function(){c&&c()}}}),r.ajaxprefilter(function(a){a.crossdomain&&(a.contents.script=\"!1)}),r.ajaxSetup({accepts:{script:\"text/javascript,\" application=\"\" javascript,=\"\" ecmascript,=\"\" x-ecmascript\"},contents:{script:=\"\" \\b(?:java|ecma)script\\b=\"\" },converters:{\"text=\"\" script\":function(a){return=\"\" r.globaleval(a),a}}}),r.ajaxprefilter(\"script\",function(a){void=\"\" b,c;return{send:function(e,f){b=\"r(\"<script\">\").prop({charset:a.scriptCharset,src:a.url}).on(\"load error\",c=function(a){b.remove(),c=null,a&&f(\"error\"===a.type?404:200,a.type)}),d.head.appendChild(b[0])},abort:function(){c&&c()}}}});var Qb=[],Rb=/(=)\\?(?=&|$)|\\?\\?/;r.ajaxSetup({jsonp:\"callback\",jsonpCallback:function(){var a=Qb.pop()||r.expando+\"_\"+rb++;return this[a]=!0,a}}),r.ajaxPrefilter(\"json jsonp\",function(b,c,d){var e,f,g,h=b.jsonp!==!1&&(Rb.test(b.url)?\"url\":\"string\"==typeof b.data&&0===(b.contentType||\"\").indexOf(\"application/x-www-form-urlencoded\")&&Rb.test(b.data)&&\"data\");if(h||\"jsonp\"===b.dataTypes[0])return e=b.jsonpCallback=r.isFunction(b.jsonpCallback)?b.jsonpCallback():b.jsonpCallback,h?b[h]=b[h].replace(Rb,\"$1\"+e):b.jsonp!==!1&&(b.url+=(sb.test(b.url)?\"&\":\"?\")+b.jsonp+\"=\"+e),b.converters[\"script json\"]=function(){return g||r.error(e+\" was not called\"),g[0]},b.dataTypes[0]=\"json\",f=a[e],a[e]=function(){g=arguments},d.always(function(){void 0===f?r(a).removeProp(e):a[e]=f,b[e]&&(b.jsonpCallback=c.jsonpCallback,Qb.push(e)),g&&r.isFunction(f)&&f(g[0]),g=f=void 0}),\"script\"}),o.createHTMLDocument=function(){var a=d.implementation.createHTMLDocument(\"\").body;return a.innerHTML=\"<form></form><form></form>\",2===a.childNodes.length}(),r.parseHTML=function(a,b,c){if(\"string\"!=typeof a)return[];\"boolean\"==typeof b&&(c=b,b=!1);var e,f,g;return b||(o.createHTMLDocument?(b=d.implementation.createHTMLDocument(\"\"),e=b.createElement(\"base\"),e.href=d.location.href,b.head.appendChild(e)):b=d),f=B.exec(a),g=!c&&[],f?[b.createElement(f[1])]:(f=oa([a],b,g),g&&g.length&&r(g).remove(),r.merge([],f.childNodes))},r.fn.load=function(a,b,c){var d,e,f,g=this,h=a.indexOf(\" \");return h>-1&&(d=r.trim(a.slice(h)),a=a.slice(0,h)),r.isFunction(b)?(c=b,b=void 0):b&&\"object\"==typeof b&&(e=\"POST\"),g.length>0&&r.ajax({url:a,type:e||\"GET\",dataType:\"html\",data:b}).done(function(a){f=arguments,g.html(d?r(\"<div>\").append(r.parseHTML(a)).find(d):a)}).always(c&&function(a,b){g.each(function(){c.apply(this,f||[a.responseText,b,a])})}),this},r.each([\"ajaxStart\",\"ajaxStop\",\"ajaxComplete\",\"ajaxError\",\"ajaxSuccess\",\"ajaxSend\"],function(a,b){r.fn[b]=function(a){return this.on(b,a)}}),r.expr.pseudos.animated=function(a){return r.grep(r.timers,function(b){return a===b.elem}).length};function Sb(a){return r.isWindow(a)?a:9===a.nodeType&&a.defaultView}r.offset={setOffset:function(a,b,c){var d,e,f,g,h,i,j,k=r.css(a,\"position\"),l=r(a),m={};\"static\"===k&&(a.style.position=\"relative\"),h=l.offset(),f=r.css(a,\"top\"),i=r.css(a,\"left\"),j=(\"absolute\"===k||\"fixed\"===k)&&(f+i).indexOf(\"auto\")>-1,j?(d=l.position(),g=d.top,e=d.left):(g=parseFloat(f)||0,e=parseFloat(i)||0),r.isFunction(b)&&(b=b.call(a,c,r.extend({},h))),null!=b.top&&(m.top=b.top-h.top+g),null!=b.left&&(m.left=b.left-h.left+e),\"using\"in b?b.using.call(a,m):l.css(m)}},r.fn.extend({offset:function(a){if(arguments.length)return void 0===a?this:this.each(function(b){r.offset.setOffset(this,a,b)});var b,c,d,e,f=this[0];if(f)return f.getClientRects().length?(d=f.getBoundingClientRect(),d.width||d.height?(e=f.ownerDocument,c=Sb(e),b=e.documentElement,{top:d.top+c.pageYOffset-b.clientTop,left:d.left+c.pageXOffset-b.clientLeft}):d):{top:0,left:0}},position:function(){if(this[0]){var a,b,c=this[0],d={top:0,left:0};return\"fixed\"===r.css(c,\"position\")?b=c.getBoundingClientRect():(a=this.offsetParent(),b=this.offset(),r.nodeName(a[0],\"html\")||(d=a.offset()),d={top:d.top+r.css(a[0],\"borderTopWidth\",!0),left:d.left+r.css(a[0],\"borderLeftWidth\",!0)}),{top:b.top-d.top-r.css(c,\"marginTop\",!0),left:b.left-d.left-r.css(c,\"marginLeft\",!0)}}},offsetParent:function(){return this.map(function(){var a=this.offsetParent;while(a&&\"static\"===r.css(a,\"position\"))a=a.offsetParent;return a||pa})}}),r.each({scrollLeft:\"pageXOffset\",scrollTop:\"pageYOffset\"},function(a,b){var c=\"pageYOffset\"===b;r.fn[a]=function(d){return S(this,function(a,d,e){var f=Sb(a);return void 0===e?f?f[b]:a[d]:void(f?f.scrollTo(c?f.pageXOffset:e,c?e:f.pageYOffset):a[d]=e)},a,d,arguments.length)}}),r.each([\"top\",\"left\"],function(a,b){r.cssHooks[b]=Na(o.pixelPosition,function(a,c){if(c)return c=Ma(a,b),Ka.test(c)?r(a).position()[b]+\"px\":c})}),r.each({Height:\"height\",Width:\"width\"},function(a,b){r.each({padding:\"inner\"+a,content:b,\"\":\"outer\"+a},function(c,d){r.fn[d]=function(e,f){var g=arguments.length&&(c||\"boolean\"!=typeof e),h=c||(e===!0||f===!0?\"margin\":\"border\");return S(this,function(b,c,e){var f;return r.isWindow(b)?0===d.indexOf(\"outer\")?b[\"inner\"+a]:b.document.documentElement[\"client\"+a]:9===b.nodeType?(f=b.documentElement,Math.max(b.body[\"scroll\"+a],f[\"scroll\"+a],b.body[\"offset\"+a],f[\"offset\"+a],f[\"client\"+a])):void 0===e?r.css(b,c,h):r.style(b,c,e,h)},b,g?e:void 0,g)}})}),r.fn.extend({bind:function(a,b,c){return this.on(a,null,b,c)},unbind:function(a,b){return this.off(a,null,b)},delegate:function(a,b,c,d){return this.on(b,a,c,d)},undelegate:function(a,b,c){return 1===arguments.length?this.off(a,\"**\"):this.off(b,a||\"**\",c)}}),r.parseJSON=JSON.parse,\"function\"==typeof define&&define.amd&&define(\"jquery\",[],function(){return r});var Tb=a.jQuery,Ub=a.$;return r.noConflict=function(b){return a.$===r&&(a.$=Ub),b&&a.jQuery===r&&(a.jQuery=Tb),r},b||(a.jQuery=a.$=r),r});\n</div></300||304===b,d&&(v=mb(o,y,d)),v=nb(o,v,y,j),j?(o.ifmodified&&(w=y.getresponseheader(\"last-modified\"),w&&(r.lastmodified[f]=w),w=y.getresponseheader(\"etag\"),w&&(r.etag[f]=w)),204===b||\"head\"===o.type?x=\"nocontent\":304===b?x=\"notmodified\":(x=v.state,m=v.data,n=v.error,j=!n)):(n=x,!b&&x||(x=\"error\",b<0&&(b=0))),y.status=b,y.statustext=(c||x)+\"\",j?s.resolvewith(p,[m,x,y]):s.rejectwith(p,[y,x,n]),y.statuscode(u),u=void></0&&\"on\"+p,b=b[r.expando]?b:new></0?h:f?e:0;i<h;i++)if(c=d[i],(c.selected||i===e)&&!c.disabled&&(!c.parentnode.disabled||!r.nodename(c.parentnode,\"optgroup\"))){if(b=r(c).val(),f)return></0&&(d+=f+\"></4;d+=2-b)c=aa[d],e[\"margin\"+c]=e[\"padding\"+c]=a;return></d;c++)b=this[c]||{},1===b.nodetype&&(r.cleandata(la(b,!1)),b.innerhtml=a);b=0}catch(e){}}b&&this.empty().append(a)},null,a,arguments.length)},replacewith:function(){var></e;d++)ga(f[d],g[d]);if(b)if(c)for(f=f||la(a),g=g||la(h),d=0,e=f.length;d<e;d++)fa(f[d],g[d]);else></m;l++)j=e,l!==n&&(j=r.clone(j,!0,!0),i&&r.merge(h,la(j,\"script\"))),c.call(a[l],j,l);if(i)for(k=h[h.length-1].ownerdocument,r.map(h,ea),l=0;l<i;l++)j=h[l],ja.test(j.type||\"\")&&!v.access(j,\"globaleval\")&&r.contains(k,j)&&(j.src?r._evalurl&&r._evalurl(j.src):p(j.textcontent.replace(ba,\"\"),k))}return></d;c++)r.event.add(b,e,j[e][c])}w.hasdata(a)&&(h=w.access(a),i=r.extend({},h),w.set(b,i))}}function></script|<style|<link></b.length&&g.push({elem:this,handlers:b.slice(h)}),g},addprop:function(a,b){object.defineproperty(r.event.prototype,a,{enumerable:!0,configurable:!0,get:r.isfunction(b)?function(){if(this.originalevent)return></arguments.length;c++)i[c]=arguments[c];if(b.delegatetarget=this,!k.predispatch||k.predispatch.call(this,b)!==!1){h=r.event.handlers.call(this,b,j),c=0;while((f=h[c++])&&!b.ispropagationstopped()){b.currenttarget=f.elem,d=0;while((g=f.handlers[d++])&&!b.isimmediatepropagationstopped())b.rnamespace&&!b.rnamespace.test(g.namespace)||(b.handleobj=g,b.data=g.data,e=((r.event.special[g.origtype]||{}).handle||g.handler).apply(f.elem,i),void></d;c++)v.set(a[c],\"globaleval\",!b||v.get(b[c],\"globaleval\"))}var></c?r.queue(this[0],a):void></i;h++)b(a[h],c,g?d:d.call(a[h],h,b(a[h],c)));return></=1&&(o(a,g.done(h(c)).resolve,g.reject),\"pending\"===g.state()||r.isfunction(e[c]&&e[c].then)))return></f)){if(a=d.apply(h,i),a===c.promise())throw></=h&&h--}),this},has:function(a){return></f.length)f[h].apply(c[0],c[1])===!1&&a.stoponfalse&&(h=f.length,c=!1)}a.memory||(c=!1),b=!1,e&&(f=c?[]:\"\")},j={add:function(){return></c;a++)if(r.contains(this,b[a]))return!0})},closest:function(a,b){var></\"===a[0]&&\"></[\\w\\w]+></d;b++)if(r.contains(e[b],this))return!0}));for(c=this.pushstack([]),b=0;b<d;b++)r.find(a,e[b],c);return></\\></([a-z][^\\></e&&ya(a.slice(i,e)),e<f&&ya(a=a.slice(e)),e<f&&sa(a))}m.push(c)}return></f;i++)if(c=d.relative[a[i].type])m=[ta(ua(m),c)];else{if(c=d.filter[a[i].type].apply(null,a[i].matches),c[u]){for(e=++i;e<f;e++)if(d.relative[a[e].type])break;return></e;d++)ga(a,b[d],c);return></0?c+b:c;++d<b;)a.push(d);return></6)return!1;return!0},parent:function(a){return!d.pseudos.empty(a)},header:function(a){return></0?string.fromcharcode(d+65536):string.fromcharcode(d></d;c++)if(a[c]===b)return></b?[this[c]]:[])},end:function(){return></0?this[a+this.length]:this[a]:f.call(this)},pushstack:function(a){var>"}],"Post":[{"title":"Hello Go","date":"2016-09-11T09:21:03.000Z","_content":"\n##### Mac 安装 GO\n\n本人使用了Brew来安装。\n\n##### 安装前首先更新Brew。\n\n```\nbrew update && brew upgrade\n```\n\n##### 安装Go\n\n使用brew安装go\n\n```\nbrew install go\n```\n\n##### 设置$GOPATH\n\nGo从1.1版本开始必须设置这个变量，也就是说通过以上方式安装后就必须要设置$GOPATH了。\n\n这个目录用来存放Go源码，可运行文件，和编译之后的包文件。\n\nMac系统设置\n\n在bash中加入：\n\n```shell\nexport GOPATH=/your/path\n```\n\n以上目录需要存在，不存在就自己手动创建一个。\n\n然后运行\n\n```shell\nsource ~/.zshrc\n```\n\n替换成你自己使用的shell，如.bashrc等。\n\n然后，需要在/your/path目录下，新建 pkg，bin，src目录。\n\n​\tsrc目录存放源代码，如hello.go\n\n​\tpkg目录存放编译后的文件，如hello.a\n\n​\tbin目录存放生成后的可执行文件\n\nsrc目录就是主要开发目录。如hello项目，则在src下新建hello目录。\n\n到这里，就可以开始Go之旅了。\n\n##### Hello Go\n\n需要注意的是，在Go中，包名和文件名是可以不同的，包名为main的时候即为可以独立运行的包。\n\n在src目录新建hello目录，创建hello.go文件。\n\n```go\npackage main //包名\n\nimport \"fmt\" //导入一个系统级别的fmt包\n\n//使用func定义函数\n//main函数没有参数，没有返回值\nfunc main() {\n  fmt.Println(\"Hello Go\") //调用包函数的方法为 pkgName.funcName\n}\n```\n\n一个hello.go就写好了，在命令行输入\n\n```go\ngo run hello.go\n```\n\n就可以看到输出Hello Go了。","source":"_posts/Hello-Go.md","raw":"title: Hello Go\ncategories: golang\ndate: 2016-09-11 17:21:03\ntags:  [go]\n\n---\n\n##### Mac 安装 GO\n\n本人使用了Brew来安装。\n\n##### 安装前首先更新Brew。\n\n```\nbrew update && brew upgrade\n```\n\n##### 安装Go\n\n使用brew安装go\n\n```\nbrew install go\n```\n\n##### 设置$GOPATH\n\nGo从1.1版本开始必须设置这个变量，也就是说通过以上方式安装后就必须要设置$GOPATH了。\n\n这个目录用来存放Go源码，可运行文件，和编译之后的包文件。\n\nMac系统设置\n\n在bash中加入：\n\n```shell\nexport GOPATH=/your/path\n```\n\n以上目录需要存在，不存在就自己手动创建一个。\n\n然后运行\n\n```shell\nsource ~/.zshrc\n```\n\n替换成你自己使用的shell，如.bashrc等。\n\n然后，需要在/your/path目录下，新建 pkg，bin，src目录。\n\n​\tsrc目录存放源代码，如hello.go\n\n​\tpkg目录存放编译后的文件，如hello.a\n\n​\tbin目录存放生成后的可执行文件\n\nsrc目录就是主要开发目录。如hello项目，则在src下新建hello目录。\n\n到这里，就可以开始Go之旅了。\n\n##### Hello Go\n\n需要注意的是，在Go中，包名和文件名是可以不同的，包名为main的时候即为可以独立运行的包。\n\n在src目录新建hello目录，创建hello.go文件。\n\n```go\npackage main //包名\n\nimport \"fmt\" //导入一个系统级别的fmt包\n\n//使用func定义函数\n//main函数没有参数，没有返回值\nfunc main() {\n  fmt.Println(\"Hello Go\") //调用包函数的方法为 pkgName.funcName\n}\n```\n\n一个hello.go就写好了，在命令行输入\n\n```go\ngo run hello.go\n```\n\n就可以看到输出Hello Go了。","slug":"Hello-Go","published":1,"updated":"2016-09-11T09:21:09.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj830jvcs0000ul0rjjmbwzdl","content":"<h5 id=\"Mac-安装-GO\"><a href=\"#Mac-安装-GO\" class=\"headerlink\" title=\"Mac 安装 GO\"></a>Mac 安装 GO</h5><p>本人使用了Brew来安装。</p>\n<h5 id=\"安装前首先更新Brew。\"><a href=\"#安装前首先更新Brew。\" class=\"headerlink\" title=\"安装前首先更新Brew。\"></a>安装前首先更新Brew。</h5><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">brew update &amp;&amp; brew upgrade</div></pre></td></tr></table></figure>\n<h5 id=\"安装Go\"><a href=\"#安装Go\" class=\"headerlink\" title=\"安装Go\"></a>安装Go</h5><p>使用brew安装go</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">brew install go</div></pre></td></tr></table></figure>\n<h5 id=\"设置-GOPATH\"><a href=\"#设置-GOPATH\" class=\"headerlink\" title=\"设置$GOPATH\"></a>设置$GOPATH</h5><p>Go从1.1版本开始必须设置这个变量，也就是说通过以上方式安装后就必须要设置$GOPATH了。</p>\n<p>这个目录用来存放Go源码，可运行文件，和编译之后的包文件。</p>\n<p>Mac系统设置</p>\n<p>在bash中加入：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">export GOPATH=/your/path</div></pre></td></tr></table></figure>\n<p>以上目录需要存在，不存在就自己手动创建一个。</p>\n<p>然后运行</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">source ~/.zshrc</div></pre></td></tr></table></figure>\n<p>替换成你自己使用的shell，如.bashrc等。</p>\n<p>然后，需要在/your/path目录下，新建 pkg，bin，src目录。</p>\n<p>​    src目录存放源代码，如hello.go</p>\n<p>​    pkg目录存放编译后的文件，如hello.a</p>\n<p>​    bin目录存放生成后的可执行文件</p>\n<p>src目录就是主要开发目录。如hello项目，则在src下新建hello目录。</p>\n<p>到这里，就可以开始Go之旅了。</p>\n<h5 id=\"Hello-Go\"><a href=\"#Hello-Go\" class=\"headerlink\" title=\"Hello Go\"></a>Hello Go</h5><p>需要注意的是，在Go中，包名和文件名是可以不同的，包名为main的时候即为可以独立运行的包。</p>\n<p>在src目录新建hello目录，创建hello.go文件。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">package</span> main <span class=\"comment\">//包名</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">import</span> <span class=\"string\">\"fmt\"</span> <span class=\"comment\">//导入一个系统级别的fmt包</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">//使用func定义函数</span></div><div class=\"line\"><span class=\"comment\">//main函数没有参数，没有返回值</span></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</div><div class=\"line\">  fmt.Println(<span class=\"string\">\"Hello Go\"</span>) <span class=\"comment\">//调用包函数的方法为 pkgName.funcName</span></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>一个hello.go就写好了，在命令行输入</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">go</span> run hello.<span class=\"keyword\">go</span></div></pre></td></tr></table></figure>\n<p>就可以看到输出Hello Go了。</p>\n","site":{"data":{}},"excerpt":"","more":"<h5 id=\"Mac-安装-GO\"><a href=\"#Mac-安装-GO\" class=\"headerlink\" title=\"Mac 安装 GO\"></a>Mac 安装 GO</h5><p>本人使用了Brew来安装。</p>\n<h5 id=\"安装前首先更新Brew。\"><a href=\"#安装前首先更新Brew。\" class=\"headerlink\" title=\"安装前首先更新Brew。\"></a>安装前首先更新Brew。</h5><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">brew update &amp;&amp; brew upgrade</div></pre></td></tr></table></figure>\n<h5 id=\"安装Go\"><a href=\"#安装Go\" class=\"headerlink\" title=\"安装Go\"></a>安装Go</h5><p>使用brew安装go</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">brew install go</div></pre></td></tr></table></figure>\n<h5 id=\"设置-GOPATH\"><a href=\"#设置-GOPATH\" class=\"headerlink\" title=\"设置$GOPATH\"></a>设置$GOPATH</h5><p>Go从1.1版本开始必须设置这个变量，也就是说通过以上方式安装后就必须要设置$GOPATH了。</p>\n<p>这个目录用来存放Go源码，可运行文件，和编译之后的包文件。</p>\n<p>Mac系统设置</p>\n<p>在bash中加入：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">export GOPATH=/your/path</div></pre></td></tr></table></figure>\n<p>以上目录需要存在，不存在就自己手动创建一个。</p>\n<p>然后运行</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">source ~/.zshrc</div></pre></td></tr></table></figure>\n<p>替换成你自己使用的shell，如.bashrc等。</p>\n<p>然后，需要在/your/path目录下，新建 pkg，bin，src目录。</p>\n<p>​    src目录存放源代码，如hello.go</p>\n<p>​    pkg目录存放编译后的文件，如hello.a</p>\n<p>​    bin目录存放生成后的可执行文件</p>\n<p>src目录就是主要开发目录。如hello项目，则在src下新建hello目录。</p>\n<p>到这里，就可以开始Go之旅了。</p>\n<h5 id=\"Hello-Go\"><a href=\"#Hello-Go\" class=\"headerlink\" title=\"Hello Go\"></a>Hello Go</h5><p>需要注意的是，在Go中，包名和文件名是可以不同的，包名为main的时候即为可以独立运行的包。</p>\n<p>在src目录新建hello目录，创建hello.go文件。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">package</span> main <span class=\"comment\">//包名</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">import</span> <span class=\"string\">\"fmt\"</span> <span class=\"comment\">//导入一个系统级别的fmt包</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">//使用func定义函数</span></div><div class=\"line\"><span class=\"comment\">//main函数没有参数，没有返回值</span></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</div><div class=\"line\">  fmt.Println(<span class=\"string\">\"Hello Go\"</span>) <span class=\"comment\">//调用包函数的方法为 pkgName.funcName</span></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>一个hello.go就写好了，在命令行输入</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">go</span> run hello.<span class=\"keyword\">go</span></div></pre></td></tr></table></figure>\n<p>就可以看到输出Hello Go了。</p>\n"},{"title":"在Go中使用 HTTP/2 Server Push","date":"2017-07-01T16:09:13.000Z","_content":"\n#### 写在前面\n\n本文来自[Golang的官方博客](https://blog.golang.org/h2push)，由 Jaana Burcu Dogan, Tom Bergan 发表于2017年3月24日。\n\n近来看到此篇，觉得不错，非常适合用来学习Go中的 Server Push ，于是决定翻译一下，水平有限，如有不足不恰当的地方还请提出宝贵意见。\n\n#### 序\n\nHTTP/2旨在解决HTTP/1.x的很多问题。现代网页通常包含很多资源：HTML，css，js，图片等等。在 HTTP/1.x 中，必须明确地请求这些资源。这是一个缓慢的过程。浏览器必须从获取HTML开始，然后在解析页面时获取更多资源。由于服务器必须等待浏览器发起请求，网络通常处于空闲，没有充分利用。\n\n为了改善延迟，HTTP/2引入了 Server Push ，这允许服务器在明确的请求之前将资源推送到浏览器。服务器通常会知道一个页面所需要的额外的资源，并且可以在响应初始请求时开始推送这些资源。这就允许服务器充分利用空闲的网络来改善加载时间。\n\n![server push示意](/images/go/serverpush.svg)\n\n在协议层，HTTP/2 Server Push 由 PUSH_PROMISE 帧发起。PUSH_PROMISE 表明了服务器向客户端推送资源的意图。一旦浏览器接收到PUSH_PROMISE，它就会知道服务器会推送资源。如果浏览器后来发现需要这个资源，它会等待推送完成，而不是发起一个新的请求。这减少了浏览器在网络上等待的时间。\n\n#### net/http 包中的 Server Push\n\nGo1.8 引入了 http.Server 对 push 响应的支持，如果运行的服务器是 HTTP/2 服务器，并且请求连接使用了 HTTP/2，则可以使用此功能。在任何HTTP处理程序中，可以通过检查 http.ResponseWriter 是否实现了 http.Pusher 接口来判断是否支持 Server Push。\n\n例如，如果服务器知道一个页面中包含 app.js，处理程序可以初始化一个 http.Pusher。\n\n```go\nhttp.HandleFunc(\"/\", func(w http.ResponseWriter, r *http.Request) {\n  if push, ok := w.(http.Pusher); ok {\n    //支持Push\n    if err := pusher.Push(\"/app.js\", nil); err != nil {\n      log.Printf(\"Failed to push: %v\", err)\n    }\n  }\n  // ...\n})\n```\n\nPush会为 app.js 创建一个 “合成请求”，将该请求合成到 PUSH_PROMISE 帧中，然后将请求转发到服务器的请求处理程序，请求处理程序会生成响应。Push的第二个参数指定了包含在 PUSH_PROMISE 中的附加header头，例如，如果对 app.js 的响应在 Accept-Encoding 上不同，则 PUSH_PROMISE 应包含 Accept-Encoding 的值。\n\n```go\nhttp.HandleFunc(\"/\", func(w http.ResponseWriter, r *http.Request) {\n  if pusher, ok := w.(http.Pusher); ok {\n    //支持Push\n    options := &http.PushOptions{\n      Header: http.Header{\n        \"Accept-Encoding\": r.Header[\"Accept-Encoding\"],\n      },\n    }\n    if err := pusher.Pusher(\"/app.js\", options); err != nil {\n      log.Printf(\"Failed to push: %v\", err)\n    }\n  }\n  // ...\n})\n```\n\n完整示例见：\n\n```shell\n$ go get golang.org/x/blog/content/h2push/server\n```\n\n启动服务，然后打开 [https://localhost:8080](https://localhost:8080)，浏览器开发工具应该会显示服务器推送了 app.js 和 style.css 。\n\n![网络请求耗时](/images/go/networktimeline.png)\n\n#### 在响应前开始Push\n\n在发送响应之前调用Push是个好主意，否则可能会意外产生重复的响应，例如，假设下边是HTML响应的一部分：\n\n```html\n<html>\n<head>\n\t<link rel=\"stylesheet\" href=\"a.cs\">...\t\n```\n\n然后调用 Push(\"a.css\", nil) ，浏览器可能会在接收到 PUSH_PROMISE 之前就开始解析这段 HTM L了，这种情况下，浏览器除了接收到 PUSH_PROMISE 之外，还会发起一个 a.css 的请求，那么服务器就会为 a.css 生成两个请求。而在写入响应之前调用PUSH则避免了这种可能性。\n\n#### 何时使用Server Push\n\n应该考虑在任何网络连接空闲时使用 Server Push 。刚完成为 web app 发送 HTML ？不要浪费时间等待请求，开始推送客户端需要用到的资源，你有没有过将资源嵌入到 HTML 文件中以减少延迟？替换掉内联，尝试使用推送。重定向是另一个使用推送的好时机，因为客户端在这个过程中几乎把时间全浪费在请求的往返上。有很多情况适合使用 Push ，我们才刚刚开始。\n\n如果没有提到以下几个注意事项，将是我们的失职。\n\n​\t首先，只能推送当前服务器上的资源-这意味着无法推送托管在第三方服务器或CDN上的资源。\n\n​\t第二，除非能确定客户端确实需要，否则不要推送，这样会浪费带宽。当浏览器已经缓存了某些资源时， 必须要避免推送。\n\n​\t第三，天真的把所有资源推送到页面会使性能更糟糕。\n\n以下链接可以作为补充阅读：\n\n- [HTTP/2 Push: The Details](https://calendar.perfplanet.com/2016/http2-push-the-details/)\n- [Innovating with HTTP/2 Server Push](https://www.igvita.com/2013/06/12/innovating-with-http-2.0-server-push/)\n- [Cache-Aware Server Push in H2O](https://github.com/h2o/h2o/issues/421)\n- [The PRPL Pattern](https://developers.google.com/web/fundamentals/performance/prpl-pattern/)\n- [Rules of Thumb for HTTP/2 Push](https://docs.google.com/document/d/1K0NykTXBbbbTlv60t5MyJvXjqKGsCVNYHyLEXIxYMv0)\n- [Server Push in the HTTP/2 spec](https://tools.ietf.org/html/rfc7540#section-8.2)\n\n#### 结尾\n\nGo1.8 标准库为 HTTP/2 Server Push 提供了开箱即用的支持，为优化 Web 应用程序提供更多灵活性。\n\n转到[HTTP/2 Server Push演示页面](https://http2.golang.org/serverpush)查看实际效果。\n\n#### 一些资料\n\n[HTTP/2 简介](https://developers.google.com/web/fundamentals/performance/http2/?hl=zh-cn)\n\nHTTP/2 Server Push 详解：\n\n原文：\n\n[A Comprehensive Guide To HTTP/2 Server Push](https://www.smashingmagazine.com/2017/04/guide-http2-server-push/)\n\n译文：\n\n[HTTP/2 Server Push 详解（上）](http://www.alloyteam.com/2017/04/guide-http2-server-push-part1/)\n\n[HTTP/2 Server Push 详解（下）](http://www.alloyteam.com/2017/04/guide-http2-server-push-part2/)","source":"_posts/HTTP2-Server-Push.md","raw":"title: 在Go中使用 HTTP/2 Server Push\ncategories: golang\ndate: 2017-07-02 00:09:13\ntags:  [go]\n\n---\n\n#### 写在前面\n\n本文来自[Golang的官方博客](https://blog.golang.org/h2push)，由 Jaana Burcu Dogan, Tom Bergan 发表于2017年3月24日。\n\n近来看到此篇，觉得不错，非常适合用来学习Go中的 Server Push ，于是决定翻译一下，水平有限，如有不足不恰当的地方还请提出宝贵意见。\n\n#### 序\n\nHTTP/2旨在解决HTTP/1.x的很多问题。现代网页通常包含很多资源：HTML，css，js，图片等等。在 HTTP/1.x 中，必须明确地请求这些资源。这是一个缓慢的过程。浏览器必须从获取HTML开始，然后在解析页面时获取更多资源。由于服务器必须等待浏览器发起请求，网络通常处于空闲，没有充分利用。\n\n为了改善延迟，HTTP/2引入了 Server Push ，这允许服务器在明确的请求之前将资源推送到浏览器。服务器通常会知道一个页面所需要的额外的资源，并且可以在响应初始请求时开始推送这些资源。这就允许服务器充分利用空闲的网络来改善加载时间。\n\n![server push示意](/images/go/serverpush.svg)\n\n在协议层，HTTP/2 Server Push 由 PUSH_PROMISE 帧发起。PUSH_PROMISE 表明了服务器向客户端推送资源的意图。一旦浏览器接收到PUSH_PROMISE，它就会知道服务器会推送资源。如果浏览器后来发现需要这个资源，它会等待推送完成，而不是发起一个新的请求。这减少了浏览器在网络上等待的时间。\n\n#### net/http 包中的 Server Push\n\nGo1.8 引入了 http.Server 对 push 响应的支持，如果运行的服务器是 HTTP/2 服务器，并且请求连接使用了 HTTP/2，则可以使用此功能。在任何HTTP处理程序中，可以通过检查 http.ResponseWriter 是否实现了 http.Pusher 接口来判断是否支持 Server Push。\n\n例如，如果服务器知道一个页面中包含 app.js，处理程序可以初始化一个 http.Pusher。\n\n```go\nhttp.HandleFunc(\"/\", func(w http.ResponseWriter, r *http.Request) {\n  if push, ok := w.(http.Pusher); ok {\n    //支持Push\n    if err := pusher.Push(\"/app.js\", nil); err != nil {\n      log.Printf(\"Failed to push: %v\", err)\n    }\n  }\n  // ...\n})\n```\n\nPush会为 app.js 创建一个 “合成请求”，将该请求合成到 PUSH_PROMISE 帧中，然后将请求转发到服务器的请求处理程序，请求处理程序会生成响应。Push的第二个参数指定了包含在 PUSH_PROMISE 中的附加header头，例如，如果对 app.js 的响应在 Accept-Encoding 上不同，则 PUSH_PROMISE 应包含 Accept-Encoding 的值。\n\n```go\nhttp.HandleFunc(\"/\", func(w http.ResponseWriter, r *http.Request) {\n  if pusher, ok := w.(http.Pusher); ok {\n    //支持Push\n    options := &http.PushOptions{\n      Header: http.Header{\n        \"Accept-Encoding\": r.Header[\"Accept-Encoding\"],\n      },\n    }\n    if err := pusher.Pusher(\"/app.js\", options); err != nil {\n      log.Printf(\"Failed to push: %v\", err)\n    }\n  }\n  // ...\n})\n```\n\n完整示例见：\n\n```shell\n$ go get golang.org/x/blog/content/h2push/server\n```\n\n启动服务，然后打开 [https://localhost:8080](https://localhost:8080)，浏览器开发工具应该会显示服务器推送了 app.js 和 style.css 。\n\n![网络请求耗时](/images/go/networktimeline.png)\n\n#### 在响应前开始Push\n\n在发送响应之前调用Push是个好主意，否则可能会意外产生重复的响应，例如，假设下边是HTML响应的一部分：\n\n```html\n<html>\n<head>\n\t<link rel=\"stylesheet\" href=\"a.cs\">...\t\n```\n\n然后调用 Push(\"a.css\", nil) ，浏览器可能会在接收到 PUSH_PROMISE 之前就开始解析这段 HTM L了，这种情况下，浏览器除了接收到 PUSH_PROMISE 之外，还会发起一个 a.css 的请求，那么服务器就会为 a.css 生成两个请求。而在写入响应之前调用PUSH则避免了这种可能性。\n\n#### 何时使用Server Push\n\n应该考虑在任何网络连接空闲时使用 Server Push 。刚完成为 web app 发送 HTML ？不要浪费时间等待请求，开始推送客户端需要用到的资源，你有没有过将资源嵌入到 HTML 文件中以减少延迟？替换掉内联，尝试使用推送。重定向是另一个使用推送的好时机，因为客户端在这个过程中几乎把时间全浪费在请求的往返上。有很多情况适合使用 Push ，我们才刚刚开始。\n\n如果没有提到以下几个注意事项，将是我们的失职。\n\n​\t首先，只能推送当前服务器上的资源-这意味着无法推送托管在第三方服务器或CDN上的资源。\n\n​\t第二，除非能确定客户端确实需要，否则不要推送，这样会浪费带宽。当浏览器已经缓存了某些资源时， 必须要避免推送。\n\n​\t第三，天真的把所有资源推送到页面会使性能更糟糕。\n\n以下链接可以作为补充阅读：\n\n- [HTTP/2 Push: The Details](https://calendar.perfplanet.com/2016/http2-push-the-details/)\n- [Innovating with HTTP/2 Server Push](https://www.igvita.com/2013/06/12/innovating-with-http-2.0-server-push/)\n- [Cache-Aware Server Push in H2O](https://github.com/h2o/h2o/issues/421)\n- [The PRPL Pattern](https://developers.google.com/web/fundamentals/performance/prpl-pattern/)\n- [Rules of Thumb for HTTP/2 Push](https://docs.google.com/document/d/1K0NykTXBbbbTlv60t5MyJvXjqKGsCVNYHyLEXIxYMv0)\n- [Server Push in the HTTP/2 spec](https://tools.ietf.org/html/rfc7540#section-8.2)\n\n#### 结尾\n\nGo1.8 标准库为 HTTP/2 Server Push 提供了开箱即用的支持，为优化 Web 应用程序提供更多灵活性。\n\n转到[HTTP/2 Server Push演示页面](https://http2.golang.org/serverpush)查看实际效果。\n\n#### 一些资料\n\n[HTTP/2 简介](https://developers.google.com/web/fundamentals/performance/http2/?hl=zh-cn)\n\nHTTP/2 Server Push 详解：\n\n原文：\n\n[A Comprehensive Guide To HTTP/2 Server Push](https://www.smashingmagazine.com/2017/04/guide-http2-server-push/)\n\n译文：\n\n[HTTP/2 Server Push 详解（上）](http://www.alloyteam.com/2017/04/guide-http2-server-push-part1/)\n\n[HTTP/2 Server Push 详解（下）](http://www.alloyteam.com/2017/04/guide-http2-server-push-part2/)","slug":"HTTP2-Server-Push","published":1,"updated":"2017-07-02T02:00:42.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj830jvcw0001ul0rg6s0mrtx","content":"<h4 id=\"写在前面\"><a href=\"#写在前面\" class=\"headerlink\" title=\"写在前面\"></a>写在前面</h4><p>本文来自<a href=\"https://blog.golang.org/h2push\" target=\"_blank\" rel=\"external\">Golang的官方博客</a>，由 Jaana Burcu Dogan, Tom Bergan 发表于2017年3月24日。</p>\n<p>近来看到此篇，觉得不错，非常适合用来学习Go中的 Server Push ，于是决定翻译一下，水平有限，如有不足不恰当的地方还请提出宝贵意见。</p>\n<h4 id=\"序\"><a href=\"#序\" class=\"headerlink\" title=\"序\"></a>序</h4><p>HTTP/2旨在解决HTTP/1.x的很多问题。现代网页通常包含很多资源：HTML，css，js，图片等等。在 HTTP/1.x 中，必须明确地请求这些资源。这是一个缓慢的过程。浏览器必须从获取HTML开始，然后在解析页面时获取更多资源。由于服务器必须等待浏览器发起请求，网络通常处于空闲，没有充分利用。</p>\n<p>为了改善延迟，HTTP/2引入了 Server Push ，这允许服务器在明确的请求之前将资源推送到浏览器。服务器通常会知道一个页面所需要的额外的资源，并且可以在响应初始请求时开始推送这些资源。这就允许服务器充分利用空闲的网络来改善加载时间。</p>\n<p><img src=\"/images/go/serverpush.svg\" alt=\"server push示意\"></p>\n<p>在协议层，HTTP/2 Server Push 由 PUSH_PROMISE 帧发起。PUSH_PROMISE 表明了服务器向客户端推送资源的意图。一旦浏览器接收到PUSH_PROMISE，它就会知道服务器会推送资源。如果浏览器后来发现需要这个资源，它会等待推送完成，而不是发起一个新的请求。这减少了浏览器在网络上等待的时间。</p>\n<h4 id=\"net-http-包中的-Server-Push\"><a href=\"#net-http-包中的-Server-Push\" class=\"headerlink\" title=\"net/http 包中的 Server Push\"></a>net/http 包中的 Server Push</h4><p>Go1.8 引入了 http.Server 对 push 响应的支持，如果运行的服务器是 HTTP/2 服务器，并且请求连接使用了 HTTP/2，则可以使用此功能。在任何HTTP处理程序中，可以通过检查 http.ResponseWriter 是否实现了 http.Pusher 接口来判断是否支持 Server Push。</p>\n<p>例如，如果服务器知道一个页面中包含 app.js，处理程序可以初始化一个 http.Pusher。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\">http.HandleFunc(<span class=\"string\">\"/\"</span>, <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</div><div class=\"line\">  <span class=\"keyword\">if</span> push, ok := w.(http.Pusher); ok &#123;</div><div class=\"line\">    <span class=\"comment\">//支持Push</span></div><div class=\"line\">    <span class=\"keyword\">if</span> err := pusher.Push(<span class=\"string\">\"/app.js\"</span>, <span class=\"literal\">nil</span>); err != <span class=\"literal\">nil</span> &#123;</div><div class=\"line\">      log.Printf(<span class=\"string\">\"Failed to push: %v\"</span>, err)</div><div class=\"line\">    &#125;</div><div class=\"line\">  &#125;</div><div class=\"line\">  <span class=\"comment\">// ...</span></div><div class=\"line\">&#125;)</div></pre></td></tr></table></figure>\n<p>Push会为 app.js 创建一个 “合成请求”，将该请求合成到 PUSH_PROMISE 帧中，然后将请求转发到服务器的请求处理程序，请求处理程序会生成响应。Push的第二个参数指定了包含在 PUSH_PROMISE 中的附加header头，例如，如果对 app.js 的响应在 Accept-Encoding 上不同，则 PUSH_PROMISE 应包含 Accept-Encoding 的值。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div></pre></td><td class=\"code\"><pre><div class=\"line\">http.HandleFunc(<span class=\"string\">\"/\"</span>, <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</div><div class=\"line\">  <span class=\"keyword\">if</span> pusher, ok := w.(http.Pusher); ok &#123;</div><div class=\"line\">    <span class=\"comment\">//支持Push</span></div><div class=\"line\">    options := &amp;http.PushOptions&#123;</div><div class=\"line\">      Header: http.Header&#123;</div><div class=\"line\">        <span class=\"string\">\"Accept-Encoding\"</span>: r.Header[<span class=\"string\">\"Accept-Encoding\"</span>],</div><div class=\"line\">      &#125;,</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">if</span> err := pusher.Pusher(<span class=\"string\">\"/app.js\"</span>, options); err != <span class=\"literal\">nil</span> &#123;</div><div class=\"line\">      log.Printf(<span class=\"string\">\"Failed to push: %v\"</span>, err)</div><div class=\"line\">    &#125;</div><div class=\"line\">  &#125;</div><div class=\"line\">  <span class=\"comment\">// ...</span></div><div class=\"line\">&#125;)</div></pre></td></tr></table></figure>\n<p>完整示例见：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">$</span> go get golang.org/x/blog/content/h2push/server</div></pre></td></tr></table></figure>\n<p>启动服务，然后打开 <a href=\"https://localhost:8080\" target=\"_blank\" rel=\"external\">https://localhost:8080</a>，浏览器开发工具应该会显示服务器推送了 app.js 和 style.css 。</p>\n<p><img src=\"/images/go/networktimeline.png\" alt=\"网络请求耗时\"></p>\n<h4 id=\"在响应前开始Push\"><a href=\"#在响应前开始Push\" class=\"headerlink\" title=\"在响应前开始Push\"></a>在响应前开始Push</h4><p>在发送响应之前调用Push是个好主意，否则可能会意外产生重复的响应，例如，假设下边是HTML响应的一部分：</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></div><div class=\"line\">\t<span class=\"tag\">&lt;<span class=\"name\">link</span> <span class=\"attr\">rel</span>=<span class=\"string\">\"stylesheet\"</span> <span class=\"attr\">href</span>=<span class=\"string\">\"a.cs\"</span>&gt;</span>...</div></pre></td></tr></table></figure>\n<p>然后调用 Push(“a.css”, nil) ，浏览器可能会在接收到 PUSH_PROMISE 之前就开始解析这段 HTM L了，这种情况下，浏览器除了接收到 PUSH_PROMISE 之外，还会发起一个 a.css 的请求，那么服务器就会为 a.css 生成两个请求。而在写入响应之前调用PUSH则避免了这种可能性。</p>\n<h4 id=\"何时使用Server-Push\"><a href=\"#何时使用Server-Push\" class=\"headerlink\" title=\"何时使用Server Push\"></a>何时使用Server Push</h4><p>应该考虑在任何网络连接空闲时使用 Server Push 。刚完成为 web app 发送 HTML ？不要浪费时间等待请求，开始推送客户端需要用到的资源，你有没有过将资源嵌入到 HTML 文件中以减少延迟？替换掉内联，尝试使用推送。重定向是另一个使用推送的好时机，因为客户端在这个过程中几乎把时间全浪费在请求的往返上。有很多情况适合使用 Push ，我们才刚刚开始。</p>\n<p>如果没有提到以下几个注意事项，将是我们的失职。</p>\n<p>​    首先，只能推送当前服务器上的资源-这意味着无法推送托管在第三方服务器或CDN上的资源。</p>\n<p>​    第二，除非能确定客户端确实需要，否则不要推送，这样会浪费带宽。当浏览器已经缓存了某些资源时， 必须要避免推送。</p>\n<p>​    第三，天真的把所有资源推送到页面会使性能更糟糕。</p>\n<p>以下链接可以作为补充阅读：</p>\n<ul>\n<li><a href=\"https://calendar.perfplanet.com/2016/http2-push-the-details/\" target=\"_blank\" rel=\"external\">HTTP/2 Push: The Details</a></li>\n<li><a href=\"https://www.igvita.com/2013/06/12/innovating-with-http-2.0-server-push/\" target=\"_blank\" rel=\"external\">Innovating with HTTP/2 Server Push</a></li>\n<li><a href=\"https://github.com/h2o/h2o/issues/421\" target=\"_blank\" rel=\"external\">Cache-Aware Server Push in H2O</a></li>\n<li><a href=\"https://developers.google.com/web/fundamentals/performance/prpl-pattern/\" target=\"_blank\" rel=\"external\">The PRPL Pattern</a></li>\n<li><a href=\"https://docs.google.com/document/d/1K0NykTXBbbbTlv60t5MyJvXjqKGsCVNYHyLEXIxYMv0\" target=\"_blank\" rel=\"external\">Rules of Thumb for HTTP/2 Push</a></li>\n<li><a href=\"https://tools.ietf.org/html/rfc7540#section-8.2\" target=\"_blank\" rel=\"external\">Server Push in the HTTP/2 spec</a></li>\n</ul>\n<h4 id=\"结尾\"><a href=\"#结尾\" class=\"headerlink\" title=\"结尾\"></a>结尾</h4><p>Go1.8 标准库为 HTTP/2 Server Push 提供了开箱即用的支持，为优化 Web 应用程序提供更多灵活性。</p>\n<p>转到<a href=\"https://http2.golang.org/serverpush\" target=\"_blank\" rel=\"external\">HTTP/2 Server Push演示页面</a>查看实际效果。</p>\n<h4 id=\"一些资料\"><a href=\"#一些资料\" class=\"headerlink\" title=\"一些资料\"></a>一些资料</h4><p><a href=\"https://developers.google.com/web/fundamentals/performance/http2/?hl=zh-cn\" target=\"_blank\" rel=\"external\">HTTP/2 简介</a></p>\n<p>HTTP/2 Server Push 详解：</p>\n<p>原文：</p>\n<p><a href=\"https://www.smashingmagazine.com/2017/04/guide-http2-server-push/\" target=\"_blank\" rel=\"external\">A Comprehensive Guide To HTTP/2 Server Push</a></p>\n<p>译文：</p>\n<p><a href=\"http://www.alloyteam.com/2017/04/guide-http2-server-push-part1/\" target=\"_blank\" rel=\"external\">HTTP/2 Server Push 详解（上）</a></p>\n<p><a href=\"http://www.alloyteam.com/2017/04/guide-http2-server-push-part2/\" target=\"_blank\" rel=\"external\">HTTP/2 Server Push 详解（下）</a></p>\n","site":{"data":{}},"excerpt":"","more":"<h4 id=\"写在前面\"><a href=\"#写在前面\" class=\"headerlink\" title=\"写在前面\"></a>写在前面</h4><p>本文来自<a href=\"https://blog.golang.org/h2push\" target=\"_blank\" rel=\"external\">Golang的官方博客</a>，由 Jaana Burcu Dogan, Tom Bergan 发表于2017年3月24日。</p>\n<p>近来看到此篇，觉得不错，非常适合用来学习Go中的 Server Push ，于是决定翻译一下，水平有限，如有不足不恰当的地方还请提出宝贵意见。</p>\n<h4 id=\"序\"><a href=\"#序\" class=\"headerlink\" title=\"序\"></a>序</h4><p>HTTP/2旨在解决HTTP/1.x的很多问题。现代网页通常包含很多资源：HTML，css，js，图片等等。在 HTTP/1.x 中，必须明确地请求这些资源。这是一个缓慢的过程。浏览器必须从获取HTML开始，然后在解析页面时获取更多资源。由于服务器必须等待浏览器发起请求，网络通常处于空闲，没有充分利用。</p>\n<p>为了改善延迟，HTTP/2引入了 Server Push ，这允许服务器在明确的请求之前将资源推送到浏览器。服务器通常会知道一个页面所需要的额外的资源，并且可以在响应初始请求时开始推送这些资源。这就允许服务器充分利用空闲的网络来改善加载时间。</p>\n<p><img src=\"/images/go/serverpush.svg\" alt=\"server push示意\"></p>\n<p>在协议层，HTTP/2 Server Push 由 PUSH_PROMISE 帧发起。PUSH_PROMISE 表明了服务器向客户端推送资源的意图。一旦浏览器接收到PUSH_PROMISE，它就会知道服务器会推送资源。如果浏览器后来发现需要这个资源，它会等待推送完成，而不是发起一个新的请求。这减少了浏览器在网络上等待的时间。</p>\n<h4 id=\"net-http-包中的-Server-Push\"><a href=\"#net-http-包中的-Server-Push\" class=\"headerlink\" title=\"net/http 包中的 Server Push\"></a>net/http 包中的 Server Push</h4><p>Go1.8 引入了 http.Server 对 push 响应的支持，如果运行的服务器是 HTTP/2 服务器，并且请求连接使用了 HTTP/2，则可以使用此功能。在任何HTTP处理程序中，可以通过检查 http.ResponseWriter 是否实现了 http.Pusher 接口来判断是否支持 Server Push。</p>\n<p>例如，如果服务器知道一个页面中包含 app.js，处理程序可以初始化一个 http.Pusher。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\">http.HandleFunc(<span class=\"string\">\"/\"</span>, <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</div><div class=\"line\">  <span class=\"keyword\">if</span> push, ok := w.(http.Pusher); ok &#123;</div><div class=\"line\">    <span class=\"comment\">//支持Push</span></div><div class=\"line\">    <span class=\"keyword\">if</span> err := pusher.Push(<span class=\"string\">\"/app.js\"</span>, <span class=\"literal\">nil</span>); err != <span class=\"literal\">nil</span> &#123;</div><div class=\"line\">      log.Printf(<span class=\"string\">\"Failed to push: %v\"</span>, err)</div><div class=\"line\">    &#125;</div><div class=\"line\">  &#125;</div><div class=\"line\">  <span class=\"comment\">// ...</span></div><div class=\"line\">&#125;)</div></pre></td></tr></table></figure>\n<p>Push会为 app.js 创建一个 “合成请求”，将该请求合成到 PUSH_PROMISE 帧中，然后将请求转发到服务器的请求处理程序，请求处理程序会生成响应。Push的第二个参数指定了包含在 PUSH_PROMISE 中的附加header头，例如，如果对 app.js 的响应在 Accept-Encoding 上不同，则 PUSH_PROMISE 应包含 Accept-Encoding 的值。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div></pre></td><td class=\"code\"><pre><div class=\"line\">http.HandleFunc(<span class=\"string\">\"/\"</span>, <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</div><div class=\"line\">  <span class=\"keyword\">if</span> pusher, ok := w.(http.Pusher); ok &#123;</div><div class=\"line\">    <span class=\"comment\">//支持Push</span></div><div class=\"line\">    options := &amp;http.PushOptions&#123;</div><div class=\"line\">      Header: http.Header&#123;</div><div class=\"line\">        <span class=\"string\">\"Accept-Encoding\"</span>: r.Header[<span class=\"string\">\"Accept-Encoding\"</span>],</div><div class=\"line\">      &#125;,</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">if</span> err := pusher.Pusher(<span class=\"string\">\"/app.js\"</span>, options); err != <span class=\"literal\">nil</span> &#123;</div><div class=\"line\">      log.Printf(<span class=\"string\">\"Failed to push: %v\"</span>, err)</div><div class=\"line\">    &#125;</div><div class=\"line\">  &#125;</div><div class=\"line\">  <span class=\"comment\">// ...</span></div><div class=\"line\">&#125;)</div></pre></td></tr></table></figure>\n<p>完整示例见：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">$</span> go get golang.org/x/blog/content/h2push/server</div></pre></td></tr></table></figure>\n<p>启动服务，然后打开 <a href=\"https://localhost:8080\" target=\"_blank\" rel=\"external\">https://localhost:8080</a>，浏览器开发工具应该会显示服务器推送了 app.js 和 style.css 。</p>\n<p><img src=\"/images/go/networktimeline.png\" alt=\"网络请求耗时\"></p>\n<h4 id=\"在响应前开始Push\"><a href=\"#在响应前开始Push\" class=\"headerlink\" title=\"在响应前开始Push\"></a>在响应前开始Push</h4><p>在发送响应之前调用Push是个好主意，否则可能会意外产生重复的响应，例如，假设下边是HTML响应的一部分：</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></div><div class=\"line\">\t<span class=\"tag\">&lt;<span class=\"name\">link</span> <span class=\"attr\">rel</span>=<span class=\"string\">\"stylesheet\"</span> <span class=\"attr\">href</span>=<span class=\"string\">\"a.cs\"</span>&gt;</span>...</div></pre></td></tr></table></figure>\n<p>然后调用 Push(“a.css”, nil) ，浏览器可能会在接收到 PUSH_PROMISE 之前就开始解析这段 HTM L了，这种情况下，浏览器除了接收到 PUSH_PROMISE 之外，还会发起一个 a.css 的请求，那么服务器就会为 a.css 生成两个请求。而在写入响应之前调用PUSH则避免了这种可能性。</p>\n<h4 id=\"何时使用Server-Push\"><a href=\"#何时使用Server-Push\" class=\"headerlink\" title=\"何时使用Server Push\"></a>何时使用Server Push</h4><p>应该考虑在任何网络连接空闲时使用 Server Push 。刚完成为 web app 发送 HTML ？不要浪费时间等待请求，开始推送客户端需要用到的资源，你有没有过将资源嵌入到 HTML 文件中以减少延迟？替换掉内联，尝试使用推送。重定向是另一个使用推送的好时机，因为客户端在这个过程中几乎把时间全浪费在请求的往返上。有很多情况适合使用 Push ，我们才刚刚开始。</p>\n<p>如果没有提到以下几个注意事项，将是我们的失职。</p>\n<p>​    首先，只能推送当前服务器上的资源-这意味着无法推送托管在第三方服务器或CDN上的资源。</p>\n<p>​    第二，除非能确定客户端确实需要，否则不要推送，这样会浪费带宽。当浏览器已经缓存了某些资源时， 必须要避免推送。</p>\n<p>​    第三，天真的把所有资源推送到页面会使性能更糟糕。</p>\n<p>以下链接可以作为补充阅读：</p>\n<ul>\n<li><a href=\"https://calendar.perfplanet.com/2016/http2-push-the-details/\" target=\"_blank\" rel=\"external\">HTTP/2 Push: The Details</a></li>\n<li><a href=\"https://www.igvita.com/2013/06/12/innovating-with-http-2.0-server-push/\" target=\"_blank\" rel=\"external\">Innovating with HTTP/2 Server Push</a></li>\n<li><a href=\"https://github.com/h2o/h2o/issues/421\" target=\"_blank\" rel=\"external\">Cache-Aware Server Push in H2O</a></li>\n<li><a href=\"https://developers.google.com/web/fundamentals/performance/prpl-pattern/\" target=\"_blank\" rel=\"external\">The PRPL Pattern</a></li>\n<li><a href=\"https://docs.google.com/document/d/1K0NykTXBbbbTlv60t5MyJvXjqKGsCVNYHyLEXIxYMv0\" target=\"_blank\" rel=\"external\">Rules of Thumb for HTTP/2 Push</a></li>\n<li><a href=\"https://tools.ietf.org/html/rfc7540#section-8.2\" target=\"_blank\" rel=\"external\">Server Push in the HTTP/2 spec</a></li>\n</ul>\n<h4 id=\"结尾\"><a href=\"#结尾\" class=\"headerlink\" title=\"结尾\"></a>结尾</h4><p>Go1.8 标准库为 HTTP/2 Server Push 提供了开箱即用的支持，为优化 Web 应用程序提供更多灵活性。</p>\n<p>转到<a href=\"https://http2.golang.org/serverpush\" target=\"_blank\" rel=\"external\">HTTP/2 Server Push演示页面</a>查看实际效果。</p>\n<h4 id=\"一些资料\"><a href=\"#一些资料\" class=\"headerlink\" title=\"一些资料\"></a>一些资料</h4><p><a href=\"https://developers.google.com/web/fundamentals/performance/http2/?hl=zh-cn\" target=\"_blank\" rel=\"external\">HTTP/2 简介</a></p>\n<p>HTTP/2 Server Push 详解：</p>\n<p>原文：</p>\n<p><a href=\"https://www.smashingmagazine.com/2017/04/guide-http2-server-push/\" target=\"_blank\" rel=\"external\">A Comprehensive Guide To HTTP/2 Server Push</a></p>\n<p>译文：</p>\n<p><a href=\"http://www.alloyteam.com/2017/04/guide-http2-server-push-part1/\" target=\"_blank\" rel=\"external\">HTTP/2 Server Push 详解（上）</a></p>\n<p><a href=\"http://www.alloyteam.com/2017/04/guide-http2-server-push-part2/\" target=\"_blank\" rel=\"external\">HTTP/2 Server Push 详解（下）</a></p>\n"},{"title":"MySQL实现row_number","date":"2016-02-03T10:25:26.000Z","_content":"\n在本教程中，我们将在MySQL中实现一个非常实用的row_number功能。\n\nrow_number是一个返回数据排序编号的排名方法，从1开始。我们经常需要用到row_number去生成某些报表，不幸的是，MySQL并不像MSSQL，Oracle一样支持这个方法。在MySQL中如果想实现这个功能需要临时变量。\n\n为了在MySQL中实现row_number，需要在查询中实用临时变量，下图中从employees表中查询出5条数据，并且从1开始，为每一行添加了编号(row number)。\n\n```\nSET @row_number = 0;\n \nSELECT \n    (@row_number:=@row_number + 1) AS num, firstName, lastName\nFROM\n    employees\nLIMIT 5;\n```\n\n![](/images/mysql-row_number-session-variables.jpg)\n\n在上面的查询中：\n\n\t首先，我们定义了一个变量叫做row_number,初始值为0，row_number是以@为前缀的一个临时变量。\n\t\n\t然后，在查询中，我们为这个变量每次+1，LIMIT分句是为了限制返回的结果数，此处设为5.\n\t\n另一个方法是使用临时变量作为派生表，联合主表。看下边的查询语句：\n\n```\nSELECT \n    (@row_number:=@row_number + 1) AS num, firstName, lastName\nFROM\n    employees,(SELECT @row_number:=0) AS t\nLIMIT 5;\n\n```\n\n需要注意，派生表必须使用别名，以使查询语句在语法上没有问题。\n\n由于时间关系（回家过年），暂时到这里，文中部分内容可能翻译的有点不太顺，可以直接看下原文，原文中还有一部分讲分组查询中实用row_number。\n\n这个之后再写。\n\t\n原文地址：[MySQL row_number, This Is How You Emulate It](http://www.mysqltutorial.org/mysql-row_number/)\n\t","source":"_posts/MySQL实现row_number .md","raw":"title: MySQL实现row_number\ncategories: mysql\ndate: 2016-02-03 18:25:26\ntags:  [mysql]\n\n---\n\n在本教程中，我们将在MySQL中实现一个非常实用的row_number功能。\n\nrow_number是一个返回数据排序编号的排名方法，从1开始。我们经常需要用到row_number去生成某些报表，不幸的是，MySQL并不像MSSQL，Oracle一样支持这个方法。在MySQL中如果想实现这个功能需要临时变量。\n\n为了在MySQL中实现row_number，需要在查询中实用临时变量，下图中从employees表中查询出5条数据，并且从1开始，为每一行添加了编号(row number)。\n\n```\nSET @row_number = 0;\n \nSELECT \n    (@row_number:=@row_number + 1) AS num, firstName, lastName\nFROM\n    employees\nLIMIT 5;\n```\n\n![](/images/mysql-row_number-session-variables.jpg)\n\n在上面的查询中：\n\n\t首先，我们定义了一个变量叫做row_number,初始值为0，row_number是以@为前缀的一个临时变量。\n\t\n\t然后，在查询中，我们为这个变量每次+1，LIMIT分句是为了限制返回的结果数，此处设为5.\n\t\n另一个方法是使用临时变量作为派生表，联合主表。看下边的查询语句：\n\n```\nSELECT \n    (@row_number:=@row_number + 1) AS num, firstName, lastName\nFROM\n    employees,(SELECT @row_number:=0) AS t\nLIMIT 5;\n\n```\n\n需要注意，派生表必须使用别名，以使查询语句在语法上没有问题。\n\n由于时间关系（回家过年），暂时到这里，文中部分内容可能翻译的有点不太顺，可以直接看下原文，原文中还有一部分讲分组查询中实用row_number。\n\n这个之后再写。\n\t\n原文地址：[MySQL row_number, This Is How You Emulate It](http://www.mysqltutorial.org/mysql-row_number/)\n\t","slug":"MySQL实现row_number ","published":1,"updated":"2016-02-03T10:27:20.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj830jvd00004ul0rnsvh6cys","content":"<p>在本教程中，我们将在MySQL中实现一个非常实用的row_number功能。</p>\n<p>row_number是一个返回数据排序编号的排名方法，从1开始。我们经常需要用到row_number去生成某些报表，不幸的是，MySQL并不像MSSQL，Oracle一样支持这个方法。在MySQL中如果想实现这个功能需要临时变量。</p>\n<p>为了在MySQL中实现row_number，需要在查询中实用临时变量，下图中从employees表中查询出5条数据，并且从1开始，为每一行添加了编号(row number)。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">SET @row_number = 0;</div><div class=\"line\"> </div><div class=\"line\">SELECT </div><div class=\"line\">    (@row_number:=@row_number + 1) AS num, firstName, lastName</div><div class=\"line\">FROM</div><div class=\"line\">    employees</div><div class=\"line\">LIMIT 5;</div></pre></td></tr></table></figure>\n<p><img src=\"/images/mysql-row_number-session-variables.jpg\" alt=\"\"></p>\n<p>在上面的查询中：</p>\n<pre><code>首先，我们定义了一个变量叫做row_number,初始值为0，row_number是以@为前缀的一个临时变量。\n\n然后，在查询中，我们为这个变量每次+1，LIMIT分句是为了限制返回的结果数，此处设为5.\n</code></pre><p>另一个方法是使用临时变量作为派生表，联合主表。看下边的查询语句：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">SELECT </div><div class=\"line\">    (@row_number:=@row_number + 1) AS num, firstName, lastName</div><div class=\"line\">FROM</div><div class=\"line\">    employees,(SELECT @row_number:=0) AS t</div><div class=\"line\">LIMIT 5;</div></pre></td></tr></table></figure>\n<p>需要注意，派生表必须使用别名，以使查询语句在语法上没有问题。</p>\n<p>由于时间关系（回家过年），暂时到这里，文中部分内容可能翻译的有点不太顺，可以直接看下原文，原文中还有一部分讲分组查询中实用row_number。</p>\n<p>这个之后再写。</p>\n<p>原文地址：<a href=\"http://www.mysqltutorial.org/mysql-row_number/\" target=\"_blank\" rel=\"external\">MySQL row_number, This Is How You Emulate It</a></p>\n","site":{"data":{}},"excerpt":"","more":"<p>在本教程中，我们将在MySQL中实现一个非常实用的row_number功能。</p>\n<p>row_number是一个返回数据排序编号的排名方法，从1开始。我们经常需要用到row_number去生成某些报表，不幸的是，MySQL并不像MSSQL，Oracle一样支持这个方法。在MySQL中如果想实现这个功能需要临时变量。</p>\n<p>为了在MySQL中实现row_number，需要在查询中实用临时变量，下图中从employees表中查询出5条数据，并且从1开始，为每一行添加了编号(row number)。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">SET @row_number = 0;</div><div class=\"line\"> </div><div class=\"line\">SELECT </div><div class=\"line\">    (@row_number:=@row_number + 1) AS num, firstName, lastName</div><div class=\"line\">FROM</div><div class=\"line\">    employees</div><div class=\"line\">LIMIT 5;</div></pre></td></tr></table></figure>\n<p><img src=\"/images/mysql-row_number-session-variables.jpg\" alt=\"\"></p>\n<p>在上面的查询中：</p>\n<pre><code>首先，我们定义了一个变量叫做row_number,初始值为0，row_number是以@为前缀的一个临时变量。\n\n然后，在查询中，我们为这个变量每次+1，LIMIT分句是为了限制返回的结果数，此处设为5.\n</code></pre><p>另一个方法是使用临时变量作为派生表，联合主表。看下边的查询语句：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">SELECT </div><div class=\"line\">    (@row_number:=@row_number + 1) AS num, firstName, lastName</div><div class=\"line\">FROM</div><div class=\"line\">    employees,(SELECT @row_number:=0) AS t</div><div class=\"line\">LIMIT 5;</div></pre></td></tr></table></figure>\n<p>需要注意，派生表必须使用别名，以使查询语句在语法上没有问题。</p>\n<p>由于时间关系（回家过年），暂时到这里，文中部分内容可能翻译的有点不太顺，可以直接看下原文，原文中还有一部分讲分组查询中实用row_number。</p>\n<p>这个之后再写。</p>\n<p>原文地址：<a href=\"http://www.mysqltutorial.org/mysql-row_number/\" target=\"_blank\" rel=\"external\">MySQL row_number, This Is How You Emulate It</a></p>\n"},{"title":"MySQL实现row_number第二部分","date":"2016-02-24T09:58:24.000Z","_content":"接上篇：[MySQL实现row_number](https://www.qichengzx.com/2016/02/03/MySQL%E5%AE%9E%E7%8E%B0row_number%20.html)\n\n### 为分组增加row number\n\nrow_number的分析函数怎么样？（原文：How about  row_number “over partition by” functionality? ），比如，如果想为每一个组增加row number，并且在每一个新的分组重置它。\n\n查看下图中payments表。\n\n```\nSELECT\n    customerNumber, paymentDate, amount\nFROM\n    payments\nORDER BY customerNumber;\n```\n\n![](/images/mysql-row-number/mysql-row_number-payments-table.jpg)\n\n\n设想下，为每一条customer数据增加一个当前行的编号，并且每当customer的number字段变化的时候行编号都被重置。\n\n为了实现这个，需要使用两个临时变量，一个作为当前行编号，另一个用来存 上一条customer number与当前行的number进行对比，查询语句如下。（这句有点绕，可能翻译的不太准确，请以原文为准。To achieve this, you have to use two session variables, one for the row number and the other for storing the old customer number to compare it with the current one as the following query:）\n\n```\nSELECT \n    @row_number:=CASE\n        WHEN @customer_no = customerNumber THEN @row_number + 1\n        ELSE 1\n    END AS num,\n    @customer_no:=customerNumber as CustomerNumber,\n    paymentDate,\n    amount\nFROM\n    payments\nORDER BY customerNumber;\n```\n\n在这段查询代码中，我们使用了CASE声明，如果customer的number不变，就给row_number变量+1，否则，重置为1，结果如下：\n\n![](/images/mysql-row-number/mysql-row_number-per-group.jpg)\n\n与为每一行记录生成row_number一样，也可以使用派生表（derived table）和交叉连接（cross join）生成同样的结果。\n\n```\nSELECT \n    @row_number:=CASE\n        WHEN @customer_no = customerNumber THEN @row_number + 1\n        ELSE 1\n    END AS num,\n    @customer_no:=customerNumber as CustomerNumber,\n    paymentDate,\n    amount\nFROM\n    payments,(SELECT @customer_no:=0,@row_number:=0) as t\nORDER BY customerNumber;\n```\n\n本教程中，我们展示了如何在MySQL中模仿row_number方法。\n\n\n原文地址：[MySQL row_number, This Is How You Emulate It](http://www.mysqltutorial.org/mysql-row_number/)\n\t","source":"_posts/MySql-row_number-part-2.md","raw":"title: MySQL实现row_number第二部分\ncategories: mysql\ndate: 2016-02-24 17:58:24\ntags:  [mysql]\n\n---\n接上篇：[MySQL实现row_number](https://www.qichengzx.com/2016/02/03/MySQL%E5%AE%9E%E7%8E%B0row_number%20.html)\n\n### 为分组增加row number\n\nrow_number的分析函数怎么样？（原文：How about  row_number “over partition by” functionality? ），比如，如果想为每一个组增加row number，并且在每一个新的分组重置它。\n\n查看下图中payments表。\n\n```\nSELECT\n    customerNumber, paymentDate, amount\nFROM\n    payments\nORDER BY customerNumber;\n```\n\n![](/images/mysql-row-number/mysql-row_number-payments-table.jpg)\n\n\n设想下，为每一条customer数据增加一个当前行的编号，并且每当customer的number字段变化的时候行编号都被重置。\n\n为了实现这个，需要使用两个临时变量，一个作为当前行编号，另一个用来存 上一条customer number与当前行的number进行对比，查询语句如下。（这句有点绕，可能翻译的不太准确，请以原文为准。To achieve this, you have to use two session variables, one for the row number and the other for storing the old customer number to compare it with the current one as the following query:）\n\n```\nSELECT \n    @row_number:=CASE\n        WHEN @customer_no = customerNumber THEN @row_number + 1\n        ELSE 1\n    END AS num,\n    @customer_no:=customerNumber as CustomerNumber,\n    paymentDate,\n    amount\nFROM\n    payments\nORDER BY customerNumber;\n```\n\n在这段查询代码中，我们使用了CASE声明，如果customer的number不变，就给row_number变量+1，否则，重置为1，结果如下：\n\n![](/images/mysql-row-number/mysql-row_number-per-group.jpg)\n\n与为每一行记录生成row_number一样，也可以使用派生表（derived table）和交叉连接（cross join）生成同样的结果。\n\n```\nSELECT \n    @row_number:=CASE\n        WHEN @customer_no = customerNumber THEN @row_number + 1\n        ELSE 1\n    END AS num,\n    @customer_no:=customerNumber as CustomerNumber,\n    paymentDate,\n    amount\nFROM\n    payments,(SELECT @customer_no:=0,@row_number:=0) as t\nORDER BY customerNumber;\n```\n\n本教程中，我们展示了如何在MySQL中模仿row_number方法。\n\n\n原文地址：[MySQL row_number, This Is How You Emulate It](http://www.mysqltutorial.org/mysql-row_number/)\n\t","slug":"MySql-row_number-part-2","published":1,"updated":"2016-02-25T03:35:21.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj830jvd00005ul0r8wf665k2","content":"<p>接上篇：<a href=\"https://www.qichengzx.com/2016/02/03/MySQL%E5%AE%9E%E7%8E%B0row_number%20.html\">MySQL实现row_number</a></p>\n<h3 id=\"为分组增加row-number\"><a href=\"#为分组增加row-number\" class=\"headerlink\" title=\"为分组增加row number\"></a>为分组增加row number</h3><p>row_number的分析函数怎么样？（原文：How about  row_number “over partition by” functionality? ），比如，如果想为每一个组增加row number，并且在每一个新的分组重置它。</p>\n<p>查看下图中payments表。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">SELECT</div><div class=\"line\">    customerNumber, paymentDate, amount</div><div class=\"line\">FROM</div><div class=\"line\">    payments</div><div class=\"line\">ORDER BY customerNumber;</div></pre></td></tr></table></figure>\n<p><img src=\"/images/mysql-row-number/mysql-row_number-payments-table.jpg\" alt=\"\"></p>\n<p>设想下，为每一条customer数据增加一个当前行的编号，并且每当customer的number字段变化的时候行编号都被重置。</p>\n<p>为了实现这个，需要使用两个临时变量，一个作为当前行编号，另一个用来存 上一条customer number与当前行的number进行对比，查询语句如下。（这句有点绕，可能翻译的不太准确，请以原文为准。To achieve this, you have to use two session variables, one for the row number and the other for storing the old customer number to compare it with the current one as the following query:）</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div></pre></td><td class=\"code\"><pre><div class=\"line\">SELECT </div><div class=\"line\">    @row_number:=CASE</div><div class=\"line\">        WHEN @customer_no = customerNumber THEN @row_number + 1</div><div class=\"line\">        ELSE 1</div><div class=\"line\">    END AS num,</div><div class=\"line\">    @customer_no:=customerNumber as CustomerNumber,</div><div class=\"line\">    paymentDate,</div><div class=\"line\">    amount</div><div class=\"line\">FROM</div><div class=\"line\">    payments</div><div class=\"line\">ORDER BY customerNumber;</div></pre></td></tr></table></figure>\n<p>在这段查询代码中，我们使用了CASE声明，如果customer的number不变，就给row_number变量+1，否则，重置为1，结果如下：</p>\n<p><img src=\"/images/mysql-row-number/mysql-row_number-per-group.jpg\" alt=\"\"></p>\n<p>与为每一行记录生成row_number一样，也可以使用派生表（derived table）和交叉连接（cross join）生成同样的结果。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div></pre></td><td class=\"code\"><pre><div class=\"line\">SELECT </div><div class=\"line\">    @row_number:=CASE</div><div class=\"line\">        WHEN @customer_no = customerNumber THEN @row_number + 1</div><div class=\"line\">        ELSE 1</div><div class=\"line\">    END AS num,</div><div class=\"line\">    @customer_no:=customerNumber as CustomerNumber,</div><div class=\"line\">    paymentDate,</div><div class=\"line\">    amount</div><div class=\"line\">FROM</div><div class=\"line\">    payments,(SELECT @customer_no:=0,@row_number:=0) as t</div><div class=\"line\">ORDER BY customerNumber;</div></pre></td></tr></table></figure>\n<p>本教程中，我们展示了如何在MySQL中模仿row_number方法。</p>\n<p>原文地址：<a href=\"http://www.mysqltutorial.org/mysql-row_number/\" target=\"_blank\" rel=\"external\">MySQL row_number, This Is How You Emulate It</a></p>\n","site":{"data":{}},"excerpt":"","more":"<p>接上篇：<a href=\"https://www.qichengzx.com/2016/02/03/MySQL%E5%AE%9E%E7%8E%B0row_number%20.html\">MySQL实现row_number</a></p>\n<h3 id=\"为分组增加row-number\"><a href=\"#为分组增加row-number\" class=\"headerlink\" title=\"为分组增加row number\"></a>为分组增加row number</h3><p>row_number的分析函数怎么样？（原文：How about  row_number “over partition by” functionality? ），比如，如果想为每一个组增加row number，并且在每一个新的分组重置它。</p>\n<p>查看下图中payments表。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">SELECT</div><div class=\"line\">    customerNumber, paymentDate, amount</div><div class=\"line\">FROM</div><div class=\"line\">    payments</div><div class=\"line\">ORDER BY customerNumber;</div></pre></td></tr></table></figure>\n<p><img src=\"/images/mysql-row-number/mysql-row_number-payments-table.jpg\" alt=\"\"></p>\n<p>设想下，为每一条customer数据增加一个当前行的编号，并且每当customer的number字段变化的时候行编号都被重置。</p>\n<p>为了实现这个，需要使用两个临时变量，一个作为当前行编号，另一个用来存 上一条customer number与当前行的number进行对比，查询语句如下。（这句有点绕，可能翻译的不太准确，请以原文为准。To achieve this, you have to use two session variables, one for the row number and the other for storing the old customer number to compare it with the current one as the following query:）</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div></pre></td><td class=\"code\"><pre><div class=\"line\">SELECT </div><div class=\"line\">    @row_number:=CASE</div><div class=\"line\">        WHEN @customer_no = customerNumber THEN @row_number + 1</div><div class=\"line\">        ELSE 1</div><div class=\"line\">    END AS num,</div><div class=\"line\">    @customer_no:=customerNumber as CustomerNumber,</div><div class=\"line\">    paymentDate,</div><div class=\"line\">    amount</div><div class=\"line\">FROM</div><div class=\"line\">    payments</div><div class=\"line\">ORDER BY customerNumber;</div></pre></td></tr></table></figure>\n<p>在这段查询代码中，我们使用了CASE声明，如果customer的number不变，就给row_number变量+1，否则，重置为1，结果如下：</p>\n<p><img src=\"/images/mysql-row-number/mysql-row_number-per-group.jpg\" alt=\"\"></p>\n<p>与为每一行记录生成row_number一样，也可以使用派生表（derived table）和交叉连接（cross join）生成同样的结果。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div></pre></td><td class=\"code\"><pre><div class=\"line\">SELECT </div><div class=\"line\">    @row_number:=CASE</div><div class=\"line\">        WHEN @customer_no = customerNumber THEN @row_number + 1</div><div class=\"line\">        ELSE 1</div><div class=\"line\">    END AS num,</div><div class=\"line\">    @customer_no:=customerNumber as CustomerNumber,</div><div class=\"line\">    paymentDate,</div><div class=\"line\">    amount</div><div class=\"line\">FROM</div><div class=\"line\">    payments,(SELECT @customer_no:=0,@row_number:=0) as t</div><div class=\"line\">ORDER BY customerNumber;</div></pre></td></tr></table></figure>\n<p>本教程中，我们展示了如何在MySQL中模仿row_number方法。</p>\n<p>原文地址：<a href=\"http://www.mysqltutorial.org/mysql-row_number/\" target=\"_blank\" rel=\"external\">MySQL row_number, This Is How You Emulate It</a></p>\n"},{"layout":"react-native","title":"React-Native Fetch方法发送网络请求","date":"2015-11-06T14:54:22.000Z","_content":"\n\n\n先贴一个官方文档。\n[Network](https://facebook.github.io/react-native/docs/network.html#content)\n\n\n\n    fetch('https://mywebsite.com/endpoint/', {\n        method: 'POST',\n        headers: {\n            'Accept': 'application/json',\n            'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n            firstParam: 'yourValue',\n            secondParam: 'yourOtherValue',\n        })\n    })\n\n一开始我就是单纯的这么写的，愉快的把URL替换掉，把参数替换掉，然后。。。\n我愉快的敲下 `var_dump($_POST['firstParam'])` 的时候，后台没接到任何东西，后来在stackoverflow上看到回答，说之所以接收不到，是因为这不属于form data，想要这么写，需要在接收前添加 `file_get_contents('php://input') `,然后果然就可以了。\n\n    $json = json_decode(file_get_contents('php://input'), true);\n    var_dump($json['firstParam']);\n\n但是这样会影响到现有的web应用，所以又继续查资料，发现可以改成下边这样的方法。\n\n\n    function toQueryString(obj) {\n        return obj ? Object.keys(obj).sort().map(function (key) {\n            var val = obj[key];\n            if (Array.isArray(val)) {\n                return val.sort().map(function (val2) {\n                    return encodeURIComponent(key) + '=' + encodeURIComponent(val2);\n                }).join('&');\n            }\n    \n            return encodeURIComponent(key) + '=' + encodeURIComponent(val);\n        }).join('&') : '';\n\t}\n\n\n    fetch(url, {\n        method: 'post',\n        body: toQueryString({ \n            'firstParam': 'yourValue',\n            'secondParam':'yourOtherValue' \n        })\n    }) \n\n\n\n这样，在后台就可以正常的用$_POST['firstParam'];接收了。\n\n\n[Sending data as key-value pair using fetch polyfill in react-native](http://stackoverflow.com/questions/32448862/how-can-i-use-react-native-with-php-with-fetch-return-data-is-always-null)\n\n[How can I use react-native with php with fetch return data is always null](http://stackoverflow.com/questions/31201940/sending-data-as-key-value-pair-using-fetch-polyfill-in-react-native)\n\n\n","source":"_posts/React-Native-Fetch.md","raw":"layout: react-native\ntitle: React-Native Fetch方法发送网络请求\ndate: 2015-11-06 22:54:22\ntags:  [react-native,fetch,网络请求]\n---\n\n\n\n先贴一个官方文档。\n[Network](https://facebook.github.io/react-native/docs/network.html#content)\n\n\n\n    fetch('https://mywebsite.com/endpoint/', {\n        method: 'POST',\n        headers: {\n            'Accept': 'application/json',\n            'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n            firstParam: 'yourValue',\n            secondParam: 'yourOtherValue',\n        })\n    })\n\n一开始我就是单纯的这么写的，愉快的把URL替换掉，把参数替换掉，然后。。。\n我愉快的敲下 `var_dump($_POST['firstParam'])` 的时候，后台没接到任何东西，后来在stackoverflow上看到回答，说之所以接收不到，是因为这不属于form data，想要这么写，需要在接收前添加 `file_get_contents('php://input') `,然后果然就可以了。\n\n    $json = json_decode(file_get_contents('php://input'), true);\n    var_dump($json['firstParam']);\n\n但是这样会影响到现有的web应用，所以又继续查资料，发现可以改成下边这样的方法。\n\n\n    function toQueryString(obj) {\n        return obj ? Object.keys(obj).sort().map(function (key) {\n            var val = obj[key];\n            if (Array.isArray(val)) {\n                return val.sort().map(function (val2) {\n                    return encodeURIComponent(key) + '=' + encodeURIComponent(val2);\n                }).join('&');\n            }\n    \n            return encodeURIComponent(key) + '=' + encodeURIComponent(val);\n        }).join('&') : '';\n\t}\n\n\n    fetch(url, {\n        method: 'post',\n        body: toQueryString({ \n            'firstParam': 'yourValue',\n            'secondParam':'yourOtherValue' \n        })\n    }) \n\n\n\n这样，在后台就可以正常的用$_POST['firstParam'];接收了。\n\n\n[Sending data as key-value pair using fetch polyfill in react-native](http://stackoverflow.com/questions/32448862/how-can-i-use-react-native-with-php-with-fetch-return-data-is-always-null)\n\n[How can I use react-native with php with fetch return data is always null](http://stackoverflow.com/questions/31201940/sending-data-as-key-value-pair-using-fetch-polyfill-in-react-native)\n\n\n","slug":"React-Native-Fetch","published":1,"updated":"2015-11-08T02:51:53.000Z","comments":1,"photos":[],"link":"","_id":"cj830jvd30006ul0rqf7jdpw3","content":"<p>先贴一个官方文档。<br><a href=\"https://facebook.github.io/react-native/docs/network.html#content\" target=\"_blank\" rel=\"external\">Network</a></p>\n<pre><code>fetch(&apos;https://mywebsite.com/endpoint/&apos;, {\n    method: &apos;POST&apos;,\n    headers: {\n        &apos;Accept&apos;: &apos;application/json&apos;,\n        &apos;Content-Type&apos;: &apos;application/json&apos;,\n    },\n    body: JSON.stringify({\n        firstParam: &apos;yourValue&apos;,\n        secondParam: &apos;yourOtherValue&apos;,\n    })\n})\n</code></pre><p>一开始我就是单纯的这么写的，愉快的把URL替换掉，把参数替换掉，然后。。。<br>我愉快的敲下 <code>var_dump($_POST[&#39;firstParam&#39;])</code> 的时候，后台没接到任何东西，后来在stackoverflow上看到回答，说之所以接收不到，是因为这不属于form data，想要这么写，需要在接收前添加 <code>file_get_contents(&#39;php://input&#39;)</code>,然后果然就可以了。</p>\n<pre><code>$json = json_decode(file_get_contents(&apos;php://input&apos;), true);\nvar_dump($json[&apos;firstParam&apos;]);\n</code></pre><p>但是这样会影响到现有的web应用，所以又继续查资料，发现可以改成下边这样的方法。</p>\n<pre><code>function toQueryString(obj) {\n    return obj ? Object.keys(obj).sort().map(function (key) {\n        var val = obj[key];\n        if (Array.isArray(val)) {\n            return val.sort().map(function (val2) {\n                return encodeURIComponent(key) + &apos;=&apos; + encodeURIComponent(val2);\n            }).join(&apos;&amp;&apos;);\n        }\n\n        return encodeURIComponent(key) + &apos;=&apos; + encodeURIComponent(val);\n    }).join(&apos;&amp;&apos;) : &apos;&apos;;\n}\n\n\nfetch(url, {\n    method: &apos;post&apos;,\n    body: toQueryString({ \n        &apos;firstParam&apos;: &apos;yourValue&apos;,\n        &apos;secondParam&apos;:&apos;yourOtherValue&apos; \n    })\n}) \n</code></pre><p>这样，在后台就可以正常的用$_POST[‘firstParam’];接收了。</p>\n<p><a href=\"http://stackoverflow.com/questions/32448862/how-can-i-use-react-native-with-php-with-fetch-return-data-is-always-null\" target=\"_blank\" rel=\"external\">Sending data as key-value pair using fetch polyfill in react-native</a></p>\n<p><a href=\"http://stackoverflow.com/questions/31201940/sending-data-as-key-value-pair-using-fetch-polyfill-in-react-native\" target=\"_blank\" rel=\"external\">How can I use react-native with php with fetch return data is always null</a></p>\n","site":{"data":{}},"excerpt":"","more":"<p>先贴一个官方文档。<br><a href=\"https://facebook.github.io/react-native/docs/network.html#content\" target=\"_blank\" rel=\"external\">Network</a></p>\n<pre><code>fetch(&apos;https://mywebsite.com/endpoint/&apos;, {\n    method: &apos;POST&apos;,\n    headers: {\n        &apos;Accept&apos;: &apos;application/json&apos;,\n        &apos;Content-Type&apos;: &apos;application/json&apos;,\n    },\n    body: JSON.stringify({\n        firstParam: &apos;yourValue&apos;,\n        secondParam: &apos;yourOtherValue&apos;,\n    })\n})\n</code></pre><p>一开始我就是单纯的这么写的，愉快的把URL替换掉，把参数替换掉，然后。。。<br>我愉快的敲下 <code>var_dump($_POST[&#39;firstParam&#39;])</code> 的时候，后台没接到任何东西，后来在stackoverflow上看到回答，说之所以接收不到，是因为这不属于form data，想要这么写，需要在接收前添加 <code>file_get_contents(&#39;php://input&#39;)</code>,然后果然就可以了。</p>\n<pre><code>$json = json_decode(file_get_contents(&apos;php://input&apos;), true);\nvar_dump($json[&apos;firstParam&apos;]);\n</code></pre><p>但是这样会影响到现有的web应用，所以又继续查资料，发现可以改成下边这样的方法。</p>\n<pre><code>function toQueryString(obj) {\n    return obj ? Object.keys(obj).sort().map(function (key) {\n        var val = obj[key];\n        if (Array.isArray(val)) {\n            return val.sort().map(function (val2) {\n                return encodeURIComponent(key) + &apos;=&apos; + encodeURIComponent(val2);\n            }).join(&apos;&amp;&apos;);\n        }\n\n        return encodeURIComponent(key) + &apos;=&apos; + encodeURIComponent(val);\n    }).join(&apos;&amp;&apos;) : &apos;&apos;;\n}\n\n\nfetch(url, {\n    method: &apos;post&apos;,\n    body: toQueryString({ \n        &apos;firstParam&apos;: &apos;yourValue&apos;,\n        &apos;secondParam&apos;:&apos;yourOtherValue&apos; \n    })\n}) \n</code></pre><p>这样，在后台就可以正常的用$_POST[‘firstParam’];接收了。</p>\n<p><a href=\"http://stackoverflow.com/questions/32448862/how-can-i-use-react-native-with-php-with-fetch-return-data-is-always-null\" target=\"_blank\" rel=\"external\">Sending data as key-value pair using fetch polyfill in react-native</a></p>\n<p><a href=\"http://stackoverflow.com/questions/31201940/sending-data-as-key-value-pair-using-fetch-polyfill-in-react-native\" target=\"_blank\" rel=\"external\">How can I use react-native with php with fetch return data is always null</a></p>\n"},{"title":"vps 搭建个人git服务器","date":"2015-11-07T15:34:10.000Z","_content":"\n\n以下内容主要来自\n\t[How To Set Up a Private Git Server on a VPS](https://www.digitalocean.com/community/tutorials/how-to-set-up-a-private-git-server-on-a-vps)\n\n之前在DigitalOcean买了个5刀的vps，本来是想搞VPN的，但是没成功，后来把个人博客放这了，后来又觉得有点浪费，索性重新启用这个域名来写技术文章。\n\n本来是用的WP的但是也一直没写，后来又想折腾别的程序试一下，就选了现在的[hexo](https://hexo.io)，昨天在自己电脑上安装了，也可以写文章页可以默认 `hexo server` 运行，然后，我愉快的把命令行关掉之后，就傻了。\n\n后来也在官方文档和Google里看有什么办法能让它在后台运行，官方说可以 `hexo s &`，然并卵，官方和Google都说可以用 `forever` `pm2` ，一样然并卵，今天早晨起来继续弄的时候，觉得还是放弃吧，既然有public文件夹，还是用nginx去解析吧。这个都是后话了。\n\n下边说怎么在vps上安装git服务器，昨天和今天上午也看了一些资料一直也不成功。晚上从DigitalOcean社区里看到这篇文章，然后就成功了。\n\n\n#### 0 在本地生成ssh key\n\n\tssh-keygen -C \"youremail@mailprovider.com\"\n\n\tGenerating public/private rsa key pair.\n\t\n\tEnter file in which to save the key (/home/flynn/.ssh/id_rsa):\n\t\n\tEnter passphrase (empty for no passphrase):\n\t\n\tEnter same passphrase again: \n\t\n\tYour identification has been saved in foo_rsa.\n\t\n\tYour public key has been saved in foo_rsa.pub.\n\n\n注意替换成自己的邮箱，可以一路回车，也可以在 Enter passphrase 的时候输入一个密码保护一下。如果已经生成过了可以 **略过这步**。\n#### 1 在服务器添加git用户\n首先切换到root用户，`su -` 。\n然后添加git用户。（用户名不一定是git，但是习惯上用这个名）\n\n`useradd git`\n\n设置密码\n\n`passwd git`\n\n输入两次密码即可，用户创建完毕。我在操作的时候并没有在/home/下创建git用户的目录。\n\n所以可能需要自己手动创建\n\n`cd /home/`\n\n`mkdir git `\n\n`sudo chown -R -v git:git git/`\n\n现在可以安装git服务了。\n\n\n    CentOS/Fedora: yum install git\n    Ubuntu/Debian: apt-get install git\n\nDO文档说可以这样，但是部分资料里写要 install git-core，但是因为之前安装过git-core，所以不确定是不是DO文档上是正确的，**所以此处DO的文档可能不准确。**（不确定）\n\n#### 2 把本地的ssh key添加到服务器的允许访问列表里\n\n登录进服务器，切换到git用户。\n\n`su git`\n\n然后创建git用户的.ssh文件夹及authorized_keys文件，\n\n`mkdir ~/.ssh && touch ~/.ssh/authorized_keys`\n\n\n&&的意思是执行完第一个命令后紧接着执行第二个命令，分开写一样可以，连着写逼格更高。\n\n然后回到本地的命令行里，\n\n`cat .ssh/id_rsa.pub | ssh git@123.45.56.78 \"cat >> ~/.ssh/authorized_keys\"`\n\n第一个cat 后的文件地址取决于你电脑上这个文件的路径，后边是说把前边你本地的id_rsa.pub的内容写到远程服务器上git 这个用户的.ssh/authorized_keys文件里，也就是前边创建的那个文件。\n\n所以，不出意外的话，此时可以在服务器上运行\n\n`cat ~/.ssh/authorized_keys ` 就可以看到你本地电脑生成的key了，不出意外的话结尾应该是你生成key填写的邮箱。\n\n#### 3 初始化本地仓库\n\n在服务器上任何一个位置，执行\n\n`git init --bare project.git`，这样，在你的开发机和服务器环境是就可以用到这个project.git了。\n\n（为已存在的git项目）设置远程仓库的URL\n\n`git remote set-url origin git@git.droplet.com:project.git`\n\ngit@git.droplet.com:project.git 替换成你的git用户名，你的ip或域名，及你的服务器上git的文件夹\n\n如果是一个新的仓库，是这样\n\n`git init && git remote add origin git@git.droplet.com:project.git`\n\ngit@git.droplet.com:my-project.gi 只是服务器上\n\n\n### 总结：\n\n\t所以实际上上边的流程是\n\t\n\t0. 在服务器上比如home/git 目录里git init --bare project.git\n\t1. 在自己电脑，某个目录，git init 或者git clone git@git.droplet.com:project.git\n\t2. 在服务器上比如www目录，git init 或git clone git@git.droplet.com:project.git\n\t\n\t不出意外，这样就可以了。\n\t\n\t本地添加一个新文件，git add . , git commit -m \"test\" ,git push origin master，登录服务器，切换到www目录，git pull origin master，就可以了。\n\t\n\t\n参考资料:\n\n[How To Set Up a Private Git Server on a VPS](https://www.digitalocean.com/community/tutorials/how-to-set-up-a-private-git-server-on-a-vps)\n\n[Git on the Server - Setting Up the Server](https://git-scm.com/book/it/v2/Git-on-the-Server-Setting-Up-the-Server)","source":"_posts/Set Up a Private Git Server on a VPS.md","raw":"title: vps 搭建个人git服务器\ndate: 2015-11-07 23:34:10\ntags:  [vps,git]\n---\n\n\n以下内容主要来自\n\t[How To Set Up a Private Git Server on a VPS](https://www.digitalocean.com/community/tutorials/how-to-set-up-a-private-git-server-on-a-vps)\n\n之前在DigitalOcean买了个5刀的vps，本来是想搞VPN的，但是没成功，后来把个人博客放这了，后来又觉得有点浪费，索性重新启用这个域名来写技术文章。\n\n本来是用的WP的但是也一直没写，后来又想折腾别的程序试一下，就选了现在的[hexo](https://hexo.io)，昨天在自己电脑上安装了，也可以写文章页可以默认 `hexo server` 运行，然后，我愉快的把命令行关掉之后，就傻了。\n\n后来也在官方文档和Google里看有什么办法能让它在后台运行，官方说可以 `hexo s &`，然并卵，官方和Google都说可以用 `forever` `pm2` ，一样然并卵，今天早晨起来继续弄的时候，觉得还是放弃吧，既然有public文件夹，还是用nginx去解析吧。这个都是后话了。\n\n下边说怎么在vps上安装git服务器，昨天和今天上午也看了一些资料一直也不成功。晚上从DigitalOcean社区里看到这篇文章，然后就成功了。\n\n\n#### 0 在本地生成ssh key\n\n\tssh-keygen -C \"youremail@mailprovider.com\"\n\n\tGenerating public/private rsa key pair.\n\t\n\tEnter file in which to save the key (/home/flynn/.ssh/id_rsa):\n\t\n\tEnter passphrase (empty for no passphrase):\n\t\n\tEnter same passphrase again: \n\t\n\tYour identification has been saved in foo_rsa.\n\t\n\tYour public key has been saved in foo_rsa.pub.\n\n\n注意替换成自己的邮箱，可以一路回车，也可以在 Enter passphrase 的时候输入一个密码保护一下。如果已经生成过了可以 **略过这步**。\n#### 1 在服务器添加git用户\n首先切换到root用户，`su -` 。\n然后添加git用户。（用户名不一定是git，但是习惯上用这个名）\n\n`useradd git`\n\n设置密码\n\n`passwd git`\n\n输入两次密码即可，用户创建完毕。我在操作的时候并没有在/home/下创建git用户的目录。\n\n所以可能需要自己手动创建\n\n`cd /home/`\n\n`mkdir git `\n\n`sudo chown -R -v git:git git/`\n\n现在可以安装git服务了。\n\n\n    CentOS/Fedora: yum install git\n    Ubuntu/Debian: apt-get install git\n\nDO文档说可以这样，但是部分资料里写要 install git-core，但是因为之前安装过git-core，所以不确定是不是DO文档上是正确的，**所以此处DO的文档可能不准确。**（不确定）\n\n#### 2 把本地的ssh key添加到服务器的允许访问列表里\n\n登录进服务器，切换到git用户。\n\n`su git`\n\n然后创建git用户的.ssh文件夹及authorized_keys文件，\n\n`mkdir ~/.ssh && touch ~/.ssh/authorized_keys`\n\n\n&&的意思是执行完第一个命令后紧接着执行第二个命令，分开写一样可以，连着写逼格更高。\n\n然后回到本地的命令行里，\n\n`cat .ssh/id_rsa.pub | ssh git@123.45.56.78 \"cat >> ~/.ssh/authorized_keys\"`\n\n第一个cat 后的文件地址取决于你电脑上这个文件的路径，后边是说把前边你本地的id_rsa.pub的内容写到远程服务器上git 这个用户的.ssh/authorized_keys文件里，也就是前边创建的那个文件。\n\n所以，不出意外的话，此时可以在服务器上运行\n\n`cat ~/.ssh/authorized_keys ` 就可以看到你本地电脑生成的key了，不出意外的话结尾应该是你生成key填写的邮箱。\n\n#### 3 初始化本地仓库\n\n在服务器上任何一个位置，执行\n\n`git init --bare project.git`，这样，在你的开发机和服务器环境是就可以用到这个project.git了。\n\n（为已存在的git项目）设置远程仓库的URL\n\n`git remote set-url origin git@git.droplet.com:project.git`\n\ngit@git.droplet.com:project.git 替换成你的git用户名，你的ip或域名，及你的服务器上git的文件夹\n\n如果是一个新的仓库，是这样\n\n`git init && git remote add origin git@git.droplet.com:project.git`\n\ngit@git.droplet.com:my-project.gi 只是服务器上\n\n\n### 总结：\n\n\t所以实际上上边的流程是\n\t\n\t0. 在服务器上比如home/git 目录里git init --bare project.git\n\t1. 在自己电脑，某个目录，git init 或者git clone git@git.droplet.com:project.git\n\t2. 在服务器上比如www目录，git init 或git clone git@git.droplet.com:project.git\n\t\n\t不出意外，这样就可以了。\n\t\n\t本地添加一个新文件，git add . , git commit -m \"test\" ,git push origin master，登录服务器，切换到www目录，git pull origin master，就可以了。\n\t\n\t\n参考资料:\n\n[How To Set Up a Private Git Server on a VPS](https://www.digitalocean.com/community/tutorials/how-to-set-up-a-private-git-server-on-a-vps)\n\n[Git on the Server - Setting Up the Server](https://git-scm.com/book/it/v2/Git-on-the-Server-Setting-Up-the-Server)","slug":"Set Up a Private Git Server on a VPS","published":1,"updated":"2015-11-08T02:42:16.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj830jvd7000aul0r11eg7gop","content":"<p>以下内容主要来自<br>    <a href=\"https://www.digitalocean.com/community/tutorials/how-to-set-up-a-private-git-server-on-a-vps\" target=\"_blank\" rel=\"external\">How To Set Up a Private Git Server on a VPS</a></p>\n<p>之前在DigitalOcean买了个5刀的vps，本来是想搞VPN的，但是没成功，后来把个人博客放这了，后来又觉得有点浪费，索性重新启用这个域名来写技术文章。</p>\n<p>本来是用的WP的但是也一直没写，后来又想折腾别的程序试一下，就选了现在的<a href=\"https://hexo.io\" target=\"_blank\" rel=\"external\">hexo</a>，昨天在自己电脑上安装了，也可以写文章页可以默认 <code>hexo server</code> 运行，然后，我愉快的把命令行关掉之后，就傻了。</p>\n<p>后来也在官方文档和Google里看有什么办法能让它在后台运行，官方说可以 <code>hexo s &amp;</code>，然并卵，官方和Google都说可以用 <code>forever</code> <code>pm2</code> ，一样然并卵，今天早晨起来继续弄的时候，觉得还是放弃吧，既然有public文件夹，还是用nginx去解析吧。这个都是后话了。</p>\n<p>下边说怎么在vps上安装git服务器，昨天和今天上午也看了一些资料一直也不成功。晚上从DigitalOcean社区里看到这篇文章，然后就成功了。</p>\n<h4 id=\"0-在本地生成ssh-key\"><a href=\"#0-在本地生成ssh-key\" class=\"headerlink\" title=\"0 在本地生成ssh key\"></a>0 在本地生成ssh key</h4><pre><code>ssh-keygen -C &quot;youremail@mailprovider.com&quot;\n\nGenerating public/private rsa key pair.\n\nEnter file in which to save the key (/home/flynn/.ssh/id_rsa):\n\nEnter passphrase (empty for no passphrase):\n\nEnter same passphrase again: \n\nYour identification has been saved in foo_rsa.\n\nYour public key has been saved in foo_rsa.pub.\n</code></pre><p>注意替换成自己的邮箱，可以一路回车，也可以在 Enter passphrase 的时候输入一个密码保护一下。如果已经生成过了可以 <strong>略过这步</strong>。</p>\n<h4 id=\"1-在服务器添加git用户\"><a href=\"#1-在服务器添加git用户\" class=\"headerlink\" title=\"1 在服务器添加git用户\"></a>1 在服务器添加git用户</h4><p>首先切换到root用户，<code>su -</code> 。<br>然后添加git用户。（用户名不一定是git，但是习惯上用这个名）</p>\n<p><code>useradd git</code></p>\n<p>设置密码</p>\n<p><code>passwd git</code></p>\n<p>输入两次密码即可，用户创建完毕。我在操作的时候并没有在/home/下创建git用户的目录。</p>\n<p>所以可能需要自己手动创建</p>\n<p><code>cd /home/</code></p>\n<p><code>mkdir git</code></p>\n<p><code>sudo chown -R -v git:git git/</code></p>\n<p>现在可以安装git服务了。</p>\n<pre><code>CentOS/Fedora: yum install git\nUbuntu/Debian: apt-get install git\n</code></pre><p>DO文档说可以这样，但是部分资料里写要 install git-core，但是因为之前安装过git-core，所以不确定是不是DO文档上是正确的，<strong>所以此处DO的文档可能不准确。</strong>（不确定）</p>\n<h4 id=\"2-把本地的ssh-key添加到服务器的允许访问列表里\"><a href=\"#2-把本地的ssh-key添加到服务器的允许访问列表里\" class=\"headerlink\" title=\"2 把本地的ssh key添加到服务器的允许访问列表里\"></a>2 把本地的ssh key添加到服务器的允许访问列表里</h4><p>登录进服务器，切换到git用户。</p>\n<p><code>su git</code></p>\n<p>然后创建git用户的.ssh文件夹及authorized_keys文件，</p>\n<p><code>mkdir ~/.ssh &amp;&amp; touch ~/.ssh/authorized_keys</code></p>\n<p>&amp;&amp;的意思是执行完第一个命令后紧接着执行第二个命令，分开写一样可以，连着写逼格更高。</p>\n<p>然后回到本地的命令行里，</p>\n<p><code>cat .ssh/id_rsa.pub | ssh git@123.45.56.78 &quot;cat &gt;&gt; ~/.ssh/authorized_keys&quot;</code></p>\n<p>第一个cat 后的文件地址取决于你电脑上这个文件的路径，后边是说把前边你本地的id_rsa.pub的内容写到远程服务器上git 这个用户的.ssh/authorized_keys文件里，也就是前边创建的那个文件。</p>\n<p>所以，不出意外的话，此时可以在服务器上运行</p>\n<p><code>cat ~/.ssh/authorized_keys</code> 就可以看到你本地电脑生成的key了，不出意外的话结尾应该是你生成key填写的邮箱。</p>\n<h4 id=\"3-初始化本地仓库\"><a href=\"#3-初始化本地仓库\" class=\"headerlink\" title=\"3 初始化本地仓库\"></a>3 初始化本地仓库</h4><p>在服务器上任何一个位置，执行</p>\n<p><code>git init --bare project.git</code>，这样，在你的开发机和服务器环境是就可以用到这个project.git了。</p>\n<p>（为已存在的git项目）设置远程仓库的URL</p>\n<p><code>git remote set-url origin git@git.droplet.com:project.git</code></p>\n<p>git@git.droplet.com:project.git 替换成你的git用户名，你的ip或域名，及你的服务器上git的文件夹</p>\n<p>如果是一个新的仓库，是这样</p>\n<p><code>git init &amp;&amp; git remote add origin git@git.droplet.com:project.git</code></p>\n<p>git@git.droplet.com:my-project.gi 只是服务器上</p>\n<h3 id=\"总结：\"><a href=\"#总结：\" class=\"headerlink\" title=\"总结：\"></a>总结：</h3><pre><code>所以实际上上边的流程是\n\n0. 在服务器上比如home/git 目录里git init --bare project.git\n1. 在自己电脑，某个目录，git init 或者git clone git@git.droplet.com:project.git\n2. 在服务器上比如www目录，git init 或git clone git@git.droplet.com:project.git\n\n不出意外，这样就可以了。\n\n本地添加一个新文件，git add . , git commit -m &quot;test&quot; ,git push origin master，登录服务器，切换到www目录，git pull origin master，就可以了。\n</code></pre><p>参考资料:</p>\n<p><a href=\"https://www.digitalocean.com/community/tutorials/how-to-set-up-a-private-git-server-on-a-vps\" target=\"_blank\" rel=\"external\">How To Set Up a Private Git Server on a VPS</a></p>\n<p><a href=\"https://git-scm.com/book/it/v2/Git-on-the-Server-Setting-Up-the-Server\" target=\"_blank\" rel=\"external\">Git on the Server - Setting Up the Server</a></p>\n","site":{"data":{}},"excerpt":"","more":"<p>以下内容主要来自<br>    <a href=\"https://www.digitalocean.com/community/tutorials/how-to-set-up-a-private-git-server-on-a-vps\" target=\"_blank\" rel=\"external\">How To Set Up a Private Git Server on a VPS</a></p>\n<p>之前在DigitalOcean买了个5刀的vps，本来是想搞VPN的，但是没成功，后来把个人博客放这了，后来又觉得有点浪费，索性重新启用这个域名来写技术文章。</p>\n<p>本来是用的WP的但是也一直没写，后来又想折腾别的程序试一下，就选了现在的<a href=\"https://hexo.io\" target=\"_blank\" rel=\"external\">hexo</a>，昨天在自己电脑上安装了，也可以写文章页可以默认 <code>hexo server</code> 运行，然后，我愉快的把命令行关掉之后，就傻了。</p>\n<p>后来也在官方文档和Google里看有什么办法能让它在后台运行，官方说可以 <code>hexo s &amp;</code>，然并卵，官方和Google都说可以用 <code>forever</code> <code>pm2</code> ，一样然并卵，今天早晨起来继续弄的时候，觉得还是放弃吧，既然有public文件夹，还是用nginx去解析吧。这个都是后话了。</p>\n<p>下边说怎么在vps上安装git服务器，昨天和今天上午也看了一些资料一直也不成功。晚上从DigitalOcean社区里看到这篇文章，然后就成功了。</p>\n<h4 id=\"0-在本地生成ssh-key\"><a href=\"#0-在本地生成ssh-key\" class=\"headerlink\" title=\"0 在本地生成ssh key\"></a>0 在本地生成ssh key</h4><pre><code>ssh-keygen -C &quot;youremail@mailprovider.com&quot;\n\nGenerating public/private rsa key pair.\n\nEnter file in which to save the key (/home/flynn/.ssh/id_rsa):\n\nEnter passphrase (empty for no passphrase):\n\nEnter same passphrase again: \n\nYour identification has been saved in foo_rsa.\n\nYour public key has been saved in foo_rsa.pub.\n</code></pre><p>注意替换成自己的邮箱，可以一路回车，也可以在 Enter passphrase 的时候输入一个密码保护一下。如果已经生成过了可以 <strong>略过这步</strong>。</p>\n<h4 id=\"1-在服务器添加git用户\"><a href=\"#1-在服务器添加git用户\" class=\"headerlink\" title=\"1 在服务器添加git用户\"></a>1 在服务器添加git用户</h4><p>首先切换到root用户，<code>su -</code> 。<br>然后添加git用户。（用户名不一定是git，但是习惯上用这个名）</p>\n<p><code>useradd git</code></p>\n<p>设置密码</p>\n<p><code>passwd git</code></p>\n<p>输入两次密码即可，用户创建完毕。我在操作的时候并没有在/home/下创建git用户的目录。</p>\n<p>所以可能需要自己手动创建</p>\n<p><code>cd /home/</code></p>\n<p><code>mkdir git</code></p>\n<p><code>sudo chown -R -v git:git git/</code></p>\n<p>现在可以安装git服务了。</p>\n<pre><code>CentOS/Fedora: yum install git\nUbuntu/Debian: apt-get install git\n</code></pre><p>DO文档说可以这样，但是部分资料里写要 install git-core，但是因为之前安装过git-core，所以不确定是不是DO文档上是正确的，<strong>所以此处DO的文档可能不准确。</strong>（不确定）</p>\n<h4 id=\"2-把本地的ssh-key添加到服务器的允许访问列表里\"><a href=\"#2-把本地的ssh-key添加到服务器的允许访问列表里\" class=\"headerlink\" title=\"2 把本地的ssh key添加到服务器的允许访问列表里\"></a>2 把本地的ssh key添加到服务器的允许访问列表里</h4><p>登录进服务器，切换到git用户。</p>\n<p><code>su git</code></p>\n<p>然后创建git用户的.ssh文件夹及authorized_keys文件，</p>\n<p><code>mkdir ~/.ssh &amp;&amp; touch ~/.ssh/authorized_keys</code></p>\n<p>&amp;&amp;的意思是执行完第一个命令后紧接着执行第二个命令，分开写一样可以，连着写逼格更高。</p>\n<p>然后回到本地的命令行里，</p>\n<p><code>cat .ssh/id_rsa.pub | ssh git@123.45.56.78 &quot;cat &gt;&gt; ~/.ssh/authorized_keys&quot;</code></p>\n<p>第一个cat 后的文件地址取决于你电脑上这个文件的路径，后边是说把前边你本地的id_rsa.pub的内容写到远程服务器上git 这个用户的.ssh/authorized_keys文件里，也就是前边创建的那个文件。</p>\n<p>所以，不出意外的话，此时可以在服务器上运行</p>\n<p><code>cat ~/.ssh/authorized_keys</code> 就可以看到你本地电脑生成的key了，不出意外的话结尾应该是你生成key填写的邮箱。</p>\n<h4 id=\"3-初始化本地仓库\"><a href=\"#3-初始化本地仓库\" class=\"headerlink\" title=\"3 初始化本地仓库\"></a>3 初始化本地仓库</h4><p>在服务器上任何一个位置，执行</p>\n<p><code>git init --bare project.git</code>，这样，在你的开发机和服务器环境是就可以用到这个project.git了。</p>\n<p>（为已存在的git项目）设置远程仓库的URL</p>\n<p><code>git remote set-url origin git@git.droplet.com:project.git</code></p>\n<p>git@git.droplet.com:project.git 替换成你的git用户名，你的ip或域名，及你的服务器上git的文件夹</p>\n<p>如果是一个新的仓库，是这样</p>\n<p><code>git init &amp;&amp; git remote add origin git@git.droplet.com:project.git</code></p>\n<p>git@git.droplet.com:my-project.gi 只是服务器上</p>\n<h3 id=\"总结：\"><a href=\"#总结：\" class=\"headerlink\" title=\"总结：\"></a>总结：</h3><pre><code>所以实际上上边的流程是\n\n0. 在服务器上比如home/git 目录里git init --bare project.git\n1. 在自己电脑，某个目录，git init 或者git clone git@git.droplet.com:project.git\n2. 在服务器上比如www目录，git init 或git clone git@git.droplet.com:project.git\n\n不出意外，这样就可以了。\n\n本地添加一个新文件，git add . , git commit -m &quot;test&quot; ,git push origin master，登录服务器，切换到www目录，git pull origin master，就可以了。\n</code></pre><p>参考资料:</p>\n<p><a href=\"https://www.digitalocean.com/community/tutorials/how-to-set-up-a-private-git-server-on-a-vps\" target=\"_blank\" rel=\"external\">How To Set Up a Private Git Server on a VPS</a></p>\n<p><a href=\"https://git-scm.com/book/it/v2/Git-on-the-Server-Setting-Up-the-Server\" target=\"_blank\" rel=\"external\">Git on the Server - Setting Up the Server</a></p>\n"},{"title":"一段有意思的JS For循环代码","date":"2016-02-25T09:10:43.000Z","_content":"\n```\nvar a =0;\nfor (var i =0,j =0; i <10,j<6;i++,j++) {\n\ta = i+j;\n\tconsole.log(\"i=\"+i);\n\tconsole.log(\"j=\"+j);\n\tconsole.log(\"a=\"+a);\n}\n```\n\n朋友面试，遇到的面试题，电话跟我说完就回来写下来试了一下，结果与自己预想的一样。\n\n没写之前，电话里说的思路是，因为 j 限制了 小于 6，那么应该只循环6次，实际上也确实是这样。\n\n所以最终结果，a = 10。\n\n###### 但是想不明白为什么会有这样的面试题，或者说，什么样的情况会需要写这样的代码呢？","source":"_posts/a-piece-of-interesting-code-of-js-for-function.md","raw":"title: 一段有意思的JS For循环代码\ncategories: javascript\ndate: 2016-02-25 17:10:43\ntags:  [js]\n\n---\n\n```\nvar a =0;\nfor (var i =0,j =0; i <10,j<6;i++,j++) {\n\ta = i+j;\n\tconsole.log(\"i=\"+i);\n\tconsole.log(\"j=\"+j);\n\tconsole.log(\"a=\"+a);\n}\n```\n\n朋友面试，遇到的面试题，电话跟我说完就回来写下来试了一下，结果与自己预想的一样。\n\n没写之前，电话里说的思路是，因为 j 限制了 小于 6，那么应该只循环6次，实际上也确实是这样。\n\n所以最终结果，a = 10。\n\n###### 但是想不明白为什么会有这样的面试题，或者说，什么样的情况会需要写这样的代码呢？","slug":"a-piece-of-interesting-code-of-js-for-function","published":1,"updated":"2016-02-25T09:16:54.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj830jvd9000bul0rt8yvx34i","content":"<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">var a =0;</div><div class=\"line\">for (var i =0,j =0; i &lt;10,j&lt;6;i++,j++) &#123;</div><div class=\"line\">\ta = i+j;</div><div class=\"line\">\tconsole.log(&quot;i=&quot;+i);</div><div class=\"line\">\tconsole.log(&quot;j=&quot;+j);</div><div class=\"line\">\tconsole.log(&quot;a=&quot;+a);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>朋友面试，遇到的面试题，电话跟我说完就回来写下来试了一下，结果与自己预想的一样。</p>\n<p>没写之前，电话里说的思路是，因为 j 限制了 小于 6，那么应该只循环6次，实际上也确实是这样。</p>\n<p>所以最终结果，a = 10。</p>\n<h6 id=\"但是想不明白为什么会有这样的面试题，或者说，什么样的情况会需要写这样的代码呢？\"><a href=\"#但是想不明白为什么会有这样的面试题，或者说，什么样的情况会需要写这样的代码呢？\" class=\"headerlink\" title=\"但是想不明白为什么会有这样的面试题，或者说，什么样的情况会需要写这样的代码呢？\"></a>但是想不明白为什么会有这样的面试题，或者说，什么样的情况会需要写这样的代码呢？</h6>","site":{"data":{}},"excerpt":"","more":"<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">var a =0;</div><div class=\"line\">for (var i =0,j =0; i &lt;10,j&lt;6;i++,j++) &#123;</div><div class=\"line\">\ta = i+j;</div><div class=\"line\">\tconsole.log(&quot;i=&quot;+i);</div><div class=\"line\">\tconsole.log(&quot;j=&quot;+j);</div><div class=\"line\">\tconsole.log(&quot;a=&quot;+a);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>朋友面试，遇到的面试题，电话跟我说完就回来写下来试了一下，结果与自己预想的一样。</p>\n<p>没写之前，电话里说的思路是，因为 j 限制了 小于 6，那么应该只循环6次，实际上也确实是这样。</p>\n<p>所以最终结果，a = 10。</p>\n<h6 id=\"但是想不明白为什么会有这样的面试题，或者说，什么样的情况会需要写这样的代码呢？\"><a href=\"#但是想不明白为什么会有这样的面试题，或者说，什么样的情况会需要写这样的代码呢？\" class=\"headerlink\" title=\"但是想不明白为什么会有这样的面试题，或者说，什么样的情况会需要写这样的代码呢？\"></a>但是想不明白为什么会有这样的面试题，或者说，什么样的情况会需要写这样的代码呢？</h6>"},{"title":"一个简单的php+redis队列示例","date":"2016-05-15T06:19:52.000Z","_content":"\n![](/images/redis/redis-300dpi.png)\n\n虽然RabbitMQ的坑年前就开始填了，但是并没有机会在项目中实际使用，机缘巧合，换工作后第一个比较重要的事就是做一个直播的页面，如果数据直接插入或读取自数据库，数据库端的压力就太大了，当时RabbitMQ还没看完，而其他的队列程序更是没有用过，只是稍微对Redis熟悉些，于是就使用了Redis做。\n\n[Redis](http://redis.io/)比较常见的是作为数据缓存工具使用，数据存储在内存中，减少了数据库的连接和查询，效率高，又方便。\n\n而其实Redis也可以用来做消息队列。\n\n### 发送\n\n发送端首先当然是做好数据的接收和检测，比如为空的情况下给个默认值或返回错误。\n\n特殊的情况下可能还要正则处理。\n\n处理完插入到Redis的list([列表](http://www.redis.cn/topics/data-types-intro.html#lists))中。如果插入失败抛出异常。\n\n```php\n<?php\n\n$redis = new Redis();\n$redis->connect('127.0.0.1');\n\n//如果redis需要认证\n$redis->auth('redispasswd');\n\n//命令行中使用，可以使用把信息作为参数的方式\n$data = $argv[1];\nif(empty($data)) $data = \"Hello World..!\":\n\ntry{\n\t//便于调试，在信息后边加上当前时间\n\t$data .= '-at-'.date('Y-m-d H:i:s');\n\t$redis->LPUSH('redis_queue_1',json_encode($data));\n}catch(Exception $e){\n\techo $e->getMessage().\"\\n\";\n}\n```\n\n#### 执行\n\n```shell\nphp push.php \"testinfo\"\n```\n\n### 接收\n\n由于消息是源源不断发送到队列中，所以接收端程序一般会以后台进程的方式运行。\n\n```php\n<?php\n$redis = new Redis();\n$redis->connect('127.0.0.1');\n\n$redis->auth('redispasswd');\n\nwhile (true) {\n\n\ttry {\n\t\t$data = $redis->rPopLPush('redis_queue_1','redis_queue_1_bak').\"\\n\";\n\t\tif($data){\n\t\t\techo $data;\n\t\t}else{\n\t\t\techo \"没有数据\\n\";\n\t\t}\n\t} catch (Exception $e) {\n\t\techo $e->getMessage().\"\\n\";\n\t}\n\n\t//每秒读取1次\n\tsleep(1);\n}\n```\n\n#### 执行\n\n```shell\nphp get.php\n```\n\n### 更进一步\n\n如果想把数据写入到MySQL中，该怎么办？\n\n大多数情况下数据最终是需要持久化的，仅仅存在于redis中，也许内存会不够呢。\n\n改造一下get.php。\n\n```php\n<?php\n$redis = new Redis();\n$redis->connect('127.0.0.1');\n\n$redis->auth('redispasswd');\n\n$dsn = 'mysql:dbname=test;host=127.0.0.1';\n\ntry{\n\t$pdo = new PDO($dsn,'root','mysqlpasswd',array(PDO::MYSQL_ATTR_INIT_COMMAND => 'SET NAMES utf8'));\n}catch(PDOExcetion $e){\n\techo $e->getMessage().\"\\n\";\n}\n\nwhile(true){\n\t$data = $redis->rPopLPush('redis_queue_1','redis_queue_1_bak');\n\tif($data){\n\t\t$sth = $pdo->prepare(\"INSERT INTO tb_test(msg,time) VALUES (:msg,:time)\");\n\t\t\n\t\t$time = time();\n\t\t\n\t\t$sth->bindParam(':msg',$data,PDO::PARAM_STR);\n\t\t$sth->bindParam(':time',$time,PDO::PARAM_INT);\n\t\t\n\t\t$sth->execute();\n\t\t$id = $pdo->lastInsertId();\n      \n\t\techo \"插入成功，ID=$id \\n\";\n\t}else{\n\t\techo \"没有数据 \\n\";\n\t}\n\t\n\t//实际任务中可能需要尽可能快的把数据导入到MySQL中\n\tsleep(1);\n}\n```\n\n\n\n#### 注意\n\n​\t这里使用了[PDO](http://php.net/manual/zh/book.pdo.php);\n\n​\t[bindParam](http://php.net/manual/zh/pdostatement.bindparam.php)方法的第一个参数对应insert语句中的对应顺序的值，如第一个bindParam方法对应第一个value值。\n\n​\tbindParam方法第二个参数为实际的值，传入变量或固定值，传入方法调用时如time()会提示：\n\nStrict standards: Only variables should be passed by reference in /www/get.php on line 24。","source":"_posts/a-sample-redis-queue.md","raw":"title: 一个简单的php+redis队列示例\ncategories: php\ndate: 2016-05-15 14:19:52\ntags:  [redis,php,队列]\n\n---\n\n![](/images/redis/redis-300dpi.png)\n\n虽然RabbitMQ的坑年前就开始填了，但是并没有机会在项目中实际使用，机缘巧合，换工作后第一个比较重要的事就是做一个直播的页面，如果数据直接插入或读取自数据库，数据库端的压力就太大了，当时RabbitMQ还没看完，而其他的队列程序更是没有用过，只是稍微对Redis熟悉些，于是就使用了Redis做。\n\n[Redis](http://redis.io/)比较常见的是作为数据缓存工具使用，数据存储在内存中，减少了数据库的连接和查询，效率高，又方便。\n\n而其实Redis也可以用来做消息队列。\n\n### 发送\n\n发送端首先当然是做好数据的接收和检测，比如为空的情况下给个默认值或返回错误。\n\n特殊的情况下可能还要正则处理。\n\n处理完插入到Redis的list([列表](http://www.redis.cn/topics/data-types-intro.html#lists))中。如果插入失败抛出异常。\n\n```php\n<?php\n\n$redis = new Redis();\n$redis->connect('127.0.0.1');\n\n//如果redis需要认证\n$redis->auth('redispasswd');\n\n//命令行中使用，可以使用把信息作为参数的方式\n$data = $argv[1];\nif(empty($data)) $data = \"Hello World..!\":\n\ntry{\n\t//便于调试，在信息后边加上当前时间\n\t$data .= '-at-'.date('Y-m-d H:i:s');\n\t$redis->LPUSH('redis_queue_1',json_encode($data));\n}catch(Exception $e){\n\techo $e->getMessage().\"\\n\";\n}\n```\n\n#### 执行\n\n```shell\nphp push.php \"testinfo\"\n```\n\n### 接收\n\n由于消息是源源不断发送到队列中，所以接收端程序一般会以后台进程的方式运行。\n\n```php\n<?php\n$redis = new Redis();\n$redis->connect('127.0.0.1');\n\n$redis->auth('redispasswd');\n\nwhile (true) {\n\n\ttry {\n\t\t$data = $redis->rPopLPush('redis_queue_1','redis_queue_1_bak').\"\\n\";\n\t\tif($data){\n\t\t\techo $data;\n\t\t}else{\n\t\t\techo \"没有数据\\n\";\n\t\t}\n\t} catch (Exception $e) {\n\t\techo $e->getMessage().\"\\n\";\n\t}\n\n\t//每秒读取1次\n\tsleep(1);\n}\n```\n\n#### 执行\n\n```shell\nphp get.php\n```\n\n### 更进一步\n\n如果想把数据写入到MySQL中，该怎么办？\n\n大多数情况下数据最终是需要持久化的，仅仅存在于redis中，也许内存会不够呢。\n\n改造一下get.php。\n\n```php\n<?php\n$redis = new Redis();\n$redis->connect('127.0.0.1');\n\n$redis->auth('redispasswd');\n\n$dsn = 'mysql:dbname=test;host=127.0.0.1';\n\ntry{\n\t$pdo = new PDO($dsn,'root','mysqlpasswd',array(PDO::MYSQL_ATTR_INIT_COMMAND => 'SET NAMES utf8'));\n}catch(PDOExcetion $e){\n\techo $e->getMessage().\"\\n\";\n}\n\nwhile(true){\n\t$data = $redis->rPopLPush('redis_queue_1','redis_queue_1_bak');\n\tif($data){\n\t\t$sth = $pdo->prepare(\"INSERT INTO tb_test(msg,time) VALUES (:msg,:time)\");\n\t\t\n\t\t$time = time();\n\t\t\n\t\t$sth->bindParam(':msg',$data,PDO::PARAM_STR);\n\t\t$sth->bindParam(':time',$time,PDO::PARAM_INT);\n\t\t\n\t\t$sth->execute();\n\t\t$id = $pdo->lastInsertId();\n      \n\t\techo \"插入成功，ID=$id \\n\";\n\t}else{\n\t\techo \"没有数据 \\n\";\n\t}\n\t\n\t//实际任务中可能需要尽可能快的把数据导入到MySQL中\n\tsleep(1);\n}\n```\n\n\n\n#### 注意\n\n​\t这里使用了[PDO](http://php.net/manual/zh/book.pdo.php);\n\n​\t[bindParam](http://php.net/manual/zh/pdostatement.bindparam.php)方法的第一个参数对应insert语句中的对应顺序的值，如第一个bindParam方法对应第一个value值。\n\n​\tbindParam方法第二个参数为实际的值，传入变量或固定值，传入方法调用时如time()会提示：\n\nStrict standards: Only variables should be passed by reference in /www/get.php on line 24。","slug":"a-sample-redis-queue","published":1,"updated":"2016-05-15T06:25:08.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj830jvdb000gul0rf5wxwgto","content":"<p><img src=\"/images/redis/redis-300dpi.png\" alt=\"\"></p>\n<p>虽然RabbitMQ的坑年前就开始填了，但是并没有机会在项目中实际使用，机缘巧合，换工作后第一个比较重要的事就是做一个直播的页面，如果数据直接插入或读取自数据库，数据库端的压力就太大了，当时RabbitMQ还没看完，而其他的队列程序更是没有用过，只是稍微对Redis熟悉些，于是就使用了Redis做。</p>\n<p><a href=\"http://redis.io/\" target=\"_blank\" rel=\"external\">Redis</a>比较常见的是作为数据缓存工具使用，数据存储在内存中，减少了数据库的连接和查询，效率高，又方便。</p>\n<p>而其实Redis也可以用来做消息队列。</p>\n<h3 id=\"发送\"><a href=\"#发送\" class=\"headerlink\" title=\"发送\"></a>发送</h3><p>发送端首先当然是做好数据的接收和检测，比如为空的情况下给个默认值或返回错误。</p>\n<p>特殊的情况下可能还要正则处理。</p>\n<p>处理完插入到Redis的list(<a href=\"http://www.redis.cn/topics/data-types-intro.html#lists\" target=\"_blank\" rel=\"external\">列表</a>)中。如果插入失败抛出异常。</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\"></div><div class=\"line\">$redis = <span class=\"keyword\">new</span> Redis();</div><div class=\"line\">$redis-&gt;connect(<span class=\"string\">'127.0.0.1'</span>);</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">//如果redis需要认证</span></div><div class=\"line\">$redis-&gt;auth(<span class=\"string\">'redispasswd'</span>);</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">//命令行中使用，可以使用把信息作为参数的方式</span></div><div class=\"line\">$data = $argv[<span class=\"number\">1</span>];</div><div class=\"line\"><span class=\"keyword\">if</span>(<span class=\"keyword\">empty</span>($data)) $data = <span class=\"string\">\"Hello World..!\"</span>:</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">try</span>&#123;</div><div class=\"line\">\t<span class=\"comment\">//便于调试，在信息后边加上当前时间</span></div><div class=\"line\">\t$data .= <span class=\"string\">'-at-'</span>.date(<span class=\"string\">'Y-m-d H:i:s'</span>);</div><div class=\"line\">\t$redis-&gt;LPUSH(<span class=\"string\">'redis_queue_1'</span>,json_encode($data));</div><div class=\"line\">&#125;<span class=\"keyword\">catch</span>(<span class=\"keyword\">Exception</span> $e)&#123;</div><div class=\"line\">\t<span class=\"keyword\">echo</span> $e-&gt;getMessage().<span class=\"string\">\"\\n\"</span>;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h4 id=\"执行\"><a href=\"#执行\" class=\"headerlink\" title=\"执行\"></a>执行</h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">php push.php \"testinfo\"</div></pre></td></tr></table></figure>\n<h3 id=\"接收\"><a href=\"#接收\" class=\"headerlink\" title=\"接收\"></a>接收</h3><p>由于消息是源源不断发送到队列中，所以接收端程序一般会以后台进程的方式运行。</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\">$redis = <span class=\"keyword\">new</span> Redis();</div><div class=\"line\">$redis-&gt;connect(<span class=\"string\">'127.0.0.1'</span>);</div><div class=\"line\"></div><div class=\"line\">$redis-&gt;auth(<span class=\"string\">'redispasswd'</span>);</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">while</span> (<span class=\"keyword\">true</span>) &#123;</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"keyword\">try</span> &#123;</div><div class=\"line\">\t\t$data = $redis-&gt;rPopLPush(<span class=\"string\">'redis_queue_1'</span>,<span class=\"string\">'redis_queue_1_bak'</span>).<span class=\"string\">\"\\n\"</span>;</div><div class=\"line\">\t\t<span class=\"keyword\">if</span>($data)&#123;</div><div class=\"line\">\t\t\t<span class=\"keyword\">echo</span> $data;</div><div class=\"line\">\t\t&#125;<span class=\"keyword\">else</span>&#123;</div><div class=\"line\">\t\t\t<span class=\"keyword\">echo</span> <span class=\"string\">\"没有数据\\n\"</span>;</div><div class=\"line\">\t\t&#125;</div><div class=\"line\">\t&#125; <span class=\"keyword\">catch</span> (<span class=\"keyword\">Exception</span> $e) &#123;</div><div class=\"line\">\t\t<span class=\"keyword\">echo</span> $e-&gt;getMessage().<span class=\"string\">\"\\n\"</span>;</div><div class=\"line\">\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"comment\">//每秒读取1次</span></div><div class=\"line\">\tsleep(<span class=\"number\">1</span>);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h4 id=\"执行-1\"><a href=\"#执行-1\" class=\"headerlink\" title=\"执行\"></a>执行</h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">php get.php</div></pre></td></tr></table></figure>\n<h3 id=\"更进一步\"><a href=\"#更进一步\" class=\"headerlink\" title=\"更进一步\"></a>更进一步</h3><p>如果想把数据写入到MySQL中，该怎么办？</p>\n<p>大多数情况下数据最终是需要持久化的，仅仅存在于redis中，也许内存会不够呢。</p>\n<p>改造一下get.php。</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\">$redis = <span class=\"keyword\">new</span> Redis();</div><div class=\"line\">$redis-&gt;connect(<span class=\"string\">'127.0.0.1'</span>);</div><div class=\"line\"></div><div class=\"line\">$redis-&gt;auth(<span class=\"string\">'redispasswd'</span>);</div><div class=\"line\"></div><div class=\"line\">$dsn = <span class=\"string\">'mysql:dbname=test;host=127.0.0.1'</span>;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">try</span>&#123;</div><div class=\"line\">\t$pdo = <span class=\"keyword\">new</span> PDO($dsn,<span class=\"string\">'root'</span>,<span class=\"string\">'mysqlpasswd'</span>,<span class=\"keyword\">array</span>(PDO::MYSQL_ATTR_INIT_COMMAND =&gt; <span class=\"string\">'SET NAMES utf8'</span>));</div><div class=\"line\">&#125;<span class=\"keyword\">catch</span>(PDOExcetion $e)&#123;</div><div class=\"line\">\t<span class=\"keyword\">echo</span> $e-&gt;getMessage().<span class=\"string\">\"\\n\"</span>;</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">while</span>(<span class=\"keyword\">true</span>)&#123;</div><div class=\"line\">\t$data = $redis-&gt;rPopLPush(<span class=\"string\">'redis_queue_1'</span>,<span class=\"string\">'redis_queue_1_bak'</span>);</div><div class=\"line\">\t<span class=\"keyword\">if</span>($data)&#123;</div><div class=\"line\">\t\t$sth = $pdo-&gt;prepare(<span class=\"string\">\"INSERT INTO tb_test(msg,time) VALUES (:msg,:time)\"</span>);</div><div class=\"line\">\t\t</div><div class=\"line\">\t\t$time = time();</div><div class=\"line\">\t\t</div><div class=\"line\">\t\t$sth-&gt;bindParam(<span class=\"string\">':msg'</span>,$data,PDO::PARAM_STR);</div><div class=\"line\">\t\t$sth-&gt;bindParam(<span class=\"string\">':time'</span>,$time,PDO::PARAM_INT);</div><div class=\"line\">\t\t</div><div class=\"line\">\t\t$sth-&gt;execute();</div><div class=\"line\">\t\t$id = $pdo-&gt;lastInsertId();</div><div class=\"line\">      </div><div class=\"line\">\t\t<span class=\"keyword\">echo</span> <span class=\"string\">\"插入成功，ID=$id \\n\"</span>;</div><div class=\"line\">\t&#125;<span class=\"keyword\">else</span>&#123;</div><div class=\"line\">\t\t<span class=\"keyword\">echo</span> <span class=\"string\">\"没有数据 \\n\"</span>;</div><div class=\"line\">\t&#125;</div><div class=\"line\">\t</div><div class=\"line\">\t<span class=\"comment\">//实际任务中可能需要尽可能快的把数据导入到MySQL中</span></div><div class=\"line\">\tsleep(<span class=\"number\">1</span>);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h4 id=\"注意\"><a href=\"#注意\" class=\"headerlink\" title=\"注意\"></a>注意</h4><p>​    这里使用了<a href=\"http://php.net/manual/zh/book.pdo.php\" target=\"_blank\" rel=\"external\">PDO</a>;</p>\n<p>​    <a href=\"http://php.net/manual/zh/pdostatement.bindparam.php\" target=\"_blank\" rel=\"external\">bindParam</a>方法的第一个参数对应insert语句中的对应顺序的值，如第一个bindParam方法对应第一个value值。</p>\n<p>​    bindParam方法第二个参数为实际的值，传入变量或固定值，传入方法调用时如time()会提示：</p>\n<p>Strict standards: Only variables should be passed by reference in /www/get.php on line 24。</p>\n","site":{"data":{}},"excerpt":"","more":"<p><img src=\"/images/redis/redis-300dpi.png\" alt=\"\"></p>\n<p>虽然RabbitMQ的坑年前就开始填了，但是并没有机会在项目中实际使用，机缘巧合，换工作后第一个比较重要的事就是做一个直播的页面，如果数据直接插入或读取自数据库，数据库端的压力就太大了，当时RabbitMQ还没看完，而其他的队列程序更是没有用过，只是稍微对Redis熟悉些，于是就使用了Redis做。</p>\n<p><a href=\"http://redis.io/\" target=\"_blank\" rel=\"external\">Redis</a>比较常见的是作为数据缓存工具使用，数据存储在内存中，减少了数据库的连接和查询，效率高，又方便。</p>\n<p>而其实Redis也可以用来做消息队列。</p>\n<h3 id=\"发送\"><a href=\"#发送\" class=\"headerlink\" title=\"发送\"></a>发送</h3><p>发送端首先当然是做好数据的接收和检测，比如为空的情况下给个默认值或返回错误。</p>\n<p>特殊的情况下可能还要正则处理。</p>\n<p>处理完插入到Redis的list(<a href=\"http://www.redis.cn/topics/data-types-intro.html#lists\" target=\"_blank\" rel=\"external\">列表</a>)中。如果插入失败抛出异常。</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\"></div><div class=\"line\">$redis = <span class=\"keyword\">new</span> Redis();</div><div class=\"line\">$redis-&gt;connect(<span class=\"string\">'127.0.0.1'</span>);</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">//如果redis需要认证</span></div><div class=\"line\">$redis-&gt;auth(<span class=\"string\">'redispasswd'</span>);</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">//命令行中使用，可以使用把信息作为参数的方式</span></div><div class=\"line\">$data = $argv[<span class=\"number\">1</span>];</div><div class=\"line\"><span class=\"keyword\">if</span>(<span class=\"keyword\">empty</span>($data)) $data = <span class=\"string\">\"Hello World..!\"</span>:</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">try</span>&#123;</div><div class=\"line\">\t<span class=\"comment\">//便于调试，在信息后边加上当前时间</span></div><div class=\"line\">\t$data .= <span class=\"string\">'-at-'</span>.date(<span class=\"string\">'Y-m-d H:i:s'</span>);</div><div class=\"line\">\t$redis-&gt;LPUSH(<span class=\"string\">'redis_queue_1'</span>,json_encode($data));</div><div class=\"line\">&#125;<span class=\"keyword\">catch</span>(<span class=\"keyword\">Exception</span> $e)&#123;</div><div class=\"line\">\t<span class=\"keyword\">echo</span> $e-&gt;getMessage().<span class=\"string\">\"\\n\"</span>;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h4 id=\"执行\"><a href=\"#执行\" class=\"headerlink\" title=\"执行\"></a>执行</h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">php push.php \"testinfo\"</div></pre></td></tr></table></figure>\n<h3 id=\"接收\"><a href=\"#接收\" class=\"headerlink\" title=\"接收\"></a>接收</h3><p>由于消息是源源不断发送到队列中，所以接收端程序一般会以后台进程的方式运行。</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\">$redis = <span class=\"keyword\">new</span> Redis();</div><div class=\"line\">$redis-&gt;connect(<span class=\"string\">'127.0.0.1'</span>);</div><div class=\"line\"></div><div class=\"line\">$redis-&gt;auth(<span class=\"string\">'redispasswd'</span>);</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">while</span> (<span class=\"keyword\">true</span>) &#123;</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"keyword\">try</span> &#123;</div><div class=\"line\">\t\t$data = $redis-&gt;rPopLPush(<span class=\"string\">'redis_queue_1'</span>,<span class=\"string\">'redis_queue_1_bak'</span>).<span class=\"string\">\"\\n\"</span>;</div><div class=\"line\">\t\t<span class=\"keyword\">if</span>($data)&#123;</div><div class=\"line\">\t\t\t<span class=\"keyword\">echo</span> $data;</div><div class=\"line\">\t\t&#125;<span class=\"keyword\">else</span>&#123;</div><div class=\"line\">\t\t\t<span class=\"keyword\">echo</span> <span class=\"string\">\"没有数据\\n\"</span>;</div><div class=\"line\">\t\t&#125;</div><div class=\"line\">\t&#125; <span class=\"keyword\">catch</span> (<span class=\"keyword\">Exception</span> $e) &#123;</div><div class=\"line\">\t\t<span class=\"keyword\">echo</span> $e-&gt;getMessage().<span class=\"string\">\"\\n\"</span>;</div><div class=\"line\">\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"comment\">//每秒读取1次</span></div><div class=\"line\">\tsleep(<span class=\"number\">1</span>);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h4 id=\"执行-1\"><a href=\"#执行-1\" class=\"headerlink\" title=\"执行\"></a>执行</h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">php get.php</div></pre></td></tr></table></figure>\n<h3 id=\"更进一步\"><a href=\"#更进一步\" class=\"headerlink\" title=\"更进一步\"></a>更进一步</h3><p>如果想把数据写入到MySQL中，该怎么办？</p>\n<p>大多数情况下数据最终是需要持久化的，仅仅存在于redis中，也许内存会不够呢。</p>\n<p>改造一下get.php。</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\">$redis = <span class=\"keyword\">new</span> Redis();</div><div class=\"line\">$redis-&gt;connect(<span class=\"string\">'127.0.0.1'</span>);</div><div class=\"line\"></div><div class=\"line\">$redis-&gt;auth(<span class=\"string\">'redispasswd'</span>);</div><div class=\"line\"></div><div class=\"line\">$dsn = <span class=\"string\">'mysql:dbname=test;host=127.0.0.1'</span>;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">try</span>&#123;</div><div class=\"line\">\t$pdo = <span class=\"keyword\">new</span> PDO($dsn,<span class=\"string\">'root'</span>,<span class=\"string\">'mysqlpasswd'</span>,<span class=\"keyword\">array</span>(PDO::MYSQL_ATTR_INIT_COMMAND =&gt; <span class=\"string\">'SET NAMES utf8'</span>));</div><div class=\"line\">&#125;<span class=\"keyword\">catch</span>(PDOExcetion $e)&#123;</div><div class=\"line\">\t<span class=\"keyword\">echo</span> $e-&gt;getMessage().<span class=\"string\">\"\\n\"</span>;</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">while</span>(<span class=\"keyword\">true</span>)&#123;</div><div class=\"line\">\t$data = $redis-&gt;rPopLPush(<span class=\"string\">'redis_queue_1'</span>,<span class=\"string\">'redis_queue_1_bak'</span>);</div><div class=\"line\">\t<span class=\"keyword\">if</span>($data)&#123;</div><div class=\"line\">\t\t$sth = $pdo-&gt;prepare(<span class=\"string\">\"INSERT INTO tb_test(msg,time) VALUES (:msg,:time)\"</span>);</div><div class=\"line\">\t\t</div><div class=\"line\">\t\t$time = time();</div><div class=\"line\">\t\t</div><div class=\"line\">\t\t$sth-&gt;bindParam(<span class=\"string\">':msg'</span>,$data,PDO::PARAM_STR);</div><div class=\"line\">\t\t$sth-&gt;bindParam(<span class=\"string\">':time'</span>,$time,PDO::PARAM_INT);</div><div class=\"line\">\t\t</div><div class=\"line\">\t\t$sth-&gt;execute();</div><div class=\"line\">\t\t$id = $pdo-&gt;lastInsertId();</div><div class=\"line\">      </div><div class=\"line\">\t\t<span class=\"keyword\">echo</span> <span class=\"string\">\"插入成功，ID=$id \\n\"</span>;</div><div class=\"line\">\t&#125;<span class=\"keyword\">else</span>&#123;</div><div class=\"line\">\t\t<span class=\"keyword\">echo</span> <span class=\"string\">\"没有数据 \\n\"</span>;</div><div class=\"line\">\t&#125;</div><div class=\"line\">\t</div><div class=\"line\">\t<span class=\"comment\">//实际任务中可能需要尽可能快的把数据导入到MySQL中</span></div><div class=\"line\">\tsleep(<span class=\"number\">1</span>);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h4 id=\"注意\"><a href=\"#注意\" class=\"headerlink\" title=\"注意\"></a>注意</h4><p>​    这里使用了<a href=\"http://php.net/manual/zh/book.pdo.php\" target=\"_blank\" rel=\"external\">PDO</a>;</p>\n<p>​    <a href=\"http://php.net/manual/zh/pdostatement.bindparam.php\" target=\"_blank\" rel=\"external\">bindParam</a>方法的第一个参数对应insert语句中的对应顺序的值，如第一个bindParam方法对应第一个value值。</p>\n<p>​    bindParam方法第二个参数为实际的值，传入变量或固定值，传入方法调用时如time()会提示：</p>\n<p>Strict standards: Only variables should be passed by reference in /www/get.php on line 24。</p>\n"},{"title":"crontab实现定时备份数据库","date":"2016-01-10T10:52:55.000Z","_content":"\n![](/images/backup-database-with-crontab/crontab.jpg)\n\ncrontab命令之前写过了，在[Linux crontab 访问PHP URL完成定时任务](http://segmentfault.com/a/1190000003953826)，今天写了一个用来备份数据库的脚本。\n\n主要会用到以下几个命令：\n\n#### mysqldump\n\n参考文章：[mysqldump导入导出数据库总结 ](http://blog.csdn.net/shellching/article/details/8129687)\n\n\n#### 创建.sh文件：\n\n```\ncd ~\nvi backup.sh\n```\nbackup.sh内主要内容如下：\n\n```\nmysqldump -hlocalhost -uroot -p'root' --databases database1 | gzip > /var/backups/databases-database1`date +'%Y%m%d_%H%M%S'`.sql.gz\n```\n\n首先用mysqldump命令\n\n```\n\t1.连接数据库\n\t2.选择要备份数据库\n\t3.选择存储备份文件的方式，这里使用了gzip了生成一个压缩包\n```\n\n根据文档，如果想备份所有数据库，可以使用\n\n```\nmysqldump -hlocalhost -uroot -p'root' --all-databases | gzip > /var/backups/databases-all-database`date +'%Y%m%d_%H%M%S'`.sql.gz\n```\n保存。\n\n有备份，就会有备份后的处理，显而易见的问题是备份多了会比较占空间，并且也用不到那么多备份。所以备份完成删除掉一段时间以前的就可以了。这步也可以在备份前做，无所谓。\n\n这里又用到了find命令\n\n参考文章：[Linux中find常见用法示例](http://www.cnblogs.com/wanqieddy/archive/2011/06/09/2076785.html)\n\n#### 删除之前的备份文件\n\n在刚才的backup.sh中继续输入：\n\n```\ncd /var/backups/\nrm -rf `find . -name '*.sql.gz' -mtime +10`\n\n```\n\n这句命令有两部分，\n\n第一部分是删除命令：'rm -rf'。就是那句一定要慎用的命令了.\n\n第二部分是找到：当前目录，名字以'.sql.gz'结尾的，更改时间在10天以前的文件。\n\n'.'表示当前目录，由于上一句是'cd /var/backups/'，所以这里使用当前目录即可。\n\n'-name '和'-mtime'参数是find命令的条件。\n\n具体的说明，和其他条件可以参考前边说到的文章。\n\n到这里基本上备份脚本就完成了。\n\n但是为了什么时候突然想看一下日志，或者备份出错的时候查问题，还可以在脚本里加上记录日志的命令：\n\n#### 日志\n\n```\necho 'Begin Backup Database At :' `date +'%Y-%m-%d %H:%M:%S'`\n```\n\n这里又用到了date。\n\n参考文章：[Linux下date命令，格式化输出，时间设置 ](http://blog.csdn.net/jk110333/article/details/8590746/)\n\n脚本保存之后，记得添加执行权限；\n\n```\nsudo chmod +x backup.sh\n```\n\n接下来就是在系统里添加crontab任务了。\n\n```\ncd /etc/\nvi crontab\n\n```\n\n在文件末尾，加上\n\n```\nm  h dom mon dow user\tcommand\n00 5 * * * root /home/yourname/backup.sh >> /var/log/backup.log\n```\n\n这样，backup.sh里的echo就会输出到/var/log/backup.log中了。\n\nOver。\n\n\n","source":"_posts/backup-database-with-crontab.md","raw":"title: crontab实现定时备份数据库\ncategories: linux\ndate: 2016-01-10 18:52:55\ntags:  [crontab,mysql,linux]\n\n---\n\n![](/images/backup-database-with-crontab/crontab.jpg)\n\ncrontab命令之前写过了，在[Linux crontab 访问PHP URL完成定时任务](http://segmentfault.com/a/1190000003953826)，今天写了一个用来备份数据库的脚本。\n\n主要会用到以下几个命令：\n\n#### mysqldump\n\n参考文章：[mysqldump导入导出数据库总结 ](http://blog.csdn.net/shellching/article/details/8129687)\n\n\n#### 创建.sh文件：\n\n```\ncd ~\nvi backup.sh\n```\nbackup.sh内主要内容如下：\n\n```\nmysqldump -hlocalhost -uroot -p'root' --databases database1 | gzip > /var/backups/databases-database1`date +'%Y%m%d_%H%M%S'`.sql.gz\n```\n\n首先用mysqldump命令\n\n```\n\t1.连接数据库\n\t2.选择要备份数据库\n\t3.选择存储备份文件的方式，这里使用了gzip了生成一个压缩包\n```\n\n根据文档，如果想备份所有数据库，可以使用\n\n```\nmysqldump -hlocalhost -uroot -p'root' --all-databases | gzip > /var/backups/databases-all-database`date +'%Y%m%d_%H%M%S'`.sql.gz\n```\n保存。\n\n有备份，就会有备份后的处理，显而易见的问题是备份多了会比较占空间，并且也用不到那么多备份。所以备份完成删除掉一段时间以前的就可以了。这步也可以在备份前做，无所谓。\n\n这里又用到了find命令\n\n参考文章：[Linux中find常见用法示例](http://www.cnblogs.com/wanqieddy/archive/2011/06/09/2076785.html)\n\n#### 删除之前的备份文件\n\n在刚才的backup.sh中继续输入：\n\n```\ncd /var/backups/\nrm -rf `find . -name '*.sql.gz' -mtime +10`\n\n```\n\n这句命令有两部分，\n\n第一部分是删除命令：'rm -rf'。就是那句一定要慎用的命令了.\n\n第二部分是找到：当前目录，名字以'.sql.gz'结尾的，更改时间在10天以前的文件。\n\n'.'表示当前目录，由于上一句是'cd /var/backups/'，所以这里使用当前目录即可。\n\n'-name '和'-mtime'参数是find命令的条件。\n\n具体的说明，和其他条件可以参考前边说到的文章。\n\n到这里基本上备份脚本就完成了。\n\n但是为了什么时候突然想看一下日志，或者备份出错的时候查问题，还可以在脚本里加上记录日志的命令：\n\n#### 日志\n\n```\necho 'Begin Backup Database At :' `date +'%Y-%m-%d %H:%M:%S'`\n```\n\n这里又用到了date。\n\n参考文章：[Linux下date命令，格式化输出，时间设置 ](http://blog.csdn.net/jk110333/article/details/8590746/)\n\n脚本保存之后，记得添加执行权限；\n\n```\nsudo chmod +x backup.sh\n```\n\n接下来就是在系统里添加crontab任务了。\n\n```\ncd /etc/\nvi crontab\n\n```\n\n在文件末尾，加上\n\n```\nm  h dom mon dow user\tcommand\n00 5 * * * root /home/yourname/backup.sh >> /var/log/backup.log\n```\n\n这样，backup.sh里的echo就会输出到/var/log/backup.log中了。\n\nOver。\n\n\n","slug":"backup-database-with-crontab","published":1,"updated":"2016-04-23T12:07:24.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj830jvdd000hul0r4a3lu9px","content":"<p><img src=\"/images/backup-database-with-crontab/crontab.jpg\" alt=\"\"></p>\n<p>crontab命令之前写过了，在<a href=\"http://segmentfault.com/a/1190000003953826\" target=\"_blank\" rel=\"external\">Linux crontab 访问PHP URL完成定时任务</a>，今天写了一个用来备份数据库的脚本。</p>\n<p>主要会用到以下几个命令：</p>\n<h4 id=\"mysqldump\"><a href=\"#mysqldump\" class=\"headerlink\" title=\"mysqldump\"></a>mysqldump</h4><p>参考文章：<a href=\"http://blog.csdn.net/shellching/article/details/8129687\" target=\"_blank\" rel=\"external\">mysqldump导入导出数据库总结 </a></p>\n<h4 id=\"创建-sh文件：\"><a href=\"#创建-sh文件：\" class=\"headerlink\" title=\"创建.sh文件：\"></a>创建.sh文件：</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">cd ~</div><div class=\"line\">vi backup.sh</div></pre></td></tr></table></figure>\n<p>backup.sh内主要内容如下：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">mysqldump -hlocalhost -uroot -p&apos;root&apos; --databases database1 | gzip &gt; /var/backups/databases-database1`date +&apos;%Y%m%d_%H%M%S&apos;`.sql.gz</div></pre></td></tr></table></figure>\n<p>首先用mysqldump命令</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">1.连接数据库</div><div class=\"line\">2.选择要备份数据库</div><div class=\"line\">3.选择存储备份文件的方式，这里使用了gzip了生成一个压缩包</div></pre></td></tr></table></figure>\n<p>根据文档，如果想备份所有数据库，可以使用</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">mysqldump -hlocalhost -uroot -p&apos;root&apos; --all-databases | gzip &gt; /var/backups/databases-all-database`date +&apos;%Y%m%d_%H%M%S&apos;`.sql.gz</div></pre></td></tr></table></figure>\n<p>保存。</p>\n<p>有备份，就会有备份后的处理，显而易见的问题是备份多了会比较占空间，并且也用不到那么多备份。所以备份完成删除掉一段时间以前的就可以了。这步也可以在备份前做，无所谓。</p>\n<p>这里又用到了find命令</p>\n<p>参考文章：<a href=\"http://www.cnblogs.com/wanqieddy/archive/2011/06/09/2076785.html\" target=\"_blank\" rel=\"external\">Linux中find常见用法示例</a></p>\n<h4 id=\"删除之前的备份文件\"><a href=\"#删除之前的备份文件\" class=\"headerlink\" title=\"删除之前的备份文件\"></a>删除之前的备份文件</h4><p>在刚才的backup.sh中继续输入：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">cd /var/backups/</div><div class=\"line\">rm -rf `find . -name &apos;*.sql.gz&apos; -mtime +10`</div></pre></td></tr></table></figure>\n<p>这句命令有两部分，</p>\n<p>第一部分是删除命令：’rm -rf’。就是那句一定要慎用的命令了.</p>\n<p>第二部分是找到：当前目录，名字以’.sql.gz’结尾的，更改时间在10天以前的文件。</p>\n<p>‘.’表示当前目录，由于上一句是’cd /var/backups/‘，所以这里使用当前目录即可。</p>\n<p>‘-name ‘和’-mtime’参数是find命令的条件。</p>\n<p>具体的说明，和其他条件可以参考前边说到的文章。</p>\n<p>到这里基本上备份脚本就完成了。</p>\n<p>但是为了什么时候突然想看一下日志，或者备份出错的时候查问题，还可以在脚本里加上记录日志的命令：</p>\n<h4 id=\"日志\"><a href=\"#日志\" class=\"headerlink\" title=\"日志\"></a>日志</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">echo &apos;Begin Backup Database At :&apos; `date +&apos;%Y-%m-%d %H:%M:%S&apos;`</div></pre></td></tr></table></figure>\n<p>这里又用到了date。</p>\n<p>参考文章：<a href=\"http://blog.csdn.net/jk110333/article/details/8590746/\" target=\"_blank\" rel=\"external\">Linux下date命令，格式化输出，时间设置 </a></p>\n<p>脚本保存之后，记得添加执行权限；</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">sudo chmod +x backup.sh</div></pre></td></tr></table></figure>\n<p>接下来就是在系统里添加crontab任务了。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">cd /etc/</div><div class=\"line\">vi crontab</div></pre></td></tr></table></figure>\n<p>在文件末尾，加上</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">m  h dom mon dow user\tcommand</div><div class=\"line\">00 5 * * * root /home/yourname/backup.sh &gt;&gt; /var/log/backup.log</div></pre></td></tr></table></figure>\n<p>这样，backup.sh里的echo就会输出到/var/log/backup.log中了。</p>\n<p>Over。</p>\n","site":{"data":{}},"excerpt":"","more":"<p><img src=\"/images/backup-database-with-crontab/crontab.jpg\" alt=\"\"></p>\n<p>crontab命令之前写过了，在<a href=\"http://segmentfault.com/a/1190000003953826\" target=\"_blank\" rel=\"external\">Linux crontab 访问PHP URL完成定时任务</a>，今天写了一个用来备份数据库的脚本。</p>\n<p>主要会用到以下几个命令：</p>\n<h4 id=\"mysqldump\"><a href=\"#mysqldump\" class=\"headerlink\" title=\"mysqldump\"></a>mysqldump</h4><p>参考文章：<a href=\"http://blog.csdn.net/shellching/article/details/8129687\" target=\"_blank\" rel=\"external\">mysqldump导入导出数据库总结 </a></p>\n<h4 id=\"创建-sh文件：\"><a href=\"#创建-sh文件：\" class=\"headerlink\" title=\"创建.sh文件：\"></a>创建.sh文件：</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">cd ~</div><div class=\"line\">vi backup.sh</div></pre></td></tr></table></figure>\n<p>backup.sh内主要内容如下：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">mysqldump -hlocalhost -uroot -p&apos;root&apos; --databases database1 | gzip &gt; /var/backups/databases-database1`date +&apos;%Y%m%d_%H%M%S&apos;`.sql.gz</div></pre></td></tr></table></figure>\n<p>首先用mysqldump命令</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">1.连接数据库</div><div class=\"line\">2.选择要备份数据库</div><div class=\"line\">3.选择存储备份文件的方式，这里使用了gzip了生成一个压缩包</div></pre></td></tr></table></figure>\n<p>根据文档，如果想备份所有数据库，可以使用</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">mysqldump -hlocalhost -uroot -p&apos;root&apos; --all-databases | gzip &gt; /var/backups/databases-all-database`date +&apos;%Y%m%d_%H%M%S&apos;`.sql.gz</div></pre></td></tr></table></figure>\n<p>保存。</p>\n<p>有备份，就会有备份后的处理，显而易见的问题是备份多了会比较占空间，并且也用不到那么多备份。所以备份完成删除掉一段时间以前的就可以了。这步也可以在备份前做，无所谓。</p>\n<p>这里又用到了find命令</p>\n<p>参考文章：<a href=\"http://www.cnblogs.com/wanqieddy/archive/2011/06/09/2076785.html\" target=\"_blank\" rel=\"external\">Linux中find常见用法示例</a></p>\n<h4 id=\"删除之前的备份文件\"><a href=\"#删除之前的备份文件\" class=\"headerlink\" title=\"删除之前的备份文件\"></a>删除之前的备份文件</h4><p>在刚才的backup.sh中继续输入：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">cd /var/backups/</div><div class=\"line\">rm -rf `find . -name &apos;*.sql.gz&apos; -mtime +10`</div></pre></td></tr></table></figure>\n<p>这句命令有两部分，</p>\n<p>第一部分是删除命令：’rm -rf’。就是那句一定要慎用的命令了.</p>\n<p>第二部分是找到：当前目录，名字以’.sql.gz’结尾的，更改时间在10天以前的文件。</p>\n<p>‘.’表示当前目录，由于上一句是’cd /var/backups/‘，所以这里使用当前目录即可。</p>\n<p>‘-name ‘和’-mtime’参数是find命令的条件。</p>\n<p>具体的说明，和其他条件可以参考前边说到的文章。</p>\n<p>到这里基本上备份脚本就完成了。</p>\n<p>但是为了什么时候突然想看一下日志，或者备份出错的时候查问题，还可以在脚本里加上记录日志的命令：</p>\n<h4 id=\"日志\"><a href=\"#日志\" class=\"headerlink\" title=\"日志\"></a>日志</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">echo &apos;Begin Backup Database At :&apos; `date +&apos;%Y-%m-%d %H:%M:%S&apos;`</div></pre></td></tr></table></figure>\n<p>这里又用到了date。</p>\n<p>参考文章：<a href=\"http://blog.csdn.net/jk110333/article/details/8590746/\" target=\"_blank\" rel=\"external\">Linux下date命令，格式化输出，时间设置 </a></p>\n<p>脚本保存之后，记得添加执行权限；</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">sudo chmod +x backup.sh</div></pre></td></tr></table></figure>\n<p>接下来就是在系统里添加crontab任务了。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">cd /etc/</div><div class=\"line\">vi crontab</div></pre></td></tr></table></figure>\n<p>在文件末尾，加上</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">m  h dom mon dow user\tcommand</div><div class=\"line\">00 5 * * * root /home/yourname/backup.sh &gt;&gt; /var/log/backup.log</div></pre></td></tr></table></figure>\n<p>这样，backup.sh里的echo就会输出到/var/log/backup.log中了。</p>\n<p>Over。</p>\n"},{"title":"用Docker部署Golang Beego框架应用","date":"2016-10-21T02:02:02.000Z","_content":"\nDocker是什么就不说了。\nGolang是什么也不说了。\nBeego是什么就更不用说了。\n\n最近Beego项目完成，研究怎么部署。因为Docker部署起来更简单更快速，所以就说下怎么在docker里部署beego应用。\n\n#### 写在前面\n\n假设你的应用路径为 /go/app；\n假设已配置好docker的相关东西。\n假设使用 [godep](https://github.com/tools/godep) 作为依赖管理工具\n示例中开放端口为80，需要与app.conf中的端口一致，可以自行修改。\n\n#### 配置\n\n在 /go/app 目录新建Dockerfile。\n\n```\nFROM golang:1.7.1-alpine\n\nMAINTAINER youremail <youremail@xxx.com>\n\nRUN apk add --update go git\n\nADD ./ /go/src/app\n\nRUN cd /go/src/app \\\n\t&& go get github.com/astaxie/beego \\\n\t&& go get github.com/tools/godep \\\n\t&& godep update -goversion \\\n\t&& godep get \\\n\t&& godep save \\\n\t&& go build\n\nEXPOSE 80\n\nEXTRYPOINT /go/src/app/app\n```\n\n本例使用 golang:1.7.1-alpine 作为基础镜像。golang的所有镜像见[这里](https://hub.docker.com/_/golang/)。\n\n#### 构建\n```\ndocker build -t app .\n```\n\n#### 运行 \n\n```\ndocker run -d -p 8080:80 app\n```\n\n#### 访问\n\n使用nginx反向代理访问docker中的go应用。\n\n```\nserver {\n    listen       80;\n    server_name  app.com;\n\n    charset utf-8;\n    access_log  logs/app.access.log;\n\n    location / {\n        try_files /_not_exists_ @backend;\n    }\n    if (!-e $request_filename) {\n        return 404;\n    }\n\n    location @backend {\n        proxy_set_header X-Forwarded-For $remote_addr;\n        proxy_set_header Host            $http_host;\n\n        proxy_pass http://192.168.99.100:8080; // 192.168.99.100为docker machine的ip,8080为 docker run 时指定的本地端口。\n    }\n}\n```\n\n#### 相关资料\n\n[如何使用Docker快速部署go-web应用程序](https://yq.aliyun.com/articles/57247)\n[Deploying Go servers with Docker](https://blog.golang.org/docker)\n[如何使用Docker部署Go Web应用程序](http://www.infoq.com/cn/articles/how-to-deploy-a-go-web-application-with-docker?utm_source=infoq&utm_medium=related_content_link&utm_campaign=relatedContent_articles_clk)\n[The Easiest Way to Develop with Go — Introducing a Docker Based Go Tool](https://www.iron.io/the-easiest-way-to-develop-with-go%E2%80%8A-%E2%80%8Aintroducing-a-docker-based-go-tool/)\n[How To Deploy a Go Web Application with Docker](https://semaphoreci.com/community/tutorials/how-to-deploy-a-go-web-application-with-docker)\n[nginx 部署](https://beego.me/docs/deploy/nginx.md)","source":"_posts/beego-in-docker.md","raw":"title: 用Docker部署Golang Beego框架应用\ncategories: golang\ndate: 2016-10-21 10:02:02\ntags: [go]\n\n---\n\nDocker是什么就不说了。\nGolang是什么也不说了。\nBeego是什么就更不用说了。\n\n最近Beego项目完成，研究怎么部署。因为Docker部署起来更简单更快速，所以就说下怎么在docker里部署beego应用。\n\n#### 写在前面\n\n假设你的应用路径为 /go/app；\n假设已配置好docker的相关东西。\n假设使用 [godep](https://github.com/tools/godep) 作为依赖管理工具\n示例中开放端口为80，需要与app.conf中的端口一致，可以自行修改。\n\n#### 配置\n\n在 /go/app 目录新建Dockerfile。\n\n```\nFROM golang:1.7.1-alpine\n\nMAINTAINER youremail <youremail@xxx.com>\n\nRUN apk add --update go git\n\nADD ./ /go/src/app\n\nRUN cd /go/src/app \\\n\t&& go get github.com/astaxie/beego \\\n\t&& go get github.com/tools/godep \\\n\t&& godep update -goversion \\\n\t&& godep get \\\n\t&& godep save \\\n\t&& go build\n\nEXPOSE 80\n\nEXTRYPOINT /go/src/app/app\n```\n\n本例使用 golang:1.7.1-alpine 作为基础镜像。golang的所有镜像见[这里](https://hub.docker.com/_/golang/)。\n\n#### 构建\n```\ndocker build -t app .\n```\n\n#### 运行 \n\n```\ndocker run -d -p 8080:80 app\n```\n\n#### 访问\n\n使用nginx反向代理访问docker中的go应用。\n\n```\nserver {\n    listen       80;\n    server_name  app.com;\n\n    charset utf-8;\n    access_log  logs/app.access.log;\n\n    location / {\n        try_files /_not_exists_ @backend;\n    }\n    if (!-e $request_filename) {\n        return 404;\n    }\n\n    location @backend {\n        proxy_set_header X-Forwarded-For $remote_addr;\n        proxy_set_header Host            $http_host;\n\n        proxy_pass http://192.168.99.100:8080; // 192.168.99.100为docker machine的ip,8080为 docker run 时指定的本地端口。\n    }\n}\n```\n\n#### 相关资料\n\n[如何使用Docker快速部署go-web应用程序](https://yq.aliyun.com/articles/57247)\n[Deploying Go servers with Docker](https://blog.golang.org/docker)\n[如何使用Docker部署Go Web应用程序](http://www.infoq.com/cn/articles/how-to-deploy-a-go-web-application-with-docker?utm_source=infoq&utm_medium=related_content_link&utm_campaign=relatedContent_articles_clk)\n[The Easiest Way to Develop with Go — Introducing a Docker Based Go Tool](https://www.iron.io/the-easiest-way-to-develop-with-go%E2%80%8A-%E2%80%8Aintroducing-a-docker-based-go-tool/)\n[How To Deploy a Go Web Application with Docker](https://semaphoreci.com/community/tutorials/how-to-deploy-a-go-web-application-with-docker)\n[nginx 部署](https://beego.me/docs/deploy/nginx.md)","slug":"beego-in-docker","published":1,"updated":"2016-10-30T02:49:27.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj830jvdf000lul0r21zmixge","content":"<p>Docker是什么就不说了。<br>Golang是什么也不说了。<br>Beego是什么就更不用说了。</p>\n<p>最近Beego项目完成，研究怎么部署。因为Docker部署起来更简单更快速，所以就说下怎么在docker里部署beego应用。</p>\n<h4 id=\"写在前面\"><a href=\"#写在前面\" class=\"headerlink\" title=\"写在前面\"></a>写在前面</h4><p>假设你的应用路径为 /go/app；<br>假设已配置好docker的相关东西。<br>假设使用 <a href=\"https://github.com/tools/godep\" target=\"_blank\" rel=\"external\">godep</a> 作为依赖管理工具<br>示例中开放端口为80，需要与app.conf中的端口一致，可以自行修改。</p>\n<h4 id=\"配置\"><a href=\"#配置\" class=\"headerlink\" title=\"配置\"></a>配置</h4><p>在 /go/app 目录新建Dockerfile。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div></pre></td><td class=\"code\"><pre><div class=\"line\">FROM golang:1.7.1-alpine</div><div class=\"line\"></div><div class=\"line\">MAINTAINER youremail &lt;youremail@xxx.com&gt;</div><div class=\"line\"></div><div class=\"line\">RUN apk add --update go git</div><div class=\"line\"></div><div class=\"line\">ADD ./ /go/src/app</div><div class=\"line\"></div><div class=\"line\">RUN cd /go/src/app \\</div><div class=\"line\">\t&amp;&amp; go get github.com/astaxie/beego \\</div><div class=\"line\">\t&amp;&amp; go get github.com/tools/godep \\</div><div class=\"line\">\t&amp;&amp; godep update -goversion \\</div><div class=\"line\">\t&amp;&amp; godep get \\</div><div class=\"line\">\t&amp;&amp; godep save \\</div><div class=\"line\">\t&amp;&amp; go build</div><div class=\"line\"></div><div class=\"line\">EXPOSE 80</div><div class=\"line\"></div><div class=\"line\">EXTRYPOINT /go/src/app/app</div></pre></td></tr></table></figure>\n<p>本例使用 golang:1.7.1-alpine 作为基础镜像。golang的所有镜像见<a href=\"https://hub.docker.com/_/golang/\" target=\"_blank\" rel=\"external\">这里</a>。</p>\n<h4 id=\"构建\"><a href=\"#构建\" class=\"headerlink\" title=\"构建\"></a>构建</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">docker build -t app .</div></pre></td></tr></table></figure>\n<h4 id=\"运行\"><a href=\"#运行\" class=\"headerlink\" title=\"运行\"></a>运行</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">docker run -d -p 8080:80 app</div></pre></td></tr></table></figure>\n<h4 id=\"访问\"><a href=\"#访问\" class=\"headerlink\" title=\"访问\"></a>访问</h4><p>使用nginx反向代理访问docker中的go应用。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div></pre></td><td class=\"code\"><pre><div class=\"line\">server &#123;</div><div class=\"line\">    listen       80;</div><div class=\"line\">    server_name  app.com;</div><div class=\"line\"></div><div class=\"line\">    charset utf-8;</div><div class=\"line\">    access_log  logs/app.access.log;</div><div class=\"line\"></div><div class=\"line\">    location / &#123;</div><div class=\"line\">        try_files /_not_exists_ @backend;</div><div class=\"line\">    &#125;</div><div class=\"line\">    if (!-e $request_filename) &#123;</div><div class=\"line\">        return 404;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    location @backend &#123;</div><div class=\"line\">        proxy_set_header X-Forwarded-For $remote_addr;</div><div class=\"line\">        proxy_set_header Host            $http_host;</div><div class=\"line\"></div><div class=\"line\">        proxy_pass http://192.168.99.100:8080; // 192.168.99.100为docker machine的ip,8080为 docker run 时指定的本地端口。</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h4 id=\"相关资料\"><a href=\"#相关资料\" class=\"headerlink\" title=\"相关资料\"></a>相关资料</h4><p><a href=\"https://yq.aliyun.com/articles/57247\" target=\"_blank\" rel=\"external\">如何使用Docker快速部署go-web应用程序</a><br><a href=\"https://blog.golang.org/docker\" target=\"_blank\" rel=\"external\">Deploying Go servers with Docker</a><br><a href=\"http://www.infoq.com/cn/articles/how-to-deploy-a-go-web-application-with-docker?utm_source=infoq&amp;utm_medium=related_content_link&amp;utm_campaign=relatedContent_articles_clk\" target=\"_blank\" rel=\"external\">如何使用Docker部署Go Web应用程序</a><br><a href=\"https://www.iron.io/the-easiest-way-to-develop-with-go%E2%80%8A-%E2%80%8Aintroducing-a-docker-based-go-tool/\" target=\"_blank\" rel=\"external\">The Easiest Way to Develop with Go — Introducing a Docker Based Go Tool</a><br><a href=\"https://semaphoreci.com/community/tutorials/how-to-deploy-a-go-web-application-with-docker\" target=\"_blank\" rel=\"external\">How To Deploy a Go Web Application with Docker</a><br><a href=\"https://beego.me/docs/deploy/nginx.md\" target=\"_blank\" rel=\"external\">nginx 部署</a></p>\n","site":{"data":{}},"excerpt":"","more":"<p>Docker是什么就不说了。<br>Golang是什么也不说了。<br>Beego是什么就更不用说了。</p>\n<p>最近Beego项目完成，研究怎么部署。因为Docker部署起来更简单更快速，所以就说下怎么在docker里部署beego应用。</p>\n<h4 id=\"写在前面\"><a href=\"#写在前面\" class=\"headerlink\" title=\"写在前面\"></a>写在前面</h4><p>假设你的应用路径为 /go/app；<br>假设已配置好docker的相关东西。<br>假设使用 <a href=\"https://github.com/tools/godep\" target=\"_blank\" rel=\"external\">godep</a> 作为依赖管理工具<br>示例中开放端口为80，需要与app.conf中的端口一致，可以自行修改。</p>\n<h4 id=\"配置\"><a href=\"#配置\" class=\"headerlink\" title=\"配置\"></a>配置</h4><p>在 /go/app 目录新建Dockerfile。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div></pre></td><td class=\"code\"><pre><div class=\"line\">FROM golang:1.7.1-alpine</div><div class=\"line\"></div><div class=\"line\">MAINTAINER youremail &lt;youremail@xxx.com&gt;</div><div class=\"line\"></div><div class=\"line\">RUN apk add --update go git</div><div class=\"line\"></div><div class=\"line\">ADD ./ /go/src/app</div><div class=\"line\"></div><div class=\"line\">RUN cd /go/src/app \\</div><div class=\"line\">\t&amp;&amp; go get github.com/astaxie/beego \\</div><div class=\"line\">\t&amp;&amp; go get github.com/tools/godep \\</div><div class=\"line\">\t&amp;&amp; godep update -goversion \\</div><div class=\"line\">\t&amp;&amp; godep get \\</div><div class=\"line\">\t&amp;&amp; godep save \\</div><div class=\"line\">\t&amp;&amp; go build</div><div class=\"line\"></div><div class=\"line\">EXPOSE 80</div><div class=\"line\"></div><div class=\"line\">EXTRYPOINT /go/src/app/app</div></pre></td></tr></table></figure>\n<p>本例使用 golang:1.7.1-alpine 作为基础镜像。golang的所有镜像见<a href=\"https://hub.docker.com/_/golang/\" target=\"_blank\" rel=\"external\">这里</a>。</p>\n<h4 id=\"构建\"><a href=\"#构建\" class=\"headerlink\" title=\"构建\"></a>构建</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">docker build -t app .</div></pre></td></tr></table></figure>\n<h4 id=\"运行\"><a href=\"#运行\" class=\"headerlink\" title=\"运行\"></a>运行</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">docker run -d -p 8080:80 app</div></pre></td></tr></table></figure>\n<h4 id=\"访问\"><a href=\"#访问\" class=\"headerlink\" title=\"访问\"></a>访问</h4><p>使用nginx反向代理访问docker中的go应用。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div></pre></td><td class=\"code\"><pre><div class=\"line\">server &#123;</div><div class=\"line\">    listen       80;</div><div class=\"line\">    server_name  app.com;</div><div class=\"line\"></div><div class=\"line\">    charset utf-8;</div><div class=\"line\">    access_log  logs/app.access.log;</div><div class=\"line\"></div><div class=\"line\">    location / &#123;</div><div class=\"line\">        try_files /_not_exists_ @backend;</div><div class=\"line\">    &#125;</div><div class=\"line\">    if (!-e $request_filename) &#123;</div><div class=\"line\">        return 404;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    location @backend &#123;</div><div class=\"line\">        proxy_set_header X-Forwarded-For $remote_addr;</div><div class=\"line\">        proxy_set_header Host            $http_host;</div><div class=\"line\"></div><div class=\"line\">        proxy_pass http://192.168.99.100:8080; // 192.168.99.100为docker machine的ip,8080为 docker run 时指定的本地端口。</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h4 id=\"相关资料\"><a href=\"#相关资料\" class=\"headerlink\" title=\"相关资料\"></a>相关资料</h4><p><a href=\"https://yq.aliyun.com/articles/57247\" target=\"_blank\" rel=\"external\">如何使用Docker快速部署go-web应用程序</a><br><a href=\"https://blog.golang.org/docker\" target=\"_blank\" rel=\"external\">Deploying Go servers with Docker</a><br><a href=\"http://www.infoq.com/cn/articles/how-to-deploy-a-go-web-application-with-docker?utm_source=infoq&amp;utm_medium=related_content_link&amp;utm_campaign=relatedContent_articles_clk\" target=\"_blank\" rel=\"external\">如何使用Docker部署Go Web应用程序</a><br><a href=\"https://www.iron.io/the-easiest-way-to-develop-with-go%E2%80%8A-%E2%80%8Aintroducing-a-docker-based-go-tool/\" target=\"_blank\" rel=\"external\">The Easiest Way to Develop with Go — Introducing a Docker Based Go Tool</a><br><a href=\"https://semaphoreci.com/community/tutorials/how-to-deploy-a-go-web-application-with-docker\" target=\"_blank\" rel=\"external\">How To Deploy a Go Web Application with Docker</a><br><a href=\"https://beego.me/docs/deploy/nginx.md\" target=\"_blank\" rel=\"external\">nginx 部署</a></p>\n"},{"title":"解决Discuz无法发布爱奇艺视频的问题","date":"2016-05-08T10:57:24.000Z","_content":"\n\n![](/images/discuz/201510148054_136.jpg)\n\n最近碰到需要在Discuz论坛中插入爱奇艺视频的问题，之前没关注过，搜索后有些答案说DZ不支持爱奇艺，有些说爱奇艺不支持DZ，并没有真正能解决问题的。\n\n下午突然想到也许是DZ根据粘贴进来的flash地址生成的标签代码不对，试验后发现果然是这个原因。\n\n打卡/static/js/editor.js 文件第1299行查看这段代码：\n\n```js\ncase 'vid':\n\tvar mediaUrl = $(ctrlid + '_param_1').value;\n\tvar auto = '';\n\tvar posque = mediaUrl.lastIndexOf('?');\n\tposque = posque === -1 ? mb_strlen(mediaUrl) : posque;\n\tvar ext = mediaUrl.lastIndexOf('.') === -1 ? '' : mediaUrl.substring(mediaUrl.lastIndexOf('.') + 1, posque).toLowerCase();\n\text = in_array(ext, ['mp3', 'wma', 'ra', 'rm', 'ram', 'mid', 'asx', 'wmv', 'avi', 'mpg', 'mpeg', 'rmvb', 'asf', 'mov', 'flv', 'swf']) ? ext : 'x';\n\tif(ext == 'x') {\n\t\tif(/^mms:\\/\\//.test(mediaUrl)) {\n\t\t\text = 'mms';\n\t\t} else if(/^(rtsp|pnm):\\/\\//.test(mediaUrl)) {\n\t\t\text = 'rtsp';\n\t\t}\n\t}\n\tvar str = '[media=' + ext + ',' + $(ctrlid + '_param_2').value + ',' + $(ctrlid + '_param_3').value + ']' + squarestrip(mediaUrl) + '[/media]';\n\tinsertText(str, str.length, 0, false, sel);\n\tbreak;\n```\n\n\nDiscuz根据主流的视频网站的视频地址格式写的规则，生成discuz专用的[media]标签，在前台输出的时候再解析成embed这样的HTML代码。\n\n解析之后的差不多就是这样：\n\n```html\n<embed src=\"http://player.video.qiyi.com/7b42a1a27ff121c201ee5e6c6d757817/0/0/v_19rrklq2bs.swf-albumId=406283300-tvId=406283300-isPurchase=2-cnId=1\" allowFullScreen=\"true\" quality=\"high\" width=\"480\" height=\"350\" align=\"middle\" allowScriptAccess=\"always\" type=\"application/x-shockwave-flash\"></embed>\n```\n\n而不那么主流的爱奇艺的flash地址则是：”http://player.video.qiyi.com/7b42a1a27ff121c201ee5e6c6d757817/0/0/v_19rrklq2bs.swf-albumId=406283300-tvId=406283300-isPurchase=2-cnId=1”，查看上一段代码可以看到，discuz会用正则去看粘贴的地址最后一个\".\"后的后缀，如果这个后缀不在自己的已知flash格式数组中，就把类型设为\"x\"，也就是生成的标签成了[media=x,500,350]。\n\n再到了前台解析，不认识，直接生成一个a标签。\n\n所以，我的解决办法是：\n\n```js\nif(ext == 'x') {\n\tif(/^mms:\\/\\//.test(mediaUrl)) {\n\t\text = 'mms';\n\t} else if(/^(rtsp|pnm):\\/\\//.test(mediaUrl)) {\n\t\text = 'rtsp';\n\t} else if (mediaUrl.indexOf('player.video.qiyi.com')) {\n  \t\text = 'swf';\t\n\t}\n}\n```\n\n增加一个else if 判断是否包含爱奇艺播放器的域名，当用户粘贴的flash地址包含这个字符串时，就认为是粘贴了一个爱奇艺的视频，存储的格式也就成了[media=swf]。\n\n但是这里其实不是十分严谨，如果一个非法的flash地址很巧合的包含了这个字符串，也会认为是flash了，那这种情况下就会出错了。","source":"_posts/cant-post-iqiyi-video-to-discuz.md","raw":"title: 解决Discuz无法发布爱奇艺视频的问题\ncategories: javascript\ndate: 2016-05-08 18:57:24\ntags:  [js,discuz,爱奇艺]\n---\n\n\n![](/images/discuz/201510148054_136.jpg)\n\n最近碰到需要在Discuz论坛中插入爱奇艺视频的问题，之前没关注过，搜索后有些答案说DZ不支持爱奇艺，有些说爱奇艺不支持DZ，并没有真正能解决问题的。\n\n下午突然想到也许是DZ根据粘贴进来的flash地址生成的标签代码不对，试验后发现果然是这个原因。\n\n打卡/static/js/editor.js 文件第1299行查看这段代码：\n\n```js\ncase 'vid':\n\tvar mediaUrl = $(ctrlid + '_param_1').value;\n\tvar auto = '';\n\tvar posque = mediaUrl.lastIndexOf('?');\n\tposque = posque === -1 ? mb_strlen(mediaUrl) : posque;\n\tvar ext = mediaUrl.lastIndexOf('.') === -1 ? '' : mediaUrl.substring(mediaUrl.lastIndexOf('.') + 1, posque).toLowerCase();\n\text = in_array(ext, ['mp3', 'wma', 'ra', 'rm', 'ram', 'mid', 'asx', 'wmv', 'avi', 'mpg', 'mpeg', 'rmvb', 'asf', 'mov', 'flv', 'swf']) ? ext : 'x';\n\tif(ext == 'x') {\n\t\tif(/^mms:\\/\\//.test(mediaUrl)) {\n\t\t\text = 'mms';\n\t\t} else if(/^(rtsp|pnm):\\/\\//.test(mediaUrl)) {\n\t\t\text = 'rtsp';\n\t\t}\n\t}\n\tvar str = '[media=' + ext + ',' + $(ctrlid + '_param_2').value + ',' + $(ctrlid + '_param_3').value + ']' + squarestrip(mediaUrl) + '[/media]';\n\tinsertText(str, str.length, 0, false, sel);\n\tbreak;\n```\n\n\nDiscuz根据主流的视频网站的视频地址格式写的规则，生成discuz专用的[media]标签，在前台输出的时候再解析成embed这样的HTML代码。\n\n解析之后的差不多就是这样：\n\n```html\n<embed src=\"http://player.video.qiyi.com/7b42a1a27ff121c201ee5e6c6d757817/0/0/v_19rrklq2bs.swf-albumId=406283300-tvId=406283300-isPurchase=2-cnId=1\" allowFullScreen=\"true\" quality=\"high\" width=\"480\" height=\"350\" align=\"middle\" allowScriptAccess=\"always\" type=\"application/x-shockwave-flash\"></embed>\n```\n\n而不那么主流的爱奇艺的flash地址则是：”http://player.video.qiyi.com/7b42a1a27ff121c201ee5e6c6d757817/0/0/v_19rrklq2bs.swf-albumId=406283300-tvId=406283300-isPurchase=2-cnId=1”，查看上一段代码可以看到，discuz会用正则去看粘贴的地址最后一个\".\"后的后缀，如果这个后缀不在自己的已知flash格式数组中，就把类型设为\"x\"，也就是生成的标签成了[media=x,500,350]。\n\n再到了前台解析，不认识，直接生成一个a标签。\n\n所以，我的解决办法是：\n\n```js\nif(ext == 'x') {\n\tif(/^mms:\\/\\//.test(mediaUrl)) {\n\t\text = 'mms';\n\t} else if(/^(rtsp|pnm):\\/\\//.test(mediaUrl)) {\n\t\text = 'rtsp';\n\t} else if (mediaUrl.indexOf('player.video.qiyi.com')) {\n  \t\text = 'swf';\t\n\t}\n}\n```\n\n增加一个else if 判断是否包含爱奇艺播放器的域名，当用户粘贴的flash地址包含这个字符串时，就认为是粘贴了一个爱奇艺的视频，存储的格式也就成了[media=swf]。\n\n但是这里其实不是十分严谨，如果一个非法的flash地址很巧合的包含了这个字符串，也会认为是flash了，那这种情况下就会出错了。","slug":"cant-post-iqiyi-video-to-discuz","published":1,"updated":"2016-05-08T10:57:25.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj830jvdg000nul0rh4gfdqa7","content":"<p><img src=\"/images/discuz/201510148054_136.jpg\" alt=\"\"></p>\n<p>最近碰到需要在Discuz论坛中插入爱奇艺视频的问题，之前没关注过，搜索后有些答案说DZ不支持爱奇艺，有些说爱奇艺不支持DZ，并没有真正能解决问题的。</p>\n<p>下午突然想到也许是DZ根据粘贴进来的flash地址生成的标签代码不对，试验后发现果然是这个原因。</p>\n<p>打卡/static/js/editor.js 文件第1299行查看这段代码：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">case</span> <span class=\"string\">'vid'</span>:</div><div class=\"line\">\t<span class=\"keyword\">var</span> mediaUrl = $(ctrlid + <span class=\"string\">'_param_1'</span>).value;</div><div class=\"line\">\t<span class=\"keyword\">var</span> auto = <span class=\"string\">''</span>;</div><div class=\"line\">\t<span class=\"keyword\">var</span> posque = mediaUrl.lastIndexOf(<span class=\"string\">'?'</span>);</div><div class=\"line\">\tposque = posque === <span class=\"number\">-1</span> ? mb_strlen(mediaUrl) : posque;</div><div class=\"line\">\t<span class=\"keyword\">var</span> ext = mediaUrl.lastIndexOf(<span class=\"string\">'.'</span>) === <span class=\"number\">-1</span> ? <span class=\"string\">''</span> : mediaUrl.substring(mediaUrl.lastIndexOf(<span class=\"string\">'.'</span>) + <span class=\"number\">1</span>, posque).toLowerCase();</div><div class=\"line\">\text = in_array(ext, [<span class=\"string\">'mp3'</span>, <span class=\"string\">'wma'</span>, <span class=\"string\">'ra'</span>, <span class=\"string\">'rm'</span>, <span class=\"string\">'ram'</span>, <span class=\"string\">'mid'</span>, <span class=\"string\">'asx'</span>, <span class=\"string\">'wmv'</span>, <span class=\"string\">'avi'</span>, <span class=\"string\">'mpg'</span>, <span class=\"string\">'mpeg'</span>, <span class=\"string\">'rmvb'</span>, <span class=\"string\">'asf'</span>, <span class=\"string\">'mov'</span>, <span class=\"string\">'flv'</span>, <span class=\"string\">'swf'</span>]) ? ext : <span class=\"string\">'x'</span>;</div><div class=\"line\">\t<span class=\"keyword\">if</span>(ext == <span class=\"string\">'x'</span>) &#123;</div><div class=\"line\">\t\t<span class=\"keyword\">if</span>(<span class=\"regexp\">/^mms:\\/\\//</span>.test(mediaUrl)) &#123;</div><div class=\"line\">\t\t\text = <span class=\"string\">'mms'</span>;</div><div class=\"line\">\t\t&#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span>(<span class=\"regexp\">/^(rtsp|pnm):\\/\\//</span>.test(mediaUrl)) &#123;</div><div class=\"line\">\t\t\text = <span class=\"string\">'rtsp'</span>;</div><div class=\"line\">\t\t&#125;</div><div class=\"line\">\t&#125;</div><div class=\"line\">\t<span class=\"keyword\">var</span> str = <span class=\"string\">'[media='</span> + ext + <span class=\"string\">','</span> + $(ctrlid + <span class=\"string\">'_param_2'</span>).value + <span class=\"string\">','</span> + $(ctrlid + <span class=\"string\">'_param_3'</span>).value + <span class=\"string\">']'</span> + squarestrip(mediaUrl) + <span class=\"string\">'[/media]'</span>;</div><div class=\"line\">\tinsertText(str, str.length, <span class=\"number\">0</span>, <span class=\"literal\">false</span>, sel);</div><div class=\"line\">\t<span class=\"keyword\">break</span>;</div></pre></td></tr></table></figure>\n<p>Discuz根据主流的视频网站的视频地址格式写的规则，生成discuz专用的[media]标签，在前台输出的时候再解析成embed这样的HTML代码。</p>\n<p>解析之后的差不多就是这样：</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">embed</span> <span class=\"attr\">src</span>=<span class=\"string\">\"http://player.video.qiyi.com/7b42a1a27ff121c201ee5e6c6d757817/0/0/v_19rrklq2bs.swf-albumId=406283300-tvId=406283300-isPurchase=2-cnId=1\"</span> <span class=\"attr\">allowFullScreen</span>=<span class=\"string\">\"true\"</span> <span class=\"attr\">quality</span>=<span class=\"string\">\"high\"</span> <span class=\"attr\">width</span>=<span class=\"string\">\"480\"</span> <span class=\"attr\">height</span>=<span class=\"string\">\"350\"</span> <span class=\"attr\">align</span>=<span class=\"string\">\"middle\"</span> <span class=\"attr\">allowScriptAccess</span>=<span class=\"string\">\"always\"</span> <span class=\"attr\">type</span>=<span class=\"string\">\"application/x-shockwave-flash\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">embed</span>&gt;</span></div></pre></td></tr></table></figure>\n<p>而不那么主流的爱奇艺的flash地址则是：”<a href=\"http://player.video.qiyi.com/7b42a1a27ff121c201ee5e6c6d757817/0/0/v_19rrklq2bs.swf-albumId=406283300-tvId=406283300-isPurchase=2-cnId=1”，查看上一段代码可以看到，discuz会用正则去看粘贴的地址最后一个&quot;.&quot;后的后缀，如果这个后缀不在自己的已知flash格式数组中，就把类型设为&quot;x&quot;，也就是生成的标签成了[media=x,500,350]。\" target=\"_blank\" rel=\"external\">http://player.video.qiyi.com/7b42a1a27ff121c201ee5e6c6d757817/0/0/v_19rrklq2bs.swf-albumId=406283300-tvId=406283300-isPurchase=2-cnId=1”，查看上一段代码可以看到，discuz会用正则去看粘贴的地址最后一个&quot;.&quot;后的后缀，如果这个后缀不在自己的已知flash格式数组中，就把类型设为&quot;x&quot;，也就是生成的标签成了[media=x,500,350]。</a></p>\n<p>再到了前台解析，不认识，直接生成一个a标签。</p>\n<p>所以，我的解决办法是：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">if</span>(ext == <span class=\"string\">'x'</span>) &#123;</div><div class=\"line\">\t<span class=\"keyword\">if</span>(<span class=\"regexp\">/^mms:\\/\\//</span>.test(mediaUrl)) &#123;</div><div class=\"line\">\t\text = <span class=\"string\">'mms'</span>;</div><div class=\"line\">\t&#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span>(<span class=\"regexp\">/^(rtsp|pnm):\\/\\//</span>.test(mediaUrl)) &#123;</div><div class=\"line\">\t\text = <span class=\"string\">'rtsp'</span>;</div><div class=\"line\">\t&#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (mediaUrl.indexOf(<span class=\"string\">'player.video.qiyi.com'</span>)) &#123;</div><div class=\"line\">  \t\text = <span class=\"string\">'swf'</span>;\t</div><div class=\"line\">\t&#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>增加一个else if 判断是否包含爱奇艺播放器的域名，当用户粘贴的flash地址包含这个字符串时，就认为是粘贴了一个爱奇艺的视频，存储的格式也就成了[media=swf]。</p>\n<p>但是这里其实不是十分严谨，如果一个非法的flash地址很巧合的包含了这个字符串，也会认为是flash了，那这种情况下就会出错了。</p>\n","site":{"data":{}},"excerpt":"","more":"<p><img src=\"/images/discuz/201510148054_136.jpg\" alt=\"\"></p>\n<p>最近碰到需要在Discuz论坛中插入爱奇艺视频的问题，之前没关注过，搜索后有些答案说DZ不支持爱奇艺，有些说爱奇艺不支持DZ，并没有真正能解决问题的。</p>\n<p>下午突然想到也许是DZ根据粘贴进来的flash地址生成的标签代码不对，试验后发现果然是这个原因。</p>\n<p>打卡/static/js/editor.js 文件第1299行查看这段代码：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">case</span> <span class=\"string\">'vid'</span>:</div><div class=\"line\">\t<span class=\"keyword\">var</span> mediaUrl = $(ctrlid + <span class=\"string\">'_param_1'</span>).value;</div><div class=\"line\">\t<span class=\"keyword\">var</span> auto = <span class=\"string\">''</span>;</div><div class=\"line\">\t<span class=\"keyword\">var</span> posque = mediaUrl.lastIndexOf(<span class=\"string\">'?'</span>);</div><div class=\"line\">\tposque = posque === <span class=\"number\">-1</span> ? mb_strlen(mediaUrl) : posque;</div><div class=\"line\">\t<span class=\"keyword\">var</span> ext = mediaUrl.lastIndexOf(<span class=\"string\">'.'</span>) === <span class=\"number\">-1</span> ? <span class=\"string\">''</span> : mediaUrl.substring(mediaUrl.lastIndexOf(<span class=\"string\">'.'</span>) + <span class=\"number\">1</span>, posque).toLowerCase();</div><div class=\"line\">\text = in_array(ext, [<span class=\"string\">'mp3'</span>, <span class=\"string\">'wma'</span>, <span class=\"string\">'ra'</span>, <span class=\"string\">'rm'</span>, <span class=\"string\">'ram'</span>, <span class=\"string\">'mid'</span>, <span class=\"string\">'asx'</span>, <span class=\"string\">'wmv'</span>, <span class=\"string\">'avi'</span>, <span class=\"string\">'mpg'</span>, <span class=\"string\">'mpeg'</span>, <span class=\"string\">'rmvb'</span>, <span class=\"string\">'asf'</span>, <span class=\"string\">'mov'</span>, <span class=\"string\">'flv'</span>, <span class=\"string\">'swf'</span>]) ? ext : <span class=\"string\">'x'</span>;</div><div class=\"line\">\t<span class=\"keyword\">if</span>(ext == <span class=\"string\">'x'</span>) &#123;</div><div class=\"line\">\t\t<span class=\"keyword\">if</span>(<span class=\"regexp\">/^mms:\\/\\//</span>.test(mediaUrl)) &#123;</div><div class=\"line\">\t\t\text = <span class=\"string\">'mms'</span>;</div><div class=\"line\">\t\t&#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span>(<span class=\"regexp\">/^(rtsp|pnm):\\/\\//</span>.test(mediaUrl)) &#123;</div><div class=\"line\">\t\t\text = <span class=\"string\">'rtsp'</span>;</div><div class=\"line\">\t\t&#125;</div><div class=\"line\">\t&#125;</div><div class=\"line\">\t<span class=\"keyword\">var</span> str = <span class=\"string\">'[media='</span> + ext + <span class=\"string\">','</span> + $(ctrlid + <span class=\"string\">'_param_2'</span>).value + <span class=\"string\">','</span> + $(ctrlid + <span class=\"string\">'_param_3'</span>).value + <span class=\"string\">']'</span> + squarestrip(mediaUrl) + <span class=\"string\">'[/media]'</span>;</div><div class=\"line\">\tinsertText(str, str.length, <span class=\"number\">0</span>, <span class=\"literal\">false</span>, sel);</div><div class=\"line\">\t<span class=\"keyword\">break</span>;</div></pre></td></tr></table></figure>\n<p>Discuz根据主流的视频网站的视频地址格式写的规则，生成discuz专用的[media]标签，在前台输出的时候再解析成embed这样的HTML代码。</p>\n<p>解析之后的差不多就是这样：</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">embed</span> <span class=\"attr\">src</span>=<span class=\"string\">\"http://player.video.qiyi.com/7b42a1a27ff121c201ee5e6c6d757817/0/0/v_19rrklq2bs.swf-albumId=406283300-tvId=406283300-isPurchase=2-cnId=1\"</span> <span class=\"attr\">allowFullScreen</span>=<span class=\"string\">\"true\"</span> <span class=\"attr\">quality</span>=<span class=\"string\">\"high\"</span> <span class=\"attr\">width</span>=<span class=\"string\">\"480\"</span> <span class=\"attr\">height</span>=<span class=\"string\">\"350\"</span> <span class=\"attr\">align</span>=<span class=\"string\">\"middle\"</span> <span class=\"attr\">allowScriptAccess</span>=<span class=\"string\">\"always\"</span> <span class=\"attr\">type</span>=<span class=\"string\">\"application/x-shockwave-flash\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">embed</span>&gt;</span></div></pre></td></tr></table></figure>\n<p>而不那么主流的爱奇艺的flash地址则是：”<a href=\"http://player.video.qiyi.com/7b42a1a27ff121c201ee5e6c6d757817/0/0/v_19rrklq2bs.swf-albumId=406283300-tvId=406283300-isPurchase=2-cnId=1”，查看上一段代码可以看到，discuz会用正则去看粘贴的地址最后一个&quot;.&quot;后的后缀，如果这个后缀不在自己的已知flash格式数组中，就把类型设为&quot;x&quot;，也就是生成的标签成了[media=x,500,350]。\" target=\"_blank\" rel=\"external\">http://player.video.qiyi.com/7b42a1a27ff121c201ee5e6c6d757817/0/0/v_19rrklq2bs.swf-albumId=406283300-tvId=406283300-isPurchase=2-cnId=1”，查看上一段代码可以看到，discuz会用正则去看粘贴的地址最后一个&quot;.&quot;后的后缀，如果这个后缀不在自己的已知flash格式数组中，就把类型设为&quot;x&quot;，也就是生成的标签成了[media=x,500,350]。</a></p>\n<p>再到了前台解析，不认识，直接生成一个a标签。</p>\n<p>所以，我的解决办法是：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">if</span>(ext == <span class=\"string\">'x'</span>) &#123;</div><div class=\"line\">\t<span class=\"keyword\">if</span>(<span class=\"regexp\">/^mms:\\/\\//</span>.test(mediaUrl)) &#123;</div><div class=\"line\">\t\text = <span class=\"string\">'mms'</span>;</div><div class=\"line\">\t&#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span>(<span class=\"regexp\">/^(rtsp|pnm):\\/\\//</span>.test(mediaUrl)) &#123;</div><div class=\"line\">\t\text = <span class=\"string\">'rtsp'</span>;</div><div class=\"line\">\t&#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (mediaUrl.indexOf(<span class=\"string\">'player.video.qiyi.com'</span>)) &#123;</div><div class=\"line\">  \t\text = <span class=\"string\">'swf'</span>;\t</div><div class=\"line\">\t&#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>增加一个else if 判断是否包含爱奇艺播放器的域名，当用户粘贴的flash地址包含这个字符串时，就认为是粘贴了一个爱奇艺的视频，存储的格式也就成了[media=swf]。</p>\n<p>但是这里其实不是十分严谨，如果一个非法的flash地址很巧合的包含了这个字符串，也会认为是flash了，那这种情况下就会出错了。</p>\n"},{"title":"Golang XMl 转 JSON","date":"2016-09-16T03:28:20.000Z","_content":"\n![](/images/golang.png)\n\n#### 起因\n\n某个上古时代的API，依然在返回XML格式的数据，更奇葩的是，GBK格式的。\n\n用Go顺利的写到了发送数据，接收数据，然后取值有点麻烦啊。。。。\n\n各种Google后，终于解决，但是不保证是唯一，正确，最合适的答案。\n\n#### 说在前边\n\n本文假设要解析的XMl数据为：\n\n```xml\n<?xml version=\"1.0\" encoding=\"GBK\" ?>\n<response>\n    <status>200</status>\n</response>\n```\n\n要解决的问题是取出“200”这个状态值。\n\n#### 导入包\n\n解析XML使用了\"encoding/xml\"这个包。\n\n所以先导入这个包。\n\n```go\nimport \"encoding/xml\"\n```\n\n#### 定义struct\n\n定义一个自定义类型的Response\n\n```go\ntype Response struct {\n    Status int `xml:\"status\" json:\"status\"`\n}\n```\n\n定义一个Response类型的变量\n\n```go\nvar result Response\n```\n\n#### 偷懒转格式\n\n因为\"encoding/xml\"不支持GBK格式的XML，而返回的内容又固定标明了编码是GBK，所以这里偷懒，直接把GBK替换成UTF-8，本例中不影响结果。\n\n```go\nxmlstr := `?xml version=\"1.0\" encoding=\"GBK\" ?>\n<response>\n    <status>200</status>\n</response>\n`\nxmlstr = strings.Replace(xmlstr, \"GBK\", \"UTF-8\", -1)\n```\n\n使用strings包，替换“GBK”，相信根据参数顺序能看出各个参数的意义，最后一个参数：-1，为替换全部，即字符串中所有出现的第二个参数全部替换。\n\n#### 解析，转换，取值\n\n使用encoding/jon，go-simplejson包\n\n```go\n//解析XML\nerr := xml.Unmarshal([]byte(xmlstr), &result)\n\nif nil != err {\n  log.Fatal(err)\n}\nlog.Printf(\"XML:%v \\n\", result) \n\n//转换成JSON\nres, err := json.Marshal(result)\n\nif nil != err {\n  log.Fatal(err)\n}\nlog.Printf(\"JSON:%s \\n\", res)\n\njs, err := simplejson.NewJson([]byte(res))\n\nif nil != err {\n  log.Fatal(err)\n}\nstatus, err := js.Get(\"status\").Int()\n\nlog.Printf(\"STATUS:%v \\n\", status)\n```\n\n以上是本人在处理XML 转 JSON 时的解决办法，应该还有更简单更合适的方案。仅供参考。\n\n#### 完整代码：\n\n```go\npackage main\nimport (\n    \"encoding/xml\"\n    \"encoding/json\"\n    \"log\"\n    \"strings\"\n    simplejson \"github.com/bitly/go-simplejson\"\n)\ntype Response struct {\n    Status int `xml:\"status\" json:\"status\"`\n}\n\nfunc main() {\n    \n    var result Response\n\n    //多行字符串，使用反引号`\n    xmlstr := `<?xml version=\"1.0\" encoding=\"GBK\" ?>\n<response>\n    <status>200</status>\n</response>`\n\n    xmlstr = strings.Replace(xmlstr, \"GBK\", \"UTF-8\", -1)\n\n    err := xml.Unmarshal([]byte(xmlstr), &result)\n    if err != nil {\n        log.Fatal(err)\n    }\n    log.Printf(\"XML:%v\",result)\n\n    r, err := json.Marshal(result)\n    if nil != err {\n        log.Fatal(err)\n    }\n\n    log.Printf(\"JSON:%s\", r)\n\n    js, err := simplejson.NewJson([]byte(r))\n\n    if nil != err {\n        log.Fatal(err)\n    }\n    status, err := js.Get(\"status\").Int()\n    log.Printf(\"VALUE:%v\",status)\n\n}\n```\n\n#### 发现问题：\n今天（2016-09-18），再看这段代码，发现跟另一个程序里有些不一样。\n\n另一个程序里是这样的：\n```\ntype Response struct {\n    Status int `xml:\"status\"\n}\n```\n也可以正常返回值，但是在本文中的示例却不能正常输出status值，而是会输出空，看了半天发现，使用 log 时：\n```\nlog.Printf(\"VALUE:%v\",status)\n```\n如果struct没有写\n“json:\"status\"”，就不能输出，如果换成fmt，struct就可以不写“json:\"status\"。结果是一样的，其中的原因还要再查资料研究下。\n\n参考文章：\n\n[标准库—XML处理（一）](http://blog.studygolang.com/2012/12/%e6%a0%87%e5%87%86%e5%ba%93-xml%e5%a4%84%e7%90%86%ef%bc%88%e4%b8%80%ef%bc%89/)\n\n[https://play.golang.org/p/7HNLEUnX-m](https://play.golang.org/p/7HNLEUnX-m)\n\n[https://play.golang.org/p/m99B12RaLe](https://play.golang.org/p/m99B12RaLe)\n\n[XML处理](https://astaxie.gitbooks.io/build-web-application-with-golang/content/zh/07.1.html)","source":"_posts/convert-xml-to-json-in-golang.md","raw":"title: Golang XMl 转 JSON\ncategories: golang\ndate: 2016-09-16 11:28:20\ntags:  [go]\n\n---\n\n![](/images/golang.png)\n\n#### 起因\n\n某个上古时代的API，依然在返回XML格式的数据，更奇葩的是，GBK格式的。\n\n用Go顺利的写到了发送数据，接收数据，然后取值有点麻烦啊。。。。\n\n各种Google后，终于解决，但是不保证是唯一，正确，最合适的答案。\n\n#### 说在前边\n\n本文假设要解析的XMl数据为：\n\n```xml\n<?xml version=\"1.0\" encoding=\"GBK\" ?>\n<response>\n    <status>200</status>\n</response>\n```\n\n要解决的问题是取出“200”这个状态值。\n\n#### 导入包\n\n解析XML使用了\"encoding/xml\"这个包。\n\n所以先导入这个包。\n\n```go\nimport \"encoding/xml\"\n```\n\n#### 定义struct\n\n定义一个自定义类型的Response\n\n```go\ntype Response struct {\n    Status int `xml:\"status\" json:\"status\"`\n}\n```\n\n定义一个Response类型的变量\n\n```go\nvar result Response\n```\n\n#### 偷懒转格式\n\n因为\"encoding/xml\"不支持GBK格式的XML，而返回的内容又固定标明了编码是GBK，所以这里偷懒，直接把GBK替换成UTF-8，本例中不影响结果。\n\n```go\nxmlstr := `?xml version=\"1.0\" encoding=\"GBK\" ?>\n<response>\n    <status>200</status>\n</response>\n`\nxmlstr = strings.Replace(xmlstr, \"GBK\", \"UTF-8\", -1)\n```\n\n使用strings包，替换“GBK”，相信根据参数顺序能看出各个参数的意义，最后一个参数：-1，为替换全部，即字符串中所有出现的第二个参数全部替换。\n\n#### 解析，转换，取值\n\n使用encoding/jon，go-simplejson包\n\n```go\n//解析XML\nerr := xml.Unmarshal([]byte(xmlstr), &result)\n\nif nil != err {\n  log.Fatal(err)\n}\nlog.Printf(\"XML:%v \\n\", result) \n\n//转换成JSON\nres, err := json.Marshal(result)\n\nif nil != err {\n  log.Fatal(err)\n}\nlog.Printf(\"JSON:%s \\n\", res)\n\njs, err := simplejson.NewJson([]byte(res))\n\nif nil != err {\n  log.Fatal(err)\n}\nstatus, err := js.Get(\"status\").Int()\n\nlog.Printf(\"STATUS:%v \\n\", status)\n```\n\n以上是本人在处理XML 转 JSON 时的解决办法，应该还有更简单更合适的方案。仅供参考。\n\n#### 完整代码：\n\n```go\npackage main\nimport (\n    \"encoding/xml\"\n    \"encoding/json\"\n    \"log\"\n    \"strings\"\n    simplejson \"github.com/bitly/go-simplejson\"\n)\ntype Response struct {\n    Status int `xml:\"status\" json:\"status\"`\n}\n\nfunc main() {\n    \n    var result Response\n\n    //多行字符串，使用反引号`\n    xmlstr := `<?xml version=\"1.0\" encoding=\"GBK\" ?>\n<response>\n    <status>200</status>\n</response>`\n\n    xmlstr = strings.Replace(xmlstr, \"GBK\", \"UTF-8\", -1)\n\n    err := xml.Unmarshal([]byte(xmlstr), &result)\n    if err != nil {\n        log.Fatal(err)\n    }\n    log.Printf(\"XML:%v\",result)\n\n    r, err := json.Marshal(result)\n    if nil != err {\n        log.Fatal(err)\n    }\n\n    log.Printf(\"JSON:%s\", r)\n\n    js, err := simplejson.NewJson([]byte(r))\n\n    if nil != err {\n        log.Fatal(err)\n    }\n    status, err := js.Get(\"status\").Int()\n    log.Printf(\"VALUE:%v\",status)\n\n}\n```\n\n#### 发现问题：\n今天（2016-09-18），再看这段代码，发现跟另一个程序里有些不一样。\n\n另一个程序里是这样的：\n```\ntype Response struct {\n    Status int `xml:\"status\"\n}\n```\n也可以正常返回值，但是在本文中的示例却不能正常输出status值，而是会输出空，看了半天发现，使用 log 时：\n```\nlog.Printf(\"VALUE:%v\",status)\n```\n如果struct没有写\n“json:\"status\"”，就不能输出，如果换成fmt，struct就可以不写“json:\"status\"。结果是一样的，其中的原因还要再查资料研究下。\n\n参考文章：\n\n[标准库—XML处理（一）](http://blog.studygolang.com/2012/12/%e6%a0%87%e5%87%86%e5%ba%93-xml%e5%a4%84%e7%90%86%ef%bc%88%e4%b8%80%ef%bc%89/)\n\n[https://play.golang.org/p/7HNLEUnX-m](https://play.golang.org/p/7HNLEUnX-m)\n\n[https://play.golang.org/p/m99B12RaLe](https://play.golang.org/p/m99B12RaLe)\n\n[XML处理](https://astaxie.gitbooks.io/build-web-application-with-golang/content/zh/07.1.html)","slug":"convert-xml-to-json-in-golang","published":1,"updated":"2016-09-18T13:19:05.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj830jvdh000sul0rd2byw5k9","content":"<p><img src=\"/images/golang.png\" alt=\"\"></p>\n<h4 id=\"起因\"><a href=\"#起因\" class=\"headerlink\" title=\"起因\"></a>起因</h4><p>某个上古时代的API，依然在返回XML格式的数据，更奇葩的是，GBK格式的。</p>\n<p>用Go顺利的写到了发送数据，接收数据，然后取值有点麻烦啊。。。。</p>\n<p>各种Google后，终于解决，但是不保证是唯一，正确，最合适的答案。</p>\n<h4 id=\"说在前边\"><a href=\"#说在前边\" class=\"headerlink\" title=\"说在前边\"></a>说在前边</h4><p>本文假设要解析的XMl数据为：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"php\"><span class=\"meta\">&lt;?</span>xml version=<span class=\"string\">\"1.0\"</span> encoding=<span class=\"string\">\"GBK\"</span> <span class=\"meta\">?&gt;</span></span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">response</span>&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">status</span>&gt;</span>200<span class=\"tag\">&lt;/<span class=\"name\">status</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">response</span>&gt;</span></div></pre></td></tr></table></figure>\n<p>要解决的问题是取出“200”这个状态值。</p>\n<h4 id=\"导入包\"><a href=\"#导入包\" class=\"headerlink\" title=\"导入包\"></a>导入包</h4><p>解析XML使用了”encoding/xml”这个包。</p>\n<p>所以先导入这个包。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">import</span> <span class=\"string\">\"encoding/xml\"</span></div></pre></td></tr></table></figure>\n<h4 id=\"定义struct\"><a href=\"#定义struct\" class=\"headerlink\" title=\"定义struct\"></a>定义struct</h4><p>定义一个自定义类型的Response</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">type</span> Response <span class=\"keyword\">struct</span> &#123;</div><div class=\"line\">    Status <span class=\"keyword\">int</span> <span class=\"string\">`xml:\"status\" json:\"status\"`</span></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>定义一个Response类型的变量</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> result Response</div></pre></td></tr></table></figure>\n<h4 id=\"偷懒转格式\"><a href=\"#偷懒转格式\" class=\"headerlink\" title=\"偷懒转格式\"></a>偷懒转格式</h4><p>因为”encoding/xml”不支持GBK格式的XML，而返回的内容又固定标明了编码是GBK，所以这里偷懒，直接把GBK替换成UTF-8，本例中不影响结果。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">xmlstr := <span class=\"string\">`?xml version=\"1.0\" encoding=\"GBK\" ?&gt;</span></div><div class=\"line\"><span class=\"string\">&lt;response&gt;</span></div><div class=\"line\"><span class=\"string\">    &lt;status&gt;200&lt;/status&gt;</span></div><div class=\"line\"><span class=\"string\">&lt;/response&gt;</span></div><div class=\"line\"><span class=\"string\">`</span></div><div class=\"line\">xmlstr = strings.Replace(xmlstr, <span class=\"string\">\"GBK\"</span>, <span class=\"string\">\"UTF-8\"</span>, <span class=\"number\">-1</span>)</div></pre></td></tr></table></figure>\n<p>使用strings包，替换“GBK”，相信根据参数顺序能看出各个参数的意义，最后一个参数：-1，为替换全部，即字符串中所有出现的第二个参数全部替换。</p>\n<h4 id=\"解析，转换，取值\"><a href=\"#解析，转换，取值\" class=\"headerlink\" title=\"解析，转换，取值\"></a>解析，转换，取值</h4><p>使用encoding/jon，go-simplejson包</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">//解析XML</span></div><div class=\"line\">err := xml.Unmarshal([]<span class=\"keyword\">byte</span>(xmlstr), &amp;result)</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">if</span> <span class=\"literal\">nil</span> != err &#123;</div><div class=\"line\">  log.Fatal(err)</div><div class=\"line\">&#125;</div><div class=\"line\">log.Printf(<span class=\"string\">\"XML:%v \\n\"</span>, result) </div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">//转换成JSON</span></div><div class=\"line\">res, err := json.Marshal(result)</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">if</span> <span class=\"literal\">nil</span> != err &#123;</div><div class=\"line\">  log.Fatal(err)</div><div class=\"line\">&#125;</div><div class=\"line\">log.Printf(<span class=\"string\">\"JSON:%s \\n\"</span>, res)</div><div class=\"line\"></div><div class=\"line\">js, err := simplejson.NewJson([]<span class=\"keyword\">byte</span>(res))</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">if</span> <span class=\"literal\">nil</span> != err &#123;</div><div class=\"line\">  log.Fatal(err)</div><div class=\"line\">&#125;</div><div class=\"line\">status, err := js.Get(<span class=\"string\">\"status\"</span>).Int()</div><div class=\"line\"></div><div class=\"line\">log.Printf(<span class=\"string\">\"STATUS:%v \\n\"</span>, status)</div></pre></td></tr></table></figure>\n<p>以上是本人在处理XML 转 JSON 时的解决办法，应该还有更简单更合适的方案。仅供参考。</p>\n<h4 id=\"完整代码：\"><a href=\"#完整代码：\" class=\"headerlink\" title=\"完整代码：\"></a>完整代码：</h4><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">package</span> main</div><div class=\"line\"><span class=\"keyword\">import</span> (</div><div class=\"line\">    <span class=\"string\">\"encoding/xml\"</span></div><div class=\"line\">    <span class=\"string\">\"encoding/json\"</span></div><div class=\"line\">    <span class=\"string\">\"log\"</span></div><div class=\"line\">    <span class=\"string\">\"strings\"</span></div><div class=\"line\">    simplejson <span class=\"string\">\"github.com/bitly/go-simplejson\"</span></div><div class=\"line\">)</div><div class=\"line\"><span class=\"keyword\">type</span> Response <span class=\"keyword\">struct</span> &#123;</div><div class=\"line\">    Status <span class=\"keyword\">int</span> <span class=\"string\">`xml:\"status\" json:\"status\"`</span></div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</div><div class=\"line\">    </div><div class=\"line\">    <span class=\"keyword\">var</span> result Response</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">//多行字符串，使用反引号`</span></div><div class=\"line\">    xmlstr := <span class=\"string\">`&lt;?xml version=\"1.0\" encoding=\"GBK\" ?&gt;</span></div><div class=\"line\"><span class=\"string\">&lt;response&gt;</span></div><div class=\"line\"><span class=\"string\">    &lt;status&gt;200&lt;/status&gt;</span></div><div class=\"line\"><span class=\"string\">&lt;/response&gt;`</span></div><div class=\"line\"></div><div class=\"line\">    xmlstr = strings.Replace(xmlstr, <span class=\"string\">\"GBK\"</span>, <span class=\"string\">\"UTF-8\"</span>, <span class=\"number\">-1</span>)</div><div class=\"line\"></div><div class=\"line\">    err := xml.Unmarshal([]<span class=\"keyword\">byte</span>(xmlstr), &amp;result)</div><div class=\"line\">    <span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</div><div class=\"line\">        log.Fatal(err)</div><div class=\"line\">    &#125;</div><div class=\"line\">    log.Printf(<span class=\"string\">\"XML:%v\"</span>,result)</div><div class=\"line\"></div><div class=\"line\">    r, err := json.Marshal(result)</div><div class=\"line\">    <span class=\"keyword\">if</span> <span class=\"literal\">nil</span> != err &#123;</div><div class=\"line\">        log.Fatal(err)</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    log.Printf(<span class=\"string\">\"JSON:%s\"</span>, r)</div><div class=\"line\"></div><div class=\"line\">    js, err := simplejson.NewJson([]<span class=\"keyword\">byte</span>(r))</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">if</span> <span class=\"literal\">nil</span> != err &#123;</div><div class=\"line\">        log.Fatal(err)</div><div class=\"line\">    &#125;</div><div class=\"line\">    status, err := js.Get(<span class=\"string\">\"status\"</span>).Int()</div><div class=\"line\">    log.Printf(<span class=\"string\">\"VALUE:%v\"</span>,status)</div><div class=\"line\"></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h4 id=\"发现问题：\"><a href=\"#发现问题：\" class=\"headerlink\" title=\"发现问题：\"></a>发现问题：</h4><p>今天（2016-09-18），再看这段代码，发现跟另一个程序里有些不一样。</p>\n<p>另一个程序里是这样的：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">type Response struct &#123;</div><div class=\"line\">    Status int `xml:&quot;status&quot;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>也可以正常返回值，但是在本文中的示例却不能正常输出status值，而是会输出空，看了半天发现，使用 log 时：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">log.Printf(&quot;VALUE:%v&quot;,status)</div></pre></td></tr></table></figure></p>\n<p>如果struct没有写<br>“json:”status””，就不能输出，如果换成fmt，struct就可以不写“json:”status”。结果是一样的，其中的原因还要再查资料研究下。</p>\n<p>参考文章：</p>\n<p><a href=\"http://blog.studygolang.com/2012/12/%e6%a0%87%e5%87%86%e5%ba%93-xml%e5%a4%84%e7%90%86%ef%bc%88%e4%b8%80%ef%bc%89/\" target=\"_blank\" rel=\"external\">标准库—XML处理（一）</a></p>\n<p><a href=\"https://play.golang.org/p/7HNLEUnX-m\" target=\"_blank\" rel=\"external\">https://play.golang.org/p/7HNLEUnX-m</a></p>\n<p><a href=\"https://play.golang.org/p/m99B12RaLe\" target=\"_blank\" rel=\"external\">https://play.golang.org/p/m99B12RaLe</a></p>\n<p><a href=\"https://astaxie.gitbooks.io/build-web-application-with-golang/content/zh/07.1.html\" target=\"_blank\" rel=\"external\">XML处理</a></p>\n","site":{"data":{}},"excerpt":"","more":"<p><img src=\"/images/golang.png\" alt=\"\"></p>\n<h4 id=\"起因\"><a href=\"#起因\" class=\"headerlink\" title=\"起因\"></a>起因</h4><p>某个上古时代的API，依然在返回XML格式的数据，更奇葩的是，GBK格式的。</p>\n<p>用Go顺利的写到了发送数据，接收数据，然后取值有点麻烦啊。。。。</p>\n<p>各种Google后，终于解决，但是不保证是唯一，正确，最合适的答案。</p>\n<h4 id=\"说在前边\"><a href=\"#说在前边\" class=\"headerlink\" title=\"说在前边\"></a>说在前边</h4><p>本文假设要解析的XMl数据为：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"php\"><span class=\"meta\">&lt;?</span>xml version=<span class=\"string\">\"1.0\"</span> encoding=<span class=\"string\">\"GBK\"</span> <span class=\"meta\">?&gt;</span></span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">response</span>&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">status</span>&gt;</span>200<span class=\"tag\">&lt;/<span class=\"name\">status</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">response</span>&gt;</span></div></pre></td></tr></table></figure>\n<p>要解决的问题是取出“200”这个状态值。</p>\n<h4 id=\"导入包\"><a href=\"#导入包\" class=\"headerlink\" title=\"导入包\"></a>导入包</h4><p>解析XML使用了”encoding/xml”这个包。</p>\n<p>所以先导入这个包。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">import</span> <span class=\"string\">\"encoding/xml\"</span></div></pre></td></tr></table></figure>\n<h4 id=\"定义struct\"><a href=\"#定义struct\" class=\"headerlink\" title=\"定义struct\"></a>定义struct</h4><p>定义一个自定义类型的Response</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">type</span> Response <span class=\"keyword\">struct</span> &#123;</div><div class=\"line\">    Status <span class=\"keyword\">int</span> <span class=\"string\">`xml:\"status\" json:\"status\"`</span></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>定义一个Response类型的变量</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> result Response</div></pre></td></tr></table></figure>\n<h4 id=\"偷懒转格式\"><a href=\"#偷懒转格式\" class=\"headerlink\" title=\"偷懒转格式\"></a>偷懒转格式</h4><p>因为”encoding/xml”不支持GBK格式的XML，而返回的内容又固定标明了编码是GBK，所以这里偷懒，直接把GBK替换成UTF-8，本例中不影响结果。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">xmlstr := <span class=\"string\">`?xml version=\"1.0\" encoding=\"GBK\" ?&gt;</span></div><div class=\"line\"><span class=\"string\">&lt;response&gt;</span></div><div class=\"line\"><span class=\"string\">    &lt;status&gt;200&lt;/status&gt;</span></div><div class=\"line\"><span class=\"string\">&lt;/response&gt;</span></div><div class=\"line\"><span class=\"string\">`</span></div><div class=\"line\">xmlstr = strings.Replace(xmlstr, <span class=\"string\">\"GBK\"</span>, <span class=\"string\">\"UTF-8\"</span>, <span class=\"number\">-1</span>)</div></pre></td></tr></table></figure>\n<p>使用strings包，替换“GBK”，相信根据参数顺序能看出各个参数的意义，最后一个参数：-1，为替换全部，即字符串中所有出现的第二个参数全部替换。</p>\n<h4 id=\"解析，转换，取值\"><a href=\"#解析，转换，取值\" class=\"headerlink\" title=\"解析，转换，取值\"></a>解析，转换，取值</h4><p>使用encoding/jon，go-simplejson包</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">//解析XML</span></div><div class=\"line\">err := xml.Unmarshal([]<span class=\"keyword\">byte</span>(xmlstr), &amp;result)</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">if</span> <span class=\"literal\">nil</span> != err &#123;</div><div class=\"line\">  log.Fatal(err)</div><div class=\"line\">&#125;</div><div class=\"line\">log.Printf(<span class=\"string\">\"XML:%v \\n\"</span>, result) </div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">//转换成JSON</span></div><div class=\"line\">res, err := json.Marshal(result)</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">if</span> <span class=\"literal\">nil</span> != err &#123;</div><div class=\"line\">  log.Fatal(err)</div><div class=\"line\">&#125;</div><div class=\"line\">log.Printf(<span class=\"string\">\"JSON:%s \\n\"</span>, res)</div><div class=\"line\"></div><div class=\"line\">js, err := simplejson.NewJson([]<span class=\"keyword\">byte</span>(res))</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">if</span> <span class=\"literal\">nil</span> != err &#123;</div><div class=\"line\">  log.Fatal(err)</div><div class=\"line\">&#125;</div><div class=\"line\">status, err := js.Get(<span class=\"string\">\"status\"</span>).Int()</div><div class=\"line\"></div><div class=\"line\">log.Printf(<span class=\"string\">\"STATUS:%v \\n\"</span>, status)</div></pre></td></tr></table></figure>\n<p>以上是本人在处理XML 转 JSON 时的解决办法，应该还有更简单更合适的方案。仅供参考。</p>\n<h4 id=\"完整代码：\"><a href=\"#完整代码：\" class=\"headerlink\" title=\"完整代码：\"></a>完整代码：</h4><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">package</span> main</div><div class=\"line\"><span class=\"keyword\">import</span> (</div><div class=\"line\">    <span class=\"string\">\"encoding/xml\"</span></div><div class=\"line\">    <span class=\"string\">\"encoding/json\"</span></div><div class=\"line\">    <span class=\"string\">\"log\"</span></div><div class=\"line\">    <span class=\"string\">\"strings\"</span></div><div class=\"line\">    simplejson <span class=\"string\">\"github.com/bitly/go-simplejson\"</span></div><div class=\"line\">)</div><div class=\"line\"><span class=\"keyword\">type</span> Response <span class=\"keyword\">struct</span> &#123;</div><div class=\"line\">    Status <span class=\"keyword\">int</span> <span class=\"string\">`xml:\"status\" json:\"status\"`</span></div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</div><div class=\"line\">    </div><div class=\"line\">    <span class=\"keyword\">var</span> result Response</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">//多行字符串，使用反引号`</span></div><div class=\"line\">    xmlstr := <span class=\"string\">`&lt;?xml version=\"1.0\" encoding=\"GBK\" ?&gt;</span></div><div class=\"line\"><span class=\"string\">&lt;response&gt;</span></div><div class=\"line\"><span class=\"string\">    &lt;status&gt;200&lt;/status&gt;</span></div><div class=\"line\"><span class=\"string\">&lt;/response&gt;`</span></div><div class=\"line\"></div><div class=\"line\">    xmlstr = strings.Replace(xmlstr, <span class=\"string\">\"GBK\"</span>, <span class=\"string\">\"UTF-8\"</span>, <span class=\"number\">-1</span>)</div><div class=\"line\"></div><div class=\"line\">    err := xml.Unmarshal([]<span class=\"keyword\">byte</span>(xmlstr), &amp;result)</div><div class=\"line\">    <span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</div><div class=\"line\">        log.Fatal(err)</div><div class=\"line\">    &#125;</div><div class=\"line\">    log.Printf(<span class=\"string\">\"XML:%v\"</span>,result)</div><div class=\"line\"></div><div class=\"line\">    r, err := json.Marshal(result)</div><div class=\"line\">    <span class=\"keyword\">if</span> <span class=\"literal\">nil</span> != err &#123;</div><div class=\"line\">        log.Fatal(err)</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    log.Printf(<span class=\"string\">\"JSON:%s\"</span>, r)</div><div class=\"line\"></div><div class=\"line\">    js, err := simplejson.NewJson([]<span class=\"keyword\">byte</span>(r))</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">if</span> <span class=\"literal\">nil</span> != err &#123;</div><div class=\"line\">        log.Fatal(err)</div><div class=\"line\">    &#125;</div><div class=\"line\">    status, err := js.Get(<span class=\"string\">\"status\"</span>).Int()</div><div class=\"line\">    log.Printf(<span class=\"string\">\"VALUE:%v\"</span>,status)</div><div class=\"line\"></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h4 id=\"发现问题：\"><a href=\"#发现问题：\" class=\"headerlink\" title=\"发现问题：\"></a>发现问题：</h4><p>今天（2016-09-18），再看这段代码，发现跟另一个程序里有些不一样。</p>\n<p>另一个程序里是这样的：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">type Response struct &#123;</div><div class=\"line\">    Status int `xml:&quot;status&quot;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>也可以正常返回值，但是在本文中的示例却不能正常输出status值，而是会输出空，看了半天发现，使用 log 时：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">log.Printf(&quot;VALUE:%v&quot;,status)</div></pre></td></tr></table></figure></p>\n<p>如果struct没有写<br>“json:”status””，就不能输出，如果换成fmt，struct就可以不写“json:”status”。结果是一样的，其中的原因还要再查资料研究下。</p>\n<p>参考文章：</p>\n<p><a href=\"http://blog.studygolang.com/2012/12/%e6%a0%87%e5%87%86%e5%ba%93-xml%e5%a4%84%e7%90%86%ef%bc%88%e4%b8%80%ef%bc%89/\" target=\"_blank\" rel=\"external\">标准库—XML处理（一）</a></p>\n<p><a href=\"https://play.golang.org/p/7HNLEUnX-m\" target=\"_blank\" rel=\"external\">https://play.golang.org/p/7HNLEUnX-m</a></p>\n<p><a href=\"https://play.golang.org/p/m99B12RaLe\" target=\"_blank\" rel=\"external\">https://play.golang.org/p/m99B12RaLe</a></p>\n<p><a href=\"https://astaxie.gitbooks.io/build-web-application-with-golang/content/zh/07.1.html\" target=\"_blank\" rel=\"external\">XML处理</a></p>\n"},{"title":"Laravel 手动创建分页","date":"2016-09-28T07:43:13.000Z","_content":"\n有些情况下会从接口读取数据，数据较多时会用到分页，Laravel为这种需求提供了很方便的方法。\n\n[官方文档](https://laravel.com/docs/5.2/pagination)里几句略过，并没有详细说明，经过查找资料，发现如下方法可行。\n\n### 首先use LengthAwarePaginator\n\n```php\nuse Illuminate\\Pagination\\LengthAwarePaginator;\nuse Illuminate\\Support\\Collection;\n```\n\n假设原内容是：\n\n```php\n$result = [\n    'item1',\n    'item2',\n    'item3',\n    'item4',\n    'item5',\n    'item6',\n];\n```\n\n对于一个列表来说，item一般会是个array，这里忽略。\n\n### 情况1，已知总数，只有部分数据\n由于本人所使用的接口有页码和每页数量的参数，所以每次查询返回的其实就是每一页的内容了，而接口又返回了符合条件的总数count，所以使用如下方式即可：\n\n```php\n$perPage = 10;\n$count = 100;//假设这里是接口返回的总数\n//创建collection\n$collection = new Collection($data);\n\n$currentPageResults = $collection->all();\n\n//生成分页\n$data = new LengthAwarePaginator($currentPageResults, $count, $perPage);\n//设置分页的链接\n$data->setPath($request->url());\n```\n\n### 情况2，未知总数，有全部数据\n而如果$data是全部数据呢，比如100条数据全部返回，然后要生成一个每页10条记录的分页，可以这样做：\n\n```php\n//获取当前页码\n$currentPage = LengthAwarePaginator::resolveCurrentPage();\n\n//从数组创建一个laravel collection\n$collection = new Collection($searchResults);\n\n//设置每页数量\n$perPage = 10;\n\n//从collection分割数据\n$currentPageSearchResults = $collection->slice($currentPage * $perPage, $perPage)->all();\n\n//生成分页\n$paginatedSearchResults= new LengthAwarePaginator($currentPageSearchResults, count($collection), $perPage);\n//设置分页的链接\n$data->setPath($request->url());\n```\n\n### 区别\n\n其实两者只是相差了一次分割数据。\n\n### 最后\n\n在视图里依然使用\n\n```\n{!! $data->render() !!}\n```\n\n输出分页组件。\n\n看起来还挺简单的。\n\n### 参考链接：\n\n[官方文档pagination](https://laravel.com/docs/5.2/pagination)\n\n[Custom data pagination with Laravel 5](http://psampaz.github.io/custom-data-pagination-with-laravel-5/)\n\n[CUSTOM PAGINATION VIEW IN LARAVEL 5 WITH ARRAYS](http://www.acekyd.com/2016/02/28/custom-pagination-view-in-laravel-5-with-arrays/)","source":"_posts/custom-data-pagination-in-laravel-with-arrays.md","raw":"title: Laravel 手动创建分页\ncategories: php\ndate: 2016-09-28 15:43:13\ntags:  [php,laravel]\n\n---\n\n有些情况下会从接口读取数据，数据较多时会用到分页，Laravel为这种需求提供了很方便的方法。\n\n[官方文档](https://laravel.com/docs/5.2/pagination)里几句略过，并没有详细说明，经过查找资料，发现如下方法可行。\n\n### 首先use LengthAwarePaginator\n\n```php\nuse Illuminate\\Pagination\\LengthAwarePaginator;\nuse Illuminate\\Support\\Collection;\n```\n\n假设原内容是：\n\n```php\n$result = [\n    'item1',\n    'item2',\n    'item3',\n    'item4',\n    'item5',\n    'item6',\n];\n```\n\n对于一个列表来说，item一般会是个array，这里忽略。\n\n### 情况1，已知总数，只有部分数据\n由于本人所使用的接口有页码和每页数量的参数，所以每次查询返回的其实就是每一页的内容了，而接口又返回了符合条件的总数count，所以使用如下方式即可：\n\n```php\n$perPage = 10;\n$count = 100;//假设这里是接口返回的总数\n//创建collection\n$collection = new Collection($data);\n\n$currentPageResults = $collection->all();\n\n//生成分页\n$data = new LengthAwarePaginator($currentPageResults, $count, $perPage);\n//设置分页的链接\n$data->setPath($request->url());\n```\n\n### 情况2，未知总数，有全部数据\n而如果$data是全部数据呢，比如100条数据全部返回，然后要生成一个每页10条记录的分页，可以这样做：\n\n```php\n//获取当前页码\n$currentPage = LengthAwarePaginator::resolveCurrentPage();\n\n//从数组创建一个laravel collection\n$collection = new Collection($searchResults);\n\n//设置每页数量\n$perPage = 10;\n\n//从collection分割数据\n$currentPageSearchResults = $collection->slice($currentPage * $perPage, $perPage)->all();\n\n//生成分页\n$paginatedSearchResults= new LengthAwarePaginator($currentPageSearchResults, count($collection), $perPage);\n//设置分页的链接\n$data->setPath($request->url());\n```\n\n### 区别\n\n其实两者只是相差了一次分割数据。\n\n### 最后\n\n在视图里依然使用\n\n```\n{!! $data->render() !!}\n```\n\n输出分页组件。\n\n看起来还挺简单的。\n\n### 参考链接：\n\n[官方文档pagination](https://laravel.com/docs/5.2/pagination)\n\n[Custom data pagination with Laravel 5](http://psampaz.github.io/custom-data-pagination-with-laravel-5/)\n\n[CUSTOM PAGINATION VIEW IN LARAVEL 5 WITH ARRAYS](http://www.acekyd.com/2016/02/28/custom-pagination-view-in-laravel-5-with-arrays/)","slug":"custom-data-pagination-in-laravel-with-arrays","published":1,"updated":"2016-10-30T02:43:04.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj830jvdk000uul0r54ell83a","content":"<p>有些情况下会从接口读取数据，数据较多时会用到分页，Laravel为这种需求提供了很方便的方法。</p>\n<p><a href=\"https://laravel.com/docs/5.2/pagination\" target=\"_blank\" rel=\"external\">官方文档</a>里几句略过，并没有详细说明，经过查找资料，发现如下方法可行。</p>\n<h3 id=\"首先use-LengthAwarePaginator\"><a href=\"#首先use-LengthAwarePaginator\" class=\"headerlink\" title=\"首先use LengthAwarePaginator\"></a>首先use LengthAwarePaginator</h3><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">use</span> <span class=\"title\">Illuminate</span>\\<span class=\"title\">Pagination</span>\\<span class=\"title\">LengthAwarePaginator</span>;</div><div class=\"line\"><span class=\"keyword\">use</span> <span class=\"title\">Illuminate</span>\\<span class=\"title\">Support</span>\\<span class=\"title\">Collection</span>;</div></pre></td></tr></table></figure>\n<p>假设原内容是：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\">$result = [</div><div class=\"line\">    <span class=\"string\">'item1'</span>,</div><div class=\"line\">    <span class=\"string\">'item2'</span>,</div><div class=\"line\">    <span class=\"string\">'item3'</span>,</div><div class=\"line\">    <span class=\"string\">'item4'</span>,</div><div class=\"line\">    <span class=\"string\">'item5'</span>,</div><div class=\"line\">    <span class=\"string\">'item6'</span>,</div><div class=\"line\">];</div></pre></td></tr></table></figure>\n<p>对于一个列表来说，item一般会是个array，这里忽略。</p>\n<h3 id=\"情况1，已知总数，只有部分数据\"><a href=\"#情况1，已知总数，只有部分数据\" class=\"headerlink\" title=\"情况1，已知总数，只有部分数据\"></a>情况1，已知总数，只有部分数据</h3><p>由于本人所使用的接口有页码和每页数量的参数，所以每次查询返回的其实就是每一页的内容了，而接口又返回了符合条件的总数count，所以使用如下方式即可：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div></pre></td><td class=\"code\"><pre><div class=\"line\">$perPage = <span class=\"number\">10</span>;</div><div class=\"line\">$count = <span class=\"number\">100</span>;<span class=\"comment\">//假设这里是接口返回的总数</span></div><div class=\"line\"><span class=\"comment\">//创建collection</span></div><div class=\"line\">$collection = <span class=\"keyword\">new</span> Collection($data);</div><div class=\"line\"></div><div class=\"line\">$currentPageResults = $collection-&gt;all();</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">//生成分页</span></div><div class=\"line\">$data = <span class=\"keyword\">new</span> LengthAwarePaginator($currentPageResults, $count, $perPage);</div><div class=\"line\"><span class=\"comment\">//设置分页的链接</span></div><div class=\"line\">$data-&gt;setPath($request-&gt;url());</div></pre></td></tr></table></figure>\n<h3 id=\"情况2，未知总数，有全部数据\"><a href=\"#情况2，未知总数，有全部数据\" class=\"headerlink\" title=\"情况2，未知总数，有全部数据\"></a>情况2，未知总数，有全部数据</h3><p>而如果$data是全部数据呢，比如100条数据全部返回，然后要生成一个每页10条记录的分页，可以这样做：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">//获取当前页码</span></div><div class=\"line\">$currentPage = LengthAwarePaginator::resolveCurrentPage();</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">//从数组创建一个laravel collection</span></div><div class=\"line\">$collection = <span class=\"keyword\">new</span> Collection($searchResults);</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">//设置每页数量</span></div><div class=\"line\">$perPage = <span class=\"number\">10</span>;</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">//从collection分割数据</span></div><div class=\"line\">$currentPageSearchResults = $collection-&gt;slice($currentPage * $perPage, $perPage)-&gt;all();</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">//生成分页</span></div><div class=\"line\">$paginatedSearchResults= <span class=\"keyword\">new</span> LengthAwarePaginator($currentPageSearchResults, count($collection), $perPage);</div><div class=\"line\"><span class=\"comment\">//设置分页的链接</span></div><div class=\"line\">$data-&gt;setPath($request-&gt;url());</div></pre></td></tr></table></figure>\n<h3 id=\"区别\"><a href=\"#区别\" class=\"headerlink\" title=\"区别\"></a>区别</h3><p>其实两者只是相差了一次分割数据。</p>\n<h3 id=\"最后\"><a href=\"#最后\" class=\"headerlink\" title=\"最后\"></a>最后</h3><p>在视图里依然使用</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">&#123;!! $data-&gt;render() !!&#125;</div></pre></td></tr></table></figure>\n<p>输出分页组件。</p>\n<p>看起来还挺简单的。</p>\n<h3 id=\"参考链接：\"><a href=\"#参考链接：\" class=\"headerlink\" title=\"参考链接：\"></a>参考链接：</h3><p><a href=\"https://laravel.com/docs/5.2/pagination\" target=\"_blank\" rel=\"external\">官方文档pagination</a></p>\n<p><a href=\"http://psampaz.github.io/custom-data-pagination-with-laravel-5/\" target=\"_blank\" rel=\"external\">Custom data pagination with Laravel 5</a></p>\n<p><a href=\"http://www.acekyd.com/2016/02/28/custom-pagination-view-in-laravel-5-with-arrays/\" target=\"_blank\" rel=\"external\">CUSTOM PAGINATION VIEW IN LARAVEL 5 WITH ARRAYS</a></p>\n","site":{"data":{}},"excerpt":"","more":"<p>有些情况下会从接口读取数据，数据较多时会用到分页，Laravel为这种需求提供了很方便的方法。</p>\n<p><a href=\"https://laravel.com/docs/5.2/pagination\" target=\"_blank\" rel=\"external\">官方文档</a>里几句略过，并没有详细说明，经过查找资料，发现如下方法可行。</p>\n<h3 id=\"首先use-LengthAwarePaginator\"><a href=\"#首先use-LengthAwarePaginator\" class=\"headerlink\" title=\"首先use LengthAwarePaginator\"></a>首先use LengthAwarePaginator</h3><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">use</span> <span class=\"title\">Illuminate</span>\\<span class=\"title\">Pagination</span>\\<span class=\"title\">LengthAwarePaginator</span>;</div><div class=\"line\"><span class=\"keyword\">use</span> <span class=\"title\">Illuminate</span>\\<span class=\"title\">Support</span>\\<span class=\"title\">Collection</span>;</div></pre></td></tr></table></figure>\n<p>假设原内容是：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\">$result = [</div><div class=\"line\">    <span class=\"string\">'item1'</span>,</div><div class=\"line\">    <span class=\"string\">'item2'</span>,</div><div class=\"line\">    <span class=\"string\">'item3'</span>,</div><div class=\"line\">    <span class=\"string\">'item4'</span>,</div><div class=\"line\">    <span class=\"string\">'item5'</span>,</div><div class=\"line\">    <span class=\"string\">'item6'</span>,</div><div class=\"line\">];</div></pre></td></tr></table></figure>\n<p>对于一个列表来说，item一般会是个array，这里忽略。</p>\n<h3 id=\"情况1，已知总数，只有部分数据\"><a href=\"#情况1，已知总数，只有部分数据\" class=\"headerlink\" title=\"情况1，已知总数，只有部分数据\"></a>情况1，已知总数，只有部分数据</h3><p>由于本人所使用的接口有页码和每页数量的参数，所以每次查询返回的其实就是每一页的内容了，而接口又返回了符合条件的总数count，所以使用如下方式即可：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div></pre></td><td class=\"code\"><pre><div class=\"line\">$perPage = <span class=\"number\">10</span>;</div><div class=\"line\">$count = <span class=\"number\">100</span>;<span class=\"comment\">//假设这里是接口返回的总数</span></div><div class=\"line\"><span class=\"comment\">//创建collection</span></div><div class=\"line\">$collection = <span class=\"keyword\">new</span> Collection($data);</div><div class=\"line\"></div><div class=\"line\">$currentPageResults = $collection-&gt;all();</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">//生成分页</span></div><div class=\"line\">$data = <span class=\"keyword\">new</span> LengthAwarePaginator($currentPageResults, $count, $perPage);</div><div class=\"line\"><span class=\"comment\">//设置分页的链接</span></div><div class=\"line\">$data-&gt;setPath($request-&gt;url());</div></pre></td></tr></table></figure>\n<h3 id=\"情况2，未知总数，有全部数据\"><a href=\"#情况2，未知总数，有全部数据\" class=\"headerlink\" title=\"情况2，未知总数，有全部数据\"></a>情况2，未知总数，有全部数据</h3><p>而如果$data是全部数据呢，比如100条数据全部返回，然后要生成一个每页10条记录的分页，可以这样做：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">//获取当前页码</span></div><div class=\"line\">$currentPage = LengthAwarePaginator::resolveCurrentPage();</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">//从数组创建一个laravel collection</span></div><div class=\"line\">$collection = <span class=\"keyword\">new</span> Collection($searchResults);</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">//设置每页数量</span></div><div class=\"line\">$perPage = <span class=\"number\">10</span>;</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">//从collection分割数据</span></div><div class=\"line\">$currentPageSearchResults = $collection-&gt;slice($currentPage * $perPage, $perPage)-&gt;all();</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">//生成分页</span></div><div class=\"line\">$paginatedSearchResults= <span class=\"keyword\">new</span> LengthAwarePaginator($currentPageSearchResults, count($collection), $perPage);</div><div class=\"line\"><span class=\"comment\">//设置分页的链接</span></div><div class=\"line\">$data-&gt;setPath($request-&gt;url());</div></pre></td></tr></table></figure>\n<h3 id=\"区别\"><a href=\"#区别\" class=\"headerlink\" title=\"区别\"></a>区别</h3><p>其实两者只是相差了一次分割数据。</p>\n<h3 id=\"最后\"><a href=\"#最后\" class=\"headerlink\" title=\"最后\"></a>最后</h3><p>在视图里依然使用</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">&#123;!! $data-&gt;render() !!&#125;</div></pre></td></tr></table></figure>\n<p>输出分页组件。</p>\n<p>看起来还挺简单的。</p>\n<h3 id=\"参考链接：\"><a href=\"#参考链接：\" class=\"headerlink\" title=\"参考链接：\"></a>参考链接：</h3><p><a href=\"https://laravel.com/docs/5.2/pagination\" target=\"_blank\" rel=\"external\">官方文档pagination</a></p>\n<p><a href=\"http://psampaz.github.io/custom-data-pagination-with-laravel-5/\" target=\"_blank\" rel=\"external\">Custom data pagination with Laravel 5</a></p>\n<p><a href=\"http://www.acekyd.com/2016/02/28/custom-pagination-view-in-laravel-5-with-arrays/\" target=\"_blank\" rel=\"external\">CUSTOM PAGINATION VIEW IN LARAVEL 5 WITH ARRAYS</a></p>\n"},{"title":"【译】使用Go和Angular通过WebSocket构建实时聊天应用","date":"2017-07-15T04:11:14.000Z","_content":"\n### 写在前面\n\n本文[原文](https://www.thepolyglotdeveloper.com/2016/12/create-real-time-chat-app-golang-angular-2-websockets/)，详细讲解了如何使用Go和Angular通过WebSocket构建实时聊天应用。\n\n#### 正文\n\n我最近听到很多关于WebSocket的东西，以及WebSocket如何在应用程序和服务器之间实现实时通信。WebSocket作为RESTful API的替代和补充，已经存在了很长时间。使用WebSocket可以做例如实时聊天，与IoT通信，游戏，和其他很多需要在客户端和服务器之间进行即时消息传递的东西。\n\n最近一段时间，我[使用了一个叫Socket.io的库，用来在Node.js中使用websockets](https://www.thepolyglotdeveloper.com/2016/01/create-a-real-time-chat-application-with-the-cean-stack-and-socket-io/)，但是当我真正使用Go以后，我打算研究一下如何在Go中使用WebSocket。\n\n通过本文，我们将学习如何创建一个聊天应用，其中客户端是一个 Angular 2 应用，服务端使用Go。\n\n#### 要求\n\n在这个应用中有很多操作，所以有一些必要的前提条件，如下所示：\n\n- [Go](https://golang.org/) 1.7+\n- [Node.js](https://nodejs.org/en/) 4.0+\n- [Angular2 CLI](https://cli.angular.io/)\n\n处理所有消息和客户端的聊天服务器使用Go编写。客户端前端使用 Angular 2编写，has a dependency of the Node Package Manager (NPM) which ships with Node.js.\n\n#### 创建Go聊天服务器\n\n我们打算先开发整个应用的服务器端部分，它需要依赖几个第三方的包。\n\n在命令行执行以下命令，下载第三方包：\n\n```go\n//Install Go Dependencies\ngo get github.com/gorilla/websocket\ngo get github.com/satori/go.uuid\n```\n\nwebsocket包的作者同时也是 [Mux](https://github.com/gorilla/mux) 这个路由包 的作者，我们还需要一个UUID包来分配每一个客户端的唯一ID。\n\n在 $GOPATH 目录创建一个新的项目，我自己的项目目录是 $GOPATH/src/github.com/nraboy/realtime-chat/main.go。\n\n在进行下一步之前，需要注意的是，我从 [Dinosaurs Code](https://dinosaurscode.xyz/go/2016/07/17/go-websockets-tutorial/) 和 [Gorilla websocket chat example](https://github.com/gorilla/websocket/tree/master/examples/chat)  获取了一部分Go 代码，为了避免剽窃的嫌疑，我使用了很多原始代码中的一部分，但我也为这个项目加入了很多自己的独特的东西。\n\n这次我们要做的聊天应用有3个结构体：\n\n```go\n// $GOPATH/src/github.com/nraboy/realtime-chat/main.go\ntype ClientManager struct {\n    clients    map[*Client]bool\n    broadcast  chan []byte\n    register   chan *Client\n    unregister chan *Client\n}\n \ntype Client struct {\n    id     string\n    socket *websocket.Conn\n    send   chan []byte\n}\n \ntype Message struct {\n    Sender    string `json:\"sender,omitempty\"`\n    Recipient string `json:\"recipient,omitempty\"`\n    Content   string `json:\"content,omitempty\"`\n}\n```\n\nClientManager用于管理所有已连接的客户端，尝试连接的客户端，已经断开连接等待删除的客户端，和所有已连接客户端收发的消息。\n\n每个客户端有一个唯一的ID，一个socket连接，和等待发送的消息。\n\n为了增加传递的数据的复杂性，消息将使用 JSON 格式。而不是传递一串不容易被理解，阅读的数据。使用JSON格式，我们可以使用元数据和其他有用的东西。每一条消息将包含发送消息的客户端，接收消息的客户端，和消息的实际内容。\n\n首先定义一个全局的ClientManager。\n\n```go\n//$GOPATH/src/github.com/nraboy/realtime-chat/main.go\nvar manager = ClientManager{\n    broadcast:  make(chan []byte),\n    register:   make(chan *Client),\n    unregister: make(chan *Client),\n    clients:    make(map[*Client]bool),\n}\n```\n\n服务器端将使用3个goroutine，一个用于管理客户端，一个用于读取websocket数据，另一个用于往websocket里写数据。这里指的是读取和写入的goroutine将为每个连接的客户端创建一个新的实例。所有的goroutine将循环运行直至不再需要。\n\n编写如下代码，来开始服务：\n\n```go\n//$GOPATH/src/github.com/nraboy/realtime-chat/main.go\nfunc (manager *ClientManager) start() {\n    for {\n        select {\n        case conn := <-manager.register:\n        \tmanager.clients[conn] = true\n        \tjsonMessage, _ := json.Marshal(&Message{Content: \"/A new socket has connected.\"})\n            manager.send(jsonMessage, conn)\n        case conn := <-manager.unregister:\n            if _, ok := manager.clients[conn]; ok {\n                close(conn.send)\n                delete(manager.clients, conn)\n                jsonMessage, _ := json.Marshal(&Message{Content: \"/A socket has disconnected.\"})\n                manager.send(jsonMessage, conn)\n            }\n        case message := <-manager.broadcast:\n            for conn := range manager.clients {\n                select {\n                case conn.send <- message:\n                default:\n                    close(conn.send)\n                    delete(manager.clients, conn)\n                }\n            }\n        }\n    }\n}\n```\n\n每当 manager.register 接收到数据，这个正在建立连接的客户端将会被添加到 manager (前文创建的 ClientManager 实例)的 clients 中。然后，将向所有其他客户端发送一条JSON消息。\n\n同时，如果客户端断开连接，manager.unregister channel将会收到消息，断开连接的客户端的 channel 中的数据将被关闭，客户端也会从manager中删除。然后发送消息给其他的客户端告知某个客户端已断开连接。\n\n如果 manager.broadcast channel 中存在数据，则表示正在尝试发送和接收消息。我们打算遍历每个已连接的客户端，将消息发送给它们。如果由于某些原因，channel 被阻塞或消息无法发送，我们会认为这个客户端已断开连接，然后将其删除。\n\n为了使代码简洁，创建一个 manager.send 方法遍历每个客户端。\n\n```go\n//$GOPATH/src/github.com/nraboy/realtime-chat/main.go\nfunc (manager *ClientManager) send(message []byte, ignore *Client) {\n    for conn := range manager.clients {\n        if conn != ignore {\n            conn.send <- message\n        }\n    }\n}\n```\n\n至于conn.send如何发送数据，会在后面探讨。\n\n现在我们可以探索 goroutine 如何读取客户端发送的 websocket 数据。这个 goroutine 的关键是读取 socket 数据，并将数据添加到 manager.boradcast 做进一步处理。\n\n```go\n//$GOPATH/src/github.com/nraboy/realtime-chat/main.go\nfunc (c *Client) read() {\n    defer func() {\n        manager.unregister <- c\n        c.socket.Close()\n    }()\n \n    for {\n        _, message, err := c.socket.ReadMessage()\n        if err != nil {\n            manager.unregister <- c\n            c.socket.Close()\n            break\n        }\n        jsonMessage, _ := json.Marshal(&Message{Sender: c.id, Content: string(message)})\n        manager.broadcast <- jsonMessage\n    }\n}\n```\n\n如果读取 websocket 数据出错，可能意味着客户端已经断开连接。如果是这样，我们需要从服务器中注销这个客户端。\n\n还记得前边的 conn.send 吗，它用来在第三个 goroutine 中写数据。\n\n```go\n//$GOPATH/src/github.com/nraboy/realtime-chat/main.go\nfunc (c *Client) write() {\n    defer func() {\n        c.socket.Close()\n    }()\n \n    for {\n        select {\n        case message, ok := <-c.send:\n            if !ok {\n                c.socket.WriteMessage(websocket.CloseMessage, []byte{})\n                return\n            }\n \n            c.socket.WriteMessage(websocket.TextMessage, message)\n        }\n    }\n}\n```\n\n如果 c.send channel有数据，我们将尝试发送这些数据。如果由于某些原因，channel 运行不正常，我们将向客户端发送断开连接的消息。\n\n那么，如何启动这些 goroutine 呢，当我们启动服务器时，服务器 goroutine 将会启动，当有客户端连接时，其他 goroutine 将会启动。\n\nmain方法中的代码：\n\n```go\n//$GOPATH/src/github.com/nraboy/realtime-chat/main.goGo\nfunc main() {\n    fmt.Println(\"Starting application...\")\n    go manager.start()\n    http.HandleFunc(\"/ws\", wsPage)\n    http.ListenAndServe(\":12345\", nil)\n}\n```\n\n我们在12345端口启动服务器，通过 websocket 连接访问。名为 wsPage 的方法如下所示：\n\n```go\n//$GOPATH/src/github.com/nraboy/realtime-chat/main.goGo\nfunc wsPage(res http.ResponseWriter, req *http.Request) {\n    conn, error := (&websocket.Upgrader{CheckOrigin: func(r *http.Request) bool { return true }}).Upgrade(res, req, nil)\n    if error != nil {\n        http.NotFound(res, req)\n        return\n    }\n    client := &Client{id: uuid.NewV4().String(), socket: conn, send: make(chan []byte)}\n \n    manager.register <- client\n \n    go client.read()\n    go client.write()\n}\n```\n\n通过使用 websocket 包将HTTP请求升级到websocket请求。通过添加 CheckOrigin ，我们可以接受来自外部域的请求，从而消除跨域资源共享（CORS）的错误。\n\n创建连接后，将创建一个客户端，并分配唯一的ID。如前所述，该客户端已经注册到服务器。客户端注册后，读写 goroutine 将被触发。\n\n此时，我们可以通过如下命令启动应用。\n\n```shell\n//Run Go Application\ngo run *.go\n```\n\n你不能在直接 web 浏览器中测试，但是可以建立一个 websocket 连接到 ws://localhost:12345/ws。\n\n#### 创建Angular2 聊天客户端\n\n现在我们需要创建一个客户端的应用，客户端可以发送和接收消息。假设您已经安装了[Angular 2 CLI](https://cli.angular.io/)，请执行以下操作：\n\n```shell\n//Create New Angular 2 Project\nng new SocketExample\n```\n\n执行完将会生成一个单页应用，而我们想要完成的内容，是下方的动图演示的这样。\n\n![](/images/go/golang-angular2-chat.gif)\n\n补充：此处需cd SocketExmapl && npm install。\n\nJavaScript的 websocket 在Angular 2提供的一个类中。使用 Angular 2 CLI，通过执行如下操作创建provider。\n\n```shell\n//Create Angular 2 Provider\nng g service socket\n```\n\n上述命令会在您的项目中创建 **src/app/socket.service.ts ** 和 **src/app/socket.service.spec.ts** 。spec文件用于单元测试，不在本文讨论范围内。打开 **src/app/socket.service.ts** 文件，编写以下 TypeScript 代码：\n\n```typescript\n//src/app/socket.service.ts\nimport { Injectable, EventEmitter } from '@angular/core';\n \n@Injectable()\nexport class SocketService {\n \n    private socket: WebSocket;\n    private listener: EventEmitter<any> = new EventEmitter();\n \n    public constructor() {\n        this.socket = new WebSocket(\"ws://localhost:12345/ws\");\n        this.socket.onopen = event => {\n            this.listener.emit({\"type\": \"open\", \"data\": event});\n        }\n        this.socket.onclose = event => {\n            this.listener.emit({\"type\": \"close\", \"data\": event});\n        }\n        this.socket.onmessage = event => {\n            this.listener.emit({\"type\": \"message\", \"data\": JSON.parse(event.data)});\n        }\n    }\n \n    public send(data: string) {\n        this.socket.send(data);\n    }\n \n    public close() {\n        this.socket.close();\n    }\n \n    public getEventListener() {\n        return this.listener;\n    }\n \n}\n```\n\n该提供者是可以注射的，并在触发某些事件事发送数据。在构造方法中，建立了与Go应用的WebSocket 连接，并创建了3个事件监听器。分别对应每个socket创建和销毁时，及接收到消息时。\n\nsend方法允许我们向Go应用发送消息，close方法用于通知Go应用我们将断开连接。\n\n提供者程序已创建，但是还不能在我们的的应用程序的任何文件中使用。因此，我们需要将其添加到 **src/app/app.module.ts** 文件的 @NgModule 块中。打开文件并输入：\n\n```typescript\n//src/app/app.module.ts\nimport { BrowserModule } from '@angular/platform-browser';\nimport { NgModule } from '@angular/core';\nimport { FormsModule } from '@angular/forms';\nimport { HttpModule } from '@angular/http';\n \nimport { AppComponent } from './app.component';\nimport { SocketService } from \"./socket.service\";\n \n@NgModule({\n    declarations: [\n        AppComponent\n    ],\n    imports: [\n        BrowserModule,\n        FormsModule,\n        HttpModule\n    ],\n    providers: [SocketService],\n    bootstrap: [AppComponent]\n})\nexport class AppModule { }\n```\n\n需要注意的是，此时我们已经将provider导入并且添加到 @NgModule 块的 providers数组中了。\n\n现在我们可以专注处理页面的逻辑了。打开 **src/app/app.component.ts** 文件，并输入以下代码：\n\n```typescript\n//src/app/app.component.ts\nimport { Component, OnInit, OnDestroy } from '@angular/core';\nimport { SocketService } from \"./socket.service\";\n \n@Component({\n    selector: 'app-root',\n    templateUrl: './app.component.html',\n    styleUrls: ['./app.component.css']\n})\nexport class AppComponent implements OnInit, OnDestroy {\n \n    public messages: Array<any>;\n    public chatBox: string;\n \n    public constructor(private socket: SocketService) {\n        this.messages = [];\n        this.chatBox = \"\";\n    }\n \n    public ngOnInit() {\n        this.socket.getEventListener().subscribe(event => {\n            if(event.type == \"message\") {\n                let data = event.data.content;\n                if(event.data.sender) {\n                    data = event.data.sender + \": \" + data;\n                }\n                this.messages.push(data);\n            }\n            if(event.type == \"close\") {\n                this.messages.push(\"/The socket connection has been closed\");\n            }\n            if(event.type == \"open\") {\n                this.messages.push(\"/The socket connection has been established\");\n            }\n        });\n    }\n \n    public ngOnDestroy() {\n        this.socket.close();\n    }\n \n    public send() {\n        if(this.chatBox) {\n            this.socket.send(this.chatBox);\n            this.chatBox = \"\";\n        }\n    }\n \n    public isSystemMessage(message: string) {\n        return message.startsWith(\"/\") ? \"<strong>\" + message.substring(1) + \"</strong>\" : message;\n    }\n \n}\n```\n\n在上述 AppComponent类的构造方法中，我们注册服务提供者并初始化需要绑定到UI的变量。在构造函数中加载或订阅不太好，我们使用ngOninit方法来代替。\n\n```typescript\n//src/app/app.component.ts\npublic ngOnInit() {\n    this.socket.getEventListener().subscribe(event => {\n        if(event.type == \"message\") {\n            let data = event.data.content;\n            if(event.data.sender) {\n                data = event.data.sender + \": \" + data;\n            }\n            this.messages.push(data);\n        }\n        if(event.type == \"close\") {\n            this.messages.push(\"/The socket connection has been closed\");\n        }\n        if(event.type == \"open\") {\n            this.messages.push(\"/The socket connection has been established\");\n        }\n    });\n}\n```\n\n在上述方法中，我们订阅了在provider中创建的事件监听器。在这里我们需要检查发生了什么事件。如果是一条消息，需要检查是否存在发件人，然后将其添加到消息中。\n\n你可能注意到了，一些消息是以斜线开始的。用来表示系统消息，稍后会将其加粗。\n\n当客户端断开时，关闭事件将会发送到服务器，如果消息已经发送，它也会被发送到服务器。\n\n在查看HTML之前，先添加一些CSS，使其看起来更像一个聊天应用。打开 **src/style.css**，输入以下内容：\n\n```css\n/*src/styles.css*/\n/* You can add global styles to this file, and also import other style files */\n* { margin: 0; padding: 0; box-sizing: border-box; }\nbody { font: 13px Helvetica, Arial; }\nform { background: #000; padding: 3px; position: fixed; bottom: 0; width: 100%; }\nform input { border: 0; padding: 10px; width: 90%; margin-right: .5%; }\nform button { width: 9%; background: rgb(130, 224, 255); border: none; padding: 10px; }\n#messages { list-style-type: none; margin: 0; padding: 0; }\n#messages li { padding: 5px 10px; }\n#messages li:nth-child(odd) { background: #eee; }\n```\n\n现在，需要处理下HTML了。打开 **src/app/app.component.html** 文件，并输入以下内容：\n\n```html\n<!--src/app/app.component.html-->\n<ul id=\"messages\">\n    <li *ngFor=\"let message of messages\">\n        <span [innerHTML]=\"isSystemMessage(message)\"></span>\n    </li>\n</ul>\n<form action=\"\">\n    <input [(ngModel)]=\"chatBox\" [ngModelOptions]=\"{standalone: true}\" autocomplete=\"off\" />\n    <button (click)=\"send()\">Send</button>\n</form>\n```\n\n这里我们只是简单的将消息数组遍历到屏幕上 。以斜线开头的消息将会被加粗。提交按钮绑定到了send方法中，当按下时，会提交输入框中的内容到Go应用。\n\n#### 结语\n\n刚刚演示了如何使用 Go 和 Angular 2 创建一个 WebSocket 实时聊天应用。虽然没有在这个示例中存储聊天记录，但是这套逻辑可以应用于更复杂的项目，比如游戏，IOT，和其他很多场景。\n\n#### 关于原作者\n\n[Nic Raboy](https://www.thepolyglotdeveloper.com/author/nraboy/)是现代网络和移动开发技术的倡导者。 他在Java，JavaScript，Golang以及各种框架（如Angular，NativeScript和Apache Cordova）方面拥有丰富的经验。 Nic写作的内容主要是他在使Web和移动开发更容易理解相关方面的经验。\n\n","source":"_posts/create-real-time-chat-app-golang-angular-2-websockets.md","raw":"title: 【译】使用Go和Angular通过WebSocket构建实时聊天应用\ncategories: golang\ndate: 2017-07-15 12:11:14\ntags:  [go]\n\n---\n\n### 写在前面\n\n本文[原文](https://www.thepolyglotdeveloper.com/2016/12/create-real-time-chat-app-golang-angular-2-websockets/)，详细讲解了如何使用Go和Angular通过WebSocket构建实时聊天应用。\n\n#### 正文\n\n我最近听到很多关于WebSocket的东西，以及WebSocket如何在应用程序和服务器之间实现实时通信。WebSocket作为RESTful API的替代和补充，已经存在了很长时间。使用WebSocket可以做例如实时聊天，与IoT通信，游戏，和其他很多需要在客户端和服务器之间进行即时消息传递的东西。\n\n最近一段时间，我[使用了一个叫Socket.io的库，用来在Node.js中使用websockets](https://www.thepolyglotdeveloper.com/2016/01/create-a-real-time-chat-application-with-the-cean-stack-and-socket-io/)，但是当我真正使用Go以后，我打算研究一下如何在Go中使用WebSocket。\n\n通过本文，我们将学习如何创建一个聊天应用，其中客户端是一个 Angular 2 应用，服务端使用Go。\n\n#### 要求\n\n在这个应用中有很多操作，所以有一些必要的前提条件，如下所示：\n\n- [Go](https://golang.org/) 1.7+\n- [Node.js](https://nodejs.org/en/) 4.0+\n- [Angular2 CLI](https://cli.angular.io/)\n\n处理所有消息和客户端的聊天服务器使用Go编写。客户端前端使用 Angular 2编写，has a dependency of the Node Package Manager (NPM) which ships with Node.js.\n\n#### 创建Go聊天服务器\n\n我们打算先开发整个应用的服务器端部分，它需要依赖几个第三方的包。\n\n在命令行执行以下命令，下载第三方包：\n\n```go\n//Install Go Dependencies\ngo get github.com/gorilla/websocket\ngo get github.com/satori/go.uuid\n```\n\nwebsocket包的作者同时也是 [Mux](https://github.com/gorilla/mux) 这个路由包 的作者，我们还需要一个UUID包来分配每一个客户端的唯一ID。\n\n在 $GOPATH 目录创建一个新的项目，我自己的项目目录是 $GOPATH/src/github.com/nraboy/realtime-chat/main.go。\n\n在进行下一步之前，需要注意的是，我从 [Dinosaurs Code](https://dinosaurscode.xyz/go/2016/07/17/go-websockets-tutorial/) 和 [Gorilla websocket chat example](https://github.com/gorilla/websocket/tree/master/examples/chat)  获取了一部分Go 代码，为了避免剽窃的嫌疑，我使用了很多原始代码中的一部分，但我也为这个项目加入了很多自己的独特的东西。\n\n这次我们要做的聊天应用有3个结构体：\n\n```go\n// $GOPATH/src/github.com/nraboy/realtime-chat/main.go\ntype ClientManager struct {\n    clients    map[*Client]bool\n    broadcast  chan []byte\n    register   chan *Client\n    unregister chan *Client\n}\n \ntype Client struct {\n    id     string\n    socket *websocket.Conn\n    send   chan []byte\n}\n \ntype Message struct {\n    Sender    string `json:\"sender,omitempty\"`\n    Recipient string `json:\"recipient,omitempty\"`\n    Content   string `json:\"content,omitempty\"`\n}\n```\n\nClientManager用于管理所有已连接的客户端，尝试连接的客户端，已经断开连接等待删除的客户端，和所有已连接客户端收发的消息。\n\n每个客户端有一个唯一的ID，一个socket连接，和等待发送的消息。\n\n为了增加传递的数据的复杂性，消息将使用 JSON 格式。而不是传递一串不容易被理解，阅读的数据。使用JSON格式，我们可以使用元数据和其他有用的东西。每一条消息将包含发送消息的客户端，接收消息的客户端，和消息的实际内容。\n\n首先定义一个全局的ClientManager。\n\n```go\n//$GOPATH/src/github.com/nraboy/realtime-chat/main.go\nvar manager = ClientManager{\n    broadcast:  make(chan []byte),\n    register:   make(chan *Client),\n    unregister: make(chan *Client),\n    clients:    make(map[*Client]bool),\n}\n```\n\n服务器端将使用3个goroutine，一个用于管理客户端，一个用于读取websocket数据，另一个用于往websocket里写数据。这里指的是读取和写入的goroutine将为每个连接的客户端创建一个新的实例。所有的goroutine将循环运行直至不再需要。\n\n编写如下代码，来开始服务：\n\n```go\n//$GOPATH/src/github.com/nraboy/realtime-chat/main.go\nfunc (manager *ClientManager) start() {\n    for {\n        select {\n        case conn := <-manager.register:\n        \tmanager.clients[conn] = true\n        \tjsonMessage, _ := json.Marshal(&Message{Content: \"/A new socket has connected.\"})\n            manager.send(jsonMessage, conn)\n        case conn := <-manager.unregister:\n            if _, ok := manager.clients[conn]; ok {\n                close(conn.send)\n                delete(manager.clients, conn)\n                jsonMessage, _ := json.Marshal(&Message{Content: \"/A socket has disconnected.\"})\n                manager.send(jsonMessage, conn)\n            }\n        case message := <-manager.broadcast:\n            for conn := range manager.clients {\n                select {\n                case conn.send <- message:\n                default:\n                    close(conn.send)\n                    delete(manager.clients, conn)\n                }\n            }\n        }\n    }\n}\n```\n\n每当 manager.register 接收到数据，这个正在建立连接的客户端将会被添加到 manager (前文创建的 ClientManager 实例)的 clients 中。然后，将向所有其他客户端发送一条JSON消息。\n\n同时，如果客户端断开连接，manager.unregister channel将会收到消息，断开连接的客户端的 channel 中的数据将被关闭，客户端也会从manager中删除。然后发送消息给其他的客户端告知某个客户端已断开连接。\n\n如果 manager.broadcast channel 中存在数据，则表示正在尝试发送和接收消息。我们打算遍历每个已连接的客户端，将消息发送给它们。如果由于某些原因，channel 被阻塞或消息无法发送，我们会认为这个客户端已断开连接，然后将其删除。\n\n为了使代码简洁，创建一个 manager.send 方法遍历每个客户端。\n\n```go\n//$GOPATH/src/github.com/nraboy/realtime-chat/main.go\nfunc (manager *ClientManager) send(message []byte, ignore *Client) {\n    for conn := range manager.clients {\n        if conn != ignore {\n            conn.send <- message\n        }\n    }\n}\n```\n\n至于conn.send如何发送数据，会在后面探讨。\n\n现在我们可以探索 goroutine 如何读取客户端发送的 websocket 数据。这个 goroutine 的关键是读取 socket 数据，并将数据添加到 manager.boradcast 做进一步处理。\n\n```go\n//$GOPATH/src/github.com/nraboy/realtime-chat/main.go\nfunc (c *Client) read() {\n    defer func() {\n        manager.unregister <- c\n        c.socket.Close()\n    }()\n \n    for {\n        _, message, err := c.socket.ReadMessage()\n        if err != nil {\n            manager.unregister <- c\n            c.socket.Close()\n            break\n        }\n        jsonMessage, _ := json.Marshal(&Message{Sender: c.id, Content: string(message)})\n        manager.broadcast <- jsonMessage\n    }\n}\n```\n\n如果读取 websocket 数据出错，可能意味着客户端已经断开连接。如果是这样，我们需要从服务器中注销这个客户端。\n\n还记得前边的 conn.send 吗，它用来在第三个 goroutine 中写数据。\n\n```go\n//$GOPATH/src/github.com/nraboy/realtime-chat/main.go\nfunc (c *Client) write() {\n    defer func() {\n        c.socket.Close()\n    }()\n \n    for {\n        select {\n        case message, ok := <-c.send:\n            if !ok {\n                c.socket.WriteMessage(websocket.CloseMessage, []byte{})\n                return\n            }\n \n            c.socket.WriteMessage(websocket.TextMessage, message)\n        }\n    }\n}\n```\n\n如果 c.send channel有数据，我们将尝试发送这些数据。如果由于某些原因，channel 运行不正常，我们将向客户端发送断开连接的消息。\n\n那么，如何启动这些 goroutine 呢，当我们启动服务器时，服务器 goroutine 将会启动，当有客户端连接时，其他 goroutine 将会启动。\n\nmain方法中的代码：\n\n```go\n//$GOPATH/src/github.com/nraboy/realtime-chat/main.goGo\nfunc main() {\n    fmt.Println(\"Starting application...\")\n    go manager.start()\n    http.HandleFunc(\"/ws\", wsPage)\n    http.ListenAndServe(\":12345\", nil)\n}\n```\n\n我们在12345端口启动服务器，通过 websocket 连接访问。名为 wsPage 的方法如下所示：\n\n```go\n//$GOPATH/src/github.com/nraboy/realtime-chat/main.goGo\nfunc wsPage(res http.ResponseWriter, req *http.Request) {\n    conn, error := (&websocket.Upgrader{CheckOrigin: func(r *http.Request) bool { return true }}).Upgrade(res, req, nil)\n    if error != nil {\n        http.NotFound(res, req)\n        return\n    }\n    client := &Client{id: uuid.NewV4().String(), socket: conn, send: make(chan []byte)}\n \n    manager.register <- client\n \n    go client.read()\n    go client.write()\n}\n```\n\n通过使用 websocket 包将HTTP请求升级到websocket请求。通过添加 CheckOrigin ，我们可以接受来自外部域的请求，从而消除跨域资源共享（CORS）的错误。\n\n创建连接后，将创建一个客户端，并分配唯一的ID。如前所述，该客户端已经注册到服务器。客户端注册后，读写 goroutine 将被触发。\n\n此时，我们可以通过如下命令启动应用。\n\n```shell\n//Run Go Application\ngo run *.go\n```\n\n你不能在直接 web 浏览器中测试，但是可以建立一个 websocket 连接到 ws://localhost:12345/ws。\n\n#### 创建Angular2 聊天客户端\n\n现在我们需要创建一个客户端的应用，客户端可以发送和接收消息。假设您已经安装了[Angular 2 CLI](https://cli.angular.io/)，请执行以下操作：\n\n```shell\n//Create New Angular 2 Project\nng new SocketExample\n```\n\n执行完将会生成一个单页应用，而我们想要完成的内容，是下方的动图演示的这样。\n\n![](/images/go/golang-angular2-chat.gif)\n\n补充：此处需cd SocketExmapl && npm install。\n\nJavaScript的 websocket 在Angular 2提供的一个类中。使用 Angular 2 CLI，通过执行如下操作创建provider。\n\n```shell\n//Create Angular 2 Provider\nng g service socket\n```\n\n上述命令会在您的项目中创建 **src/app/socket.service.ts ** 和 **src/app/socket.service.spec.ts** 。spec文件用于单元测试，不在本文讨论范围内。打开 **src/app/socket.service.ts** 文件，编写以下 TypeScript 代码：\n\n```typescript\n//src/app/socket.service.ts\nimport { Injectable, EventEmitter } from '@angular/core';\n \n@Injectable()\nexport class SocketService {\n \n    private socket: WebSocket;\n    private listener: EventEmitter<any> = new EventEmitter();\n \n    public constructor() {\n        this.socket = new WebSocket(\"ws://localhost:12345/ws\");\n        this.socket.onopen = event => {\n            this.listener.emit({\"type\": \"open\", \"data\": event});\n        }\n        this.socket.onclose = event => {\n            this.listener.emit({\"type\": \"close\", \"data\": event});\n        }\n        this.socket.onmessage = event => {\n            this.listener.emit({\"type\": \"message\", \"data\": JSON.parse(event.data)});\n        }\n    }\n \n    public send(data: string) {\n        this.socket.send(data);\n    }\n \n    public close() {\n        this.socket.close();\n    }\n \n    public getEventListener() {\n        return this.listener;\n    }\n \n}\n```\n\n该提供者是可以注射的，并在触发某些事件事发送数据。在构造方法中，建立了与Go应用的WebSocket 连接，并创建了3个事件监听器。分别对应每个socket创建和销毁时，及接收到消息时。\n\nsend方法允许我们向Go应用发送消息，close方法用于通知Go应用我们将断开连接。\n\n提供者程序已创建，但是还不能在我们的的应用程序的任何文件中使用。因此，我们需要将其添加到 **src/app/app.module.ts** 文件的 @NgModule 块中。打开文件并输入：\n\n```typescript\n//src/app/app.module.ts\nimport { BrowserModule } from '@angular/platform-browser';\nimport { NgModule } from '@angular/core';\nimport { FormsModule } from '@angular/forms';\nimport { HttpModule } from '@angular/http';\n \nimport { AppComponent } from './app.component';\nimport { SocketService } from \"./socket.service\";\n \n@NgModule({\n    declarations: [\n        AppComponent\n    ],\n    imports: [\n        BrowserModule,\n        FormsModule,\n        HttpModule\n    ],\n    providers: [SocketService],\n    bootstrap: [AppComponent]\n})\nexport class AppModule { }\n```\n\n需要注意的是，此时我们已经将provider导入并且添加到 @NgModule 块的 providers数组中了。\n\n现在我们可以专注处理页面的逻辑了。打开 **src/app/app.component.ts** 文件，并输入以下代码：\n\n```typescript\n//src/app/app.component.ts\nimport { Component, OnInit, OnDestroy } from '@angular/core';\nimport { SocketService } from \"./socket.service\";\n \n@Component({\n    selector: 'app-root',\n    templateUrl: './app.component.html',\n    styleUrls: ['./app.component.css']\n})\nexport class AppComponent implements OnInit, OnDestroy {\n \n    public messages: Array<any>;\n    public chatBox: string;\n \n    public constructor(private socket: SocketService) {\n        this.messages = [];\n        this.chatBox = \"\";\n    }\n \n    public ngOnInit() {\n        this.socket.getEventListener().subscribe(event => {\n            if(event.type == \"message\") {\n                let data = event.data.content;\n                if(event.data.sender) {\n                    data = event.data.sender + \": \" + data;\n                }\n                this.messages.push(data);\n            }\n            if(event.type == \"close\") {\n                this.messages.push(\"/The socket connection has been closed\");\n            }\n            if(event.type == \"open\") {\n                this.messages.push(\"/The socket connection has been established\");\n            }\n        });\n    }\n \n    public ngOnDestroy() {\n        this.socket.close();\n    }\n \n    public send() {\n        if(this.chatBox) {\n            this.socket.send(this.chatBox);\n            this.chatBox = \"\";\n        }\n    }\n \n    public isSystemMessage(message: string) {\n        return message.startsWith(\"/\") ? \"<strong>\" + message.substring(1) + \"</strong>\" : message;\n    }\n \n}\n```\n\n在上述 AppComponent类的构造方法中，我们注册服务提供者并初始化需要绑定到UI的变量。在构造函数中加载或订阅不太好，我们使用ngOninit方法来代替。\n\n```typescript\n//src/app/app.component.ts\npublic ngOnInit() {\n    this.socket.getEventListener().subscribe(event => {\n        if(event.type == \"message\") {\n            let data = event.data.content;\n            if(event.data.sender) {\n                data = event.data.sender + \": \" + data;\n            }\n            this.messages.push(data);\n        }\n        if(event.type == \"close\") {\n            this.messages.push(\"/The socket connection has been closed\");\n        }\n        if(event.type == \"open\") {\n            this.messages.push(\"/The socket connection has been established\");\n        }\n    });\n}\n```\n\n在上述方法中，我们订阅了在provider中创建的事件监听器。在这里我们需要检查发生了什么事件。如果是一条消息，需要检查是否存在发件人，然后将其添加到消息中。\n\n你可能注意到了，一些消息是以斜线开始的。用来表示系统消息，稍后会将其加粗。\n\n当客户端断开时，关闭事件将会发送到服务器，如果消息已经发送，它也会被发送到服务器。\n\n在查看HTML之前，先添加一些CSS，使其看起来更像一个聊天应用。打开 **src/style.css**，输入以下内容：\n\n```css\n/*src/styles.css*/\n/* You can add global styles to this file, and also import other style files */\n* { margin: 0; padding: 0; box-sizing: border-box; }\nbody { font: 13px Helvetica, Arial; }\nform { background: #000; padding: 3px; position: fixed; bottom: 0; width: 100%; }\nform input { border: 0; padding: 10px; width: 90%; margin-right: .5%; }\nform button { width: 9%; background: rgb(130, 224, 255); border: none; padding: 10px; }\n#messages { list-style-type: none; margin: 0; padding: 0; }\n#messages li { padding: 5px 10px; }\n#messages li:nth-child(odd) { background: #eee; }\n```\n\n现在，需要处理下HTML了。打开 **src/app/app.component.html** 文件，并输入以下内容：\n\n```html\n<!--src/app/app.component.html-->\n<ul id=\"messages\">\n    <li *ngFor=\"let message of messages\">\n        <span [innerHTML]=\"isSystemMessage(message)\"></span>\n    </li>\n</ul>\n<form action=\"\">\n    <input [(ngModel)]=\"chatBox\" [ngModelOptions]=\"{standalone: true}\" autocomplete=\"off\" />\n    <button (click)=\"send()\">Send</button>\n</form>\n```\n\n这里我们只是简单的将消息数组遍历到屏幕上 。以斜线开头的消息将会被加粗。提交按钮绑定到了send方法中，当按下时，会提交输入框中的内容到Go应用。\n\n#### 结语\n\n刚刚演示了如何使用 Go 和 Angular 2 创建一个 WebSocket 实时聊天应用。虽然没有在这个示例中存储聊天记录，但是这套逻辑可以应用于更复杂的项目，比如游戏，IOT，和其他很多场景。\n\n#### 关于原作者\n\n[Nic Raboy](https://www.thepolyglotdeveloper.com/author/nraboy/)是现代网络和移动开发技术的倡导者。 他在Java，JavaScript，Golang以及各种框架（如Angular，NativeScript和Apache Cordova）方面拥有丰富的经验。 Nic写作的内容主要是他在使Web和移动开发更容易理解相关方面的经验。\n\n","slug":"create-real-time-chat-app-golang-angular-2-websockets","published":1,"updated":"2017-07-15T04:14:29.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj830jvdn000zul0r0okrn9sk","content":"<h3 id=\"写在前面\"><a href=\"#写在前面\" class=\"headerlink\" title=\"写在前面\"></a>写在前面</h3><p>本文<a href=\"https://www.thepolyglotdeveloper.com/2016/12/create-real-time-chat-app-golang-angular-2-websockets/\" target=\"_blank\" rel=\"external\">原文</a>，详细讲解了如何使用Go和Angular通过WebSocket构建实时聊天应用。</p>\n<h4 id=\"正文\"><a href=\"#正文\" class=\"headerlink\" title=\"正文\"></a>正文</h4><p>我最近听到很多关于WebSocket的东西，以及WebSocket如何在应用程序和服务器之间实现实时通信。WebSocket作为RESTful API的替代和补充，已经存在了很长时间。使用WebSocket可以做例如实时聊天，与IoT通信，游戏，和其他很多需要在客户端和服务器之间进行即时消息传递的东西。</p>\n<p>最近一段时间，我<a href=\"https://www.thepolyglotdeveloper.com/2016/01/create-a-real-time-chat-application-with-the-cean-stack-and-socket-io/\" target=\"_blank\" rel=\"external\">使用了一个叫Socket.io的库，用来在Node.js中使用websockets</a>，但是当我真正使用Go以后，我打算研究一下如何在Go中使用WebSocket。</p>\n<p>通过本文，我们将学习如何创建一个聊天应用，其中客户端是一个 Angular 2 应用，服务端使用Go。</p>\n<h4 id=\"要求\"><a href=\"#要求\" class=\"headerlink\" title=\"要求\"></a>要求</h4><p>在这个应用中有很多操作，所以有一些必要的前提条件，如下所示：</p>\n<ul>\n<li><a href=\"https://golang.org/\" target=\"_blank\" rel=\"external\">Go</a> 1.7+</li>\n<li><a href=\"https://nodejs.org/en/\" target=\"_blank\" rel=\"external\">Node.js</a> 4.0+</li>\n<li><a href=\"https://cli.angular.io/\" target=\"_blank\" rel=\"external\">Angular2 CLI</a></li>\n</ul>\n<p>处理所有消息和客户端的聊天服务器使用Go编写。客户端前端使用 Angular 2编写，has a dependency of the Node Package Manager (NPM) which ships with Node.js.</p>\n<h4 id=\"创建Go聊天服务器\"><a href=\"#创建Go聊天服务器\" class=\"headerlink\" title=\"创建Go聊天服务器\"></a>创建Go聊天服务器</h4><p>我们打算先开发整个应用的服务器端部分，它需要依赖几个第三方的包。</p>\n<p>在命令行执行以下命令，下载第三方包：</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">//Install Go Dependencies</span></div><div class=\"line\"><span class=\"keyword\">go</span> get github.com/gorilla/websocket</div><div class=\"line\"><span class=\"keyword\">go</span> get github.com/satori/<span class=\"keyword\">go</span>.uuid</div></pre></td></tr></table></figure>\n<p>websocket包的作者同时也是 <a href=\"https://github.com/gorilla/mux\" target=\"_blank\" rel=\"external\">Mux</a> 这个路由包 的作者，我们还需要一个UUID包来分配每一个客户端的唯一ID。</p>\n<p>在 $GOPATH 目录创建一个新的项目，我自己的项目目录是 $GOPATH/src/github.com/nraboy/realtime-chat/main.go。</p>\n<p>在进行下一步之前，需要注意的是，我从 <a href=\"https://dinosaurscode.xyz/go/2016/07/17/go-websockets-tutorial/\" target=\"_blank\" rel=\"external\">Dinosaurs Code</a> 和 <a href=\"https://github.com/gorilla/websocket/tree/master/examples/chat\" target=\"_blank\" rel=\"external\">Gorilla websocket chat example</a>  获取了一部分Go 代码，为了避免剽窃的嫌疑，我使用了很多原始代码中的一部分，但我也为这个项目加入了很多自己的独特的东西。</p>\n<p>这次我们要做的聊天应用有3个结构体：</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">// $GOPATH/src/github.com/nraboy/realtime-chat/main.go</span></div><div class=\"line\"><span class=\"keyword\">type</span> ClientManager <span class=\"keyword\">struct</span> &#123;</div><div class=\"line\">    clients    <span class=\"keyword\">map</span>[*Client]<span class=\"keyword\">bool</span></div><div class=\"line\">    broadcast  <span class=\"keyword\">chan</span> []<span class=\"keyword\">byte</span></div><div class=\"line\">    register   <span class=\"keyword\">chan</span> *Client</div><div class=\"line\">    unregister <span class=\"keyword\">chan</span> *Client</div><div class=\"line\">&#125;</div><div class=\"line\"> </div><div class=\"line\"><span class=\"keyword\">type</span> Client <span class=\"keyword\">struct</span> &#123;</div><div class=\"line\">    id     <span class=\"keyword\">string</span></div><div class=\"line\">    socket *websocket.Conn</div><div class=\"line\">    send   <span class=\"keyword\">chan</span> []<span class=\"keyword\">byte</span></div><div class=\"line\">&#125;</div><div class=\"line\"> </div><div class=\"line\"><span class=\"keyword\">type</span> Message <span class=\"keyword\">struct</span> &#123;</div><div class=\"line\">    Sender    <span class=\"keyword\">string</span> <span class=\"string\">`json:\"sender,omitempty\"`</span></div><div class=\"line\">    Recipient <span class=\"keyword\">string</span> <span class=\"string\">`json:\"recipient,omitempty\"`</span></div><div class=\"line\">    Content   <span class=\"keyword\">string</span> <span class=\"string\">`json:\"content,omitempty\"`</span></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>ClientManager用于管理所有已连接的客户端，尝试连接的客户端，已经断开连接等待删除的客户端，和所有已连接客户端收发的消息。</p>\n<p>每个客户端有一个唯一的ID，一个socket连接，和等待发送的消息。</p>\n<p>为了增加传递的数据的复杂性，消息将使用 JSON 格式。而不是传递一串不容易被理解，阅读的数据。使用JSON格式，我们可以使用元数据和其他有用的东西。每一条消息将包含发送消息的客户端，接收消息的客户端，和消息的实际内容。</p>\n<p>首先定义一个全局的ClientManager。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">//$GOPATH/src/github.com/nraboy/realtime-chat/main.go</span></div><div class=\"line\"><span class=\"keyword\">var</span> manager = ClientManager&#123;</div><div class=\"line\">    broadcast:  <span class=\"built_in\">make</span>(<span class=\"keyword\">chan</span> []<span class=\"keyword\">byte</span>),</div><div class=\"line\">    register:   <span class=\"built_in\">make</span>(<span class=\"keyword\">chan</span> *Client),</div><div class=\"line\">    unregister: <span class=\"built_in\">make</span>(<span class=\"keyword\">chan</span> *Client),</div><div class=\"line\">    clients:    <span class=\"built_in\">make</span>(<span class=\"keyword\">map</span>[*Client]<span class=\"keyword\">bool</span>),</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>服务器端将使用3个goroutine，一个用于管理客户端，一个用于读取websocket数据，另一个用于往websocket里写数据。这里指的是读取和写入的goroutine将为每个连接的客户端创建一个新的实例。所有的goroutine将循环运行直至不再需要。</p>\n<p>编写如下代码，来开始服务：</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">//$GOPATH/src/github.com/nraboy/realtime-chat/main.go</span></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(manager *ClientManager)</span> <span class=\"title\">start</span><span class=\"params\">()</span></span> &#123;</div><div class=\"line\">    <span class=\"keyword\">for</span> &#123;</div><div class=\"line\">        <span class=\"keyword\">select</span> &#123;</div><div class=\"line\">        <span class=\"keyword\">case</span> conn := &lt;-manager.register:</div><div class=\"line\">        \tmanager.clients[conn] = <span class=\"literal\">true</span></div><div class=\"line\">        \tjsonMessage, _ := json.Marshal(&amp;Message&#123;Content: <span class=\"string\">\"/A new socket has connected.\"</span>&#125;)</div><div class=\"line\">            manager.send(jsonMessage, conn)</div><div class=\"line\">        <span class=\"keyword\">case</span> conn := &lt;-manager.unregister:</div><div class=\"line\">            <span class=\"keyword\">if</span> _, ok := manager.clients[conn]; ok &#123;</div><div class=\"line\">                <span class=\"built_in\">close</span>(conn.send)</div><div class=\"line\">                <span class=\"built_in\">delete</span>(manager.clients, conn)</div><div class=\"line\">                jsonMessage, _ := json.Marshal(&amp;Message&#123;Content: <span class=\"string\">\"/A socket has disconnected.\"</span>&#125;)</div><div class=\"line\">                manager.send(jsonMessage, conn)</div><div class=\"line\">            &#125;</div><div class=\"line\">        <span class=\"keyword\">case</span> message := &lt;-manager.broadcast:</div><div class=\"line\">            <span class=\"keyword\">for</span> conn := <span class=\"keyword\">range</span> manager.clients &#123;</div><div class=\"line\">                <span class=\"keyword\">select</span> &#123;</div><div class=\"line\">                <span class=\"keyword\">case</span> conn.send &lt;- message:</div><div class=\"line\">                <span class=\"keyword\">default</span>:</div><div class=\"line\">                    <span class=\"built_in\">close</span>(conn.send)</div><div class=\"line\">                    <span class=\"built_in\">delete</span>(manager.clients, conn)</div><div class=\"line\">                &#125;</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>每当 manager.register 接收到数据，这个正在建立连接的客户端将会被添加到 manager (前文创建的 ClientManager 实例)的 clients 中。然后，将向所有其他客户端发送一条JSON消息。</p>\n<p>同时，如果客户端断开连接，manager.unregister channel将会收到消息，断开连接的客户端的 channel 中的数据将被关闭，客户端也会从manager中删除。然后发送消息给其他的客户端告知某个客户端已断开连接。</p>\n<p>如果 manager.broadcast channel 中存在数据，则表示正在尝试发送和接收消息。我们打算遍历每个已连接的客户端，将消息发送给它们。如果由于某些原因，channel 被阻塞或消息无法发送，我们会认为这个客户端已断开连接，然后将其删除。</p>\n<p>为了使代码简洁，创建一个 manager.send 方法遍历每个客户端。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">//$GOPATH/src/github.com/nraboy/realtime-chat/main.go</span></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(manager *ClientManager)</span> <span class=\"title\">send</span><span class=\"params\">(message []<span class=\"keyword\">byte</span>, ignore *Client)</span></span> &#123;</div><div class=\"line\">    <span class=\"keyword\">for</span> conn := <span class=\"keyword\">range</span> manager.clients &#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> conn != ignore &#123;</div><div class=\"line\">            conn.send &lt;- message</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>至于conn.send如何发送数据，会在后面探讨。</p>\n<p>现在我们可以探索 goroutine 如何读取客户端发送的 websocket 数据。这个 goroutine 的关键是读取 socket 数据，并将数据添加到 manager.boradcast 做进一步处理。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">//$GOPATH/src/github.com/nraboy/realtime-chat/main.go</span></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(c *Client)</span> <span class=\"title\">read</span><span class=\"params\">()</span></span> &#123;</div><div class=\"line\">    <span class=\"keyword\">defer</span> <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span></span> &#123;</div><div class=\"line\">        manager.unregister &lt;- c</div><div class=\"line\">        c.socket.Close()</div><div class=\"line\">    &#125;()</div><div class=\"line\"> </div><div class=\"line\">    <span class=\"keyword\">for</span> &#123;</div><div class=\"line\">        _, message, err := c.socket.ReadMessage()</div><div class=\"line\">        <span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</div><div class=\"line\">            manager.unregister &lt;- c</div><div class=\"line\">            c.socket.Close()</div><div class=\"line\">            <span class=\"keyword\">break</span></div><div class=\"line\">        &#125;</div><div class=\"line\">        jsonMessage, _ := json.Marshal(&amp;Message&#123;Sender: c.id, Content: <span class=\"keyword\">string</span>(message)&#125;)</div><div class=\"line\">        manager.broadcast &lt;- jsonMessage</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>如果读取 websocket 数据出错，可能意味着客户端已经断开连接。如果是这样，我们需要从服务器中注销这个客户端。</p>\n<p>还记得前边的 conn.send 吗，它用来在第三个 goroutine 中写数据。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">//$GOPATH/src/github.com/nraboy/realtime-chat/main.go</span></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(c *Client)</span> <span class=\"title\">write</span><span class=\"params\">()</span></span> &#123;</div><div class=\"line\">    <span class=\"keyword\">defer</span> <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span></span> &#123;</div><div class=\"line\">        c.socket.Close()</div><div class=\"line\">    &#125;()</div><div class=\"line\"> </div><div class=\"line\">    <span class=\"keyword\">for</span> &#123;</div><div class=\"line\">        <span class=\"keyword\">select</span> &#123;</div><div class=\"line\">        <span class=\"keyword\">case</span> message, ok := &lt;-c.send:</div><div class=\"line\">            <span class=\"keyword\">if</span> !ok &#123;</div><div class=\"line\">                c.socket.WriteMessage(websocket.CloseMessage, []<span class=\"keyword\">byte</span>&#123;&#125;)</div><div class=\"line\">                <span class=\"keyword\">return</span></div><div class=\"line\">            &#125;</div><div class=\"line\"> </div><div class=\"line\">            c.socket.WriteMessage(websocket.TextMessage, message)</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>如果 c.send channel有数据，我们将尝试发送这些数据。如果由于某些原因，channel 运行不正常，我们将向客户端发送断开连接的消息。</p>\n<p>那么，如何启动这些 goroutine 呢，当我们启动服务器时，服务器 goroutine 将会启动，当有客户端连接时，其他 goroutine 将会启动。</p>\n<p>main方法中的代码：</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">//$GOPATH/src/github.com/nraboy/realtime-chat/main.goGo</span></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</div><div class=\"line\">    fmt.Println(<span class=\"string\">\"Starting application...\"</span>)</div><div class=\"line\">    <span class=\"keyword\">go</span> manager.start()</div><div class=\"line\">    http.HandleFunc(<span class=\"string\">\"/ws\"</span>, wsPage)</div><div class=\"line\">    http.ListenAndServe(<span class=\"string\">\":12345\"</span>, <span class=\"literal\">nil</span>)</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>我们在12345端口启动服务器，通过 websocket 连接访问。名为 wsPage 的方法如下所示：</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">//$GOPATH/src/github.com/nraboy/realtime-chat/main.goGo</span></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">wsPage</span><span class=\"params\">(res http.ResponseWriter, req *http.Request)</span></span> &#123;</div><div class=\"line\">    conn, error := (&amp;websocket.Upgrader&#123;CheckOrigin: <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">(r *http.Request)</span> <span class=\"title\">bool</span></span> &#123; <span class=\"keyword\">return</span> <span class=\"literal\">true</span> &#125;&#125;).Upgrade(res, req, <span class=\"literal\">nil</span>)</div><div class=\"line\">    <span class=\"keyword\">if</span> error != <span class=\"literal\">nil</span> &#123;</div><div class=\"line\">        http.NotFound(res, req)</div><div class=\"line\">        <span class=\"keyword\">return</span></div><div class=\"line\">    &#125;</div><div class=\"line\">    client := &amp;Client&#123;id: uuid.NewV4().String(), socket: conn, send: <span class=\"built_in\">make</span>(<span class=\"keyword\">chan</span> []<span class=\"keyword\">byte</span>)&#125;</div><div class=\"line\"> </div><div class=\"line\">    manager.register &lt;- client</div><div class=\"line\"> </div><div class=\"line\">    <span class=\"keyword\">go</span> client.read()</div><div class=\"line\">    <span class=\"keyword\">go</span> client.write()</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>通过使用 websocket 包将HTTP请求升级到websocket请求。通过添加 CheckOrigin ，我们可以接受来自外部域的请求，从而消除跨域资源共享（CORS）的错误。</p>\n<p>创建连接后，将创建一个客户端，并分配唯一的ID。如前所述，该客户端已经注册到服务器。客户端注册后，读写 goroutine 将被触发。</p>\n<p>此时，我们可以通过如下命令启动应用。</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">//Run Go Application</div><div class=\"line\">go run *.go</div></pre></td></tr></table></figure>\n<p>你不能在直接 web 浏览器中测试，但是可以建立一个 websocket 连接到 ws://localhost:12345/ws。</p>\n<h4 id=\"创建Angular2-聊天客户端\"><a href=\"#创建Angular2-聊天客户端\" class=\"headerlink\" title=\"创建Angular2 聊天客户端\"></a>创建Angular2 聊天客户端</h4><p>现在我们需要创建一个客户端的应用，客户端可以发送和接收消息。假设您已经安装了<a href=\"https://cli.angular.io/\" target=\"_blank\" rel=\"external\">Angular 2 CLI</a>，请执行以下操作：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">//Create New Angular 2 Project</div><div class=\"line\">ng new SocketExample</div></pre></td></tr></table></figure>\n<p>执行完将会生成一个单页应用，而我们想要完成的内容，是下方的动图演示的这样。</p>\n<p><img src=\"/images/go/golang-angular2-chat.gif\" alt=\"\"></p>\n<p>补充：此处需cd SocketExmapl &amp;&amp; npm install。</p>\n<p>JavaScript的 websocket 在Angular 2提供的一个类中。使用 Angular 2 CLI，通过执行如下操作创建provider。</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">//Create Angular 2 Provider</div><div class=\"line\">ng g service socket</div></pre></td></tr></table></figure>\n<p>上述命令会在您的项目中创建 <strong>src/app/socket.service.ts </strong> 和 <strong>src/app/socket.service.spec.ts</strong> 。spec文件用于单元测试，不在本文讨论范围内。打开 <strong>src/app/socket.service.ts</strong> 文件，编写以下 TypeScript 代码：</p>\n<figure class=\"highlight typescript\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">//src/app/socket.service.ts</span></div><div class=\"line\"><span class=\"keyword\">import</span> &#123; Injectable, EventEmitter &#125; <span class=\"keyword\">from</span> <span class=\"string\">'@angular/core'</span>;</div><div class=\"line\"> </div><div class=\"line\"><span class=\"meta\">@Injectable</span>()</div><div class=\"line\"><span class=\"keyword\">export</span> <span class=\"keyword\">class</span> SocketService &#123;</div><div class=\"line\"> </div><div class=\"line\">    <span class=\"keyword\">private</span> socket: WebSocket;</div><div class=\"line\">    <span class=\"keyword\">private</span> listener: EventEmitter&lt;<span class=\"built_in\">any</span>&gt; = <span class=\"keyword\">new</span> EventEmitter();</div><div class=\"line\"> </div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">constructor</span>(<span class=\"params\"></span>) &#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>.socket = <span class=\"keyword\">new</span> WebSocket(<span class=\"string\">\"ws://localhost:12345/ws\"</span>);</div><div class=\"line\">        <span class=\"keyword\">this</span>.socket.onopen = <span class=\"function\"><span class=\"params\">event</span> =&gt;</span> &#123;</div><div class=\"line\">            <span class=\"keyword\">this</span>.listener.emit(&#123;<span class=\"string\">\"type\"</span>: <span class=\"string\">\"open\"</span>, <span class=\"string\">\"data\"</span>: event&#125;);</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"keyword\">this</span>.socket.onclose = <span class=\"function\"><span class=\"params\">event</span> =&gt;</span> &#123;</div><div class=\"line\">            <span class=\"keyword\">this</span>.listener.emit(&#123;<span class=\"string\">\"type\"</span>: <span class=\"string\">\"close\"</span>, <span class=\"string\">\"data\"</span>: event&#125;);</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"keyword\">this</span>.socket.onmessage = <span class=\"function\"><span class=\"params\">event</span> =&gt;</span> &#123;</div><div class=\"line\">            <span class=\"keyword\">this</span>.listener.emit(&#123;<span class=\"string\">\"type\"</span>: <span class=\"string\">\"message\"</span>, <span class=\"string\">\"data\"</span>: <span class=\"built_in\">JSON</span>.parse(event.data)&#125;);</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\"> </div><div class=\"line\">    <span class=\"keyword\">public</span> send(data: <span class=\"built_in\">string</span>) &#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>.socket.send(data);</div><div class=\"line\">    &#125;</div><div class=\"line\"> </div><div class=\"line\">    <span class=\"keyword\">public</span> close() &#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>.socket.close();</div><div class=\"line\">    &#125;</div><div class=\"line\"> </div><div class=\"line\">    <span class=\"keyword\">public</span> getEventListener() &#123;</div><div class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.listener;</div><div class=\"line\">    &#125;</div><div class=\"line\"> </div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>该提供者是可以注射的，并在触发某些事件事发送数据。在构造方法中，建立了与Go应用的WebSocket 连接，并创建了3个事件监听器。分别对应每个socket创建和销毁时，及接收到消息时。</p>\n<p>send方法允许我们向Go应用发送消息，close方法用于通知Go应用我们将断开连接。</p>\n<p>提供者程序已创建，但是还不能在我们的的应用程序的任何文件中使用。因此，我们需要将其添加到 <strong>src/app/app.module.ts</strong> 文件的 @NgModule 块中。打开文件并输入：</p>\n<figure class=\"highlight typescript\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">//src/app/app.module.ts</span></div><div class=\"line\"><span class=\"keyword\">import</span> &#123; BrowserModule &#125; <span class=\"keyword\">from</span> <span class=\"string\">'@angular/platform-browser'</span>;</div><div class=\"line\"><span class=\"keyword\">import</span> &#123; NgModule &#125; <span class=\"keyword\">from</span> <span class=\"string\">'@angular/core'</span>;</div><div class=\"line\"><span class=\"keyword\">import</span> &#123; FormsModule &#125; <span class=\"keyword\">from</span> <span class=\"string\">'@angular/forms'</span>;</div><div class=\"line\"><span class=\"keyword\">import</span> &#123; HttpModule &#125; <span class=\"keyword\">from</span> <span class=\"string\">'@angular/http'</span>;</div><div class=\"line\"> </div><div class=\"line\"><span class=\"keyword\">import</span> &#123; AppComponent &#125; <span class=\"keyword\">from</span> <span class=\"string\">'./app.component'</span>;</div><div class=\"line\"><span class=\"keyword\">import</span> &#123; SocketService &#125; <span class=\"keyword\">from</span> <span class=\"string\">\"./socket.service\"</span>;</div><div class=\"line\"> </div><div class=\"line\"><span class=\"meta\">@NgModule</span>(&#123;</div><div class=\"line\">    declarations: [</div><div class=\"line\">        AppComponent</div><div class=\"line\">    ],</div><div class=\"line\">    imports: [</div><div class=\"line\">        BrowserModule,</div><div class=\"line\">        FormsModule,</div><div class=\"line\">        HttpModule</div><div class=\"line\">    ],</div><div class=\"line\">    providers: [SocketService],</div><div class=\"line\">    bootstrap: [AppComponent]</div><div class=\"line\">&#125;)</div><div class=\"line\"><span class=\"keyword\">export</span> <span class=\"keyword\">class</span> AppModule &#123; &#125;</div></pre></td></tr></table></figure>\n<p>需要注意的是，此时我们已经将provider导入并且添加到 @NgModule 块的 providers数组中了。</p>\n<p>现在我们可以专注处理页面的逻辑了。打开 <strong>src/app/app.component.ts</strong> 文件，并输入以下代码：</p>\n<figure class=\"highlight typescript\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">//src/app/app.component.ts</span></div><div class=\"line\"><span class=\"keyword\">import</span> &#123; Component, OnInit, OnDestroy &#125; <span class=\"keyword\">from</span> <span class=\"string\">'@angular/core'</span>;</div><div class=\"line\"><span class=\"keyword\">import</span> &#123; SocketService &#125; <span class=\"keyword\">from</span> <span class=\"string\">\"./socket.service\"</span>;</div><div class=\"line\"> </div><div class=\"line\"><span class=\"meta\">@Component</span>(&#123;</div><div class=\"line\">    selector: <span class=\"string\">'app-root'</span>,</div><div class=\"line\">    templateUrl: <span class=\"string\">'./app.component.html'</span>,</div><div class=\"line\">    styleUrls: [<span class=\"string\">'./app.component.css'</span>]</div><div class=\"line\">&#125;)</div><div class=\"line\"><span class=\"keyword\">export</span> <span class=\"keyword\">class</span> AppComponent <span class=\"keyword\">implements</span> OnInit, OnDestroy &#123;</div><div class=\"line\"> </div><div class=\"line\">    <span class=\"keyword\">public</span> messages: <span class=\"built_in\">Array</span>&lt;<span class=\"built_in\">any</span>&gt;;</div><div class=\"line\">    <span class=\"keyword\">public</span> chatBox: <span class=\"built_in\">string</span>;</div><div class=\"line\"> </div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">constructor</span>(<span class=\"params\"><span class=\"keyword\">private</span> socket: SocketService</span>) &#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>.messages = [];</div><div class=\"line\">        <span class=\"keyword\">this</span>.chatBox = <span class=\"string\">\"\"</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\"> </div><div class=\"line\">    <span class=\"keyword\">public</span> ngOnInit() &#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>.socket.getEventListener().subscribe(<span class=\"function\"><span class=\"params\">event</span> =&gt;</span> &#123;</div><div class=\"line\">            <span class=\"keyword\">if</span>(event.type == <span class=\"string\">\"message\"</span>) &#123;</div><div class=\"line\">                <span class=\"keyword\">let</span> data = event.data.content;</div><div class=\"line\">                <span class=\"keyword\">if</span>(event.data.sender) &#123;</div><div class=\"line\">                    data = event.data.sender + <span class=\"string\">\": \"</span> + data;</div><div class=\"line\">                &#125;</div><div class=\"line\">                <span class=\"keyword\">this</span>.messages.push(data);</div><div class=\"line\">            &#125;</div><div class=\"line\">            <span class=\"keyword\">if</span>(event.type == <span class=\"string\">\"close\"</span>) &#123;</div><div class=\"line\">                <span class=\"keyword\">this</span>.messages.push(<span class=\"string\">\"/The socket connection has been closed\"</span>);</div><div class=\"line\">            &#125;</div><div class=\"line\">            <span class=\"keyword\">if</span>(event.type == <span class=\"string\">\"open\"</span>) &#123;</div><div class=\"line\">                <span class=\"keyword\">this</span>.messages.push(<span class=\"string\">\"/The socket connection has been established\"</span>);</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;);</div><div class=\"line\">    &#125;</div><div class=\"line\"> </div><div class=\"line\">    <span class=\"keyword\">public</span> ngOnDestroy() &#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>.socket.close();</div><div class=\"line\">    &#125;</div><div class=\"line\"> </div><div class=\"line\">    <span class=\"keyword\">public</span> send() &#123;</div><div class=\"line\">        <span class=\"keyword\">if</span>(<span class=\"keyword\">this</span>.chatBox) &#123;</div><div class=\"line\">            <span class=\"keyword\">this</span>.socket.send(<span class=\"keyword\">this</span>.chatBox);</div><div class=\"line\">            <span class=\"keyword\">this</span>.chatBox = <span class=\"string\">\"\"</span>;</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\"> </div><div class=\"line\">    <span class=\"keyword\">public</span> isSystemMessage(message: <span class=\"built_in\">string</span>) &#123;</div><div class=\"line\">        <span class=\"keyword\">return</span> message.startsWith(<span class=\"string\">\"/\"</span>) ? <span class=\"string\">\"&lt;strong&gt;\"</span> + message.substring(<span class=\"number\">1</span>) + <span class=\"string\">\"&lt;/strong&gt;\"</span> : message;</div><div class=\"line\">    &#125;</div><div class=\"line\"> </div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>在上述 AppComponent类的构造方法中，我们注册服务提供者并初始化需要绑定到UI的变量。在构造函数中加载或订阅不太好，我们使用ngOninit方法来代替。</p>\n<figure class=\"highlight typescript\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">//src/app/app.component.ts</span></div><div class=\"line\"><span class=\"keyword\">public</span> ngOnInit() &#123;</div><div class=\"line\">    <span class=\"keyword\">this</span>.socket.getEventListener().subscribe(<span class=\"function\"><span class=\"params\">event</span> =&gt;</span> &#123;</div><div class=\"line\">        <span class=\"keyword\">if</span>(event.type == <span class=\"string\">\"message\"</span>) &#123;</div><div class=\"line\">            <span class=\"keyword\">let</span> data = event.data.content;</div><div class=\"line\">            <span class=\"keyword\">if</span>(event.data.sender) &#123;</div><div class=\"line\">                data = event.data.sender + <span class=\"string\">\": \"</span> + data;</div><div class=\"line\">            &#125;</div><div class=\"line\">            <span class=\"keyword\">this</span>.messages.push(data);</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"keyword\">if</span>(event.type == <span class=\"string\">\"close\"</span>) &#123;</div><div class=\"line\">            <span class=\"keyword\">this</span>.messages.push(<span class=\"string\">\"/The socket connection has been closed\"</span>);</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"keyword\">if</span>(event.type == <span class=\"string\">\"open\"</span>) &#123;</div><div class=\"line\">            <span class=\"keyword\">this</span>.messages.push(<span class=\"string\">\"/The socket connection has been established\"</span>);</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>在上述方法中，我们订阅了在provider中创建的事件监听器。在这里我们需要检查发生了什么事件。如果是一条消息，需要检查是否存在发件人，然后将其添加到消息中。</p>\n<p>你可能注意到了，一些消息是以斜线开始的。用来表示系统消息，稍后会将其加粗。</p>\n<p>当客户端断开时，关闭事件将会发送到服务器，如果消息已经发送，它也会被发送到服务器。</p>\n<p>在查看HTML之前，先添加一些CSS，使其看起来更像一个聊天应用。打开 <strong>src/style.css</strong>，输入以下内容：</p>\n<figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">/*src/styles.css*/</span></div><div class=\"line\"><span class=\"comment\">/* You can add global styles to this file, and also import other style files */</span></div><div class=\"line\">* &#123; <span class=\"attribute\">margin</span>: <span class=\"number\">0</span>; <span class=\"attribute\">padding</span>: <span class=\"number\">0</span>; <span class=\"attribute\">box-sizing</span>: border-box; &#125;</div><div class=\"line\"><span class=\"selector-tag\">body</span> &#123; <span class=\"attribute\">font</span>: <span class=\"number\">13px</span> Helvetica, Arial; &#125;</div><div class=\"line\"><span class=\"selector-tag\">form</span> &#123; <span class=\"attribute\">background</span>: <span class=\"number\">#000</span>; <span class=\"attribute\">padding</span>: <span class=\"number\">3px</span>; <span class=\"attribute\">position</span>: fixed; <span class=\"attribute\">bottom</span>: <span class=\"number\">0</span>; <span class=\"attribute\">width</span>: <span class=\"number\">100%</span>; &#125;</div><div class=\"line\"><span class=\"selector-tag\">form</span> <span class=\"selector-tag\">input</span> &#123; <span class=\"attribute\">border</span>: <span class=\"number\">0</span>; <span class=\"attribute\">padding</span>: <span class=\"number\">10px</span>; <span class=\"attribute\">width</span>: <span class=\"number\">90%</span>; <span class=\"attribute\">margin-right</span>: .<span class=\"number\">5%</span>; &#125;</div><div class=\"line\"><span class=\"selector-tag\">form</span> <span class=\"selector-tag\">button</span> &#123; <span class=\"attribute\">width</span>: <span class=\"number\">9%</span>; <span class=\"attribute\">background</span>: <span class=\"built_in\">rgb</span>(130, 224, 255); <span class=\"attribute\">border</span>: none; <span class=\"attribute\">padding</span>: <span class=\"number\">10px</span>; &#125;</div><div class=\"line\"><span class=\"selector-id\">#messages</span> &#123; <span class=\"attribute\">list-style-type</span>: none; <span class=\"attribute\">margin</span>: <span class=\"number\">0</span>; <span class=\"attribute\">padding</span>: <span class=\"number\">0</span>; &#125;</div><div class=\"line\"><span class=\"selector-id\">#messages</span> <span class=\"selector-tag\">li</span> &#123; <span class=\"attribute\">padding</span>: <span class=\"number\">5px</span> <span class=\"number\">10px</span>; &#125;</div><div class=\"line\"><span class=\"selector-id\">#messages</span> <span class=\"selector-tag\">li</span><span class=\"selector-pseudo\">:nth-child(odd)</span> &#123; <span class=\"attribute\">background</span>: <span class=\"number\">#eee</span>; &#125;</div></pre></td></tr></table></figure>\n<p>现在，需要处理下HTML了。打开 <strong>src/app/app.component.html</strong> 文件，并输入以下内容：</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">&lt;!--src/app/app.component.html--&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">ul</span> <span class=\"attr\">id</span>=<span class=\"string\">\"messages\"</span>&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">li</span> *<span class=\"attr\">ngFor</span>=<span class=\"string\">\"let message of messages\"</span>&gt;</span></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">span</span> [<span class=\"attr\">innerHTML</span>]=<span class=\"string\">\"isSystemMessage(message)\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">span</span>&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">li</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">ul</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">form</span> <span class=\"attr\">action</span>=<span class=\"string\">\"\"</span>&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">input</span> [(<span class=\"attr\">ngModel</span>)]=<span class=\"string\">\"chatBox\"</span> [<span class=\"attr\">ngModelOptions</span>]=<span class=\"string\">\"&#123;standalone: true&#125;\"</span> <span class=\"attr\">autocomplete</span>=<span class=\"string\">\"off\"</span> /&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">button</span> (<span class=\"attr\">click</span>)=<span class=\"string\">\"send()\"</span>&gt;</span>Send<span class=\"tag\">&lt;/<span class=\"name\">button</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">form</span>&gt;</span></div></pre></td></tr></table></figure>\n<p>这里我们只是简单的将消息数组遍历到屏幕上 。以斜线开头的消息将会被加粗。提交按钮绑定到了send方法中，当按下时，会提交输入框中的内容到Go应用。</p>\n<h4 id=\"结语\"><a href=\"#结语\" class=\"headerlink\" title=\"结语\"></a>结语</h4><p>刚刚演示了如何使用 Go 和 Angular 2 创建一个 WebSocket 实时聊天应用。虽然没有在这个示例中存储聊天记录，但是这套逻辑可以应用于更复杂的项目，比如游戏，IOT，和其他很多场景。</p>\n<h4 id=\"关于原作者\"><a href=\"#关于原作者\" class=\"headerlink\" title=\"关于原作者\"></a>关于原作者</h4><p><a href=\"https://www.thepolyglotdeveloper.com/author/nraboy/\" target=\"_blank\" rel=\"external\">Nic Raboy</a>是现代网络和移动开发技术的倡导者。 他在Java，JavaScript，Golang以及各种框架（如Angular，NativeScript和Apache Cordova）方面拥有丰富的经验。 Nic写作的内容主要是他在使Web和移动开发更容易理解相关方面的经验。</p>\n","site":{"data":{}},"excerpt":"","more":"<h3 id=\"写在前面\"><a href=\"#写在前面\" class=\"headerlink\" title=\"写在前面\"></a>写在前面</h3><p>本文<a href=\"https://www.thepolyglotdeveloper.com/2016/12/create-real-time-chat-app-golang-angular-2-websockets/\" target=\"_blank\" rel=\"external\">原文</a>，详细讲解了如何使用Go和Angular通过WebSocket构建实时聊天应用。</p>\n<h4 id=\"正文\"><a href=\"#正文\" class=\"headerlink\" title=\"正文\"></a>正文</h4><p>我最近听到很多关于WebSocket的东西，以及WebSocket如何在应用程序和服务器之间实现实时通信。WebSocket作为RESTful API的替代和补充，已经存在了很长时间。使用WebSocket可以做例如实时聊天，与IoT通信，游戏，和其他很多需要在客户端和服务器之间进行即时消息传递的东西。</p>\n<p>最近一段时间，我<a href=\"https://www.thepolyglotdeveloper.com/2016/01/create-a-real-time-chat-application-with-the-cean-stack-and-socket-io/\" target=\"_blank\" rel=\"external\">使用了一个叫Socket.io的库，用来在Node.js中使用websockets</a>，但是当我真正使用Go以后，我打算研究一下如何在Go中使用WebSocket。</p>\n<p>通过本文，我们将学习如何创建一个聊天应用，其中客户端是一个 Angular 2 应用，服务端使用Go。</p>\n<h4 id=\"要求\"><a href=\"#要求\" class=\"headerlink\" title=\"要求\"></a>要求</h4><p>在这个应用中有很多操作，所以有一些必要的前提条件，如下所示：</p>\n<ul>\n<li><a href=\"https://golang.org/\" target=\"_blank\" rel=\"external\">Go</a> 1.7+</li>\n<li><a href=\"https://nodejs.org/en/\" target=\"_blank\" rel=\"external\">Node.js</a> 4.0+</li>\n<li><a href=\"https://cli.angular.io/\" target=\"_blank\" rel=\"external\">Angular2 CLI</a></li>\n</ul>\n<p>处理所有消息和客户端的聊天服务器使用Go编写。客户端前端使用 Angular 2编写，has a dependency of the Node Package Manager (NPM) which ships with Node.js.</p>\n<h4 id=\"创建Go聊天服务器\"><a href=\"#创建Go聊天服务器\" class=\"headerlink\" title=\"创建Go聊天服务器\"></a>创建Go聊天服务器</h4><p>我们打算先开发整个应用的服务器端部分，它需要依赖几个第三方的包。</p>\n<p>在命令行执行以下命令，下载第三方包：</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">//Install Go Dependencies</span></div><div class=\"line\"><span class=\"keyword\">go</span> get github.com/gorilla/websocket</div><div class=\"line\"><span class=\"keyword\">go</span> get github.com/satori/<span class=\"keyword\">go</span>.uuid</div></pre></td></tr></table></figure>\n<p>websocket包的作者同时也是 <a href=\"https://github.com/gorilla/mux\" target=\"_blank\" rel=\"external\">Mux</a> 这个路由包 的作者，我们还需要一个UUID包来分配每一个客户端的唯一ID。</p>\n<p>在 $GOPATH 目录创建一个新的项目，我自己的项目目录是 $GOPATH/src/github.com/nraboy/realtime-chat/main.go。</p>\n<p>在进行下一步之前，需要注意的是，我从 <a href=\"https://dinosaurscode.xyz/go/2016/07/17/go-websockets-tutorial/\" target=\"_blank\" rel=\"external\">Dinosaurs Code</a> 和 <a href=\"https://github.com/gorilla/websocket/tree/master/examples/chat\" target=\"_blank\" rel=\"external\">Gorilla websocket chat example</a>  获取了一部分Go 代码，为了避免剽窃的嫌疑，我使用了很多原始代码中的一部分，但我也为这个项目加入了很多自己的独特的东西。</p>\n<p>这次我们要做的聊天应用有3个结构体：</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">// $GOPATH/src/github.com/nraboy/realtime-chat/main.go</span></div><div class=\"line\"><span class=\"keyword\">type</span> ClientManager <span class=\"keyword\">struct</span> &#123;</div><div class=\"line\">    clients    <span class=\"keyword\">map</span>[*Client]<span class=\"keyword\">bool</span></div><div class=\"line\">    broadcast  <span class=\"keyword\">chan</span> []<span class=\"keyword\">byte</span></div><div class=\"line\">    register   <span class=\"keyword\">chan</span> *Client</div><div class=\"line\">    unregister <span class=\"keyword\">chan</span> *Client</div><div class=\"line\">&#125;</div><div class=\"line\"> </div><div class=\"line\"><span class=\"keyword\">type</span> Client <span class=\"keyword\">struct</span> &#123;</div><div class=\"line\">    id     <span class=\"keyword\">string</span></div><div class=\"line\">    socket *websocket.Conn</div><div class=\"line\">    send   <span class=\"keyword\">chan</span> []<span class=\"keyword\">byte</span></div><div class=\"line\">&#125;</div><div class=\"line\"> </div><div class=\"line\"><span class=\"keyword\">type</span> Message <span class=\"keyword\">struct</span> &#123;</div><div class=\"line\">    Sender    <span class=\"keyword\">string</span> <span class=\"string\">`json:\"sender,omitempty\"`</span></div><div class=\"line\">    Recipient <span class=\"keyword\">string</span> <span class=\"string\">`json:\"recipient,omitempty\"`</span></div><div class=\"line\">    Content   <span class=\"keyword\">string</span> <span class=\"string\">`json:\"content,omitempty\"`</span></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>ClientManager用于管理所有已连接的客户端，尝试连接的客户端，已经断开连接等待删除的客户端，和所有已连接客户端收发的消息。</p>\n<p>每个客户端有一个唯一的ID，一个socket连接，和等待发送的消息。</p>\n<p>为了增加传递的数据的复杂性，消息将使用 JSON 格式。而不是传递一串不容易被理解，阅读的数据。使用JSON格式，我们可以使用元数据和其他有用的东西。每一条消息将包含发送消息的客户端，接收消息的客户端，和消息的实际内容。</p>\n<p>首先定义一个全局的ClientManager。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">//$GOPATH/src/github.com/nraboy/realtime-chat/main.go</span></div><div class=\"line\"><span class=\"keyword\">var</span> manager = ClientManager&#123;</div><div class=\"line\">    broadcast:  <span class=\"built_in\">make</span>(<span class=\"keyword\">chan</span> []<span class=\"keyword\">byte</span>),</div><div class=\"line\">    register:   <span class=\"built_in\">make</span>(<span class=\"keyword\">chan</span> *Client),</div><div class=\"line\">    unregister: <span class=\"built_in\">make</span>(<span class=\"keyword\">chan</span> *Client),</div><div class=\"line\">    clients:    <span class=\"built_in\">make</span>(<span class=\"keyword\">map</span>[*Client]<span class=\"keyword\">bool</span>),</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>服务器端将使用3个goroutine，一个用于管理客户端，一个用于读取websocket数据，另一个用于往websocket里写数据。这里指的是读取和写入的goroutine将为每个连接的客户端创建一个新的实例。所有的goroutine将循环运行直至不再需要。</p>\n<p>编写如下代码，来开始服务：</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">//$GOPATH/src/github.com/nraboy/realtime-chat/main.go</span></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(manager *ClientManager)</span> <span class=\"title\">start</span><span class=\"params\">()</span></span> &#123;</div><div class=\"line\">    <span class=\"keyword\">for</span> &#123;</div><div class=\"line\">        <span class=\"keyword\">select</span> &#123;</div><div class=\"line\">        <span class=\"keyword\">case</span> conn := &lt;-manager.register:</div><div class=\"line\">        \tmanager.clients[conn] = <span class=\"literal\">true</span></div><div class=\"line\">        \tjsonMessage, _ := json.Marshal(&amp;Message&#123;Content: <span class=\"string\">\"/A new socket has connected.\"</span>&#125;)</div><div class=\"line\">            manager.send(jsonMessage, conn)</div><div class=\"line\">        <span class=\"keyword\">case</span> conn := &lt;-manager.unregister:</div><div class=\"line\">            <span class=\"keyword\">if</span> _, ok := manager.clients[conn]; ok &#123;</div><div class=\"line\">                <span class=\"built_in\">close</span>(conn.send)</div><div class=\"line\">                <span class=\"built_in\">delete</span>(manager.clients, conn)</div><div class=\"line\">                jsonMessage, _ := json.Marshal(&amp;Message&#123;Content: <span class=\"string\">\"/A socket has disconnected.\"</span>&#125;)</div><div class=\"line\">                manager.send(jsonMessage, conn)</div><div class=\"line\">            &#125;</div><div class=\"line\">        <span class=\"keyword\">case</span> message := &lt;-manager.broadcast:</div><div class=\"line\">            <span class=\"keyword\">for</span> conn := <span class=\"keyword\">range</span> manager.clients &#123;</div><div class=\"line\">                <span class=\"keyword\">select</span> &#123;</div><div class=\"line\">                <span class=\"keyword\">case</span> conn.send &lt;- message:</div><div class=\"line\">                <span class=\"keyword\">default</span>:</div><div class=\"line\">                    <span class=\"built_in\">close</span>(conn.send)</div><div class=\"line\">                    <span class=\"built_in\">delete</span>(manager.clients, conn)</div><div class=\"line\">                &#125;</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>每当 manager.register 接收到数据，这个正在建立连接的客户端将会被添加到 manager (前文创建的 ClientManager 实例)的 clients 中。然后，将向所有其他客户端发送一条JSON消息。</p>\n<p>同时，如果客户端断开连接，manager.unregister channel将会收到消息，断开连接的客户端的 channel 中的数据将被关闭，客户端也会从manager中删除。然后发送消息给其他的客户端告知某个客户端已断开连接。</p>\n<p>如果 manager.broadcast channel 中存在数据，则表示正在尝试发送和接收消息。我们打算遍历每个已连接的客户端，将消息发送给它们。如果由于某些原因，channel 被阻塞或消息无法发送，我们会认为这个客户端已断开连接，然后将其删除。</p>\n<p>为了使代码简洁，创建一个 manager.send 方法遍历每个客户端。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">//$GOPATH/src/github.com/nraboy/realtime-chat/main.go</span></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(manager *ClientManager)</span> <span class=\"title\">send</span><span class=\"params\">(message []<span class=\"keyword\">byte</span>, ignore *Client)</span></span> &#123;</div><div class=\"line\">    <span class=\"keyword\">for</span> conn := <span class=\"keyword\">range</span> manager.clients &#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> conn != ignore &#123;</div><div class=\"line\">            conn.send &lt;- message</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>至于conn.send如何发送数据，会在后面探讨。</p>\n<p>现在我们可以探索 goroutine 如何读取客户端发送的 websocket 数据。这个 goroutine 的关键是读取 socket 数据，并将数据添加到 manager.boradcast 做进一步处理。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">//$GOPATH/src/github.com/nraboy/realtime-chat/main.go</span></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(c *Client)</span> <span class=\"title\">read</span><span class=\"params\">()</span></span> &#123;</div><div class=\"line\">    <span class=\"keyword\">defer</span> <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span></span> &#123;</div><div class=\"line\">        manager.unregister &lt;- c</div><div class=\"line\">        c.socket.Close()</div><div class=\"line\">    &#125;()</div><div class=\"line\"> </div><div class=\"line\">    <span class=\"keyword\">for</span> &#123;</div><div class=\"line\">        _, message, err := c.socket.ReadMessage()</div><div class=\"line\">        <span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</div><div class=\"line\">            manager.unregister &lt;- c</div><div class=\"line\">            c.socket.Close()</div><div class=\"line\">            <span class=\"keyword\">break</span></div><div class=\"line\">        &#125;</div><div class=\"line\">        jsonMessage, _ := json.Marshal(&amp;Message&#123;Sender: c.id, Content: <span class=\"keyword\">string</span>(message)&#125;)</div><div class=\"line\">        manager.broadcast &lt;- jsonMessage</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>如果读取 websocket 数据出错，可能意味着客户端已经断开连接。如果是这样，我们需要从服务器中注销这个客户端。</p>\n<p>还记得前边的 conn.send 吗，它用来在第三个 goroutine 中写数据。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">//$GOPATH/src/github.com/nraboy/realtime-chat/main.go</span></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(c *Client)</span> <span class=\"title\">write</span><span class=\"params\">()</span></span> &#123;</div><div class=\"line\">    <span class=\"keyword\">defer</span> <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span></span> &#123;</div><div class=\"line\">        c.socket.Close()</div><div class=\"line\">    &#125;()</div><div class=\"line\"> </div><div class=\"line\">    <span class=\"keyword\">for</span> &#123;</div><div class=\"line\">        <span class=\"keyword\">select</span> &#123;</div><div class=\"line\">        <span class=\"keyword\">case</span> message, ok := &lt;-c.send:</div><div class=\"line\">            <span class=\"keyword\">if</span> !ok &#123;</div><div class=\"line\">                c.socket.WriteMessage(websocket.CloseMessage, []<span class=\"keyword\">byte</span>&#123;&#125;)</div><div class=\"line\">                <span class=\"keyword\">return</span></div><div class=\"line\">            &#125;</div><div class=\"line\"> </div><div class=\"line\">            c.socket.WriteMessage(websocket.TextMessage, message)</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>如果 c.send channel有数据，我们将尝试发送这些数据。如果由于某些原因，channel 运行不正常，我们将向客户端发送断开连接的消息。</p>\n<p>那么，如何启动这些 goroutine 呢，当我们启动服务器时，服务器 goroutine 将会启动，当有客户端连接时，其他 goroutine 将会启动。</p>\n<p>main方法中的代码：</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">//$GOPATH/src/github.com/nraboy/realtime-chat/main.goGo</span></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</div><div class=\"line\">    fmt.Println(<span class=\"string\">\"Starting application...\"</span>)</div><div class=\"line\">    <span class=\"keyword\">go</span> manager.start()</div><div class=\"line\">    http.HandleFunc(<span class=\"string\">\"/ws\"</span>, wsPage)</div><div class=\"line\">    http.ListenAndServe(<span class=\"string\">\":12345\"</span>, <span class=\"literal\">nil</span>)</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>我们在12345端口启动服务器，通过 websocket 连接访问。名为 wsPage 的方法如下所示：</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">//$GOPATH/src/github.com/nraboy/realtime-chat/main.goGo</span></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">wsPage</span><span class=\"params\">(res http.ResponseWriter, req *http.Request)</span></span> &#123;</div><div class=\"line\">    conn, error := (&amp;websocket.Upgrader&#123;CheckOrigin: <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">(r *http.Request)</span> <span class=\"title\">bool</span></span> &#123; <span class=\"keyword\">return</span> <span class=\"literal\">true</span> &#125;&#125;).Upgrade(res, req, <span class=\"literal\">nil</span>)</div><div class=\"line\">    <span class=\"keyword\">if</span> error != <span class=\"literal\">nil</span> &#123;</div><div class=\"line\">        http.NotFound(res, req)</div><div class=\"line\">        <span class=\"keyword\">return</span></div><div class=\"line\">    &#125;</div><div class=\"line\">    client := &amp;Client&#123;id: uuid.NewV4().String(), socket: conn, send: <span class=\"built_in\">make</span>(<span class=\"keyword\">chan</span> []<span class=\"keyword\">byte</span>)&#125;</div><div class=\"line\"> </div><div class=\"line\">    manager.register &lt;- client</div><div class=\"line\"> </div><div class=\"line\">    <span class=\"keyword\">go</span> client.read()</div><div class=\"line\">    <span class=\"keyword\">go</span> client.write()</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>通过使用 websocket 包将HTTP请求升级到websocket请求。通过添加 CheckOrigin ，我们可以接受来自外部域的请求，从而消除跨域资源共享（CORS）的错误。</p>\n<p>创建连接后，将创建一个客户端，并分配唯一的ID。如前所述，该客户端已经注册到服务器。客户端注册后，读写 goroutine 将被触发。</p>\n<p>此时，我们可以通过如下命令启动应用。</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">//Run Go Application</div><div class=\"line\">go run *.go</div></pre></td></tr></table></figure>\n<p>你不能在直接 web 浏览器中测试，但是可以建立一个 websocket 连接到 ws://localhost:12345/ws。</p>\n<h4 id=\"创建Angular2-聊天客户端\"><a href=\"#创建Angular2-聊天客户端\" class=\"headerlink\" title=\"创建Angular2 聊天客户端\"></a>创建Angular2 聊天客户端</h4><p>现在我们需要创建一个客户端的应用，客户端可以发送和接收消息。假设您已经安装了<a href=\"https://cli.angular.io/\" target=\"_blank\" rel=\"external\">Angular 2 CLI</a>，请执行以下操作：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">//Create New Angular 2 Project</div><div class=\"line\">ng new SocketExample</div></pre></td></tr></table></figure>\n<p>执行完将会生成一个单页应用，而我们想要完成的内容，是下方的动图演示的这样。</p>\n<p><img src=\"/images/go/golang-angular2-chat.gif\" alt=\"\"></p>\n<p>补充：此处需cd SocketExmapl &amp;&amp; npm install。</p>\n<p>JavaScript的 websocket 在Angular 2提供的一个类中。使用 Angular 2 CLI，通过执行如下操作创建provider。</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">//Create Angular 2 Provider</div><div class=\"line\">ng g service socket</div></pre></td></tr></table></figure>\n<p>上述命令会在您的项目中创建 <strong>src/app/socket.service.ts </strong> 和 <strong>src/app/socket.service.spec.ts</strong> 。spec文件用于单元测试，不在本文讨论范围内。打开 <strong>src/app/socket.service.ts</strong> 文件，编写以下 TypeScript 代码：</p>\n<figure class=\"highlight typescript\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">//src/app/socket.service.ts</span></div><div class=\"line\"><span class=\"keyword\">import</span> &#123; Injectable, EventEmitter &#125; <span class=\"keyword\">from</span> <span class=\"string\">'@angular/core'</span>;</div><div class=\"line\"> </div><div class=\"line\"><span class=\"meta\">@Injectable</span>()</div><div class=\"line\"><span class=\"keyword\">export</span> <span class=\"keyword\">class</span> SocketService &#123;</div><div class=\"line\"> </div><div class=\"line\">    <span class=\"keyword\">private</span> socket: WebSocket;</div><div class=\"line\">    <span class=\"keyword\">private</span> listener: EventEmitter&lt;<span class=\"built_in\">any</span>&gt; = <span class=\"keyword\">new</span> EventEmitter();</div><div class=\"line\"> </div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">constructor</span>(<span class=\"params\"></span>) &#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>.socket = <span class=\"keyword\">new</span> WebSocket(<span class=\"string\">\"ws://localhost:12345/ws\"</span>);</div><div class=\"line\">        <span class=\"keyword\">this</span>.socket.onopen = <span class=\"function\"><span class=\"params\">event</span> =&gt;</span> &#123;</div><div class=\"line\">            <span class=\"keyword\">this</span>.listener.emit(&#123;<span class=\"string\">\"type\"</span>: <span class=\"string\">\"open\"</span>, <span class=\"string\">\"data\"</span>: event&#125;);</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"keyword\">this</span>.socket.onclose = <span class=\"function\"><span class=\"params\">event</span> =&gt;</span> &#123;</div><div class=\"line\">            <span class=\"keyword\">this</span>.listener.emit(&#123;<span class=\"string\">\"type\"</span>: <span class=\"string\">\"close\"</span>, <span class=\"string\">\"data\"</span>: event&#125;);</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"keyword\">this</span>.socket.onmessage = <span class=\"function\"><span class=\"params\">event</span> =&gt;</span> &#123;</div><div class=\"line\">            <span class=\"keyword\">this</span>.listener.emit(&#123;<span class=\"string\">\"type\"</span>: <span class=\"string\">\"message\"</span>, <span class=\"string\">\"data\"</span>: <span class=\"built_in\">JSON</span>.parse(event.data)&#125;);</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\"> </div><div class=\"line\">    <span class=\"keyword\">public</span> send(data: <span class=\"built_in\">string</span>) &#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>.socket.send(data);</div><div class=\"line\">    &#125;</div><div class=\"line\"> </div><div class=\"line\">    <span class=\"keyword\">public</span> close() &#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>.socket.close();</div><div class=\"line\">    &#125;</div><div class=\"line\"> </div><div class=\"line\">    <span class=\"keyword\">public</span> getEventListener() &#123;</div><div class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.listener;</div><div class=\"line\">    &#125;</div><div class=\"line\"> </div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>该提供者是可以注射的，并在触发某些事件事发送数据。在构造方法中，建立了与Go应用的WebSocket 连接，并创建了3个事件监听器。分别对应每个socket创建和销毁时，及接收到消息时。</p>\n<p>send方法允许我们向Go应用发送消息，close方法用于通知Go应用我们将断开连接。</p>\n<p>提供者程序已创建，但是还不能在我们的的应用程序的任何文件中使用。因此，我们需要将其添加到 <strong>src/app/app.module.ts</strong> 文件的 @NgModule 块中。打开文件并输入：</p>\n<figure class=\"highlight typescript\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">//src/app/app.module.ts</span></div><div class=\"line\"><span class=\"keyword\">import</span> &#123; BrowserModule &#125; <span class=\"keyword\">from</span> <span class=\"string\">'@angular/platform-browser'</span>;</div><div class=\"line\"><span class=\"keyword\">import</span> &#123; NgModule &#125; <span class=\"keyword\">from</span> <span class=\"string\">'@angular/core'</span>;</div><div class=\"line\"><span class=\"keyword\">import</span> &#123; FormsModule &#125; <span class=\"keyword\">from</span> <span class=\"string\">'@angular/forms'</span>;</div><div class=\"line\"><span class=\"keyword\">import</span> &#123; HttpModule &#125; <span class=\"keyword\">from</span> <span class=\"string\">'@angular/http'</span>;</div><div class=\"line\"> </div><div class=\"line\"><span class=\"keyword\">import</span> &#123; AppComponent &#125; <span class=\"keyword\">from</span> <span class=\"string\">'./app.component'</span>;</div><div class=\"line\"><span class=\"keyword\">import</span> &#123; SocketService &#125; <span class=\"keyword\">from</span> <span class=\"string\">\"./socket.service\"</span>;</div><div class=\"line\"> </div><div class=\"line\"><span class=\"meta\">@NgModule</span>(&#123;</div><div class=\"line\">    declarations: [</div><div class=\"line\">        AppComponent</div><div class=\"line\">    ],</div><div class=\"line\">    imports: [</div><div class=\"line\">        BrowserModule,</div><div class=\"line\">        FormsModule,</div><div class=\"line\">        HttpModule</div><div class=\"line\">    ],</div><div class=\"line\">    providers: [SocketService],</div><div class=\"line\">    bootstrap: [AppComponent]</div><div class=\"line\">&#125;)</div><div class=\"line\"><span class=\"keyword\">export</span> <span class=\"keyword\">class</span> AppModule &#123; &#125;</div></pre></td></tr></table></figure>\n<p>需要注意的是，此时我们已经将provider导入并且添加到 @NgModule 块的 providers数组中了。</p>\n<p>现在我们可以专注处理页面的逻辑了。打开 <strong>src/app/app.component.ts</strong> 文件，并输入以下代码：</p>\n<figure class=\"highlight typescript\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">//src/app/app.component.ts</span></div><div class=\"line\"><span class=\"keyword\">import</span> &#123; Component, OnInit, OnDestroy &#125; <span class=\"keyword\">from</span> <span class=\"string\">'@angular/core'</span>;</div><div class=\"line\"><span class=\"keyword\">import</span> &#123; SocketService &#125; <span class=\"keyword\">from</span> <span class=\"string\">\"./socket.service\"</span>;</div><div class=\"line\"> </div><div class=\"line\"><span class=\"meta\">@Component</span>(&#123;</div><div class=\"line\">    selector: <span class=\"string\">'app-root'</span>,</div><div class=\"line\">    templateUrl: <span class=\"string\">'./app.component.html'</span>,</div><div class=\"line\">    styleUrls: [<span class=\"string\">'./app.component.css'</span>]</div><div class=\"line\">&#125;)</div><div class=\"line\"><span class=\"keyword\">export</span> <span class=\"keyword\">class</span> AppComponent <span class=\"keyword\">implements</span> OnInit, OnDestroy &#123;</div><div class=\"line\"> </div><div class=\"line\">    <span class=\"keyword\">public</span> messages: <span class=\"built_in\">Array</span>&lt;<span class=\"built_in\">any</span>&gt;;</div><div class=\"line\">    <span class=\"keyword\">public</span> chatBox: <span class=\"built_in\">string</span>;</div><div class=\"line\"> </div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">constructor</span>(<span class=\"params\"><span class=\"keyword\">private</span> socket: SocketService</span>) &#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>.messages = [];</div><div class=\"line\">        <span class=\"keyword\">this</span>.chatBox = <span class=\"string\">\"\"</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\"> </div><div class=\"line\">    <span class=\"keyword\">public</span> ngOnInit() &#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>.socket.getEventListener().subscribe(<span class=\"function\"><span class=\"params\">event</span> =&gt;</span> &#123;</div><div class=\"line\">            <span class=\"keyword\">if</span>(event.type == <span class=\"string\">\"message\"</span>) &#123;</div><div class=\"line\">                <span class=\"keyword\">let</span> data = event.data.content;</div><div class=\"line\">                <span class=\"keyword\">if</span>(event.data.sender) &#123;</div><div class=\"line\">                    data = event.data.sender + <span class=\"string\">\": \"</span> + data;</div><div class=\"line\">                &#125;</div><div class=\"line\">                <span class=\"keyword\">this</span>.messages.push(data);</div><div class=\"line\">            &#125;</div><div class=\"line\">            <span class=\"keyword\">if</span>(event.type == <span class=\"string\">\"close\"</span>) &#123;</div><div class=\"line\">                <span class=\"keyword\">this</span>.messages.push(<span class=\"string\">\"/The socket connection has been closed\"</span>);</div><div class=\"line\">            &#125;</div><div class=\"line\">            <span class=\"keyword\">if</span>(event.type == <span class=\"string\">\"open\"</span>) &#123;</div><div class=\"line\">                <span class=\"keyword\">this</span>.messages.push(<span class=\"string\">\"/The socket connection has been established\"</span>);</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;);</div><div class=\"line\">    &#125;</div><div class=\"line\"> </div><div class=\"line\">    <span class=\"keyword\">public</span> ngOnDestroy() &#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>.socket.close();</div><div class=\"line\">    &#125;</div><div class=\"line\"> </div><div class=\"line\">    <span class=\"keyword\">public</span> send() &#123;</div><div class=\"line\">        <span class=\"keyword\">if</span>(<span class=\"keyword\">this</span>.chatBox) &#123;</div><div class=\"line\">            <span class=\"keyword\">this</span>.socket.send(<span class=\"keyword\">this</span>.chatBox);</div><div class=\"line\">            <span class=\"keyword\">this</span>.chatBox = <span class=\"string\">\"\"</span>;</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\"> </div><div class=\"line\">    <span class=\"keyword\">public</span> isSystemMessage(message: <span class=\"built_in\">string</span>) &#123;</div><div class=\"line\">        <span class=\"keyword\">return</span> message.startsWith(<span class=\"string\">\"/\"</span>) ? <span class=\"string\">\"&lt;strong&gt;\"</span> + message.substring(<span class=\"number\">1</span>) + <span class=\"string\">\"&lt;/strong&gt;\"</span> : message;</div><div class=\"line\">    &#125;</div><div class=\"line\"> </div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>在上述 AppComponent类的构造方法中，我们注册服务提供者并初始化需要绑定到UI的变量。在构造函数中加载或订阅不太好，我们使用ngOninit方法来代替。</p>\n<figure class=\"highlight typescript\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">//src/app/app.component.ts</span></div><div class=\"line\"><span class=\"keyword\">public</span> ngOnInit() &#123;</div><div class=\"line\">    <span class=\"keyword\">this</span>.socket.getEventListener().subscribe(<span class=\"function\"><span class=\"params\">event</span> =&gt;</span> &#123;</div><div class=\"line\">        <span class=\"keyword\">if</span>(event.type == <span class=\"string\">\"message\"</span>) &#123;</div><div class=\"line\">            <span class=\"keyword\">let</span> data = event.data.content;</div><div class=\"line\">            <span class=\"keyword\">if</span>(event.data.sender) &#123;</div><div class=\"line\">                data = event.data.sender + <span class=\"string\">\": \"</span> + data;</div><div class=\"line\">            &#125;</div><div class=\"line\">            <span class=\"keyword\">this</span>.messages.push(data);</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"keyword\">if</span>(event.type == <span class=\"string\">\"close\"</span>) &#123;</div><div class=\"line\">            <span class=\"keyword\">this</span>.messages.push(<span class=\"string\">\"/The socket connection has been closed\"</span>);</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"keyword\">if</span>(event.type == <span class=\"string\">\"open\"</span>) &#123;</div><div class=\"line\">            <span class=\"keyword\">this</span>.messages.push(<span class=\"string\">\"/The socket connection has been established\"</span>);</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>在上述方法中，我们订阅了在provider中创建的事件监听器。在这里我们需要检查发生了什么事件。如果是一条消息，需要检查是否存在发件人，然后将其添加到消息中。</p>\n<p>你可能注意到了，一些消息是以斜线开始的。用来表示系统消息，稍后会将其加粗。</p>\n<p>当客户端断开时，关闭事件将会发送到服务器，如果消息已经发送，它也会被发送到服务器。</p>\n<p>在查看HTML之前，先添加一些CSS，使其看起来更像一个聊天应用。打开 <strong>src/style.css</strong>，输入以下内容：</p>\n<figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">/*src/styles.css*/</span></div><div class=\"line\"><span class=\"comment\">/* You can add global styles to this file, and also import other style files */</span></div><div class=\"line\">* &#123; <span class=\"attribute\">margin</span>: <span class=\"number\">0</span>; <span class=\"attribute\">padding</span>: <span class=\"number\">0</span>; <span class=\"attribute\">box-sizing</span>: border-box; &#125;</div><div class=\"line\"><span class=\"selector-tag\">body</span> &#123; <span class=\"attribute\">font</span>: <span class=\"number\">13px</span> Helvetica, Arial; &#125;</div><div class=\"line\"><span class=\"selector-tag\">form</span> &#123; <span class=\"attribute\">background</span>: <span class=\"number\">#000</span>; <span class=\"attribute\">padding</span>: <span class=\"number\">3px</span>; <span class=\"attribute\">position</span>: fixed; <span class=\"attribute\">bottom</span>: <span class=\"number\">0</span>; <span class=\"attribute\">width</span>: <span class=\"number\">100%</span>; &#125;</div><div class=\"line\"><span class=\"selector-tag\">form</span> <span class=\"selector-tag\">input</span> &#123; <span class=\"attribute\">border</span>: <span class=\"number\">0</span>; <span class=\"attribute\">padding</span>: <span class=\"number\">10px</span>; <span class=\"attribute\">width</span>: <span class=\"number\">90%</span>; <span class=\"attribute\">margin-right</span>: .<span class=\"number\">5%</span>; &#125;</div><div class=\"line\"><span class=\"selector-tag\">form</span> <span class=\"selector-tag\">button</span> &#123; <span class=\"attribute\">width</span>: <span class=\"number\">9%</span>; <span class=\"attribute\">background</span>: <span class=\"built_in\">rgb</span>(130, 224, 255); <span class=\"attribute\">border</span>: none; <span class=\"attribute\">padding</span>: <span class=\"number\">10px</span>; &#125;</div><div class=\"line\"><span class=\"selector-id\">#messages</span> &#123; <span class=\"attribute\">list-style-type</span>: none; <span class=\"attribute\">margin</span>: <span class=\"number\">0</span>; <span class=\"attribute\">padding</span>: <span class=\"number\">0</span>; &#125;</div><div class=\"line\"><span class=\"selector-id\">#messages</span> <span class=\"selector-tag\">li</span> &#123; <span class=\"attribute\">padding</span>: <span class=\"number\">5px</span> <span class=\"number\">10px</span>; &#125;</div><div class=\"line\"><span class=\"selector-id\">#messages</span> <span class=\"selector-tag\">li</span><span class=\"selector-pseudo\">:nth-child(odd)</span> &#123; <span class=\"attribute\">background</span>: <span class=\"number\">#eee</span>; &#125;</div></pre></td></tr></table></figure>\n<p>现在，需要处理下HTML了。打开 <strong>src/app/app.component.html</strong> 文件，并输入以下内容：</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">&lt;!--src/app/app.component.html--&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">ul</span> <span class=\"attr\">id</span>=<span class=\"string\">\"messages\"</span>&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">li</span> *<span class=\"attr\">ngFor</span>=<span class=\"string\">\"let message of messages\"</span>&gt;</span></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">span</span> [<span class=\"attr\">innerHTML</span>]=<span class=\"string\">\"isSystemMessage(message)\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">span</span>&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">li</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">ul</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">form</span> <span class=\"attr\">action</span>=<span class=\"string\">\"\"</span>&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">input</span> [(<span class=\"attr\">ngModel</span>)]=<span class=\"string\">\"chatBox\"</span> [<span class=\"attr\">ngModelOptions</span>]=<span class=\"string\">\"&#123;standalone: true&#125;\"</span> <span class=\"attr\">autocomplete</span>=<span class=\"string\">\"off\"</span> /&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">button</span> (<span class=\"attr\">click</span>)=<span class=\"string\">\"send()\"</span>&gt;</span>Send<span class=\"tag\">&lt;/<span class=\"name\">button</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">form</span>&gt;</span></div></pre></td></tr></table></figure>\n<p>这里我们只是简单的将消息数组遍历到屏幕上 。以斜线开头的消息将会被加粗。提交按钮绑定到了send方法中，当按下时，会提交输入框中的内容到Go应用。</p>\n<h4 id=\"结语\"><a href=\"#结语\" class=\"headerlink\" title=\"结语\"></a>结语</h4><p>刚刚演示了如何使用 Go 和 Angular 2 创建一个 WebSocket 实时聊天应用。虽然没有在这个示例中存储聊天记录，但是这套逻辑可以应用于更复杂的项目，比如游戏，IOT，和其他很多场景。</p>\n<h4 id=\"关于原作者\"><a href=\"#关于原作者\" class=\"headerlink\" title=\"关于原作者\"></a>关于原作者</h4><p><a href=\"https://www.thepolyglotdeveloper.com/author/nraboy/\" target=\"_blank\" rel=\"external\">Nic Raboy</a>是现代网络和移动开发技术的倡导者。 他在Java，JavaScript，Golang以及各种框架（如Angular，NativeScript和Apache Cordova）方面拥有丰富的经验。 Nic写作的内容主要是他在使Web和移动开发更容易理解相关方面的经验。</p>\n"},{"title":"使用Dropbox同步hexo文章","date":"2015-12-27T13:47:09.000Z","_content":"![](/images/dropbox/20130702165945-558672261.jpg)\n\n继之前[那次失败的尝试](https://www.qichengzx.com/2015/11/13/dropbox-sync-hexo-and-autobuild-itself.html)之后（只在当时写的时候实验过几次，每次都以服务器卡死结束），后来在又多了几篇日志之后连generate也不能愉快的完成了。索性就在本地生成然后git push到服务器。\n\n现在想更激进一些，git只管理日志以外的东西，比如hexo的升级，或模板的调整和日志源文件。而生成的静态文件直接通过Dropbox客户端同步到服务器。\n\n话不多说。\n\n以下为前提：\n\n\t本地已安装hexo，和Dropbox客户端，并且客户端的同步目录已经选择到hexo的目录。\n\t服务器已安装dropbox服务，及相应的用户。\n\n\nDropbox的同步目录选hexo根目录或public都行，只是在服务器的处理脚本那同步修改下就行了。\n\n以下内容假设已在服务器添加dbox用户用于dropbox服务的同步处理。并且也已经设置了与dropbox账户的关联。\n\n#### 启动dropboxd\n\n用dbox用户登录服务器。\n\n然后，启动dropboxd进程。\n\n```\n~/dropbox-dist/dropboxd &\n```\n\n#### 设置文件夹监测\n\n##### 先安装incron服务。\n\n```\napt-get install incron\nyum install incron\n```\n\n##### 开机启动\n\n安装sysv-rc-conf，用于管理服务的启动\n\n```\napt-get install sysv-rc-conf\nsysv-rc-conf incron on\nsysv-rc-conf --list //用于查看所有服务的状态\n\n```\n\n##### 创建监测服务\n\n先修改下incron的编辑器\n\n```\nsudo vi /etc/incron.conf\n\n```\n\n在文件的最后一行，去掉editor = vi前的#，保存退出。\n\n输入：\n\n```\nincrontab -e\n```\n\n如果当前登录的不是dbox用户，可以使用\n```\nincrontab -udbox -e\n```\n\n然后输入：\n\n```\n/home/dbox/Dropbox/yourfolder/ IN_ATTRIB,IN_MOVE /home/dbox/dbox.sh\n\n```\n第一个参数：用来接收Dropbox同步的文件夹\n\n第二个参数：指监测的动作\n\n第三个参数：处理脚本\n\n监测的动作可以用：\n\n```\nIN_ACCESS，即文件被访问\nIN_MODIFY，文件被 write\nIN_ATTRIB，文件属性被修改，如 chmod、chown、touch 等\nIN_CLOSE_WRITE，可写文件被 close\nIN_CLOSE_NOWRITE，不可写文件被 close\nIN_OPEN，文件被 open\nIN_MOVED_FROM，文件被移走,如 mv\nIN_MOVED_TO，文件被移来，如 mv、cp\nIN_CREATE，创建新文件\nIN_DELETE，文件被删除，如 rm\nIN_DELETE_SELF，自删除，即一个可执行文件在执行时删除自己\nIN_MOVE_SELF，自移动，即一个可执行文件在执行时移动自己\nIN_UNMOUNT，宿主文件系统被 umount\nIN_CLOSE，文件被关闭，等同于(IN_CLOSE_WRITE | IN_CLOSE_NOWRITE)\nIN_MOVE，文件被移动，等同于(IN_MOVED_FROM | IN_MOVED_TO)\n#上面所说的文件也包括目录。\n```\n\n##### 处理同步后的文件的脚本\n\n```\ncd /home/dbox/\nvi dbox.sh\n\ncd /home/dbox/Dropbox/yoursite/\ncp -R public/ /var/www/yoursite/\n\n```\n最后一句要注意看你本地同步了哪些内容，还要注意与网站的目录对应。\n\n还要注意dbox.sh要有执行权限，和yoursite的写入权限。\n\n至此，完成。\n\n\n","source":"_posts/dropbox-sync-hexo-article.md","raw":"title: 使用Dropbox同步hexo文章\ndate: 2015-12-27 21:47:09\ntags:  [dropbox,hexo]\n---\n![](/images/dropbox/20130702165945-558672261.jpg)\n\n继之前[那次失败的尝试](https://www.qichengzx.com/2015/11/13/dropbox-sync-hexo-and-autobuild-itself.html)之后（只在当时写的时候实验过几次，每次都以服务器卡死结束），后来在又多了几篇日志之后连generate也不能愉快的完成了。索性就在本地生成然后git push到服务器。\n\n现在想更激进一些，git只管理日志以外的东西，比如hexo的升级，或模板的调整和日志源文件。而生成的静态文件直接通过Dropbox客户端同步到服务器。\n\n话不多说。\n\n以下为前提：\n\n\t本地已安装hexo，和Dropbox客户端，并且客户端的同步目录已经选择到hexo的目录。\n\t服务器已安装dropbox服务，及相应的用户。\n\n\nDropbox的同步目录选hexo根目录或public都行，只是在服务器的处理脚本那同步修改下就行了。\n\n以下内容假设已在服务器添加dbox用户用于dropbox服务的同步处理。并且也已经设置了与dropbox账户的关联。\n\n#### 启动dropboxd\n\n用dbox用户登录服务器。\n\n然后，启动dropboxd进程。\n\n```\n~/dropbox-dist/dropboxd &\n```\n\n#### 设置文件夹监测\n\n##### 先安装incron服务。\n\n```\napt-get install incron\nyum install incron\n```\n\n##### 开机启动\n\n安装sysv-rc-conf，用于管理服务的启动\n\n```\napt-get install sysv-rc-conf\nsysv-rc-conf incron on\nsysv-rc-conf --list //用于查看所有服务的状态\n\n```\n\n##### 创建监测服务\n\n先修改下incron的编辑器\n\n```\nsudo vi /etc/incron.conf\n\n```\n\n在文件的最后一行，去掉editor = vi前的#，保存退出。\n\n输入：\n\n```\nincrontab -e\n```\n\n如果当前登录的不是dbox用户，可以使用\n```\nincrontab -udbox -e\n```\n\n然后输入：\n\n```\n/home/dbox/Dropbox/yourfolder/ IN_ATTRIB,IN_MOVE /home/dbox/dbox.sh\n\n```\n第一个参数：用来接收Dropbox同步的文件夹\n\n第二个参数：指监测的动作\n\n第三个参数：处理脚本\n\n监测的动作可以用：\n\n```\nIN_ACCESS，即文件被访问\nIN_MODIFY，文件被 write\nIN_ATTRIB，文件属性被修改，如 chmod、chown、touch 等\nIN_CLOSE_WRITE，可写文件被 close\nIN_CLOSE_NOWRITE，不可写文件被 close\nIN_OPEN，文件被 open\nIN_MOVED_FROM，文件被移走,如 mv\nIN_MOVED_TO，文件被移来，如 mv、cp\nIN_CREATE，创建新文件\nIN_DELETE，文件被删除，如 rm\nIN_DELETE_SELF，自删除，即一个可执行文件在执行时删除自己\nIN_MOVE_SELF，自移动，即一个可执行文件在执行时移动自己\nIN_UNMOUNT，宿主文件系统被 umount\nIN_CLOSE，文件被关闭，等同于(IN_CLOSE_WRITE | IN_CLOSE_NOWRITE)\nIN_MOVE，文件被移动，等同于(IN_MOVED_FROM | IN_MOVED_TO)\n#上面所说的文件也包括目录。\n```\n\n##### 处理同步后的文件的脚本\n\n```\ncd /home/dbox/\nvi dbox.sh\n\ncd /home/dbox/Dropbox/yoursite/\ncp -R public/ /var/www/yoursite/\n\n```\n最后一句要注意看你本地同步了哪些内容，还要注意与网站的目录对应。\n\n还要注意dbox.sh要有执行权限，和yoursite的写入权限。\n\n至此，完成。\n\n\n","slug":"dropbox-sync-hexo-article","published":1,"updated":"2016-04-23T12:08:10.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj830jvdq0011ul0rujaht2om","content":"<p><img src=\"/images/dropbox/20130702165945-558672261.jpg\" alt=\"\"></p>\n<p>继之前<a href=\"https://www.qichengzx.com/2015/11/13/dropbox-sync-hexo-and-autobuild-itself.html\">那次失败的尝试</a>之后（只在当时写的时候实验过几次，每次都以服务器卡死结束），后来在又多了几篇日志之后连generate也不能愉快的完成了。索性就在本地生成然后git push到服务器。</p>\n<p>现在想更激进一些，git只管理日志以外的东西，比如hexo的升级，或模板的调整和日志源文件。而生成的静态文件直接通过Dropbox客户端同步到服务器。</p>\n<p>话不多说。</p>\n<p>以下为前提：</p>\n<pre><code>本地已安装hexo，和Dropbox客户端，并且客户端的同步目录已经选择到hexo的目录。\n服务器已安装dropbox服务，及相应的用户。\n</code></pre><p>Dropbox的同步目录选hexo根目录或public都行，只是在服务器的处理脚本那同步修改下就行了。</p>\n<p>以下内容假设已在服务器添加dbox用户用于dropbox服务的同步处理。并且也已经设置了与dropbox账户的关联。</p>\n<h4 id=\"启动dropboxd\"><a href=\"#启动dropboxd\" class=\"headerlink\" title=\"启动dropboxd\"></a>启动dropboxd</h4><p>用dbox用户登录服务器。</p>\n<p>然后，启动dropboxd进程。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">~/dropbox-dist/dropboxd &amp;</div></pre></td></tr></table></figure>\n<h4 id=\"设置文件夹监测\"><a href=\"#设置文件夹监测\" class=\"headerlink\" title=\"设置文件夹监测\"></a>设置文件夹监测</h4><h5 id=\"先安装incron服务。\"><a href=\"#先安装incron服务。\" class=\"headerlink\" title=\"先安装incron服务。\"></a>先安装incron服务。</h5><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">apt-get install incron</div><div class=\"line\">yum install incron</div></pre></td></tr></table></figure>\n<h5 id=\"开机启动\"><a href=\"#开机启动\" class=\"headerlink\" title=\"开机启动\"></a>开机启动</h5><p>安装sysv-rc-conf，用于管理服务的启动</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">apt-get install sysv-rc-conf</div><div class=\"line\">sysv-rc-conf incron on</div><div class=\"line\">sysv-rc-conf --list //用于查看所有服务的状态</div></pre></td></tr></table></figure>\n<h5 id=\"创建监测服务\"><a href=\"#创建监测服务\" class=\"headerlink\" title=\"创建监测服务\"></a>创建监测服务</h5><p>先修改下incron的编辑器</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">sudo vi /etc/incron.conf</div></pre></td></tr></table></figure>\n<p>在文件的最后一行，去掉editor = vi前的#，保存退出。</p>\n<p>输入：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">incrontab -e</div></pre></td></tr></table></figure>\n<p>如果当前登录的不是dbox用户，可以使用<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">incrontab -udbox -e</div></pre></td></tr></table></figure></p>\n<p>然后输入：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">/home/dbox/Dropbox/yourfolder/ IN_ATTRIB,IN_MOVE /home/dbox/dbox.sh</div></pre></td></tr></table></figure>\n<p>第一个参数：用来接收Dropbox同步的文件夹</p>\n<p>第二个参数：指监测的动作</p>\n<p>第三个参数：处理脚本</p>\n<p>监测的动作可以用：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div></pre></td><td class=\"code\"><pre><div class=\"line\">IN_ACCESS，即文件被访问</div><div class=\"line\">IN_MODIFY，文件被 write</div><div class=\"line\">IN_ATTRIB，文件属性被修改，如 chmod、chown、touch 等</div><div class=\"line\">IN_CLOSE_WRITE，可写文件被 close</div><div class=\"line\">IN_CLOSE_NOWRITE，不可写文件被 close</div><div class=\"line\">IN_OPEN，文件被 open</div><div class=\"line\">IN_MOVED_FROM，文件被移走,如 mv</div><div class=\"line\">IN_MOVED_TO，文件被移来，如 mv、cp</div><div class=\"line\">IN_CREATE，创建新文件</div><div class=\"line\">IN_DELETE，文件被删除，如 rm</div><div class=\"line\">IN_DELETE_SELF，自删除，即一个可执行文件在执行时删除自己</div><div class=\"line\">IN_MOVE_SELF，自移动，即一个可执行文件在执行时移动自己</div><div class=\"line\">IN_UNMOUNT，宿主文件系统被 umount</div><div class=\"line\">IN_CLOSE，文件被关闭，等同于(IN_CLOSE_WRITE | IN_CLOSE_NOWRITE)</div><div class=\"line\">IN_MOVE，文件被移动，等同于(IN_MOVED_FROM | IN_MOVED_TO)</div><div class=\"line\">#上面所说的文件也包括目录。</div></pre></td></tr></table></figure>\n<h5 id=\"处理同步后的文件的脚本\"><a href=\"#处理同步后的文件的脚本\" class=\"headerlink\" title=\"处理同步后的文件的脚本\"></a>处理同步后的文件的脚本</h5><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">cd /home/dbox/</div><div class=\"line\">vi dbox.sh</div><div class=\"line\"></div><div class=\"line\">cd /home/dbox/Dropbox/yoursite/</div><div class=\"line\">cp -R public/ /var/www/yoursite/</div></pre></td></tr></table></figure>\n<p>最后一句要注意看你本地同步了哪些内容，还要注意与网站的目录对应。</p>\n<p>还要注意dbox.sh要有执行权限，和yoursite的写入权限。</p>\n<p>至此，完成。</p>\n","site":{"data":{}},"excerpt":"","more":"<p><img src=\"/images/dropbox/20130702165945-558672261.jpg\" alt=\"\"></p>\n<p>继之前<a href=\"https://www.qichengzx.com/2015/11/13/dropbox-sync-hexo-and-autobuild-itself.html\">那次失败的尝试</a>之后（只在当时写的时候实验过几次，每次都以服务器卡死结束），后来在又多了几篇日志之后连generate也不能愉快的完成了。索性就在本地生成然后git push到服务器。</p>\n<p>现在想更激进一些，git只管理日志以外的东西，比如hexo的升级，或模板的调整和日志源文件。而生成的静态文件直接通过Dropbox客户端同步到服务器。</p>\n<p>话不多说。</p>\n<p>以下为前提：</p>\n<pre><code>本地已安装hexo，和Dropbox客户端，并且客户端的同步目录已经选择到hexo的目录。\n服务器已安装dropbox服务，及相应的用户。\n</code></pre><p>Dropbox的同步目录选hexo根目录或public都行，只是在服务器的处理脚本那同步修改下就行了。</p>\n<p>以下内容假设已在服务器添加dbox用户用于dropbox服务的同步处理。并且也已经设置了与dropbox账户的关联。</p>\n<h4 id=\"启动dropboxd\"><a href=\"#启动dropboxd\" class=\"headerlink\" title=\"启动dropboxd\"></a>启动dropboxd</h4><p>用dbox用户登录服务器。</p>\n<p>然后，启动dropboxd进程。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">~/dropbox-dist/dropboxd &amp;</div></pre></td></tr></table></figure>\n<h4 id=\"设置文件夹监测\"><a href=\"#设置文件夹监测\" class=\"headerlink\" title=\"设置文件夹监测\"></a>设置文件夹监测</h4><h5 id=\"先安装incron服务。\"><a href=\"#先安装incron服务。\" class=\"headerlink\" title=\"先安装incron服务。\"></a>先安装incron服务。</h5><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">apt-get install incron</div><div class=\"line\">yum install incron</div></pre></td></tr></table></figure>\n<h5 id=\"开机启动\"><a href=\"#开机启动\" class=\"headerlink\" title=\"开机启动\"></a>开机启动</h5><p>安装sysv-rc-conf，用于管理服务的启动</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">apt-get install sysv-rc-conf</div><div class=\"line\">sysv-rc-conf incron on</div><div class=\"line\">sysv-rc-conf --list //用于查看所有服务的状态</div></pre></td></tr></table></figure>\n<h5 id=\"创建监测服务\"><a href=\"#创建监测服务\" class=\"headerlink\" title=\"创建监测服务\"></a>创建监测服务</h5><p>先修改下incron的编辑器</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">sudo vi /etc/incron.conf</div></pre></td></tr></table></figure>\n<p>在文件的最后一行，去掉editor = vi前的#，保存退出。</p>\n<p>输入：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">incrontab -e</div></pre></td></tr></table></figure>\n<p>如果当前登录的不是dbox用户，可以使用<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">incrontab -udbox -e</div></pre></td></tr></table></figure></p>\n<p>然后输入：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">/home/dbox/Dropbox/yourfolder/ IN_ATTRIB,IN_MOVE /home/dbox/dbox.sh</div></pre></td></tr></table></figure>\n<p>第一个参数：用来接收Dropbox同步的文件夹</p>\n<p>第二个参数：指监测的动作</p>\n<p>第三个参数：处理脚本</p>\n<p>监测的动作可以用：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div></pre></td><td class=\"code\"><pre><div class=\"line\">IN_ACCESS，即文件被访问</div><div class=\"line\">IN_MODIFY，文件被 write</div><div class=\"line\">IN_ATTRIB，文件属性被修改，如 chmod、chown、touch 等</div><div class=\"line\">IN_CLOSE_WRITE，可写文件被 close</div><div class=\"line\">IN_CLOSE_NOWRITE，不可写文件被 close</div><div class=\"line\">IN_OPEN，文件被 open</div><div class=\"line\">IN_MOVED_FROM，文件被移走,如 mv</div><div class=\"line\">IN_MOVED_TO，文件被移来，如 mv、cp</div><div class=\"line\">IN_CREATE，创建新文件</div><div class=\"line\">IN_DELETE，文件被删除，如 rm</div><div class=\"line\">IN_DELETE_SELF，自删除，即一个可执行文件在执行时删除自己</div><div class=\"line\">IN_MOVE_SELF，自移动，即一个可执行文件在执行时移动自己</div><div class=\"line\">IN_UNMOUNT，宿主文件系统被 umount</div><div class=\"line\">IN_CLOSE，文件被关闭，等同于(IN_CLOSE_WRITE | IN_CLOSE_NOWRITE)</div><div class=\"line\">IN_MOVE，文件被移动，等同于(IN_MOVED_FROM | IN_MOVED_TO)</div><div class=\"line\">#上面所说的文件也包括目录。</div></pre></td></tr></table></figure>\n<h5 id=\"处理同步后的文件的脚本\"><a href=\"#处理同步后的文件的脚本\" class=\"headerlink\" title=\"处理同步后的文件的脚本\"></a>处理同步后的文件的脚本</h5><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">cd /home/dbox/</div><div class=\"line\">vi dbox.sh</div><div class=\"line\"></div><div class=\"line\">cd /home/dbox/Dropbox/yoursite/</div><div class=\"line\">cp -R public/ /var/www/yoursite/</div></pre></td></tr></table></figure>\n<p>最后一句要注意看你本地同步了哪些内容，还要注意与网站的目录对应。</p>\n<p>还要注意dbox.sh要有执行权限，和yoursite的写入权限。</p>\n<p>至此，完成。</p>\n"},{"title":"利用Dropbox同步hexo的文章源文件并自动生成文章发布","layout":"photo","date":"2015-11-13T06:12:35.000Z","_content":"\n** 阅读之前默认为已在服务器安装hexo，也默认服务器可以访问Dropbox **\n\n** 不建议服务器内存小于512M ，谁卡谁知道 **\n\n\n### 最初的最初\n\n先说下我最终完成的结构：\n\n\t1.本地有一个日志文件夹，用于存放md文件，或HTML文件，作为本地的Dropbox客户端同步的目录\n\t2.服务器home文件夹中init一套hexo程序，用于接收本地的md文件，和generate，minify\n\t\n流程：\n\n\t1.本地撰写，本地客户端自动同步\n\t2.服务器Dropbox设置的同步目录接收本地的内容并cp到专门用于生成的hexo目录里\n\t3.服务器用于生成的hexo生成新日志，cp到web目录中\n\t\n这么做的原因是，如果一共（是整个博客一共）只有一篇文章或几篇文章，那几乎没影响，如果，有几十篇了，据我观察，生成很耗时，可能会导致搜索引擎访问出现404，用户打开一个生成到一半的文件，用户打开一个木有样式的文章。\n\n\n### STEP 0 安装Dropbox\n\n[注册Dropbox](https://db.tt/mMNtRA6x)。\n\n\n```\nif( ! has_dropbox_account() ){\n\treturn \"请先注册个账户啊亲\";\n}\n```\n\n由于Dropbox默认安装在~，所以建议新建一个专用于同步的账户，如dbox。\n\n```\nadduser dbox\npasswd dbox \n```\n\n** 请记住密码。请记住密码。请记住密码。 **\n\n然后，用新建的账户登录进去。\n\n终于可以安装Dropbox了。\n\n这里要区分一下你的系统，\n\n** 32位: **\n\n```\ncd ~ && wget -O - \"https://www.dropbox.com/download?plat=lnx.x86\" | tar xzf -\n```\n\n** 64位: **\n\n```\ncd ~ && wget -O - \"https://www.dropbox.com/download?plat=lnx.x86_64\" | tar xzf -\n```\n\n然后就可以运行Dropbox的守护程序了\n\n```\n~/.dropbox-dist/dropboxd &\n```\n\n第一次在新的电脑上启动，会提示：\n\n\t此电脑尚未与任何 Dropbox 帐户关联...\n\n\t请访问 https://www.dropbox.com/cli_link_nonce?nonce=95cd317d2***** 来关联此设备。\n\n\t此电脑现在已与 Dropbox 关联。欢迎 yourname username\n\n\n** 注意在出现“此电脑现在已与 Dropbox 关联。欢迎 your username”前不要ctrl+c 退出这个程序。 **\n\n打开授权链接后会出现如下的提示，选择连接即可。\n\n![](http://7b1hhm.com1.z0.glb.clouddn.com/hexo33B2BAAF-6996-41AA-BFA3-FC177106F62A.png)\n\n一定要注意，不然你都会奇怪为啥再次启动这个进程的时候还会出现“尚未关联的提示”\n\n验证成功后，会在当前用户的home目录中创建Dropbox目录，即Dropbox同步的目录。\n\n此时，如果你打开了 top，那应该发现此时服务器的内存有点捉急了，原因是Dropbox这个进程占的很多，所以一般情况下killall dropbox 退出就好了，壕请随意。\n\n\n### STEP 1 设置文件夹监测\n\n\n**安装incron服务**\n\t\nincron是Linux下一个监测文件变化的服务\n\t\n\n```\napt-get install incron\nyum install incron\n\n```\n\n** 设置开机启动 **\n\n安装sysv-rc-conf，用于管理服务的启动\n\n```\napt-get install sysv-rc-conf\nsysv-rc-conf incron on\n\n```\n\n** 创建监测任务 **\n\n先修改下incron的编辑器\n\n```\nvi /etc/incron.conf\n\n```\n\n（此时可能需要sudo权限，因为是dbox用户）在文件的最后一行，去掉editor = vi前的#，保存退出。\n\n输入：incrontab -e\n\n\n```\n/home/dbox/Dropbox/yourfolder/ IN_ATTRIB,IN_MOVE /home/dbox/hexo.bash\n\n```\n\n第一个参数：用来接收Dropbox同步的文件夹\n\n第二个参数：指监测的动作\n\n第三个参数：处理脚本\n\n监测的动作可以用：\n\n\tIN_ACCESS，即文件被访问\n\tIN_MODIFY，文件被 write\n\tIN_ATTRIB，文件属性被修改，如 chmod、chown、touch 等\n\tIN_CLOSE_WRITE，可写文件被 close\n\tIN_CLOSE_NOWRITE，不可写文件被 close\n\tIN_OPEN，文件被 open\n\tIN_MOVED_FROM，文件被移走,如 mv\n\tIN_MOVED_TO，文件被移来，如 mv、cp\n\tIN_CREATE，创建新文件\n\tIN_DELETE，文件被删除，如 rm\n\tIN_DELETE_SELF，自删除，即一个可执行文件在执行时删除自己\n\tIN_MOVE_SELF，自移动，即一个可执行文件在执行时移动自己\n\tIN_UNMOUNT，宿主文件系统被 umount\n\tIN_CLOSE，文件被关闭，等同于(IN_CLOSE_WRITE | IN_CLOSE_NOWRITE)\n\tIN_MOVE，文件被移动，等同于(IN_MOVED_FROM | IN_MOVED_TO)\n\t#上面所说的文件也包括目录。\n\n\n可以选自己需要的动作\n\n接下来写处理脚本\n```\nvi hexo.bash\n```\n\n\n```\ncp -R /home/dbox/Dropbox/yourfolder/* /home/dbox/dropasync/source/_posts/;\ncd /home/dbox/dropasync/ && hexo gm\ncd ~ && ./.dropbox-dist/dropboxd\n\n```\n\n理论上到这里已经可以了。\n\n~~但是实际上我本人在测试的时候，512内存的服务器会只剩下4M内存，然后再执行任何命令都提示\n```-bash: fork: Cannot allocate memory```，持续很长时间，一开始以为是同时跑的进程太多导致内存不够，把没用的mongodb，redis都kill之后还是这样，后来干脆在执行这个脚本的时候把Dropbox的后台禁掉，也不行，之后想到了在这段脚本里echo一段数字到log中，执行的时候发现会写入多次，但是还是不清楚为什么会出现这种情况，进程里也是出现了两个或多个hexo，于是干脆就在这段脚本开始时先kill dropbox和hexo，在末尾再kill hexo。实际运行起来，内存还是会降到最低，但是持续时间明显减少到可以接受的程度。~~\n\n---\n2015-11-21 14:06:07 附截图\n---\n\n![](http://7b1hhm.com1.z0.glb.clouddn.com/hexoF2A913D3-14C5-4FC9-B177-500AC0434036.png)\n\n---\n2015-11-14 22:38:06 测试发现，上述带删除线的方法依然不行。内存依然会榨干很长时间。\n\n---\n\n\n至于为何出现这个情况，咱不可知。。。总不能完全是因为内存太小吧……\n\n后续应该还会继续改进这个脚本。\n\n**另外，在安装这个用于生成日志的hexo程序的时候也出现了npm killed的问题，查了资料发现也是因为内存不足，npm install -d 可以查看安装过程，如果出错可以用来定位到底是什么原因引起错误**\n\n\n一些参考资料：\n\n[Hexo 服务器端布署及 Dropbox 同步](http://lucifr.com/2013/06/02/hexo-on-cloud-with-dropbox-and-vps/)\n\n[用Hexo+Vps搭建博客并用Dropbox同步自动发布](http://www.fanicy.com/2014/06/01/0001.hexowithvpsdropbox/)\n\n[incrontab(5) - Linux man page](http://linux.die.net/man/5/incrontab)\n\n[incron：linux下基于文件的事件触发](http://wlx.westgis.ac.cn/tag/incrontab/)\n\n[Why is chkconfig no longer available in Ubuntu?](http://askubuntu.com/questions/221293/why-is-chkconfig-no-longer-available-in-ubuntu)\n\n[Use incron to Trigger Action when File Changes 如果设置incrontab出现问题可以参考这篇](https://www.garron.me/en/linux/use-incron-rsync-dropbox-backup.html)\n","source":"_posts/dropbox-sync-hexo-and-autobuild-itself.md","raw":"title: 利用Dropbox同步hexo的文章源文件并自动生成文章发布\nlayout: photo\ndate: 2015-11-13 14:12:35\ntags:  [hexo,dropbox]\n---\n\n** 阅读之前默认为已在服务器安装hexo，也默认服务器可以访问Dropbox **\n\n** 不建议服务器内存小于512M ，谁卡谁知道 **\n\n\n### 最初的最初\n\n先说下我最终完成的结构：\n\n\t1.本地有一个日志文件夹，用于存放md文件，或HTML文件，作为本地的Dropbox客户端同步的目录\n\t2.服务器home文件夹中init一套hexo程序，用于接收本地的md文件，和generate，minify\n\t\n流程：\n\n\t1.本地撰写，本地客户端自动同步\n\t2.服务器Dropbox设置的同步目录接收本地的内容并cp到专门用于生成的hexo目录里\n\t3.服务器用于生成的hexo生成新日志，cp到web目录中\n\t\n这么做的原因是，如果一共（是整个博客一共）只有一篇文章或几篇文章，那几乎没影响，如果，有几十篇了，据我观察，生成很耗时，可能会导致搜索引擎访问出现404，用户打开一个生成到一半的文件，用户打开一个木有样式的文章。\n\n\n### STEP 0 安装Dropbox\n\n[注册Dropbox](https://db.tt/mMNtRA6x)。\n\n\n```\nif( ! has_dropbox_account() ){\n\treturn \"请先注册个账户啊亲\";\n}\n```\n\n由于Dropbox默认安装在~，所以建议新建一个专用于同步的账户，如dbox。\n\n```\nadduser dbox\npasswd dbox \n```\n\n** 请记住密码。请记住密码。请记住密码。 **\n\n然后，用新建的账户登录进去。\n\n终于可以安装Dropbox了。\n\n这里要区分一下你的系统，\n\n** 32位: **\n\n```\ncd ~ && wget -O - \"https://www.dropbox.com/download?plat=lnx.x86\" | tar xzf -\n```\n\n** 64位: **\n\n```\ncd ~ && wget -O - \"https://www.dropbox.com/download?plat=lnx.x86_64\" | tar xzf -\n```\n\n然后就可以运行Dropbox的守护程序了\n\n```\n~/.dropbox-dist/dropboxd &\n```\n\n第一次在新的电脑上启动，会提示：\n\n\t此电脑尚未与任何 Dropbox 帐户关联...\n\n\t请访问 https://www.dropbox.com/cli_link_nonce?nonce=95cd317d2***** 来关联此设备。\n\n\t此电脑现在已与 Dropbox 关联。欢迎 yourname username\n\n\n** 注意在出现“此电脑现在已与 Dropbox 关联。欢迎 your username”前不要ctrl+c 退出这个程序。 **\n\n打开授权链接后会出现如下的提示，选择连接即可。\n\n![](http://7b1hhm.com1.z0.glb.clouddn.com/hexo33B2BAAF-6996-41AA-BFA3-FC177106F62A.png)\n\n一定要注意，不然你都会奇怪为啥再次启动这个进程的时候还会出现“尚未关联的提示”\n\n验证成功后，会在当前用户的home目录中创建Dropbox目录，即Dropbox同步的目录。\n\n此时，如果你打开了 top，那应该发现此时服务器的内存有点捉急了，原因是Dropbox这个进程占的很多，所以一般情况下killall dropbox 退出就好了，壕请随意。\n\n\n### STEP 1 设置文件夹监测\n\n\n**安装incron服务**\n\t\nincron是Linux下一个监测文件变化的服务\n\t\n\n```\napt-get install incron\nyum install incron\n\n```\n\n** 设置开机启动 **\n\n安装sysv-rc-conf，用于管理服务的启动\n\n```\napt-get install sysv-rc-conf\nsysv-rc-conf incron on\n\n```\n\n** 创建监测任务 **\n\n先修改下incron的编辑器\n\n```\nvi /etc/incron.conf\n\n```\n\n（此时可能需要sudo权限，因为是dbox用户）在文件的最后一行，去掉editor = vi前的#，保存退出。\n\n输入：incrontab -e\n\n\n```\n/home/dbox/Dropbox/yourfolder/ IN_ATTRIB,IN_MOVE /home/dbox/hexo.bash\n\n```\n\n第一个参数：用来接收Dropbox同步的文件夹\n\n第二个参数：指监测的动作\n\n第三个参数：处理脚本\n\n监测的动作可以用：\n\n\tIN_ACCESS，即文件被访问\n\tIN_MODIFY，文件被 write\n\tIN_ATTRIB，文件属性被修改，如 chmod、chown、touch 等\n\tIN_CLOSE_WRITE，可写文件被 close\n\tIN_CLOSE_NOWRITE，不可写文件被 close\n\tIN_OPEN，文件被 open\n\tIN_MOVED_FROM，文件被移走,如 mv\n\tIN_MOVED_TO，文件被移来，如 mv、cp\n\tIN_CREATE，创建新文件\n\tIN_DELETE，文件被删除，如 rm\n\tIN_DELETE_SELF，自删除，即一个可执行文件在执行时删除自己\n\tIN_MOVE_SELF，自移动，即一个可执行文件在执行时移动自己\n\tIN_UNMOUNT，宿主文件系统被 umount\n\tIN_CLOSE，文件被关闭，等同于(IN_CLOSE_WRITE | IN_CLOSE_NOWRITE)\n\tIN_MOVE，文件被移动，等同于(IN_MOVED_FROM | IN_MOVED_TO)\n\t#上面所说的文件也包括目录。\n\n\n可以选自己需要的动作\n\n接下来写处理脚本\n```\nvi hexo.bash\n```\n\n\n```\ncp -R /home/dbox/Dropbox/yourfolder/* /home/dbox/dropasync/source/_posts/;\ncd /home/dbox/dropasync/ && hexo gm\ncd ~ && ./.dropbox-dist/dropboxd\n\n```\n\n理论上到这里已经可以了。\n\n~~但是实际上我本人在测试的时候，512内存的服务器会只剩下4M内存，然后再执行任何命令都提示\n```-bash: fork: Cannot allocate memory```，持续很长时间，一开始以为是同时跑的进程太多导致内存不够，把没用的mongodb，redis都kill之后还是这样，后来干脆在执行这个脚本的时候把Dropbox的后台禁掉，也不行，之后想到了在这段脚本里echo一段数字到log中，执行的时候发现会写入多次，但是还是不清楚为什么会出现这种情况，进程里也是出现了两个或多个hexo，于是干脆就在这段脚本开始时先kill dropbox和hexo，在末尾再kill hexo。实际运行起来，内存还是会降到最低，但是持续时间明显减少到可以接受的程度。~~\n\n---\n2015-11-21 14:06:07 附截图\n---\n\n![](http://7b1hhm.com1.z0.glb.clouddn.com/hexoF2A913D3-14C5-4FC9-B177-500AC0434036.png)\n\n---\n2015-11-14 22:38:06 测试发现，上述带删除线的方法依然不行。内存依然会榨干很长时间。\n\n---\n\n\n至于为何出现这个情况，咱不可知。。。总不能完全是因为内存太小吧……\n\n后续应该还会继续改进这个脚本。\n\n**另外，在安装这个用于生成日志的hexo程序的时候也出现了npm killed的问题，查了资料发现也是因为内存不足，npm install -d 可以查看安装过程，如果出错可以用来定位到底是什么原因引起错误**\n\n\n一些参考资料：\n\n[Hexo 服务器端布署及 Dropbox 同步](http://lucifr.com/2013/06/02/hexo-on-cloud-with-dropbox-and-vps/)\n\n[用Hexo+Vps搭建博客并用Dropbox同步自动发布](http://www.fanicy.com/2014/06/01/0001.hexowithvpsdropbox/)\n\n[incrontab(5) - Linux man page](http://linux.die.net/man/5/incrontab)\n\n[incron：linux下基于文件的事件触发](http://wlx.westgis.ac.cn/tag/incrontab/)\n\n[Why is chkconfig no longer available in Ubuntu?](http://askubuntu.com/questions/221293/why-is-chkconfig-no-longer-available-in-ubuntu)\n\n[Use incron to Trigger Action when File Changes 如果设置incrontab出现问题可以参考这篇](https://www.garron.me/en/linux/use-incron-rsync-dropbox-backup.html)\n","slug":"dropbox-sync-hexo-and-autobuild-itself","published":1,"updated":"2015-12-19T07:50:01.000Z","comments":1,"photos":[],"link":"","_id":"cj830jvds0016ul0r3nthdxw7","content":"<p><strong> 阅读之前默认为已在服务器安装hexo，也默认服务器可以访问Dropbox </strong></p>\n<p><strong> 不建议服务器内存小于512M ，谁卡谁知道 </strong></p>\n<h3 id=\"最初的最初\"><a href=\"#最初的最初\" class=\"headerlink\" title=\"最初的最初\"></a>最初的最初</h3><p>先说下我最终完成的结构：</p>\n<pre><code>1.本地有一个日志文件夹，用于存放md文件，或HTML文件，作为本地的Dropbox客户端同步的目录\n2.服务器home文件夹中init一套hexo程序，用于接收本地的md文件，和generate，minify\n</code></pre><p>流程：</p>\n<pre><code>1.本地撰写，本地客户端自动同步\n2.服务器Dropbox设置的同步目录接收本地的内容并cp到专门用于生成的hexo目录里\n3.服务器用于生成的hexo生成新日志，cp到web目录中\n</code></pre><p>这么做的原因是，如果一共（是整个博客一共）只有一篇文章或几篇文章，那几乎没影响，如果，有几十篇了，据我观察，生成很耗时，可能会导致搜索引擎访问出现404，用户打开一个生成到一半的文件，用户打开一个木有样式的文章。</p>\n<h3 id=\"STEP-0-安装Dropbox\"><a href=\"#STEP-0-安装Dropbox\" class=\"headerlink\" title=\"STEP 0 安装Dropbox\"></a>STEP 0 安装Dropbox</h3><p><a href=\"https://db.tt/mMNtRA6x\" target=\"_blank\" rel=\"external\">注册Dropbox</a>。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">if( ! has_dropbox_account() )&#123;</div><div class=\"line\">\treturn &quot;请先注册个账户啊亲&quot;;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>由于Dropbox默认安装在~，所以建议新建一个专用于同步的账户，如dbox。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">adduser dbox</div><div class=\"line\">passwd dbox</div></pre></td></tr></table></figure>\n<p><strong> 请记住密码。请记住密码。请记住密码。 </strong></p>\n<p>然后，用新建的账户登录进去。</p>\n<p>终于可以安装Dropbox了。</p>\n<p>这里要区分一下你的系统，</p>\n<p><strong> 32位: </strong></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">cd ~ &amp;&amp; wget -O - &quot;https://www.dropbox.com/download?plat=lnx.x86&quot; | tar xzf -</div></pre></td></tr></table></figure>\n<p><strong> 64位: </strong></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">cd ~ &amp;&amp; wget -O - &quot;https://www.dropbox.com/download?plat=lnx.x86_64&quot; | tar xzf -</div></pre></td></tr></table></figure>\n<p>然后就可以运行Dropbox的守护程序了</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">~/.dropbox-dist/dropboxd &amp;</div></pre></td></tr></table></figure>\n<p>第一次在新的电脑上启动，会提示：</p>\n<pre><code>此电脑尚未与任何 Dropbox 帐户关联...\n\n请访问 https://www.dropbox.com/cli_link_nonce?nonce=95cd317d2***** 来关联此设备。\n\n此电脑现在已与 Dropbox 关联。欢迎 yourname username\n</code></pre><p><strong> 注意在出现“此电脑现在已与 Dropbox 关联。欢迎 your username”前不要ctrl+c 退出这个程序。 </strong></p>\n<p>打开授权链接后会出现如下的提示，选择连接即可。</p>\n<p><img src=\"http://7b1hhm.com1.z0.glb.clouddn.com/hexo33B2BAAF-6996-41AA-BFA3-FC177106F62A.png\" alt=\"\"></p>\n<p>一定要注意，不然你都会奇怪为啥再次启动这个进程的时候还会出现“尚未关联的提示”</p>\n<p>验证成功后，会在当前用户的home目录中创建Dropbox目录，即Dropbox同步的目录。</p>\n<p>此时，如果你打开了 top，那应该发现此时服务器的内存有点捉急了，原因是Dropbox这个进程占的很多，所以一般情况下killall dropbox 退出就好了，壕请随意。</p>\n<h3 id=\"STEP-1-设置文件夹监测\"><a href=\"#STEP-1-设置文件夹监测\" class=\"headerlink\" title=\"STEP 1 设置文件夹监测\"></a>STEP 1 设置文件夹监测</h3><p><strong>安装incron服务</strong></p>\n<p>incron是Linux下一个监测文件变化的服务</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">apt-get install incron</div><div class=\"line\">yum install incron</div></pre></td></tr></table></figure>\n<p><strong> 设置开机启动 </strong></p>\n<p>安装sysv-rc-conf，用于管理服务的启动</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">apt-get install sysv-rc-conf</div><div class=\"line\">sysv-rc-conf incron on</div></pre></td></tr></table></figure>\n<p><strong> 创建监测任务 </strong></p>\n<p>先修改下incron的编辑器</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">vi /etc/incron.conf</div></pre></td></tr></table></figure>\n<p>（此时可能需要sudo权限，因为是dbox用户）在文件的最后一行，去掉editor = vi前的#，保存退出。</p>\n<p>输入：incrontab -e</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">/home/dbox/Dropbox/yourfolder/ IN_ATTRIB,IN_MOVE /home/dbox/hexo.bash</div></pre></td></tr></table></figure>\n<p>第一个参数：用来接收Dropbox同步的文件夹</p>\n<p>第二个参数：指监测的动作</p>\n<p>第三个参数：处理脚本</p>\n<p>监测的动作可以用：</p>\n<pre><code>IN_ACCESS，即文件被访问\nIN_MODIFY，文件被 write\nIN_ATTRIB，文件属性被修改，如 chmod、chown、touch 等\nIN_CLOSE_WRITE，可写文件被 close\nIN_CLOSE_NOWRITE，不可写文件被 close\nIN_OPEN，文件被 open\nIN_MOVED_FROM，文件被移走,如 mv\nIN_MOVED_TO，文件被移来，如 mv、cp\nIN_CREATE，创建新文件\nIN_DELETE，文件被删除，如 rm\nIN_DELETE_SELF，自删除，即一个可执行文件在执行时删除自己\nIN_MOVE_SELF，自移动，即一个可执行文件在执行时移动自己\nIN_UNMOUNT，宿主文件系统被 umount\nIN_CLOSE，文件被关闭，等同于(IN_CLOSE_WRITE | IN_CLOSE_NOWRITE)\nIN_MOVE，文件被移动，等同于(IN_MOVED_FROM | IN_MOVED_TO)\n#上面所说的文件也包括目录。\n</code></pre><p>可以选自己需要的动作</p>\n<p>接下来写处理脚本<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">vi hexo.bash</div></pre></td></tr></table></figure></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">cp -R /home/dbox/Dropbox/yourfolder/* /home/dbox/dropasync/source/_posts/;</div><div class=\"line\">cd /home/dbox/dropasync/ &amp;&amp; hexo gm</div><div class=\"line\">cd ~ &amp;&amp; ./.dropbox-dist/dropboxd</div></pre></td></tr></table></figure>\n<p>理论上到这里已经可以了。</p>\n<p><del>但是实际上我本人在测试的时候，512内存的服务器会只剩下4M内存，然后再执行任何命令都提示<br><code>-bash: fork: Cannot allocate memory</code>，持续很长时间，一开始以为是同时跑的进程太多导致内存不够，把没用的mongodb，redis都kill之后还是这样，后来干脆在执行这个脚本的时候把Dropbox的后台禁掉，也不行，之后想到了在这段脚本里echo一段数字到log中，执行的时候发现会写入多次，但是还是不清楚为什么会出现这种情况，进程里也是出现了两个或多个hexo，于是干脆就在这段脚本开始时先kill dropbox和hexo，在末尾再kill hexo。实际运行起来，内存还是会降到最低，但是持续时间明显减少到可以接受的程度。</del></p>\n<hr>\n<h2 id=\"2015-11-21-14-06-07-附截图\"><a href=\"#2015-11-21-14-06-07-附截图\" class=\"headerlink\" title=\"2015-11-21 14:06:07 附截图\"></a>2015-11-21 14:06:07 附截图</h2><p><img src=\"http://7b1hhm.com1.z0.glb.clouddn.com/hexoF2A913D3-14C5-4FC9-B177-500AC0434036.png\" alt=\"\"></p>\n<hr>\n<p>2015-11-14 22:38:06 测试发现，上述带删除线的方法依然不行。内存依然会榨干很长时间。</p>\n<hr>\n<p>至于为何出现这个情况，咱不可知。。。总不能完全是因为内存太小吧……</p>\n<p>后续应该还会继续改进这个脚本。</p>\n<p><strong>另外，在安装这个用于生成日志的hexo程序的时候也出现了npm killed的问题，查了资料发现也是因为内存不足，npm install -d 可以查看安装过程，如果出错可以用来定位到底是什么原因引起错误</strong></p>\n<p>一些参考资料：</p>\n<p><a href=\"http://lucifr.com/2013/06/02/hexo-on-cloud-with-dropbox-and-vps/\" target=\"_blank\" rel=\"external\">Hexo 服务器端布署及 Dropbox 同步</a></p>\n<p><a href=\"http://www.fanicy.com/2014/06/01/0001.hexowithvpsdropbox/\" target=\"_blank\" rel=\"external\">用Hexo+Vps搭建博客并用Dropbox同步自动发布</a></p>\n<p><a href=\"http://linux.die.net/man/5/incrontab\" target=\"_blank\" rel=\"external\">incrontab(5) - Linux man page</a></p>\n<p><a href=\"http://wlx.westgis.ac.cn/tag/incrontab/\" target=\"_blank\" rel=\"external\">incron：linux下基于文件的事件触发</a></p>\n<p><a href=\"http://askubuntu.com/questions/221293/why-is-chkconfig-no-longer-available-in-ubuntu\" target=\"_blank\" rel=\"external\">Why is chkconfig no longer available in Ubuntu?</a></p>\n<p><a href=\"https://www.garron.me/en/linux/use-incron-rsync-dropbox-backup.html\" target=\"_blank\" rel=\"external\">Use incron to Trigger Action when File Changes 如果设置incrontab出现问题可以参考这篇</a></p>\n","site":{"data":{}},"excerpt":"","more":"<p><strong> 阅读之前默认为已在服务器安装hexo，也默认服务器可以访问Dropbox </strong></p>\n<p><strong> 不建议服务器内存小于512M ，谁卡谁知道 </strong></p>\n<h3 id=\"最初的最初\"><a href=\"#最初的最初\" class=\"headerlink\" title=\"最初的最初\"></a>最初的最初</h3><p>先说下我最终完成的结构：</p>\n<pre><code>1.本地有一个日志文件夹，用于存放md文件，或HTML文件，作为本地的Dropbox客户端同步的目录\n2.服务器home文件夹中init一套hexo程序，用于接收本地的md文件，和generate，minify\n</code></pre><p>流程：</p>\n<pre><code>1.本地撰写，本地客户端自动同步\n2.服务器Dropbox设置的同步目录接收本地的内容并cp到专门用于生成的hexo目录里\n3.服务器用于生成的hexo生成新日志，cp到web目录中\n</code></pre><p>这么做的原因是，如果一共（是整个博客一共）只有一篇文章或几篇文章，那几乎没影响，如果，有几十篇了，据我观察，生成很耗时，可能会导致搜索引擎访问出现404，用户打开一个生成到一半的文件，用户打开一个木有样式的文章。</p>\n<h3 id=\"STEP-0-安装Dropbox\"><a href=\"#STEP-0-安装Dropbox\" class=\"headerlink\" title=\"STEP 0 安装Dropbox\"></a>STEP 0 安装Dropbox</h3><p><a href=\"https://db.tt/mMNtRA6x\" target=\"_blank\" rel=\"external\">注册Dropbox</a>。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">if( ! has_dropbox_account() )&#123;</div><div class=\"line\">\treturn &quot;请先注册个账户啊亲&quot;;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>由于Dropbox默认安装在~，所以建议新建一个专用于同步的账户，如dbox。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">adduser dbox</div><div class=\"line\">passwd dbox</div></pre></td></tr></table></figure>\n<p><strong> 请记住密码。请记住密码。请记住密码。 </strong></p>\n<p>然后，用新建的账户登录进去。</p>\n<p>终于可以安装Dropbox了。</p>\n<p>这里要区分一下你的系统，</p>\n<p><strong> 32位: </strong></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">cd ~ &amp;&amp; wget -O - &quot;https://www.dropbox.com/download?plat=lnx.x86&quot; | tar xzf -</div></pre></td></tr></table></figure>\n<p><strong> 64位: </strong></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">cd ~ &amp;&amp; wget -O - &quot;https://www.dropbox.com/download?plat=lnx.x86_64&quot; | tar xzf -</div></pre></td></tr></table></figure>\n<p>然后就可以运行Dropbox的守护程序了</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">~/.dropbox-dist/dropboxd &amp;</div></pre></td></tr></table></figure>\n<p>第一次在新的电脑上启动，会提示：</p>\n<pre><code>此电脑尚未与任何 Dropbox 帐户关联...\n\n请访问 https://www.dropbox.com/cli_link_nonce?nonce=95cd317d2***** 来关联此设备。\n\n此电脑现在已与 Dropbox 关联。欢迎 yourname username\n</code></pre><p><strong> 注意在出现“此电脑现在已与 Dropbox 关联。欢迎 your username”前不要ctrl+c 退出这个程序。 </strong></p>\n<p>打开授权链接后会出现如下的提示，选择连接即可。</p>\n<p><img src=\"http://7b1hhm.com1.z0.glb.clouddn.com/hexo33B2BAAF-6996-41AA-BFA3-FC177106F62A.png\" alt=\"\"></p>\n<p>一定要注意，不然你都会奇怪为啥再次启动这个进程的时候还会出现“尚未关联的提示”</p>\n<p>验证成功后，会在当前用户的home目录中创建Dropbox目录，即Dropbox同步的目录。</p>\n<p>此时，如果你打开了 top，那应该发现此时服务器的内存有点捉急了，原因是Dropbox这个进程占的很多，所以一般情况下killall dropbox 退出就好了，壕请随意。</p>\n<h3 id=\"STEP-1-设置文件夹监测\"><a href=\"#STEP-1-设置文件夹监测\" class=\"headerlink\" title=\"STEP 1 设置文件夹监测\"></a>STEP 1 设置文件夹监测</h3><p><strong>安装incron服务</strong></p>\n<p>incron是Linux下一个监测文件变化的服务</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">apt-get install incron</div><div class=\"line\">yum install incron</div></pre></td></tr></table></figure>\n<p><strong> 设置开机启动 </strong></p>\n<p>安装sysv-rc-conf，用于管理服务的启动</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">apt-get install sysv-rc-conf</div><div class=\"line\">sysv-rc-conf incron on</div></pre></td></tr></table></figure>\n<p><strong> 创建监测任务 </strong></p>\n<p>先修改下incron的编辑器</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">vi /etc/incron.conf</div></pre></td></tr></table></figure>\n<p>（此时可能需要sudo权限，因为是dbox用户）在文件的最后一行，去掉editor = vi前的#，保存退出。</p>\n<p>输入：incrontab -e</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">/home/dbox/Dropbox/yourfolder/ IN_ATTRIB,IN_MOVE /home/dbox/hexo.bash</div></pre></td></tr></table></figure>\n<p>第一个参数：用来接收Dropbox同步的文件夹</p>\n<p>第二个参数：指监测的动作</p>\n<p>第三个参数：处理脚本</p>\n<p>监测的动作可以用：</p>\n<pre><code>IN_ACCESS，即文件被访问\nIN_MODIFY，文件被 write\nIN_ATTRIB，文件属性被修改，如 chmod、chown、touch 等\nIN_CLOSE_WRITE，可写文件被 close\nIN_CLOSE_NOWRITE，不可写文件被 close\nIN_OPEN，文件被 open\nIN_MOVED_FROM，文件被移走,如 mv\nIN_MOVED_TO，文件被移来，如 mv、cp\nIN_CREATE，创建新文件\nIN_DELETE，文件被删除，如 rm\nIN_DELETE_SELF，自删除，即一个可执行文件在执行时删除自己\nIN_MOVE_SELF，自移动，即一个可执行文件在执行时移动自己\nIN_UNMOUNT，宿主文件系统被 umount\nIN_CLOSE，文件被关闭，等同于(IN_CLOSE_WRITE | IN_CLOSE_NOWRITE)\nIN_MOVE，文件被移动，等同于(IN_MOVED_FROM | IN_MOVED_TO)\n#上面所说的文件也包括目录。\n</code></pre><p>可以选自己需要的动作</p>\n<p>接下来写处理脚本<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">vi hexo.bash</div></pre></td></tr></table></figure></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">cp -R /home/dbox/Dropbox/yourfolder/* /home/dbox/dropasync/source/_posts/;</div><div class=\"line\">cd /home/dbox/dropasync/ &amp;&amp; hexo gm</div><div class=\"line\">cd ~ &amp;&amp; ./.dropbox-dist/dropboxd</div></pre></td></tr></table></figure>\n<p>理论上到这里已经可以了。</p>\n<p><del>但是实际上我本人在测试的时候，512内存的服务器会只剩下4M内存，然后再执行任何命令都提示<br><code>-bash: fork: Cannot allocate memory</code>，持续很长时间，一开始以为是同时跑的进程太多导致内存不够，把没用的mongodb，redis都kill之后还是这样，后来干脆在执行这个脚本的时候把Dropbox的后台禁掉，也不行，之后想到了在这段脚本里echo一段数字到log中，执行的时候发现会写入多次，但是还是不清楚为什么会出现这种情况，进程里也是出现了两个或多个hexo，于是干脆就在这段脚本开始时先kill dropbox和hexo，在末尾再kill hexo。实际运行起来，内存还是会降到最低，但是持续时间明显减少到可以接受的程度。</del></p>\n<hr>\n<h2 id=\"2015-11-21-14-06-07-附截图\"><a href=\"#2015-11-21-14-06-07-附截图\" class=\"headerlink\" title=\"2015-11-21 14:06:07 附截图\"></a>2015-11-21 14:06:07 附截图</h2><p><img src=\"http://7b1hhm.com1.z0.glb.clouddn.com/hexoF2A913D3-14C5-4FC9-B177-500AC0434036.png\" alt=\"\"></p>\n<hr>\n<p>2015-11-14 22:38:06 测试发现，上述带删除线的方法依然不行。内存依然会榨干很长时间。</p>\n<hr>\n<p>至于为何出现这个情况，咱不可知。。。总不能完全是因为内存太小吧……</p>\n<p>后续应该还会继续改进这个脚本。</p>\n<p><strong>另外，在安装这个用于生成日志的hexo程序的时候也出现了npm killed的问题，查了资料发现也是因为内存不足，npm install -d 可以查看安装过程，如果出错可以用来定位到底是什么原因引起错误</strong></p>\n<p>一些参考资料：</p>\n<p><a href=\"http://lucifr.com/2013/06/02/hexo-on-cloud-with-dropbox-and-vps/\" target=\"_blank\" rel=\"external\">Hexo 服务器端布署及 Dropbox 同步</a></p>\n<p><a href=\"http://www.fanicy.com/2014/06/01/0001.hexowithvpsdropbox/\" target=\"_blank\" rel=\"external\">用Hexo+Vps搭建博客并用Dropbox同步自动发布</a></p>\n<p><a href=\"http://linux.die.net/man/5/incrontab\" target=\"_blank\" rel=\"external\">incrontab(5) - Linux man page</a></p>\n<p><a href=\"http://wlx.westgis.ac.cn/tag/incrontab/\" target=\"_blank\" rel=\"external\">incron：linux下基于文件的事件触发</a></p>\n<p><a href=\"http://askubuntu.com/questions/221293/why-is-chkconfig-no-longer-available-in-ubuntu\" target=\"_blank\" rel=\"external\">Why is chkconfig no longer available in Ubuntu?</a></p>\n<p><a href=\"https://www.garron.me/en/linux/use-incron-rsync-dropbox-backup.html\" target=\"_blank\" rel=\"external\">Use incron to Trigger Action when File Changes 如果设置incrontab出现问题可以参考这篇</a></p>\n"},{"title":"ECharts饼图示例","date":"2016-01-19T13:27:00.000Z","_content":"\n![](/images/BEEC6560-EC03-4027-969D-DBB584A47E69.png)\n\n今天写一个做地区分布的饼图的东西。\n\n由于数据库里本身没有存储地区数据，只有IP，所以也用到了[高春辉老师目前的项目](http://www.ipip.net/)里提供的IP地址数据库。可以在数据库下载页面下载到免费的数据库文件和一个PHP处理类。\n\n还用到了百度团队开源的[ECharts](http://echarts.baidu.com/index.html)，很简单很好用。\n\n其实事情本身并没有难度。\n\n### 约定\n\n默认为：此时已有一个静态页面，并且已引入echarts的js文件。\n\n### 先读取数据\n```\n\n\t$sql = \"SELECT id,ips FROM table order by id desc limit 100000\";\n\t\n\t$pdo = new PDO('mysql:host=127.0.0.1;dbname=db1','root','root');\n\t\n\t$query = $pdo -> query($sql);\n\t$query->setFetchMode(PDO::FETCH_ASSOC);\n\t$rs = $query->fetchAll();\t\n\t\n```\n\n### 根据IP得出所在地信息\n\n```\n\n\tinclude './IP.class.php';//ipip.net提供的IP处理类\n\t$IP = new IP();\n\tforeach ($rs as $key => $value) {\n\t\t$a = $IP->find($value[\"ips\"]);\n\t\t$arr[$key] = $a[1].$a[2]; //正确的IP返回的数据为:Array ( [0] => 中国 [1] => 黑龙江 [2] => 鹤岗 [3] => ) ,这里根据实际情况取对应字段即可。\n\t}\n\t\n```\n\n### 生成echarts所需的数据\n\n```\n\t$data = array_count_values($arr);\n```\n\n嗯，一个非常简单粗暴的把同名地区数量算出来的方法。这样就生成了如array('北京'=>2,'天津'=>3)这样的数据。正是echarts所需的。\n\n### 饼图区域\n\n```\n\t<div id=\"main\" style=\"width: 1400px;height:1400px;\"></div>\n```\n\n### 正经的JS来了\n\n```\n\tvar myChart = echarts.init(document.getElementById('main'));\n\t\n\tvar option = {\n       \n        title : {\n\t        text: 'IP分布地区',\n\t        x:'center'\n\t    },\n\t    tooltip : {\n\t        trigger: 'item',\n\t        formatter: \"{a} <br/>{b} : {c} ({d}%)\"\n\t    },\n\t    legend: {\n\t        orient: 'vertical',\n\t        left: 'left',\n\t        //简单起见此处直接foreach了\n\t        data: [<?php foreach ($keys as $key => $value) { echo '\"'.$value.'\",'; }?>]\n\t    },\n\t    series : [\n\t        {\n\t            name: 'IP所在地区',\n\t            type: 'pie',\n\t            radius : '40%',\n\t            center: ['50%', '60%'],\n\t            data:[\n\t            \t//同上，\n\t            \t<?php \n\t            \t\t//reset($data);\n\t\t\t\t\t\twhile (list($key, $val) = each($data)){\n\t\t\t\t\t\t\techo '{value:'.$val.',name:\"'.$key.'\"},';\n\t\t\t\t\t\t}\n\t            \t?>\n\t            ],\n\t            itemStyle: {\n\t                emphasis: {\n\t                    shadowBlur: 10,\n\t                    shadowOffsetX: 0,\n\t                    shadowColor: 'rgba(0, 0, 0, 0.5)'\n\t                }\n\t            }\n\t        }\n\t    ]\n    };\n    \n    // 使用刚指定的配置项和数据显示图表。\n    myChart.setOption(option);\n\n```\n\n打开页面看一下吧。\n\n\n\n","source":"_posts/echarts-pie.md","raw":"title: ECharts饼图示例\ncategories: javascript\ndate: 2016-01-19 21:27:00\ntags:  [javascript,php,ECharts,php]\n\n---\n\n![](/images/BEEC6560-EC03-4027-969D-DBB584A47E69.png)\n\n今天写一个做地区分布的饼图的东西。\n\n由于数据库里本身没有存储地区数据，只有IP，所以也用到了[高春辉老师目前的项目](http://www.ipip.net/)里提供的IP地址数据库。可以在数据库下载页面下载到免费的数据库文件和一个PHP处理类。\n\n还用到了百度团队开源的[ECharts](http://echarts.baidu.com/index.html)，很简单很好用。\n\n其实事情本身并没有难度。\n\n### 约定\n\n默认为：此时已有一个静态页面，并且已引入echarts的js文件。\n\n### 先读取数据\n```\n\n\t$sql = \"SELECT id,ips FROM table order by id desc limit 100000\";\n\t\n\t$pdo = new PDO('mysql:host=127.0.0.1;dbname=db1','root','root');\n\t\n\t$query = $pdo -> query($sql);\n\t$query->setFetchMode(PDO::FETCH_ASSOC);\n\t$rs = $query->fetchAll();\t\n\t\n```\n\n### 根据IP得出所在地信息\n\n```\n\n\tinclude './IP.class.php';//ipip.net提供的IP处理类\n\t$IP = new IP();\n\tforeach ($rs as $key => $value) {\n\t\t$a = $IP->find($value[\"ips\"]);\n\t\t$arr[$key] = $a[1].$a[2]; //正确的IP返回的数据为:Array ( [0] => 中国 [1] => 黑龙江 [2] => 鹤岗 [3] => ) ,这里根据实际情况取对应字段即可。\n\t}\n\t\n```\n\n### 生成echarts所需的数据\n\n```\n\t$data = array_count_values($arr);\n```\n\n嗯，一个非常简单粗暴的把同名地区数量算出来的方法。这样就生成了如array('北京'=>2,'天津'=>3)这样的数据。正是echarts所需的。\n\n### 饼图区域\n\n```\n\t<div id=\"main\" style=\"width: 1400px;height:1400px;\"></div>\n```\n\n### 正经的JS来了\n\n```\n\tvar myChart = echarts.init(document.getElementById('main'));\n\t\n\tvar option = {\n       \n        title : {\n\t        text: 'IP分布地区',\n\t        x:'center'\n\t    },\n\t    tooltip : {\n\t        trigger: 'item',\n\t        formatter: \"{a} <br/>{b} : {c} ({d}%)\"\n\t    },\n\t    legend: {\n\t        orient: 'vertical',\n\t        left: 'left',\n\t        //简单起见此处直接foreach了\n\t        data: [<?php foreach ($keys as $key => $value) { echo '\"'.$value.'\",'; }?>]\n\t    },\n\t    series : [\n\t        {\n\t            name: 'IP所在地区',\n\t            type: 'pie',\n\t            radius : '40%',\n\t            center: ['50%', '60%'],\n\t            data:[\n\t            \t//同上，\n\t            \t<?php \n\t            \t\t//reset($data);\n\t\t\t\t\t\twhile (list($key, $val) = each($data)){\n\t\t\t\t\t\t\techo '{value:'.$val.',name:\"'.$key.'\"},';\n\t\t\t\t\t\t}\n\t            \t?>\n\t            ],\n\t            itemStyle: {\n\t                emphasis: {\n\t                    shadowBlur: 10,\n\t                    shadowOffsetX: 0,\n\t                    shadowColor: 'rgba(0, 0, 0, 0.5)'\n\t                }\n\t            }\n\t        }\n\t    ]\n    };\n    \n    // 使用刚指定的配置项和数据显示图表。\n    myChart.setOption(option);\n\n```\n\n打开页面看一下吧。\n\n\n\n","slug":"echarts-pie","published":1,"updated":"2016-01-19T14:25:04.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj830jvdu0018ul0r46s4ia1j","content":"<p><img src=\"/images/BEEC6560-EC03-4027-969D-DBB584A47E69.png\" alt=\"\"></p>\n<p>今天写一个做地区分布的饼图的东西。</p>\n<p>由于数据库里本身没有存储地区数据，只有IP，所以也用到了<a href=\"http://www.ipip.net/\" target=\"_blank\" rel=\"external\">高春辉老师目前的项目</a>里提供的IP地址数据库。可以在数据库下载页面下载到免费的数据库文件和一个PHP处理类。</p>\n<p>还用到了百度团队开源的<a href=\"http://echarts.baidu.com/index.html\" target=\"_blank\" rel=\"external\">ECharts</a>，很简单很好用。</p>\n<p>其实事情本身并没有难度。</p>\n<h3 id=\"约定\"><a href=\"#约定\" class=\"headerlink\" title=\"约定\"></a>约定</h3><p>默认为：此时已有一个静态页面，并且已引入echarts的js文件。</p>\n<h3 id=\"先读取数据\"><a href=\"#先读取数据\" class=\"headerlink\" title=\"先读取数据\"></a>先读取数据</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\"></div><div class=\"line\">$sql = &quot;SELECT id,ips FROM table order by id desc limit 100000&quot;;</div><div class=\"line\"></div><div class=\"line\">$pdo = new PDO(&apos;mysql:host=127.0.0.1;dbname=db1&apos;,&apos;root&apos;,&apos;root&apos;);</div><div class=\"line\"></div><div class=\"line\">$query = $pdo -&gt; query($sql);</div><div class=\"line\">$query-&gt;setFetchMode(PDO::FETCH_ASSOC);</div><div class=\"line\">$rs = $query-&gt;fetchAll();</div></pre></td></tr></table></figure>\n<h3 id=\"根据IP得出所在地信息\"><a href=\"#根据IP得出所在地信息\" class=\"headerlink\" title=\"根据IP得出所在地信息\"></a>根据IP得出所在地信息</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\"></div><div class=\"line\">include &apos;./IP.class.php&apos;;//ipip.net提供的IP处理类</div><div class=\"line\">$IP = new IP();</div><div class=\"line\">foreach ($rs as $key =&gt; $value) &#123;</div><div class=\"line\">\t$a = $IP-&gt;find($value[&quot;ips&quot;]);</div><div class=\"line\">\t$arr[$key] = $a[1].$a[2]; //正确的IP返回的数据为:Array ( [0] =&gt; 中国 [1] =&gt; 黑龙江 [2] =&gt; 鹤岗 [3] =&gt; ) ,这里根据实际情况取对应字段即可。</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h3 id=\"生成echarts所需的数据\"><a href=\"#生成echarts所需的数据\" class=\"headerlink\" title=\"生成echarts所需的数据\"></a>生成echarts所需的数据</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$data = array_count_values($arr);</div></pre></td></tr></table></figure>\n<p>嗯，一个非常简单粗暴的把同名地区数量算出来的方法。这样就生成了如array(‘北京’=&gt;2,’天津’=&gt;3)这样的数据。正是echarts所需的。</p>\n<h3 id=\"饼图区域\"><a href=\"#饼图区域\" class=\"headerlink\" title=\"饼图区域\"></a>饼图区域</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;div id=&quot;main&quot; style=&quot;width: 1400px;height:1400px;&quot;&gt;&lt;/div&gt;</div></pre></td></tr></table></figure>\n<h3 id=\"正经的JS来了\"><a href=\"#正经的JS来了\" class=\"headerlink\" title=\"正经的JS来了\"></a>正经的JS来了</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div></pre></td><td class=\"code\"><pre><div class=\"line\">var myChart = echarts.init(document.getElementById(&apos;main&apos;));</div><div class=\"line\"></div><div class=\"line\">var option = &#123;</div><div class=\"line\">      </div><div class=\"line\">       title : &#123;</div><div class=\"line\">        text: &apos;IP分布地区&apos;,</div><div class=\"line\">        x:&apos;center&apos;</div><div class=\"line\">    &#125;,</div><div class=\"line\">    tooltip : &#123;</div><div class=\"line\">        trigger: &apos;item&apos;,</div><div class=\"line\">        formatter: &quot;&#123;a&#125; &lt;br/&gt;&#123;b&#125; : &#123;c&#125; (&#123;d&#125;%)&quot;</div><div class=\"line\">    &#125;,</div><div class=\"line\">    legend: &#123;</div><div class=\"line\">        orient: &apos;vertical&apos;,</div><div class=\"line\">        left: &apos;left&apos;,</div><div class=\"line\">        //简单起见此处直接foreach了</div><div class=\"line\">        data: [&lt;?php foreach ($keys as $key =&gt; $value) &#123; echo &apos;&quot;&apos;.$value.&apos;&quot;,&apos;; &#125;?&gt;]</div><div class=\"line\">    &#125;,</div><div class=\"line\">    series : [</div><div class=\"line\">        &#123;</div><div class=\"line\">            name: &apos;IP所在地区&apos;,</div><div class=\"line\">            type: &apos;pie&apos;,</div><div class=\"line\">            radius : &apos;40%&apos;,</div><div class=\"line\">            center: [&apos;50%&apos;, &apos;60%&apos;],</div><div class=\"line\">            data:[</div><div class=\"line\">            \t//同上，</div><div class=\"line\">            \t&lt;?php </div><div class=\"line\">            \t\t//reset($data);</div><div class=\"line\">\t\t\t\t\twhile (list($key, $val) = each($data))&#123;</div><div class=\"line\">\t\t\t\t\t\techo &apos;&#123;value:&apos;.$val.&apos;,name:&quot;&apos;.$key.&apos;&quot;&#125;,&apos;;</div><div class=\"line\">\t\t\t\t\t&#125;</div><div class=\"line\">            \t?&gt;</div><div class=\"line\">            ],</div><div class=\"line\">            itemStyle: &#123;</div><div class=\"line\">                emphasis: &#123;</div><div class=\"line\">                    shadowBlur: 10,</div><div class=\"line\">                    shadowOffsetX: 0,</div><div class=\"line\">                    shadowColor: &apos;rgba(0, 0, 0, 0.5)&apos;</div><div class=\"line\">                &#125;</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;</div><div class=\"line\">    ]</div><div class=\"line\">   &#125;;</div><div class=\"line\">   </div><div class=\"line\">   // 使用刚指定的配置项和数据显示图表。</div><div class=\"line\">   myChart.setOption(option);</div></pre></td></tr></table></figure>\n<p>打开页面看一下吧。</p>\n","site":{"data":{}},"excerpt":"","more":"<p><img src=\"/images/BEEC6560-EC03-4027-969D-DBB584A47E69.png\" alt=\"\"></p>\n<p>今天写一个做地区分布的饼图的东西。</p>\n<p>由于数据库里本身没有存储地区数据，只有IP，所以也用到了<a href=\"http://www.ipip.net/\" target=\"_blank\" rel=\"external\">高春辉老师目前的项目</a>里提供的IP地址数据库。可以在数据库下载页面下载到免费的数据库文件和一个PHP处理类。</p>\n<p>还用到了百度团队开源的<a href=\"http://echarts.baidu.com/index.html\" target=\"_blank\" rel=\"external\">ECharts</a>，很简单很好用。</p>\n<p>其实事情本身并没有难度。</p>\n<h3 id=\"约定\"><a href=\"#约定\" class=\"headerlink\" title=\"约定\"></a>约定</h3><p>默认为：此时已有一个静态页面，并且已引入echarts的js文件。</p>\n<h3 id=\"先读取数据\"><a href=\"#先读取数据\" class=\"headerlink\" title=\"先读取数据\"></a>先读取数据</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\"></div><div class=\"line\">$sql = &quot;SELECT id,ips FROM table order by id desc limit 100000&quot;;</div><div class=\"line\"></div><div class=\"line\">$pdo = new PDO(&apos;mysql:host=127.0.0.1;dbname=db1&apos;,&apos;root&apos;,&apos;root&apos;);</div><div class=\"line\"></div><div class=\"line\">$query = $pdo -&gt; query($sql);</div><div class=\"line\">$query-&gt;setFetchMode(PDO::FETCH_ASSOC);</div><div class=\"line\">$rs = $query-&gt;fetchAll();</div></pre></td></tr></table></figure>\n<h3 id=\"根据IP得出所在地信息\"><a href=\"#根据IP得出所在地信息\" class=\"headerlink\" title=\"根据IP得出所在地信息\"></a>根据IP得出所在地信息</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\"></div><div class=\"line\">include &apos;./IP.class.php&apos;;//ipip.net提供的IP处理类</div><div class=\"line\">$IP = new IP();</div><div class=\"line\">foreach ($rs as $key =&gt; $value) &#123;</div><div class=\"line\">\t$a = $IP-&gt;find($value[&quot;ips&quot;]);</div><div class=\"line\">\t$arr[$key] = $a[1].$a[2]; //正确的IP返回的数据为:Array ( [0] =&gt; 中国 [1] =&gt; 黑龙江 [2] =&gt; 鹤岗 [3] =&gt; ) ,这里根据实际情况取对应字段即可。</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h3 id=\"生成echarts所需的数据\"><a href=\"#生成echarts所需的数据\" class=\"headerlink\" title=\"生成echarts所需的数据\"></a>生成echarts所需的数据</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$data = array_count_values($arr);</div></pre></td></tr></table></figure>\n<p>嗯，一个非常简单粗暴的把同名地区数量算出来的方法。这样就生成了如array(‘北京’=&gt;2,’天津’=&gt;3)这样的数据。正是echarts所需的。</p>\n<h3 id=\"饼图区域\"><a href=\"#饼图区域\" class=\"headerlink\" title=\"饼图区域\"></a>饼图区域</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;div id=&quot;main&quot; style=&quot;width: 1400px;height:1400px;&quot;&gt;&lt;/div&gt;</div></pre></td></tr></table></figure>\n<h3 id=\"正经的JS来了\"><a href=\"#正经的JS来了\" class=\"headerlink\" title=\"正经的JS来了\"></a>正经的JS来了</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div></pre></td><td class=\"code\"><pre><div class=\"line\">var myChart = echarts.init(document.getElementById(&apos;main&apos;));</div><div class=\"line\"></div><div class=\"line\">var option = &#123;</div><div class=\"line\">      </div><div class=\"line\">       title : &#123;</div><div class=\"line\">        text: &apos;IP分布地区&apos;,</div><div class=\"line\">        x:&apos;center&apos;</div><div class=\"line\">    &#125;,</div><div class=\"line\">    tooltip : &#123;</div><div class=\"line\">        trigger: &apos;item&apos;,</div><div class=\"line\">        formatter: &quot;&#123;a&#125; &lt;br/&gt;&#123;b&#125; : &#123;c&#125; (&#123;d&#125;%)&quot;</div><div class=\"line\">    &#125;,</div><div class=\"line\">    legend: &#123;</div><div class=\"line\">        orient: &apos;vertical&apos;,</div><div class=\"line\">        left: &apos;left&apos;,</div><div class=\"line\">        //简单起见此处直接foreach了</div><div class=\"line\">        data: [&lt;?php foreach ($keys as $key =&gt; $value) &#123; echo &apos;&quot;&apos;.$value.&apos;&quot;,&apos;; &#125;?&gt;]</div><div class=\"line\">    &#125;,</div><div class=\"line\">    series : [</div><div class=\"line\">        &#123;</div><div class=\"line\">            name: &apos;IP所在地区&apos;,</div><div class=\"line\">            type: &apos;pie&apos;,</div><div class=\"line\">            radius : &apos;40%&apos;,</div><div class=\"line\">            center: [&apos;50%&apos;, &apos;60%&apos;],</div><div class=\"line\">            data:[</div><div class=\"line\">            \t//同上，</div><div class=\"line\">            \t&lt;?php </div><div class=\"line\">            \t\t//reset($data);</div><div class=\"line\">\t\t\t\t\twhile (list($key, $val) = each($data))&#123;</div><div class=\"line\">\t\t\t\t\t\techo &apos;&#123;value:&apos;.$val.&apos;,name:&quot;&apos;.$key.&apos;&quot;&#125;,&apos;;</div><div class=\"line\">\t\t\t\t\t&#125;</div><div class=\"line\">            \t?&gt;</div><div class=\"line\">            ],</div><div class=\"line\">            itemStyle: &#123;</div><div class=\"line\">                emphasis: &#123;</div><div class=\"line\">                    shadowBlur: 10,</div><div class=\"line\">                    shadowOffsetX: 0,</div><div class=\"line\">                    shadowColor: &apos;rgba(0, 0, 0, 0.5)&apos;</div><div class=\"line\">                &#125;</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;</div><div class=\"line\">    ]</div><div class=\"line\">   &#125;;</div><div class=\"line\">   </div><div class=\"line\">   // 使用刚指定的配置项和数据显示图表。</div><div class=\"line\">   myChart.setOption(option);</div></pre></td></tr></table></figure>\n<p>打开页面看一下吧。</p>\n"},{"title":"MySQL命令行导出结果集到Excel","date":"2015-11-21T13:24:35.000Z","_content":"\n![](http://7b1hhm.com1.z0.glb.clouddn.com/hexo1631785_mysql.gif)\n\n某个需求，为了简单单独建表存储，而且没有相关的后台管理方法，无法查看，或导出，但是又突然出现需要导出这个需求。\n\n所以突然想到MySQL是否带了这种直接导出到文件中的方法，查资料后发现果然有。\n\n只需要在命令行中执行如下查询即可。\n\n```\nSELECT * FROM my_table INTO OUTFILE 'file.csv' FIELDS TERMINATED BY ',';\n```\n\n有几点需要注意：\n\n\t0.文件将在服务器上生成，所以需要需要MySQL进程有生成文件的权限。\n\t1.必须为一个不存在的文件名。\n\t\n其实还有一些功能，或者说是说明，这里并没有写。\n\n\n官方文档：\n\n[13.2.9.1 SELECT ... INTO Syntax](http://dev.mysql.com/doc/refman/5.5/en/select-into.html)","source":"_posts/export-results-of-mysql-to-excel.md","raw":"title: MySQL命令行导出结果集到Excel\ncategories: mysql\ndate: 2015-11-21 21:24:35\ntags:  [mysql,excel]\n\n---\n\n![](http://7b1hhm.com1.z0.glb.clouddn.com/hexo1631785_mysql.gif)\n\n某个需求，为了简单单独建表存储，而且没有相关的后台管理方法，无法查看，或导出，但是又突然出现需要导出这个需求。\n\n所以突然想到MySQL是否带了这种直接导出到文件中的方法，查资料后发现果然有。\n\n只需要在命令行中执行如下查询即可。\n\n```\nSELECT * FROM my_table INTO OUTFILE 'file.csv' FIELDS TERMINATED BY ',';\n```\n\n有几点需要注意：\n\n\t0.文件将在服务器上生成，所以需要需要MySQL进程有生成文件的权限。\n\t1.必须为一个不存在的文件名。\n\t\n其实还有一些功能，或者说是说明，这里并没有写。\n\n\n官方文档：\n\n[13.2.9.1 SELECT ... INTO Syntax](http://dev.mysql.com/doc/refman/5.5/en/select-into.html)","slug":"export-results-of-mysql-to-excel","published":1,"updated":"2015-11-21T13:50:00.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj830jvdv001aul0rmmsoskc2","content":"<p><img src=\"http://7b1hhm.com1.z0.glb.clouddn.com/hexo1631785_mysql.gif\" alt=\"\"></p>\n<p>某个需求，为了简单单独建表存储，而且没有相关的后台管理方法，无法查看，或导出，但是又突然出现需要导出这个需求。</p>\n<p>所以突然想到MySQL是否带了这种直接导出到文件中的方法，查资料后发现果然有。</p>\n<p>只需要在命令行中执行如下查询即可。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">SELECT * FROM my_table INTO OUTFILE &apos;file.csv&apos; FIELDS TERMINATED BY &apos;,&apos;;</div></pre></td></tr></table></figure>\n<p>有几点需要注意：</p>\n<pre><code>0.文件将在服务器上生成，所以需要需要MySQL进程有生成文件的权限。\n1.必须为一个不存在的文件名。\n</code></pre><p>其实还有一些功能，或者说是说明，这里并没有写。</p>\n<p>官方文档：</p>\n<p><a href=\"http://dev.mysql.com/doc/refman/5.5/en/select-into.html\" target=\"_blank\" rel=\"external\">13.2.9.1 SELECT … INTO Syntax</a></p>\n","site":{"data":{}},"excerpt":"","more":"<p><img src=\"http://7b1hhm.com1.z0.glb.clouddn.com/hexo1631785_mysql.gif\" alt=\"\"></p>\n<p>某个需求，为了简单单独建表存储，而且没有相关的后台管理方法，无法查看，或导出，但是又突然出现需要导出这个需求。</p>\n<p>所以突然想到MySQL是否带了这种直接导出到文件中的方法，查资料后发现果然有。</p>\n<p>只需要在命令行中执行如下查询即可。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">SELECT * FROM my_table INTO OUTFILE &apos;file.csv&apos; FIELDS TERMINATED BY &apos;,&apos;;</div></pre></td></tr></table></figure>\n<p>有几点需要注意：</p>\n<pre><code>0.文件将在服务器上生成，所以需要需要MySQL进程有生成文件的权限。\n1.必须为一个不存在的文件名。\n</code></pre><p>其实还有一些功能，或者说是说明，这里并没有写。</p>\n<p>官方文档：</p>\n<p><a href=\"http://dev.mysql.com/doc/refman/5.5/en/select-into.html\" target=\"_blank\" rel=\"external\">13.2.9.1 SELECT … INTO Syntax</a></p>\n"},{"title":"Go语言写爬取糗百热门帖子","date":"2016-12-04T07:49:04.000Z","_content":"\n闲来无事，想着也用Go来写个爬虫之类的东西，我并不知道这算不算严格意义上的爬虫。\n\n思前想后，觉得写个爬糗百热门的脚本吧，一来足够简单，二来大概熟悉下流程。\n\n首先，选了[goquery](https://github.com/PuerkitoBio/goquery)这个包来解析HTML，声称与jquery相似的用法，事实上也确实是这样，非常方便。\n\n定个目标，只爬取列表页的帖子内容，作者和回帖都不管。\n\n```\npackage main\n\nimport (\n\t\"github.com/PuerkitoBio/goquery\"\n\t\"log\"\n)\n\n//定义结构体\ntype Qb struct {\n\tId int `json:\"id\"`\n\tContent string `json:\"content\"`\n}\n\nfunc main() {\n\tvar url = \"http://www.qiushibaike.com/hot\"\n\n\tdoc, err := goquery.NewDocument(url)\n\tif err != nil {\n\t\tlog.Fatal(err)\n\t}\n\n\tvar qb []Qb\n\tdoc.Find(\"#content-left .article\").Each(func(i int, s *goquery.Selection) {\n\t\t//s即为当前的 .article 元素，查找下级中的span元素的内容。\n\t\tcontent := s.Find(\".content span\").Text()\n\t\tqb = append(qb, Qb{Id: i, Content: content})\n\t})\n\n\tlog.Println(qb)\n}\n```\n\n\"#content-left .article\" 即每一条帖子作为元素的class。\n\n将会输出：\n```\n[\n\t{0 结婚十三周年那天，老婆望着一大桌子菜不禁泪流满面。我帮她拭去泪水:瞧你，都激动的哭了!老婆却说:我激动个屁!想想这十三年跟着你受的罪，我实在忍不住啊!} \n\t{1 前几天天冷，就给妹妹买了条围巾，然后她说谢谢哥，本人本着组织精神说你应该谢谢你嫂子，她惊讶的对我说:哥，你谈女朋友了。我说:没有，你应该感谢她一直到现在都没出现，哥才有钱给你买东西} \n\t{2 跟哥们去理发，剪头的是个妹纸。。妹纸:“你有女朋友么？”哥们一听，突然兴奋的说:“没有！”妹纸:“我是个实习生，本来想给你换大工的，看你没有女朋友，我就随意剪了！”哥们你别看我，我就是一口水没忍住，喷你脸上了而已！} \n\t{3 老妈比较胖，小时候每次打我我都是撒腿就跑，老妈没一次抓到我的。直到老妈学会骑自行车以后，那鞭子挥得………真像套马杆的汉子，威武雄壮……}\n]\n```\n\n那么如何展示到页面中呢。\n\n我选择了 [gin](https://github.com/gin-gonic/gin) 框架。\n\n修改一下代码。\n\n```\nfunc main() {\n\tr := gin.Default()\n\tr.LoadHTMLGlob(\"public/*\")\n\tr.GET(\"/\", Index)\n\tr.Run()\n}\n\nfunc Index(c *gin.Context) {\n\tvar url = \"http://www.qiushibaike.com/hot\"\n\n\tdoc, err := goquery.NewDocument(url)\n\tif err != nil {\n\t\tlog.Fatal(err)\n\t}\n\n\tvar result []Qb\n\tdoc.Find(\"#content-left .article\").Each(func(i int, s *goquery.Selection) {\n\t\tcontent := s.Find(\".content span\").Text()\n\t\tresult = append(result, Qb{Id: i, Content: content})\n\t})\n\n\tc.HTML(http.StatusOK, \"index.html\", gin.H{\n\t\t\"items\": result,\n\t\t\"title\": \"糗百热门\"\n\t})\n}\n```\n\n可以看到，\n```\nr := gin.Default()\nr.LoadHTMLGlob(\"public/*\")\nr.GET(\"/\", Index)\n```\n\n这里加载了public目录中的模板，然后下一行，表示，接收到 \"/\" 的请求时，调用Index方法去处理。\n\n到这里，文档的抓取，解析，构造数据就已经完成，下一步，看一下怎么显示到页面中。\n\n```\n{% raw %}\n<div class=\"col-md-12\">\n    <h2>{{ .title }}</h2>\n    <table class=\"table table-striped table-bordered table-hover\">\n        {{ range $item := .items }}\n        <tr>\n            <td>{{ $item.Content }}</td>\n        </tr>\n        {{ end }}\n    </table>\n</div>\n{% endraw %}\n```\n\n使用 \"{% raw %}{{ }}{% endraw %}\" 输出后端发送过来的数据。使用 range 迭代数据。与\n\n```\nfor pos, char := range str {\n...\n}\n```\n\n一样。\n\n完整的模板代码：\n\n```\n{% raw %}\n<!-- public/index.html -->\n\n<html>\n    <head>\n        <meta http-equiv=\"content-type\" content=\"text/html; charset=utf-8\">\n        <meta name=\"viewport\" content=\"width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no\">\n        <title>糗百</title>\n\n        <link rel=\"stylesheet\" href=\"https://cdn.bootcss.com/bootstrap/3.3.6/css/bootstrap.min.css\">\n        <link rel=\"stylesheet\"  href=\"https://cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css\">\n\n    </head>\n    <body>\n        <div class=\"container\">\n            <div class=\"row\">\n                <div class=\"col-md-12\">\n                    <h2>{{ .title }}</h2>\n                    <table class=\"table table-striped table-bordered table-hover\">\n                        {{ range $item := .items }}\n                        <tr>\n                            <td>{{ $item.Content }}</td>\n                        </tr>\n                        {{ end }}\n                    </table>\n                </div>\n            </div>\n        </div>\n    </body>\n</html>\n{% endraw %}\n```\n\n这样，运行一下，就可以了。\n\ngin框架默认使用8080端口，打开 http://localhost:8080 就可以看到一个极简版的糗百热门了。\n\n问题来了，怎么增加一个分页呢？\n\n完整代码见:\n\n[Github地址](https://github.com/qichengzx/goqiubai)\n\n#### 后记\n\n其实早就写完了这篇，但是hexo生成的时候由于 [\"{% raw %}{{{% endraw %}\"的问题](https://hexo.io/docs/troubleshooting.html#Escape-Contents)，生成一直失败，一直拖到现在。\n\n实际代码中需要去掉 \"{ % raw % }\" 相关部分。","source":"_posts/go-qiubai.md","raw":"title: Go语言写爬取糗百热门帖子\ncategories: golang\ndate: 2016-12-04 15:49:04\ntags:  [go,糗百,goquery,gin]\n---\n\n闲来无事，想着也用Go来写个爬虫之类的东西，我并不知道这算不算严格意义上的爬虫。\n\n思前想后，觉得写个爬糗百热门的脚本吧，一来足够简单，二来大概熟悉下流程。\n\n首先，选了[goquery](https://github.com/PuerkitoBio/goquery)这个包来解析HTML，声称与jquery相似的用法，事实上也确实是这样，非常方便。\n\n定个目标，只爬取列表页的帖子内容，作者和回帖都不管。\n\n```\npackage main\n\nimport (\n\t\"github.com/PuerkitoBio/goquery\"\n\t\"log\"\n)\n\n//定义结构体\ntype Qb struct {\n\tId int `json:\"id\"`\n\tContent string `json:\"content\"`\n}\n\nfunc main() {\n\tvar url = \"http://www.qiushibaike.com/hot\"\n\n\tdoc, err := goquery.NewDocument(url)\n\tif err != nil {\n\t\tlog.Fatal(err)\n\t}\n\n\tvar qb []Qb\n\tdoc.Find(\"#content-left .article\").Each(func(i int, s *goquery.Selection) {\n\t\t//s即为当前的 .article 元素，查找下级中的span元素的内容。\n\t\tcontent := s.Find(\".content span\").Text()\n\t\tqb = append(qb, Qb{Id: i, Content: content})\n\t})\n\n\tlog.Println(qb)\n}\n```\n\n\"#content-left .article\" 即每一条帖子作为元素的class。\n\n将会输出：\n```\n[\n\t{0 结婚十三周年那天，老婆望着一大桌子菜不禁泪流满面。我帮她拭去泪水:瞧你，都激动的哭了!老婆却说:我激动个屁!想想这十三年跟着你受的罪，我实在忍不住啊!} \n\t{1 前几天天冷，就给妹妹买了条围巾，然后她说谢谢哥，本人本着组织精神说你应该谢谢你嫂子，她惊讶的对我说:哥，你谈女朋友了。我说:没有，你应该感谢她一直到现在都没出现，哥才有钱给你买东西} \n\t{2 跟哥们去理发，剪头的是个妹纸。。妹纸:“你有女朋友么？”哥们一听，突然兴奋的说:“没有！”妹纸:“我是个实习生，本来想给你换大工的，看你没有女朋友，我就随意剪了！”哥们你别看我，我就是一口水没忍住，喷你脸上了而已！} \n\t{3 老妈比较胖，小时候每次打我我都是撒腿就跑，老妈没一次抓到我的。直到老妈学会骑自行车以后，那鞭子挥得………真像套马杆的汉子，威武雄壮……}\n]\n```\n\n那么如何展示到页面中呢。\n\n我选择了 [gin](https://github.com/gin-gonic/gin) 框架。\n\n修改一下代码。\n\n```\nfunc main() {\n\tr := gin.Default()\n\tr.LoadHTMLGlob(\"public/*\")\n\tr.GET(\"/\", Index)\n\tr.Run()\n}\n\nfunc Index(c *gin.Context) {\n\tvar url = \"http://www.qiushibaike.com/hot\"\n\n\tdoc, err := goquery.NewDocument(url)\n\tif err != nil {\n\t\tlog.Fatal(err)\n\t}\n\n\tvar result []Qb\n\tdoc.Find(\"#content-left .article\").Each(func(i int, s *goquery.Selection) {\n\t\tcontent := s.Find(\".content span\").Text()\n\t\tresult = append(result, Qb{Id: i, Content: content})\n\t})\n\n\tc.HTML(http.StatusOK, \"index.html\", gin.H{\n\t\t\"items\": result,\n\t\t\"title\": \"糗百热门\"\n\t})\n}\n```\n\n可以看到，\n```\nr := gin.Default()\nr.LoadHTMLGlob(\"public/*\")\nr.GET(\"/\", Index)\n```\n\n这里加载了public目录中的模板，然后下一行，表示，接收到 \"/\" 的请求时，调用Index方法去处理。\n\n到这里，文档的抓取，解析，构造数据就已经完成，下一步，看一下怎么显示到页面中。\n\n```\n{% raw %}\n<div class=\"col-md-12\">\n    <h2>{{ .title }}</h2>\n    <table class=\"table table-striped table-bordered table-hover\">\n        {{ range $item := .items }}\n        <tr>\n            <td>{{ $item.Content }}</td>\n        </tr>\n        {{ end }}\n    </table>\n</div>\n{% endraw %}\n```\n\n使用 \"{% raw %}{{ }}{% endraw %}\" 输出后端发送过来的数据。使用 range 迭代数据。与\n\n```\nfor pos, char := range str {\n...\n}\n```\n\n一样。\n\n完整的模板代码：\n\n```\n{% raw %}\n<!-- public/index.html -->\n\n<html>\n    <head>\n        <meta http-equiv=\"content-type\" content=\"text/html; charset=utf-8\">\n        <meta name=\"viewport\" content=\"width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no\">\n        <title>糗百</title>\n\n        <link rel=\"stylesheet\" href=\"https://cdn.bootcss.com/bootstrap/3.3.6/css/bootstrap.min.css\">\n        <link rel=\"stylesheet\"  href=\"https://cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css\">\n\n    </head>\n    <body>\n        <div class=\"container\">\n            <div class=\"row\">\n                <div class=\"col-md-12\">\n                    <h2>{{ .title }}</h2>\n                    <table class=\"table table-striped table-bordered table-hover\">\n                        {{ range $item := .items }}\n                        <tr>\n                            <td>{{ $item.Content }}</td>\n                        </tr>\n                        {{ end }}\n                    </table>\n                </div>\n            </div>\n        </div>\n    </body>\n</html>\n{% endraw %}\n```\n\n这样，运行一下，就可以了。\n\ngin框架默认使用8080端口，打开 http://localhost:8080 就可以看到一个极简版的糗百热门了。\n\n问题来了，怎么增加一个分页呢？\n\n完整代码见:\n\n[Github地址](https://github.com/qichengzx/goqiubai)\n\n#### 后记\n\n其实早就写完了这篇，但是hexo生成的时候由于 [\"{% raw %}{{{% endraw %}\"的问题](https://hexo.io/docs/troubleshooting.html#Escape-Contents)，生成一直失败，一直拖到现在。\n\n实际代码中需要去掉 \"{ % raw % }\" 相关部分。","slug":"go-qiubai","published":1,"updated":"2017-09-23T12:27:08.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj830jvdx001ful0rkogyrta5","content":"<p>闲来无事，想着也用Go来写个爬虫之类的东西，我并不知道这算不算严格意义上的爬虫。</p>\n<p>思前想后，觉得写个爬糗百热门的脚本吧，一来足够简单，二来大概熟悉下流程。</p>\n<p>首先，选了<a href=\"https://github.com/PuerkitoBio/goquery\" target=\"_blank\" rel=\"external\">goquery</a>这个包来解析HTML，声称与jquery相似的用法，事实上也确实是这样，非常方便。</p>\n<p>定个目标，只爬取列表页的帖子内容，作者和回帖都不管。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div></pre></td><td class=\"code\"><pre><div class=\"line\">package main</div><div class=\"line\"></div><div class=\"line\">import (</div><div class=\"line\">\t&quot;github.com/PuerkitoBio/goquery&quot;</div><div class=\"line\">\t&quot;log&quot;</div><div class=\"line\">)</div><div class=\"line\"></div><div class=\"line\">//定义结构体</div><div class=\"line\">type Qb struct &#123;</div><div class=\"line\">\tId int `json:&quot;id&quot;`</div><div class=\"line\">\tContent string `json:&quot;content&quot;`</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\">func main() &#123;</div><div class=\"line\">\tvar url = &quot;http://www.qiushibaike.com/hot&quot;</div><div class=\"line\"></div><div class=\"line\">\tdoc, err := goquery.NewDocument(url)</div><div class=\"line\">\tif err != nil &#123;</div><div class=\"line\">\t\tlog.Fatal(err)</div><div class=\"line\">\t&#125;</div><div class=\"line\"></div><div class=\"line\">\tvar qb []Qb</div><div class=\"line\">\tdoc.Find(&quot;#content-left .article&quot;).Each(func(i int, s *goquery.Selection) &#123;</div><div class=\"line\">\t\t//s即为当前的 .article 元素，查找下级中的span元素的内容。</div><div class=\"line\">\t\tcontent := s.Find(&quot;.content span&quot;).Text()</div><div class=\"line\">\t\tqb = append(qb, Qb&#123;Id: i, Content: content&#125;)</div><div class=\"line\">\t&#125;)</div><div class=\"line\"></div><div class=\"line\">\tlog.Println(qb)</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>“#content-left .article” 即每一条帖子作为元素的class。</p>\n<p>将会输出：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">[</div><div class=\"line\">\t&#123;0 结婚十三周年那天，老婆望着一大桌子菜不禁泪流满面。我帮她拭去泪水:瞧你，都激动的哭了!老婆却说:我激动个屁!想想这十三年跟着你受的罪，我实在忍不住啊!&#125; </div><div class=\"line\">\t&#123;1 前几天天冷，就给妹妹买了条围巾，然后她说谢谢哥，本人本着组织精神说你应该谢谢你嫂子，她惊讶的对我说:哥，你谈女朋友了。我说:没有，你应该感谢她一直到现在都没出现，哥才有钱给你买东西&#125; </div><div class=\"line\">\t&#123;2 跟哥们去理发，剪头的是个妹纸。。妹纸:“你有女朋友么？”哥们一听，突然兴奋的说:“没有！”妹纸:“我是个实习生，本来想给你换大工的，看你没有女朋友，我就随意剪了！”哥们你别看我，我就是一口水没忍住，喷你脸上了而已！&#125; </div><div class=\"line\">\t&#123;3 老妈比较胖，小时候每次打我我都是撒腿就跑，老妈没一次抓到我的。直到老妈学会骑自行车以后，那鞭子挥得………真像套马杆的汉子，威武雄壮……&#125;</div><div class=\"line\">]</div></pre></td></tr></table></figure></p>\n<p>那么如何展示到页面中呢。</p>\n<p>我选择了 <a href=\"https://github.com/gin-gonic/gin\" target=\"_blank\" rel=\"external\">gin</a> 框架。</p>\n<p>修改一下代码。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div></pre></td><td class=\"code\"><pre><div class=\"line\">func main() &#123;</div><div class=\"line\">\tr := gin.Default()</div><div class=\"line\">\tr.LoadHTMLGlob(&quot;public/*&quot;)</div><div class=\"line\">\tr.GET(&quot;/&quot;, Index)</div><div class=\"line\">\tr.Run()</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\">func Index(c *gin.Context) &#123;</div><div class=\"line\">\tvar url = &quot;http://www.qiushibaike.com/hot&quot;</div><div class=\"line\"></div><div class=\"line\">\tdoc, err := goquery.NewDocument(url)</div><div class=\"line\">\tif err != nil &#123;</div><div class=\"line\">\t\tlog.Fatal(err)</div><div class=\"line\">\t&#125;</div><div class=\"line\"></div><div class=\"line\">\tvar result []Qb</div><div class=\"line\">\tdoc.Find(&quot;#content-left .article&quot;).Each(func(i int, s *goquery.Selection) &#123;</div><div class=\"line\">\t\tcontent := s.Find(&quot;.content span&quot;).Text()</div><div class=\"line\">\t\tresult = append(result, Qb&#123;Id: i, Content: content&#125;)</div><div class=\"line\">\t&#125;)</div><div class=\"line\"></div><div class=\"line\">\tc.HTML(http.StatusOK, &quot;index.html&quot;, gin.H&#123;</div><div class=\"line\">\t\t&quot;items&quot;: result,</div><div class=\"line\">\t\t&quot;title&quot;: &quot;糗百热门&quot;</div><div class=\"line\">\t&#125;)</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>可以看到，<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">r := gin.Default()</div><div class=\"line\">r.LoadHTMLGlob(&quot;public/*&quot;)</div><div class=\"line\">r.GET(&quot;/&quot;, Index)</div></pre></td></tr></table></figure></p>\n<p>这里加载了public目录中的模板，然后下一行，表示，接收到 “/“ 的请求时，调用Index方法去处理。</p>\n<p>到这里，文档的抓取，解析，构造数据就已经完成，下一步，看一下怎么显示到页面中。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div></pre></td><td class=\"code\"><pre><div class=\"line\">&#123;% raw %&#125;</div><div class=\"line\">&lt;div class=&quot;col-md-12&quot;&gt;</div><div class=\"line\">    &lt;h2&gt;&#123;&#123; .title &#125;&#125;&lt;/h2&gt;</div><div class=\"line\">    &lt;table class=&quot;table table-striped table-bordered table-hover&quot;&gt;</div><div class=\"line\">        &#123;&#123; range $item := .items &#125;&#125;</div><div class=\"line\">        &lt;tr&gt;</div><div class=\"line\">            &lt;td&gt;&#123;&#123; $item.Content &#125;&#125;&lt;/td&gt;</div><div class=\"line\">        &lt;/tr&gt;</div><div class=\"line\">        &#123;&#123; end &#125;&#125;</div><div class=\"line\">    &lt;/table&gt;</div><div class=\"line\">&lt;/div&gt;</div><div class=\"line\">&#123;% endraw %&#125;</div></pre></td></tr></table></figure>\n<p>使用 “{{ }}“ 输出后端发送过来的数据。使用 range 迭代数据。与</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">for pos, char := range str &#123;</div><div class=\"line\">...</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>一样。</p>\n<p>完整的模板代码：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div></pre></td><td class=\"code\"><pre><div class=\"line\">&#123;% raw %&#125;</div><div class=\"line\">&lt;!-- public/index.html --&gt;</div><div class=\"line\"></div><div class=\"line\">&lt;html&gt;</div><div class=\"line\">    &lt;head&gt;</div><div class=\"line\">        &lt;meta http-equiv=&quot;content-type&quot; content=&quot;text/html; charset=utf-8&quot;&gt;</div><div class=\"line\">        &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no&quot;&gt;</div><div class=\"line\">        &lt;title&gt;糗百&lt;/title&gt;</div><div class=\"line\"></div><div class=\"line\">        &lt;link rel=&quot;stylesheet&quot; href=&quot;https://cdn.bootcss.com/bootstrap/3.3.6/css/bootstrap.min.css&quot;&gt;</div><div class=\"line\">        &lt;link rel=&quot;stylesheet&quot;  href=&quot;https://cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css&quot;&gt;</div><div class=\"line\"></div><div class=\"line\">    &lt;/head&gt;</div><div class=\"line\">    &lt;body&gt;</div><div class=\"line\">        &lt;div class=&quot;container&quot;&gt;</div><div class=\"line\">            &lt;div class=&quot;row&quot;&gt;</div><div class=\"line\">                &lt;div class=&quot;col-md-12&quot;&gt;</div><div class=\"line\">                    &lt;h2&gt;&#123;&#123; .title &#125;&#125;&lt;/h2&gt;</div><div class=\"line\">                    &lt;table class=&quot;table table-striped table-bordered table-hover&quot;&gt;</div><div class=\"line\">                        &#123;&#123; range $item := .items &#125;&#125;</div><div class=\"line\">                        &lt;tr&gt;</div><div class=\"line\">                            &lt;td&gt;&#123;&#123; $item.Content &#125;&#125;&lt;/td&gt;</div><div class=\"line\">                        &lt;/tr&gt;</div><div class=\"line\">                        &#123;&#123; end &#125;&#125;</div><div class=\"line\">                    &lt;/table&gt;</div><div class=\"line\">                &lt;/div&gt;</div><div class=\"line\">            &lt;/div&gt;</div><div class=\"line\">        &lt;/div&gt;</div><div class=\"line\">    &lt;/body&gt;</div><div class=\"line\">&lt;/html&gt;</div><div class=\"line\">&#123;% endraw %&#125;</div></pre></td></tr></table></figure>\n<p>这样，运行一下，就可以了。</p>\n<p>gin框架默认使用8080端口，打开 <a href=\"http://localhost:8080\" target=\"_blank\" rel=\"external\">http://localhost:8080</a> 就可以看到一个极简版的糗百热门了。</p>\n<p>问题来了，怎么增加一个分页呢？</p>\n<p>完整代码见:</p>\n<p><a href=\"https://github.com/qichengzx/goqiubai\" target=\"_blank\" rel=\"external\">Github地址</a></p>\n<h4 id=\"后记\"><a href=\"#后记\" class=\"headerlink\" title=\"后记\"></a>后记</h4><p>其实早就写完了这篇，但是hexo生成的时候由于 <a href=\"https://hexo.io/docs/troubleshooting.html#Escape-Contents\" target=\"_blank\" rel=\"external\">“{{“的问题</a>，生成一直失败，一直拖到现在。</p>\n<p>实际代码中需要去掉 “{ % raw % }” 相关部分。</p>\n","site":{"data":{}},"excerpt":"","more":"<p>闲来无事，想着也用Go来写个爬虫之类的东西，我并不知道这算不算严格意义上的爬虫。</p>\n<p>思前想后，觉得写个爬糗百热门的脚本吧，一来足够简单，二来大概熟悉下流程。</p>\n<p>首先，选了<a href=\"https://github.com/PuerkitoBio/goquery\" target=\"_blank\" rel=\"external\">goquery</a>这个包来解析HTML，声称与jquery相似的用法，事实上也确实是这样，非常方便。</p>\n<p>定个目标，只爬取列表页的帖子内容，作者和回帖都不管。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div></pre></td><td class=\"code\"><pre><div class=\"line\">package main</div><div class=\"line\"></div><div class=\"line\">import (</div><div class=\"line\">\t&quot;github.com/PuerkitoBio/goquery&quot;</div><div class=\"line\">\t&quot;log&quot;</div><div class=\"line\">)</div><div class=\"line\"></div><div class=\"line\">//定义结构体</div><div class=\"line\">type Qb struct &#123;</div><div class=\"line\">\tId int `json:&quot;id&quot;`</div><div class=\"line\">\tContent string `json:&quot;content&quot;`</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\">func main() &#123;</div><div class=\"line\">\tvar url = &quot;http://www.qiushibaike.com/hot&quot;</div><div class=\"line\"></div><div class=\"line\">\tdoc, err := goquery.NewDocument(url)</div><div class=\"line\">\tif err != nil &#123;</div><div class=\"line\">\t\tlog.Fatal(err)</div><div class=\"line\">\t&#125;</div><div class=\"line\"></div><div class=\"line\">\tvar qb []Qb</div><div class=\"line\">\tdoc.Find(&quot;#content-left .article&quot;).Each(func(i int, s *goquery.Selection) &#123;</div><div class=\"line\">\t\t//s即为当前的 .article 元素，查找下级中的span元素的内容。</div><div class=\"line\">\t\tcontent := s.Find(&quot;.content span&quot;).Text()</div><div class=\"line\">\t\tqb = append(qb, Qb&#123;Id: i, Content: content&#125;)</div><div class=\"line\">\t&#125;)</div><div class=\"line\"></div><div class=\"line\">\tlog.Println(qb)</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>“#content-left .article” 即每一条帖子作为元素的class。</p>\n<p>将会输出：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">[</div><div class=\"line\">\t&#123;0 结婚十三周年那天，老婆望着一大桌子菜不禁泪流满面。我帮她拭去泪水:瞧你，都激动的哭了!老婆却说:我激动个屁!想想这十三年跟着你受的罪，我实在忍不住啊!&#125; </div><div class=\"line\">\t&#123;1 前几天天冷，就给妹妹买了条围巾，然后她说谢谢哥，本人本着组织精神说你应该谢谢你嫂子，她惊讶的对我说:哥，你谈女朋友了。我说:没有，你应该感谢她一直到现在都没出现，哥才有钱给你买东西&#125; </div><div class=\"line\">\t&#123;2 跟哥们去理发，剪头的是个妹纸。。妹纸:“你有女朋友么？”哥们一听，突然兴奋的说:“没有！”妹纸:“我是个实习生，本来想给你换大工的，看你没有女朋友，我就随意剪了！”哥们你别看我，我就是一口水没忍住，喷你脸上了而已！&#125; </div><div class=\"line\">\t&#123;3 老妈比较胖，小时候每次打我我都是撒腿就跑，老妈没一次抓到我的。直到老妈学会骑自行车以后，那鞭子挥得………真像套马杆的汉子，威武雄壮……&#125;</div><div class=\"line\">]</div></pre></td></tr></table></figure></p>\n<p>那么如何展示到页面中呢。</p>\n<p>我选择了 <a href=\"https://github.com/gin-gonic/gin\" target=\"_blank\" rel=\"external\">gin</a> 框架。</p>\n<p>修改一下代码。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div></pre></td><td class=\"code\"><pre><div class=\"line\">func main() &#123;</div><div class=\"line\">\tr := gin.Default()</div><div class=\"line\">\tr.LoadHTMLGlob(&quot;public/*&quot;)</div><div class=\"line\">\tr.GET(&quot;/&quot;, Index)</div><div class=\"line\">\tr.Run()</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\">func Index(c *gin.Context) &#123;</div><div class=\"line\">\tvar url = &quot;http://www.qiushibaike.com/hot&quot;</div><div class=\"line\"></div><div class=\"line\">\tdoc, err := goquery.NewDocument(url)</div><div class=\"line\">\tif err != nil &#123;</div><div class=\"line\">\t\tlog.Fatal(err)</div><div class=\"line\">\t&#125;</div><div class=\"line\"></div><div class=\"line\">\tvar result []Qb</div><div class=\"line\">\tdoc.Find(&quot;#content-left .article&quot;).Each(func(i int, s *goquery.Selection) &#123;</div><div class=\"line\">\t\tcontent := s.Find(&quot;.content span&quot;).Text()</div><div class=\"line\">\t\tresult = append(result, Qb&#123;Id: i, Content: content&#125;)</div><div class=\"line\">\t&#125;)</div><div class=\"line\"></div><div class=\"line\">\tc.HTML(http.StatusOK, &quot;index.html&quot;, gin.H&#123;</div><div class=\"line\">\t\t&quot;items&quot;: result,</div><div class=\"line\">\t\t&quot;title&quot;: &quot;糗百热门&quot;</div><div class=\"line\">\t&#125;)</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>可以看到，<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">r := gin.Default()</div><div class=\"line\">r.LoadHTMLGlob(&quot;public/*&quot;)</div><div class=\"line\">r.GET(&quot;/&quot;, Index)</div></pre></td></tr></table></figure></p>\n<p>这里加载了public目录中的模板，然后下一行，表示，接收到 “/“ 的请求时，调用Index方法去处理。</p>\n<p>到这里，文档的抓取，解析，构造数据就已经完成，下一步，看一下怎么显示到页面中。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div></pre></td><td class=\"code\"><pre><div class=\"line\">&#123;% raw %&#125;</div><div class=\"line\">&lt;div class=&quot;col-md-12&quot;&gt;</div><div class=\"line\">    &lt;h2&gt;&#123;&#123; .title &#125;&#125;&lt;/h2&gt;</div><div class=\"line\">    &lt;table class=&quot;table table-striped table-bordered table-hover&quot;&gt;</div><div class=\"line\">        &#123;&#123; range $item := .items &#125;&#125;</div><div class=\"line\">        &lt;tr&gt;</div><div class=\"line\">            &lt;td&gt;&#123;&#123; $item.Content &#125;&#125;&lt;/td&gt;</div><div class=\"line\">        &lt;/tr&gt;</div><div class=\"line\">        &#123;&#123; end &#125;&#125;</div><div class=\"line\">    &lt;/table&gt;</div><div class=\"line\">&lt;/div&gt;</div><div class=\"line\">&#123;% endraw %&#125;</div></pre></td></tr></table></figure>\n<p>使用 “{{ }}“ 输出后端发送过来的数据。使用 range 迭代数据。与</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">for pos, char := range str &#123;</div><div class=\"line\">...</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>一样。</p>\n<p>完整的模板代码：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div></pre></td><td class=\"code\"><pre><div class=\"line\">&#123;% raw %&#125;</div><div class=\"line\">&lt;!-- public/index.html --&gt;</div><div class=\"line\"></div><div class=\"line\">&lt;html&gt;</div><div class=\"line\">    &lt;head&gt;</div><div class=\"line\">        &lt;meta http-equiv=&quot;content-type&quot; content=&quot;text/html; charset=utf-8&quot;&gt;</div><div class=\"line\">        &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no&quot;&gt;</div><div class=\"line\">        &lt;title&gt;糗百&lt;/title&gt;</div><div class=\"line\"></div><div class=\"line\">        &lt;link rel=&quot;stylesheet&quot; href=&quot;https://cdn.bootcss.com/bootstrap/3.3.6/css/bootstrap.min.css&quot;&gt;</div><div class=\"line\">        &lt;link rel=&quot;stylesheet&quot;  href=&quot;https://cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css&quot;&gt;</div><div class=\"line\"></div><div class=\"line\">    &lt;/head&gt;</div><div class=\"line\">    &lt;body&gt;</div><div class=\"line\">        &lt;div class=&quot;container&quot;&gt;</div><div class=\"line\">            &lt;div class=&quot;row&quot;&gt;</div><div class=\"line\">                &lt;div class=&quot;col-md-12&quot;&gt;</div><div class=\"line\">                    &lt;h2&gt;&#123;&#123; .title &#125;&#125;&lt;/h2&gt;</div><div class=\"line\">                    &lt;table class=&quot;table table-striped table-bordered table-hover&quot;&gt;</div><div class=\"line\">                        &#123;&#123; range $item := .items &#125;&#125;</div><div class=\"line\">                        &lt;tr&gt;</div><div class=\"line\">                            &lt;td&gt;&#123;&#123; $item.Content &#125;&#125;&lt;/td&gt;</div><div class=\"line\">                        &lt;/tr&gt;</div><div class=\"line\">                        &#123;&#123; end &#125;&#125;</div><div class=\"line\">                    &lt;/table&gt;</div><div class=\"line\">                &lt;/div&gt;</div><div class=\"line\">            &lt;/div&gt;</div><div class=\"line\">        &lt;/div&gt;</div><div class=\"line\">    &lt;/body&gt;</div><div class=\"line\">&lt;/html&gt;</div><div class=\"line\">&#123;% endraw %&#125;</div></pre></td></tr></table></figure>\n<p>这样，运行一下，就可以了。</p>\n<p>gin框架默认使用8080端口，打开 <a href=\"http://localhost:8080\" target=\"_blank\" rel=\"external\">http://localhost:8080</a> 就可以看到一个极简版的糗百热门了。</p>\n<p>问题来了，怎么增加一个分页呢？</p>\n<p>完整代码见:</p>\n<p><a href=\"https://github.com/qichengzx/goqiubai\" target=\"_blank\" rel=\"external\">Github地址</a></p>\n<h4 id=\"后记\"><a href=\"#后记\" class=\"headerlink\" title=\"后记\"></a>后记</h4><p>其实早就写完了这篇，但是hexo生成的时候由于 <a href=\"https://hexo.io/docs/troubleshooting.html#Escape-Contents\" target=\"_blank\" rel=\"external\">“{{“的问题</a>，生成一直失败，一直拖到现在。</p>\n<p>实际代码中需要去掉 “{ % raw % }” 相关部分。</p>\n"},{"title":"Hello World","date":"2015-11-06T13:54:22.000Z","_content":"Welcome to [Hexo](http://hexo.io/)! This is your very first post. Check [documentation](http://hexo.io/docs/) for more info. If you get any problems when using Hexo, you can find the answer in [troubleshooting](http://hexo.io/docs/troubleshooting.html) or you can ask me on [GitHub](https://github.com/hexojs/hexo/issues).\n\n## Quick Start\n\n### Create a new post\n\n``` bash\n$ hexo new \"My New Post\"\n```\n\nMore info: [Writing](http://hexo.io/docs/writing.html)\n\n### Run server\n\n``` bash\n$ hexo server\n```\n\nMore info: [Server](http://hexo.io/docs/server.html)\n\n### Generate static files\n\n``` bash\n$ hexo generate\n```\n\nMore info: [Generating](http://hexo.io/docs/generating.html)\n\n### Deploy to remote sites\n\n``` bash\n$ hexo deploy\n```\n\nMore info: [Deployment](http://hexo.io/docs/deployment.html)\n","source":"_posts/hello-world.md","raw":"title: Hello World\ndate: 2015-11-06 21:54:22\n---\nWelcome to [Hexo](http://hexo.io/)! This is your very first post. Check [documentation](http://hexo.io/docs/) for more info. If you get any problems when using Hexo, you can find the answer in [troubleshooting](http://hexo.io/docs/troubleshooting.html) or you can ask me on [GitHub](https://github.com/hexojs/hexo/issues).\n\n## Quick Start\n\n### Create a new post\n\n``` bash\n$ hexo new \"My New Post\"\n```\n\nMore info: [Writing](http://hexo.io/docs/writing.html)\n\n### Run server\n\n``` bash\n$ hexo server\n```\n\nMore info: [Server](http://hexo.io/docs/server.html)\n\n### Generate static files\n\n``` bash\n$ hexo generate\n```\n\nMore info: [Generating](http://hexo.io/docs/generating.html)\n\n### Deploy to remote sites\n\n``` bash\n$ hexo deploy\n```\n\nMore info: [Deployment](http://hexo.io/docs/deployment.html)\n","slug":"hello-world","published":1,"updated":"2015-11-08T02:35:08.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj830jvdy001hul0rqws9nuwq","content":"<p>Welcome to <a href=\"http://hexo.io/\" target=\"_blank\" rel=\"external\">Hexo</a>! This is your very first post. Check <a href=\"http://hexo.io/docs/\" target=\"_blank\" rel=\"external\">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href=\"http://hexo.io/docs/troubleshooting.html\" target=\"_blank\" rel=\"external\">troubleshooting</a> or you can ask me on <a href=\"https://github.com/hexojs/hexo/issues\" target=\"_blank\" rel=\"external\">GitHub</a>.</p>\n<h2 id=\"Quick-Start\"><a href=\"#Quick-Start\" class=\"headerlink\" title=\"Quick Start\"></a>Quick Start</h2><h3 id=\"Create-a-new-post\"><a href=\"#Create-a-new-post\" class=\"headerlink\" title=\"Create a new post\"></a>Create a new post</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo new <span class=\"string\">\"My New Post\"</span></div></pre></td></tr></table></figure>\n<p>More info: <a href=\"http://hexo.io/docs/writing.html\" target=\"_blank\" rel=\"external\">Writing</a></p>\n<h3 id=\"Run-server\"><a href=\"#Run-server\" class=\"headerlink\" title=\"Run server\"></a>Run server</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo server</div></pre></td></tr></table></figure>\n<p>More info: <a href=\"http://hexo.io/docs/server.html\" target=\"_blank\" rel=\"external\">Server</a></p>\n<h3 id=\"Generate-static-files\"><a href=\"#Generate-static-files\" class=\"headerlink\" title=\"Generate static files\"></a>Generate static files</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo generate</div></pre></td></tr></table></figure>\n<p>More info: <a href=\"http://hexo.io/docs/generating.html\" target=\"_blank\" rel=\"external\">Generating</a></p>\n<h3 id=\"Deploy-to-remote-sites\"><a href=\"#Deploy-to-remote-sites\" class=\"headerlink\" title=\"Deploy to remote sites\"></a>Deploy to remote sites</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo deploy</div></pre></td></tr></table></figure>\n<p>More info: <a href=\"http://hexo.io/docs/deployment.html\" target=\"_blank\" rel=\"external\">Deployment</a></p>\n","site":{"data":{}},"excerpt":"","more":"<p>Welcome to <a href=\"http://hexo.io/\" target=\"_blank\" rel=\"external\">Hexo</a>! This is your very first post. Check <a href=\"http://hexo.io/docs/\" target=\"_blank\" rel=\"external\">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href=\"http://hexo.io/docs/troubleshooting.html\" target=\"_blank\" rel=\"external\">troubleshooting</a> or you can ask me on <a href=\"https://github.com/hexojs/hexo/issues\" target=\"_blank\" rel=\"external\">GitHub</a>.</p>\n<h2 id=\"Quick-Start\"><a href=\"#Quick-Start\" class=\"headerlink\" title=\"Quick Start\"></a>Quick Start</h2><h3 id=\"Create-a-new-post\"><a href=\"#Create-a-new-post\" class=\"headerlink\" title=\"Create a new post\"></a>Create a new post</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo new <span class=\"string\">\"My New Post\"</span></div></pre></td></tr></table></figure>\n<p>More info: <a href=\"http://hexo.io/docs/writing.html\" target=\"_blank\" rel=\"external\">Writing</a></p>\n<h3 id=\"Run-server\"><a href=\"#Run-server\" class=\"headerlink\" title=\"Run server\"></a>Run server</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo server</div></pre></td></tr></table></figure>\n<p>More info: <a href=\"http://hexo.io/docs/server.html\" target=\"_blank\" rel=\"external\">Server</a></p>\n<h3 id=\"Generate-static-files\"><a href=\"#Generate-static-files\" class=\"headerlink\" title=\"Generate static files\"></a>Generate static files</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo generate</div></pre></td></tr></table></figure>\n<p>More info: <a href=\"http://hexo.io/docs/generating.html\" target=\"_blank\" rel=\"external\">Generating</a></p>\n<h3 id=\"Deploy-to-remote-sites\"><a href=\"#Deploy-to-remote-sites\" class=\"headerlink\" title=\"Deploy to remote sites\"></a>Deploy to remote sites</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo deploy</div></pre></td></tr></table></figure>\n<p>More info: <a href=\"http://hexo.io/docs/deployment.html\" target=\"_blank\" rel=\"external\">Deployment</a></p>\n"},{"title":"Beego中使用过滤器","date":"2017-03-06T00:23:47.000Z","_content":"\n为了方便调试和排错，决定在现有的beego程序里加上requestID。\n\n查了些资料发现写的并不是特别清楚和详细，在此总结一下，也算是加深下印象。\n\nastaxie说可以用过滤器实现，就是在Beego运行时在特定的步骤前加入。而由于我的需求比较简单，就选在了BeforeRouter。\n\n在main.go中:\n\n```Go\nimport \"github.com/astaxie/beego/context\"\nimport \"github.com/satori/go.uuid\"\n\n```\n\n在main函数中加入:\n\n```Go\nvar FilterRequestID = func(ctx *context.Context) {\n\trequestId := uuid.NewV4().String()\n\tctx.Input.SetData(\"requestId\", requestId)\n}\n\nbeego.InsertFilter(\"/*\", beego.BeforeRouter, FilterRequestID)\n\n```\n\n在需要使用的地方，如\n\n```Go\n// @router /requestid [get]\nfunc (this *MyController) Requestid() {\n\t//读取requestId\n\trid := this.Ctx.Input.GetData(\"requestId\").(string)\n\n\tfmt.Println(\"requestId:\",rid)\n}\n```\n\n或者\n\n```Go\nfunc (m *MyController) Requestid() {\n\trid := m.Ctx.Input.GetData(\"requestId\").(string)\n\n\tfmt.Println(\"requestId:\",rid)\n}\n```\n\n其实很简单，但是文档和查到的资料中都没有明确的说需要引用 \"github.com/astaxie/beego/context\"，导致写的时候浪费了一些时间。\n\n参考资料:\n\n[过滤器](https://beego.me/docs/mvc/controller/filter.md)\n[beego log中增加request id的一种方式](https://gocn.io/article/95)","source":"_posts/insert-filter-in-beego.md","raw":"title: Beego中使用过滤器\ncategories: golang\ndate: 2017-03-06 08:23:47\ntags:  [go]\n\n---\n\n为了方便调试和排错，决定在现有的beego程序里加上requestID。\n\n查了些资料发现写的并不是特别清楚和详细，在此总结一下，也算是加深下印象。\n\nastaxie说可以用过滤器实现，就是在Beego运行时在特定的步骤前加入。而由于我的需求比较简单，就选在了BeforeRouter。\n\n在main.go中:\n\n```Go\nimport \"github.com/astaxie/beego/context\"\nimport \"github.com/satori/go.uuid\"\n\n```\n\n在main函数中加入:\n\n```Go\nvar FilterRequestID = func(ctx *context.Context) {\n\trequestId := uuid.NewV4().String()\n\tctx.Input.SetData(\"requestId\", requestId)\n}\n\nbeego.InsertFilter(\"/*\", beego.BeforeRouter, FilterRequestID)\n\n```\n\n在需要使用的地方，如\n\n```Go\n// @router /requestid [get]\nfunc (this *MyController) Requestid() {\n\t//读取requestId\n\trid := this.Ctx.Input.GetData(\"requestId\").(string)\n\n\tfmt.Println(\"requestId:\",rid)\n}\n```\n\n或者\n\n```Go\nfunc (m *MyController) Requestid() {\n\trid := m.Ctx.Input.GetData(\"requestId\").(string)\n\n\tfmt.Println(\"requestId:\",rid)\n}\n```\n\n其实很简单，但是文档和查到的资料中都没有明确的说需要引用 \"github.com/astaxie/beego/context\"，导致写的时候浪费了一些时间。\n\n参考资料:\n\n[过滤器](https://beego.me/docs/mvc/controller/filter.md)\n[beego log中增加request id的一种方式](https://gocn.io/article/95)","slug":"insert-filter-in-beego","published":1,"updated":"2017-06-27T14:53:11.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj830jvdz001mul0r7hnyqvsh","content":"<p>为了方便调试和排错，决定在现有的beego程序里加上requestID。</p>\n<p>查了些资料发现写的并不是特别清楚和详细，在此总结一下，也算是加深下印象。</p>\n<p>astaxie说可以用过滤器实现，就是在Beego运行时在特定的步骤前加入。而由于我的需求比较简单，就选在了BeforeRouter。</p>\n<p>在main.go中:</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">import</span> <span class=\"string\">\"github.com/astaxie/beego/context\"</span></div><div class=\"line\"><span class=\"keyword\">import</span> <span class=\"string\">\"github.com/satori/go.uuid\"</span></div></pre></td></tr></table></figure>\n<p>在main函数中加入:</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> FilterRequestID = <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">(ctx *context.Context)</span></span> &#123;</div><div class=\"line\">\trequestId := uuid.NewV4().String()</div><div class=\"line\">\tctx.Input.SetData(<span class=\"string\">\"requestId\"</span>, requestId)</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\">beego.InsertFilter(<span class=\"string\">\"/*\"</span>, beego.BeforeRouter, FilterRequestID)</div></pre></td></tr></table></figure>\n<p>在需要使用的地方，如</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">// @router /requestid [get]</span></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(this *MyController)</span> <span class=\"title\">Requestid</span><span class=\"params\">()</span></span> &#123;</div><div class=\"line\">\t<span class=\"comment\">//读取requestId</span></div><div class=\"line\">\trid := this.Ctx.Input.GetData(<span class=\"string\">\"requestId\"</span>).(<span class=\"keyword\">string</span>)</div><div class=\"line\"></div><div class=\"line\">\tfmt.Println(<span class=\"string\">\"requestId:\"</span>,rid)</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>或者</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(m *MyController)</span> <span class=\"title\">Requestid</span><span class=\"params\">()</span></span> &#123;</div><div class=\"line\">\trid := m.Ctx.Input.GetData(<span class=\"string\">\"requestId\"</span>).(<span class=\"keyword\">string</span>)</div><div class=\"line\"></div><div class=\"line\">\tfmt.Println(<span class=\"string\">\"requestId:\"</span>,rid)</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>其实很简单，但是文档和查到的资料中都没有明确的说需要引用 “github.com/astaxie/beego/context”，导致写的时候浪费了一些时间。</p>\n<p>参考资料:</p>\n<p><a href=\"https://beego.me/docs/mvc/controller/filter.md\" target=\"_blank\" rel=\"external\">过滤器</a><br><a href=\"https://gocn.io/article/95\" target=\"_blank\" rel=\"external\">beego log中增加request id的一种方式</a></p>\n","site":{"data":{}},"excerpt":"","more":"<p>为了方便调试和排错，决定在现有的beego程序里加上requestID。</p>\n<p>查了些资料发现写的并不是特别清楚和详细，在此总结一下，也算是加深下印象。</p>\n<p>astaxie说可以用过滤器实现，就是在Beego运行时在特定的步骤前加入。而由于我的需求比较简单，就选在了BeforeRouter。</p>\n<p>在main.go中:</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">import</span> <span class=\"string\">\"github.com/astaxie/beego/context\"</span></div><div class=\"line\"><span class=\"keyword\">import</span> <span class=\"string\">\"github.com/satori/go.uuid\"</span></div></pre></td></tr></table></figure>\n<p>在main函数中加入:</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> FilterRequestID = <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">(ctx *context.Context)</span></span> &#123;</div><div class=\"line\">\trequestId := uuid.NewV4().String()</div><div class=\"line\">\tctx.Input.SetData(<span class=\"string\">\"requestId\"</span>, requestId)</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\">beego.InsertFilter(<span class=\"string\">\"/*\"</span>, beego.BeforeRouter, FilterRequestID)</div></pre></td></tr></table></figure>\n<p>在需要使用的地方，如</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">// @router /requestid [get]</span></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(this *MyController)</span> <span class=\"title\">Requestid</span><span class=\"params\">()</span></span> &#123;</div><div class=\"line\">\t<span class=\"comment\">//读取requestId</span></div><div class=\"line\">\trid := this.Ctx.Input.GetData(<span class=\"string\">\"requestId\"</span>).(<span class=\"keyword\">string</span>)</div><div class=\"line\"></div><div class=\"line\">\tfmt.Println(<span class=\"string\">\"requestId:\"</span>,rid)</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>或者</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(m *MyController)</span> <span class=\"title\">Requestid</span><span class=\"params\">()</span></span> &#123;</div><div class=\"line\">\trid := m.Ctx.Input.GetData(<span class=\"string\">\"requestId\"</span>).(<span class=\"keyword\">string</span>)</div><div class=\"line\"></div><div class=\"line\">\tfmt.Println(<span class=\"string\">\"requestId:\"</span>,rid)</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>其实很简单，但是文档和查到的资料中都没有明确的说需要引用 “github.com/astaxie/beego/context”，导致写的时候浪费了一些时间。</p>\n<p>参考资料:</p>\n<p><a href=\"https://beego.me/docs/mvc/controller/filter.md\" target=\"_blank\" rel=\"external\">过滤器</a><br><a href=\"https://gocn.io/article/95\" target=\"_blank\" rel=\"external\">beego log中增加request id的一种方式</a></p>\n"},{"title":"Mac brew php7.1环境下安装Yaf","date":"2016-11-02T09:57:38.000Z","_content":"\n![](/images/php/think201-emergence-of-php7.jpg)\n\n开发机一直使用brew来安装PHP及其他的环境，今天把PHP升到7.1，由于7.1版本下还没有[yaf](http://www.laruence.com/manual/)的源，所以无法使用brew安装，只能编译安装了。\n\n首先下载yaf，解压，进入目录。\n\n```\ngit clone git@github.com:laruence/yaf.git\n\n$(brew --prefix homebrew/php/php71)/bin/phpize\n\n./configure --with-php-config=$(brew --prefix homebrew/php/php71)/bin/php-config\n\nmake && make install\n\nmake test\n\n```\n\n$(brew --prefix homebrew/php/php71) 即 brew info php71结果中的path值。\n\n由于brew安装PHP会在php.ini同级目录创建conf.d目录，并把扩展的配置文件写在这里，一目了然知道都安装了哪些扩展，所以也以同样方式在此目录创建ext-yaf.ini。\n\nmake install 后会显示，具体路径可能会不一样。\n\n```\nInstalling shared extensions:     /usr/local/Cellar/php71/7.1.0-rc.5_9/lib/php/extensions/no-debug-non-zts-20160303/\n```\n这个目录即扩展.so的存放目录。下边会用到。\n\n```\n[yaf]\nextension=\"/usr/local/opt/php71/lib/php/extensions/no-debug-non-zts-20160303/yaf.so\"\nyaf.environ=\"dev\"\n;yaf.use_namespace = 1\n```\n\n至此，重启php-fpm就可以了。\n\n#### \n图片来自：[Emergence of PHP7](https://think201.com/blog/2016/emergence-of-php7/)","source":"_posts/install-yaf-on-mac.md","raw":"title: Mac brew php7.1环境下安装Yaf\ncategories: php\ndate: 2016-11-02 17:57:38\ntags:  [php]\n\n---\n\n![](/images/php/think201-emergence-of-php7.jpg)\n\n开发机一直使用brew来安装PHP及其他的环境，今天把PHP升到7.1，由于7.1版本下还没有[yaf](http://www.laruence.com/manual/)的源，所以无法使用brew安装，只能编译安装了。\n\n首先下载yaf，解压，进入目录。\n\n```\ngit clone git@github.com:laruence/yaf.git\n\n$(brew --prefix homebrew/php/php71)/bin/phpize\n\n./configure --with-php-config=$(brew --prefix homebrew/php/php71)/bin/php-config\n\nmake && make install\n\nmake test\n\n```\n\n$(brew --prefix homebrew/php/php71) 即 brew info php71结果中的path值。\n\n由于brew安装PHP会在php.ini同级目录创建conf.d目录，并把扩展的配置文件写在这里，一目了然知道都安装了哪些扩展，所以也以同样方式在此目录创建ext-yaf.ini。\n\nmake install 后会显示，具体路径可能会不一样。\n\n```\nInstalling shared extensions:     /usr/local/Cellar/php71/7.1.0-rc.5_9/lib/php/extensions/no-debug-non-zts-20160303/\n```\n这个目录即扩展.so的存放目录。下边会用到。\n\n```\n[yaf]\nextension=\"/usr/local/opt/php71/lib/php/extensions/no-debug-non-zts-20160303/yaf.so\"\nyaf.environ=\"dev\"\n;yaf.use_namespace = 1\n```\n\n至此，重启php-fpm就可以了。\n\n#### \n图片来自：[Emergence of PHP7](https://think201.com/blog/2016/emergence-of-php7/)","slug":"install-yaf-on-mac","published":1,"updated":"2016-11-30T13:16:37.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj830jve1001oul0rqu9ajrpl","content":"<p><img src=\"/images/php/think201-emergence-of-php7.jpg\" alt=\"\"></p>\n<p>开发机一直使用brew来安装PHP及其他的环境，今天把PHP升到7.1，由于7.1版本下还没有<a href=\"http://www.laruence.com/manual/\" target=\"_blank\" rel=\"external\">yaf</a>的源，所以无法使用brew安装，只能编译安装了。</p>\n<p>首先下载yaf，解压，进入目录。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\">git clone git@github.com:laruence/yaf.git</div><div class=\"line\"></div><div class=\"line\">$(brew --prefix homebrew/php/php71)/bin/phpize</div><div class=\"line\"></div><div class=\"line\">./configure --with-php-config=$(brew --prefix homebrew/php/php71)/bin/php-config</div><div class=\"line\"></div><div class=\"line\">make &amp;&amp; make install</div><div class=\"line\"></div><div class=\"line\">make test</div></pre></td></tr></table></figure>\n<p>$(brew –prefix homebrew/php/php71) 即 brew info php71结果中的path值。</p>\n<p>由于brew安装PHP会在php.ini同级目录创建conf.d目录，并把扩展的配置文件写在这里，一目了然知道都安装了哪些扩展，所以也以同样方式在此目录创建ext-yaf.ini。</p>\n<p>make install 后会显示，具体路径可能会不一样。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">Installing shared extensions:     /usr/local/Cellar/php71/7.1.0-rc.5_9/lib/php/extensions/no-debug-non-zts-20160303/</div></pre></td></tr></table></figure>\n<p>这个目录即扩展.so的存放目录。下边会用到。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">[yaf]</div><div class=\"line\">extension=&quot;/usr/local/opt/php71/lib/php/extensions/no-debug-non-zts-20160303/yaf.so&quot;</div><div class=\"line\">yaf.environ=&quot;dev&quot;</div><div class=\"line\">;yaf.use_namespace = 1</div></pre></td></tr></table></figure>\n<p>至此，重启php-fpm就可以了。</p>\n<p>####<br>图片来自：<a href=\"https://think201.com/blog/2016/emergence-of-php7/\" target=\"_blank\" rel=\"external\">Emergence of PHP7</a></p>\n","site":{"data":{}},"excerpt":"","more":"<p><img src=\"/images/php/think201-emergence-of-php7.jpg\" alt=\"\"></p>\n<p>开发机一直使用brew来安装PHP及其他的环境，今天把PHP升到7.1，由于7.1版本下还没有<a href=\"http://www.laruence.com/manual/\" target=\"_blank\" rel=\"external\">yaf</a>的源，所以无法使用brew安装，只能编译安装了。</p>\n<p>首先下载yaf，解压，进入目录。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\">git clone git@github.com:laruence/yaf.git</div><div class=\"line\"></div><div class=\"line\">$(brew --prefix homebrew/php/php71)/bin/phpize</div><div class=\"line\"></div><div class=\"line\">./configure --with-php-config=$(brew --prefix homebrew/php/php71)/bin/php-config</div><div class=\"line\"></div><div class=\"line\">make &amp;&amp; make install</div><div class=\"line\"></div><div class=\"line\">make test</div></pre></td></tr></table></figure>\n<p>$(brew –prefix homebrew/php/php71) 即 brew info php71结果中的path值。</p>\n<p>由于brew安装PHP会在php.ini同级目录创建conf.d目录，并把扩展的配置文件写在这里，一目了然知道都安装了哪些扩展，所以也以同样方式在此目录创建ext-yaf.ini。</p>\n<p>make install 后会显示，具体路径可能会不一样。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">Installing shared extensions:     /usr/local/Cellar/php71/7.1.0-rc.5_9/lib/php/extensions/no-debug-non-zts-20160303/</div></pre></td></tr></table></figure>\n<p>这个目录即扩展.so的存放目录。下边会用到。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">[yaf]</div><div class=\"line\">extension=&quot;/usr/local/opt/php71/lib/php/extensions/no-debug-non-zts-20160303/yaf.so&quot;</div><div class=\"line\">yaf.environ=&quot;dev&quot;</div><div class=\"line\">;yaf.use_namespace = 1</div></pre></td></tr></table></figure>\n<p>至此，重启php-fpm就可以了。</p>\n<p>####<br>图片来自：<a href=\"https://think201.com/blog/2016/emergence-of-php7/\" target=\"_blank\" rel=\"external\">Emergence of PHP7</a></p>\n"},{"title":"JS标识符","date":"2015-11-17T14:07:21.000Z","_content":"\n\n标识符由一个字母开头，其后可以选择性的加上一个或多个字母、数字或下划线。但是，不能使用下面这些保留字：\n\n```\nabstract\nboolean break byte\ncase catch char class const continue\ndebugger default delete do double\nelse enum export extends\nfalse final finally float for function\ngoto\nif implements import in instanceof int interface \nlong\nnative new null\npackage private protected public\nreturn\nshort static super switch synchronized\nthis throw throws transient true try typeof\nvar volatile void\nwhile with\n```\n\n这个列表里的大部分并未用在JS语言里，有一些已经逐渐在新标准中出现，但是这个列表也不包括一些本应该保留的字，如undefined,NaN,Infinity。\n\nJS不允许使用保留字来命名变量或参数，也不允许在对象字面量中，或者用 点运算符(.)提取对象属性时，使用保留字作为对象的属性名。\n\n\n标识符被用于语句，变量，参数，属性名，运算符和标记。\n\n注:实际中，JS也允许 (_),($)开头。","source":"_posts/js-names.md","raw":"title: JS标识符\ncategories: javascript\ndate: 2015-11-17 22:07:21\ntags:  [javascript,标识符]\n\n---\n\n\n标识符由一个字母开头，其后可以选择性的加上一个或多个字母、数字或下划线。但是，不能使用下面这些保留字：\n\n```\nabstract\nboolean break byte\ncase catch char class const continue\ndebugger default delete do double\nelse enum export extends\nfalse final finally float for function\ngoto\nif implements import in instanceof int interface \nlong\nnative new null\npackage private protected public\nreturn\nshort static super switch synchronized\nthis throw throws transient true try typeof\nvar volatile void\nwhile with\n```\n\n这个列表里的大部分并未用在JS语言里，有一些已经逐渐在新标准中出现，但是这个列表也不包括一些本应该保留的字，如undefined,NaN,Infinity。\n\nJS不允许使用保留字来命名变量或参数，也不允许在对象字面量中，或者用 点运算符(.)提取对象属性时，使用保留字作为对象的属性名。\n\n\n标识符被用于语句，变量，参数，属性名，运算符和标记。\n\n注:实际中，JS也允许 (_),($)开头。","slug":"js-names","published":1,"updated":"2015-11-18T14:21:40.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj830jve3001sul0r7xsq6ifv","content":"<p>标识符由一个字母开头，其后可以选择性的加上一个或多个字母、数字或下划线。但是，不能使用下面这些保留字：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div></pre></td><td class=\"code\"><pre><div class=\"line\">abstract</div><div class=\"line\">boolean break byte</div><div class=\"line\">case catch char class const continue</div><div class=\"line\">debugger default delete do double</div><div class=\"line\">else enum export extends</div><div class=\"line\">false final finally float for function</div><div class=\"line\">goto</div><div class=\"line\">if implements import in instanceof int interface </div><div class=\"line\">long</div><div class=\"line\">native new null</div><div class=\"line\">package private protected public</div><div class=\"line\">return</div><div class=\"line\">short static super switch synchronized</div><div class=\"line\">this throw throws transient true try typeof</div><div class=\"line\">var volatile void</div><div class=\"line\">while with</div></pre></td></tr></table></figure>\n<p>这个列表里的大部分并未用在JS语言里，有一些已经逐渐在新标准中出现，但是这个列表也不包括一些本应该保留的字，如undefined,NaN,Infinity。</p>\n<p>JS不允许使用保留字来命名变量或参数，也不允许在对象字面量中，或者用 点运算符(.)提取对象属性时，使用保留字作为对象的属性名。</p>\n<p>标识符被用于语句，变量，参数，属性名，运算符和标记。</p>\n<p>注:实际中，JS也允许 (_),($)开头。</p>\n","site":{"data":{}},"excerpt":"","more":"<p>标识符由一个字母开头，其后可以选择性的加上一个或多个字母、数字或下划线。但是，不能使用下面这些保留字：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div></pre></td><td class=\"code\"><pre><div class=\"line\">abstract</div><div class=\"line\">boolean break byte</div><div class=\"line\">case catch char class const continue</div><div class=\"line\">debugger default delete do double</div><div class=\"line\">else enum export extends</div><div class=\"line\">false final finally float for function</div><div class=\"line\">goto</div><div class=\"line\">if implements import in instanceof int interface </div><div class=\"line\">long</div><div class=\"line\">native new null</div><div class=\"line\">package private protected public</div><div class=\"line\">return</div><div class=\"line\">short static super switch synchronized</div><div class=\"line\">this throw throws transient true try typeof</div><div class=\"line\">var volatile void</div><div class=\"line\">while with</div></pre></td></tr></table></figure>\n<p>这个列表里的大部分并未用在JS语言里，有一些已经逐渐在新标准中出现，但是这个列表也不包括一些本应该保留的字，如undefined,NaN,Infinity。</p>\n<p>JS不允许使用保留字来命名变量或参数，也不允许在对象字面量中，或者用 点运算符(.)提取对象属性时，使用保留字作为对象的属性名。</p>\n<p>标识符被用于语句，变量，参数，属性名，运算符和标记。</p>\n<p>注:实际中，JS也允许 (_),($)开头。</p>\n"},{"title":"Node.js连接MySQL并读取数据","date":"2015-12-03T13:38:37.000Z","_content":"\n\n![](http://7b1hhm.com1.z0.glb.clouddn.com/hexo201312030901.jpg)\n\n文章部分代码与[之前整理的一篇文章](http://segmentfault.com/a/1190000002995355)一样。\n\n本文主要实现node连接MySQL并读取指定表的数据输出到ejs模板中。\n\nMySQL是一款非常常用的开源数据库，[npm中也有MySQL的包](https://www.npmjs.com/package/mysql)。\n\n\n###MySQL测试库的表结构：\n\n```\nDROP TABLE IF EXISTS `news`;\nCREATE TABLE `news` (\n  `id` int(11) NOT NULL DEFAULT '0',\n  `title` varchar(45) NOT NULL DEFAULT '',\n  `createtime` int(11) NOT NULL DEFAULT '0',\n  PRIMARY KEY (`id`)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8;\n\nLOCK TABLES `news` WRITE;\nINSERT INTO `news` VALUES (1,'news one',1449064787),(2,'news two',1449064790),(3,'news three',1449064900);\nUNLOCK TABLES;\n```\n\n### 安装Node.js MySQL包\n\n```\nnpm install mysql\n```\n\n### server.js\n\n```\n//server.js\nvar express = require('express');\nvar mysql = require('mysql');\nvar moment = require('moment');//用来格式化UNIX时间戳\nvar app = express();\n```\n配置MySQL数据库\n\n```\nvar connection = mysql.createConnection({\n\thost:'localhost',\n\tuser:'root',\n\tpassword:'root',\n\tdatabase:'node'\n});\n```\n连接数据库，并在成功或失败时输出log\n\n```\nconnection.connect(function(err){\n\tif(!err){\n\t\tconsole.log('Database is connected...\\n\\n');\n\t}else{\n\t\tconsole.log('Error Connecting Database...\\n\\n');\n\t}\n});\n```\n定义表\n\n```\nvar TABLE = 'news';\n```\n设定模板引擎\n\n```\napp.set('view engine','ejs');\n```\n这就是很普通的路由，表示接收访问首页的请求\n\n```\napp.get('/',function(req,res){\n\t//定义一组数据\n\tvar data = [\n\t\t\t\t\t{ name : 'Bloody Mary' , drunkness : 3 },\n\t\t\t\t\t{ name : 'Martini' , drunkness : 5 },\n\t\t\t\t\t{ name : 'Scotch' , drunkness : 10 }\n\t\t\t\t];\n\n\t//MySQL查询\n\tconnection.query(\n\t\t//普通的SQL\n\t\t'select * from ' + TABLE,\n\t\t//查询回调\n\t\tfunction(err,results,fields){\n\t\t\tif(err){\n\t\t\t\t//输出错误\n\t\t\t\tthrow err;\n\t\t\t}\n\t\t\t\n\t\t\tif(results){\n\t\t\t\tconsole.log(results);\n\t\t\t\t//express render一个页面\n\t\t\t\tres.render('pages/index',{\n\t\t\t\t\ttitle:'test',\n\t\t\t\t\tresults:results,\n\t\t\t\t\tdata:data,\n\t\t\t\t\tmoment:moment\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t)\n\n});\n\napp.listen(8888);\nconsole.log('8888 is the magic port');\n```\n\n### index.ejs\n\n```\n<% include ../partials/head %>\n\n<body class=\"container\">\n\t<main>\n\t\t<div class=\"jumbotron\">\n\t\t\t<h2>data from static</h2>\n\t\t\t<ul>\n\t\t\t\t<% data.forEach(function(d) { %>\n\t\t\t\t<li>\n\t\t\t\t\t<%= d.name %>\n\t\t\t\t\t<span><%= d.drunkness %></span>\n\t\t\t\t</li>\n\t\t\t    <% }); %>\n\t\t\t</ul>\n\t\t</div>\n\t\t<div class=\"jumbotron\">\n\t\t\t<h2>data from mysql</h2>\n\t\t\t<ul>\n\t\t\t\t<% results.forEach(function(result) { %>\n\t\t\t\t<li>\n\t\t\t\t\t<%= result.id %>\n\t\t\t\t\t<span><%= result.title %></span>\n\t\t\t\t\t<span><%= moment(result.createtime*1000).format('YYYY-MM-DD, hh:mm:ss') %></span>\n\t\t\t\t</li>\n\t\t\t    <% }); %>\n\t\t\t</ul>\n\t\t</div>\n\t\t\n\t</main>\n\n\t<footer>\n\t\t<% include ../partials/footer %>\n\t</footer>\n\t\n</body>\n</html>\n```\n至此，就可以正常输出从数据库里读取出来的数据了。\n\n**小插曲**\n\n之前在练习的时候，require MySQL 之后npm install 只安装了require的几个包，昨天再写的时候装了一大堆。\n另外之前在使用moment的时候并没有在render页面的时候传入moment，直接就可以用了，昨天也报错了。\n","source":"_posts/nodejs-mysql.md","raw":"title: Node.js连接MySQL并读取数据\ndate: 2015-12-03 21:38:37\ntags:  [node,mysql]\ncategories: javascript\n---\n\n\n![](http://7b1hhm.com1.z0.glb.clouddn.com/hexo201312030901.jpg)\n\n文章部分代码与[之前整理的一篇文章](http://segmentfault.com/a/1190000002995355)一样。\n\n本文主要实现node连接MySQL并读取指定表的数据输出到ejs模板中。\n\nMySQL是一款非常常用的开源数据库，[npm中也有MySQL的包](https://www.npmjs.com/package/mysql)。\n\n\n###MySQL测试库的表结构：\n\n```\nDROP TABLE IF EXISTS `news`;\nCREATE TABLE `news` (\n  `id` int(11) NOT NULL DEFAULT '0',\n  `title` varchar(45) NOT NULL DEFAULT '',\n  `createtime` int(11) NOT NULL DEFAULT '0',\n  PRIMARY KEY (`id`)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8;\n\nLOCK TABLES `news` WRITE;\nINSERT INTO `news` VALUES (1,'news one',1449064787),(2,'news two',1449064790),(3,'news three',1449064900);\nUNLOCK TABLES;\n```\n\n### 安装Node.js MySQL包\n\n```\nnpm install mysql\n```\n\n### server.js\n\n```\n//server.js\nvar express = require('express');\nvar mysql = require('mysql');\nvar moment = require('moment');//用来格式化UNIX时间戳\nvar app = express();\n```\n配置MySQL数据库\n\n```\nvar connection = mysql.createConnection({\n\thost:'localhost',\n\tuser:'root',\n\tpassword:'root',\n\tdatabase:'node'\n});\n```\n连接数据库，并在成功或失败时输出log\n\n```\nconnection.connect(function(err){\n\tif(!err){\n\t\tconsole.log('Database is connected...\\n\\n');\n\t}else{\n\t\tconsole.log('Error Connecting Database...\\n\\n');\n\t}\n});\n```\n定义表\n\n```\nvar TABLE = 'news';\n```\n设定模板引擎\n\n```\napp.set('view engine','ejs');\n```\n这就是很普通的路由，表示接收访问首页的请求\n\n```\napp.get('/',function(req,res){\n\t//定义一组数据\n\tvar data = [\n\t\t\t\t\t{ name : 'Bloody Mary' , drunkness : 3 },\n\t\t\t\t\t{ name : 'Martini' , drunkness : 5 },\n\t\t\t\t\t{ name : 'Scotch' , drunkness : 10 }\n\t\t\t\t];\n\n\t//MySQL查询\n\tconnection.query(\n\t\t//普通的SQL\n\t\t'select * from ' + TABLE,\n\t\t//查询回调\n\t\tfunction(err,results,fields){\n\t\t\tif(err){\n\t\t\t\t//输出错误\n\t\t\t\tthrow err;\n\t\t\t}\n\t\t\t\n\t\t\tif(results){\n\t\t\t\tconsole.log(results);\n\t\t\t\t//express render一个页面\n\t\t\t\tres.render('pages/index',{\n\t\t\t\t\ttitle:'test',\n\t\t\t\t\tresults:results,\n\t\t\t\t\tdata:data,\n\t\t\t\t\tmoment:moment\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t)\n\n});\n\napp.listen(8888);\nconsole.log('8888 is the magic port');\n```\n\n### index.ejs\n\n```\n<% include ../partials/head %>\n\n<body class=\"container\">\n\t<main>\n\t\t<div class=\"jumbotron\">\n\t\t\t<h2>data from static</h2>\n\t\t\t<ul>\n\t\t\t\t<% data.forEach(function(d) { %>\n\t\t\t\t<li>\n\t\t\t\t\t<%= d.name %>\n\t\t\t\t\t<span><%= d.drunkness %></span>\n\t\t\t\t</li>\n\t\t\t    <% }); %>\n\t\t\t</ul>\n\t\t</div>\n\t\t<div class=\"jumbotron\">\n\t\t\t<h2>data from mysql</h2>\n\t\t\t<ul>\n\t\t\t\t<% results.forEach(function(result) { %>\n\t\t\t\t<li>\n\t\t\t\t\t<%= result.id %>\n\t\t\t\t\t<span><%= result.title %></span>\n\t\t\t\t\t<span><%= moment(result.createtime*1000).format('YYYY-MM-DD, hh:mm:ss') %></span>\n\t\t\t\t</li>\n\t\t\t    <% }); %>\n\t\t\t</ul>\n\t\t</div>\n\t\t\n\t</main>\n\n\t<footer>\n\t\t<% include ../partials/footer %>\n\t</footer>\n\t\n</body>\n</html>\n```\n至此，就可以正常输出从数据库里读取出来的数据了。\n\n**小插曲**\n\n之前在练习的时候，require MySQL 之后npm install 只安装了require的几个包，昨天再写的时候装了一大堆。\n另外之前在使用moment的时候并没有在render页面的时候传入moment，直接就可以用了，昨天也报错了。\n","slug":"nodejs-mysql","published":1,"updated":"2015-12-03T14:24:07.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj830jve5001vul0ru7vhvsfe","content":"<p><img src=\"http://7b1hhm.com1.z0.glb.clouddn.com/hexo201312030901.jpg\" alt=\"\"></p>\n<p>文章部分代码与<a href=\"http://segmentfault.com/a/1190000002995355\" target=\"_blank\" rel=\"external\">之前整理的一篇文章</a>一样。</p>\n<p>本文主要实现node连接MySQL并读取指定表的数据输出到ejs模板中。</p>\n<p>MySQL是一款非常常用的开源数据库，<a href=\"https://www.npmjs.com/package/mysql\" target=\"_blank\" rel=\"external\">npm中也有MySQL的包</a>。</p>\n<p>###MySQL测试库的表结构：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div></pre></td><td class=\"code\"><pre><div class=\"line\">DROP TABLE IF EXISTS `news`;</div><div class=\"line\">CREATE TABLE `news` (</div><div class=\"line\">  `id` int(11) NOT NULL DEFAULT &apos;0&apos;,</div><div class=\"line\">  `title` varchar(45) NOT NULL DEFAULT &apos;&apos;,</div><div class=\"line\">  `createtime` int(11) NOT NULL DEFAULT &apos;0&apos;,</div><div class=\"line\">  PRIMARY KEY (`id`)</div><div class=\"line\">) ENGINE=InnoDB DEFAULT CHARSET=utf8;</div><div class=\"line\"></div><div class=\"line\">LOCK TABLES `news` WRITE;</div><div class=\"line\">INSERT INTO `news` VALUES (1,&apos;news one&apos;,1449064787),(2,&apos;news two&apos;,1449064790),(3,&apos;news three&apos;,1449064900);</div><div class=\"line\">UNLOCK TABLES;</div></pre></td></tr></table></figure>\n<h3 id=\"安装Node-js-MySQL包\"><a href=\"#安装Node-js-MySQL包\" class=\"headerlink\" title=\"安装Node.js MySQL包\"></a>安装Node.js MySQL包</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">npm install mysql</div></pre></td></tr></table></figure>\n<h3 id=\"server-js\"><a href=\"#server-js\" class=\"headerlink\" title=\"server.js\"></a>server.js</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">//server.js</div><div class=\"line\">var express = require(&apos;express&apos;);</div><div class=\"line\">var mysql = require(&apos;mysql&apos;);</div><div class=\"line\">var moment = require(&apos;moment&apos;);//用来格式化UNIX时间戳</div><div class=\"line\">var app = express();</div></pre></td></tr></table></figure>\n<p>配置MySQL数据库</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">var connection = mysql.createConnection(&#123;</div><div class=\"line\">\thost:&apos;localhost&apos;,</div><div class=\"line\">\tuser:&apos;root&apos;,</div><div class=\"line\">\tpassword:&apos;root&apos;,</div><div class=\"line\">\tdatabase:&apos;node&apos;</div><div class=\"line\">&#125;);</div></pre></td></tr></table></figure>\n<p>连接数据库，并在成功或失败时输出log</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">connection.connect(function(err)&#123;</div><div class=\"line\">\tif(!err)&#123;</div><div class=\"line\">\t\tconsole.log(&apos;Database is connected...\\n\\n&apos;);</div><div class=\"line\">\t&#125;else&#123;</div><div class=\"line\">\t\tconsole.log(&apos;Error Connecting Database...\\n\\n&apos;);</div><div class=\"line\">\t&#125;</div><div class=\"line\">&#125;);</div></pre></td></tr></table></figure>\n<p>定义表</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">var TABLE = &apos;news&apos;;</div></pre></td></tr></table></figure>\n<p>设定模板引擎</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">app.set(&apos;view engine&apos;,&apos;ejs&apos;);</div></pre></td></tr></table></figure>\n<p>这就是很普通的路由，表示接收访问首页的请求</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div></pre></td><td class=\"code\"><pre><div class=\"line\">app.get(&apos;/&apos;,function(req,res)&#123;</div><div class=\"line\">\t//定义一组数据</div><div class=\"line\">\tvar data = [</div><div class=\"line\">\t\t\t\t\t&#123; name : &apos;Bloody Mary&apos; , drunkness : 3 &#125;,</div><div class=\"line\">\t\t\t\t\t&#123; name : &apos;Martini&apos; , drunkness : 5 &#125;,</div><div class=\"line\">\t\t\t\t\t&#123; name : &apos;Scotch&apos; , drunkness : 10 &#125;</div><div class=\"line\">\t\t\t\t];</div><div class=\"line\"></div><div class=\"line\">\t//MySQL查询</div><div class=\"line\">\tconnection.query(</div><div class=\"line\">\t\t//普通的SQL</div><div class=\"line\">\t\t&apos;select * from &apos; + TABLE,</div><div class=\"line\">\t\t//查询回调</div><div class=\"line\">\t\tfunction(err,results,fields)&#123;</div><div class=\"line\">\t\t\tif(err)&#123;</div><div class=\"line\">\t\t\t\t//输出错误</div><div class=\"line\">\t\t\t\tthrow err;</div><div class=\"line\">\t\t\t&#125;</div><div class=\"line\">\t\t\t</div><div class=\"line\">\t\t\tif(results)&#123;</div><div class=\"line\">\t\t\t\tconsole.log(results);</div><div class=\"line\">\t\t\t\t//express render一个页面</div><div class=\"line\">\t\t\t\tres.render(&apos;pages/index&apos;,&#123;</div><div class=\"line\">\t\t\t\t\ttitle:&apos;test&apos;,</div><div class=\"line\">\t\t\t\t\tresults:results,</div><div class=\"line\">\t\t\t\t\tdata:data,</div><div class=\"line\">\t\t\t\t\tmoment:moment</div><div class=\"line\">\t\t\t\t&#125;);</div><div class=\"line\">\t\t\t&#125;</div><div class=\"line\">\t\t&#125;</div><div class=\"line\">\t)</div><div class=\"line\"></div><div class=\"line\">&#125;);</div><div class=\"line\"></div><div class=\"line\">app.listen(8888);</div><div class=\"line\">console.log(&apos;8888 is the magic port&apos;);</div></pre></td></tr></table></figure>\n<h3 id=\"index-ejs\"><a href=\"#index-ejs\" class=\"headerlink\" title=\"index.ejs\"></a>index.ejs</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;% include ../partials/head %&gt;</div><div class=\"line\"></div><div class=\"line\">&lt;body class=&quot;container&quot;&gt;</div><div class=\"line\">\t&lt;main&gt;</div><div class=\"line\">\t\t&lt;div class=&quot;jumbotron&quot;&gt;</div><div class=\"line\">\t\t\t&lt;h2&gt;data from static&lt;/h2&gt;</div><div class=\"line\">\t\t\t&lt;ul&gt;</div><div class=\"line\">\t\t\t\t&lt;% data.forEach(function(d) &#123; %&gt;</div><div class=\"line\">\t\t\t\t&lt;li&gt;</div><div class=\"line\">\t\t\t\t\t&lt;%= d.name %&gt;</div><div class=\"line\">\t\t\t\t\t&lt;span&gt;&lt;%= d.drunkness %&gt;&lt;/span&gt;</div><div class=\"line\">\t\t\t\t&lt;/li&gt;</div><div class=\"line\">\t\t\t    &lt;% &#125;); %&gt;</div><div class=\"line\">\t\t\t&lt;/ul&gt;</div><div class=\"line\">\t\t&lt;/div&gt;</div><div class=\"line\">\t\t&lt;div class=&quot;jumbotron&quot;&gt;</div><div class=\"line\">\t\t\t&lt;h2&gt;data from mysql&lt;/h2&gt;</div><div class=\"line\">\t\t\t&lt;ul&gt;</div><div class=\"line\">\t\t\t\t&lt;% results.forEach(function(result) &#123; %&gt;</div><div class=\"line\">\t\t\t\t&lt;li&gt;</div><div class=\"line\">\t\t\t\t\t&lt;%= result.id %&gt;</div><div class=\"line\">\t\t\t\t\t&lt;span&gt;&lt;%= result.title %&gt;&lt;/span&gt;</div><div class=\"line\">\t\t\t\t\t&lt;span&gt;&lt;%= moment(result.createtime*1000).format(&apos;YYYY-MM-DD, hh:mm:ss&apos;) %&gt;&lt;/span&gt;</div><div class=\"line\">\t\t\t\t&lt;/li&gt;</div><div class=\"line\">\t\t\t    &lt;% &#125;); %&gt;</div><div class=\"line\">\t\t\t&lt;/ul&gt;</div><div class=\"line\">\t\t&lt;/div&gt;</div><div class=\"line\">\t\t</div><div class=\"line\">\t&lt;/main&gt;</div><div class=\"line\"></div><div class=\"line\">\t&lt;footer&gt;</div><div class=\"line\">\t\t&lt;% include ../partials/footer %&gt;</div><div class=\"line\">\t&lt;/footer&gt;</div><div class=\"line\">\t</div><div class=\"line\">&lt;/body&gt;</div><div class=\"line\">&lt;/html&gt;</div></pre></td></tr></table></figure>\n<p>至此，就可以正常输出从数据库里读取出来的数据了。</p>\n<p><strong>小插曲</strong></p>\n<p>之前在练习的时候，require MySQL 之后npm install 只安装了require的几个包，昨天再写的时候装了一大堆。<br>另外之前在使用moment的时候并没有在render页面的时候传入moment，直接就可以用了，昨天也报错了。</p>\n","site":{"data":{}},"excerpt":"","more":"<p><img src=\"http://7b1hhm.com1.z0.glb.clouddn.com/hexo201312030901.jpg\" alt=\"\"></p>\n<p>文章部分代码与<a href=\"http://segmentfault.com/a/1190000002995355\" target=\"_blank\" rel=\"external\">之前整理的一篇文章</a>一样。</p>\n<p>本文主要实现node连接MySQL并读取指定表的数据输出到ejs模板中。</p>\n<p>MySQL是一款非常常用的开源数据库，<a href=\"https://www.npmjs.com/package/mysql\" target=\"_blank\" rel=\"external\">npm中也有MySQL的包</a>。</p>\n<p>###MySQL测试库的表结构：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div></pre></td><td class=\"code\"><pre><div class=\"line\">DROP TABLE IF EXISTS `news`;</div><div class=\"line\">CREATE TABLE `news` (</div><div class=\"line\">  `id` int(11) NOT NULL DEFAULT &apos;0&apos;,</div><div class=\"line\">  `title` varchar(45) NOT NULL DEFAULT &apos;&apos;,</div><div class=\"line\">  `createtime` int(11) NOT NULL DEFAULT &apos;0&apos;,</div><div class=\"line\">  PRIMARY KEY (`id`)</div><div class=\"line\">) ENGINE=InnoDB DEFAULT CHARSET=utf8;</div><div class=\"line\"></div><div class=\"line\">LOCK TABLES `news` WRITE;</div><div class=\"line\">INSERT INTO `news` VALUES (1,&apos;news one&apos;,1449064787),(2,&apos;news two&apos;,1449064790),(3,&apos;news three&apos;,1449064900);</div><div class=\"line\">UNLOCK TABLES;</div></pre></td></tr></table></figure>\n<h3 id=\"安装Node-js-MySQL包\"><a href=\"#安装Node-js-MySQL包\" class=\"headerlink\" title=\"安装Node.js MySQL包\"></a>安装Node.js MySQL包</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">npm install mysql</div></pre></td></tr></table></figure>\n<h3 id=\"server-js\"><a href=\"#server-js\" class=\"headerlink\" title=\"server.js\"></a>server.js</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">//server.js</div><div class=\"line\">var express = require(&apos;express&apos;);</div><div class=\"line\">var mysql = require(&apos;mysql&apos;);</div><div class=\"line\">var moment = require(&apos;moment&apos;);//用来格式化UNIX时间戳</div><div class=\"line\">var app = express();</div></pre></td></tr></table></figure>\n<p>配置MySQL数据库</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">var connection = mysql.createConnection(&#123;</div><div class=\"line\">\thost:&apos;localhost&apos;,</div><div class=\"line\">\tuser:&apos;root&apos;,</div><div class=\"line\">\tpassword:&apos;root&apos;,</div><div class=\"line\">\tdatabase:&apos;node&apos;</div><div class=\"line\">&#125;);</div></pre></td></tr></table></figure>\n<p>连接数据库，并在成功或失败时输出log</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">connection.connect(function(err)&#123;</div><div class=\"line\">\tif(!err)&#123;</div><div class=\"line\">\t\tconsole.log(&apos;Database is connected...\\n\\n&apos;);</div><div class=\"line\">\t&#125;else&#123;</div><div class=\"line\">\t\tconsole.log(&apos;Error Connecting Database...\\n\\n&apos;);</div><div class=\"line\">\t&#125;</div><div class=\"line\">&#125;);</div></pre></td></tr></table></figure>\n<p>定义表</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">var TABLE = &apos;news&apos;;</div></pre></td></tr></table></figure>\n<p>设定模板引擎</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">app.set(&apos;view engine&apos;,&apos;ejs&apos;);</div></pre></td></tr></table></figure>\n<p>这就是很普通的路由，表示接收访问首页的请求</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div></pre></td><td class=\"code\"><pre><div class=\"line\">app.get(&apos;/&apos;,function(req,res)&#123;</div><div class=\"line\">\t//定义一组数据</div><div class=\"line\">\tvar data = [</div><div class=\"line\">\t\t\t\t\t&#123; name : &apos;Bloody Mary&apos; , drunkness : 3 &#125;,</div><div class=\"line\">\t\t\t\t\t&#123; name : &apos;Martini&apos; , drunkness : 5 &#125;,</div><div class=\"line\">\t\t\t\t\t&#123; name : &apos;Scotch&apos; , drunkness : 10 &#125;</div><div class=\"line\">\t\t\t\t];</div><div class=\"line\"></div><div class=\"line\">\t//MySQL查询</div><div class=\"line\">\tconnection.query(</div><div class=\"line\">\t\t//普通的SQL</div><div class=\"line\">\t\t&apos;select * from &apos; + TABLE,</div><div class=\"line\">\t\t//查询回调</div><div class=\"line\">\t\tfunction(err,results,fields)&#123;</div><div class=\"line\">\t\t\tif(err)&#123;</div><div class=\"line\">\t\t\t\t//输出错误</div><div class=\"line\">\t\t\t\tthrow err;</div><div class=\"line\">\t\t\t&#125;</div><div class=\"line\">\t\t\t</div><div class=\"line\">\t\t\tif(results)&#123;</div><div class=\"line\">\t\t\t\tconsole.log(results);</div><div class=\"line\">\t\t\t\t//express render一个页面</div><div class=\"line\">\t\t\t\tres.render(&apos;pages/index&apos;,&#123;</div><div class=\"line\">\t\t\t\t\ttitle:&apos;test&apos;,</div><div class=\"line\">\t\t\t\t\tresults:results,</div><div class=\"line\">\t\t\t\t\tdata:data,</div><div class=\"line\">\t\t\t\t\tmoment:moment</div><div class=\"line\">\t\t\t\t&#125;);</div><div class=\"line\">\t\t\t&#125;</div><div class=\"line\">\t\t&#125;</div><div class=\"line\">\t)</div><div class=\"line\"></div><div class=\"line\">&#125;);</div><div class=\"line\"></div><div class=\"line\">app.listen(8888);</div><div class=\"line\">console.log(&apos;8888 is the magic port&apos;);</div></pre></td></tr></table></figure>\n<h3 id=\"index-ejs\"><a href=\"#index-ejs\" class=\"headerlink\" title=\"index.ejs\"></a>index.ejs</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;% include ../partials/head %&gt;</div><div class=\"line\"></div><div class=\"line\">&lt;body class=&quot;container&quot;&gt;</div><div class=\"line\">\t&lt;main&gt;</div><div class=\"line\">\t\t&lt;div class=&quot;jumbotron&quot;&gt;</div><div class=\"line\">\t\t\t&lt;h2&gt;data from static&lt;/h2&gt;</div><div class=\"line\">\t\t\t&lt;ul&gt;</div><div class=\"line\">\t\t\t\t&lt;% data.forEach(function(d) &#123; %&gt;</div><div class=\"line\">\t\t\t\t&lt;li&gt;</div><div class=\"line\">\t\t\t\t\t&lt;%= d.name %&gt;</div><div class=\"line\">\t\t\t\t\t&lt;span&gt;&lt;%= d.drunkness %&gt;&lt;/span&gt;</div><div class=\"line\">\t\t\t\t&lt;/li&gt;</div><div class=\"line\">\t\t\t    &lt;% &#125;); %&gt;</div><div class=\"line\">\t\t\t&lt;/ul&gt;</div><div class=\"line\">\t\t&lt;/div&gt;</div><div class=\"line\">\t\t&lt;div class=&quot;jumbotron&quot;&gt;</div><div class=\"line\">\t\t\t&lt;h2&gt;data from mysql&lt;/h2&gt;</div><div class=\"line\">\t\t\t&lt;ul&gt;</div><div class=\"line\">\t\t\t\t&lt;% results.forEach(function(result) &#123; %&gt;</div><div class=\"line\">\t\t\t\t&lt;li&gt;</div><div class=\"line\">\t\t\t\t\t&lt;%= result.id %&gt;</div><div class=\"line\">\t\t\t\t\t&lt;span&gt;&lt;%= result.title %&gt;&lt;/span&gt;</div><div class=\"line\">\t\t\t\t\t&lt;span&gt;&lt;%= moment(result.createtime*1000).format(&apos;YYYY-MM-DD, hh:mm:ss&apos;) %&gt;&lt;/span&gt;</div><div class=\"line\">\t\t\t\t&lt;/li&gt;</div><div class=\"line\">\t\t\t    &lt;% &#125;); %&gt;</div><div class=\"line\">\t\t\t&lt;/ul&gt;</div><div class=\"line\">\t\t&lt;/div&gt;</div><div class=\"line\">\t\t</div><div class=\"line\">\t&lt;/main&gt;</div><div class=\"line\"></div><div class=\"line\">\t&lt;footer&gt;</div><div class=\"line\">\t\t&lt;% include ../partials/footer %&gt;</div><div class=\"line\">\t&lt;/footer&gt;</div><div class=\"line\">\t</div><div class=\"line\">&lt;/body&gt;</div><div class=\"line\">&lt;/html&gt;</div></pre></td></tr></table></figure>\n<p>至此，就可以正常输出从数据库里读取出来的数据了。</p>\n<p><strong>小插曲</strong></p>\n<p>之前在练习的时候，require MySQL 之后npm install 只安装了require的几个包，昨天再写的时候装了一大堆。<br>另外之前在使用moment的时候并没有在render页面的时候传入moment，直接就可以用了，昨天也报错了。</p>\n"},{"title":"LeetCode 561.Array Partition I(数组分区 1) - Go实现","date":"2017-08-13T02:14:49.000Z","_content":"\n题目地址:[561. Array Partition I](https://leetcode.com/problems/array-partition-i/description/)\n\n题目描述：\n\nGiven an array of 2n integers, your task is to group these integers into n pairs of integer, say (a1, b1), (a2, b2), ..., (an, bn) which makes sum of min(ai, bi) for all i from 1 to n as large as possible.\n\n###### Example 1:\n\n```\nInput: [1,4,3,2]\n\nOutput: 4\n\nExplanation: n is 2, and the maximum sum of pairs is 4 = min(1, 2) + min(3, 4).\n```\n\n###### Note:\n\n​\tn is a positive integer, which is in the range of [1, 10000].\n​\tAll the integers in the array will be in the range of [-10000, 10000].\n\n\n\n题目大意：\n\n给定一个长度为2n的数组，要把它分成n个分组，即每组有两个数，返回每组中最小值的总和，使和最大。\n\n理解了大意就知道思路了，又看了下论坛里的[算法分析](https://discuss.leetcode.com/topic/87206/java-solution-sorting-and-rough-proof-of-algorithm)\n\n解决方案基本就是先按从小到大排序，这样相邻的数字是最接近的，然后再分成两两一组，取每组中的第一个数相加即可。\n\n```go\npackage main\n\nimport (\n\t\"fmt\"\n\t\"sort\"\n)\n\nfunc main() {\n\tnums := []int{4, 5, 6, 1}\n\tn := arrayPairSum(nums)\n\tfmt.Println(n)\n}\n\nfunc arrayPairSum(nums []int) int {\n\tsort.Ints(nums)\n\tsum := 0\n\tlength := len(nums)\n\tfor i := 0; i < length; i += 2 {\n\t\tsum += nums[i]\n\t}\n\treturn sum\n}\n```\n\n在线查看结果:[The Go Playground](https://play.golang.org/p/2tkZyayXUB)\n\n其实这里主要用到了Go的[sort包给int数组排序](https://golang.org/pkg/sort/#Ints)。排序后遍历数组，每次递增2就可以了。","source":"_posts/leetcode-array-partition-i.md","raw":"title: LeetCode 561.Array Partition I(数组分区 1) - Go实现\ncategories: golang\ndate: 2017-08-13 10:14:49\ntags: [go,leetcode]\n\n---\n\n题目地址:[561. Array Partition I](https://leetcode.com/problems/array-partition-i/description/)\n\n题目描述：\n\nGiven an array of 2n integers, your task is to group these integers into n pairs of integer, say (a1, b1), (a2, b2), ..., (an, bn) which makes sum of min(ai, bi) for all i from 1 to n as large as possible.\n\n###### Example 1:\n\n```\nInput: [1,4,3,2]\n\nOutput: 4\n\nExplanation: n is 2, and the maximum sum of pairs is 4 = min(1, 2) + min(3, 4).\n```\n\n###### Note:\n\n​\tn is a positive integer, which is in the range of [1, 10000].\n​\tAll the integers in the array will be in the range of [-10000, 10000].\n\n\n\n题目大意：\n\n给定一个长度为2n的数组，要把它分成n个分组，即每组有两个数，返回每组中最小值的总和，使和最大。\n\n理解了大意就知道思路了，又看了下论坛里的[算法分析](https://discuss.leetcode.com/topic/87206/java-solution-sorting-and-rough-proof-of-algorithm)\n\n解决方案基本就是先按从小到大排序，这样相邻的数字是最接近的，然后再分成两两一组，取每组中的第一个数相加即可。\n\n```go\npackage main\n\nimport (\n\t\"fmt\"\n\t\"sort\"\n)\n\nfunc main() {\n\tnums := []int{4, 5, 6, 1}\n\tn := arrayPairSum(nums)\n\tfmt.Println(n)\n}\n\nfunc arrayPairSum(nums []int) int {\n\tsort.Ints(nums)\n\tsum := 0\n\tlength := len(nums)\n\tfor i := 0; i < length; i += 2 {\n\t\tsum += nums[i]\n\t}\n\treturn sum\n}\n```\n\n在线查看结果:[The Go Playground](https://play.golang.org/p/2tkZyayXUB)\n\n其实这里主要用到了Go的[sort包给int数组排序](https://golang.org/pkg/sort/#Ints)。排序后遍历数组，每次递增2就可以了。","slug":"leetcode-array-partition-i","published":1,"updated":"2017-08-13T02:54:02.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj830jve6001zul0rquqwbb97","content":"<p>题目地址:<a href=\"https://leetcode.com/problems/array-partition-i/description/\" target=\"_blank\" rel=\"external\">561. Array Partition I</a></p>\n<p>题目描述：</p>\n<p>Given an array of 2n integers, your task is to group these integers into n pairs of integer, say (a1, b1), (a2, b2), …, (an, bn) which makes sum of min(ai, bi) for all i from 1 to n as large as possible.</p>\n<h6 id=\"Example-1\"><a href=\"#Example-1\" class=\"headerlink\" title=\"Example 1:\"></a>Example 1:</h6><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">Input: [1,4,3,2]</div><div class=\"line\"></div><div class=\"line\">Output: 4</div><div class=\"line\"></div><div class=\"line\">Explanation: n is 2, and the maximum sum of pairs is 4 = min(1, 2) + min(3, 4).</div></pre></td></tr></table></figure>\n<h6 id=\"Note\"><a href=\"#Note\" class=\"headerlink\" title=\"Note:\"></a>Note:</h6><p>​    n is a positive integer, which is in the range of [1, 10000].<br>​    All the integers in the array will be in the range of [-10000, 10000].</p>\n<p>题目大意：</p>\n<p>给定一个长度为2n的数组，要把它分成n个分组，即每组有两个数，返回每组中最小值的总和，使和最大。</p>\n<p>理解了大意就知道思路了，又看了下论坛里的<a href=\"https://discuss.leetcode.com/topic/87206/java-solution-sorting-and-rough-proof-of-algorithm\" target=\"_blank\" rel=\"external\">算法分析</a></p>\n<p>解决方案基本就是先按从小到大排序，这样相邻的数字是最接近的，然后再分成两两一组，取每组中的第一个数相加即可。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">package</span> main</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">import</span> (</div><div class=\"line\">\t<span class=\"string\">\"fmt\"</span></div><div class=\"line\">\t<span class=\"string\">\"sort\"</span></div><div class=\"line\">)</div><div class=\"line\"></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</div><div class=\"line\">\tnums := []<span class=\"keyword\">int</span>&#123;<span class=\"number\">4</span>, <span class=\"number\">5</span>, <span class=\"number\">6</span>, <span class=\"number\">1</span>&#125;</div><div class=\"line\">\tn := arrayPairSum(nums)</div><div class=\"line\">\tfmt.Println(n)</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">arrayPairSum</span><span class=\"params\">(nums []<span class=\"keyword\">int</span>)</span> <span class=\"title\">int</span></span> &#123;</div><div class=\"line\">\tsort.Ints(nums)</div><div class=\"line\">\tsum := <span class=\"number\">0</span></div><div class=\"line\">\tlength := <span class=\"built_in\">len</span>(nums)</div><div class=\"line\">\t<span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; length; i += <span class=\"number\">2</span> &#123;</div><div class=\"line\">\t\tsum += nums[i]</div><div class=\"line\">\t&#125;</div><div class=\"line\">\t<span class=\"keyword\">return</span> sum</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>在线查看结果:<a href=\"https://play.golang.org/p/2tkZyayXUB\" target=\"_blank\" rel=\"external\">The Go Playground</a></p>\n<p>其实这里主要用到了Go的<a href=\"https://golang.org/pkg/sort/#Ints\" target=\"_blank\" rel=\"external\">sort包给int数组排序</a>。排序后遍历数组，每次递增2就可以了。</p>\n","site":{"data":{}},"excerpt":"","more":"<p>题目地址:<a href=\"https://leetcode.com/problems/array-partition-i/description/\" target=\"_blank\" rel=\"external\">561. Array Partition I</a></p>\n<p>题目描述：</p>\n<p>Given an array of 2n integers, your task is to group these integers into n pairs of integer, say (a1, b1), (a2, b2), …, (an, bn) which makes sum of min(ai, bi) for all i from 1 to n as large as possible.</p>\n<h6 id=\"Example-1\"><a href=\"#Example-1\" class=\"headerlink\" title=\"Example 1:\"></a>Example 1:</h6><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">Input: [1,4,3,2]</div><div class=\"line\"></div><div class=\"line\">Output: 4</div><div class=\"line\"></div><div class=\"line\">Explanation: n is 2, and the maximum sum of pairs is 4 = min(1, 2) + min(3, 4).</div></pre></td></tr></table></figure>\n<h6 id=\"Note\"><a href=\"#Note\" class=\"headerlink\" title=\"Note:\"></a>Note:</h6><p>​    n is a positive integer, which is in the range of [1, 10000].<br>​    All the integers in the array will be in the range of [-10000, 10000].</p>\n<p>题目大意：</p>\n<p>给定一个长度为2n的数组，要把它分成n个分组，即每组有两个数，返回每组中最小值的总和，使和最大。</p>\n<p>理解了大意就知道思路了，又看了下论坛里的<a href=\"https://discuss.leetcode.com/topic/87206/java-solution-sorting-and-rough-proof-of-algorithm\" target=\"_blank\" rel=\"external\">算法分析</a></p>\n<p>解决方案基本就是先按从小到大排序，这样相邻的数字是最接近的，然后再分成两两一组，取每组中的第一个数相加即可。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">package</span> main</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">import</span> (</div><div class=\"line\">\t<span class=\"string\">\"fmt\"</span></div><div class=\"line\">\t<span class=\"string\">\"sort\"</span></div><div class=\"line\">)</div><div class=\"line\"></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</div><div class=\"line\">\tnums := []<span class=\"keyword\">int</span>&#123;<span class=\"number\">4</span>, <span class=\"number\">5</span>, <span class=\"number\">6</span>, <span class=\"number\">1</span>&#125;</div><div class=\"line\">\tn := arrayPairSum(nums)</div><div class=\"line\">\tfmt.Println(n)</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">arrayPairSum</span><span class=\"params\">(nums []<span class=\"keyword\">int</span>)</span> <span class=\"title\">int</span></span> &#123;</div><div class=\"line\">\tsort.Ints(nums)</div><div class=\"line\">\tsum := <span class=\"number\">0</span></div><div class=\"line\">\tlength := <span class=\"built_in\">len</span>(nums)</div><div class=\"line\">\t<span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; length; i += <span class=\"number\">2</span> &#123;</div><div class=\"line\">\t\tsum += nums[i]</div><div class=\"line\">\t&#125;</div><div class=\"line\">\t<span class=\"keyword\">return</span> sum</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>在线查看结果:<a href=\"https://play.golang.org/p/2tkZyayXUB\" target=\"_blank\" rel=\"external\">The Go Playground</a></p>\n<p>其实这里主要用到了Go的<a href=\"https://golang.org/pkg/sort/#Ints\" target=\"_blank\" rel=\"external\">sort包给int数组排序</a>。排序后遍历数组，每次递增2就可以了。</p>\n"},{"title":"MySQL实现按经纬度做距离排序","date":"2017-06-27T14:18:19.000Z","_content":"\n![](/images/geolocation.png)\n题图来自网络\n\n工作中某些业务需要用到按距离排序返回结果，之前的方式是根据前端传过来来的经纬度，和指定范围的距离，算出一个坐标区间，再用这个区间的值去MySQL中查找，类似“where lat between (lat1, lat2) and lng between (lng1,lng2)”，查出数据后，再遍历数据计算每一条数据到这个经纬度的距离，然后根据得出的距离排序返回。低效，麻烦，不方便分页。\n\n于是决定直接从MySQL中算出距离后返回，省事，方便，还可以直接分页了。\n\n查资料后发现还挺简单的，下方的示例是从[Google官方的文档](https://developers.google.com/maps/articles/phpsqlsearch_v3)中摘取出来。\n\n创建如下数据表：\n\n```mysql\nCREATE TABLE `markers` (\n  `id` INT NOT NULL AUTO_INCREMENT PRIMARY KEY ,\n  `name` VARCHAR( 60 ) NOT NULL ,\n  `address` VARCHAR( 80 ) NOT NULL ,\n  `lat` FLOAT( 10, 6 ) NOT NULL ,\n  `lng` FLOAT( 10, 6 ) NOT NULL\n) ENGINE = MYISAM ;\n```\n\n填充数据：\n\n```mysql\nINSERT INTO `markers` (`name`, `address`, `lat`, `lng`) VALUES ('Frankie Johnnie & Luigo Too','939 W El Camino Real, Mountain View, CA','37.386339','-122.085823');\nINSERT INTO `markers` (`name`, `address`, `lat`, `lng`) VALUES ('Amici\\'s East Coast Pizzeria','790 Castro St, Mountain View, CA','37.38714','-122.083235');\nINSERT INTO `markers` (`name`, `address`, `lat`, `lng`) VALUES ('Kapp\\'s Pizza Bar & Grill','191 Castro St, Mountain View, CA','37.393885','-122.078916');\nINSERT INTO `markers` (`name`, `address`, `lat`, `lng`) VALUES ('Round Table Pizza: Mountain View','570 N Shoreline Blvd, Mountain View, CA','37.402653','-122.079354');\nINSERT INTO `markers` (`name`, `address`, `lat`, `lng`) VALUES ('Tony & Alba\\'s Pizza & Pasta','619 Escuela Ave, Mountain View, CA','37.394011','-122.095528');\nINSERT INTO `markers` (`name`, `address`, `lat`, `lng`) VALUES ('Oregano\\'s Wood-Fired Pizza','4546 El Camino Real, Los Altos, CA','37.401724','-122.114646');\n```\n\n下面，开始从表中查询数据。\n\n根据latitude，longitude值，基于[Haversine公式](http://en.wikipedia.org/wiki/Haversine_formula)从表中查询数据。\n\n假设我们要查询latitude=37.38714,longitude=-122.083235，范围在25英里内的前20条数据，可以这样：\n\n```mysql\nSELECT id, ( 3959 * acos( cos( radians('37.38714') ) * cos( radians( lat ) ) * cos( radians( lng ) - radians('-122.083235') ) + sin( radians('37.38714') ) * sin( radians( lat ) ) ) ) AS distance FROM markers HAVING distance < 25 ORDER BY distance LIMIT 0, 20;\n```\n\n如果想使用“公里”代替“英里”，将3959换成6371即可。\n\n特别简单。\n\n参考资料：\n\n[Creating a Store Locator with PHP, MySQL & Google Maps](https://developers.google.com/maps/articles/phpsqlsearch_v3)\n\n[Geo/Spatial Search with MySQL](https://zh.scribd.com/presentation/2569355/Geo-Distance-Search-with-MySQL)","source":"_posts/order-by-distance-in-mysql.md","raw":"title: MySQL实现按经纬度做距离排序\ncategories: mysql\ndate: 2017-06-27 22:18:19\ntags: [mysql]\n\n---\n\n![](/images/geolocation.png)\n题图来自网络\n\n工作中某些业务需要用到按距离排序返回结果，之前的方式是根据前端传过来来的经纬度，和指定范围的距离，算出一个坐标区间，再用这个区间的值去MySQL中查找，类似“where lat between (lat1, lat2) and lng between (lng1,lng2)”，查出数据后，再遍历数据计算每一条数据到这个经纬度的距离，然后根据得出的距离排序返回。低效，麻烦，不方便分页。\n\n于是决定直接从MySQL中算出距离后返回，省事，方便，还可以直接分页了。\n\n查资料后发现还挺简单的，下方的示例是从[Google官方的文档](https://developers.google.com/maps/articles/phpsqlsearch_v3)中摘取出来。\n\n创建如下数据表：\n\n```mysql\nCREATE TABLE `markers` (\n  `id` INT NOT NULL AUTO_INCREMENT PRIMARY KEY ,\n  `name` VARCHAR( 60 ) NOT NULL ,\n  `address` VARCHAR( 80 ) NOT NULL ,\n  `lat` FLOAT( 10, 6 ) NOT NULL ,\n  `lng` FLOAT( 10, 6 ) NOT NULL\n) ENGINE = MYISAM ;\n```\n\n填充数据：\n\n```mysql\nINSERT INTO `markers` (`name`, `address`, `lat`, `lng`) VALUES ('Frankie Johnnie & Luigo Too','939 W El Camino Real, Mountain View, CA','37.386339','-122.085823');\nINSERT INTO `markers` (`name`, `address`, `lat`, `lng`) VALUES ('Amici\\'s East Coast Pizzeria','790 Castro St, Mountain View, CA','37.38714','-122.083235');\nINSERT INTO `markers` (`name`, `address`, `lat`, `lng`) VALUES ('Kapp\\'s Pizza Bar & Grill','191 Castro St, Mountain View, CA','37.393885','-122.078916');\nINSERT INTO `markers` (`name`, `address`, `lat`, `lng`) VALUES ('Round Table Pizza: Mountain View','570 N Shoreline Blvd, Mountain View, CA','37.402653','-122.079354');\nINSERT INTO `markers` (`name`, `address`, `lat`, `lng`) VALUES ('Tony & Alba\\'s Pizza & Pasta','619 Escuela Ave, Mountain View, CA','37.394011','-122.095528');\nINSERT INTO `markers` (`name`, `address`, `lat`, `lng`) VALUES ('Oregano\\'s Wood-Fired Pizza','4546 El Camino Real, Los Altos, CA','37.401724','-122.114646');\n```\n\n下面，开始从表中查询数据。\n\n根据latitude，longitude值，基于[Haversine公式](http://en.wikipedia.org/wiki/Haversine_formula)从表中查询数据。\n\n假设我们要查询latitude=37.38714,longitude=-122.083235，范围在25英里内的前20条数据，可以这样：\n\n```mysql\nSELECT id, ( 3959 * acos( cos( radians('37.38714') ) * cos( radians( lat ) ) * cos( radians( lng ) - radians('-122.083235') ) + sin( radians('37.38714') ) * sin( radians( lat ) ) ) ) AS distance FROM markers HAVING distance < 25 ORDER BY distance LIMIT 0, 20;\n```\n\n如果想使用“公里”代替“英里”，将3959换成6371即可。\n\n特别简单。\n\n参考资料：\n\n[Creating a Store Locator with PHP, MySQL & Google Maps](https://developers.google.com/maps/articles/phpsqlsearch_v3)\n\n[Geo/Spatial Search with MySQL](https://zh.scribd.com/presentation/2569355/Geo-Distance-Search-with-MySQL)","slug":"order-by-distance-in-mysql","published":1,"updated":"2017-06-27T14:25:53.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj830jve80022ul0rxudilj9i","content":"<p><img src=\"/images/geolocation.png\" alt=\"\"><br>题图来自网络</p>\n<p>工作中某些业务需要用到按距离排序返回结果，之前的方式是根据前端传过来来的经纬度，和指定范围的距离，算出一个坐标区间，再用这个区间的值去MySQL中查找，类似“where lat between (lat1, lat2) and lng between (lng1,lng2)”，查出数据后，再遍历数据计算每一条数据到这个经纬度的距离，然后根据得出的距离排序返回。低效，麻烦，不方便分页。</p>\n<p>于是决定直接从MySQL中算出距离后返回，省事，方便，还可以直接分页了。</p>\n<p>查资料后发现还挺简单的，下方的示例是从<a href=\"https://developers.google.com/maps/articles/phpsqlsearch_v3\" target=\"_blank\" rel=\"external\">Google官方的文档</a>中摘取出来。</p>\n<p>创建如下数据表：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">CREATE TABLE `markers` (</div><div class=\"line\">  `id` INT NOT NULL AUTO_INCREMENT PRIMARY KEY ,</div><div class=\"line\">  `name` VARCHAR( 60 ) NOT NULL ,</div><div class=\"line\">  `address` VARCHAR( 80 ) NOT NULL ,</div><div class=\"line\">  `lat` FLOAT( 10, 6 ) NOT NULL ,</div><div class=\"line\">  `lng` FLOAT( 10, 6 ) NOT NULL</div><div class=\"line\">) ENGINE = MYISAM ;</div></pre></td></tr></table></figure>\n<p>填充数据：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">INSERT INTO `markers` (`name`, `address`, `lat`, `lng`) VALUES (&apos;Frankie Johnnie &amp; Luigo Too&apos;,&apos;939 W El Camino Real, Mountain View, CA&apos;,&apos;37.386339&apos;,&apos;-122.085823&apos;);</div><div class=\"line\">INSERT INTO `markers` (`name`, `address`, `lat`, `lng`) VALUES (&apos;Amici\\&apos;s East Coast Pizzeria&apos;,&apos;790 Castro St, Mountain View, CA&apos;,&apos;37.38714&apos;,&apos;-122.083235&apos;);</div><div class=\"line\">INSERT INTO `markers` (`name`, `address`, `lat`, `lng`) VALUES (&apos;Kapp\\&apos;s Pizza Bar &amp; Grill&apos;,&apos;191 Castro St, Mountain View, CA&apos;,&apos;37.393885&apos;,&apos;-122.078916&apos;);</div><div class=\"line\">INSERT INTO `markers` (`name`, `address`, `lat`, `lng`) VALUES (&apos;Round Table Pizza: Mountain View&apos;,&apos;570 N Shoreline Blvd, Mountain View, CA&apos;,&apos;37.402653&apos;,&apos;-122.079354&apos;);</div><div class=\"line\">INSERT INTO `markers` (`name`, `address`, `lat`, `lng`) VALUES (&apos;Tony &amp; Alba\\&apos;s Pizza &amp; Pasta&apos;,&apos;619 Escuela Ave, Mountain View, CA&apos;,&apos;37.394011&apos;,&apos;-122.095528&apos;);</div><div class=\"line\">INSERT INTO `markers` (`name`, `address`, `lat`, `lng`) VALUES (&apos;Oregano\\&apos;s Wood-Fired Pizza&apos;,&apos;4546 El Camino Real, Los Altos, CA&apos;,&apos;37.401724&apos;,&apos;-122.114646&apos;);</div></pre></td></tr></table></figure>\n<p>下面，开始从表中查询数据。</p>\n<p>根据latitude，longitude值，基于<a href=\"http://en.wikipedia.org/wiki/Haversine_formula\" target=\"_blank\" rel=\"external\">Haversine公式</a>从表中查询数据。</p>\n<p>假设我们要查询latitude=37.38714,longitude=-122.083235，范围在25英里内的前20条数据，可以这样：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">SELECT id, ( 3959 * acos( cos( radians(&apos;37.38714&apos;) ) * cos( radians( lat ) ) * cos( radians( lng ) - radians(&apos;-122.083235&apos;) ) + sin( radians(&apos;37.38714&apos;) ) * sin( radians( lat ) ) ) ) AS distance FROM markers HAVING distance &lt; 25 ORDER BY distance LIMIT 0, 20;</div></pre></td></tr></table></figure>\n<p>如果想使用“公里”代替“英里”，将3959换成6371即可。</p>\n<p>特别简单。</p>\n<p>参考资料：</p>\n<p><a href=\"https://developers.google.com/maps/articles/phpsqlsearch_v3\" target=\"_blank\" rel=\"external\">Creating a Store Locator with PHP, MySQL &amp; Google Maps</a></p>\n<p><a href=\"https://zh.scribd.com/presentation/2569355/Geo-Distance-Search-with-MySQL\" target=\"_blank\" rel=\"external\">Geo/Spatial Search with MySQL</a></p>\n","site":{"data":{}},"excerpt":"","more":"<p><img src=\"/images/geolocation.png\" alt=\"\"><br>题图来自网络</p>\n<p>工作中某些业务需要用到按距离排序返回结果，之前的方式是根据前端传过来来的经纬度，和指定范围的距离，算出一个坐标区间，再用这个区间的值去MySQL中查找，类似“where lat between (lat1, lat2) and lng between (lng1,lng2)”，查出数据后，再遍历数据计算每一条数据到这个经纬度的距离，然后根据得出的距离排序返回。低效，麻烦，不方便分页。</p>\n<p>于是决定直接从MySQL中算出距离后返回，省事，方便，还可以直接分页了。</p>\n<p>查资料后发现还挺简单的，下方的示例是从<a href=\"https://developers.google.com/maps/articles/phpsqlsearch_v3\" target=\"_blank\" rel=\"external\">Google官方的文档</a>中摘取出来。</p>\n<p>创建如下数据表：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">CREATE TABLE `markers` (</div><div class=\"line\">  `id` INT NOT NULL AUTO_INCREMENT PRIMARY KEY ,</div><div class=\"line\">  `name` VARCHAR( 60 ) NOT NULL ,</div><div class=\"line\">  `address` VARCHAR( 80 ) NOT NULL ,</div><div class=\"line\">  `lat` FLOAT( 10, 6 ) NOT NULL ,</div><div class=\"line\">  `lng` FLOAT( 10, 6 ) NOT NULL</div><div class=\"line\">) ENGINE = MYISAM ;</div></pre></td></tr></table></figure>\n<p>填充数据：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">INSERT INTO `markers` (`name`, `address`, `lat`, `lng`) VALUES (&apos;Frankie Johnnie &amp; Luigo Too&apos;,&apos;939 W El Camino Real, Mountain View, CA&apos;,&apos;37.386339&apos;,&apos;-122.085823&apos;);</div><div class=\"line\">INSERT INTO `markers` (`name`, `address`, `lat`, `lng`) VALUES (&apos;Amici\\&apos;s East Coast Pizzeria&apos;,&apos;790 Castro St, Mountain View, CA&apos;,&apos;37.38714&apos;,&apos;-122.083235&apos;);</div><div class=\"line\">INSERT INTO `markers` (`name`, `address`, `lat`, `lng`) VALUES (&apos;Kapp\\&apos;s Pizza Bar &amp; Grill&apos;,&apos;191 Castro St, Mountain View, CA&apos;,&apos;37.393885&apos;,&apos;-122.078916&apos;);</div><div class=\"line\">INSERT INTO `markers` (`name`, `address`, `lat`, `lng`) VALUES (&apos;Round Table Pizza: Mountain View&apos;,&apos;570 N Shoreline Blvd, Mountain View, CA&apos;,&apos;37.402653&apos;,&apos;-122.079354&apos;);</div><div class=\"line\">INSERT INTO `markers` (`name`, `address`, `lat`, `lng`) VALUES (&apos;Tony &amp; Alba\\&apos;s Pizza &amp; Pasta&apos;,&apos;619 Escuela Ave, Mountain View, CA&apos;,&apos;37.394011&apos;,&apos;-122.095528&apos;);</div><div class=\"line\">INSERT INTO `markers` (`name`, `address`, `lat`, `lng`) VALUES (&apos;Oregano\\&apos;s Wood-Fired Pizza&apos;,&apos;4546 El Camino Real, Los Altos, CA&apos;,&apos;37.401724&apos;,&apos;-122.114646&apos;);</div></pre></td></tr></table></figure>\n<p>下面，开始从表中查询数据。</p>\n<p>根据latitude，longitude值，基于<a href=\"http://en.wikipedia.org/wiki/Haversine_formula\" target=\"_blank\" rel=\"external\">Haversine公式</a>从表中查询数据。</p>\n<p>假设我们要查询latitude=37.38714,longitude=-122.083235，范围在25英里内的前20条数据，可以这样：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">SELECT id, ( 3959 * acos( cos( radians(&apos;37.38714&apos;) ) * cos( radians( lat ) ) * cos( radians( lng ) - radians(&apos;-122.083235&apos;) ) + sin( radians(&apos;37.38714&apos;) ) * sin( radians( lat ) ) ) ) AS distance FROM markers HAVING distance &lt; 25 ORDER BY distance LIMIT 0, 20;</div></pre></td></tr></table></figure>\n<p>如果想使用“公里”代替“英里”，将3959换成6371即可。</p>\n<p>特别简单。</p>\n<p>参考资料：</p>\n<p><a href=\"https://developers.google.com/maps/articles/phpsqlsearch_v3\" target=\"_blank\" rel=\"external\">Creating a Store Locator with PHP, MySQL &amp; Google Maps</a></p>\n<p><a href=\"https://zh.scribd.com/presentation/2569355/Geo-Distance-Search-with-MySQL\" target=\"_blank\" rel=\"external\">Geo/Spatial Search with MySQL</a></p>\n"},{"title":"PHP Curl 上传文件","date":"2016-07-02T15:11:30.000Z","_content":"\n有时候会遇到上传文件给第三方服务的情况，比如本身程序并不需要存储附件，而是把附件发送给一个公共的服务。\n\n最近正好碰到这个问题，记录一下。\n\n上代码。\n\n#### 发送端：\n\n```php\n<?php\n\n// 接口地址\n$api = 'http://api.example.com/uploadfile';\n$file = $_FILES['file'];//保存$_FILES到变量中。\n\n// 此处可能存在上传失败等问题，需验证$_FILES[\"file\"][\"error\"]。\n// 做业务对应的规则验证，如文件格式，文件大小等。\n\n// 创建一个 cURL 句柄\n$ch = curl_init($api);\n\n// 创建一个 CURLFile 对象\n// 上传文件的路径，文件的Mimetype，文件名\n$cfile = curl_file_create($file['tmp_name'],$file['type'],$file['name']);\n\n$data = [\n\t'type'=>'image',\n\t'data'=>$cfile\n];\n\n// 设置 POST 数据\ncurl_setopt($ch, CURLOPT_POST,1);\ncurl_setopt($ch, CURLOPT_POSTFIELDS, $data);\n\n$resp = curl_exec($ch);\n\nif(!$resp) {\n  die('Error: \"' . curl_error($ch) . '\" - Code: ' . curl_errno($ch));\n} else {\n  echo \"Response HTTP Status Code : \" . curl_getinfo($ch, CURLINFO_HTTP_CODE);\n  echo \"\\nResponse HTTP Body : \" . $resp;\n}\n\n// Close request to clear up some resources\ncurl_close($ch);\n```\n\n#### 接收端：\n\n```php\n<?php \nvar_dump($_FILES);// 接收文件内容\nva_dump($_POST);// 接收type\n```\n\n#### 前端：\n\n前端可使用Form或其他Ajax方式上传。","source":"_posts/php-post-file-with-curl.md","raw":"title: PHP Curl 上传文件\ncategories: php\ndate: 2016-07-02 23:11:30\ntags:  [php]\n\n---\n\n有时候会遇到上传文件给第三方服务的情况，比如本身程序并不需要存储附件，而是把附件发送给一个公共的服务。\n\n最近正好碰到这个问题，记录一下。\n\n上代码。\n\n#### 发送端：\n\n```php\n<?php\n\n// 接口地址\n$api = 'http://api.example.com/uploadfile';\n$file = $_FILES['file'];//保存$_FILES到变量中。\n\n// 此处可能存在上传失败等问题，需验证$_FILES[\"file\"][\"error\"]。\n// 做业务对应的规则验证，如文件格式，文件大小等。\n\n// 创建一个 cURL 句柄\n$ch = curl_init($api);\n\n// 创建一个 CURLFile 对象\n// 上传文件的路径，文件的Mimetype，文件名\n$cfile = curl_file_create($file['tmp_name'],$file['type'],$file['name']);\n\n$data = [\n\t'type'=>'image',\n\t'data'=>$cfile\n];\n\n// 设置 POST 数据\ncurl_setopt($ch, CURLOPT_POST,1);\ncurl_setopt($ch, CURLOPT_POSTFIELDS, $data);\n\n$resp = curl_exec($ch);\n\nif(!$resp) {\n  die('Error: \"' . curl_error($ch) . '\" - Code: ' . curl_errno($ch));\n} else {\n  echo \"Response HTTP Status Code : \" . curl_getinfo($ch, CURLINFO_HTTP_CODE);\n  echo \"\\nResponse HTTP Body : \" . $resp;\n}\n\n// Close request to clear up some resources\ncurl_close($ch);\n```\n\n#### 接收端：\n\n```php\n<?php \nvar_dump($_FILES);// 接收文件内容\nva_dump($_POST);// 接收type\n```\n\n#### 前端：\n\n前端可使用Form或其他Ajax方式上传。","slug":"php-post-file-with-curl","published":1,"updated":"2016-07-03T01:14:00.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj830jve90024ul0rvtgsntxa","content":"<p>有时候会遇到上传文件给第三方服务的情况，比如本身程序并不需要存储附件，而是把附件发送给一个公共的服务。</p>\n<p>最近正好碰到这个问题，记录一下。</p>\n<p>上代码。</p>\n<h4 id=\"发送端：\"><a href=\"#发送端：\" class=\"headerlink\" title=\"发送端：\"></a>发送端：</h4><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">// 接口地址</span></div><div class=\"line\">$api = <span class=\"string\">'http://api.example.com/uploadfile'</span>;</div><div class=\"line\">$file = $_FILES[<span class=\"string\">'file'</span>];<span class=\"comment\">//保存$_FILES到变量中。</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">// 此处可能存在上传失败等问题，需验证$_FILES[\"file\"][\"error\"]。</span></div><div class=\"line\"><span class=\"comment\">// 做业务对应的规则验证，如文件格式，文件大小等。</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">// 创建一个 cURL 句柄</span></div><div class=\"line\">$ch = curl_init($api);</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">// 创建一个 CURLFile 对象</span></div><div class=\"line\"><span class=\"comment\">// 上传文件的路径，文件的Mimetype，文件名</span></div><div class=\"line\">$cfile = curl_file_create($file[<span class=\"string\">'tmp_name'</span>],$file[<span class=\"string\">'type'</span>],$file[<span class=\"string\">'name'</span>]);</div><div class=\"line\"></div><div class=\"line\">$data = [</div><div class=\"line\">\t<span class=\"string\">'type'</span>=&gt;<span class=\"string\">'image'</span>,</div><div class=\"line\">\t<span class=\"string\">'data'</span>=&gt;$cfile</div><div class=\"line\">];</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">// 设置 POST 数据</span></div><div class=\"line\">curl_setopt($ch, CURLOPT_POST,<span class=\"number\">1</span>);</div><div class=\"line\">curl_setopt($ch, CURLOPT_POSTFIELDS, $data);</div><div class=\"line\"></div><div class=\"line\">$resp = curl_exec($ch);</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">if</span>(!$resp) &#123;</div><div class=\"line\">  <span class=\"keyword\">die</span>(<span class=\"string\">'Error: \"'</span> . curl_error($ch) . <span class=\"string\">'\" - Code: '</span> . curl_errno($ch));</div><div class=\"line\">&#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">  <span class=\"keyword\">echo</span> <span class=\"string\">\"Response HTTP Status Code : \"</span> . curl_getinfo($ch, CURLINFO_HTTP_CODE);</div><div class=\"line\">  <span class=\"keyword\">echo</span> <span class=\"string\">\"\\nResponse HTTP Body : \"</span> . $resp;</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">// Close request to clear up some resources</span></div><div class=\"line\">curl_close($ch);</div></pre></td></tr></table></figure>\n<h4 id=\"接收端：\"><a href=\"#接收端：\" class=\"headerlink\" title=\"接收端：\"></a>接收端：</h4><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span> </div><div class=\"line\">var_dump($_FILES);<span class=\"comment\">// 接收文件内容</span></div><div class=\"line\">va_dump($_POST);<span class=\"comment\">// 接收type</span></div></pre></td></tr></table></figure>\n<h4 id=\"前端：\"><a href=\"#前端：\" class=\"headerlink\" title=\"前端：\"></a>前端：</h4><p>前端可使用Form或其他Ajax方式上传。</p>\n","site":{"data":{}},"excerpt":"","more":"<p>有时候会遇到上传文件给第三方服务的情况，比如本身程序并不需要存储附件，而是把附件发送给一个公共的服务。</p>\n<p>最近正好碰到这个问题，记录一下。</p>\n<p>上代码。</p>\n<h4 id=\"发送端：\"><a href=\"#发送端：\" class=\"headerlink\" title=\"发送端：\"></a>发送端：</h4><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">// 接口地址</span></div><div class=\"line\">$api = <span class=\"string\">'http://api.example.com/uploadfile'</span>;</div><div class=\"line\">$file = $_FILES[<span class=\"string\">'file'</span>];<span class=\"comment\">//保存$_FILES到变量中。</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">// 此处可能存在上传失败等问题，需验证$_FILES[\"file\"][\"error\"]。</span></div><div class=\"line\"><span class=\"comment\">// 做业务对应的规则验证，如文件格式，文件大小等。</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">// 创建一个 cURL 句柄</span></div><div class=\"line\">$ch = curl_init($api);</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">// 创建一个 CURLFile 对象</span></div><div class=\"line\"><span class=\"comment\">// 上传文件的路径，文件的Mimetype，文件名</span></div><div class=\"line\">$cfile = curl_file_create($file[<span class=\"string\">'tmp_name'</span>],$file[<span class=\"string\">'type'</span>],$file[<span class=\"string\">'name'</span>]);</div><div class=\"line\"></div><div class=\"line\">$data = [</div><div class=\"line\">\t<span class=\"string\">'type'</span>=&gt;<span class=\"string\">'image'</span>,</div><div class=\"line\">\t<span class=\"string\">'data'</span>=&gt;$cfile</div><div class=\"line\">];</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">// 设置 POST 数据</span></div><div class=\"line\">curl_setopt($ch, CURLOPT_POST,<span class=\"number\">1</span>);</div><div class=\"line\">curl_setopt($ch, CURLOPT_POSTFIELDS, $data);</div><div class=\"line\"></div><div class=\"line\">$resp = curl_exec($ch);</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">if</span>(!$resp) &#123;</div><div class=\"line\">  <span class=\"keyword\">die</span>(<span class=\"string\">'Error: \"'</span> . curl_error($ch) . <span class=\"string\">'\" - Code: '</span> . curl_errno($ch));</div><div class=\"line\">&#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">  <span class=\"keyword\">echo</span> <span class=\"string\">\"Response HTTP Status Code : \"</span> . curl_getinfo($ch, CURLINFO_HTTP_CODE);</div><div class=\"line\">  <span class=\"keyword\">echo</span> <span class=\"string\">\"\\nResponse HTTP Body : \"</span> . $resp;</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">// Close request to clear up some resources</span></div><div class=\"line\">curl_close($ch);</div></pre></td></tr></table></figure>\n<h4 id=\"接收端：\"><a href=\"#接收端：\" class=\"headerlink\" title=\"接收端：\"></a>接收端：</h4><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span> </div><div class=\"line\">var_dump($_FILES);<span class=\"comment\">// 接收文件内容</span></div><div class=\"line\">va_dump($_POST);<span class=\"comment\">// 接收type</span></div></pre></td></tr></table></figure>\n<h4 id=\"前端：\"><a href=\"#前端：\" class=\"headerlink\" title=\"前端：\"></a>前端：</h4><p>前端可使用Form或其他Ajax方式上传。</p>\n"},{"title":"PHP RabbitMQ 教程（五） - 主题","date":"2016-04-27T10:27:03.000Z","_content":"\n### 主题\n\n([使用php-amqplib](https://github.com/php-amqplib/php-amqplib))\n\n在[上一节](/2016/04/24/php-rabbitmq-tutorial-four.html)我们改善了日志系统(logging system，以下简称日志系统)，为了替代fanout类型的交换器，我们使用了一个direct类型的交换器，带来的好处是可以有选择的接收日志。\n\n虽然使用direct交换器改善了系统，但是仍然有局限性 - 它不能根据多个条件进行路由。\n\n在日志系统中，我们也许不仅仅想订阅严重等级的日志，也想订阅基于消息发布源的内容。也许你已经知道这个概念来自于UNIX的[syslog](http://en.wikipedia.org/wiki/Syslog)工具，基于严重性(info/warn/crit...)和设备路由日志(auth/cron/kern...)的工具。\n\n这可以提高灵活性 - 我们也许只想要监听来自'cron'的关键错误而不是来自'kern'的全部日志。\n\n为了在我们的日志系统上实现这个功能，需要学习一个更复杂的 topic 交换器。\n\n### Topic 交换器\n\n发送到 topic 交换器的消息不能随意设置 routing_key - 它必须是一个单词列表，以'.'分隔。单词可以是任何内容，但是通常会具体说明消息的功能。一些有效的routing key示例：样：\"stock.usd.nyse\"，\"nyse.vmw\"，\"quick.orange.rabbit\"。routing key 可以是任何长度的你喜欢的单词，最大255个字节。\n\nbinding key 也必须是同样的格式，topic交换器的逻辑和direct交换器类似 - 带有特定routing key的消息会被派发到所有绑定了binding key的队列，然而对于binding key依然有两个重要的特殊情况：\n\n\t*可以代替一个单词\n\n\t#可以代替0个或多个单词\n\n下图比较好的解释了这个情况：\n\n![](/images/rabbitmq/python-five.png)\t\n\n在这个例子中，我们准备全部发送描述动物的消息。这些消息带有由三个单词(两个点号分隔)组成的routing key，其中第一个单词表示速度，第二个表示颜色，第三个表示种类：\"<speed>.<colour>.<species>\"。\n\n我们创建三个绑定：Q1的binding key为\"\\*.orange\"，Q2的binding key为\"\\*.\\*.rabbit\"和\"lazy.\\#\"。\n\n这些绑定可以概括为：\n\n\tQ1 关注所有orange的动物\n\t\n\tQ2 想知道所有关于兔子（rabbits）和懒惰动物（lazy animals）的消息。\n\nrouting key为\"quick.orange.rabbit\"的消息会被发送到两个队列，\"lazy.orange.elephant\"也会被发送到这两个队列。而\"quick.orange.fox\"则只会发送到第一个队列，\"lazy.brown.fox\"会被只发送到第二个队列。\"lazy.pink.rabbit\"会只被发送到第二个队列一次，即使它匹配两个绑定。\"quick.brown.fox\"不匹配任何绑定，所以会被丢弃。\n\n如果打破规则，发送一条带有一个或四个单词，如\"orange\"或\"quick.orange.male.rabbit\"会怎么样？好吧，消息会丢失，因为它不匹配任何一个绑定。\n\n但是，\"lazy.orange.male.rabbit\"这种消息，即使它有4个单词，依然会匹配最后一个绑定，然后被发送到第二个队列。\n\n#### topic 交换器\n\n```\ntopic 交换器非常强大，可以表现得跟其他交换器一样。\n\n当一个队列的binding key为\"#\"时，它会接收所有消息，忽略routing key，像fanout交换器一样。\n\n当绑定中不存在\"*\"和\"#\"时，topic交换器会表现的跟direct交换器一样。\n\n```\n\n### 整合\n\n我们准备在日志系统中使用topic交换器。假定日志的routing key由两个单词：\"<facility>.<severity>\"组成。\n\n代码与上一节的几乎一致。\n\nemit_log_topic.php：\n\n```php\n<?php\n\nrequire_once __DIR__ . '/vendor/autoload.php';\nuse PhpAmqpLib\\Connection\\AMQPStreamConnection;\nuse PhpAmqpLib\\Message\\AMQPMessage;\n\n$connection = new AMQPStreamConnection('localhost', 5672, 'guest', 'guest');\n$channel = $connection->channel();\n\n$channel->exchange_declare('topic_logs', 'topic', false, false, false);\n\n$routing_key = isset($argv[1]) && !empty($argv[1]) ? $argv[1] : 'anonymous.info';\n$data = implode(' ', array_slice($agrv, 2));\nif(empty($data)) $data = \"Hello Wrold!\";\n\n$msg = new AMQPMessage($data);\n\n$channel->basic_publish($msg, 'topic_logs', $routing_key);\n\necho \" [x] Sent \",$routing_key,':',$data,\" \\n\";\n\n$channel->close();\n$connection->close();\n\n?>\n```\n\nreceive_logs_topic.php：\n\n```php\n<?php\n\nrequire_once __DIR__ . '/vendor/autoload.php';\nuse PhpAmqpLib\\Connection\\AMQPStreamConnection;\n\n$connection = new AMQPStreamConnection('localhost', 5672, 'guest', 'guest');\n$channel = $connection->channel();\n\n$channel->exchange_declare('topic_logs', 'topic', false, false, false);\n\nlist($queue_name, ,) = $channel->queue_declare(\"\", false, false, true, false);\n\n$binding_keys = array_slice($argv, 1);\nif( empty($binding_keys) ){\n  file_put_contents('php://stderr', \"Usage: $argv[0] [binding_key]\\n\");\n  exit(1);\n}\n\nforeach($binding_keys as $binding_key){\n  $channel->queue_bind($queue_name, 'topic_logs', $binding_key);\n}\n\necho ' [*] Waiting for logs. To exit press CTRL+C', \"\\n\";\n\n$callback = function($msg){\n  echo ' [*] ',$msg->delivery_info['routing_key'], ':', $msg->body, \"\\n\";\n}\n\n$channel->basic_consume($queue_name, '', false, true, false, false, $callback);\n\nwhile(count($channel->callbacks)){\n  $channel->wait();\n}\n\n$channel->close();\n$connection->close();\n\n?>\n```\n\n接收所有日志：\n\n```\nphp receive_logs_topic.php '#'\n```\n\n接收所有来自\"kern\"的日志：\n\n```\nphp receive_logs_topic.php \"kern.*\"\n```\n\n只接收\"致命(critical)\"日志：\n\n```shell\nphp receive_logs_topic.php \"*.critical\"\n```\n\n创建多个绑定：\n\n```shell\nphp receive_logs_topic.php \"kern.*\" \"*.critical\"\n```\n\n发布routing key为\"kern.critical\"的日志就输入：\n\n```shell\nphp emit_log_topic.php \"kern.critical\" \"A critical kernel error\"\n```\n\n注意此代码并没有做路由或捆绑的例子，也许你想试一下两个以上的routing key参数。\n\n一些问题：\n\n​\t[\"*\"会匹配routing key为空的消息吗？](http://www.rabbitmq.com/tutorials/tutorial-five-php.html#teaser_answer_1)\n\n​\t[\"#.*\"会匹配内容为\"..\"的消息吗？会匹配一个单词的消息吗？](http://www.rabbitmq.com/tutorials/tutorial-five-php.html#teaser_answer_2)\n\n​\t[\"a.*.#\"和\"a.#\"的区别是什么？](http://www.rabbitmq.com/tutorials/tutorial-five-php.html#teaser_answer_3)\n\n[emit_log_topic.php完整代码](https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/php/emit_log_topic.php) [receive_logs_topic.php完整代码](https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/php/receive_logs_topic.php)\n\n下一步，在第六节中学习像远程过程调用一样完成消息往返。\n\n原文地址：[Topics](https://www.rabbitmq.com/tutorials/tutorial-five-php.html)","source":"_posts/php-rabbitmq-tutorial-five.md","raw":"title: PHP RabbitMQ 教程（五） - 主题\ncategories: php\ndate: 2016-04-27 18:27:03\ntags:  [php,rabbitmq]\n\n---\n\n### 主题\n\n([使用php-amqplib](https://github.com/php-amqplib/php-amqplib))\n\n在[上一节](/2016/04/24/php-rabbitmq-tutorial-four.html)我们改善了日志系统(logging system，以下简称日志系统)，为了替代fanout类型的交换器，我们使用了一个direct类型的交换器，带来的好处是可以有选择的接收日志。\n\n虽然使用direct交换器改善了系统，但是仍然有局限性 - 它不能根据多个条件进行路由。\n\n在日志系统中，我们也许不仅仅想订阅严重等级的日志，也想订阅基于消息发布源的内容。也许你已经知道这个概念来自于UNIX的[syslog](http://en.wikipedia.org/wiki/Syslog)工具，基于严重性(info/warn/crit...)和设备路由日志(auth/cron/kern...)的工具。\n\n这可以提高灵活性 - 我们也许只想要监听来自'cron'的关键错误而不是来自'kern'的全部日志。\n\n为了在我们的日志系统上实现这个功能，需要学习一个更复杂的 topic 交换器。\n\n### Topic 交换器\n\n发送到 topic 交换器的消息不能随意设置 routing_key - 它必须是一个单词列表，以'.'分隔。单词可以是任何内容，但是通常会具体说明消息的功能。一些有效的routing key示例：样：\"stock.usd.nyse\"，\"nyse.vmw\"，\"quick.orange.rabbit\"。routing key 可以是任何长度的你喜欢的单词，最大255个字节。\n\nbinding key 也必须是同样的格式，topic交换器的逻辑和direct交换器类似 - 带有特定routing key的消息会被派发到所有绑定了binding key的队列，然而对于binding key依然有两个重要的特殊情况：\n\n\t*可以代替一个单词\n\n\t#可以代替0个或多个单词\n\n下图比较好的解释了这个情况：\n\n![](/images/rabbitmq/python-five.png)\t\n\n在这个例子中，我们准备全部发送描述动物的消息。这些消息带有由三个单词(两个点号分隔)组成的routing key，其中第一个单词表示速度，第二个表示颜色，第三个表示种类：\"<speed>.<colour>.<species>\"。\n\n我们创建三个绑定：Q1的binding key为\"\\*.orange\"，Q2的binding key为\"\\*.\\*.rabbit\"和\"lazy.\\#\"。\n\n这些绑定可以概括为：\n\n\tQ1 关注所有orange的动物\n\t\n\tQ2 想知道所有关于兔子（rabbits）和懒惰动物（lazy animals）的消息。\n\nrouting key为\"quick.orange.rabbit\"的消息会被发送到两个队列，\"lazy.orange.elephant\"也会被发送到这两个队列。而\"quick.orange.fox\"则只会发送到第一个队列，\"lazy.brown.fox\"会被只发送到第二个队列。\"lazy.pink.rabbit\"会只被发送到第二个队列一次，即使它匹配两个绑定。\"quick.brown.fox\"不匹配任何绑定，所以会被丢弃。\n\n如果打破规则，发送一条带有一个或四个单词，如\"orange\"或\"quick.orange.male.rabbit\"会怎么样？好吧，消息会丢失，因为它不匹配任何一个绑定。\n\n但是，\"lazy.orange.male.rabbit\"这种消息，即使它有4个单词，依然会匹配最后一个绑定，然后被发送到第二个队列。\n\n#### topic 交换器\n\n```\ntopic 交换器非常强大，可以表现得跟其他交换器一样。\n\n当一个队列的binding key为\"#\"时，它会接收所有消息，忽略routing key，像fanout交换器一样。\n\n当绑定中不存在\"*\"和\"#\"时，topic交换器会表现的跟direct交换器一样。\n\n```\n\n### 整合\n\n我们准备在日志系统中使用topic交换器。假定日志的routing key由两个单词：\"<facility>.<severity>\"组成。\n\n代码与上一节的几乎一致。\n\nemit_log_topic.php：\n\n```php\n<?php\n\nrequire_once __DIR__ . '/vendor/autoload.php';\nuse PhpAmqpLib\\Connection\\AMQPStreamConnection;\nuse PhpAmqpLib\\Message\\AMQPMessage;\n\n$connection = new AMQPStreamConnection('localhost', 5672, 'guest', 'guest');\n$channel = $connection->channel();\n\n$channel->exchange_declare('topic_logs', 'topic', false, false, false);\n\n$routing_key = isset($argv[1]) && !empty($argv[1]) ? $argv[1] : 'anonymous.info';\n$data = implode(' ', array_slice($agrv, 2));\nif(empty($data)) $data = \"Hello Wrold!\";\n\n$msg = new AMQPMessage($data);\n\n$channel->basic_publish($msg, 'topic_logs', $routing_key);\n\necho \" [x] Sent \",$routing_key,':',$data,\" \\n\";\n\n$channel->close();\n$connection->close();\n\n?>\n```\n\nreceive_logs_topic.php：\n\n```php\n<?php\n\nrequire_once __DIR__ . '/vendor/autoload.php';\nuse PhpAmqpLib\\Connection\\AMQPStreamConnection;\n\n$connection = new AMQPStreamConnection('localhost', 5672, 'guest', 'guest');\n$channel = $connection->channel();\n\n$channel->exchange_declare('topic_logs', 'topic', false, false, false);\n\nlist($queue_name, ,) = $channel->queue_declare(\"\", false, false, true, false);\n\n$binding_keys = array_slice($argv, 1);\nif( empty($binding_keys) ){\n  file_put_contents('php://stderr', \"Usage: $argv[0] [binding_key]\\n\");\n  exit(1);\n}\n\nforeach($binding_keys as $binding_key){\n  $channel->queue_bind($queue_name, 'topic_logs', $binding_key);\n}\n\necho ' [*] Waiting for logs. To exit press CTRL+C', \"\\n\";\n\n$callback = function($msg){\n  echo ' [*] ',$msg->delivery_info['routing_key'], ':', $msg->body, \"\\n\";\n}\n\n$channel->basic_consume($queue_name, '', false, true, false, false, $callback);\n\nwhile(count($channel->callbacks)){\n  $channel->wait();\n}\n\n$channel->close();\n$connection->close();\n\n?>\n```\n\n接收所有日志：\n\n```\nphp receive_logs_topic.php '#'\n```\n\n接收所有来自\"kern\"的日志：\n\n```\nphp receive_logs_topic.php \"kern.*\"\n```\n\n只接收\"致命(critical)\"日志：\n\n```shell\nphp receive_logs_topic.php \"*.critical\"\n```\n\n创建多个绑定：\n\n```shell\nphp receive_logs_topic.php \"kern.*\" \"*.critical\"\n```\n\n发布routing key为\"kern.critical\"的日志就输入：\n\n```shell\nphp emit_log_topic.php \"kern.critical\" \"A critical kernel error\"\n```\n\n注意此代码并没有做路由或捆绑的例子，也许你想试一下两个以上的routing key参数。\n\n一些问题：\n\n​\t[\"*\"会匹配routing key为空的消息吗？](http://www.rabbitmq.com/tutorials/tutorial-five-php.html#teaser_answer_1)\n\n​\t[\"#.*\"会匹配内容为\"..\"的消息吗？会匹配一个单词的消息吗？](http://www.rabbitmq.com/tutorials/tutorial-five-php.html#teaser_answer_2)\n\n​\t[\"a.*.#\"和\"a.#\"的区别是什么？](http://www.rabbitmq.com/tutorials/tutorial-five-php.html#teaser_answer_3)\n\n[emit_log_topic.php完整代码](https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/php/emit_log_topic.php) [receive_logs_topic.php完整代码](https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/php/receive_logs_topic.php)\n\n下一步，在第六节中学习像远程过程调用一样完成消息往返。\n\n原文地址：[Topics](https://www.rabbitmq.com/tutorials/tutorial-five-php.html)","slug":"php-rabbitmq-tutorial-five","published":1,"updated":"2016-05-07T14:06:15.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj830jveb0028ul0r4jhajrqw","content":"<h3 id=\"主题\"><a href=\"#主题\" class=\"headerlink\" title=\"主题\"></a>主题</h3><p>(<a href=\"https://github.com/php-amqplib/php-amqplib\" target=\"_blank\" rel=\"external\">使用php-amqplib</a>)</p>\n<p>在<a href=\"/2016/04/24/php-rabbitmq-tutorial-four.html\">上一节</a>我们改善了日志系统(logging system，以下简称日志系统)，为了替代fanout类型的交换器，我们使用了一个direct类型的交换器，带来的好处是可以有选择的接收日志。</p>\n<p>虽然使用direct交换器改善了系统，但是仍然有局限性 - 它不能根据多个条件进行路由。</p>\n<p>在日志系统中，我们也许不仅仅想订阅严重等级的日志，也想订阅基于消息发布源的内容。也许你已经知道这个概念来自于UNIX的<a href=\"http://en.wikipedia.org/wiki/Syslog\" target=\"_blank\" rel=\"external\">syslog</a>工具，基于严重性(info/warn/crit…)和设备路由日志(auth/cron/kern…)的工具。</p>\n<p>这可以提高灵活性 - 我们也许只想要监听来自’cron’的关键错误而不是来自’kern’的全部日志。</p>\n<p>为了在我们的日志系统上实现这个功能，需要学习一个更复杂的 topic 交换器。</p>\n<h3 id=\"Topic-交换器\"><a href=\"#Topic-交换器\" class=\"headerlink\" title=\"Topic 交换器\"></a>Topic 交换器</h3><p>发送到 topic 交换器的消息不能随意设置 routing_key - 它必须是一个单词列表，以’.’分隔。单词可以是任何内容，但是通常会具体说明消息的功能。一些有效的routing key示例：样：”stock.usd.nyse”，”nyse.vmw”，”quick.orange.rabbit”。routing key 可以是任何长度的你喜欢的单词，最大255个字节。</p>\n<p>binding key 也必须是同样的格式，topic交换器的逻辑和direct交换器类似 - 带有特定routing key的消息会被派发到所有绑定了binding key的队列，然而对于binding key依然有两个重要的特殊情况：</p>\n<pre><code>*可以代替一个单词\n\n#可以代替0个或多个单词\n</code></pre><p>下图比较好的解释了这个情况：</p>\n<p><img src=\"/images/rabbitmq/python-five.png\" alt=\"\">    </p>\n<p>在这个例子中，我们准备全部发送描述动物的消息。这些消息带有由三个单词(两个点号分隔)组成的routing key，其中第一个单词表示速度，第二个表示颜色，第三个表示种类：”<speed>.<colour>.<species>“。</species></colour></speed></p>\n<p>我们创建三个绑定：Q1的binding key为”*.orange”，Q2的binding key为”*.*.rabbit”和”lazy.#“。</p>\n<p>这些绑定可以概括为：</p>\n<pre><code>Q1 关注所有orange的动物\n\nQ2 想知道所有关于兔子（rabbits）和懒惰动物（lazy animals）的消息。\n</code></pre><p>routing key为”quick.orange.rabbit”的消息会被发送到两个队列，”lazy.orange.elephant”也会被发送到这两个队列。而”quick.orange.fox”则只会发送到第一个队列，”lazy.brown.fox”会被只发送到第二个队列。”lazy.pink.rabbit”会只被发送到第二个队列一次，即使它匹配两个绑定。”quick.brown.fox”不匹配任何绑定，所以会被丢弃。</p>\n<p>如果打破规则，发送一条带有一个或四个单词，如”orange”或”quick.orange.male.rabbit”会怎么样？好吧，消息会丢失，因为它不匹配任何一个绑定。</p>\n<p>但是，”lazy.orange.male.rabbit”这种消息，即使它有4个单词，依然会匹配最后一个绑定，然后被发送到第二个队列。</p>\n<h4 id=\"topic-交换器\"><a href=\"#topic-交换器\" class=\"headerlink\" title=\"topic 交换器\"></a>topic 交换器</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">topic 交换器非常强大，可以表现得跟其他交换器一样。</div><div class=\"line\"></div><div class=\"line\">当一个队列的binding key为&quot;#&quot;时，它会接收所有消息，忽略routing key，像fanout交换器一样。</div><div class=\"line\"></div><div class=\"line\">当绑定中不存在&quot;*&quot;和&quot;#&quot;时，topic交换器会表现的跟direct交换器一样。</div></pre></td></tr></table></figure>\n<h3 id=\"整合\"><a href=\"#整合\" class=\"headerlink\" title=\"整合\"></a>整合</h3><p>我们准备在日志系统中使用topic交换器。假定日志的routing key由两个单词：”<facility>.<severity>“组成。</severity></facility></p>\n<p>代码与上一节的几乎一致。</p>\n<p>emit_log_topic.php：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">require_once</span> <span class=\"keyword\">__DIR__</span> . <span class=\"string\">'/vendor/autoload.php'</span>;</div><div class=\"line\"><span class=\"keyword\">use</span> <span class=\"title\">PhpAmqpLib</span>\\<span class=\"title\">Connection</span>\\<span class=\"title\">AMQPStreamConnection</span>;</div><div class=\"line\"><span class=\"keyword\">use</span> <span class=\"title\">PhpAmqpLib</span>\\<span class=\"title\">Message</span>\\<span class=\"title\">AMQPMessage</span>;</div><div class=\"line\"></div><div class=\"line\">$connection = <span class=\"keyword\">new</span> AMQPStreamConnection(<span class=\"string\">'localhost'</span>, <span class=\"number\">5672</span>, <span class=\"string\">'guest'</span>, <span class=\"string\">'guest'</span>);</div><div class=\"line\">$channel = $connection-&gt;channel();</div><div class=\"line\"></div><div class=\"line\">$channel-&gt;exchange_declare(<span class=\"string\">'topic_logs'</span>, <span class=\"string\">'topic'</span>, <span class=\"keyword\">false</span>, <span class=\"keyword\">false</span>, <span class=\"keyword\">false</span>);</div><div class=\"line\"></div><div class=\"line\">$routing_key = <span class=\"keyword\">isset</span>($argv[<span class=\"number\">1</span>]) &amp;&amp; !<span class=\"keyword\">empty</span>($argv[<span class=\"number\">1</span>]) ? $argv[<span class=\"number\">1</span>] : <span class=\"string\">'anonymous.info'</span>;</div><div class=\"line\">$data = implode(<span class=\"string\">' '</span>, array_slice($agrv, <span class=\"number\">2</span>));</div><div class=\"line\"><span class=\"keyword\">if</span>(<span class=\"keyword\">empty</span>($data)) $data = <span class=\"string\">\"Hello Wrold!\"</span>;</div><div class=\"line\"></div><div class=\"line\">$msg = <span class=\"keyword\">new</span> AMQPMessage($data);</div><div class=\"line\"></div><div class=\"line\">$channel-&gt;basic_publish($msg, <span class=\"string\">'topic_logs'</span>, $routing_key);</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">echo</span> <span class=\"string\">\" [x] Sent \"</span>,$routing_key,<span class=\"string\">':'</span>,$data,<span class=\"string\">\" \\n\"</span>;</div><div class=\"line\"></div><div class=\"line\">$channel-&gt;close();</div><div class=\"line\">$connection-&gt;close();</div><div class=\"line\"></div><div class=\"line\"><span class=\"meta\">?&gt;</span></div></pre></td></tr></table></figure>\n<p>receive_logs_topic.php：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">require_once</span> <span class=\"keyword\">__DIR__</span> . <span class=\"string\">'/vendor/autoload.php'</span>;</div><div class=\"line\"><span class=\"keyword\">use</span> <span class=\"title\">PhpAmqpLib</span>\\<span class=\"title\">Connection</span>\\<span class=\"title\">AMQPStreamConnection</span>;</div><div class=\"line\"></div><div class=\"line\">$connection = <span class=\"keyword\">new</span> AMQPStreamConnection(<span class=\"string\">'localhost'</span>, <span class=\"number\">5672</span>, <span class=\"string\">'guest'</span>, <span class=\"string\">'guest'</span>);</div><div class=\"line\">$channel = $connection-&gt;channel();</div><div class=\"line\"></div><div class=\"line\">$channel-&gt;exchange_declare(<span class=\"string\">'topic_logs'</span>, <span class=\"string\">'topic'</span>, <span class=\"keyword\">false</span>, <span class=\"keyword\">false</span>, <span class=\"keyword\">false</span>);</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">list</span>($queue_name, ,) = $channel-&gt;queue_declare(<span class=\"string\">\"\"</span>, <span class=\"keyword\">false</span>, <span class=\"keyword\">false</span>, <span class=\"keyword\">true</span>, <span class=\"keyword\">false</span>);</div><div class=\"line\"></div><div class=\"line\">$binding_keys = array_slice($argv, <span class=\"number\">1</span>);</div><div class=\"line\"><span class=\"keyword\">if</span>( <span class=\"keyword\">empty</span>($binding_keys) )&#123;</div><div class=\"line\">  file_put_contents(<span class=\"string\">'php://stderr'</span>, <span class=\"string\">\"Usage: $argv[0] [binding_key]\\n\"</span>);</div><div class=\"line\">  <span class=\"keyword\">exit</span>(<span class=\"number\">1</span>);</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">foreach</span>($binding_keys <span class=\"keyword\">as</span> $binding_key)&#123;</div><div class=\"line\">  $channel-&gt;queue_bind($queue_name, <span class=\"string\">'topic_logs'</span>, $binding_key);</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">echo</span> <span class=\"string\">' [*] Waiting for logs. To exit press CTRL+C'</span>, <span class=\"string\">\"\\n\"</span>;</div><div class=\"line\"></div><div class=\"line\">$callback = <span class=\"function\"><span class=\"keyword\">function</span><span class=\"params\">($msg)</span></span>&#123;</div><div class=\"line\">  <span class=\"keyword\">echo</span> <span class=\"string\">' [*] '</span>,$msg-&gt;delivery_info[<span class=\"string\">'routing_key'</span>], <span class=\"string\">':'</span>, $msg-&gt;body, <span class=\"string\">\"\\n\"</span>;</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\">$channel-&gt;basic_consume($queue_name, <span class=\"string\">''</span>, <span class=\"keyword\">false</span>, <span class=\"keyword\">true</span>, <span class=\"keyword\">false</span>, <span class=\"keyword\">false</span>, $callback);</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">while</span>(count($channel-&gt;callbacks))&#123;</div><div class=\"line\">  $channel-&gt;wait();</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\">$channel-&gt;close();</div><div class=\"line\">$connection-&gt;close();</div><div class=\"line\"></div><div class=\"line\"><span class=\"meta\">?&gt;</span></div></pre></td></tr></table></figure>\n<p>接收所有日志：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">php receive_logs_topic.php &apos;#&apos;</div></pre></td></tr></table></figure>\n<p>接收所有来自”kern”的日志：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">php receive_logs_topic.php &quot;kern.*&quot;</div></pre></td></tr></table></figure>\n<p>只接收”致命(critical)”日志：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">php receive_logs_topic.php \"*.critical\"</div></pre></td></tr></table></figure>\n<p>创建多个绑定：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">php receive_logs_topic.php \"kern.*\" \"*.critical\"</div></pre></td></tr></table></figure>\n<p>发布routing key为”kern.critical”的日志就输入：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">php emit_log_topic.php \"kern.critical\" \"A critical kernel error\"</div></pre></td></tr></table></figure>\n<p>注意此代码并没有做路由或捆绑的例子，也许你想试一下两个以上的routing key参数。</p>\n<p>一些问题：</p>\n<p>​    <a href=\"http://www.rabbitmq.com/tutorials/tutorial-five-php.html#teaser_answer_1\" target=\"_blank\" rel=\"external\">“*”会匹配routing key为空的消息吗？</a></p>\n<p>​    <a href=\"http://www.rabbitmq.com/tutorials/tutorial-five-php.html#teaser_answer_2\" target=\"_blank\" rel=\"external\">“#.*”会匹配内容为”..”的消息吗？会匹配一个单词的消息吗？</a></p>\n<p>​    <a href=\"http://www.rabbitmq.com/tutorials/tutorial-five-php.html#teaser_answer_3\" target=\"_blank\" rel=\"external\">“a.*.#”和”a.#”的区别是什么？</a></p>\n<p><a href=\"https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/php/emit_log_topic.php\" target=\"_blank\" rel=\"external\">emit_log_topic.php完整代码</a> <a href=\"https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/php/receive_logs_topic.php\" target=\"_blank\" rel=\"external\">receive_logs_topic.php完整代码</a></p>\n<p>下一步，在第六节中学习像远程过程调用一样完成消息往返。</p>\n<p>原文地址：<a href=\"https://www.rabbitmq.com/tutorials/tutorial-five-php.html\" target=\"_blank\" rel=\"external\">Topics</a></p>\n","site":{"data":{}},"excerpt":"","more":"<h3 id=\"主题\"><a href=\"#主题\" class=\"headerlink\" title=\"主题\"></a>主题</h3><p>(<a href=\"https://github.com/php-amqplib/php-amqplib\" target=\"_blank\" rel=\"external\">使用php-amqplib</a>)</p>\n<p>在<a href=\"/2016/04/24/php-rabbitmq-tutorial-four.html\">上一节</a>我们改善了日志系统(logging system，以下简称日志系统)，为了替代fanout类型的交换器，我们使用了一个direct类型的交换器，带来的好处是可以有选择的接收日志。</p>\n<p>虽然使用direct交换器改善了系统，但是仍然有局限性 - 它不能根据多个条件进行路由。</p>\n<p>在日志系统中，我们也许不仅仅想订阅严重等级的日志，也想订阅基于消息发布源的内容。也许你已经知道这个概念来自于UNIX的<a href=\"http://en.wikipedia.org/wiki/Syslog\" target=\"_blank\" rel=\"external\">syslog</a>工具，基于严重性(info/warn/crit…)和设备路由日志(auth/cron/kern…)的工具。</p>\n<p>这可以提高灵活性 - 我们也许只想要监听来自’cron’的关键错误而不是来自’kern’的全部日志。</p>\n<p>为了在我们的日志系统上实现这个功能，需要学习一个更复杂的 topic 交换器。</p>\n<h3 id=\"Topic-交换器\"><a href=\"#Topic-交换器\" class=\"headerlink\" title=\"Topic 交换器\"></a>Topic 交换器</h3><p>发送到 topic 交换器的消息不能随意设置 routing_key - 它必须是一个单词列表，以’.’分隔。单词可以是任何内容，但是通常会具体说明消息的功能。一些有效的routing key示例：样：”stock.usd.nyse”，”nyse.vmw”，”quick.orange.rabbit”。routing key 可以是任何长度的你喜欢的单词，最大255个字节。</p>\n<p>binding key 也必须是同样的格式，topic交换器的逻辑和direct交换器类似 - 带有特定routing key的消息会被派发到所有绑定了binding key的队列，然而对于binding key依然有两个重要的特殊情况：</p>\n<pre><code>*可以代替一个单词\n\n#可以代替0个或多个单词\n</code></pre><p>下图比较好的解释了这个情况：</p>\n<p><img src=\"/images/rabbitmq/python-five.png\" alt=\"\">    </p>\n<p>在这个例子中，我们准备全部发送描述动物的消息。这些消息带有由三个单词(两个点号分隔)组成的routing key，其中第一个单词表示速度，第二个表示颜色，第三个表示种类：”<speed>.<colour>.<species>“。</species></colour></speed></p>\n<p>我们创建三个绑定：Q1的binding key为”*.orange”，Q2的binding key为”*.*.rabbit”和”lazy.#“。</p>\n<p>这些绑定可以概括为：</p>\n<pre><code>Q1 关注所有orange的动物\n\nQ2 想知道所有关于兔子（rabbits）和懒惰动物（lazy animals）的消息。\n</code></pre><p>routing key为”quick.orange.rabbit”的消息会被发送到两个队列，”lazy.orange.elephant”也会被发送到这两个队列。而”quick.orange.fox”则只会发送到第一个队列，”lazy.brown.fox”会被只发送到第二个队列。”lazy.pink.rabbit”会只被发送到第二个队列一次，即使它匹配两个绑定。”quick.brown.fox”不匹配任何绑定，所以会被丢弃。</p>\n<p>如果打破规则，发送一条带有一个或四个单词，如”orange”或”quick.orange.male.rabbit”会怎么样？好吧，消息会丢失，因为它不匹配任何一个绑定。</p>\n<p>但是，”lazy.orange.male.rabbit”这种消息，即使它有4个单词，依然会匹配最后一个绑定，然后被发送到第二个队列。</p>\n<h4 id=\"topic-交换器\"><a href=\"#topic-交换器\" class=\"headerlink\" title=\"topic 交换器\"></a>topic 交换器</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">topic 交换器非常强大，可以表现得跟其他交换器一样。</div><div class=\"line\"></div><div class=\"line\">当一个队列的binding key为&quot;#&quot;时，它会接收所有消息，忽略routing key，像fanout交换器一样。</div><div class=\"line\"></div><div class=\"line\">当绑定中不存在&quot;*&quot;和&quot;#&quot;时，topic交换器会表现的跟direct交换器一样。</div></pre></td></tr></table></figure>\n<h3 id=\"整合\"><a href=\"#整合\" class=\"headerlink\" title=\"整合\"></a>整合</h3><p>我们准备在日志系统中使用topic交换器。假定日志的routing key由两个单词：”<facility>.<severity>“组成。</severity></facility></p>\n<p>代码与上一节的几乎一致。</p>\n<p>emit_log_topic.php：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">require_once</span> <span class=\"keyword\">__DIR__</span> . <span class=\"string\">'/vendor/autoload.php'</span>;</div><div class=\"line\"><span class=\"keyword\">use</span> <span class=\"title\">PhpAmqpLib</span>\\<span class=\"title\">Connection</span>\\<span class=\"title\">AMQPStreamConnection</span>;</div><div class=\"line\"><span class=\"keyword\">use</span> <span class=\"title\">PhpAmqpLib</span>\\<span class=\"title\">Message</span>\\<span class=\"title\">AMQPMessage</span>;</div><div class=\"line\"></div><div class=\"line\">$connection = <span class=\"keyword\">new</span> AMQPStreamConnection(<span class=\"string\">'localhost'</span>, <span class=\"number\">5672</span>, <span class=\"string\">'guest'</span>, <span class=\"string\">'guest'</span>);</div><div class=\"line\">$channel = $connection-&gt;channel();</div><div class=\"line\"></div><div class=\"line\">$channel-&gt;exchange_declare(<span class=\"string\">'topic_logs'</span>, <span class=\"string\">'topic'</span>, <span class=\"keyword\">false</span>, <span class=\"keyword\">false</span>, <span class=\"keyword\">false</span>);</div><div class=\"line\"></div><div class=\"line\">$routing_key = <span class=\"keyword\">isset</span>($argv[<span class=\"number\">1</span>]) &amp;&amp; !<span class=\"keyword\">empty</span>($argv[<span class=\"number\">1</span>]) ? $argv[<span class=\"number\">1</span>] : <span class=\"string\">'anonymous.info'</span>;</div><div class=\"line\">$data = implode(<span class=\"string\">' '</span>, array_slice($agrv, <span class=\"number\">2</span>));</div><div class=\"line\"><span class=\"keyword\">if</span>(<span class=\"keyword\">empty</span>($data)) $data = <span class=\"string\">\"Hello Wrold!\"</span>;</div><div class=\"line\"></div><div class=\"line\">$msg = <span class=\"keyword\">new</span> AMQPMessage($data);</div><div class=\"line\"></div><div class=\"line\">$channel-&gt;basic_publish($msg, <span class=\"string\">'topic_logs'</span>, $routing_key);</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">echo</span> <span class=\"string\">\" [x] Sent \"</span>,$routing_key,<span class=\"string\">':'</span>,$data,<span class=\"string\">\" \\n\"</span>;</div><div class=\"line\"></div><div class=\"line\">$channel-&gt;close();</div><div class=\"line\">$connection-&gt;close();</div><div class=\"line\"></div><div class=\"line\"><span class=\"meta\">?&gt;</span></div></pre></td></tr></table></figure>\n<p>receive_logs_topic.php：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">require_once</span> <span class=\"keyword\">__DIR__</span> . <span class=\"string\">'/vendor/autoload.php'</span>;</div><div class=\"line\"><span class=\"keyword\">use</span> <span class=\"title\">PhpAmqpLib</span>\\<span class=\"title\">Connection</span>\\<span class=\"title\">AMQPStreamConnection</span>;</div><div class=\"line\"></div><div class=\"line\">$connection = <span class=\"keyword\">new</span> AMQPStreamConnection(<span class=\"string\">'localhost'</span>, <span class=\"number\">5672</span>, <span class=\"string\">'guest'</span>, <span class=\"string\">'guest'</span>);</div><div class=\"line\">$channel = $connection-&gt;channel();</div><div class=\"line\"></div><div class=\"line\">$channel-&gt;exchange_declare(<span class=\"string\">'topic_logs'</span>, <span class=\"string\">'topic'</span>, <span class=\"keyword\">false</span>, <span class=\"keyword\">false</span>, <span class=\"keyword\">false</span>);</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">list</span>($queue_name, ,) = $channel-&gt;queue_declare(<span class=\"string\">\"\"</span>, <span class=\"keyword\">false</span>, <span class=\"keyword\">false</span>, <span class=\"keyword\">true</span>, <span class=\"keyword\">false</span>);</div><div class=\"line\"></div><div class=\"line\">$binding_keys = array_slice($argv, <span class=\"number\">1</span>);</div><div class=\"line\"><span class=\"keyword\">if</span>( <span class=\"keyword\">empty</span>($binding_keys) )&#123;</div><div class=\"line\">  file_put_contents(<span class=\"string\">'php://stderr'</span>, <span class=\"string\">\"Usage: $argv[0] [binding_key]\\n\"</span>);</div><div class=\"line\">  <span class=\"keyword\">exit</span>(<span class=\"number\">1</span>);</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">foreach</span>($binding_keys <span class=\"keyword\">as</span> $binding_key)&#123;</div><div class=\"line\">  $channel-&gt;queue_bind($queue_name, <span class=\"string\">'topic_logs'</span>, $binding_key);</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">echo</span> <span class=\"string\">' [*] Waiting for logs. To exit press CTRL+C'</span>, <span class=\"string\">\"\\n\"</span>;</div><div class=\"line\"></div><div class=\"line\">$callback = <span class=\"function\"><span class=\"keyword\">function</span><span class=\"params\">($msg)</span></span>&#123;</div><div class=\"line\">  <span class=\"keyword\">echo</span> <span class=\"string\">' [*] '</span>,$msg-&gt;delivery_info[<span class=\"string\">'routing_key'</span>], <span class=\"string\">':'</span>, $msg-&gt;body, <span class=\"string\">\"\\n\"</span>;</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\">$channel-&gt;basic_consume($queue_name, <span class=\"string\">''</span>, <span class=\"keyword\">false</span>, <span class=\"keyword\">true</span>, <span class=\"keyword\">false</span>, <span class=\"keyword\">false</span>, $callback);</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">while</span>(count($channel-&gt;callbacks))&#123;</div><div class=\"line\">  $channel-&gt;wait();</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\">$channel-&gt;close();</div><div class=\"line\">$connection-&gt;close();</div><div class=\"line\"></div><div class=\"line\"><span class=\"meta\">?&gt;</span></div></pre></td></tr></table></figure>\n<p>接收所有日志：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">php receive_logs_topic.php &apos;#&apos;</div></pre></td></tr></table></figure>\n<p>接收所有来自”kern”的日志：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">php receive_logs_topic.php &quot;kern.*&quot;</div></pre></td></tr></table></figure>\n<p>只接收”致命(critical)”日志：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">php receive_logs_topic.php \"*.critical\"</div></pre></td></tr></table></figure>\n<p>创建多个绑定：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">php receive_logs_topic.php \"kern.*\" \"*.critical\"</div></pre></td></tr></table></figure>\n<p>发布routing key为”kern.critical”的日志就输入：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">php emit_log_topic.php \"kern.critical\" \"A critical kernel error\"</div></pre></td></tr></table></figure>\n<p>注意此代码并没有做路由或捆绑的例子，也许你想试一下两个以上的routing key参数。</p>\n<p>一些问题：</p>\n<p>​    <a href=\"http://www.rabbitmq.com/tutorials/tutorial-five-php.html#teaser_answer_1\" target=\"_blank\" rel=\"external\">“*”会匹配routing key为空的消息吗？</a></p>\n<p>​    <a href=\"http://www.rabbitmq.com/tutorials/tutorial-five-php.html#teaser_answer_2\" target=\"_blank\" rel=\"external\">“#.*”会匹配内容为”..”的消息吗？会匹配一个单词的消息吗？</a></p>\n<p>​    <a href=\"http://www.rabbitmq.com/tutorials/tutorial-five-php.html#teaser_answer_3\" target=\"_blank\" rel=\"external\">“a.*.#”和”a.#”的区别是什么？</a></p>\n<p><a href=\"https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/php/emit_log_topic.php\" target=\"_blank\" rel=\"external\">emit_log_topic.php完整代码</a> <a href=\"https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/php/receive_logs_topic.php\" target=\"_blank\" rel=\"external\">receive_logs_topic.php完整代码</a></p>\n<p>下一步，在第六节中学习像远程过程调用一样完成消息往返。</p>\n<p>原文地址：<a href=\"https://www.rabbitmq.com/tutorials/tutorial-five-php.html\" target=\"_blank\" rel=\"external\">Topics</a></p>\n"},{"title":"PHP RabbitMQ 教程（一） - 介绍","date":"2016-02-28T03:10:03.000Z","_content":"\n## 准备工作\n### 先决条件\n\n本教程先决条件是RabbitMQ已经安装并正在以5672端口运行在 localhost，如果你使用了不同的域，端口，用户，密码，连接配置需要适当改变。\n\n### 获得帮助\n\n如果在本教程中遇到问题，可以通过邮件列表进行联系。\n\n### 介绍\n\nRabbitMQ是一个消息代理，它的本质是，从producers（生产者）接收消息，然后发送给consumers（消费者），在这个过程中，可以根据自己的配置规则使用路由，缓冲区，保存消息。\n\n通常的，RabbitMQ，信息传送（messaging），使用一些专业术语。（RabbitMQ, and messaging in general, uses some jargon.）\n\n\t>生产（Producing）仅仅意味着发送，发送信息的程序叫做生产者（producers），以下图表示：\n\t\n![](/images/rabbitmq/producer.png)\n\t\n\t>队列就是一个信箱的名字，存在于RabbitMQ内部，虽然消息在RabbitMQ和你的应用之间传输，但是只能存在于队列里，队列没有大小限制，它可以存储尽可能多的消息，本质上它是一个无限大的缓冲区，多个producers（生产者）可以通过一个队列发送消息，多个consumers（消费者）也可以尝试从一个队列接收消息，队列以下图表示，队列的名字在图的上边：\n\n![](/images/rabbitmq/queue.png)\t\n\n\t>consumers（消费者）的意思与接收相似，消费者主要是等待接收消息的程序，以下图表示：\n\t\n![](/images/rabbitmq/consumer.png)\t\n\n需要注意的是，生产者，消费者，和代理，不需要一定在一台机器上，事实上在大多数情况下他们确实不在一台机器上。\n\n### “Hello World”\n\n（使用[php-amqplib](https://github.com/php-amqplib/php-amqplib)库）\n\n在这一部分，我们使用PHP写两段程序，一个生产者发送一条消息，一个消费者接收消息并打印出来。我们会忽略一些php-amqplib API的细节，从简单的事情开始学习，这是一段内容为“Hello World”的消息。\n\n在下边的示意图中，“P”是生产者，“C”是消费者，中间的盒子是队列 — 一个RabbitMQ代表消费者的消息缓冲区。\n\n![](/images/rabbitmq/python-one.png)\n\n#### php-amqplib库\n\nRabbitMQ支持很多协议，本教程包含AMQP 0-9-1，一个开放，通用信息协议，RabbitMQ支持Python、Ruby、.NET、Java、JMS、C、PHP、ActionScript、XMPP、STOMP等多种语言（详见[这里](http://www.rabbitmq.com/devtools.html)），在本教程中我们使用php-amqplib，使用[Composer](https://getcomposer.org/doc/00-intro.md) 管理依赖。\n\n添加一个composer.json文件到你的项目目录。\n\n```\n{\n    \"require\": {\n        \"php-amqplib/php-amqplib\": \"2.5.*\"\n    }\n}\n```\n\n如果你已经安装了 Composer ，可以运行如下的代码：\n\n```\ncomposer.phar install\n```\n\n这是一个Windows系统下的Composer安装文件。\n\n现在我们已经安装了php-amqplib，可以写程序了。\n\n### 发送\n\n![](/images/rabbitmq/sending.png)\n\n新建一个send.php作为发送端，receive.php作为接收端，发送端会连接RabbitMQ，发送一条信息，然后退出。\n\n在send.php中，需要引用php-amqplib库，和使用其中的一些必要的类。\n\n```\nrequire_once __DIR__ . '/vendor/autoload.php';\nuse PhpAmqpLib\\Connection\\AMQPStreamConnection;\nuse PhpAmqpLib\\Message\\AMQPMessage;\n\n```\n\n接下来，建立到RabbitMQ服务器的连接：\n\n```\n$connection = new AMQPStreamConnection('localhost', 5672, 'guest', 'guest');\n$channel = $connection->channel();\n\n```\n\n这里我们使用socket进行连接，处理协议和鉴定，这样就已经连接到了本机的代理，如果想要连接不同的主机，只要更改localhost为该主机的名称或IP地址即可。\n\n下一步，建立频道，大部分API的工作都在这完成。\n\n要想发送信息，需要声明一个队列，之后可以向这个队列里发布消息。\n\n```\n$channel->queue_declare('hello', false, false, false, false);\n\n$msg = new AMQPMessage('Hello World!');\n$channel->basic_publish($msg, '', 'hello');\n\necho \" [x] Sent 'Hello World!'\\n\";\n\n```\n\n声明队列是幂等的 — 它仅在不存在的时候才会被创建，如果存在也不会受影响。消息内容是一个字节数组（byte array），所以可以发送任何内容。\n\n最后，关闭频道和连接。\n\n```\n$channel->close();\n$connection->close();\n```\n\n[这是send.php类的完整内容。](https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/php/send.php)\n\n### 发送失败\n\n如果这是第一次使用RabbitMQ，并且没有看到“Sent”信息（即“ [x] Sent 'Hello World!”），也许你抓耳挠腮的想知道为什么出错了，也许是代理没有足够的硬盘空间（默认情况下需要至少1G的空间）导致拒绝接收信息。检查日志文件，有必要的花调低限值。[这个配置文件](http://www.rabbitmq.com/configure.html#config-items)文档将会展示给你如何设置disk_free_limit。\n\n### 接收\n\n收件人，与发送者只发送一条消息不同，接收者会一直运行以监听信息并输出。\n\n![](/images/rabbitmq/receiving.png)\n\nreceive.php中与send.php中的 include和use 部分的代码一样。\n\n```\nrequire_once __DIR__ . '/vendor/autoload.php';\nuse PhpAmqpLib\\Connection\\AMQPStreamConnection;\n\n```\n\n设置连接与send.php一样，打开连接和频道，命名一个队列，需要注意的是，队列名需要与send.php所发布的队列的名字一致。\n\n```\n$connection = new AMQPStreamConnection('localhost', 5672, 'guest', 'guest');\n$channel = $connection->channel();\n\n$channel->queue_declare('hello', false, false, false, false);\n\necho ' [*] Waiting for messages. To exit press CTRL+C', \"\\n\";\n\n```\n\n注意，我们在此声明了一个队列，因为有可能会在send程序开启前先开启receive程序，我们想要确保在试着接收消息之前队列就已经存在了。\n\n下一步，告诉服务器去从队列传送消息，我们会定义一个用于从服务器接收消息的函数，记住，消息会异步的从服务器发送到客户端。\n\n```\n$callback = function($msg) {\n  echo \" [x] Received \", $msg->body, \"\\n\";\n};\n\n$channel->basic_consume('hello', '', false, true, false, false, $callback);\n\nwhile(count($channel->callbacks)) {\n    $channel->wait();\n}\n```\n此处使用while方法，当收到消息时，会把收到的消息传入到$callback方法里。\n\n[这是receive.php类的全部内容。](https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/php/receive.php)\n\n现在我们可以运行两段脚本了，在命令行里，执行sender程序。\n\n```\nphp send.php\n\n```\n\n然后，执行receiver程序\n\n```\nphp receive.php\n\n```\n\nreceiver程序会把通过sender程序发送的内容打印出来，receiver程序会一直运行，监听新消息（使用ctrl+c停止），所以试着运行sender程序从另一个命令行。\n\n如果想查看队列，可以运行rabbitmqctl list_queues。\n\nHello World！\n\n查看第二部分，建立一个简单的队列。\n\n原文地址：[\"Hello World!\"](https://www.rabbitmq.com/tutorials/tutorial-one-php.html)","source":"_posts/php-rabbitmq-tutorial-one.md","raw":"title: PHP RabbitMQ 教程（一） - 介绍\ncategories: php\ndate: 2016-02-28 11:10:03\ntags:  [php,rabbitmq]\n\n---\n\n## 准备工作\n### 先决条件\n\n本教程先决条件是RabbitMQ已经安装并正在以5672端口运行在 localhost，如果你使用了不同的域，端口，用户，密码，连接配置需要适当改变。\n\n### 获得帮助\n\n如果在本教程中遇到问题，可以通过邮件列表进行联系。\n\n### 介绍\n\nRabbitMQ是一个消息代理，它的本质是，从producers（生产者）接收消息，然后发送给consumers（消费者），在这个过程中，可以根据自己的配置规则使用路由，缓冲区，保存消息。\n\n通常的，RabbitMQ，信息传送（messaging），使用一些专业术语。（RabbitMQ, and messaging in general, uses some jargon.）\n\n\t>生产（Producing）仅仅意味着发送，发送信息的程序叫做生产者（producers），以下图表示：\n\t\n![](/images/rabbitmq/producer.png)\n\t\n\t>队列就是一个信箱的名字，存在于RabbitMQ内部，虽然消息在RabbitMQ和你的应用之间传输，但是只能存在于队列里，队列没有大小限制，它可以存储尽可能多的消息，本质上它是一个无限大的缓冲区，多个producers（生产者）可以通过一个队列发送消息，多个consumers（消费者）也可以尝试从一个队列接收消息，队列以下图表示，队列的名字在图的上边：\n\n![](/images/rabbitmq/queue.png)\t\n\n\t>consumers（消费者）的意思与接收相似，消费者主要是等待接收消息的程序，以下图表示：\n\t\n![](/images/rabbitmq/consumer.png)\t\n\n需要注意的是，生产者，消费者，和代理，不需要一定在一台机器上，事实上在大多数情况下他们确实不在一台机器上。\n\n### “Hello World”\n\n（使用[php-amqplib](https://github.com/php-amqplib/php-amqplib)库）\n\n在这一部分，我们使用PHP写两段程序，一个生产者发送一条消息，一个消费者接收消息并打印出来。我们会忽略一些php-amqplib API的细节，从简单的事情开始学习，这是一段内容为“Hello World”的消息。\n\n在下边的示意图中，“P”是生产者，“C”是消费者，中间的盒子是队列 — 一个RabbitMQ代表消费者的消息缓冲区。\n\n![](/images/rabbitmq/python-one.png)\n\n#### php-amqplib库\n\nRabbitMQ支持很多协议，本教程包含AMQP 0-9-1，一个开放，通用信息协议，RabbitMQ支持Python、Ruby、.NET、Java、JMS、C、PHP、ActionScript、XMPP、STOMP等多种语言（详见[这里](http://www.rabbitmq.com/devtools.html)），在本教程中我们使用php-amqplib，使用[Composer](https://getcomposer.org/doc/00-intro.md) 管理依赖。\n\n添加一个composer.json文件到你的项目目录。\n\n```\n{\n    \"require\": {\n        \"php-amqplib/php-amqplib\": \"2.5.*\"\n    }\n}\n```\n\n如果你已经安装了 Composer ，可以运行如下的代码：\n\n```\ncomposer.phar install\n```\n\n这是一个Windows系统下的Composer安装文件。\n\n现在我们已经安装了php-amqplib，可以写程序了。\n\n### 发送\n\n![](/images/rabbitmq/sending.png)\n\n新建一个send.php作为发送端，receive.php作为接收端，发送端会连接RabbitMQ，发送一条信息，然后退出。\n\n在send.php中，需要引用php-amqplib库，和使用其中的一些必要的类。\n\n```\nrequire_once __DIR__ . '/vendor/autoload.php';\nuse PhpAmqpLib\\Connection\\AMQPStreamConnection;\nuse PhpAmqpLib\\Message\\AMQPMessage;\n\n```\n\n接下来，建立到RabbitMQ服务器的连接：\n\n```\n$connection = new AMQPStreamConnection('localhost', 5672, 'guest', 'guest');\n$channel = $connection->channel();\n\n```\n\n这里我们使用socket进行连接，处理协议和鉴定，这样就已经连接到了本机的代理，如果想要连接不同的主机，只要更改localhost为该主机的名称或IP地址即可。\n\n下一步，建立频道，大部分API的工作都在这完成。\n\n要想发送信息，需要声明一个队列，之后可以向这个队列里发布消息。\n\n```\n$channel->queue_declare('hello', false, false, false, false);\n\n$msg = new AMQPMessage('Hello World!');\n$channel->basic_publish($msg, '', 'hello');\n\necho \" [x] Sent 'Hello World!'\\n\";\n\n```\n\n声明队列是幂等的 — 它仅在不存在的时候才会被创建，如果存在也不会受影响。消息内容是一个字节数组（byte array），所以可以发送任何内容。\n\n最后，关闭频道和连接。\n\n```\n$channel->close();\n$connection->close();\n```\n\n[这是send.php类的完整内容。](https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/php/send.php)\n\n### 发送失败\n\n如果这是第一次使用RabbitMQ，并且没有看到“Sent”信息（即“ [x] Sent 'Hello World!”），也许你抓耳挠腮的想知道为什么出错了，也许是代理没有足够的硬盘空间（默认情况下需要至少1G的空间）导致拒绝接收信息。检查日志文件，有必要的花调低限值。[这个配置文件](http://www.rabbitmq.com/configure.html#config-items)文档将会展示给你如何设置disk_free_limit。\n\n### 接收\n\n收件人，与发送者只发送一条消息不同，接收者会一直运行以监听信息并输出。\n\n![](/images/rabbitmq/receiving.png)\n\nreceive.php中与send.php中的 include和use 部分的代码一样。\n\n```\nrequire_once __DIR__ . '/vendor/autoload.php';\nuse PhpAmqpLib\\Connection\\AMQPStreamConnection;\n\n```\n\n设置连接与send.php一样，打开连接和频道，命名一个队列，需要注意的是，队列名需要与send.php所发布的队列的名字一致。\n\n```\n$connection = new AMQPStreamConnection('localhost', 5672, 'guest', 'guest');\n$channel = $connection->channel();\n\n$channel->queue_declare('hello', false, false, false, false);\n\necho ' [*] Waiting for messages. To exit press CTRL+C', \"\\n\";\n\n```\n\n注意，我们在此声明了一个队列，因为有可能会在send程序开启前先开启receive程序，我们想要确保在试着接收消息之前队列就已经存在了。\n\n下一步，告诉服务器去从队列传送消息，我们会定义一个用于从服务器接收消息的函数，记住，消息会异步的从服务器发送到客户端。\n\n```\n$callback = function($msg) {\n  echo \" [x] Received \", $msg->body, \"\\n\";\n};\n\n$channel->basic_consume('hello', '', false, true, false, false, $callback);\n\nwhile(count($channel->callbacks)) {\n    $channel->wait();\n}\n```\n此处使用while方法，当收到消息时，会把收到的消息传入到$callback方法里。\n\n[这是receive.php类的全部内容。](https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/php/receive.php)\n\n现在我们可以运行两段脚本了，在命令行里，执行sender程序。\n\n```\nphp send.php\n\n```\n\n然后，执行receiver程序\n\n```\nphp receive.php\n\n```\n\nreceiver程序会把通过sender程序发送的内容打印出来，receiver程序会一直运行，监听新消息（使用ctrl+c停止），所以试着运行sender程序从另一个命令行。\n\n如果想查看队列，可以运行rabbitmqctl list_queues。\n\nHello World！\n\n查看第二部分，建立一个简单的队列。\n\n原文地址：[\"Hello World!\"](https://www.rabbitmq.com/tutorials/tutorial-one-php.html)","slug":"php-rabbitmq-tutorial-one","published":1,"updated":"2016-05-07T14:06:15.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj830jvec002aul0r261rubxu","content":"<h2 id=\"准备工作\"><a href=\"#准备工作\" class=\"headerlink\" title=\"准备工作\"></a>准备工作</h2><h3 id=\"先决条件\"><a href=\"#先决条件\" class=\"headerlink\" title=\"先决条件\"></a>先决条件</h3><p>本教程先决条件是RabbitMQ已经安装并正在以5672端口运行在 localhost，如果你使用了不同的域，端口，用户，密码，连接配置需要适当改变。</p>\n<h3 id=\"获得帮助\"><a href=\"#获得帮助\" class=\"headerlink\" title=\"获得帮助\"></a>获得帮助</h3><p>如果在本教程中遇到问题，可以通过邮件列表进行联系。</p>\n<h3 id=\"介绍\"><a href=\"#介绍\" class=\"headerlink\" title=\"介绍\"></a>介绍</h3><p>RabbitMQ是一个消息代理，它的本质是，从producers（生产者）接收消息，然后发送给consumers（消费者），在这个过程中，可以根据自己的配置规则使用路由，缓冲区，保存消息。</p>\n<p>通常的，RabbitMQ，信息传送（messaging），使用一些专业术语。（RabbitMQ, and messaging in general, uses some jargon.）</p>\n<pre><code>&gt;生产（Producing）仅仅意味着发送，发送信息的程序叫做生产者（producers），以下图表示：\n</code></pre><p><img src=\"/images/rabbitmq/producer.png\" alt=\"\"></p>\n<pre><code>&gt;队列就是一个信箱的名字，存在于RabbitMQ内部，虽然消息在RabbitMQ和你的应用之间传输，但是只能存在于队列里，队列没有大小限制，它可以存储尽可能多的消息，本质上它是一个无限大的缓冲区，多个producers（生产者）可以通过一个队列发送消息，多个consumers（消费者）也可以尝试从一个队列接收消息，队列以下图表示，队列的名字在图的上边：\n</code></pre><p><img src=\"/images/rabbitmq/queue.png\" alt=\"\">    </p>\n<pre><code>&gt;consumers（消费者）的意思与接收相似，消费者主要是等待接收消息的程序，以下图表示：\n</code></pre><p><img src=\"/images/rabbitmq/consumer.png\" alt=\"\">    </p>\n<p>需要注意的是，生产者，消费者，和代理，不需要一定在一台机器上，事实上在大多数情况下他们确实不在一台机器上。</p>\n<h3 id=\"“Hello-World”\"><a href=\"#“Hello-World”\" class=\"headerlink\" title=\"“Hello World”\"></a>“Hello World”</h3><p>（使用<a href=\"https://github.com/php-amqplib/php-amqplib\" target=\"_blank\" rel=\"external\">php-amqplib</a>库）</p>\n<p>在这一部分，我们使用PHP写两段程序，一个生产者发送一条消息，一个消费者接收消息并打印出来。我们会忽略一些php-amqplib API的细节，从简单的事情开始学习，这是一段内容为“Hello World”的消息。</p>\n<p>在下边的示意图中，“P”是生产者，“C”是消费者，中间的盒子是队列 — 一个RabbitMQ代表消费者的消息缓冲区。</p>\n<p><img src=\"/images/rabbitmq/python-one.png\" alt=\"\"></p>\n<h4 id=\"php-amqplib库\"><a href=\"#php-amqplib库\" class=\"headerlink\" title=\"php-amqplib库\"></a>php-amqplib库</h4><p>RabbitMQ支持很多协议，本教程包含AMQP 0-9-1，一个开放，通用信息协议，RabbitMQ支持Python、Ruby、.NET、Java、JMS、C、PHP、ActionScript、XMPP、STOMP等多种语言（详见<a href=\"http://www.rabbitmq.com/devtools.html\" target=\"_blank\" rel=\"external\">这里</a>），在本教程中我们使用php-amqplib，使用<a href=\"https://getcomposer.org/doc/00-intro.md\" target=\"_blank\" rel=\"external\">Composer</a> 管理依赖。</p>\n<p>添加一个composer.json文件到你的项目目录。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">&#123;</div><div class=\"line\">    &quot;require&quot;: &#123;</div><div class=\"line\">        &quot;php-amqplib/php-amqplib&quot;: &quot;2.5.*&quot;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>如果你已经安装了 Composer ，可以运行如下的代码：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">composer.phar install</div></pre></td></tr></table></figure>\n<p>这是一个Windows系统下的Composer安装文件。</p>\n<p>现在我们已经安装了php-amqplib，可以写程序了。</p>\n<h3 id=\"发送\"><a href=\"#发送\" class=\"headerlink\" title=\"发送\"></a>发送</h3><p><img src=\"/images/rabbitmq/sending.png\" alt=\"\"></p>\n<p>新建一个send.php作为发送端，receive.php作为接收端，发送端会连接RabbitMQ，发送一条信息，然后退出。</p>\n<p>在send.php中，需要引用php-amqplib库，和使用其中的一些必要的类。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">require_once __DIR__ . &apos;/vendor/autoload.php&apos;;</div><div class=\"line\">use PhpAmqpLib\\Connection\\AMQPStreamConnection;</div><div class=\"line\">use PhpAmqpLib\\Message\\AMQPMessage;</div></pre></td></tr></table></figure>\n<p>接下来，建立到RabbitMQ服务器的连接：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">$connection = new AMQPStreamConnection(&apos;localhost&apos;, 5672, &apos;guest&apos;, &apos;guest&apos;);</div><div class=\"line\">$channel = $connection-&gt;channel();</div></pre></td></tr></table></figure>\n<p>这里我们使用socket进行连接，处理协议和鉴定，这样就已经连接到了本机的代理，如果想要连接不同的主机，只要更改localhost为该主机的名称或IP地址即可。</p>\n<p>下一步，建立频道，大部分API的工作都在这完成。</p>\n<p>要想发送信息，需要声明一个队列，之后可以向这个队列里发布消息。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">$channel-&gt;queue_declare(&apos;hello&apos;, false, false, false, false);</div><div class=\"line\"></div><div class=\"line\">$msg = new AMQPMessage(&apos;Hello World!&apos;);</div><div class=\"line\">$channel-&gt;basic_publish($msg, &apos;&apos;, &apos;hello&apos;);</div><div class=\"line\"></div><div class=\"line\">echo &quot; [x] Sent &apos;Hello World!&apos;\\n&quot;;</div></pre></td></tr></table></figure>\n<p>声明队列是幂等的 — 它仅在不存在的时候才会被创建，如果存在也不会受影响。消息内容是一个字节数组（byte array），所以可以发送任何内容。</p>\n<p>最后，关闭频道和连接。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">$channel-&gt;close();</div><div class=\"line\">$connection-&gt;close();</div></pre></td></tr></table></figure>\n<p><a href=\"https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/php/send.php\" target=\"_blank\" rel=\"external\">这是send.php类的完整内容。</a></p>\n<h3 id=\"发送失败\"><a href=\"#发送失败\" class=\"headerlink\" title=\"发送失败\"></a>发送失败</h3><p>如果这是第一次使用RabbitMQ，并且没有看到“Sent”信息（即“ [x] Sent ‘Hello World!”），也许你抓耳挠腮的想知道为什么出错了，也许是代理没有足够的硬盘空间（默认情况下需要至少1G的空间）导致拒绝接收信息。检查日志文件，有必要的花调低限值。<a href=\"http://www.rabbitmq.com/configure.html#config-items\" target=\"_blank\" rel=\"external\">这个配置文件</a>文档将会展示给你如何设置disk_free_limit。</p>\n<h3 id=\"接收\"><a href=\"#接收\" class=\"headerlink\" title=\"接收\"></a>接收</h3><p>收件人，与发送者只发送一条消息不同，接收者会一直运行以监听信息并输出。</p>\n<p><img src=\"/images/rabbitmq/receiving.png\" alt=\"\"></p>\n<p>receive.php中与send.php中的 include和use 部分的代码一样。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">require_once __DIR__ . &apos;/vendor/autoload.php&apos;;</div><div class=\"line\">use PhpAmqpLib\\Connection\\AMQPStreamConnection;</div></pre></td></tr></table></figure>\n<p>设置连接与send.php一样，打开连接和频道，命名一个队列，需要注意的是，队列名需要与send.php所发布的队列的名字一致。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">$connection = new AMQPStreamConnection(&apos;localhost&apos;, 5672, &apos;guest&apos;, &apos;guest&apos;);</div><div class=\"line\">$channel = $connection-&gt;channel();</div><div class=\"line\"></div><div class=\"line\">$channel-&gt;queue_declare(&apos;hello&apos;, false, false, false, false);</div><div class=\"line\"></div><div class=\"line\">echo &apos; [*] Waiting for messages. To exit press CTRL+C&apos;, &quot;\\n&quot;;</div></pre></td></tr></table></figure>\n<p>注意，我们在此声明了一个队列，因为有可能会在send程序开启前先开启receive程序，我们想要确保在试着接收消息之前队列就已经存在了。</p>\n<p>下一步，告诉服务器去从队列传送消息，我们会定义一个用于从服务器接收消息的函数，记住，消息会异步的从服务器发送到客户端。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\">$callback = function($msg) &#123;</div><div class=\"line\">  echo &quot; [x] Received &quot;, $msg-&gt;body, &quot;\\n&quot;;</div><div class=\"line\">&#125;;</div><div class=\"line\"></div><div class=\"line\">$channel-&gt;basic_consume(&apos;hello&apos;, &apos;&apos;, false, true, false, false, $callback);</div><div class=\"line\"></div><div class=\"line\">while(count($channel-&gt;callbacks)) &#123;</div><div class=\"line\">    $channel-&gt;wait();</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>此处使用while方法，当收到消息时，会把收到的消息传入到$callback方法里。</p>\n<p><a href=\"https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/php/receive.php\" target=\"_blank\" rel=\"external\">这是receive.php类的全部内容。</a></p>\n<p>现在我们可以运行两段脚本了，在命令行里，执行sender程序。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">php send.php</div></pre></td></tr></table></figure>\n<p>然后，执行receiver程序</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">php receive.php</div></pre></td></tr></table></figure>\n<p>receiver程序会把通过sender程序发送的内容打印出来，receiver程序会一直运行，监听新消息（使用ctrl+c停止），所以试着运行sender程序从另一个命令行。</p>\n<p>如果想查看队列，可以运行rabbitmqctl list_queues。</p>\n<p>Hello World！</p>\n<p>查看第二部分，建立一个简单的队列。</p>\n<p>原文地址：<a href=\"https://www.rabbitmq.com/tutorials/tutorial-one-php.html\" target=\"_blank\" rel=\"external\">“Hello World!”</a></p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"准备工作\"><a href=\"#准备工作\" class=\"headerlink\" title=\"准备工作\"></a>准备工作</h2><h3 id=\"先决条件\"><a href=\"#先决条件\" class=\"headerlink\" title=\"先决条件\"></a>先决条件</h3><p>本教程先决条件是RabbitMQ已经安装并正在以5672端口运行在 localhost，如果你使用了不同的域，端口，用户，密码，连接配置需要适当改变。</p>\n<h3 id=\"获得帮助\"><a href=\"#获得帮助\" class=\"headerlink\" title=\"获得帮助\"></a>获得帮助</h3><p>如果在本教程中遇到问题，可以通过邮件列表进行联系。</p>\n<h3 id=\"介绍\"><a href=\"#介绍\" class=\"headerlink\" title=\"介绍\"></a>介绍</h3><p>RabbitMQ是一个消息代理，它的本质是，从producers（生产者）接收消息，然后发送给consumers（消费者），在这个过程中，可以根据自己的配置规则使用路由，缓冲区，保存消息。</p>\n<p>通常的，RabbitMQ，信息传送（messaging），使用一些专业术语。（RabbitMQ, and messaging in general, uses some jargon.）</p>\n<pre><code>&gt;生产（Producing）仅仅意味着发送，发送信息的程序叫做生产者（producers），以下图表示：\n</code></pre><p><img src=\"/images/rabbitmq/producer.png\" alt=\"\"></p>\n<pre><code>&gt;队列就是一个信箱的名字，存在于RabbitMQ内部，虽然消息在RabbitMQ和你的应用之间传输，但是只能存在于队列里，队列没有大小限制，它可以存储尽可能多的消息，本质上它是一个无限大的缓冲区，多个producers（生产者）可以通过一个队列发送消息，多个consumers（消费者）也可以尝试从一个队列接收消息，队列以下图表示，队列的名字在图的上边：\n</code></pre><p><img src=\"/images/rabbitmq/queue.png\" alt=\"\">    </p>\n<pre><code>&gt;consumers（消费者）的意思与接收相似，消费者主要是等待接收消息的程序，以下图表示：\n</code></pre><p><img src=\"/images/rabbitmq/consumer.png\" alt=\"\">    </p>\n<p>需要注意的是，生产者，消费者，和代理，不需要一定在一台机器上，事实上在大多数情况下他们确实不在一台机器上。</p>\n<h3 id=\"“Hello-World”\"><a href=\"#“Hello-World”\" class=\"headerlink\" title=\"“Hello World”\"></a>“Hello World”</h3><p>（使用<a href=\"https://github.com/php-amqplib/php-amqplib\" target=\"_blank\" rel=\"external\">php-amqplib</a>库）</p>\n<p>在这一部分，我们使用PHP写两段程序，一个生产者发送一条消息，一个消费者接收消息并打印出来。我们会忽略一些php-amqplib API的细节，从简单的事情开始学习，这是一段内容为“Hello World”的消息。</p>\n<p>在下边的示意图中，“P”是生产者，“C”是消费者，中间的盒子是队列 — 一个RabbitMQ代表消费者的消息缓冲区。</p>\n<p><img src=\"/images/rabbitmq/python-one.png\" alt=\"\"></p>\n<h4 id=\"php-amqplib库\"><a href=\"#php-amqplib库\" class=\"headerlink\" title=\"php-amqplib库\"></a>php-amqplib库</h4><p>RabbitMQ支持很多协议，本教程包含AMQP 0-9-1，一个开放，通用信息协议，RabbitMQ支持Python、Ruby、.NET、Java、JMS、C、PHP、ActionScript、XMPP、STOMP等多种语言（详见<a href=\"http://www.rabbitmq.com/devtools.html\" target=\"_blank\" rel=\"external\">这里</a>），在本教程中我们使用php-amqplib，使用<a href=\"https://getcomposer.org/doc/00-intro.md\" target=\"_blank\" rel=\"external\">Composer</a> 管理依赖。</p>\n<p>添加一个composer.json文件到你的项目目录。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">&#123;</div><div class=\"line\">    &quot;require&quot;: &#123;</div><div class=\"line\">        &quot;php-amqplib/php-amqplib&quot;: &quot;2.5.*&quot;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>如果你已经安装了 Composer ，可以运行如下的代码：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">composer.phar install</div></pre></td></tr></table></figure>\n<p>这是一个Windows系统下的Composer安装文件。</p>\n<p>现在我们已经安装了php-amqplib，可以写程序了。</p>\n<h3 id=\"发送\"><a href=\"#发送\" class=\"headerlink\" title=\"发送\"></a>发送</h3><p><img src=\"/images/rabbitmq/sending.png\" alt=\"\"></p>\n<p>新建一个send.php作为发送端，receive.php作为接收端，发送端会连接RabbitMQ，发送一条信息，然后退出。</p>\n<p>在send.php中，需要引用php-amqplib库，和使用其中的一些必要的类。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">require_once __DIR__ . &apos;/vendor/autoload.php&apos;;</div><div class=\"line\">use PhpAmqpLib\\Connection\\AMQPStreamConnection;</div><div class=\"line\">use PhpAmqpLib\\Message\\AMQPMessage;</div></pre></td></tr></table></figure>\n<p>接下来，建立到RabbitMQ服务器的连接：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">$connection = new AMQPStreamConnection(&apos;localhost&apos;, 5672, &apos;guest&apos;, &apos;guest&apos;);</div><div class=\"line\">$channel = $connection-&gt;channel();</div></pre></td></tr></table></figure>\n<p>这里我们使用socket进行连接，处理协议和鉴定，这样就已经连接到了本机的代理，如果想要连接不同的主机，只要更改localhost为该主机的名称或IP地址即可。</p>\n<p>下一步，建立频道，大部分API的工作都在这完成。</p>\n<p>要想发送信息，需要声明一个队列，之后可以向这个队列里发布消息。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">$channel-&gt;queue_declare(&apos;hello&apos;, false, false, false, false);</div><div class=\"line\"></div><div class=\"line\">$msg = new AMQPMessage(&apos;Hello World!&apos;);</div><div class=\"line\">$channel-&gt;basic_publish($msg, &apos;&apos;, &apos;hello&apos;);</div><div class=\"line\"></div><div class=\"line\">echo &quot; [x] Sent &apos;Hello World!&apos;\\n&quot;;</div></pre></td></tr></table></figure>\n<p>声明队列是幂等的 — 它仅在不存在的时候才会被创建，如果存在也不会受影响。消息内容是一个字节数组（byte array），所以可以发送任何内容。</p>\n<p>最后，关闭频道和连接。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">$channel-&gt;close();</div><div class=\"line\">$connection-&gt;close();</div></pre></td></tr></table></figure>\n<p><a href=\"https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/php/send.php\" target=\"_blank\" rel=\"external\">这是send.php类的完整内容。</a></p>\n<h3 id=\"发送失败\"><a href=\"#发送失败\" class=\"headerlink\" title=\"发送失败\"></a>发送失败</h3><p>如果这是第一次使用RabbitMQ，并且没有看到“Sent”信息（即“ [x] Sent ‘Hello World!”），也许你抓耳挠腮的想知道为什么出错了，也许是代理没有足够的硬盘空间（默认情况下需要至少1G的空间）导致拒绝接收信息。检查日志文件，有必要的花调低限值。<a href=\"http://www.rabbitmq.com/configure.html#config-items\" target=\"_blank\" rel=\"external\">这个配置文件</a>文档将会展示给你如何设置disk_free_limit。</p>\n<h3 id=\"接收\"><a href=\"#接收\" class=\"headerlink\" title=\"接收\"></a>接收</h3><p>收件人，与发送者只发送一条消息不同，接收者会一直运行以监听信息并输出。</p>\n<p><img src=\"/images/rabbitmq/receiving.png\" alt=\"\"></p>\n<p>receive.php中与send.php中的 include和use 部分的代码一样。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">require_once __DIR__ . &apos;/vendor/autoload.php&apos;;</div><div class=\"line\">use PhpAmqpLib\\Connection\\AMQPStreamConnection;</div></pre></td></tr></table></figure>\n<p>设置连接与send.php一样，打开连接和频道，命名一个队列，需要注意的是，队列名需要与send.php所发布的队列的名字一致。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">$connection = new AMQPStreamConnection(&apos;localhost&apos;, 5672, &apos;guest&apos;, &apos;guest&apos;);</div><div class=\"line\">$channel = $connection-&gt;channel();</div><div class=\"line\"></div><div class=\"line\">$channel-&gt;queue_declare(&apos;hello&apos;, false, false, false, false);</div><div class=\"line\"></div><div class=\"line\">echo &apos; [*] Waiting for messages. To exit press CTRL+C&apos;, &quot;\\n&quot;;</div></pre></td></tr></table></figure>\n<p>注意，我们在此声明了一个队列，因为有可能会在send程序开启前先开启receive程序，我们想要确保在试着接收消息之前队列就已经存在了。</p>\n<p>下一步，告诉服务器去从队列传送消息，我们会定义一个用于从服务器接收消息的函数，记住，消息会异步的从服务器发送到客户端。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\">$callback = function($msg) &#123;</div><div class=\"line\">  echo &quot; [x] Received &quot;, $msg-&gt;body, &quot;\\n&quot;;</div><div class=\"line\">&#125;;</div><div class=\"line\"></div><div class=\"line\">$channel-&gt;basic_consume(&apos;hello&apos;, &apos;&apos;, false, true, false, false, $callback);</div><div class=\"line\"></div><div class=\"line\">while(count($channel-&gt;callbacks)) &#123;</div><div class=\"line\">    $channel-&gt;wait();</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>此处使用while方法，当收到消息时，会把收到的消息传入到$callback方法里。</p>\n<p><a href=\"https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/php/receive.php\" target=\"_blank\" rel=\"external\">这是receive.php类的全部内容。</a></p>\n<p>现在我们可以运行两段脚本了，在命令行里，执行sender程序。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">php send.php</div></pre></td></tr></table></figure>\n<p>然后，执行receiver程序</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">php receive.php</div></pre></td></tr></table></figure>\n<p>receiver程序会把通过sender程序发送的内容打印出来，receiver程序会一直运行，监听新消息（使用ctrl+c停止），所以试着运行sender程序从另一个命令行。</p>\n<p>如果想查看队列，可以运行rabbitmqctl list_queues。</p>\n<p>Hello World！</p>\n<p>查看第二部分，建立一个简单的队列。</p>\n<p>原文地址：<a href=\"https://www.rabbitmq.com/tutorials/tutorial-one-php.html\" target=\"_blank\" rel=\"external\">“Hello World!”</a></p>\n"},{"title":"PHP RabbitMQ 教程（四） - 路由","date":"2016-04-24T06:16:41.000Z","_content":"\n### 路由\n（使用[php-amqplib](https://github.com/php-amqplib/php-amqplib)）\n在[上一节](/2016/04/23/php-rabbitmq-tutorial-three.html)中，我们创建了一个简单的日志系统（logging system）。我们已经可以广播日志消息到多个接收者了。\n\n在本节中，我们要给它增加一个功能-使它能够只订阅消息的一个子集。比如，只把严重的错误信息写入到日志文件（存储到磁盘）中，但同时仍然会把所有日志信息输出到控制台中。\n\n### 绑定\n\n在上一节中我们已经创建了绑定（bindings），代码如下：\n\n```\n$channel->queue_bind($queue_name,'logs');\n```\n\n绑定（bindings）是指交换器（exchange）和队列（queue）的关系。可以简单的理解为：这个队列对这个交换器中的消息感兴趣。\n\n绑定的时候可以带一个额外的 routing_key 参数。为了避免与$channel::basic_publish的参数混淆，我们把它叫做 binding_key，所以我们这样使用key创建一个绑定：\n\n```\n$binding_key = 'black';\n$channel->queue_bind($queue_name,$exchange_name,$binding_key);\n```\n\nbinding key的意义取决于交换器的类型。我们之前使用过的fanout类型的交换器，会忽略这个值。\n\n### Direct 交换器\n\n之前创建的日志系统分发所有消息到所有的消费者。我们打算扩展一下，使它可以过滤严重的消息。比如，我们只想在接收到严重错误的时候才写入到磁盘中，不在警告或普通的消息上浪费磁盘空间。\n\n我们使用的是没有太多扩展性的fanout交换器，它仅能够简单的广播消息。\n\n我们将要使用一个direct交换器代替fanout交换器。路由算法很简单-只有binding key完全匹配routing key的消息会进入队列。\n\n为了说明，考虑如下的场景：\n\n![][image-1]\n\n在这个场景中，我们可以看到direct类型的交换器X有两个队列，第一个队列使用orange作为binding key，第二个队列有两个绑定，一个是black另一个是green。\n\n在这个场景中，当routing key为orange的消息发送到交换器，将会被路由到队列Q1。routing key为black或green的消息将会发送到Q2。其他的消息则会被丢弃。\n\n### 多个绑定\n![][image-2]\n\n使用相同的binding key绑定多个队列是合法的。在这个例子中，我们会使用black作为binding key为X和Q1之间添加一个绑定。这样一来，direct 交换器就表现得跟fanout交换器一样，分发消息到匹配的队列。routing key为black的消息就会被分发到Q1和Q2。\n### 发送日志\n\n我们将要对日志系统使用这个模型，我们将要发送消息到一个direct交换器。将日志级别作为routing key。这样一来接收端程序就可以选择它想要接收的消息了。首先来看看发送日志。\n\n和以往一样，需要创建一个交换器：\n\n```\n$channel->exchange_declare('direct_logs','direct',false,false,false);\n```\n\n然后准备发送消息：\n\n```\n$channel->exchange_declare('direct_logs','direct',false,false,false);\n$channel->basic_publish($msg,'direct_logs',$severity);\n```\n为了简化，我们可以假定'severity'的值可以是'info','warning','error'中的一个。\n\n### 订阅\n接收消息的脚本会跟之前一样正常工作，但是我们准备为每一个我们感兴趣的日志级别创建一个新的绑定。\n\n```\nforeach($severities as $severity){\n\t$channel->queue_bind($queue_name,'direct_logs',$severity);\n}\n```\n\n### 整合\n\n![][image-3]\n\nemit_log_direct.php类的代码为：\n\n```php\n<?php\nrequire_once __DIR__ . '/vendor/autoload.php';\nuse PhpAmqpLib\\Connection\\AMQPStreamConnection;\nuse PhpAmqpLib\\Message\\AMQPMessage;\n\n$connection = new AMQPStremConnection('localhost',5672,'guest','guest');\n$channel = $connection->channel();\n\n$channel->exchange_declare('direct_logs','direct',false,false,false);\n\n$severity = isset($argv[1]) && !empty($argv[1]) ? $argv[1] : 'info';\n\n$data = implode(' ',array_slice($argv,2));\nif(empty($data)) $data = “Hello World!”;\n\n$msg = “[x] Sent ”,$severity,':',$data,” \\n”;\n\n$channel->close();\n$connection->close();\n?>\n```\n\nreceive_logs_direct.php的代码为：\n\n```php\n<?php\n\nrequire_once __DIR__ . '/vendor/autoload.php';\nuse PhpAmqpLib\\Connection\\AMQPStreamConnection;\n\n$connection = new AMQPStreamConnection('localhost',5672,'guest','guest');\n$channel = $connection->channel();\n\n$channel->exchange_declare('direct_logs','direct',false,false,false);\n\nlist($queue_name, ,) = $channel->queue_declare(“”,false,false,true,false);\n\n$severities = array_slice($argv,1);\nif(empty($severities)){\n\tfile_put_contents('php://stderr',”Usage:$argv[0][info][warning][error]\\n”);\n\texit(1);\n}\n\nforeach($severities as $severity){\n\t$channel->queue_bind($queue_name,'direct_logs',$severity);\n}\n\necho '[*]Waiting for logs.To exit press CTRL+C',”\\n”;\n\n$callback = function($msg){\n\techo '[*]',$msg->delivery_info['routing_key'],':',$msg->body,”\\n”;\t\n};\n\n$channel->basic_consume($queue_name,'',false,true,false,false,$callback);\n\nwhile(count($channel->callbacks)){\n\t$channel->wait();\n}\n\n$channel->close();\n$connection->close();\n?>\n```\n\n如果你想只保存'warning'或'error'（而不是'info'）级别的消息，只需要打开命令行输入：\n\n```\nphp receive_logs_direct.php warning error > logs_from_rabbit.log\n```\n\n如果你想在屏幕上输出所有的消息，打开一个新的终端，输入：\n\n```php\nphp receive_logs_direct.php info warning error\n[*]Waiting for logs.To exit press CTRL+C\n```\n\n例如，发送error消息，输入：\n\n```\nphp emit_log_direct.php error \"Run. Run. Or it will explode.\"\n[x] Sent 'error':'Run. Run. Or it will explode.'\n```\n\n[emit_log_direct.php源码](https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/php/emit_log_direct.php)  [receive_logs_direct.php源码](https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/php/receive_logs_direct.php)\n\n转到第五节，查看如何监听基于模式的消息。\n\n原文地址：[Routing](https://www.rabbitmq.com/tutorials/tutorial-four-php.html)\n\n[image-1]: /images/rabbitmq/direct-exchange.png\n[image-2]: /images/rabbitmq/direct-exchange-multiple.png\n[image-3]: /images/rabbitmq/python-four.png","source":"_posts/php-rabbitmq-tutorial-four.md","raw":"title: PHP RabbitMQ 教程（四） - 路由\ncategories: php\ndate: 2016-04-24 14:16:41\ntags:  [php,rabbitmq]\n\n---\n\n### 路由\n（使用[php-amqplib](https://github.com/php-amqplib/php-amqplib)）\n在[上一节](/2016/04/23/php-rabbitmq-tutorial-three.html)中，我们创建了一个简单的日志系统（logging system）。我们已经可以广播日志消息到多个接收者了。\n\n在本节中，我们要给它增加一个功能-使它能够只订阅消息的一个子集。比如，只把严重的错误信息写入到日志文件（存储到磁盘）中，但同时仍然会把所有日志信息输出到控制台中。\n\n### 绑定\n\n在上一节中我们已经创建了绑定（bindings），代码如下：\n\n```\n$channel->queue_bind($queue_name,'logs');\n```\n\n绑定（bindings）是指交换器（exchange）和队列（queue）的关系。可以简单的理解为：这个队列对这个交换器中的消息感兴趣。\n\n绑定的时候可以带一个额外的 routing_key 参数。为了避免与$channel::basic_publish的参数混淆，我们把它叫做 binding_key，所以我们这样使用key创建一个绑定：\n\n```\n$binding_key = 'black';\n$channel->queue_bind($queue_name,$exchange_name,$binding_key);\n```\n\nbinding key的意义取决于交换器的类型。我们之前使用过的fanout类型的交换器，会忽略这个值。\n\n### Direct 交换器\n\n之前创建的日志系统分发所有消息到所有的消费者。我们打算扩展一下，使它可以过滤严重的消息。比如，我们只想在接收到严重错误的时候才写入到磁盘中，不在警告或普通的消息上浪费磁盘空间。\n\n我们使用的是没有太多扩展性的fanout交换器，它仅能够简单的广播消息。\n\n我们将要使用一个direct交换器代替fanout交换器。路由算法很简单-只有binding key完全匹配routing key的消息会进入队列。\n\n为了说明，考虑如下的场景：\n\n![][image-1]\n\n在这个场景中，我们可以看到direct类型的交换器X有两个队列，第一个队列使用orange作为binding key，第二个队列有两个绑定，一个是black另一个是green。\n\n在这个场景中，当routing key为orange的消息发送到交换器，将会被路由到队列Q1。routing key为black或green的消息将会发送到Q2。其他的消息则会被丢弃。\n\n### 多个绑定\n![][image-2]\n\n使用相同的binding key绑定多个队列是合法的。在这个例子中，我们会使用black作为binding key为X和Q1之间添加一个绑定。这样一来，direct 交换器就表现得跟fanout交换器一样，分发消息到匹配的队列。routing key为black的消息就会被分发到Q1和Q2。\n### 发送日志\n\n我们将要对日志系统使用这个模型，我们将要发送消息到一个direct交换器。将日志级别作为routing key。这样一来接收端程序就可以选择它想要接收的消息了。首先来看看发送日志。\n\n和以往一样，需要创建一个交换器：\n\n```\n$channel->exchange_declare('direct_logs','direct',false,false,false);\n```\n\n然后准备发送消息：\n\n```\n$channel->exchange_declare('direct_logs','direct',false,false,false);\n$channel->basic_publish($msg,'direct_logs',$severity);\n```\n为了简化，我们可以假定'severity'的值可以是'info','warning','error'中的一个。\n\n### 订阅\n接收消息的脚本会跟之前一样正常工作，但是我们准备为每一个我们感兴趣的日志级别创建一个新的绑定。\n\n```\nforeach($severities as $severity){\n\t$channel->queue_bind($queue_name,'direct_logs',$severity);\n}\n```\n\n### 整合\n\n![][image-3]\n\nemit_log_direct.php类的代码为：\n\n```php\n<?php\nrequire_once __DIR__ . '/vendor/autoload.php';\nuse PhpAmqpLib\\Connection\\AMQPStreamConnection;\nuse PhpAmqpLib\\Message\\AMQPMessage;\n\n$connection = new AMQPStremConnection('localhost',5672,'guest','guest');\n$channel = $connection->channel();\n\n$channel->exchange_declare('direct_logs','direct',false,false,false);\n\n$severity = isset($argv[1]) && !empty($argv[1]) ? $argv[1] : 'info';\n\n$data = implode(' ',array_slice($argv,2));\nif(empty($data)) $data = “Hello World!”;\n\n$msg = “[x] Sent ”,$severity,':',$data,” \\n”;\n\n$channel->close();\n$connection->close();\n?>\n```\n\nreceive_logs_direct.php的代码为：\n\n```php\n<?php\n\nrequire_once __DIR__ . '/vendor/autoload.php';\nuse PhpAmqpLib\\Connection\\AMQPStreamConnection;\n\n$connection = new AMQPStreamConnection('localhost',5672,'guest','guest');\n$channel = $connection->channel();\n\n$channel->exchange_declare('direct_logs','direct',false,false,false);\n\nlist($queue_name, ,) = $channel->queue_declare(“”,false,false,true,false);\n\n$severities = array_slice($argv,1);\nif(empty($severities)){\n\tfile_put_contents('php://stderr',”Usage:$argv[0][info][warning][error]\\n”);\n\texit(1);\n}\n\nforeach($severities as $severity){\n\t$channel->queue_bind($queue_name,'direct_logs',$severity);\n}\n\necho '[*]Waiting for logs.To exit press CTRL+C',”\\n”;\n\n$callback = function($msg){\n\techo '[*]',$msg->delivery_info['routing_key'],':',$msg->body,”\\n”;\t\n};\n\n$channel->basic_consume($queue_name,'',false,true,false,false,$callback);\n\nwhile(count($channel->callbacks)){\n\t$channel->wait();\n}\n\n$channel->close();\n$connection->close();\n?>\n```\n\n如果你想只保存'warning'或'error'（而不是'info'）级别的消息，只需要打开命令行输入：\n\n```\nphp receive_logs_direct.php warning error > logs_from_rabbit.log\n```\n\n如果你想在屏幕上输出所有的消息，打开一个新的终端，输入：\n\n```php\nphp receive_logs_direct.php info warning error\n[*]Waiting for logs.To exit press CTRL+C\n```\n\n例如，发送error消息，输入：\n\n```\nphp emit_log_direct.php error \"Run. Run. Or it will explode.\"\n[x] Sent 'error':'Run. Run. Or it will explode.'\n```\n\n[emit_log_direct.php源码](https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/php/emit_log_direct.php)  [receive_logs_direct.php源码](https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/php/receive_logs_direct.php)\n\n转到第五节，查看如何监听基于模式的消息。\n\n原文地址：[Routing](https://www.rabbitmq.com/tutorials/tutorial-four-php.html)\n\n[image-1]: /images/rabbitmq/direct-exchange.png\n[image-2]: /images/rabbitmq/direct-exchange-multiple.png\n[image-3]: /images/rabbitmq/python-four.png","slug":"php-rabbitmq-tutorial-four","published":1,"updated":"2016-05-07T14:06:15.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj830jvef002dul0ro3jk3gq4","content":"<h3 id=\"路由\"><a href=\"#路由\" class=\"headerlink\" title=\"路由\"></a>路由</h3><p>（使用<a href=\"https://github.com/php-amqplib/php-amqplib\" target=\"_blank\" rel=\"external\">php-amqplib</a>）<br>在<a href=\"/2016/04/23/php-rabbitmq-tutorial-three.html\">上一节</a>中，我们创建了一个简单的日志系统（logging system）。我们已经可以广播日志消息到多个接收者了。</p>\n<p>在本节中，我们要给它增加一个功能-使它能够只订阅消息的一个子集。比如，只把严重的错误信息写入到日志文件（存储到磁盘）中，但同时仍然会把所有日志信息输出到控制台中。</p>\n<h3 id=\"绑定\"><a href=\"#绑定\" class=\"headerlink\" title=\"绑定\"></a>绑定</h3><p>在上一节中我们已经创建了绑定（bindings），代码如下：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$channel-&gt;queue_bind($queue_name,&apos;logs&apos;);</div></pre></td></tr></table></figure>\n<p>绑定（bindings）是指交换器（exchange）和队列（queue）的关系。可以简单的理解为：这个队列对这个交换器中的消息感兴趣。</p>\n<p>绑定的时候可以带一个额外的 routing_key 参数。为了避免与$channel::basic_publish的参数混淆，我们把它叫做 binding_key，所以我们这样使用key创建一个绑定：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">$binding_key = &apos;black&apos;;</div><div class=\"line\">$channel-&gt;queue_bind($queue_name,$exchange_name,$binding_key);</div></pre></td></tr></table></figure>\n<p>binding key的意义取决于交换器的类型。我们之前使用过的fanout类型的交换器，会忽略这个值。</p>\n<h3 id=\"Direct-交换器\"><a href=\"#Direct-交换器\" class=\"headerlink\" title=\"Direct 交换器\"></a>Direct 交换器</h3><p>之前创建的日志系统分发所有消息到所有的消费者。我们打算扩展一下，使它可以过滤严重的消息。比如，我们只想在接收到严重错误的时候才写入到磁盘中，不在警告或普通的消息上浪费磁盘空间。</p>\n<p>我们使用的是没有太多扩展性的fanout交换器，它仅能够简单的广播消息。</p>\n<p>我们将要使用一个direct交换器代替fanout交换器。路由算法很简单-只有binding key完全匹配routing key的消息会进入队列。</p>\n<p>为了说明，考虑如下的场景：</p>\n<p><img src=\"/images/rabbitmq/direct-exchange.png\" alt=\"\"></p>\n<p>在这个场景中，我们可以看到direct类型的交换器X有两个队列，第一个队列使用orange作为binding key，第二个队列有两个绑定，一个是black另一个是green。</p>\n<p>在这个场景中，当routing key为orange的消息发送到交换器，将会被路由到队列Q1。routing key为black或green的消息将会发送到Q2。其他的消息则会被丢弃。</p>\n<h3 id=\"多个绑定\"><a href=\"#多个绑定\" class=\"headerlink\" title=\"多个绑定\"></a>多个绑定</h3><p><img src=\"/images/rabbitmq/direct-exchange-multiple.png\" alt=\"\"></p>\n<p>使用相同的binding key绑定多个队列是合法的。在这个例子中，我们会使用black作为binding key为X和Q1之间添加一个绑定。这样一来，direct 交换器就表现得跟fanout交换器一样，分发消息到匹配的队列。routing key为black的消息就会被分发到Q1和Q2。</p>\n<h3 id=\"发送日志\"><a href=\"#发送日志\" class=\"headerlink\" title=\"发送日志\"></a>发送日志</h3><p>我们将要对日志系统使用这个模型，我们将要发送消息到一个direct交换器。将日志级别作为routing key。这样一来接收端程序就可以选择它想要接收的消息了。首先来看看发送日志。</p>\n<p>和以往一样，需要创建一个交换器：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$channel-&gt;exchange_declare(&apos;direct_logs&apos;,&apos;direct&apos;,false,false,false);</div></pre></td></tr></table></figure>\n<p>然后准备发送消息：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">$channel-&gt;exchange_declare(&apos;direct_logs&apos;,&apos;direct&apos;,false,false,false);</div><div class=\"line\">$channel-&gt;basic_publish($msg,&apos;direct_logs&apos;,$severity);</div></pre></td></tr></table></figure>\n<p>为了简化，我们可以假定’severity’的值可以是’info’,’warning’,’error’中的一个。</p>\n<h3 id=\"订阅\"><a href=\"#订阅\" class=\"headerlink\" title=\"订阅\"></a>订阅</h3><p>接收消息的脚本会跟之前一样正常工作，但是我们准备为每一个我们感兴趣的日志级别创建一个新的绑定。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">foreach($severities as $severity)&#123;</div><div class=\"line\">\t$channel-&gt;queue_bind($queue_name,&apos;direct_logs&apos;,$severity);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h3 id=\"整合\"><a href=\"#整合\" class=\"headerlink\" title=\"整合\"></a>整合</h3><p><img src=\"/images/rabbitmq/python-four.png\" alt=\"\"></p>\n<p>emit_log_direct.php类的代码为：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\"><span class=\"keyword\">require_once</span> <span class=\"keyword\">__DIR__</span> . <span class=\"string\">'/vendor/autoload.php'</span>;</div><div class=\"line\"><span class=\"keyword\">use</span> <span class=\"title\">PhpAmqpLib</span>\\<span class=\"title\">Connection</span>\\<span class=\"title\">AMQPStreamConnection</span>;</div><div class=\"line\"><span class=\"keyword\">use</span> <span class=\"title\">PhpAmqpLib</span>\\<span class=\"title\">Message</span>\\<span class=\"title\">AMQPMessage</span>;</div><div class=\"line\"></div><div class=\"line\">$connection = <span class=\"keyword\">new</span> AMQPStremConnection(<span class=\"string\">'localhost'</span>,<span class=\"number\">5672</span>,<span class=\"string\">'guest'</span>,<span class=\"string\">'guest'</span>);</div><div class=\"line\">$channel = $connection-&gt;channel();</div><div class=\"line\"></div><div class=\"line\">$channel-&gt;exchange_declare(<span class=\"string\">'direct_logs'</span>,<span class=\"string\">'direct'</span>,<span class=\"keyword\">false</span>,<span class=\"keyword\">false</span>,<span class=\"keyword\">false</span>);</div><div class=\"line\"></div><div class=\"line\">$severity = <span class=\"keyword\">isset</span>($argv[<span class=\"number\">1</span>]) &amp;&amp; !<span class=\"keyword\">empty</span>($argv[<span class=\"number\">1</span>]) ? $argv[<span class=\"number\">1</span>] : <span class=\"string\">'info'</span>;</div><div class=\"line\"></div><div class=\"line\">$data = implode(<span class=\"string\">' '</span>,array_slice($argv,<span class=\"number\">2</span>));</div><div class=\"line\"><span class=\"keyword\">if</span>(<span class=\"keyword\">empty</span>($data)) $data = “Hello World!”;</div><div class=\"line\"></div><div class=\"line\">$msg = “[x] Sent ”,$severity,<span class=\"string\">':'</span>,$data,” \\n”;</div><div class=\"line\"></div><div class=\"line\">$channel-&gt;close();</div><div class=\"line\">$connection-&gt;close();</div><div class=\"line\"><span class=\"meta\">?&gt;</span></div></pre></td></tr></table></figure>\n<p>receive_logs_direct.php的代码为：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">require_once</span> <span class=\"keyword\">__DIR__</span> . <span class=\"string\">'/vendor/autoload.php'</span>;</div><div class=\"line\"><span class=\"keyword\">use</span> <span class=\"title\">PhpAmqpLib</span>\\<span class=\"title\">Connection</span>\\<span class=\"title\">AMQPStreamConnection</span>;</div><div class=\"line\"></div><div class=\"line\">$connection = <span class=\"keyword\">new</span> AMQPStreamConnection(<span class=\"string\">'localhost'</span>,<span class=\"number\">5672</span>,<span class=\"string\">'guest'</span>,<span class=\"string\">'guest'</span>);</div><div class=\"line\">$channel = $connection-&gt;channel();</div><div class=\"line\"></div><div class=\"line\">$channel-&gt;exchange_declare(<span class=\"string\">'direct_logs'</span>,<span class=\"string\">'direct'</span>,<span class=\"keyword\">false</span>,<span class=\"keyword\">false</span>,<span class=\"keyword\">false</span>);</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">list</span>($queue_name, ,) = $channel-&gt;queue_declare(“”,<span class=\"keyword\">false</span>,<span class=\"keyword\">false</span>,<span class=\"keyword\">true</span>,<span class=\"keyword\">false</span>);</div><div class=\"line\"></div><div class=\"line\">$severities = array_slice($argv,<span class=\"number\">1</span>);</div><div class=\"line\"><span class=\"keyword\">if</span>(<span class=\"keyword\">empty</span>($severities))&#123;</div><div class=\"line\">\tfile_put_contents(<span class=\"string\">'php://stderr'</span>,”Usage:$argv[<span class=\"number\">0</span>][info][warning][error]\\n”);</div><div class=\"line\">\t<span class=\"keyword\">exit</span>(<span class=\"number\">1</span>);</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">foreach</span>($severities <span class=\"keyword\">as</span> $severity)&#123;</div><div class=\"line\">\t$channel-&gt;queue_bind($queue_name,<span class=\"string\">'direct_logs'</span>,$severity);</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">echo</span> <span class=\"string\">'[*]Waiting for logs.To exit press CTRL+C'</span>,”\\n”;</div><div class=\"line\"></div><div class=\"line\">$callback = <span class=\"function\"><span class=\"keyword\">function</span><span class=\"params\">($msg)</span></span>&#123;</div><div class=\"line\">\t<span class=\"keyword\">echo</span> <span class=\"string\">'[*]'</span>,$msg-&gt;delivery_info[<span class=\"string\">'routing_key'</span>],<span class=\"string\">':'</span>,$msg-&gt;body,”\\n”;\t</div><div class=\"line\">&#125;;</div><div class=\"line\"></div><div class=\"line\">$channel-&gt;basic_consume($queue_name,<span class=\"string\">''</span>,<span class=\"keyword\">false</span>,<span class=\"keyword\">true</span>,<span class=\"keyword\">false</span>,<span class=\"keyword\">false</span>,$callback);</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">while</span>(count($channel-&gt;callbacks))&#123;</div><div class=\"line\">\t$channel-&gt;wait();</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\">$channel-&gt;close();</div><div class=\"line\">$connection-&gt;close();</div><div class=\"line\"><span class=\"meta\">?&gt;</span></div></pre></td></tr></table></figure>\n<p>如果你想只保存’warning’或’error’（而不是’info’）级别的消息，只需要打开命令行输入：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">php receive_logs_direct.php warning error &gt; logs_from_rabbit.log</div></pre></td></tr></table></figure>\n<p>如果你想在屏幕上输出所有的消息，打开一个新的终端，输入：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">php receive_logs_direct.php info warning error</div><div class=\"line\">[*]Waiting <span class=\"keyword\">for</span> logs.To <span class=\"keyword\">exit</span> press CTRL+C</div></pre></td></tr></table></figure>\n<p>例如，发送error消息，输入：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">php emit_log_direct.php error &quot;Run. Run. Or it will explode.&quot;</div><div class=\"line\">[x] Sent &apos;error&apos;:&apos;Run. Run. Or it will explode.&apos;</div></pre></td></tr></table></figure>\n<p><a href=\"https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/php/emit_log_direct.php\" target=\"_blank\" rel=\"external\">emit_log_direct.php源码</a>  <a href=\"https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/php/receive_logs_direct.php\" target=\"_blank\" rel=\"external\">receive_logs_direct.php源码</a></p>\n<p>转到第五节，查看如何监听基于模式的消息。</p>\n<p>原文地址：<a href=\"https://www.rabbitmq.com/tutorials/tutorial-four-php.html\" target=\"_blank\" rel=\"external\">Routing</a></p>\n","site":{"data":{}},"excerpt":"","more":"<h3 id=\"路由\"><a href=\"#路由\" class=\"headerlink\" title=\"路由\"></a>路由</h3><p>（使用<a href=\"https://github.com/php-amqplib/php-amqplib\" target=\"_blank\" rel=\"external\">php-amqplib</a>）<br>在<a href=\"/2016/04/23/php-rabbitmq-tutorial-three.html\">上一节</a>中，我们创建了一个简单的日志系统（logging system）。我们已经可以广播日志消息到多个接收者了。</p>\n<p>在本节中，我们要给它增加一个功能-使它能够只订阅消息的一个子集。比如，只把严重的错误信息写入到日志文件（存储到磁盘）中，但同时仍然会把所有日志信息输出到控制台中。</p>\n<h3 id=\"绑定\"><a href=\"#绑定\" class=\"headerlink\" title=\"绑定\"></a>绑定</h3><p>在上一节中我们已经创建了绑定（bindings），代码如下：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$channel-&gt;queue_bind($queue_name,&apos;logs&apos;);</div></pre></td></tr></table></figure>\n<p>绑定（bindings）是指交换器（exchange）和队列（queue）的关系。可以简单的理解为：这个队列对这个交换器中的消息感兴趣。</p>\n<p>绑定的时候可以带一个额外的 routing_key 参数。为了避免与$channel::basic_publish的参数混淆，我们把它叫做 binding_key，所以我们这样使用key创建一个绑定：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">$binding_key = &apos;black&apos;;</div><div class=\"line\">$channel-&gt;queue_bind($queue_name,$exchange_name,$binding_key);</div></pre></td></tr></table></figure>\n<p>binding key的意义取决于交换器的类型。我们之前使用过的fanout类型的交换器，会忽略这个值。</p>\n<h3 id=\"Direct-交换器\"><a href=\"#Direct-交换器\" class=\"headerlink\" title=\"Direct 交换器\"></a>Direct 交换器</h3><p>之前创建的日志系统分发所有消息到所有的消费者。我们打算扩展一下，使它可以过滤严重的消息。比如，我们只想在接收到严重错误的时候才写入到磁盘中，不在警告或普通的消息上浪费磁盘空间。</p>\n<p>我们使用的是没有太多扩展性的fanout交换器，它仅能够简单的广播消息。</p>\n<p>我们将要使用一个direct交换器代替fanout交换器。路由算法很简单-只有binding key完全匹配routing key的消息会进入队列。</p>\n<p>为了说明，考虑如下的场景：</p>\n<p><img src=\"/images/rabbitmq/direct-exchange.png\" alt=\"\"></p>\n<p>在这个场景中，我们可以看到direct类型的交换器X有两个队列，第一个队列使用orange作为binding key，第二个队列有两个绑定，一个是black另一个是green。</p>\n<p>在这个场景中，当routing key为orange的消息发送到交换器，将会被路由到队列Q1。routing key为black或green的消息将会发送到Q2。其他的消息则会被丢弃。</p>\n<h3 id=\"多个绑定\"><a href=\"#多个绑定\" class=\"headerlink\" title=\"多个绑定\"></a>多个绑定</h3><p><img src=\"/images/rabbitmq/direct-exchange-multiple.png\" alt=\"\"></p>\n<p>使用相同的binding key绑定多个队列是合法的。在这个例子中，我们会使用black作为binding key为X和Q1之间添加一个绑定。这样一来，direct 交换器就表现得跟fanout交换器一样，分发消息到匹配的队列。routing key为black的消息就会被分发到Q1和Q2。</p>\n<h3 id=\"发送日志\"><a href=\"#发送日志\" class=\"headerlink\" title=\"发送日志\"></a>发送日志</h3><p>我们将要对日志系统使用这个模型，我们将要发送消息到一个direct交换器。将日志级别作为routing key。这样一来接收端程序就可以选择它想要接收的消息了。首先来看看发送日志。</p>\n<p>和以往一样，需要创建一个交换器：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$channel-&gt;exchange_declare(&apos;direct_logs&apos;,&apos;direct&apos;,false,false,false);</div></pre></td></tr></table></figure>\n<p>然后准备发送消息：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">$channel-&gt;exchange_declare(&apos;direct_logs&apos;,&apos;direct&apos;,false,false,false);</div><div class=\"line\">$channel-&gt;basic_publish($msg,&apos;direct_logs&apos;,$severity);</div></pre></td></tr></table></figure>\n<p>为了简化，我们可以假定’severity’的值可以是’info’,’warning’,’error’中的一个。</p>\n<h3 id=\"订阅\"><a href=\"#订阅\" class=\"headerlink\" title=\"订阅\"></a>订阅</h3><p>接收消息的脚本会跟之前一样正常工作，但是我们准备为每一个我们感兴趣的日志级别创建一个新的绑定。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">foreach($severities as $severity)&#123;</div><div class=\"line\">\t$channel-&gt;queue_bind($queue_name,&apos;direct_logs&apos;,$severity);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h3 id=\"整合\"><a href=\"#整合\" class=\"headerlink\" title=\"整合\"></a>整合</h3><p><img src=\"/images/rabbitmq/python-four.png\" alt=\"\"></p>\n<p>emit_log_direct.php类的代码为：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\"><span class=\"keyword\">require_once</span> <span class=\"keyword\">__DIR__</span> . <span class=\"string\">'/vendor/autoload.php'</span>;</div><div class=\"line\"><span class=\"keyword\">use</span> <span class=\"title\">PhpAmqpLib</span>\\<span class=\"title\">Connection</span>\\<span class=\"title\">AMQPStreamConnection</span>;</div><div class=\"line\"><span class=\"keyword\">use</span> <span class=\"title\">PhpAmqpLib</span>\\<span class=\"title\">Message</span>\\<span class=\"title\">AMQPMessage</span>;</div><div class=\"line\"></div><div class=\"line\">$connection = <span class=\"keyword\">new</span> AMQPStremConnection(<span class=\"string\">'localhost'</span>,<span class=\"number\">5672</span>,<span class=\"string\">'guest'</span>,<span class=\"string\">'guest'</span>);</div><div class=\"line\">$channel = $connection-&gt;channel();</div><div class=\"line\"></div><div class=\"line\">$channel-&gt;exchange_declare(<span class=\"string\">'direct_logs'</span>,<span class=\"string\">'direct'</span>,<span class=\"keyword\">false</span>,<span class=\"keyword\">false</span>,<span class=\"keyword\">false</span>);</div><div class=\"line\"></div><div class=\"line\">$severity = <span class=\"keyword\">isset</span>($argv[<span class=\"number\">1</span>]) &amp;&amp; !<span class=\"keyword\">empty</span>($argv[<span class=\"number\">1</span>]) ? $argv[<span class=\"number\">1</span>] : <span class=\"string\">'info'</span>;</div><div class=\"line\"></div><div class=\"line\">$data = implode(<span class=\"string\">' '</span>,array_slice($argv,<span class=\"number\">2</span>));</div><div class=\"line\"><span class=\"keyword\">if</span>(<span class=\"keyword\">empty</span>($data)) $data = “Hello World!”;</div><div class=\"line\"></div><div class=\"line\">$msg = “[x] Sent ”,$severity,<span class=\"string\">':'</span>,$data,” \\n”;</div><div class=\"line\"></div><div class=\"line\">$channel-&gt;close();</div><div class=\"line\">$connection-&gt;close();</div><div class=\"line\"><span class=\"meta\">?&gt;</span></div></pre></td></tr></table></figure>\n<p>receive_logs_direct.php的代码为：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">require_once</span> <span class=\"keyword\">__DIR__</span> . <span class=\"string\">'/vendor/autoload.php'</span>;</div><div class=\"line\"><span class=\"keyword\">use</span> <span class=\"title\">PhpAmqpLib</span>\\<span class=\"title\">Connection</span>\\<span class=\"title\">AMQPStreamConnection</span>;</div><div class=\"line\"></div><div class=\"line\">$connection = <span class=\"keyword\">new</span> AMQPStreamConnection(<span class=\"string\">'localhost'</span>,<span class=\"number\">5672</span>,<span class=\"string\">'guest'</span>,<span class=\"string\">'guest'</span>);</div><div class=\"line\">$channel = $connection-&gt;channel();</div><div class=\"line\"></div><div class=\"line\">$channel-&gt;exchange_declare(<span class=\"string\">'direct_logs'</span>,<span class=\"string\">'direct'</span>,<span class=\"keyword\">false</span>,<span class=\"keyword\">false</span>,<span class=\"keyword\">false</span>);</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">list</span>($queue_name, ,) = $channel-&gt;queue_declare(“”,<span class=\"keyword\">false</span>,<span class=\"keyword\">false</span>,<span class=\"keyword\">true</span>,<span class=\"keyword\">false</span>);</div><div class=\"line\"></div><div class=\"line\">$severities = array_slice($argv,<span class=\"number\">1</span>);</div><div class=\"line\"><span class=\"keyword\">if</span>(<span class=\"keyword\">empty</span>($severities))&#123;</div><div class=\"line\">\tfile_put_contents(<span class=\"string\">'php://stderr'</span>,”Usage:$argv[<span class=\"number\">0</span>][info][warning][error]\\n”);</div><div class=\"line\">\t<span class=\"keyword\">exit</span>(<span class=\"number\">1</span>);</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">foreach</span>($severities <span class=\"keyword\">as</span> $severity)&#123;</div><div class=\"line\">\t$channel-&gt;queue_bind($queue_name,<span class=\"string\">'direct_logs'</span>,$severity);</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">echo</span> <span class=\"string\">'[*]Waiting for logs.To exit press CTRL+C'</span>,”\\n”;</div><div class=\"line\"></div><div class=\"line\">$callback = <span class=\"function\"><span class=\"keyword\">function</span><span class=\"params\">($msg)</span></span>&#123;</div><div class=\"line\">\t<span class=\"keyword\">echo</span> <span class=\"string\">'[*]'</span>,$msg-&gt;delivery_info[<span class=\"string\">'routing_key'</span>],<span class=\"string\">':'</span>,$msg-&gt;body,”\\n”;\t</div><div class=\"line\">&#125;;</div><div class=\"line\"></div><div class=\"line\">$channel-&gt;basic_consume($queue_name,<span class=\"string\">''</span>,<span class=\"keyword\">false</span>,<span class=\"keyword\">true</span>,<span class=\"keyword\">false</span>,<span class=\"keyword\">false</span>,$callback);</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">while</span>(count($channel-&gt;callbacks))&#123;</div><div class=\"line\">\t$channel-&gt;wait();</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\">$channel-&gt;close();</div><div class=\"line\">$connection-&gt;close();</div><div class=\"line\"><span class=\"meta\">?&gt;</span></div></pre></td></tr></table></figure>\n<p>如果你想只保存’warning’或’error’（而不是’info’）级别的消息，只需要打开命令行输入：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">php receive_logs_direct.php warning error &gt; logs_from_rabbit.log</div></pre></td></tr></table></figure>\n<p>如果你想在屏幕上输出所有的消息，打开一个新的终端，输入：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">php receive_logs_direct.php info warning error</div><div class=\"line\">[*]Waiting <span class=\"keyword\">for</span> logs.To <span class=\"keyword\">exit</span> press CTRL+C</div></pre></td></tr></table></figure>\n<p>例如，发送error消息，输入：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">php emit_log_direct.php error &quot;Run. Run. Or it will explode.&quot;</div><div class=\"line\">[x] Sent &apos;error&apos;:&apos;Run. Run. Or it will explode.&apos;</div></pre></td></tr></table></figure>\n<p><a href=\"https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/php/emit_log_direct.php\" target=\"_blank\" rel=\"external\">emit_log_direct.php源码</a>  <a href=\"https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/php/receive_logs_direct.php\" target=\"_blank\" rel=\"external\">receive_logs_direct.php源码</a></p>\n<p>转到第五节，查看如何监听基于模式的消息。</p>\n<p>原文地址：<a href=\"https://www.rabbitmq.com/tutorials/tutorial-four-php.html\" target=\"_blank\" rel=\"external\">Routing</a></p>\n"},{"title":"PHP RabbitMQ 教程（六） - 远程调用","date":"2016-05-03T06:35:20.000Z","_content":"\n### 远程调用\n\n在[第二节](/2016/04/17/php-rabbitmq-tutorial-two.html)中，我们学习了如何使用工作队列在多个worker中分发耗时任务。\n\n但是如果我们需要在远程运行一个函数并等待返回结果怎么办？这是两码事，这个模式通常被称为远程过程调用（Remote Procedure Call，RPC）。\n\n在本节中我们准备使用RabbitMQ构建一个RPC系统：一个客户端和一个可扩展的RPC服务端。由于我们没有值得分发的耗时任务，我们准备创建一个假的返回[斐波那契数列](https://en.wikipedia.org/wiki/Fibonacci_number)的RPC服务。\n\n### 客户端接口\n\n我们创建一个简单的客户端类来说明RPC服务如何使用。这个类会展示call方法如何发送一个RPC请求并且阻塞，直到接收到返回值。\n\n```php\n$fibonacci_rpc = new FibonacciRpcClient();\n$response = $fibonacci_rpc->call(30);\necho \"[.] Got \", $response, \"\\n\";\n```\n\n####  RPC注意事项\n\n尽管RPC在计算机学中很常见，但它十分挑剔。当程序员不知道是否是调用一个本地的方法还是一个很慢的RPC会出现这个问题。这样的困惑便导致不可预测的系统并增加不必要的调试复杂性。比起简化的软件，误用RPC会导致不可维护的无头绪代码。\n\n记住刚才的内容，考虑下面的建议：\n\n​\t确保可以明显的看出哪个方法调用的是本地的哪个是远程的。\n\n​\t系统文档化。让组件之间的依赖变得清晰可见。\n\n​\t错误处理。当RPC服务长时间关闭客户端该作何反应？\n\n如果有疑问，则尽量避免使用RPC。如果可以话，你应该使用异步管道——而不是RPC——像阻塞，结果被异步推送到下个计算阶段。\n\n###  回调队列\n\n通常在RabbitMQ上做RPC很简单。客户端发送请求消息，服务端回复消息。为了接收响应消息，我们需要在请求中附带一个\"callback\"队列地址，我们可以使用默认的队列。来试一试：\n\n```php\nlist($queue_name, ,) = $channel->queue_declare(\"\", false, false, true, false);\n\n$msg = new AMQPMessage(\n\t$payload,\n\tarray('reply_to' => $queue_name));\n\n$channel->basic_publish($msg, '', 'rpc_queue');\n\n# ... then code to read a response message from the callback_queue\n```\n\n####  消息属性\n\nAMQP协议定义了14个消息属性。大部分不常用，下面的除外：\n\n​\tdelivery_mode：值为2时表示持久化，1为临时的。也许你还记得这个属性来自第二节。\n\n​\tcontent_type：编码格式，比如经常用的JSON格式，良好的做法是设置为：application/json。\n\n​\treply_to：通常用来定义回调队列名称。\n\n​\tcorrelation_id：用来关联RPC的响应和请求。\n\n### Correlation Id\n\n在上面的方法中我们建议为每一个RPC请求创建一个回调队列。这样非常低效，但是幸运的是有更好的办法 - 我们可以为每一个客户端创建一个单独的回调队列。\n\n这样又带来一个新的问题，在队列接收到响应时，并不知道属于哪个请求。这也正是correlation_id属性要发挥的作用。我们为每一个请求的设定一个唯一的correlation_id值，然后，当在回调队列接收到消息时会查看它的属性，基于此，我们就可以把响应和请求进行匹配。如果发现一个未知的correlation_id值，可以安全的忽略掉这条消息 - 因为它不属于任何请求。\n\n也许你会问，为什么应该忽略回调队列里的未知消息，而不是返回一个错误？因为服务可能会出现紊乱的情况，虽然不太可能，但是如果发生这种情况，RPC服务会在发送完响应后挂掉，但是还没有进行消息确认。如果发生了，重启RPC服务后会再次处理这个请求。这就是为什么在客户端我们必须适当的处理重复请求，而RPC服务最好的幂等的。\n\n### 总结\n\n![](/images/rabbitmq/python-six.png)\n\nRPC工作流程：\n\n​\t当客户端开始运行时会创建一个匿名独有回调队列。\n\n​\tRPC请求中，客户端消息带有两个属性：reply_to用来设置回调队列，correlation_id用来唯一标识每一个请求。\n\n​\t请求被发送到rpc_queue队列。\n\n​\tRPC worker（又称worker）在队列中守护，等待新请求。当请求到达，它会进行处理，然后把结果以消息的形式发送回客户端的队列，队列名便是客户端消息带有的reply_to的值。\n\n​\t客户端等待回调队列中的数据。当消息到达，检查它的correlation_id的值。如果符合客户端发送给RPC服务器中请求的值，客户端会返回响应内容到应用中。\n\n### 整合\n\n斐波那契方法：\n\n```\nfunction fib($n){\n  if($n == 0)\n  \treturn 0;\n  if($n == 1)\n  \treturn 1;\n  return fib($n-1) + fib($n-2);\n}\n```\n\n定义完斐波那契方法。假定它仅接受数字类型的输入。（别期望它能处理大的数字，它很可能非常慢的处理完。）\n\nRPC服务处理程序rpc_server.php：\n\n```php\n<?php\n\nrequire_once __DIR__ . '/vendor/autoload.php';\nuse PhpAmqpLib\\Connection\\AMQPStreamConnection;\nuse PhpAmqpLib\\Message\\AMQPMessage;\n\n$connection = new AMQPStreamConnection('localhost', 5672, 'guest', 'guest');\n$channel = $connection->channel();\n\n$channel->queue_declare('rpc_queue', false, false, false, false);\n\nfuction fib($n){\n  if($n == 0)\n    return 0;\n  if($n == 1)\n    return 1;\n  \n  return fib($n-1) + fib($n-2);\n}\n\necho \" [x] Awaiting RPC requests\\n\";\n\n$callback = function($req){\n  $n = intval($req->body);\n  echo \" [.] fib(\",$n,\")\\n\";\n  \n  $msg = new AMQPMessage(\n  \t(string)fib($n),\n    array('correlation_id' => $req->get('correlation_id'))\n  );\n  \n  $req->delivery_info['channel']->basic_publish($msg, '', $req->get('reply_to'));\n  $req->delivery_info['channel']->basic_ack($req->delivery_info['delivery_tag']);\n};\n\n$channel->basic_qos(null, 1, null);\n$channel->basic_consume('rpc_queue', '', false, false, false, false, $callback);\n\nwhile(count($channel->callbacks)){\n  $channel->wait();\n}\n\n$channel->close();\n$connection->close();\n\n?>\n```\n\n服务端代码相当简单：\n\n​\t和以往一样我们会从创建连接，频道，和声明队列开始\n\n​\t也许我们想要运行更多的进程。为了在多个服务器之间负载均衡，需要在$channel.basic_qos中设置prefech_count；\n\n​\t我们使用basic_consume访问队列。然后进入while循环等待请求消息，处理，然后返回响应消息。\n\nRPC客户端 rpc_client.php：\n\n```php\n<?php\n\nrequire_once __DIR__ . '/vendor/autoload.php';\nuse PhpAmqpLib\\Connection\\AMQPStreamConnection;\nuse PhpAmqpLib\\Message\\AMQPMessage;\n\nclass FibonacciRpcClient{\n\tprivate $connection;\n\tprivate $channel;\n\tprivate $callback_queue;\n\tprivate $response;\n\tprivate $corr_id;\n  \n\tpublic function __construct(){\n\t\t$this->connection = new AMQPStreamConnection(\n\t\t  'localhost', 5672, 'guest', 'guest'\n\t\t);\n\t\t$this->channel = $this->connection->channel();\n\t\tlist($this->callback_queue, ,) = $this->channel->queue_declare(\"\", false, false, true, false);\n\t\t$this->channel->basic_consume(\n\t\t\t$this->callback_queue, '', false, false, false, false,\n\t\t\tarray($this, 'on_response'));\n\t}\n  \n \tpublic function on_response($req){\n \t\tif($req->get('correlation_id') == $this->corr_id){\n \t\t\t$this->response = $req->body;\n \t\t}\n \t}\n  \t\n\tpublic function call($n){\n\t\t$this->response = null;\n\t\t$this->corr_id = uniqid();\n\n\t\t$msg = new AMQPMessage(\n  \t\t(string) $n,\n  \t\tarray(\n  \t\t\t'correlation_id' => $this->corr_id,\n  \t\t\t'reply_to' => $this->callback_queue)\n  \t\t);\n    )\n      \n    $this->channel->basic_publish($msg, '', 'rpc_queue');\n    while(!$this->response){\n    \t$this->channel->wait();\n    }\n    return intval($this->response);\n  }\n};\n\n$fibonacci_rpc = new FibonacciRpcClient();\n$response = $fibonacci_rpc->call(30);\necho \" [.] Got \", $response, \"\\n\";\n\n?>\n```\n\n现在可以查看示例的完整代码了。[rpc_client.php](https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/php/rpc_client.php) 和 [rpc_server.php](https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/php/rpc_server.php)。\n\n现在RPC服务端可以运行了：\n\n```shell\nphp rpc_server.php\n[x] Awiting RPC resquests\n```\n\n接收斐波那契数列运行：\n\n```\nphp rpc_client.php\n[x] Requesting fib(30)\n```\n\n这里展现的并不是RPC服务的唯一可能实现，但它有一些重要的优势：\n\n​\t如果RPC服务太慢，可以按比例增加运行数量。试试在新控制台裕兴第二个rpc_server.php服务。\n\n​\t在客户端，RPC要求只发送和接收一条消息。不能有像队列声明一样的异步调用。结果就是，对于单一的RPC请求，客户端仅需要一个网络往返。\n\n现在的代码还是过于简单，并没有想解决更复杂（更重要）的问题，比如：\n\n​\t要是没有服务端守护运行，客户端作何反应？\n\n​\tRPC客户端是否需要设置超时？\n\n​\t如果服务端引发异常，是否该把它发送到客户端？\n\n​\t处理前阻止无效消息（如检查范围，类型）进入？\n\n如果想尝试，可以在[rabbitmq-management](https://www.rabbitmq.com/plugins.html) 里找到一些有用的查看队列的插件。\n\n\n\n原文地址：[Remote procedure call (RPC)](https://www.rabbitmq.com/tutorials/tutorial-six-php.html)","source":"_posts/php-rabbitmq-tutorial-six.md","raw":"title: PHP RabbitMQ 教程（六） - 远程调用\ncategories: php\ndate: 2016-05-03 14:35:20\ntags:  [php,rabbitmq]\n\n---\n\n### 远程调用\n\n在[第二节](/2016/04/17/php-rabbitmq-tutorial-two.html)中，我们学习了如何使用工作队列在多个worker中分发耗时任务。\n\n但是如果我们需要在远程运行一个函数并等待返回结果怎么办？这是两码事，这个模式通常被称为远程过程调用（Remote Procedure Call，RPC）。\n\n在本节中我们准备使用RabbitMQ构建一个RPC系统：一个客户端和一个可扩展的RPC服务端。由于我们没有值得分发的耗时任务，我们准备创建一个假的返回[斐波那契数列](https://en.wikipedia.org/wiki/Fibonacci_number)的RPC服务。\n\n### 客户端接口\n\n我们创建一个简单的客户端类来说明RPC服务如何使用。这个类会展示call方法如何发送一个RPC请求并且阻塞，直到接收到返回值。\n\n```php\n$fibonacci_rpc = new FibonacciRpcClient();\n$response = $fibonacci_rpc->call(30);\necho \"[.] Got \", $response, \"\\n\";\n```\n\n####  RPC注意事项\n\n尽管RPC在计算机学中很常见，但它十分挑剔。当程序员不知道是否是调用一个本地的方法还是一个很慢的RPC会出现这个问题。这样的困惑便导致不可预测的系统并增加不必要的调试复杂性。比起简化的软件，误用RPC会导致不可维护的无头绪代码。\n\n记住刚才的内容，考虑下面的建议：\n\n​\t确保可以明显的看出哪个方法调用的是本地的哪个是远程的。\n\n​\t系统文档化。让组件之间的依赖变得清晰可见。\n\n​\t错误处理。当RPC服务长时间关闭客户端该作何反应？\n\n如果有疑问，则尽量避免使用RPC。如果可以话，你应该使用异步管道——而不是RPC——像阻塞，结果被异步推送到下个计算阶段。\n\n###  回调队列\n\n通常在RabbitMQ上做RPC很简单。客户端发送请求消息，服务端回复消息。为了接收响应消息，我们需要在请求中附带一个\"callback\"队列地址，我们可以使用默认的队列。来试一试：\n\n```php\nlist($queue_name, ,) = $channel->queue_declare(\"\", false, false, true, false);\n\n$msg = new AMQPMessage(\n\t$payload,\n\tarray('reply_to' => $queue_name));\n\n$channel->basic_publish($msg, '', 'rpc_queue');\n\n# ... then code to read a response message from the callback_queue\n```\n\n####  消息属性\n\nAMQP协议定义了14个消息属性。大部分不常用，下面的除外：\n\n​\tdelivery_mode：值为2时表示持久化，1为临时的。也许你还记得这个属性来自第二节。\n\n​\tcontent_type：编码格式，比如经常用的JSON格式，良好的做法是设置为：application/json。\n\n​\treply_to：通常用来定义回调队列名称。\n\n​\tcorrelation_id：用来关联RPC的响应和请求。\n\n### Correlation Id\n\n在上面的方法中我们建议为每一个RPC请求创建一个回调队列。这样非常低效，但是幸运的是有更好的办法 - 我们可以为每一个客户端创建一个单独的回调队列。\n\n这样又带来一个新的问题，在队列接收到响应时，并不知道属于哪个请求。这也正是correlation_id属性要发挥的作用。我们为每一个请求的设定一个唯一的correlation_id值，然后，当在回调队列接收到消息时会查看它的属性，基于此，我们就可以把响应和请求进行匹配。如果发现一个未知的correlation_id值，可以安全的忽略掉这条消息 - 因为它不属于任何请求。\n\n也许你会问，为什么应该忽略回调队列里的未知消息，而不是返回一个错误？因为服务可能会出现紊乱的情况，虽然不太可能，但是如果发生这种情况，RPC服务会在发送完响应后挂掉，但是还没有进行消息确认。如果发生了，重启RPC服务后会再次处理这个请求。这就是为什么在客户端我们必须适当的处理重复请求，而RPC服务最好的幂等的。\n\n### 总结\n\n![](/images/rabbitmq/python-six.png)\n\nRPC工作流程：\n\n​\t当客户端开始运行时会创建一个匿名独有回调队列。\n\n​\tRPC请求中，客户端消息带有两个属性：reply_to用来设置回调队列，correlation_id用来唯一标识每一个请求。\n\n​\t请求被发送到rpc_queue队列。\n\n​\tRPC worker（又称worker）在队列中守护，等待新请求。当请求到达，它会进行处理，然后把结果以消息的形式发送回客户端的队列，队列名便是客户端消息带有的reply_to的值。\n\n​\t客户端等待回调队列中的数据。当消息到达，检查它的correlation_id的值。如果符合客户端发送给RPC服务器中请求的值，客户端会返回响应内容到应用中。\n\n### 整合\n\n斐波那契方法：\n\n```\nfunction fib($n){\n  if($n == 0)\n  \treturn 0;\n  if($n == 1)\n  \treturn 1;\n  return fib($n-1) + fib($n-2);\n}\n```\n\n定义完斐波那契方法。假定它仅接受数字类型的输入。（别期望它能处理大的数字，它很可能非常慢的处理完。）\n\nRPC服务处理程序rpc_server.php：\n\n```php\n<?php\n\nrequire_once __DIR__ . '/vendor/autoload.php';\nuse PhpAmqpLib\\Connection\\AMQPStreamConnection;\nuse PhpAmqpLib\\Message\\AMQPMessage;\n\n$connection = new AMQPStreamConnection('localhost', 5672, 'guest', 'guest');\n$channel = $connection->channel();\n\n$channel->queue_declare('rpc_queue', false, false, false, false);\n\nfuction fib($n){\n  if($n == 0)\n    return 0;\n  if($n == 1)\n    return 1;\n  \n  return fib($n-1) + fib($n-2);\n}\n\necho \" [x] Awaiting RPC requests\\n\";\n\n$callback = function($req){\n  $n = intval($req->body);\n  echo \" [.] fib(\",$n,\")\\n\";\n  \n  $msg = new AMQPMessage(\n  \t(string)fib($n),\n    array('correlation_id' => $req->get('correlation_id'))\n  );\n  \n  $req->delivery_info['channel']->basic_publish($msg, '', $req->get('reply_to'));\n  $req->delivery_info['channel']->basic_ack($req->delivery_info['delivery_tag']);\n};\n\n$channel->basic_qos(null, 1, null);\n$channel->basic_consume('rpc_queue', '', false, false, false, false, $callback);\n\nwhile(count($channel->callbacks)){\n  $channel->wait();\n}\n\n$channel->close();\n$connection->close();\n\n?>\n```\n\n服务端代码相当简单：\n\n​\t和以往一样我们会从创建连接，频道，和声明队列开始\n\n​\t也许我们想要运行更多的进程。为了在多个服务器之间负载均衡，需要在$channel.basic_qos中设置prefech_count；\n\n​\t我们使用basic_consume访问队列。然后进入while循环等待请求消息，处理，然后返回响应消息。\n\nRPC客户端 rpc_client.php：\n\n```php\n<?php\n\nrequire_once __DIR__ . '/vendor/autoload.php';\nuse PhpAmqpLib\\Connection\\AMQPStreamConnection;\nuse PhpAmqpLib\\Message\\AMQPMessage;\n\nclass FibonacciRpcClient{\n\tprivate $connection;\n\tprivate $channel;\n\tprivate $callback_queue;\n\tprivate $response;\n\tprivate $corr_id;\n  \n\tpublic function __construct(){\n\t\t$this->connection = new AMQPStreamConnection(\n\t\t  'localhost', 5672, 'guest', 'guest'\n\t\t);\n\t\t$this->channel = $this->connection->channel();\n\t\tlist($this->callback_queue, ,) = $this->channel->queue_declare(\"\", false, false, true, false);\n\t\t$this->channel->basic_consume(\n\t\t\t$this->callback_queue, '', false, false, false, false,\n\t\t\tarray($this, 'on_response'));\n\t}\n  \n \tpublic function on_response($req){\n \t\tif($req->get('correlation_id') == $this->corr_id){\n \t\t\t$this->response = $req->body;\n \t\t}\n \t}\n  \t\n\tpublic function call($n){\n\t\t$this->response = null;\n\t\t$this->corr_id = uniqid();\n\n\t\t$msg = new AMQPMessage(\n  \t\t(string) $n,\n  \t\tarray(\n  \t\t\t'correlation_id' => $this->corr_id,\n  \t\t\t'reply_to' => $this->callback_queue)\n  \t\t);\n    )\n      \n    $this->channel->basic_publish($msg, '', 'rpc_queue');\n    while(!$this->response){\n    \t$this->channel->wait();\n    }\n    return intval($this->response);\n  }\n};\n\n$fibonacci_rpc = new FibonacciRpcClient();\n$response = $fibonacci_rpc->call(30);\necho \" [.] Got \", $response, \"\\n\";\n\n?>\n```\n\n现在可以查看示例的完整代码了。[rpc_client.php](https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/php/rpc_client.php) 和 [rpc_server.php](https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/php/rpc_server.php)。\n\n现在RPC服务端可以运行了：\n\n```shell\nphp rpc_server.php\n[x] Awiting RPC resquests\n```\n\n接收斐波那契数列运行：\n\n```\nphp rpc_client.php\n[x] Requesting fib(30)\n```\n\n这里展现的并不是RPC服务的唯一可能实现，但它有一些重要的优势：\n\n​\t如果RPC服务太慢，可以按比例增加运行数量。试试在新控制台裕兴第二个rpc_server.php服务。\n\n​\t在客户端，RPC要求只发送和接收一条消息。不能有像队列声明一样的异步调用。结果就是，对于单一的RPC请求，客户端仅需要一个网络往返。\n\n现在的代码还是过于简单，并没有想解决更复杂（更重要）的问题，比如：\n\n​\t要是没有服务端守护运行，客户端作何反应？\n\n​\tRPC客户端是否需要设置超时？\n\n​\t如果服务端引发异常，是否该把它发送到客户端？\n\n​\t处理前阻止无效消息（如检查范围，类型）进入？\n\n如果想尝试，可以在[rabbitmq-management](https://www.rabbitmq.com/plugins.html) 里找到一些有用的查看队列的插件。\n\n\n\n原文地址：[Remote procedure call (RPC)](https://www.rabbitmq.com/tutorials/tutorial-six-php.html)","slug":"php-rabbitmq-tutorial-six","published":1,"updated":"2016-05-07T14:08:27.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj830jveg002ful0rwvkr05ta","content":"<h3 id=\"远程调用\"><a href=\"#远程调用\" class=\"headerlink\" title=\"远程调用\"></a>远程调用</h3><p>在<a href=\"/2016/04/17/php-rabbitmq-tutorial-two.html\">第二节</a>中，我们学习了如何使用工作队列在多个worker中分发耗时任务。</p>\n<p>但是如果我们需要在远程运行一个函数并等待返回结果怎么办？这是两码事，这个模式通常被称为远程过程调用（Remote Procedure Call，RPC）。</p>\n<p>在本节中我们准备使用RabbitMQ构建一个RPC系统：一个客户端和一个可扩展的RPC服务端。由于我们没有值得分发的耗时任务，我们准备创建一个假的返回<a href=\"https://en.wikipedia.org/wiki/Fibonacci_number\" target=\"_blank\" rel=\"external\">斐波那契数列</a>的RPC服务。</p>\n<h3 id=\"客户端接口\"><a href=\"#客户端接口\" class=\"headerlink\" title=\"客户端接口\"></a>客户端接口</h3><p>我们创建一个简单的客户端类来说明RPC服务如何使用。这个类会展示call方法如何发送一个RPC请求并且阻塞，直到接收到返回值。</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">$fibonacci_rpc = <span class=\"keyword\">new</span> FibonacciRpcClient();</div><div class=\"line\">$response = $fibonacci_rpc-&gt;call(<span class=\"number\">30</span>);</div><div class=\"line\"><span class=\"keyword\">echo</span> <span class=\"string\">\"[.] Got \"</span>, $response, <span class=\"string\">\"\\n\"</span>;</div></pre></td></tr></table></figure>\n<h4 id=\"RPC注意事项\"><a href=\"#RPC注意事项\" class=\"headerlink\" title=\"RPC注意事项\"></a>RPC注意事项</h4><p>尽管RPC在计算机学中很常见，但它十分挑剔。当程序员不知道是否是调用一个本地的方法还是一个很慢的RPC会出现这个问题。这样的困惑便导致不可预测的系统并增加不必要的调试复杂性。比起简化的软件，误用RPC会导致不可维护的无头绪代码。</p>\n<p>记住刚才的内容，考虑下面的建议：</p>\n<p>​    确保可以明显的看出哪个方法调用的是本地的哪个是远程的。</p>\n<p>​    系统文档化。让组件之间的依赖变得清晰可见。</p>\n<p>​    错误处理。当RPC服务长时间关闭客户端该作何反应？</p>\n<p>如果有疑问，则尽量避免使用RPC。如果可以话，你应该使用异步管道——而不是RPC——像阻塞，结果被异步推送到下个计算阶段。</p>\n<h3 id=\"回调队列\"><a href=\"#回调队列\" class=\"headerlink\" title=\"回调队列\"></a>回调队列</h3><p>通常在RabbitMQ上做RPC很简单。客户端发送请求消息，服务端回复消息。为了接收响应消息，我们需要在请求中附带一个”callback”队列地址，我们可以使用默认的队列。来试一试：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">list</span>($queue_name, ,) = $channel-&gt;queue_declare(<span class=\"string\">\"\"</span>, <span class=\"keyword\">false</span>, <span class=\"keyword\">false</span>, <span class=\"keyword\">true</span>, <span class=\"keyword\">false</span>);</div><div class=\"line\"></div><div class=\"line\">$msg = <span class=\"keyword\">new</span> AMQPMessage(</div><div class=\"line\">\t$payload,</div><div class=\"line\">\t<span class=\"keyword\">array</span>(<span class=\"string\">'reply_to'</span> =&gt; $queue_name));</div><div class=\"line\"></div><div class=\"line\">$channel-&gt;basic_publish($msg, <span class=\"string\">''</span>, <span class=\"string\">'rpc_queue'</span>);</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\"># ... then code to read a response message from the callback_queue</span></div></pre></td></tr></table></figure>\n<h4 id=\"消息属性\"><a href=\"#消息属性\" class=\"headerlink\" title=\"消息属性\"></a>消息属性</h4><p>AMQP协议定义了14个消息属性。大部分不常用，下面的除外：</p>\n<p>​    delivery_mode：值为2时表示持久化，1为临时的。也许你还记得这个属性来自第二节。</p>\n<p>​    content_type：编码格式，比如经常用的JSON格式，良好的做法是设置为：application/json。</p>\n<p>​    reply_to：通常用来定义回调队列名称。</p>\n<p>​    correlation_id：用来关联RPC的响应和请求。</p>\n<h3 id=\"Correlation-Id\"><a href=\"#Correlation-Id\" class=\"headerlink\" title=\"Correlation Id\"></a>Correlation Id</h3><p>在上面的方法中我们建议为每一个RPC请求创建一个回调队列。这样非常低效，但是幸运的是有更好的办法 - 我们可以为每一个客户端创建一个单独的回调队列。</p>\n<p>这样又带来一个新的问题，在队列接收到响应时，并不知道属于哪个请求。这也正是correlation_id属性要发挥的作用。我们为每一个请求的设定一个唯一的correlation_id值，然后，当在回调队列接收到消息时会查看它的属性，基于此，我们就可以把响应和请求进行匹配。如果发现一个未知的correlation_id值，可以安全的忽略掉这条消息 - 因为它不属于任何请求。</p>\n<p>也许你会问，为什么应该忽略回调队列里的未知消息，而不是返回一个错误？因为服务可能会出现紊乱的情况，虽然不太可能，但是如果发生这种情况，RPC服务会在发送完响应后挂掉，但是还没有进行消息确认。如果发生了，重启RPC服务后会再次处理这个请求。这就是为什么在客户端我们必须适当的处理重复请求，而RPC服务最好的幂等的。</p>\n<h3 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h3><p><img src=\"/images/rabbitmq/python-six.png\" alt=\"\"></p>\n<p>RPC工作流程：</p>\n<p>​    当客户端开始运行时会创建一个匿名独有回调队列。</p>\n<p>​    RPC请求中，客户端消息带有两个属性：reply_to用来设置回调队列，correlation_id用来唯一标识每一个请求。</p>\n<p>​    请求被发送到rpc_queue队列。</p>\n<p>​    RPC worker（又称worker）在队列中守护，等待新请求。当请求到达，它会进行处理，然后把结果以消息的形式发送回客户端的队列，队列名便是客户端消息带有的reply_to的值。</p>\n<p>​    客户端等待回调队列中的数据。当消息到达，检查它的correlation_id的值。如果符合客户端发送给RPC服务器中请求的值，客户端会返回响应内容到应用中。</p>\n<h3 id=\"整合\"><a href=\"#整合\" class=\"headerlink\" title=\"整合\"></a>整合</h3><p>斐波那契方法：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">function fib($n)&#123;</div><div class=\"line\">  if($n == 0)</div><div class=\"line\">  \treturn 0;</div><div class=\"line\">  if($n == 1)</div><div class=\"line\">  \treturn 1;</div><div class=\"line\">  return fib($n-1) + fib($n-2);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>定义完斐波那契方法。假定它仅接受数字类型的输入。（别期望它能处理大的数字，它很可能非常慢的处理完。）</p>\n<p>RPC服务处理程序rpc_server.php：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">require_once</span> <span class=\"keyword\">__DIR__</span> . <span class=\"string\">'/vendor/autoload.php'</span>;</div><div class=\"line\"><span class=\"keyword\">use</span> <span class=\"title\">PhpAmqpLib</span>\\<span class=\"title\">Connection</span>\\<span class=\"title\">AMQPStreamConnection</span>;</div><div class=\"line\"><span class=\"keyword\">use</span> <span class=\"title\">PhpAmqpLib</span>\\<span class=\"title\">Message</span>\\<span class=\"title\">AMQPMessage</span>;</div><div class=\"line\"></div><div class=\"line\">$connection = <span class=\"keyword\">new</span> AMQPStreamConnection(<span class=\"string\">'localhost'</span>, <span class=\"number\">5672</span>, <span class=\"string\">'guest'</span>, <span class=\"string\">'guest'</span>);</div><div class=\"line\">$channel = $connection-&gt;channel();</div><div class=\"line\"></div><div class=\"line\">$channel-&gt;queue_declare(<span class=\"string\">'rpc_queue'</span>, <span class=\"keyword\">false</span>, <span class=\"keyword\">false</span>, <span class=\"keyword\">false</span>, <span class=\"keyword\">false</span>);</div><div class=\"line\"></div><div class=\"line\">fuction fib($n)&#123;</div><div class=\"line\">  <span class=\"keyword\">if</span>($n == <span class=\"number\">0</span>)</div><div class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</div><div class=\"line\">  <span class=\"keyword\">if</span>($n == <span class=\"number\">1</span>)</div><div class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">1</span>;</div><div class=\"line\">  </div><div class=\"line\">  <span class=\"keyword\">return</span> fib($n<span class=\"number\">-1</span>) + fib($n<span class=\"number\">-2</span>);</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">echo</span> <span class=\"string\">\" [x] Awaiting RPC requests\\n\"</span>;</div><div class=\"line\"></div><div class=\"line\">$callback = <span class=\"function\"><span class=\"keyword\">function</span><span class=\"params\">($req)</span></span>&#123;</div><div class=\"line\">  $n = intval($req-&gt;body);</div><div class=\"line\">  <span class=\"keyword\">echo</span> <span class=\"string\">\" [.] fib(\"</span>,$n,<span class=\"string\">\")\\n\"</span>;</div><div class=\"line\">  </div><div class=\"line\">  $msg = <span class=\"keyword\">new</span> AMQPMessage(</div><div class=\"line\">  \t(string)fib($n),</div><div class=\"line\">    <span class=\"keyword\">array</span>(<span class=\"string\">'correlation_id'</span> =&gt; $req-&gt;get(<span class=\"string\">'correlation_id'</span>))</div><div class=\"line\">  );</div><div class=\"line\">  </div><div class=\"line\">  $req-&gt;delivery_info[<span class=\"string\">'channel'</span>]-&gt;basic_publish($msg, <span class=\"string\">''</span>, $req-&gt;get(<span class=\"string\">'reply_to'</span>));</div><div class=\"line\">  $req-&gt;delivery_info[<span class=\"string\">'channel'</span>]-&gt;basic_ack($req-&gt;delivery_info[<span class=\"string\">'delivery_tag'</span>]);</div><div class=\"line\">&#125;;</div><div class=\"line\"></div><div class=\"line\">$channel-&gt;basic_qos(<span class=\"keyword\">null</span>, <span class=\"number\">1</span>, <span class=\"keyword\">null</span>);</div><div class=\"line\">$channel-&gt;basic_consume(<span class=\"string\">'rpc_queue'</span>, <span class=\"string\">''</span>, <span class=\"keyword\">false</span>, <span class=\"keyword\">false</span>, <span class=\"keyword\">false</span>, <span class=\"keyword\">false</span>, $callback);</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">while</span>(count($channel-&gt;callbacks))&#123;</div><div class=\"line\">  $channel-&gt;wait();</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\">$channel-&gt;close();</div><div class=\"line\">$connection-&gt;close();</div><div class=\"line\"></div><div class=\"line\"><span class=\"meta\">?&gt;</span></div></pre></td></tr></table></figure>\n<p>服务端代码相当简单：</p>\n<p>​    和以往一样我们会从创建连接，频道，和声明队列开始</p>\n<p>​    也许我们想要运行更多的进程。为了在多个服务器之间负载均衡，需要在$channel.basic_qos中设置prefech_count；</p>\n<p>​    我们使用basic_consume访问队列。然后进入while循环等待请求消息，处理，然后返回响应消息。</p>\n<p>RPC客户端 rpc_client.php：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">require_once</span> <span class=\"keyword\">__DIR__</span> . <span class=\"string\">'/vendor/autoload.php'</span>;</div><div class=\"line\"><span class=\"keyword\">use</span> <span class=\"title\">PhpAmqpLib</span>\\<span class=\"title\">Connection</span>\\<span class=\"title\">AMQPStreamConnection</span>;</div><div class=\"line\"><span class=\"keyword\">use</span> <span class=\"title\">PhpAmqpLib</span>\\<span class=\"title\">Message</span>\\<span class=\"title\">AMQPMessage</span>;</div><div class=\"line\"></div><div class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">FibonacciRpcClient</span></span>&#123;</div><div class=\"line\">\t<span class=\"keyword\">private</span> $connection;</div><div class=\"line\">\t<span class=\"keyword\">private</span> $channel;</div><div class=\"line\">\t<span class=\"keyword\">private</span> $callback_queue;</div><div class=\"line\">\t<span class=\"keyword\">private</span> $response;</div><div class=\"line\">\t<span class=\"keyword\">private</span> $corr_id;</div><div class=\"line\">  </div><div class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span><span class=\"params\">()</span></span>&#123;</div><div class=\"line\">\t\t<span class=\"keyword\">$this</span>-&gt;connection = <span class=\"keyword\">new</span> AMQPStreamConnection(</div><div class=\"line\">\t\t  <span class=\"string\">'localhost'</span>, <span class=\"number\">5672</span>, <span class=\"string\">'guest'</span>, <span class=\"string\">'guest'</span></div><div class=\"line\">\t\t);</div><div class=\"line\">\t\t<span class=\"keyword\">$this</span>-&gt;channel = <span class=\"keyword\">$this</span>-&gt;connection-&gt;channel();</div><div class=\"line\">\t\t<span class=\"keyword\">list</span>(<span class=\"keyword\">$this</span>-&gt;callback_queue, ,) = <span class=\"keyword\">$this</span>-&gt;channel-&gt;queue_declare(<span class=\"string\">\"\"</span>, <span class=\"keyword\">false</span>, <span class=\"keyword\">false</span>, <span class=\"keyword\">true</span>, <span class=\"keyword\">false</span>);</div><div class=\"line\">\t\t<span class=\"keyword\">$this</span>-&gt;channel-&gt;basic_consume(</div><div class=\"line\">\t\t\t<span class=\"keyword\">$this</span>-&gt;callback_queue, <span class=\"string\">''</span>, <span class=\"keyword\">false</span>, <span class=\"keyword\">false</span>, <span class=\"keyword\">false</span>, <span class=\"keyword\">false</span>,</div><div class=\"line\">\t\t\t<span class=\"keyword\">array</span>(<span class=\"keyword\">$this</span>, <span class=\"string\">'on_response'</span>));</div><div class=\"line\">\t&#125;</div><div class=\"line\">  </div><div class=\"line\"> \t<span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">on_response</span><span class=\"params\">($req)</span></span>&#123;</div><div class=\"line\"> \t\t<span class=\"keyword\">if</span>($req-&gt;get(<span class=\"string\">'correlation_id'</span>) == <span class=\"keyword\">$this</span>-&gt;corr_id)&#123;</div><div class=\"line\"> \t\t\t<span class=\"keyword\">$this</span>-&gt;response = $req-&gt;body;</div><div class=\"line\"> \t\t&#125;</div><div class=\"line\"> \t&#125;</div><div class=\"line\">  \t</div><div class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">call</span><span class=\"params\">($n)</span></span>&#123;</div><div class=\"line\">\t\t<span class=\"keyword\">$this</span>-&gt;response = <span class=\"keyword\">null</span>;</div><div class=\"line\">\t\t<span class=\"keyword\">$this</span>-&gt;corr_id = uniqid();</div><div class=\"line\"></div><div class=\"line\">\t\t$msg = <span class=\"keyword\">new</span> AMQPMessage(</div><div class=\"line\">  \t\t(string) $n,</div><div class=\"line\">  \t\t<span class=\"keyword\">array</span>(</div><div class=\"line\">  \t\t\t<span class=\"string\">'correlation_id'</span> =&gt; <span class=\"keyword\">$this</span>-&gt;corr_id,</div><div class=\"line\">  \t\t\t<span class=\"string\">'reply_to'</span> =&gt; <span class=\"keyword\">$this</span>-&gt;callback_queue)</div><div class=\"line\">  \t\t);</div><div class=\"line\">    )</div><div class=\"line\">      </div><div class=\"line\">    <span class=\"keyword\">$this</span>-&gt;channel-&gt;basic_publish($msg, <span class=\"string\">''</span>, <span class=\"string\">'rpc_queue'</span>);</div><div class=\"line\">    <span class=\"keyword\">while</span>(!<span class=\"keyword\">$this</span>-&gt;response)&#123;</div><div class=\"line\">    \t<span class=\"keyword\">$this</span>-&gt;channel-&gt;wait();</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">return</span> intval(<span class=\"keyword\">$this</span>-&gt;response);</div><div class=\"line\">  &#125;</div><div class=\"line\">&#125;;</div><div class=\"line\"></div><div class=\"line\">$fibonacci_rpc = <span class=\"keyword\">new</span> FibonacciRpcClient();</div><div class=\"line\">$response = $fibonacci_rpc-&gt;call(<span class=\"number\">30</span>);</div><div class=\"line\"><span class=\"keyword\">echo</span> <span class=\"string\">\" [.] Got \"</span>, $response, <span class=\"string\">\"\\n\"</span>;</div><div class=\"line\"></div><div class=\"line\"><span class=\"meta\">?&gt;</span></div></pre></td></tr></table></figure>\n<p>现在可以查看示例的完整代码了。<a href=\"https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/php/rpc_client.php\" target=\"_blank\" rel=\"external\">rpc_client.php</a> 和 <a href=\"https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/php/rpc_server.php\" target=\"_blank\" rel=\"external\">rpc_server.php</a>。</p>\n<p>现在RPC服务端可以运行了：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">php rpc_server.php</div><div class=\"line\">[x] Awiting RPC resquests</div></pre></td></tr></table></figure>\n<p>接收斐波那契数列运行：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">php rpc_client.php</div><div class=\"line\">[x] Requesting fib(30)</div></pre></td></tr></table></figure>\n<p>这里展现的并不是RPC服务的唯一可能实现，但它有一些重要的优势：</p>\n<p>​    如果RPC服务太慢，可以按比例增加运行数量。试试在新控制台裕兴第二个rpc_server.php服务。</p>\n<p>​    在客户端，RPC要求只发送和接收一条消息。不能有像队列声明一样的异步调用。结果就是，对于单一的RPC请求，客户端仅需要一个网络往返。</p>\n<p>现在的代码还是过于简单，并没有想解决更复杂（更重要）的问题，比如：</p>\n<p>​    要是没有服务端守护运行，客户端作何反应？</p>\n<p>​    RPC客户端是否需要设置超时？</p>\n<p>​    如果服务端引发异常，是否该把它发送到客户端？</p>\n<p>​    处理前阻止无效消息（如检查范围，类型）进入？</p>\n<p>如果想尝试，可以在<a href=\"https://www.rabbitmq.com/plugins.html\" target=\"_blank\" rel=\"external\">rabbitmq-management</a> 里找到一些有用的查看队列的插件。</p>\n<p>原文地址：<a href=\"https://www.rabbitmq.com/tutorials/tutorial-six-php.html\" target=\"_blank\" rel=\"external\">Remote procedure call (RPC)</a></p>\n","site":{"data":{}},"excerpt":"","more":"<h3 id=\"远程调用\"><a href=\"#远程调用\" class=\"headerlink\" title=\"远程调用\"></a>远程调用</h3><p>在<a href=\"/2016/04/17/php-rabbitmq-tutorial-two.html\">第二节</a>中，我们学习了如何使用工作队列在多个worker中分发耗时任务。</p>\n<p>但是如果我们需要在远程运行一个函数并等待返回结果怎么办？这是两码事，这个模式通常被称为远程过程调用（Remote Procedure Call，RPC）。</p>\n<p>在本节中我们准备使用RabbitMQ构建一个RPC系统：一个客户端和一个可扩展的RPC服务端。由于我们没有值得分发的耗时任务，我们准备创建一个假的返回<a href=\"https://en.wikipedia.org/wiki/Fibonacci_number\" target=\"_blank\" rel=\"external\">斐波那契数列</a>的RPC服务。</p>\n<h3 id=\"客户端接口\"><a href=\"#客户端接口\" class=\"headerlink\" title=\"客户端接口\"></a>客户端接口</h3><p>我们创建一个简单的客户端类来说明RPC服务如何使用。这个类会展示call方法如何发送一个RPC请求并且阻塞，直到接收到返回值。</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">$fibonacci_rpc = <span class=\"keyword\">new</span> FibonacciRpcClient();</div><div class=\"line\">$response = $fibonacci_rpc-&gt;call(<span class=\"number\">30</span>);</div><div class=\"line\"><span class=\"keyword\">echo</span> <span class=\"string\">\"[.] Got \"</span>, $response, <span class=\"string\">\"\\n\"</span>;</div></pre></td></tr></table></figure>\n<h4 id=\"RPC注意事项\"><a href=\"#RPC注意事项\" class=\"headerlink\" title=\"RPC注意事项\"></a>RPC注意事项</h4><p>尽管RPC在计算机学中很常见，但它十分挑剔。当程序员不知道是否是调用一个本地的方法还是一个很慢的RPC会出现这个问题。这样的困惑便导致不可预测的系统并增加不必要的调试复杂性。比起简化的软件，误用RPC会导致不可维护的无头绪代码。</p>\n<p>记住刚才的内容，考虑下面的建议：</p>\n<p>​    确保可以明显的看出哪个方法调用的是本地的哪个是远程的。</p>\n<p>​    系统文档化。让组件之间的依赖变得清晰可见。</p>\n<p>​    错误处理。当RPC服务长时间关闭客户端该作何反应？</p>\n<p>如果有疑问，则尽量避免使用RPC。如果可以话，你应该使用异步管道——而不是RPC——像阻塞，结果被异步推送到下个计算阶段。</p>\n<h3 id=\"回调队列\"><a href=\"#回调队列\" class=\"headerlink\" title=\"回调队列\"></a>回调队列</h3><p>通常在RabbitMQ上做RPC很简单。客户端发送请求消息，服务端回复消息。为了接收响应消息，我们需要在请求中附带一个”callback”队列地址，我们可以使用默认的队列。来试一试：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">list</span>($queue_name, ,) = $channel-&gt;queue_declare(<span class=\"string\">\"\"</span>, <span class=\"keyword\">false</span>, <span class=\"keyword\">false</span>, <span class=\"keyword\">true</span>, <span class=\"keyword\">false</span>);</div><div class=\"line\"></div><div class=\"line\">$msg = <span class=\"keyword\">new</span> AMQPMessage(</div><div class=\"line\">\t$payload,</div><div class=\"line\">\t<span class=\"keyword\">array</span>(<span class=\"string\">'reply_to'</span> =&gt; $queue_name));</div><div class=\"line\"></div><div class=\"line\">$channel-&gt;basic_publish($msg, <span class=\"string\">''</span>, <span class=\"string\">'rpc_queue'</span>);</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\"># ... then code to read a response message from the callback_queue</span></div></pre></td></tr></table></figure>\n<h4 id=\"消息属性\"><a href=\"#消息属性\" class=\"headerlink\" title=\"消息属性\"></a>消息属性</h4><p>AMQP协议定义了14个消息属性。大部分不常用，下面的除外：</p>\n<p>​    delivery_mode：值为2时表示持久化，1为临时的。也许你还记得这个属性来自第二节。</p>\n<p>​    content_type：编码格式，比如经常用的JSON格式，良好的做法是设置为：application/json。</p>\n<p>​    reply_to：通常用来定义回调队列名称。</p>\n<p>​    correlation_id：用来关联RPC的响应和请求。</p>\n<h3 id=\"Correlation-Id\"><a href=\"#Correlation-Id\" class=\"headerlink\" title=\"Correlation Id\"></a>Correlation Id</h3><p>在上面的方法中我们建议为每一个RPC请求创建一个回调队列。这样非常低效，但是幸运的是有更好的办法 - 我们可以为每一个客户端创建一个单独的回调队列。</p>\n<p>这样又带来一个新的问题，在队列接收到响应时，并不知道属于哪个请求。这也正是correlation_id属性要发挥的作用。我们为每一个请求的设定一个唯一的correlation_id值，然后，当在回调队列接收到消息时会查看它的属性，基于此，我们就可以把响应和请求进行匹配。如果发现一个未知的correlation_id值，可以安全的忽略掉这条消息 - 因为它不属于任何请求。</p>\n<p>也许你会问，为什么应该忽略回调队列里的未知消息，而不是返回一个错误？因为服务可能会出现紊乱的情况，虽然不太可能，但是如果发生这种情况，RPC服务会在发送完响应后挂掉，但是还没有进行消息确认。如果发生了，重启RPC服务后会再次处理这个请求。这就是为什么在客户端我们必须适当的处理重复请求，而RPC服务最好的幂等的。</p>\n<h3 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h3><p><img src=\"/images/rabbitmq/python-six.png\" alt=\"\"></p>\n<p>RPC工作流程：</p>\n<p>​    当客户端开始运行时会创建一个匿名独有回调队列。</p>\n<p>​    RPC请求中，客户端消息带有两个属性：reply_to用来设置回调队列，correlation_id用来唯一标识每一个请求。</p>\n<p>​    请求被发送到rpc_queue队列。</p>\n<p>​    RPC worker（又称worker）在队列中守护，等待新请求。当请求到达，它会进行处理，然后把结果以消息的形式发送回客户端的队列，队列名便是客户端消息带有的reply_to的值。</p>\n<p>​    客户端等待回调队列中的数据。当消息到达，检查它的correlation_id的值。如果符合客户端发送给RPC服务器中请求的值，客户端会返回响应内容到应用中。</p>\n<h3 id=\"整合\"><a href=\"#整合\" class=\"headerlink\" title=\"整合\"></a>整合</h3><p>斐波那契方法：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">function fib($n)&#123;</div><div class=\"line\">  if($n == 0)</div><div class=\"line\">  \treturn 0;</div><div class=\"line\">  if($n == 1)</div><div class=\"line\">  \treturn 1;</div><div class=\"line\">  return fib($n-1) + fib($n-2);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>定义完斐波那契方法。假定它仅接受数字类型的输入。（别期望它能处理大的数字，它很可能非常慢的处理完。）</p>\n<p>RPC服务处理程序rpc_server.php：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">require_once</span> <span class=\"keyword\">__DIR__</span> . <span class=\"string\">'/vendor/autoload.php'</span>;</div><div class=\"line\"><span class=\"keyword\">use</span> <span class=\"title\">PhpAmqpLib</span>\\<span class=\"title\">Connection</span>\\<span class=\"title\">AMQPStreamConnection</span>;</div><div class=\"line\"><span class=\"keyword\">use</span> <span class=\"title\">PhpAmqpLib</span>\\<span class=\"title\">Message</span>\\<span class=\"title\">AMQPMessage</span>;</div><div class=\"line\"></div><div class=\"line\">$connection = <span class=\"keyword\">new</span> AMQPStreamConnection(<span class=\"string\">'localhost'</span>, <span class=\"number\">5672</span>, <span class=\"string\">'guest'</span>, <span class=\"string\">'guest'</span>);</div><div class=\"line\">$channel = $connection-&gt;channel();</div><div class=\"line\"></div><div class=\"line\">$channel-&gt;queue_declare(<span class=\"string\">'rpc_queue'</span>, <span class=\"keyword\">false</span>, <span class=\"keyword\">false</span>, <span class=\"keyword\">false</span>, <span class=\"keyword\">false</span>);</div><div class=\"line\"></div><div class=\"line\">fuction fib($n)&#123;</div><div class=\"line\">  <span class=\"keyword\">if</span>($n == <span class=\"number\">0</span>)</div><div class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</div><div class=\"line\">  <span class=\"keyword\">if</span>($n == <span class=\"number\">1</span>)</div><div class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">1</span>;</div><div class=\"line\">  </div><div class=\"line\">  <span class=\"keyword\">return</span> fib($n<span class=\"number\">-1</span>) + fib($n<span class=\"number\">-2</span>);</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">echo</span> <span class=\"string\">\" [x] Awaiting RPC requests\\n\"</span>;</div><div class=\"line\"></div><div class=\"line\">$callback = <span class=\"function\"><span class=\"keyword\">function</span><span class=\"params\">($req)</span></span>&#123;</div><div class=\"line\">  $n = intval($req-&gt;body);</div><div class=\"line\">  <span class=\"keyword\">echo</span> <span class=\"string\">\" [.] fib(\"</span>,$n,<span class=\"string\">\")\\n\"</span>;</div><div class=\"line\">  </div><div class=\"line\">  $msg = <span class=\"keyword\">new</span> AMQPMessage(</div><div class=\"line\">  \t(string)fib($n),</div><div class=\"line\">    <span class=\"keyword\">array</span>(<span class=\"string\">'correlation_id'</span> =&gt; $req-&gt;get(<span class=\"string\">'correlation_id'</span>))</div><div class=\"line\">  );</div><div class=\"line\">  </div><div class=\"line\">  $req-&gt;delivery_info[<span class=\"string\">'channel'</span>]-&gt;basic_publish($msg, <span class=\"string\">''</span>, $req-&gt;get(<span class=\"string\">'reply_to'</span>));</div><div class=\"line\">  $req-&gt;delivery_info[<span class=\"string\">'channel'</span>]-&gt;basic_ack($req-&gt;delivery_info[<span class=\"string\">'delivery_tag'</span>]);</div><div class=\"line\">&#125;;</div><div class=\"line\"></div><div class=\"line\">$channel-&gt;basic_qos(<span class=\"keyword\">null</span>, <span class=\"number\">1</span>, <span class=\"keyword\">null</span>);</div><div class=\"line\">$channel-&gt;basic_consume(<span class=\"string\">'rpc_queue'</span>, <span class=\"string\">''</span>, <span class=\"keyword\">false</span>, <span class=\"keyword\">false</span>, <span class=\"keyword\">false</span>, <span class=\"keyword\">false</span>, $callback);</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">while</span>(count($channel-&gt;callbacks))&#123;</div><div class=\"line\">  $channel-&gt;wait();</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\">$channel-&gt;close();</div><div class=\"line\">$connection-&gt;close();</div><div class=\"line\"></div><div class=\"line\"><span class=\"meta\">?&gt;</span></div></pre></td></tr></table></figure>\n<p>服务端代码相当简单：</p>\n<p>​    和以往一样我们会从创建连接，频道，和声明队列开始</p>\n<p>​    也许我们想要运行更多的进程。为了在多个服务器之间负载均衡，需要在$channel.basic_qos中设置prefech_count；</p>\n<p>​    我们使用basic_consume访问队列。然后进入while循环等待请求消息，处理，然后返回响应消息。</p>\n<p>RPC客户端 rpc_client.php：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">require_once</span> <span class=\"keyword\">__DIR__</span> . <span class=\"string\">'/vendor/autoload.php'</span>;</div><div class=\"line\"><span class=\"keyword\">use</span> <span class=\"title\">PhpAmqpLib</span>\\<span class=\"title\">Connection</span>\\<span class=\"title\">AMQPStreamConnection</span>;</div><div class=\"line\"><span class=\"keyword\">use</span> <span class=\"title\">PhpAmqpLib</span>\\<span class=\"title\">Message</span>\\<span class=\"title\">AMQPMessage</span>;</div><div class=\"line\"></div><div class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">FibonacciRpcClient</span></span>&#123;</div><div class=\"line\">\t<span class=\"keyword\">private</span> $connection;</div><div class=\"line\">\t<span class=\"keyword\">private</span> $channel;</div><div class=\"line\">\t<span class=\"keyword\">private</span> $callback_queue;</div><div class=\"line\">\t<span class=\"keyword\">private</span> $response;</div><div class=\"line\">\t<span class=\"keyword\">private</span> $corr_id;</div><div class=\"line\">  </div><div class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span><span class=\"params\">()</span></span>&#123;</div><div class=\"line\">\t\t<span class=\"keyword\">$this</span>-&gt;connection = <span class=\"keyword\">new</span> AMQPStreamConnection(</div><div class=\"line\">\t\t  <span class=\"string\">'localhost'</span>, <span class=\"number\">5672</span>, <span class=\"string\">'guest'</span>, <span class=\"string\">'guest'</span></div><div class=\"line\">\t\t);</div><div class=\"line\">\t\t<span class=\"keyword\">$this</span>-&gt;channel = <span class=\"keyword\">$this</span>-&gt;connection-&gt;channel();</div><div class=\"line\">\t\t<span class=\"keyword\">list</span>(<span class=\"keyword\">$this</span>-&gt;callback_queue, ,) = <span class=\"keyword\">$this</span>-&gt;channel-&gt;queue_declare(<span class=\"string\">\"\"</span>, <span class=\"keyword\">false</span>, <span class=\"keyword\">false</span>, <span class=\"keyword\">true</span>, <span class=\"keyword\">false</span>);</div><div class=\"line\">\t\t<span class=\"keyword\">$this</span>-&gt;channel-&gt;basic_consume(</div><div class=\"line\">\t\t\t<span class=\"keyword\">$this</span>-&gt;callback_queue, <span class=\"string\">''</span>, <span class=\"keyword\">false</span>, <span class=\"keyword\">false</span>, <span class=\"keyword\">false</span>, <span class=\"keyword\">false</span>,</div><div class=\"line\">\t\t\t<span class=\"keyword\">array</span>(<span class=\"keyword\">$this</span>, <span class=\"string\">'on_response'</span>));</div><div class=\"line\">\t&#125;</div><div class=\"line\">  </div><div class=\"line\"> \t<span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">on_response</span><span class=\"params\">($req)</span></span>&#123;</div><div class=\"line\"> \t\t<span class=\"keyword\">if</span>($req-&gt;get(<span class=\"string\">'correlation_id'</span>) == <span class=\"keyword\">$this</span>-&gt;corr_id)&#123;</div><div class=\"line\"> \t\t\t<span class=\"keyword\">$this</span>-&gt;response = $req-&gt;body;</div><div class=\"line\"> \t\t&#125;</div><div class=\"line\"> \t&#125;</div><div class=\"line\">  \t</div><div class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">call</span><span class=\"params\">($n)</span></span>&#123;</div><div class=\"line\">\t\t<span class=\"keyword\">$this</span>-&gt;response = <span class=\"keyword\">null</span>;</div><div class=\"line\">\t\t<span class=\"keyword\">$this</span>-&gt;corr_id = uniqid();</div><div class=\"line\"></div><div class=\"line\">\t\t$msg = <span class=\"keyword\">new</span> AMQPMessage(</div><div class=\"line\">  \t\t(string) $n,</div><div class=\"line\">  \t\t<span class=\"keyword\">array</span>(</div><div class=\"line\">  \t\t\t<span class=\"string\">'correlation_id'</span> =&gt; <span class=\"keyword\">$this</span>-&gt;corr_id,</div><div class=\"line\">  \t\t\t<span class=\"string\">'reply_to'</span> =&gt; <span class=\"keyword\">$this</span>-&gt;callback_queue)</div><div class=\"line\">  \t\t);</div><div class=\"line\">    )</div><div class=\"line\">      </div><div class=\"line\">    <span class=\"keyword\">$this</span>-&gt;channel-&gt;basic_publish($msg, <span class=\"string\">''</span>, <span class=\"string\">'rpc_queue'</span>);</div><div class=\"line\">    <span class=\"keyword\">while</span>(!<span class=\"keyword\">$this</span>-&gt;response)&#123;</div><div class=\"line\">    \t<span class=\"keyword\">$this</span>-&gt;channel-&gt;wait();</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">return</span> intval(<span class=\"keyword\">$this</span>-&gt;response);</div><div class=\"line\">  &#125;</div><div class=\"line\">&#125;;</div><div class=\"line\"></div><div class=\"line\">$fibonacci_rpc = <span class=\"keyword\">new</span> FibonacciRpcClient();</div><div class=\"line\">$response = $fibonacci_rpc-&gt;call(<span class=\"number\">30</span>);</div><div class=\"line\"><span class=\"keyword\">echo</span> <span class=\"string\">\" [.] Got \"</span>, $response, <span class=\"string\">\"\\n\"</span>;</div><div class=\"line\"></div><div class=\"line\"><span class=\"meta\">?&gt;</span></div></pre></td></tr></table></figure>\n<p>现在可以查看示例的完整代码了。<a href=\"https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/php/rpc_client.php\" target=\"_blank\" rel=\"external\">rpc_client.php</a> 和 <a href=\"https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/php/rpc_server.php\" target=\"_blank\" rel=\"external\">rpc_server.php</a>。</p>\n<p>现在RPC服务端可以运行了：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">php rpc_server.php</div><div class=\"line\">[x] Awiting RPC resquests</div></pre></td></tr></table></figure>\n<p>接收斐波那契数列运行：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">php rpc_client.php</div><div class=\"line\">[x] Requesting fib(30)</div></pre></td></tr></table></figure>\n<p>这里展现的并不是RPC服务的唯一可能实现，但它有一些重要的优势：</p>\n<p>​    如果RPC服务太慢，可以按比例增加运行数量。试试在新控制台裕兴第二个rpc_server.php服务。</p>\n<p>​    在客户端，RPC要求只发送和接收一条消息。不能有像队列声明一样的异步调用。结果就是，对于单一的RPC请求，客户端仅需要一个网络往返。</p>\n<p>现在的代码还是过于简单，并没有想解决更复杂（更重要）的问题，比如：</p>\n<p>​    要是没有服务端守护运行，客户端作何反应？</p>\n<p>​    RPC客户端是否需要设置超时？</p>\n<p>​    如果服务端引发异常，是否该把它发送到客户端？</p>\n<p>​    处理前阻止无效消息（如检查范围，类型）进入？</p>\n<p>如果想尝试，可以在<a href=\"https://www.rabbitmq.com/plugins.html\" target=\"_blank\" rel=\"external\">rabbitmq-management</a> 里找到一些有用的查看队列的插件。</p>\n<p>原文地址：<a href=\"https://www.rabbitmq.com/tutorials/tutorial-six-php.html\" target=\"_blank\" rel=\"external\">Remote procedure call (RPC)</a></p>\n"},{"title":"PHP RabbitMQ 教程（三） - 发布/订阅","date":"2016-04-23T11:58:17.000Z","_content":"\n### 发布/订阅\n\n我们在[上一节](/2016/04/17/php-rabbitmq-tutorial-two.html)创建了一个工作队列，并假定队列对应的任务传送给了某个客户端。在这一章节我们会做一些完全不一样的东西--我们会发送一条消息到多个消费者，也称之为“发布/订阅”模式。\n\n为了说明这个模式，我们会创建一个简单的日志系统（logging system，以下简称日志系统），它由两个程序组成--第一个是发送日志信息，第二个是接收日志并打印。\n\n日志系统的每一个运行的接收端程序都会接收信息，这样就可以运行一个接收端就把日志保存到硬盘里，同时运行另一个接收端去实时显示日志到屏幕。\n\n本质上，日志内容是广播给所有的接收端的。\n\n### 交换器\n\n在之前的章节中我们从一个队列里发送和接收消息，现在该把完整的RabbitMQ消息模型介绍给大家了。\n\n让我们快速的回看一遍在之前的章节中的内容：\n\n\t>生产者是一个用来发送消息的程序\n\n\t>队列是一个存储消息的缓冲区\n\n\t>消费者是一个接收消息的程序\n\nRabbitMQ消息模型的核心思想是，生产者永远不会直接发送给任何消息队列，实际上，生产者一般情况下甚至不知道消息应该发送给哪个队列。\n\n生产者只能发送消息到交换器中，交换器非常简单。一方面从生产者接收消息，另一方面把消息推送到队列中。交换器必须知道如何处理接收到的消息，是推送到某个队列？推送到多个队列？还是丢弃这条消息。这个规则通过交换器类型(exchange type)来指定。\n\n![](/images/rabbitmq/exchanges.png)\n\n这里是交换器的几个类型：direct,topic,headers,fanout。这里我们主要关注最后一个--fanout，创建一个类型为 fanout 的交换器，命名为 logs。\n\n```\n$channel->exchange_declare('logs','fanout',false,false,false);\n```\n\nfanout交换器非常简单，你可以从名称中猜出它的功能，它把所有接收到的消息广播给所有它知道的队列，这也正是我们的日志系统需要的功能。\n\n\n#### 列出交换器\n\n可以使用rabbitmqctl 命令列出服务器上的所有交换器：\n\n```\nsudo rabbitmqctl list_exchanges\n\nListing exchanges ...\n        direct\namq.direct      direct\namq.fanout      fanout\namq.headers     headers\namq.match       headers\namq.rabbitmq.log        topic\namq.rabbitmq.trace      topic\namq.topic       topic\nlogs    fanout\n...done.\n```\n\n结果中有一些amq.*和一些未命名的交换器，这是一些默认创建的交换器，它们不太可能是现在需要用到的。\n\n#### 未命名交换器\n\n在之前的章节中我们对交换器一无所知，直到可以发送消息给队列。大概是因为我们当时正在使用一个以空字符串“”定义的默认的交换器。\n\n回想一下之前怎么发布消息：\n\n```\n$channel->basic_publish($msg,'','hello');\n```\n\n这里就是使用默认或者说未命名的交换器：消息被routing_key的值\nHere we use the default or nameless exchange: messages are routed to the queue with the name specified by routing_key, if it exists. The routing key is the second argument to basic_publish\n\n现在，可以发布消息到这个队列。\n\n```\n$channel->exchange_declare('logs','fanout',false,false,false);\n$channel->basic_publish($msg,'logs');\n```\n\n### 临时队列\n\n也许你还记得在之前我们使用了一个指定的队列（还记得 hello 队列 和 task_queue 队列吗？）。可以命名一个队列是至关重要的--我们需要指定一个worker到同一个队列。当想让生产者和消费者使用同一个队列时给队列命名是非常重要的。\n\n但是在我们的日志系统中情况不同了，我们想要接收所有的消息，不仅仅是其中的一部分，我们关心的是最新的消息而不是旧的，因此需要做两件事。\n\n首先，当连接到RabbitMQ时，需要一个空的队列，可以手动创建一个名字随机的队列，或者，更好的办法是，让服务器为我们随机选一个队列名字。\n\n其次，一旦与消费者失去连接，队列需要自动删除。\n\n在[php-amqplib](https://github.com/php-amqplib/php-amqplib)中，当我们创建了一个名字为空的队列时，实际上是创建了一个被生成了名字的非持久化的队列。\n\n```\nlist($queue_name, ,) = $channel->queue_declare(\"\");\n```\n\n方法执行后，$queue_name变量包含了一个RabbitMQ生成的字符串。比如也许是这样的：amq.gen-JzTY20BRgKO-HjmUJj0wLg。\n\n当连接被关闭的时候，队列也会被删掉，因为队列是独有的。\n\n### 绑定(Bindlings)\n\n![](/images/rabbitmq/bindings.png)\n\n我们已经创建了一个fanout类型的交换器和一个队列。现在需要让交换器发送消息给队列。交换器和队列之间的关系称之为绑定(binding)\n\n```\n$channel->queue_bind($queue_name,'logs');\n```\n\n现在开始，logs 交换器会把消息附加到队列中。\n\n#### 列出绑定（Listing bindings）\n\n可以使用 rabbitmqctl list_bindings列出所有存在的正在使用的绑定。\n\n### 整合\n\n![](/images/rabbitmq/python-three-overall.png)\n\n发送日志消息的生产者，与之前的代码看起来没什么不同，最重要的变化是现在想要发送消息到我们的 logs 交换器中，需要在发送时提供一个routing_key，但是在 fanout类型的交换器中这个值是可以忽略的。下边是emit_log.php的代码。\n\n```php\n<?php\n\nrequire_once __DIR__ .'/verdor/autoload.php';\nuse PhpAmqpLib\\Connection\\AMQPStreamConnection;\nuse PhpAmqpLib\\Message\\AMQPMessage;\n\n$connection = new AMQPStreamConnection('localhost',5672,'guest','guest');\n$channel = $channel->channel();\n\n$channel->exchange_declare('logs','fanout',false,false,false);\n\n$data = implode(' ',array_slice($argv,1));\n\nif(empty($data)) $data = \"info:Hello World\";\n$msg = new AMQPMessage($data);\n\n$channel->basic_publish($msg,'logs');\n\necho \"[x]Sent \",$data,\"\\n\";\n\n$channel->close();\n$connection->close();\n?>\n```\n\n([emit_log.php](https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/php/emit_log.php))\n\n如你所见，建立连接后声明了交换器，这一步是必须的，因为发送消息到一个不存在的交换器是被禁止的。\n\n如果还没有队列绑定到交换器，信息会丢失，但是这对于我们是可以的，如果没有消费者监听，我们可以安全的丢弃消息。\n\nreceive_logs.php：\n\n```php\n<?php\n\nrequire_once __DIR__ .'/vendor/autoload.php';\nuse PhpAmqpLib\\Connection\\QMAPStreamConnection;\n\n$connection = new AMQPStreamConnection('localhost',5672,'guest','guest');\n$channel = $connection->channel();\n\n$channel->queue_bind($queue_name,'logs');\n\necho '[*] Waiting for logs. To exit press CTRL+C',\"\\n\";\n\n$callback = function($msg){\n\techo '[x]',$msg->body,\"\\n\";\n};\n\n$channel->basic_consume($queue_name,'',false,true,false,false,$callback);\n\nwhild(count($channel->callbacks)){\n\t$channel->wait();\n}\n\n$channel->close();\n$connection->close();\n?>\n```\n([receive_logs.php](https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/php/receive_logs.php))\n\n如果想保存日志到文件中，可以在命令中输入\n\n```\nphp receive_logs.php > logs_from_rabbit.log\n```\n\n如果想在屏幕上查看日志，新打开一个终端并运行：\n\n```\nphp receive_logs.php\n```\n\n发送日志：\n\n```\nphp emit_log.php\n```\n\n使用 rabbitmqctl list_bindings 可以确认代码确实创建了绑定和队列，当两个receive_logs.php在运行的时候会看到类似这样的：\n\n```\nsudo rabbitmqctl list_bindings\nListing bindings ...\nlogs    exchange        amq.gen-JzTY20BRgKO-HjmUJj0wLg  queue           []\nlogs    exchange        amq.gen-vso0PVvyiRIL2WoV3i48Yg  queue           []\n...done.\n\n```\n\n对于结果的解释很简单，logs交换器中的数据发送到两个服务器指定的队列，而这正是我们要实现的。\n\n想要弄明白怎样去监听部分消息，转到第四部分。\n\n原文地址：[Publish/Subscribe](https://www.rabbitmq.com/tutorials/tutorial-three-php.html)","source":"_posts/php-rabbitmq-tutorial-three.md","raw":"title: PHP RabbitMQ 教程（三） - 发布/订阅\ncategories: php\ndate: 2016-04-23 19:58:17\ntags:  [php,rabbitmq]\n\n---\n\n### 发布/订阅\n\n我们在[上一节](/2016/04/17/php-rabbitmq-tutorial-two.html)创建了一个工作队列，并假定队列对应的任务传送给了某个客户端。在这一章节我们会做一些完全不一样的东西--我们会发送一条消息到多个消费者，也称之为“发布/订阅”模式。\n\n为了说明这个模式，我们会创建一个简单的日志系统（logging system，以下简称日志系统），它由两个程序组成--第一个是发送日志信息，第二个是接收日志并打印。\n\n日志系统的每一个运行的接收端程序都会接收信息，这样就可以运行一个接收端就把日志保存到硬盘里，同时运行另一个接收端去实时显示日志到屏幕。\n\n本质上，日志内容是广播给所有的接收端的。\n\n### 交换器\n\n在之前的章节中我们从一个队列里发送和接收消息，现在该把完整的RabbitMQ消息模型介绍给大家了。\n\n让我们快速的回看一遍在之前的章节中的内容：\n\n\t>生产者是一个用来发送消息的程序\n\n\t>队列是一个存储消息的缓冲区\n\n\t>消费者是一个接收消息的程序\n\nRabbitMQ消息模型的核心思想是，生产者永远不会直接发送给任何消息队列，实际上，生产者一般情况下甚至不知道消息应该发送给哪个队列。\n\n生产者只能发送消息到交换器中，交换器非常简单。一方面从生产者接收消息，另一方面把消息推送到队列中。交换器必须知道如何处理接收到的消息，是推送到某个队列？推送到多个队列？还是丢弃这条消息。这个规则通过交换器类型(exchange type)来指定。\n\n![](/images/rabbitmq/exchanges.png)\n\n这里是交换器的几个类型：direct,topic,headers,fanout。这里我们主要关注最后一个--fanout，创建一个类型为 fanout 的交换器，命名为 logs。\n\n```\n$channel->exchange_declare('logs','fanout',false,false,false);\n```\n\nfanout交换器非常简单，你可以从名称中猜出它的功能，它把所有接收到的消息广播给所有它知道的队列，这也正是我们的日志系统需要的功能。\n\n\n#### 列出交换器\n\n可以使用rabbitmqctl 命令列出服务器上的所有交换器：\n\n```\nsudo rabbitmqctl list_exchanges\n\nListing exchanges ...\n        direct\namq.direct      direct\namq.fanout      fanout\namq.headers     headers\namq.match       headers\namq.rabbitmq.log        topic\namq.rabbitmq.trace      topic\namq.topic       topic\nlogs    fanout\n...done.\n```\n\n结果中有一些amq.*和一些未命名的交换器，这是一些默认创建的交换器，它们不太可能是现在需要用到的。\n\n#### 未命名交换器\n\n在之前的章节中我们对交换器一无所知，直到可以发送消息给队列。大概是因为我们当时正在使用一个以空字符串“”定义的默认的交换器。\n\n回想一下之前怎么发布消息：\n\n```\n$channel->basic_publish($msg,'','hello');\n```\n\n这里就是使用默认或者说未命名的交换器：消息被routing_key的值\nHere we use the default or nameless exchange: messages are routed to the queue with the name specified by routing_key, if it exists. The routing key is the second argument to basic_publish\n\n现在，可以发布消息到这个队列。\n\n```\n$channel->exchange_declare('logs','fanout',false,false,false);\n$channel->basic_publish($msg,'logs');\n```\n\n### 临时队列\n\n也许你还记得在之前我们使用了一个指定的队列（还记得 hello 队列 和 task_queue 队列吗？）。可以命名一个队列是至关重要的--我们需要指定一个worker到同一个队列。当想让生产者和消费者使用同一个队列时给队列命名是非常重要的。\n\n但是在我们的日志系统中情况不同了，我们想要接收所有的消息，不仅仅是其中的一部分，我们关心的是最新的消息而不是旧的，因此需要做两件事。\n\n首先，当连接到RabbitMQ时，需要一个空的队列，可以手动创建一个名字随机的队列，或者，更好的办法是，让服务器为我们随机选一个队列名字。\n\n其次，一旦与消费者失去连接，队列需要自动删除。\n\n在[php-amqplib](https://github.com/php-amqplib/php-amqplib)中，当我们创建了一个名字为空的队列时，实际上是创建了一个被生成了名字的非持久化的队列。\n\n```\nlist($queue_name, ,) = $channel->queue_declare(\"\");\n```\n\n方法执行后，$queue_name变量包含了一个RabbitMQ生成的字符串。比如也许是这样的：amq.gen-JzTY20BRgKO-HjmUJj0wLg。\n\n当连接被关闭的时候，队列也会被删掉，因为队列是独有的。\n\n### 绑定(Bindlings)\n\n![](/images/rabbitmq/bindings.png)\n\n我们已经创建了一个fanout类型的交换器和一个队列。现在需要让交换器发送消息给队列。交换器和队列之间的关系称之为绑定(binding)\n\n```\n$channel->queue_bind($queue_name,'logs');\n```\n\n现在开始，logs 交换器会把消息附加到队列中。\n\n#### 列出绑定（Listing bindings）\n\n可以使用 rabbitmqctl list_bindings列出所有存在的正在使用的绑定。\n\n### 整合\n\n![](/images/rabbitmq/python-three-overall.png)\n\n发送日志消息的生产者，与之前的代码看起来没什么不同，最重要的变化是现在想要发送消息到我们的 logs 交换器中，需要在发送时提供一个routing_key，但是在 fanout类型的交换器中这个值是可以忽略的。下边是emit_log.php的代码。\n\n```php\n<?php\n\nrequire_once __DIR__ .'/verdor/autoload.php';\nuse PhpAmqpLib\\Connection\\AMQPStreamConnection;\nuse PhpAmqpLib\\Message\\AMQPMessage;\n\n$connection = new AMQPStreamConnection('localhost',5672,'guest','guest');\n$channel = $channel->channel();\n\n$channel->exchange_declare('logs','fanout',false,false,false);\n\n$data = implode(' ',array_slice($argv,1));\n\nif(empty($data)) $data = \"info:Hello World\";\n$msg = new AMQPMessage($data);\n\n$channel->basic_publish($msg,'logs');\n\necho \"[x]Sent \",$data,\"\\n\";\n\n$channel->close();\n$connection->close();\n?>\n```\n\n([emit_log.php](https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/php/emit_log.php))\n\n如你所见，建立连接后声明了交换器，这一步是必须的，因为发送消息到一个不存在的交换器是被禁止的。\n\n如果还没有队列绑定到交换器，信息会丢失，但是这对于我们是可以的，如果没有消费者监听，我们可以安全的丢弃消息。\n\nreceive_logs.php：\n\n```php\n<?php\n\nrequire_once __DIR__ .'/vendor/autoload.php';\nuse PhpAmqpLib\\Connection\\QMAPStreamConnection;\n\n$connection = new AMQPStreamConnection('localhost',5672,'guest','guest');\n$channel = $connection->channel();\n\n$channel->queue_bind($queue_name,'logs');\n\necho '[*] Waiting for logs. To exit press CTRL+C',\"\\n\";\n\n$callback = function($msg){\n\techo '[x]',$msg->body,\"\\n\";\n};\n\n$channel->basic_consume($queue_name,'',false,true,false,false,$callback);\n\nwhild(count($channel->callbacks)){\n\t$channel->wait();\n}\n\n$channel->close();\n$connection->close();\n?>\n```\n([receive_logs.php](https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/php/receive_logs.php))\n\n如果想保存日志到文件中，可以在命令中输入\n\n```\nphp receive_logs.php > logs_from_rabbit.log\n```\n\n如果想在屏幕上查看日志，新打开一个终端并运行：\n\n```\nphp receive_logs.php\n```\n\n发送日志：\n\n```\nphp emit_log.php\n```\n\n使用 rabbitmqctl list_bindings 可以确认代码确实创建了绑定和队列，当两个receive_logs.php在运行的时候会看到类似这样的：\n\n```\nsudo rabbitmqctl list_bindings\nListing bindings ...\nlogs    exchange        amq.gen-JzTY20BRgKO-HjmUJj0wLg  queue           []\nlogs    exchange        amq.gen-vso0PVvyiRIL2WoV3i48Yg  queue           []\n...done.\n\n```\n\n对于结果的解释很简单，logs交换器中的数据发送到两个服务器指定的队列，而这正是我们要实现的。\n\n想要弄明白怎样去监听部分消息，转到第四部分。\n\n原文地址：[Publish/Subscribe](https://www.rabbitmq.com/tutorials/tutorial-three-php.html)","slug":"php-rabbitmq-tutorial-three","published":1,"updated":"2016-05-07T14:06:15.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj830jveh002iul0rqhu62xsd","content":"<h3 id=\"发布-订阅\"><a href=\"#发布-订阅\" class=\"headerlink\" title=\"发布/订阅\"></a>发布/订阅</h3><p>我们在<a href=\"/2016/04/17/php-rabbitmq-tutorial-two.html\">上一节</a>创建了一个工作队列，并假定队列对应的任务传送给了某个客户端。在这一章节我们会做一些完全不一样的东西–我们会发送一条消息到多个消费者，也称之为“发布/订阅”模式。</p>\n<p>为了说明这个模式，我们会创建一个简单的日志系统（logging system，以下简称日志系统），它由两个程序组成–第一个是发送日志信息，第二个是接收日志并打印。</p>\n<p>日志系统的每一个运行的接收端程序都会接收信息，这样就可以运行一个接收端就把日志保存到硬盘里，同时运行另一个接收端去实时显示日志到屏幕。</p>\n<p>本质上，日志内容是广播给所有的接收端的。</p>\n<h3 id=\"交换器\"><a href=\"#交换器\" class=\"headerlink\" title=\"交换器\"></a>交换器</h3><p>在之前的章节中我们从一个队列里发送和接收消息，现在该把完整的RabbitMQ消息模型介绍给大家了。</p>\n<p>让我们快速的回看一遍在之前的章节中的内容：</p>\n<pre><code>&gt;生产者是一个用来发送消息的程序\n\n&gt;队列是一个存储消息的缓冲区\n\n&gt;消费者是一个接收消息的程序\n</code></pre><p>RabbitMQ消息模型的核心思想是，生产者永远不会直接发送给任何消息队列，实际上，生产者一般情况下甚至不知道消息应该发送给哪个队列。</p>\n<p>生产者只能发送消息到交换器中，交换器非常简单。一方面从生产者接收消息，另一方面把消息推送到队列中。交换器必须知道如何处理接收到的消息，是推送到某个队列？推送到多个队列？还是丢弃这条消息。这个规则通过交换器类型(exchange type)来指定。</p>\n<p><img src=\"/images/rabbitmq/exchanges.png\" alt=\"\"></p>\n<p>这里是交换器的几个类型：direct,topic,headers,fanout。这里我们主要关注最后一个–fanout，创建一个类型为 fanout 的交换器，命名为 logs。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$channel-&gt;exchange_declare(&apos;logs&apos;,&apos;fanout&apos;,false,false,false);</div></pre></td></tr></table></figure>\n<p>fanout交换器非常简单，你可以从名称中猜出它的功能，它把所有接收到的消息广播给所有它知道的队列，这也正是我们的日志系统需要的功能。</p>\n<h4 id=\"列出交换器\"><a href=\"#列出交换器\" class=\"headerlink\" title=\"列出交换器\"></a>列出交换器</h4><p>可以使用rabbitmqctl 命令列出服务器上的所有交换器：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div></pre></td><td class=\"code\"><pre><div class=\"line\">sudo rabbitmqctl list_exchanges</div><div class=\"line\"></div><div class=\"line\">Listing exchanges ...</div><div class=\"line\">        direct</div><div class=\"line\">amq.direct      direct</div><div class=\"line\">amq.fanout      fanout</div><div class=\"line\">amq.headers     headers</div><div class=\"line\">amq.match       headers</div><div class=\"line\">amq.rabbitmq.log        topic</div><div class=\"line\">amq.rabbitmq.trace      topic</div><div class=\"line\">amq.topic       topic</div><div class=\"line\">logs    fanout</div><div class=\"line\">...done.</div></pre></td></tr></table></figure>\n<p>结果中有一些amq.*和一些未命名的交换器，这是一些默认创建的交换器，它们不太可能是现在需要用到的。</p>\n<h4 id=\"未命名交换器\"><a href=\"#未命名交换器\" class=\"headerlink\" title=\"未命名交换器\"></a>未命名交换器</h4><p>在之前的章节中我们对交换器一无所知，直到可以发送消息给队列。大概是因为我们当时正在使用一个以空字符串“”定义的默认的交换器。</p>\n<p>回想一下之前怎么发布消息：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$channel-&gt;basic_publish($msg,&apos;&apos;,&apos;hello&apos;);</div></pre></td></tr></table></figure>\n<p>这里就是使用默认或者说未命名的交换器：消息被routing_key的值<br>Here we use the default or nameless exchange: messages are routed to the queue with the name specified by routing_key, if it exists. The routing key is the second argument to basic_publish</p>\n<p>现在，可以发布消息到这个队列。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">$channel-&gt;exchange_declare(&apos;logs&apos;,&apos;fanout&apos;,false,false,false);</div><div class=\"line\">$channel-&gt;basic_publish($msg,&apos;logs&apos;);</div></pre></td></tr></table></figure>\n<h3 id=\"临时队列\"><a href=\"#临时队列\" class=\"headerlink\" title=\"临时队列\"></a>临时队列</h3><p>也许你还记得在之前我们使用了一个指定的队列（还记得 hello 队列 和 task_queue 队列吗？）。可以命名一个队列是至关重要的–我们需要指定一个worker到同一个队列。当想让生产者和消费者使用同一个队列时给队列命名是非常重要的。</p>\n<p>但是在我们的日志系统中情况不同了，我们想要接收所有的消息，不仅仅是其中的一部分，我们关心的是最新的消息而不是旧的，因此需要做两件事。</p>\n<p>首先，当连接到RabbitMQ时，需要一个空的队列，可以手动创建一个名字随机的队列，或者，更好的办法是，让服务器为我们随机选一个队列名字。</p>\n<p>其次，一旦与消费者失去连接，队列需要自动删除。</p>\n<p>在<a href=\"https://github.com/php-amqplib/php-amqplib\" target=\"_blank\" rel=\"external\">php-amqplib</a>中，当我们创建了一个名字为空的队列时，实际上是创建了一个被生成了名字的非持久化的队列。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">list($queue_name, ,) = $channel-&gt;queue_declare(&quot;&quot;);</div></pre></td></tr></table></figure>\n<p>方法执行后，$queue_name变量包含了一个RabbitMQ生成的字符串。比如也许是这样的：amq.gen-JzTY20BRgKO-HjmUJj0wLg。</p>\n<p>当连接被关闭的时候，队列也会被删掉，因为队列是独有的。</p>\n<h3 id=\"绑定-Bindlings\"><a href=\"#绑定-Bindlings\" class=\"headerlink\" title=\"绑定(Bindlings)\"></a>绑定(Bindlings)</h3><p><img src=\"/images/rabbitmq/bindings.png\" alt=\"\"></p>\n<p>我们已经创建了一个fanout类型的交换器和一个队列。现在需要让交换器发送消息给队列。交换器和队列之间的关系称之为绑定(binding)</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$channel-&gt;queue_bind($queue_name,&apos;logs&apos;);</div></pre></td></tr></table></figure>\n<p>现在开始，logs 交换器会把消息附加到队列中。</p>\n<h4 id=\"列出绑定（Listing-bindings）\"><a href=\"#列出绑定（Listing-bindings）\" class=\"headerlink\" title=\"列出绑定（Listing bindings）\"></a>列出绑定（Listing bindings）</h4><p>可以使用 rabbitmqctl list_bindings列出所有存在的正在使用的绑定。</p>\n<h3 id=\"整合\"><a href=\"#整合\" class=\"headerlink\" title=\"整合\"></a>整合</h3><p><img src=\"/images/rabbitmq/python-three-overall.png\" alt=\"\"></p>\n<p>发送日志消息的生产者，与之前的代码看起来没什么不同，最重要的变化是现在想要发送消息到我们的 logs 交换器中，需要在发送时提供一个routing_key，但是在 fanout类型的交换器中这个值是可以忽略的。下边是emit_log.php的代码。</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">require_once</span> <span class=\"keyword\">__DIR__</span> .<span class=\"string\">'/verdor/autoload.php'</span>;</div><div class=\"line\"><span class=\"keyword\">use</span> <span class=\"title\">PhpAmqpLib</span>\\<span class=\"title\">Connection</span>\\<span class=\"title\">AMQPStreamConnection</span>;</div><div class=\"line\"><span class=\"keyword\">use</span> <span class=\"title\">PhpAmqpLib</span>\\<span class=\"title\">Message</span>\\<span class=\"title\">AMQPMessage</span>;</div><div class=\"line\"></div><div class=\"line\">$connection = <span class=\"keyword\">new</span> AMQPStreamConnection(<span class=\"string\">'localhost'</span>,<span class=\"number\">5672</span>,<span class=\"string\">'guest'</span>,<span class=\"string\">'guest'</span>);</div><div class=\"line\">$channel = $channel-&gt;channel();</div><div class=\"line\"></div><div class=\"line\">$channel-&gt;exchange_declare(<span class=\"string\">'logs'</span>,<span class=\"string\">'fanout'</span>,<span class=\"keyword\">false</span>,<span class=\"keyword\">false</span>,<span class=\"keyword\">false</span>);</div><div class=\"line\"></div><div class=\"line\">$data = implode(<span class=\"string\">' '</span>,array_slice($argv,<span class=\"number\">1</span>));</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">if</span>(<span class=\"keyword\">empty</span>($data)) $data = <span class=\"string\">\"info:Hello World\"</span>;</div><div class=\"line\">$msg = <span class=\"keyword\">new</span> AMQPMessage($data);</div><div class=\"line\"></div><div class=\"line\">$channel-&gt;basic_publish($msg,<span class=\"string\">'logs'</span>);</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">echo</span> <span class=\"string\">\"[x]Sent \"</span>,$data,<span class=\"string\">\"\\n\"</span>;</div><div class=\"line\"></div><div class=\"line\">$channel-&gt;close();</div><div class=\"line\">$connection-&gt;close();</div><div class=\"line\"><span class=\"meta\">?&gt;</span></div></pre></td></tr></table></figure>\n<p>(<a href=\"https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/php/emit_log.php\" target=\"_blank\" rel=\"external\">emit_log.php</a>)</p>\n<p>如你所见，建立连接后声明了交换器，这一步是必须的，因为发送消息到一个不存在的交换器是被禁止的。</p>\n<p>如果还没有队列绑定到交换器，信息会丢失，但是这对于我们是可以的，如果没有消费者监听，我们可以安全的丢弃消息。</p>\n<p>receive_logs.php：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">require_once</span> <span class=\"keyword\">__DIR__</span> .<span class=\"string\">'/vendor/autoload.php'</span>;</div><div class=\"line\"><span class=\"keyword\">use</span> <span class=\"title\">PhpAmqpLib</span>\\<span class=\"title\">Connection</span>\\<span class=\"title\">QMAPStreamConnection</span>;</div><div class=\"line\"></div><div class=\"line\">$connection = <span class=\"keyword\">new</span> AMQPStreamConnection(<span class=\"string\">'localhost'</span>,<span class=\"number\">5672</span>,<span class=\"string\">'guest'</span>,<span class=\"string\">'guest'</span>);</div><div class=\"line\">$channel = $connection-&gt;channel();</div><div class=\"line\"></div><div class=\"line\">$channel-&gt;queue_bind($queue_name,<span class=\"string\">'logs'</span>);</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">echo</span> <span class=\"string\">'[*] Waiting for logs. To exit press CTRL+C'</span>,<span class=\"string\">\"\\n\"</span>;</div><div class=\"line\"></div><div class=\"line\">$callback = <span class=\"function\"><span class=\"keyword\">function</span><span class=\"params\">($msg)</span></span>&#123;</div><div class=\"line\">\t<span class=\"keyword\">echo</span> <span class=\"string\">'[x]'</span>,$msg-&gt;body,<span class=\"string\">\"\\n\"</span>;</div><div class=\"line\">&#125;;</div><div class=\"line\"></div><div class=\"line\">$channel-&gt;basic_consume($queue_name,<span class=\"string\">''</span>,<span class=\"keyword\">false</span>,<span class=\"keyword\">true</span>,<span class=\"keyword\">false</span>,<span class=\"keyword\">false</span>,$callback);</div><div class=\"line\"></div><div class=\"line\">whild(count($channel-&gt;callbacks))&#123;</div><div class=\"line\">\t$channel-&gt;wait();</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\">$channel-&gt;close();</div><div class=\"line\">$connection-&gt;close();</div><div class=\"line\"><span class=\"meta\">?&gt;</span></div></pre></td></tr></table></figure>\n<p>(<a href=\"https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/php/receive_logs.php\" target=\"_blank\" rel=\"external\">receive_logs.php</a>)</p>\n<p>如果想保存日志到文件中，可以在命令中输入</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">php receive_logs.php &gt; logs_from_rabbit.log</div></pre></td></tr></table></figure>\n<p>如果想在屏幕上查看日志，新打开一个终端并运行：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">php receive_logs.php</div></pre></td></tr></table></figure>\n<p>发送日志：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">php emit_log.php</div></pre></td></tr></table></figure>\n<p>使用 rabbitmqctl list_bindings 可以确认代码确实创建了绑定和队列，当两个receive_logs.php在运行的时候会看到类似这样的：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">sudo rabbitmqctl list_bindings</div><div class=\"line\">Listing bindings ...</div><div class=\"line\">logs    exchange        amq.gen-JzTY20BRgKO-HjmUJj0wLg  queue           []</div><div class=\"line\">logs    exchange        amq.gen-vso0PVvyiRIL2WoV3i48Yg  queue           []</div><div class=\"line\">...done.</div></pre></td></tr></table></figure>\n<p>对于结果的解释很简单，logs交换器中的数据发送到两个服务器指定的队列，而这正是我们要实现的。</p>\n<p>想要弄明白怎样去监听部分消息，转到第四部分。</p>\n<p>原文地址：<a href=\"https://www.rabbitmq.com/tutorials/tutorial-three-php.html\" target=\"_blank\" rel=\"external\">Publish/Subscribe</a></p>\n","site":{"data":{}},"excerpt":"","more":"<h3 id=\"发布-订阅\"><a href=\"#发布-订阅\" class=\"headerlink\" title=\"发布/订阅\"></a>发布/订阅</h3><p>我们在<a href=\"/2016/04/17/php-rabbitmq-tutorial-two.html\">上一节</a>创建了一个工作队列，并假定队列对应的任务传送给了某个客户端。在这一章节我们会做一些完全不一样的东西–我们会发送一条消息到多个消费者，也称之为“发布/订阅”模式。</p>\n<p>为了说明这个模式，我们会创建一个简单的日志系统（logging system，以下简称日志系统），它由两个程序组成–第一个是发送日志信息，第二个是接收日志并打印。</p>\n<p>日志系统的每一个运行的接收端程序都会接收信息，这样就可以运行一个接收端就把日志保存到硬盘里，同时运行另一个接收端去实时显示日志到屏幕。</p>\n<p>本质上，日志内容是广播给所有的接收端的。</p>\n<h3 id=\"交换器\"><a href=\"#交换器\" class=\"headerlink\" title=\"交换器\"></a>交换器</h3><p>在之前的章节中我们从一个队列里发送和接收消息，现在该把完整的RabbitMQ消息模型介绍给大家了。</p>\n<p>让我们快速的回看一遍在之前的章节中的内容：</p>\n<pre><code>&gt;生产者是一个用来发送消息的程序\n\n&gt;队列是一个存储消息的缓冲区\n\n&gt;消费者是一个接收消息的程序\n</code></pre><p>RabbitMQ消息模型的核心思想是，生产者永远不会直接发送给任何消息队列，实际上，生产者一般情况下甚至不知道消息应该发送给哪个队列。</p>\n<p>生产者只能发送消息到交换器中，交换器非常简单。一方面从生产者接收消息，另一方面把消息推送到队列中。交换器必须知道如何处理接收到的消息，是推送到某个队列？推送到多个队列？还是丢弃这条消息。这个规则通过交换器类型(exchange type)来指定。</p>\n<p><img src=\"/images/rabbitmq/exchanges.png\" alt=\"\"></p>\n<p>这里是交换器的几个类型：direct,topic,headers,fanout。这里我们主要关注最后一个–fanout，创建一个类型为 fanout 的交换器，命名为 logs。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$channel-&gt;exchange_declare(&apos;logs&apos;,&apos;fanout&apos;,false,false,false);</div></pre></td></tr></table></figure>\n<p>fanout交换器非常简单，你可以从名称中猜出它的功能，它把所有接收到的消息广播给所有它知道的队列，这也正是我们的日志系统需要的功能。</p>\n<h4 id=\"列出交换器\"><a href=\"#列出交换器\" class=\"headerlink\" title=\"列出交换器\"></a>列出交换器</h4><p>可以使用rabbitmqctl 命令列出服务器上的所有交换器：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div></pre></td><td class=\"code\"><pre><div class=\"line\">sudo rabbitmqctl list_exchanges</div><div class=\"line\"></div><div class=\"line\">Listing exchanges ...</div><div class=\"line\">        direct</div><div class=\"line\">amq.direct      direct</div><div class=\"line\">amq.fanout      fanout</div><div class=\"line\">amq.headers     headers</div><div class=\"line\">amq.match       headers</div><div class=\"line\">amq.rabbitmq.log        topic</div><div class=\"line\">amq.rabbitmq.trace      topic</div><div class=\"line\">amq.topic       topic</div><div class=\"line\">logs    fanout</div><div class=\"line\">...done.</div></pre></td></tr></table></figure>\n<p>结果中有一些amq.*和一些未命名的交换器，这是一些默认创建的交换器，它们不太可能是现在需要用到的。</p>\n<h4 id=\"未命名交换器\"><a href=\"#未命名交换器\" class=\"headerlink\" title=\"未命名交换器\"></a>未命名交换器</h4><p>在之前的章节中我们对交换器一无所知，直到可以发送消息给队列。大概是因为我们当时正在使用一个以空字符串“”定义的默认的交换器。</p>\n<p>回想一下之前怎么发布消息：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$channel-&gt;basic_publish($msg,&apos;&apos;,&apos;hello&apos;);</div></pre></td></tr></table></figure>\n<p>这里就是使用默认或者说未命名的交换器：消息被routing_key的值<br>Here we use the default or nameless exchange: messages are routed to the queue with the name specified by routing_key, if it exists. The routing key is the second argument to basic_publish</p>\n<p>现在，可以发布消息到这个队列。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">$channel-&gt;exchange_declare(&apos;logs&apos;,&apos;fanout&apos;,false,false,false);</div><div class=\"line\">$channel-&gt;basic_publish($msg,&apos;logs&apos;);</div></pre></td></tr></table></figure>\n<h3 id=\"临时队列\"><a href=\"#临时队列\" class=\"headerlink\" title=\"临时队列\"></a>临时队列</h3><p>也许你还记得在之前我们使用了一个指定的队列（还记得 hello 队列 和 task_queue 队列吗？）。可以命名一个队列是至关重要的–我们需要指定一个worker到同一个队列。当想让生产者和消费者使用同一个队列时给队列命名是非常重要的。</p>\n<p>但是在我们的日志系统中情况不同了，我们想要接收所有的消息，不仅仅是其中的一部分，我们关心的是最新的消息而不是旧的，因此需要做两件事。</p>\n<p>首先，当连接到RabbitMQ时，需要一个空的队列，可以手动创建一个名字随机的队列，或者，更好的办法是，让服务器为我们随机选一个队列名字。</p>\n<p>其次，一旦与消费者失去连接，队列需要自动删除。</p>\n<p>在<a href=\"https://github.com/php-amqplib/php-amqplib\" target=\"_blank\" rel=\"external\">php-amqplib</a>中，当我们创建了一个名字为空的队列时，实际上是创建了一个被生成了名字的非持久化的队列。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">list($queue_name, ,) = $channel-&gt;queue_declare(&quot;&quot;);</div></pre></td></tr></table></figure>\n<p>方法执行后，$queue_name变量包含了一个RabbitMQ生成的字符串。比如也许是这样的：amq.gen-JzTY20BRgKO-HjmUJj0wLg。</p>\n<p>当连接被关闭的时候，队列也会被删掉，因为队列是独有的。</p>\n<h3 id=\"绑定-Bindlings\"><a href=\"#绑定-Bindlings\" class=\"headerlink\" title=\"绑定(Bindlings)\"></a>绑定(Bindlings)</h3><p><img src=\"/images/rabbitmq/bindings.png\" alt=\"\"></p>\n<p>我们已经创建了一个fanout类型的交换器和一个队列。现在需要让交换器发送消息给队列。交换器和队列之间的关系称之为绑定(binding)</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$channel-&gt;queue_bind($queue_name,&apos;logs&apos;);</div></pre></td></tr></table></figure>\n<p>现在开始，logs 交换器会把消息附加到队列中。</p>\n<h4 id=\"列出绑定（Listing-bindings）\"><a href=\"#列出绑定（Listing-bindings）\" class=\"headerlink\" title=\"列出绑定（Listing bindings）\"></a>列出绑定（Listing bindings）</h4><p>可以使用 rabbitmqctl list_bindings列出所有存在的正在使用的绑定。</p>\n<h3 id=\"整合\"><a href=\"#整合\" class=\"headerlink\" title=\"整合\"></a>整合</h3><p><img src=\"/images/rabbitmq/python-three-overall.png\" alt=\"\"></p>\n<p>发送日志消息的生产者，与之前的代码看起来没什么不同，最重要的变化是现在想要发送消息到我们的 logs 交换器中，需要在发送时提供一个routing_key，但是在 fanout类型的交换器中这个值是可以忽略的。下边是emit_log.php的代码。</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">require_once</span> <span class=\"keyword\">__DIR__</span> .<span class=\"string\">'/verdor/autoload.php'</span>;</div><div class=\"line\"><span class=\"keyword\">use</span> <span class=\"title\">PhpAmqpLib</span>\\<span class=\"title\">Connection</span>\\<span class=\"title\">AMQPStreamConnection</span>;</div><div class=\"line\"><span class=\"keyword\">use</span> <span class=\"title\">PhpAmqpLib</span>\\<span class=\"title\">Message</span>\\<span class=\"title\">AMQPMessage</span>;</div><div class=\"line\"></div><div class=\"line\">$connection = <span class=\"keyword\">new</span> AMQPStreamConnection(<span class=\"string\">'localhost'</span>,<span class=\"number\">5672</span>,<span class=\"string\">'guest'</span>,<span class=\"string\">'guest'</span>);</div><div class=\"line\">$channel = $channel-&gt;channel();</div><div class=\"line\"></div><div class=\"line\">$channel-&gt;exchange_declare(<span class=\"string\">'logs'</span>,<span class=\"string\">'fanout'</span>,<span class=\"keyword\">false</span>,<span class=\"keyword\">false</span>,<span class=\"keyword\">false</span>);</div><div class=\"line\"></div><div class=\"line\">$data = implode(<span class=\"string\">' '</span>,array_slice($argv,<span class=\"number\">1</span>));</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">if</span>(<span class=\"keyword\">empty</span>($data)) $data = <span class=\"string\">\"info:Hello World\"</span>;</div><div class=\"line\">$msg = <span class=\"keyword\">new</span> AMQPMessage($data);</div><div class=\"line\"></div><div class=\"line\">$channel-&gt;basic_publish($msg,<span class=\"string\">'logs'</span>);</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">echo</span> <span class=\"string\">\"[x]Sent \"</span>,$data,<span class=\"string\">\"\\n\"</span>;</div><div class=\"line\"></div><div class=\"line\">$channel-&gt;close();</div><div class=\"line\">$connection-&gt;close();</div><div class=\"line\"><span class=\"meta\">?&gt;</span></div></pre></td></tr></table></figure>\n<p>(<a href=\"https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/php/emit_log.php\" target=\"_blank\" rel=\"external\">emit_log.php</a>)</p>\n<p>如你所见，建立连接后声明了交换器，这一步是必须的，因为发送消息到一个不存在的交换器是被禁止的。</p>\n<p>如果还没有队列绑定到交换器，信息会丢失，但是这对于我们是可以的，如果没有消费者监听，我们可以安全的丢弃消息。</p>\n<p>receive_logs.php：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">require_once</span> <span class=\"keyword\">__DIR__</span> .<span class=\"string\">'/vendor/autoload.php'</span>;</div><div class=\"line\"><span class=\"keyword\">use</span> <span class=\"title\">PhpAmqpLib</span>\\<span class=\"title\">Connection</span>\\<span class=\"title\">QMAPStreamConnection</span>;</div><div class=\"line\"></div><div class=\"line\">$connection = <span class=\"keyword\">new</span> AMQPStreamConnection(<span class=\"string\">'localhost'</span>,<span class=\"number\">5672</span>,<span class=\"string\">'guest'</span>,<span class=\"string\">'guest'</span>);</div><div class=\"line\">$channel = $connection-&gt;channel();</div><div class=\"line\"></div><div class=\"line\">$channel-&gt;queue_bind($queue_name,<span class=\"string\">'logs'</span>);</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">echo</span> <span class=\"string\">'[*] Waiting for logs. To exit press CTRL+C'</span>,<span class=\"string\">\"\\n\"</span>;</div><div class=\"line\"></div><div class=\"line\">$callback = <span class=\"function\"><span class=\"keyword\">function</span><span class=\"params\">($msg)</span></span>&#123;</div><div class=\"line\">\t<span class=\"keyword\">echo</span> <span class=\"string\">'[x]'</span>,$msg-&gt;body,<span class=\"string\">\"\\n\"</span>;</div><div class=\"line\">&#125;;</div><div class=\"line\"></div><div class=\"line\">$channel-&gt;basic_consume($queue_name,<span class=\"string\">''</span>,<span class=\"keyword\">false</span>,<span class=\"keyword\">true</span>,<span class=\"keyword\">false</span>,<span class=\"keyword\">false</span>,$callback);</div><div class=\"line\"></div><div class=\"line\">whild(count($channel-&gt;callbacks))&#123;</div><div class=\"line\">\t$channel-&gt;wait();</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\">$channel-&gt;close();</div><div class=\"line\">$connection-&gt;close();</div><div class=\"line\"><span class=\"meta\">?&gt;</span></div></pre></td></tr></table></figure>\n<p>(<a href=\"https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/php/receive_logs.php\" target=\"_blank\" rel=\"external\">receive_logs.php</a>)</p>\n<p>如果想保存日志到文件中，可以在命令中输入</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">php receive_logs.php &gt; logs_from_rabbit.log</div></pre></td></tr></table></figure>\n<p>如果想在屏幕上查看日志，新打开一个终端并运行：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">php receive_logs.php</div></pre></td></tr></table></figure>\n<p>发送日志：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">php emit_log.php</div></pre></td></tr></table></figure>\n<p>使用 rabbitmqctl list_bindings 可以确认代码确实创建了绑定和队列，当两个receive_logs.php在运行的时候会看到类似这样的：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">sudo rabbitmqctl list_bindings</div><div class=\"line\">Listing bindings ...</div><div class=\"line\">logs    exchange        amq.gen-JzTY20BRgKO-HjmUJj0wLg  queue           []</div><div class=\"line\">logs    exchange        amq.gen-vso0PVvyiRIL2WoV3i48Yg  queue           []</div><div class=\"line\">...done.</div></pre></td></tr></table></figure>\n<p>对于结果的解释很简单，logs交换器中的数据发送到两个服务器指定的队列，而这正是我们要实现的。</p>\n<p>想要弄明白怎样去监听部分消息，转到第四部分。</p>\n<p>原文地址：<a href=\"https://www.rabbitmq.com/tutorials/tutorial-three-php.html\" target=\"_blank\" rel=\"external\">Publish/Subscribe</a></p>\n"},{"title":"PHP RabbitMQ 教程（二） - 工作队列","date":"2016-04-17T06:39:30.000Z","_content":"\n### 工作队列\n\n##### （使用[php-amqplib](https://github.com/php-amqplib/php-amqplib)库）\n\n![](/images/rabbitmq/python-two.png)\n\n在本教程[第一部分](/2016/02/28/php-rabbitmq-tutorial-one.html) 我们已经写完了从一个指定队列发送和接收消息的程序。在这一章节中，我们会创建一个工作队列（Work Queue）来分发耗时的任务给多个工作者（worker）。\n\n工作队列（也被称为 任务队列-task queue）主要是避免立即执行资源密集型任务并且还要等待它执行完毕。相反，需要让任务稍后执行，我们把一个任务当做一条信息发送给队列，后台运行的工作者（worker）会取出任务并执行，当运行多个worker时任务会在它们之间共享。\n\n这个概念在web应用中非常有用，可以在短暂的HTTP请求期间处理一些复杂的任务。\n\n### 准备工作\n\n在前面的部分我们发送了一条内容为“Hello World”的信息，现在我们会发送一些字符串，把这些字符串当做复杂的任务，我们并没有一个实际的任务，像是图片缩放，或者转换PDF文件，所以我们使用sleep方法来假设任务很繁忙。我们会在字符串中加入一些“.”来表示复杂复杂程度；每一个“.”表示需要耗时1秒，比如，“Hello ...”代表需要耗时3秒。\n\n我们从上一节的基础上稍微改动了一下send.php，来允许消息可以从命令行发送，这个程序会发送任务到队列中，把它命名为new_task.php\n\n```\n$data = impllode(' ',array_slice($argv,1));\nif(empty($data))$data = \"Hello World\";\n$msg = new AMQPMessage($data,\n\tarray('delivery_mode'=>2)#设置消息持久化，下边会讲到。\n);\n$channel->basic_publish($msg,'','task_queue');\necho \"[x] Sent \",$data,\"\\n\";\n```\n\n上一节的receive.php也需要一些改动：需要为消息中的每一个“.”模拟1秒的工作。它会从队列中取出消息并运行，把它命名为worker.php：\n\n```\n$callback = function($msg){\n\techo \"[x] Received \",$msg->body,\"\\n\";\n\tsleep(substr_count($msg->body,'.'));\n\techo \"[x] Done\",\"\\n\";\n\t$msg->delivery_info['channel]->basic_ack($msg->delivery_info['delivery_tag']);\n};\n\n$channel->basic_gos(null,1,null);\n$channel->basic_consume('task_queue','',false,false,false,false,$callback);\n```\n\n注意我们伪造的任务需要花费时间（即发送的字符串中要有一些\".\"）\n\n然后运行：\n\n```\nphp new_task.php \"A very hard task which takes two seconds..\"\nphp wordker.php\n```\n\n### 轮询分发\n\n使用工作队列的一个好处就是它能够并行的处理队列。如果有太多工作需要处理，只需要添加新的worker就可以了。\n\n首先，我们试着同时运行两个worker.php，它们都会从队列接收到消息，但是到底是不是这样呢？我们看一下。\n\n此时需要打开3个终端，其中两个运行worker.php，这两个就是我们的消费者 - C1和C2。\n\nshell1\n\n```\nphp worker.php\n[*] Waiting for messages. To exit press CTRL+C\n```\nshell2\n\n```\nphp worker.php\n[*] Waiting for messages. To exit press CTRL+C\n```\n\n在第三个终端中我们会发送新的任务，消费者程序开始运行后就可以发送一些消息了。\n\nshell3\n\n```\nphp new_task.php First message.\nphp new_task.php Second message..\nphp new_task.php Third message...\nphp new_task.php Fourth message....\nphp new_task.php Fifth message.....\n```\n\n我们看一下发送给worker的是什么:\n\nshell1\n\n```\nphp worker.php\n[*] Waiting for messages.To exit press CTRL+C\n[x]Received 'First message.'\n[x]Received 'Third message...'\n[x]Received 'Fifth message.....'\n```\nshell2\n\n```\nphp worker.php\n[*] Waiting for messages.To exit press CTRL+C\n[x]Received 'Second message.'\n[x]Received 'Fourth message...'\n```\n\nRabbitMQ会默认按顺序把消息发送给下一个消费者，平均每个消费者都会得到一样多数量的消息，这种分发消息的方式叫做轮询。试着添加三个或更多个worker来运行。\n\n### 消息响应\n\n执行一个任务会消耗一定的时间，也许你想知道如果一个消费者在执行一个耗时较长的任务时但是在执行一部分的时候挂掉会发生什么。在我们当前的代码中，一旦RabbitMQ把消息分发给消费者便会立即从内存中移除。这种情况下，如果停止一个worker，它正在处理的消息就会丢失。同时其他所有发送给这个worker的还没有处理的消息也会丢失。\n\n但是我们不想丢失任何任务，如果一个worker挂掉，需要把任务发送到另一个worker。\n\n为了确保消息永不丢失，RabbitMQ支持消息响应（message acknowledgements），消费者会发送一个响应告诉RabbitMQ已经收到了某条消息，并且已经处理，这样RabbitMQ就可以删掉它了。\n\n如果一个消费者程序在未发送响应之前挂掉了（频道关闭，链接关闭，或者TCP连接丢失），RabbitMQ会认为消息没有完全处理然后会重新推送到队列中。如果此时有其他的消费者程序在运行，RabbitMQ会很快把消息发送给另一个消费者。这样就可以确保消息不会丢失，即使worker偶尔挂掉。\n\n消息是没有超时的概念的，当worker断开连接的时候，RabbitMQ会重新发送消息，这样在处理一个耗时较长的消息任务时就不会出现问题了。\n\n消息响应默认是关闭的。可以通过设置basic_consume的第四个参数为false(true表示不开启应答)，然后在处理完任务的时候从worker发送一个正确的响应内容。\n\n```php\n$callback = function($msg){\n\techo \"[x] Received \",$msg->body,\"\\n\";\n\tsleep(substr_count($msg->body,'.'));\n\techo \"[x] Done\",\"\\n\";\n\t$msg->delivery_info['channel]->basic_ack($msg->delivery_info['delivery_tag]);\n};\n$channel->basic_consume('task_queue','',false,false,false,false,$callback);\n```\n\n这样我们就可以确保当你CTRL+C杀掉一个正在处理消息的worker的时候，消息并不会丢失。在这个worker挂掉之后，所有未响应的消息就会发送。\n\n### 忘了响应\n\n一个很容易犯的错误就是忘了basic_ack，后果很严重。消息会在程序退出后重新发送（可能看起来像是随机返还 原文：which may look like random redelivery），但是如果它不释放未响应的消息，RabbitMQ就会占用越来越多的内存。\n\n为了排除这种错误可以使用rabbitmqctl来打印messages_unacknowledges字段：\n\n```\nsudo rabbitmqctl list_queues name messages_ready messages_unacknowledged\n\nListing queues ...\nhello    0       0\n...done.\n```\n\n\n### 消息持久化\n\n我们已经学习了确保即使消费者程序挂掉，任务也不会丢失。但是任务还是会在RabbitMQ服务停止的时候丢失。\n\n当RabbitMQ退出或崩溃，它会丢失之前所有的队列和消息，除非你特意告诉它。所以我们必须把队列和消息设为持久化。\n\n首先，为了队列不丢失，需要把它声明为<i>持久化（durable）</i>，所以修改queue_declare的第三个参数为true：\n\n```\n$channel->queue_declare('hello',false,true,false,false);\n```\n\n尽管这行代码本身是正确的，但是仍然不会正确运行。因为在之前已经定义过一个非持久化的 hello 队列。RabbitＭＱ不允许使用不同参数重新定义一个已经存在的队列，它会返回一个错误。但是可以用一个快捷的方法去解决，定义一个不同名字的队列，比如 task_queue：\n\n```\n$channel->queue_declare('task_queue',false,true,false,false);\n```\n\n需要把生产者和消费者程序都设置为 true。\n\n这时候，我们就可以确保在RabbitMQ重启之后task_queue队列不会丢失。现在需要设置消息持久化了 - 通过设置AMQPMessage的属性数组中消息属性 delivery_mode = 2来达到。\n\n```\n$msg = new AMQPMessage($data,\n\t\tarray('delivery_mode'=>2) //设置消息持久化\n\t);\n```\n\n### 关于消息持久化的说明\n\n设置消息持久化并不能完全保证消息不会丢失。这只是告诉让RabbitMQ要把消息保存到硬盘，但是从RabbitMQ接收到消息到保存完成仍然还有一个短暂的间隔时间。因为RabbitMQ并不是每一条消息都会使用fsync(2)，可能只是保存到缓存中而不是真正的写到磁盘里。并不能保证消息真正的持久化，但是对于简单的工作队列已经足够了。如果你需要更健壮的持久化，可以使用[publisher confirms](https://www.rabbitmq.com/confirms.html)机制。\n\n\n\n### 公平分发\n\n也许你注意到它仍没有像我们想的那样去派发任务，比如在两个worker的情况下，处理奇数消息的比较繁忙，处理偶数消息的比较轻松，一个worker不断的忙碌而另一个几乎不需要工作，但是RabbitmQ并不知道这些，并且继续一如既往的派发消息。\n\n这是因为RabbitMQ在消息进入队列的时候只管去派发，并不管消费者未做出响应的消息数。它只是把每第n条消息发送给第n个消费者。\n\n我们可以使用basic_qos方法，并设置prefetch_count = 1。这样是告诉RabbitMQ在同一时刻不要发送超过1条消息给一个worker，或者说，不要发送新的消息给worker直到它已处理完上一条消息并作出了响应。这样，它就会把消息发送给下一个空闲的worker了。\n\n![](/images/rabbitmq/prefetch-count.png)\n\n```\n$channel->basic_qos(null,1,null);\n```\n\n### 注意队列长度\n\n如果所有的worker都处于忙碌状态，队列就会填满，你需要留意，添加更多的worker，或者使用其他的策略。\n\n\n### 整合\n\n最终，new_task.php的代码如下：\n\n```php\n<?php\n\nrequire_once __DIR__ .'/verdor/autoload.php';\nuse PhpAmqpLib\\Connection\\AMQPStreamConnection;\nuse PhpAmqpLib\\Message\\AMQPMessage;\n\n$connection = new AMQPStreamConnection('localhost',5672,'guest','guest');\n$channel = $connection->channel();\n\n$channel->queue_declare('task_queue',false,true,false,false);\n\n$data = implode(' ',array_slice($argv,1));\n\nif(empty($data)) $data = \"Hello World!\";\n\n$msg = new AMQPMessage($data,\n\tarray('delivery_mode'=>2) // 消息持久化\n);\n$channel->basic_publish($msg,'','task_queue');\n\necho \"[x]Sent \", $data, \"\\n\";\n\n$channel->close();\n$connection->close();\n?>\n```\n\n[new_task.php源码](https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/php/new_task.php)\n\nworker.php\n\n```php\n<?php\n\nrequire_once __DIR__ .'/vendor/autoload.php';\nuse PhpAmqpLib\\Connection\\AMQPStreamConnection;\n\n$connection = new AMQPStreamConnection('localhost',5672,'guest','guest');\n$channel = $connection->channel();\n\n$channel->queue_declare('task_queue',false,true,false,false);\n\necho '[*] Waiting for messages.To exit press CTRL+C',\"\\n\";\n\n$callback = function($msg){\n\techo \"[x]Received \",$msg->body,\"\\n\";\n\tsleep(substr_count($msg->body,'.'));\n\techo \"[x]Done\",\"\\n\";\n\t$msg->delivery_info['chennel']->basic_ack($msg->delivery_info['delivery_tag']);\n};\n\n$channel->basic_qos(null,1,null);\n$channel->basic_consume('task_queue','',false,false,false,false,$callback);\n\nwhile(count($channel->callbacks)){\n\t$channel->wait();\n}\n\n$channel->close();\n$connection->close();\n?>\n```\n\n[worker.php](http://github.com/rabbitmq/rabbitmq-tutorials/blob/master/php/worker.php)\n\n使用消息应答和prefetch_count=1后，就可以运行一个工作队列了，持久模式选项会在即使RabbitMQ重启的情况下保留任务。\n\n现在我们可以继续学习第三部分的内容，学习如何发送相同的消息给多个消费者。\n\n原文地址：[Work queues](https://www.rabbitmq.com/tutorials/tutorial-two-php.html)\n","source":"_posts/php-rabbitmq-tutorial-two.md","raw":"title: PHP RabbitMQ 教程（二） - 工作队列\ncategories: php\ndate: 2016-04-17 14:39:30\ntags:  [php,rabbitmq]\n\n---\n\n### 工作队列\n\n##### （使用[php-amqplib](https://github.com/php-amqplib/php-amqplib)库）\n\n![](/images/rabbitmq/python-two.png)\n\n在本教程[第一部分](/2016/02/28/php-rabbitmq-tutorial-one.html) 我们已经写完了从一个指定队列发送和接收消息的程序。在这一章节中，我们会创建一个工作队列（Work Queue）来分发耗时的任务给多个工作者（worker）。\n\n工作队列（也被称为 任务队列-task queue）主要是避免立即执行资源密集型任务并且还要等待它执行完毕。相反，需要让任务稍后执行，我们把一个任务当做一条信息发送给队列，后台运行的工作者（worker）会取出任务并执行，当运行多个worker时任务会在它们之间共享。\n\n这个概念在web应用中非常有用，可以在短暂的HTTP请求期间处理一些复杂的任务。\n\n### 准备工作\n\n在前面的部分我们发送了一条内容为“Hello World”的信息，现在我们会发送一些字符串，把这些字符串当做复杂的任务，我们并没有一个实际的任务，像是图片缩放，或者转换PDF文件，所以我们使用sleep方法来假设任务很繁忙。我们会在字符串中加入一些“.”来表示复杂复杂程度；每一个“.”表示需要耗时1秒，比如，“Hello ...”代表需要耗时3秒。\n\n我们从上一节的基础上稍微改动了一下send.php，来允许消息可以从命令行发送，这个程序会发送任务到队列中，把它命名为new_task.php\n\n```\n$data = impllode(' ',array_slice($argv,1));\nif(empty($data))$data = \"Hello World\";\n$msg = new AMQPMessage($data,\n\tarray('delivery_mode'=>2)#设置消息持久化，下边会讲到。\n);\n$channel->basic_publish($msg,'','task_queue');\necho \"[x] Sent \",$data,\"\\n\";\n```\n\n上一节的receive.php也需要一些改动：需要为消息中的每一个“.”模拟1秒的工作。它会从队列中取出消息并运行，把它命名为worker.php：\n\n```\n$callback = function($msg){\n\techo \"[x] Received \",$msg->body,\"\\n\";\n\tsleep(substr_count($msg->body,'.'));\n\techo \"[x] Done\",\"\\n\";\n\t$msg->delivery_info['channel]->basic_ack($msg->delivery_info['delivery_tag']);\n};\n\n$channel->basic_gos(null,1,null);\n$channel->basic_consume('task_queue','',false,false,false,false,$callback);\n```\n\n注意我们伪造的任务需要花费时间（即发送的字符串中要有一些\".\"）\n\n然后运行：\n\n```\nphp new_task.php \"A very hard task which takes two seconds..\"\nphp wordker.php\n```\n\n### 轮询分发\n\n使用工作队列的一个好处就是它能够并行的处理队列。如果有太多工作需要处理，只需要添加新的worker就可以了。\n\n首先，我们试着同时运行两个worker.php，它们都会从队列接收到消息，但是到底是不是这样呢？我们看一下。\n\n此时需要打开3个终端，其中两个运行worker.php，这两个就是我们的消费者 - C1和C2。\n\nshell1\n\n```\nphp worker.php\n[*] Waiting for messages. To exit press CTRL+C\n```\nshell2\n\n```\nphp worker.php\n[*] Waiting for messages. To exit press CTRL+C\n```\n\n在第三个终端中我们会发送新的任务，消费者程序开始运行后就可以发送一些消息了。\n\nshell3\n\n```\nphp new_task.php First message.\nphp new_task.php Second message..\nphp new_task.php Third message...\nphp new_task.php Fourth message....\nphp new_task.php Fifth message.....\n```\n\n我们看一下发送给worker的是什么:\n\nshell1\n\n```\nphp worker.php\n[*] Waiting for messages.To exit press CTRL+C\n[x]Received 'First message.'\n[x]Received 'Third message...'\n[x]Received 'Fifth message.....'\n```\nshell2\n\n```\nphp worker.php\n[*] Waiting for messages.To exit press CTRL+C\n[x]Received 'Second message.'\n[x]Received 'Fourth message...'\n```\n\nRabbitMQ会默认按顺序把消息发送给下一个消费者，平均每个消费者都会得到一样多数量的消息，这种分发消息的方式叫做轮询。试着添加三个或更多个worker来运行。\n\n### 消息响应\n\n执行一个任务会消耗一定的时间，也许你想知道如果一个消费者在执行一个耗时较长的任务时但是在执行一部分的时候挂掉会发生什么。在我们当前的代码中，一旦RabbitMQ把消息分发给消费者便会立即从内存中移除。这种情况下，如果停止一个worker，它正在处理的消息就会丢失。同时其他所有发送给这个worker的还没有处理的消息也会丢失。\n\n但是我们不想丢失任何任务，如果一个worker挂掉，需要把任务发送到另一个worker。\n\n为了确保消息永不丢失，RabbitMQ支持消息响应（message acknowledgements），消费者会发送一个响应告诉RabbitMQ已经收到了某条消息，并且已经处理，这样RabbitMQ就可以删掉它了。\n\n如果一个消费者程序在未发送响应之前挂掉了（频道关闭，链接关闭，或者TCP连接丢失），RabbitMQ会认为消息没有完全处理然后会重新推送到队列中。如果此时有其他的消费者程序在运行，RabbitMQ会很快把消息发送给另一个消费者。这样就可以确保消息不会丢失，即使worker偶尔挂掉。\n\n消息是没有超时的概念的，当worker断开连接的时候，RabbitMQ会重新发送消息，这样在处理一个耗时较长的消息任务时就不会出现问题了。\n\n消息响应默认是关闭的。可以通过设置basic_consume的第四个参数为false(true表示不开启应答)，然后在处理完任务的时候从worker发送一个正确的响应内容。\n\n```php\n$callback = function($msg){\n\techo \"[x] Received \",$msg->body,\"\\n\";\n\tsleep(substr_count($msg->body,'.'));\n\techo \"[x] Done\",\"\\n\";\n\t$msg->delivery_info['channel]->basic_ack($msg->delivery_info['delivery_tag]);\n};\n$channel->basic_consume('task_queue','',false,false,false,false,$callback);\n```\n\n这样我们就可以确保当你CTRL+C杀掉一个正在处理消息的worker的时候，消息并不会丢失。在这个worker挂掉之后，所有未响应的消息就会发送。\n\n### 忘了响应\n\n一个很容易犯的错误就是忘了basic_ack，后果很严重。消息会在程序退出后重新发送（可能看起来像是随机返还 原文：which may look like random redelivery），但是如果它不释放未响应的消息，RabbitMQ就会占用越来越多的内存。\n\n为了排除这种错误可以使用rabbitmqctl来打印messages_unacknowledges字段：\n\n```\nsudo rabbitmqctl list_queues name messages_ready messages_unacknowledged\n\nListing queues ...\nhello    0       0\n...done.\n```\n\n\n### 消息持久化\n\n我们已经学习了确保即使消费者程序挂掉，任务也不会丢失。但是任务还是会在RabbitMQ服务停止的时候丢失。\n\n当RabbitMQ退出或崩溃，它会丢失之前所有的队列和消息，除非你特意告诉它。所以我们必须把队列和消息设为持久化。\n\n首先，为了队列不丢失，需要把它声明为<i>持久化（durable）</i>，所以修改queue_declare的第三个参数为true：\n\n```\n$channel->queue_declare('hello',false,true,false,false);\n```\n\n尽管这行代码本身是正确的，但是仍然不会正确运行。因为在之前已经定义过一个非持久化的 hello 队列。RabbitＭＱ不允许使用不同参数重新定义一个已经存在的队列，它会返回一个错误。但是可以用一个快捷的方法去解决，定义一个不同名字的队列，比如 task_queue：\n\n```\n$channel->queue_declare('task_queue',false,true,false,false);\n```\n\n需要把生产者和消费者程序都设置为 true。\n\n这时候，我们就可以确保在RabbitMQ重启之后task_queue队列不会丢失。现在需要设置消息持久化了 - 通过设置AMQPMessage的属性数组中消息属性 delivery_mode = 2来达到。\n\n```\n$msg = new AMQPMessage($data,\n\t\tarray('delivery_mode'=>2) //设置消息持久化\n\t);\n```\n\n### 关于消息持久化的说明\n\n设置消息持久化并不能完全保证消息不会丢失。这只是告诉让RabbitMQ要把消息保存到硬盘，但是从RabbitMQ接收到消息到保存完成仍然还有一个短暂的间隔时间。因为RabbitMQ并不是每一条消息都会使用fsync(2)，可能只是保存到缓存中而不是真正的写到磁盘里。并不能保证消息真正的持久化，但是对于简单的工作队列已经足够了。如果你需要更健壮的持久化，可以使用[publisher confirms](https://www.rabbitmq.com/confirms.html)机制。\n\n\n\n### 公平分发\n\n也许你注意到它仍没有像我们想的那样去派发任务，比如在两个worker的情况下，处理奇数消息的比较繁忙，处理偶数消息的比较轻松，一个worker不断的忙碌而另一个几乎不需要工作，但是RabbitmQ并不知道这些，并且继续一如既往的派发消息。\n\n这是因为RabbitMQ在消息进入队列的时候只管去派发，并不管消费者未做出响应的消息数。它只是把每第n条消息发送给第n个消费者。\n\n我们可以使用basic_qos方法，并设置prefetch_count = 1。这样是告诉RabbitMQ在同一时刻不要发送超过1条消息给一个worker，或者说，不要发送新的消息给worker直到它已处理完上一条消息并作出了响应。这样，它就会把消息发送给下一个空闲的worker了。\n\n![](/images/rabbitmq/prefetch-count.png)\n\n```\n$channel->basic_qos(null,1,null);\n```\n\n### 注意队列长度\n\n如果所有的worker都处于忙碌状态，队列就会填满，你需要留意，添加更多的worker，或者使用其他的策略。\n\n\n### 整合\n\n最终，new_task.php的代码如下：\n\n```php\n<?php\n\nrequire_once __DIR__ .'/verdor/autoload.php';\nuse PhpAmqpLib\\Connection\\AMQPStreamConnection;\nuse PhpAmqpLib\\Message\\AMQPMessage;\n\n$connection = new AMQPStreamConnection('localhost',5672,'guest','guest');\n$channel = $connection->channel();\n\n$channel->queue_declare('task_queue',false,true,false,false);\n\n$data = implode(' ',array_slice($argv,1));\n\nif(empty($data)) $data = \"Hello World!\";\n\n$msg = new AMQPMessage($data,\n\tarray('delivery_mode'=>2) // 消息持久化\n);\n$channel->basic_publish($msg,'','task_queue');\n\necho \"[x]Sent \", $data, \"\\n\";\n\n$channel->close();\n$connection->close();\n?>\n```\n\n[new_task.php源码](https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/php/new_task.php)\n\nworker.php\n\n```php\n<?php\n\nrequire_once __DIR__ .'/vendor/autoload.php';\nuse PhpAmqpLib\\Connection\\AMQPStreamConnection;\n\n$connection = new AMQPStreamConnection('localhost',5672,'guest','guest');\n$channel = $connection->channel();\n\n$channel->queue_declare('task_queue',false,true,false,false);\n\necho '[*] Waiting for messages.To exit press CTRL+C',\"\\n\";\n\n$callback = function($msg){\n\techo \"[x]Received \",$msg->body,\"\\n\";\n\tsleep(substr_count($msg->body,'.'));\n\techo \"[x]Done\",\"\\n\";\n\t$msg->delivery_info['chennel']->basic_ack($msg->delivery_info['delivery_tag']);\n};\n\n$channel->basic_qos(null,1,null);\n$channel->basic_consume('task_queue','',false,false,false,false,$callback);\n\nwhile(count($channel->callbacks)){\n\t$channel->wait();\n}\n\n$channel->close();\n$connection->close();\n?>\n```\n\n[worker.php](http://github.com/rabbitmq/rabbitmq-tutorials/blob/master/php/worker.php)\n\n使用消息应答和prefetch_count=1后，就可以运行一个工作队列了，持久模式选项会在即使RabbitMQ重启的情况下保留任务。\n\n现在我们可以继续学习第三部分的内容，学习如何发送相同的消息给多个消费者。\n\n原文地址：[Work queues](https://www.rabbitmq.com/tutorials/tutorial-two-php.html)\n","slug":"php-rabbitmq-tutorial-two","published":1,"updated":"2016-05-07T14:06:15.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj830jvek002lul0ryxte2vgo","content":"<h3 id=\"工作队列\"><a href=\"#工作队列\" class=\"headerlink\" title=\"工作队列\"></a>工作队列</h3><h5 id=\"（使用php-amqplib库）\"><a href=\"#（使用php-amqplib库）\" class=\"headerlink\" title=\"（使用php-amqplib库）\"></a>（使用<a href=\"https://github.com/php-amqplib/php-amqplib\" target=\"_blank\" rel=\"external\">php-amqplib</a>库）</h5><p><img src=\"/images/rabbitmq/python-two.png\" alt=\"\"></p>\n<p>在本教程<a href=\"/2016/02/28/php-rabbitmq-tutorial-one.html\">第一部分</a> 我们已经写完了从一个指定队列发送和接收消息的程序。在这一章节中，我们会创建一个工作队列（Work Queue）来分发耗时的任务给多个工作者（worker）。</p>\n<p>工作队列（也被称为 任务队列-task queue）主要是避免立即执行资源密集型任务并且还要等待它执行完毕。相反，需要让任务稍后执行，我们把一个任务当做一条信息发送给队列，后台运行的工作者（worker）会取出任务并执行，当运行多个worker时任务会在它们之间共享。</p>\n<p>这个概念在web应用中非常有用，可以在短暂的HTTP请求期间处理一些复杂的任务。</p>\n<h3 id=\"准备工作\"><a href=\"#准备工作\" class=\"headerlink\" title=\"准备工作\"></a>准备工作</h3><p>在前面的部分我们发送了一条内容为“Hello World”的信息，现在我们会发送一些字符串，把这些字符串当做复杂的任务，我们并没有一个实际的任务，像是图片缩放，或者转换PDF文件，所以我们使用sleep方法来假设任务很繁忙。我们会在字符串中加入一些“.”来表示复杂复杂程度；每一个“.”表示需要耗时1秒，比如，“Hello …”代表需要耗时3秒。</p>\n<p>我们从上一节的基础上稍微改动了一下send.php，来允许消息可以从命令行发送，这个程序会发送任务到队列中，把它命名为new_task.php</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">$data = impllode(&apos; &apos;,array_slice($argv,1));</div><div class=\"line\">if(empty($data))$data = &quot;Hello World&quot;;</div><div class=\"line\">$msg = new AMQPMessage($data,</div><div class=\"line\">\tarray(&apos;delivery_mode&apos;=&gt;2)#设置消息持久化，下边会讲到。</div><div class=\"line\">);</div><div class=\"line\">$channel-&gt;basic_publish($msg,&apos;&apos;,&apos;task_queue&apos;);</div><div class=\"line\">echo &quot;[x] Sent &quot;,$data,&quot;\\n&quot;;</div></pre></td></tr></table></figure>\n<p>上一节的receive.php也需要一些改动：需要为消息中的每一个“.”模拟1秒的工作。它会从队列中取出消息并运行，把它命名为worker.php：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\">$callback = function($msg)&#123;</div><div class=\"line\">\techo &quot;[x] Received &quot;,$msg-&gt;body,&quot;\\n&quot;;</div><div class=\"line\">\tsleep(substr_count($msg-&gt;body,&apos;.&apos;));</div><div class=\"line\">\techo &quot;[x] Done&quot;,&quot;\\n&quot;;</div><div class=\"line\">\t$msg-&gt;delivery_info[&apos;channel]-&gt;basic_ack($msg-&gt;delivery_info[&apos;delivery_tag&apos;]);</div><div class=\"line\">&#125;;</div><div class=\"line\"></div><div class=\"line\">$channel-&gt;basic_gos(null,1,null);</div><div class=\"line\">$channel-&gt;basic_consume(&apos;task_queue&apos;,&apos;&apos;,false,false,false,false,$callback);</div></pre></td></tr></table></figure>\n<p>注意我们伪造的任务需要花费时间（即发送的字符串中要有一些”.”）</p>\n<p>然后运行：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">php new_task.php &quot;A very hard task which takes two seconds..&quot;</div><div class=\"line\">php wordker.php</div></pre></td></tr></table></figure>\n<h3 id=\"轮询分发\"><a href=\"#轮询分发\" class=\"headerlink\" title=\"轮询分发\"></a>轮询分发</h3><p>使用工作队列的一个好处就是它能够并行的处理队列。如果有太多工作需要处理，只需要添加新的worker就可以了。</p>\n<p>首先，我们试着同时运行两个worker.php，它们都会从队列接收到消息，但是到底是不是这样呢？我们看一下。</p>\n<p>此时需要打开3个终端，其中两个运行worker.php，这两个就是我们的消费者 - C1和C2。</p>\n<p>shell1</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">php worker.php</div><div class=\"line\">[*] Waiting for messages. To exit press CTRL+C</div></pre></td></tr></table></figure>\n<p>shell2</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">php worker.php</div><div class=\"line\">[*] Waiting for messages. To exit press CTRL+C</div></pre></td></tr></table></figure>\n<p>在第三个终端中我们会发送新的任务，消费者程序开始运行后就可以发送一些消息了。</p>\n<p>shell3</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">php new_task.php First message.</div><div class=\"line\">php new_task.php Second message..</div><div class=\"line\">php new_task.php Third message...</div><div class=\"line\">php new_task.php Fourth message....</div><div class=\"line\">php new_task.php Fifth message.....</div></pre></td></tr></table></figure>\n<p>我们看一下发送给worker的是什么:</p>\n<p>shell1</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">php worker.php</div><div class=\"line\">[*] Waiting for messages.To exit press CTRL+C</div><div class=\"line\">[x]Received &apos;First message.&apos;</div><div class=\"line\">[x]Received &apos;Third message...&apos;</div><div class=\"line\">[x]Received &apos;Fifth message.....&apos;</div></pre></td></tr></table></figure>\n<p>shell2</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">php worker.php</div><div class=\"line\">[*] Waiting for messages.To exit press CTRL+C</div><div class=\"line\">[x]Received &apos;Second message.&apos;</div><div class=\"line\">[x]Received &apos;Fourth message...&apos;</div></pre></td></tr></table></figure>\n<p>RabbitMQ会默认按顺序把消息发送给下一个消费者，平均每个消费者都会得到一样多数量的消息，这种分发消息的方式叫做轮询。试着添加三个或更多个worker来运行。</p>\n<h3 id=\"消息响应\"><a href=\"#消息响应\" class=\"headerlink\" title=\"消息响应\"></a>消息响应</h3><p>执行一个任务会消耗一定的时间，也许你想知道如果一个消费者在执行一个耗时较长的任务时但是在执行一部分的时候挂掉会发生什么。在我们当前的代码中，一旦RabbitMQ把消息分发给消费者便会立即从内存中移除。这种情况下，如果停止一个worker，它正在处理的消息就会丢失。同时其他所有发送给这个worker的还没有处理的消息也会丢失。</p>\n<p>但是我们不想丢失任何任务，如果一个worker挂掉，需要把任务发送到另一个worker。</p>\n<p>为了确保消息永不丢失，RabbitMQ支持消息响应（message acknowledgements），消费者会发送一个响应告诉RabbitMQ已经收到了某条消息，并且已经处理，这样RabbitMQ就可以删掉它了。</p>\n<p>如果一个消费者程序在未发送响应之前挂掉了（频道关闭，链接关闭，或者TCP连接丢失），RabbitMQ会认为消息没有完全处理然后会重新推送到队列中。如果此时有其他的消费者程序在运行，RabbitMQ会很快把消息发送给另一个消费者。这样就可以确保消息不会丢失，即使worker偶尔挂掉。</p>\n<p>消息是没有超时的概念的，当worker断开连接的时候，RabbitMQ会重新发送消息，这样在处理一个耗时较长的消息任务时就不会出现问题了。</p>\n<p>消息响应默认是关闭的。可以通过设置basic_consume的第四个参数为false(true表示不开启应答)，然后在处理完任务的时候从worker发送一个正确的响应内容。</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">$callback = <span class=\"function\"><span class=\"keyword\">function</span><span class=\"params\">($msg)</span></span>&#123;</div><div class=\"line\">\t<span class=\"keyword\">echo</span> <span class=\"string\">\"[x] Received \"</span>,$msg-&gt;body,<span class=\"string\">\"\\n\"</span>;</div><div class=\"line\">\tsleep(substr_count($msg-&gt;body,<span class=\"string\">'.'</span>));</div><div class=\"line\">\t<span class=\"keyword\">echo</span> <span class=\"string\">\"[x] Done\"</span>,<span class=\"string\">\"\\n\"</span>;</div><div class=\"line\">\t$msg-&gt;delivery_info[<span class=\"string\">'channel]-&gt;basic_ack($msg-&gt;delivery_info['</span>delivery_tag]);</div><div class=\"line\">&#125;;</div><div class=\"line\">$channel-&gt;basic_consume(<span class=\"string\">'task_queue'</span>,<span class=\"string\">''</span>,<span class=\"keyword\">false</span>,<span class=\"keyword\">false</span>,<span class=\"keyword\">false</span>,<span class=\"keyword\">false</span>,$callback);</div></pre></td></tr></table></figure>\n<p>这样我们就可以确保当你CTRL+C杀掉一个正在处理消息的worker的时候，消息并不会丢失。在这个worker挂掉之后，所有未响应的消息就会发送。</p>\n<h3 id=\"忘了响应\"><a href=\"#忘了响应\" class=\"headerlink\" title=\"忘了响应\"></a>忘了响应</h3><p>一个很容易犯的错误就是忘了basic_ack，后果很严重。消息会在程序退出后重新发送（可能看起来像是随机返还 原文：which may look like random redelivery），但是如果它不释放未响应的消息，RabbitMQ就会占用越来越多的内存。</p>\n<p>为了排除这种错误可以使用rabbitmqctl来打印messages_unacknowledges字段：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">sudo rabbitmqctl list_queues name messages_ready messages_unacknowledged</div><div class=\"line\"></div><div class=\"line\">Listing queues ...</div><div class=\"line\">hello    0       0</div><div class=\"line\">...done.</div></pre></td></tr></table></figure>\n<h3 id=\"消息持久化\"><a href=\"#消息持久化\" class=\"headerlink\" title=\"消息持久化\"></a>消息持久化</h3><p>我们已经学习了确保即使消费者程序挂掉，任务也不会丢失。但是任务还是会在RabbitMQ服务停止的时候丢失。</p>\n<p>当RabbitMQ退出或崩溃，它会丢失之前所有的队列和消息，除非你特意告诉它。所以我们必须把队列和消息设为持久化。</p>\n<p>首先，为了队列不丢失，需要把它声明为<i>持久化（durable）</i>，所以修改queue_declare的第三个参数为true：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$channel-&gt;queue_declare(&apos;hello&apos;,false,true,false,false);</div></pre></td></tr></table></figure>\n<p>尽管这行代码本身是正确的，但是仍然不会正确运行。因为在之前已经定义过一个非持久化的 hello 队列。RabbitＭＱ不允许使用不同参数重新定义一个已经存在的队列，它会返回一个错误。但是可以用一个快捷的方法去解决，定义一个不同名字的队列，比如 task_queue：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$channel-&gt;queue_declare(&apos;task_queue&apos;,false,true,false,false);</div></pre></td></tr></table></figure>\n<p>需要把生产者和消费者程序都设置为 true。</p>\n<p>这时候，我们就可以确保在RabbitMQ重启之后task_queue队列不会丢失。现在需要设置消息持久化了 - 通过设置AMQPMessage的属性数组中消息属性 delivery_mode = 2来达到。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">$msg = new AMQPMessage($data,</div><div class=\"line\">\t\tarray(&apos;delivery_mode&apos;=&gt;2) //设置消息持久化</div><div class=\"line\">\t);</div></pre></td></tr></table></figure>\n<h3 id=\"关于消息持久化的说明\"><a href=\"#关于消息持久化的说明\" class=\"headerlink\" title=\"关于消息持久化的说明\"></a>关于消息持久化的说明</h3><p>设置消息持久化并不能完全保证消息不会丢失。这只是告诉让RabbitMQ要把消息保存到硬盘，但是从RabbitMQ接收到消息到保存完成仍然还有一个短暂的间隔时间。因为RabbitMQ并不是每一条消息都会使用fsync(2)，可能只是保存到缓存中而不是真正的写到磁盘里。并不能保证消息真正的持久化，但是对于简单的工作队列已经足够了。如果你需要更健壮的持久化，可以使用<a href=\"https://www.rabbitmq.com/confirms.html\" target=\"_blank\" rel=\"external\">publisher confirms</a>机制。</p>\n<h3 id=\"公平分发\"><a href=\"#公平分发\" class=\"headerlink\" title=\"公平分发\"></a>公平分发</h3><p>也许你注意到它仍没有像我们想的那样去派发任务，比如在两个worker的情况下，处理奇数消息的比较繁忙，处理偶数消息的比较轻松，一个worker不断的忙碌而另一个几乎不需要工作，但是RabbitmQ并不知道这些，并且继续一如既往的派发消息。</p>\n<p>这是因为RabbitMQ在消息进入队列的时候只管去派发，并不管消费者未做出响应的消息数。它只是把每第n条消息发送给第n个消费者。</p>\n<p>我们可以使用basic_qos方法，并设置prefetch_count = 1。这样是告诉RabbitMQ在同一时刻不要发送超过1条消息给一个worker，或者说，不要发送新的消息给worker直到它已处理完上一条消息并作出了响应。这样，它就会把消息发送给下一个空闲的worker了。</p>\n<p><img src=\"/images/rabbitmq/prefetch-count.png\" alt=\"\"></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$channel-&gt;basic_qos(null,1,null);</div></pre></td></tr></table></figure>\n<h3 id=\"注意队列长度\"><a href=\"#注意队列长度\" class=\"headerlink\" title=\"注意队列长度\"></a>注意队列长度</h3><p>如果所有的worker都处于忙碌状态，队列就会填满，你需要留意，添加更多的worker，或者使用其他的策略。</p>\n<h3 id=\"整合\"><a href=\"#整合\" class=\"headerlink\" title=\"整合\"></a>整合</h3><p>最终，new_task.php的代码如下：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">require_once</span> <span class=\"keyword\">__DIR__</span> .<span class=\"string\">'/verdor/autoload.php'</span>;</div><div class=\"line\"><span class=\"keyword\">use</span> <span class=\"title\">PhpAmqpLib</span>\\<span class=\"title\">Connection</span>\\<span class=\"title\">AMQPStreamConnection</span>;</div><div class=\"line\"><span class=\"keyword\">use</span> <span class=\"title\">PhpAmqpLib</span>\\<span class=\"title\">Message</span>\\<span class=\"title\">AMQPMessage</span>;</div><div class=\"line\"></div><div class=\"line\">$connection = <span class=\"keyword\">new</span> AMQPStreamConnection(<span class=\"string\">'localhost'</span>,<span class=\"number\">5672</span>,<span class=\"string\">'guest'</span>,<span class=\"string\">'guest'</span>);</div><div class=\"line\">$channel = $connection-&gt;channel();</div><div class=\"line\"></div><div class=\"line\">$channel-&gt;queue_declare(<span class=\"string\">'task_queue'</span>,<span class=\"keyword\">false</span>,<span class=\"keyword\">true</span>,<span class=\"keyword\">false</span>,<span class=\"keyword\">false</span>);</div><div class=\"line\"></div><div class=\"line\">$data = implode(<span class=\"string\">' '</span>,array_slice($argv,<span class=\"number\">1</span>));</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">if</span>(<span class=\"keyword\">empty</span>($data)) $data = <span class=\"string\">\"Hello World!\"</span>;</div><div class=\"line\"></div><div class=\"line\">$msg = <span class=\"keyword\">new</span> AMQPMessage($data,</div><div class=\"line\">\t<span class=\"keyword\">array</span>(<span class=\"string\">'delivery_mode'</span>=&gt;<span class=\"number\">2</span>) <span class=\"comment\">// 消息持久化</span></div><div class=\"line\">);</div><div class=\"line\">$channel-&gt;basic_publish($msg,<span class=\"string\">''</span>,<span class=\"string\">'task_queue'</span>);</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">echo</span> <span class=\"string\">\"[x]Sent \"</span>, $data, <span class=\"string\">\"\\n\"</span>;</div><div class=\"line\"></div><div class=\"line\">$channel-&gt;close();</div><div class=\"line\">$connection-&gt;close();</div><div class=\"line\"><span class=\"meta\">?&gt;</span></div></pre></td></tr></table></figure>\n<p><a href=\"https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/php/new_task.php\" target=\"_blank\" rel=\"external\">new_task.php源码</a></p>\n<p>worker.php</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">require_once</span> <span class=\"keyword\">__DIR__</span> .<span class=\"string\">'/vendor/autoload.php'</span>;</div><div class=\"line\"><span class=\"keyword\">use</span> <span class=\"title\">PhpAmqpLib</span>\\<span class=\"title\">Connection</span>\\<span class=\"title\">AMQPStreamConnection</span>;</div><div class=\"line\"></div><div class=\"line\">$connection = <span class=\"keyword\">new</span> AMQPStreamConnection(<span class=\"string\">'localhost'</span>,<span class=\"number\">5672</span>,<span class=\"string\">'guest'</span>,<span class=\"string\">'guest'</span>);</div><div class=\"line\">$channel = $connection-&gt;channel();</div><div class=\"line\"></div><div class=\"line\">$channel-&gt;queue_declare(<span class=\"string\">'task_queue'</span>,<span class=\"keyword\">false</span>,<span class=\"keyword\">true</span>,<span class=\"keyword\">false</span>,<span class=\"keyword\">false</span>);</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">echo</span> <span class=\"string\">'[*] Waiting for messages.To exit press CTRL+C'</span>,<span class=\"string\">\"\\n\"</span>;</div><div class=\"line\"></div><div class=\"line\">$callback = <span class=\"function\"><span class=\"keyword\">function</span><span class=\"params\">($msg)</span></span>&#123;</div><div class=\"line\">\t<span class=\"keyword\">echo</span> <span class=\"string\">\"[x]Received \"</span>,$msg-&gt;body,<span class=\"string\">\"\\n\"</span>;</div><div class=\"line\">\tsleep(substr_count($msg-&gt;body,<span class=\"string\">'.'</span>));</div><div class=\"line\">\t<span class=\"keyword\">echo</span> <span class=\"string\">\"[x]Done\"</span>,<span class=\"string\">\"\\n\"</span>;</div><div class=\"line\">\t$msg-&gt;delivery_info[<span class=\"string\">'chennel'</span>]-&gt;basic_ack($msg-&gt;delivery_info[<span class=\"string\">'delivery_tag'</span>]);</div><div class=\"line\">&#125;;</div><div class=\"line\"></div><div class=\"line\">$channel-&gt;basic_qos(<span class=\"keyword\">null</span>,<span class=\"number\">1</span>,<span class=\"keyword\">null</span>);</div><div class=\"line\">$channel-&gt;basic_consume(<span class=\"string\">'task_queue'</span>,<span class=\"string\">''</span>,<span class=\"keyword\">false</span>,<span class=\"keyword\">false</span>,<span class=\"keyword\">false</span>,<span class=\"keyword\">false</span>,$callback);</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">while</span>(count($channel-&gt;callbacks))&#123;</div><div class=\"line\">\t$channel-&gt;wait();</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\">$channel-&gt;close();</div><div class=\"line\">$connection-&gt;close();</div><div class=\"line\"><span class=\"meta\">?&gt;</span></div></pre></td></tr></table></figure>\n<p><a href=\"http://github.com/rabbitmq/rabbitmq-tutorials/blob/master/php/worker.php\" target=\"_blank\" rel=\"external\">worker.php</a></p>\n<p>使用消息应答和prefetch_count=1后，就可以运行一个工作队列了，持久模式选项会在即使RabbitMQ重启的情况下保留任务。</p>\n<p>现在我们可以继续学习第三部分的内容，学习如何发送相同的消息给多个消费者。</p>\n<p>原文地址：<a href=\"https://www.rabbitmq.com/tutorials/tutorial-two-php.html\" target=\"_blank\" rel=\"external\">Work queues</a></p>\n","site":{"data":{}},"excerpt":"","more":"<h3 id=\"工作队列\"><a href=\"#工作队列\" class=\"headerlink\" title=\"工作队列\"></a>工作队列</h3><h5 id=\"（使用php-amqplib库）\"><a href=\"#（使用php-amqplib库）\" class=\"headerlink\" title=\"（使用php-amqplib库）\"></a>（使用<a href=\"https://github.com/php-amqplib/php-amqplib\" target=\"_blank\" rel=\"external\">php-amqplib</a>库）</h5><p><img src=\"/images/rabbitmq/python-two.png\" alt=\"\"></p>\n<p>在本教程<a href=\"/2016/02/28/php-rabbitmq-tutorial-one.html\">第一部分</a> 我们已经写完了从一个指定队列发送和接收消息的程序。在这一章节中，我们会创建一个工作队列（Work Queue）来分发耗时的任务给多个工作者（worker）。</p>\n<p>工作队列（也被称为 任务队列-task queue）主要是避免立即执行资源密集型任务并且还要等待它执行完毕。相反，需要让任务稍后执行，我们把一个任务当做一条信息发送给队列，后台运行的工作者（worker）会取出任务并执行，当运行多个worker时任务会在它们之间共享。</p>\n<p>这个概念在web应用中非常有用，可以在短暂的HTTP请求期间处理一些复杂的任务。</p>\n<h3 id=\"准备工作\"><a href=\"#准备工作\" class=\"headerlink\" title=\"准备工作\"></a>准备工作</h3><p>在前面的部分我们发送了一条内容为“Hello World”的信息，现在我们会发送一些字符串，把这些字符串当做复杂的任务，我们并没有一个实际的任务，像是图片缩放，或者转换PDF文件，所以我们使用sleep方法来假设任务很繁忙。我们会在字符串中加入一些“.”来表示复杂复杂程度；每一个“.”表示需要耗时1秒，比如，“Hello …”代表需要耗时3秒。</p>\n<p>我们从上一节的基础上稍微改动了一下send.php，来允许消息可以从命令行发送，这个程序会发送任务到队列中，把它命名为new_task.php</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">$data = impllode(&apos; &apos;,array_slice($argv,1));</div><div class=\"line\">if(empty($data))$data = &quot;Hello World&quot;;</div><div class=\"line\">$msg = new AMQPMessage($data,</div><div class=\"line\">\tarray(&apos;delivery_mode&apos;=&gt;2)#设置消息持久化，下边会讲到。</div><div class=\"line\">);</div><div class=\"line\">$channel-&gt;basic_publish($msg,&apos;&apos;,&apos;task_queue&apos;);</div><div class=\"line\">echo &quot;[x] Sent &quot;,$data,&quot;\\n&quot;;</div></pre></td></tr></table></figure>\n<p>上一节的receive.php也需要一些改动：需要为消息中的每一个“.”模拟1秒的工作。它会从队列中取出消息并运行，把它命名为worker.php：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\">$callback = function($msg)&#123;</div><div class=\"line\">\techo &quot;[x] Received &quot;,$msg-&gt;body,&quot;\\n&quot;;</div><div class=\"line\">\tsleep(substr_count($msg-&gt;body,&apos;.&apos;));</div><div class=\"line\">\techo &quot;[x] Done&quot;,&quot;\\n&quot;;</div><div class=\"line\">\t$msg-&gt;delivery_info[&apos;channel]-&gt;basic_ack($msg-&gt;delivery_info[&apos;delivery_tag&apos;]);</div><div class=\"line\">&#125;;</div><div class=\"line\"></div><div class=\"line\">$channel-&gt;basic_gos(null,1,null);</div><div class=\"line\">$channel-&gt;basic_consume(&apos;task_queue&apos;,&apos;&apos;,false,false,false,false,$callback);</div></pre></td></tr></table></figure>\n<p>注意我们伪造的任务需要花费时间（即发送的字符串中要有一些”.”）</p>\n<p>然后运行：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">php new_task.php &quot;A very hard task which takes two seconds..&quot;</div><div class=\"line\">php wordker.php</div></pre></td></tr></table></figure>\n<h3 id=\"轮询分发\"><a href=\"#轮询分发\" class=\"headerlink\" title=\"轮询分发\"></a>轮询分发</h3><p>使用工作队列的一个好处就是它能够并行的处理队列。如果有太多工作需要处理，只需要添加新的worker就可以了。</p>\n<p>首先，我们试着同时运行两个worker.php，它们都会从队列接收到消息，但是到底是不是这样呢？我们看一下。</p>\n<p>此时需要打开3个终端，其中两个运行worker.php，这两个就是我们的消费者 - C1和C2。</p>\n<p>shell1</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">php worker.php</div><div class=\"line\">[*] Waiting for messages. To exit press CTRL+C</div></pre></td></tr></table></figure>\n<p>shell2</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">php worker.php</div><div class=\"line\">[*] Waiting for messages. To exit press CTRL+C</div></pre></td></tr></table></figure>\n<p>在第三个终端中我们会发送新的任务，消费者程序开始运行后就可以发送一些消息了。</p>\n<p>shell3</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">php new_task.php First message.</div><div class=\"line\">php new_task.php Second message..</div><div class=\"line\">php new_task.php Third message...</div><div class=\"line\">php new_task.php Fourth message....</div><div class=\"line\">php new_task.php Fifth message.....</div></pre></td></tr></table></figure>\n<p>我们看一下发送给worker的是什么:</p>\n<p>shell1</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">php worker.php</div><div class=\"line\">[*] Waiting for messages.To exit press CTRL+C</div><div class=\"line\">[x]Received &apos;First message.&apos;</div><div class=\"line\">[x]Received &apos;Third message...&apos;</div><div class=\"line\">[x]Received &apos;Fifth message.....&apos;</div></pre></td></tr></table></figure>\n<p>shell2</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">php worker.php</div><div class=\"line\">[*] Waiting for messages.To exit press CTRL+C</div><div class=\"line\">[x]Received &apos;Second message.&apos;</div><div class=\"line\">[x]Received &apos;Fourth message...&apos;</div></pre></td></tr></table></figure>\n<p>RabbitMQ会默认按顺序把消息发送给下一个消费者，平均每个消费者都会得到一样多数量的消息，这种分发消息的方式叫做轮询。试着添加三个或更多个worker来运行。</p>\n<h3 id=\"消息响应\"><a href=\"#消息响应\" class=\"headerlink\" title=\"消息响应\"></a>消息响应</h3><p>执行一个任务会消耗一定的时间，也许你想知道如果一个消费者在执行一个耗时较长的任务时但是在执行一部分的时候挂掉会发生什么。在我们当前的代码中，一旦RabbitMQ把消息分发给消费者便会立即从内存中移除。这种情况下，如果停止一个worker，它正在处理的消息就会丢失。同时其他所有发送给这个worker的还没有处理的消息也会丢失。</p>\n<p>但是我们不想丢失任何任务，如果一个worker挂掉，需要把任务发送到另一个worker。</p>\n<p>为了确保消息永不丢失，RabbitMQ支持消息响应（message acknowledgements），消费者会发送一个响应告诉RabbitMQ已经收到了某条消息，并且已经处理，这样RabbitMQ就可以删掉它了。</p>\n<p>如果一个消费者程序在未发送响应之前挂掉了（频道关闭，链接关闭，或者TCP连接丢失），RabbitMQ会认为消息没有完全处理然后会重新推送到队列中。如果此时有其他的消费者程序在运行，RabbitMQ会很快把消息发送给另一个消费者。这样就可以确保消息不会丢失，即使worker偶尔挂掉。</p>\n<p>消息是没有超时的概念的，当worker断开连接的时候，RabbitMQ会重新发送消息，这样在处理一个耗时较长的消息任务时就不会出现问题了。</p>\n<p>消息响应默认是关闭的。可以通过设置basic_consume的第四个参数为false(true表示不开启应答)，然后在处理完任务的时候从worker发送一个正确的响应内容。</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">$callback = <span class=\"function\"><span class=\"keyword\">function</span><span class=\"params\">($msg)</span></span>&#123;</div><div class=\"line\">\t<span class=\"keyword\">echo</span> <span class=\"string\">\"[x] Received \"</span>,$msg-&gt;body,<span class=\"string\">\"\\n\"</span>;</div><div class=\"line\">\tsleep(substr_count($msg-&gt;body,<span class=\"string\">'.'</span>));</div><div class=\"line\">\t<span class=\"keyword\">echo</span> <span class=\"string\">\"[x] Done\"</span>,<span class=\"string\">\"\\n\"</span>;</div><div class=\"line\">\t$msg-&gt;delivery_info[<span class=\"string\">'channel]-&gt;basic_ack($msg-&gt;delivery_info['</span>delivery_tag]);</div><div class=\"line\">&#125;;</div><div class=\"line\">$channel-&gt;basic_consume(<span class=\"string\">'task_queue'</span>,<span class=\"string\">''</span>,<span class=\"keyword\">false</span>,<span class=\"keyword\">false</span>,<span class=\"keyword\">false</span>,<span class=\"keyword\">false</span>,$callback);</div></pre></td></tr></table></figure>\n<p>这样我们就可以确保当你CTRL+C杀掉一个正在处理消息的worker的时候，消息并不会丢失。在这个worker挂掉之后，所有未响应的消息就会发送。</p>\n<h3 id=\"忘了响应\"><a href=\"#忘了响应\" class=\"headerlink\" title=\"忘了响应\"></a>忘了响应</h3><p>一个很容易犯的错误就是忘了basic_ack，后果很严重。消息会在程序退出后重新发送（可能看起来像是随机返还 原文：which may look like random redelivery），但是如果它不释放未响应的消息，RabbitMQ就会占用越来越多的内存。</p>\n<p>为了排除这种错误可以使用rabbitmqctl来打印messages_unacknowledges字段：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">sudo rabbitmqctl list_queues name messages_ready messages_unacknowledged</div><div class=\"line\"></div><div class=\"line\">Listing queues ...</div><div class=\"line\">hello    0       0</div><div class=\"line\">...done.</div></pre></td></tr></table></figure>\n<h3 id=\"消息持久化\"><a href=\"#消息持久化\" class=\"headerlink\" title=\"消息持久化\"></a>消息持久化</h3><p>我们已经学习了确保即使消费者程序挂掉，任务也不会丢失。但是任务还是会在RabbitMQ服务停止的时候丢失。</p>\n<p>当RabbitMQ退出或崩溃，它会丢失之前所有的队列和消息，除非你特意告诉它。所以我们必须把队列和消息设为持久化。</p>\n<p>首先，为了队列不丢失，需要把它声明为<i>持久化（durable）</i>，所以修改queue_declare的第三个参数为true：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$channel-&gt;queue_declare(&apos;hello&apos;,false,true,false,false);</div></pre></td></tr></table></figure>\n<p>尽管这行代码本身是正确的，但是仍然不会正确运行。因为在之前已经定义过一个非持久化的 hello 队列。RabbitＭＱ不允许使用不同参数重新定义一个已经存在的队列，它会返回一个错误。但是可以用一个快捷的方法去解决，定义一个不同名字的队列，比如 task_queue：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$channel-&gt;queue_declare(&apos;task_queue&apos;,false,true,false,false);</div></pre></td></tr></table></figure>\n<p>需要把生产者和消费者程序都设置为 true。</p>\n<p>这时候，我们就可以确保在RabbitMQ重启之后task_queue队列不会丢失。现在需要设置消息持久化了 - 通过设置AMQPMessage的属性数组中消息属性 delivery_mode = 2来达到。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">$msg = new AMQPMessage($data,</div><div class=\"line\">\t\tarray(&apos;delivery_mode&apos;=&gt;2) //设置消息持久化</div><div class=\"line\">\t);</div></pre></td></tr></table></figure>\n<h3 id=\"关于消息持久化的说明\"><a href=\"#关于消息持久化的说明\" class=\"headerlink\" title=\"关于消息持久化的说明\"></a>关于消息持久化的说明</h3><p>设置消息持久化并不能完全保证消息不会丢失。这只是告诉让RabbitMQ要把消息保存到硬盘，但是从RabbitMQ接收到消息到保存完成仍然还有一个短暂的间隔时间。因为RabbitMQ并不是每一条消息都会使用fsync(2)，可能只是保存到缓存中而不是真正的写到磁盘里。并不能保证消息真正的持久化，但是对于简单的工作队列已经足够了。如果你需要更健壮的持久化，可以使用<a href=\"https://www.rabbitmq.com/confirms.html\" target=\"_blank\" rel=\"external\">publisher confirms</a>机制。</p>\n<h3 id=\"公平分发\"><a href=\"#公平分发\" class=\"headerlink\" title=\"公平分发\"></a>公平分发</h3><p>也许你注意到它仍没有像我们想的那样去派发任务，比如在两个worker的情况下，处理奇数消息的比较繁忙，处理偶数消息的比较轻松，一个worker不断的忙碌而另一个几乎不需要工作，但是RabbitmQ并不知道这些，并且继续一如既往的派发消息。</p>\n<p>这是因为RabbitMQ在消息进入队列的时候只管去派发，并不管消费者未做出响应的消息数。它只是把每第n条消息发送给第n个消费者。</p>\n<p>我们可以使用basic_qos方法，并设置prefetch_count = 1。这样是告诉RabbitMQ在同一时刻不要发送超过1条消息给一个worker，或者说，不要发送新的消息给worker直到它已处理完上一条消息并作出了响应。这样，它就会把消息发送给下一个空闲的worker了。</p>\n<p><img src=\"/images/rabbitmq/prefetch-count.png\" alt=\"\"></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$channel-&gt;basic_qos(null,1,null);</div></pre></td></tr></table></figure>\n<h3 id=\"注意队列长度\"><a href=\"#注意队列长度\" class=\"headerlink\" title=\"注意队列长度\"></a>注意队列长度</h3><p>如果所有的worker都处于忙碌状态，队列就会填满，你需要留意，添加更多的worker，或者使用其他的策略。</p>\n<h3 id=\"整合\"><a href=\"#整合\" class=\"headerlink\" title=\"整合\"></a>整合</h3><p>最终，new_task.php的代码如下：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">require_once</span> <span class=\"keyword\">__DIR__</span> .<span class=\"string\">'/verdor/autoload.php'</span>;</div><div class=\"line\"><span class=\"keyword\">use</span> <span class=\"title\">PhpAmqpLib</span>\\<span class=\"title\">Connection</span>\\<span class=\"title\">AMQPStreamConnection</span>;</div><div class=\"line\"><span class=\"keyword\">use</span> <span class=\"title\">PhpAmqpLib</span>\\<span class=\"title\">Message</span>\\<span class=\"title\">AMQPMessage</span>;</div><div class=\"line\"></div><div class=\"line\">$connection = <span class=\"keyword\">new</span> AMQPStreamConnection(<span class=\"string\">'localhost'</span>,<span class=\"number\">5672</span>,<span class=\"string\">'guest'</span>,<span class=\"string\">'guest'</span>);</div><div class=\"line\">$channel = $connection-&gt;channel();</div><div class=\"line\"></div><div class=\"line\">$channel-&gt;queue_declare(<span class=\"string\">'task_queue'</span>,<span class=\"keyword\">false</span>,<span class=\"keyword\">true</span>,<span class=\"keyword\">false</span>,<span class=\"keyword\">false</span>);</div><div class=\"line\"></div><div class=\"line\">$data = implode(<span class=\"string\">' '</span>,array_slice($argv,<span class=\"number\">1</span>));</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">if</span>(<span class=\"keyword\">empty</span>($data)) $data = <span class=\"string\">\"Hello World!\"</span>;</div><div class=\"line\"></div><div class=\"line\">$msg = <span class=\"keyword\">new</span> AMQPMessage($data,</div><div class=\"line\">\t<span class=\"keyword\">array</span>(<span class=\"string\">'delivery_mode'</span>=&gt;<span class=\"number\">2</span>) <span class=\"comment\">// 消息持久化</span></div><div class=\"line\">);</div><div class=\"line\">$channel-&gt;basic_publish($msg,<span class=\"string\">''</span>,<span class=\"string\">'task_queue'</span>);</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">echo</span> <span class=\"string\">\"[x]Sent \"</span>, $data, <span class=\"string\">\"\\n\"</span>;</div><div class=\"line\"></div><div class=\"line\">$channel-&gt;close();</div><div class=\"line\">$connection-&gt;close();</div><div class=\"line\"><span class=\"meta\">?&gt;</span></div></pre></td></tr></table></figure>\n<p><a href=\"https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/php/new_task.php\" target=\"_blank\" rel=\"external\">new_task.php源码</a></p>\n<p>worker.php</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">require_once</span> <span class=\"keyword\">__DIR__</span> .<span class=\"string\">'/vendor/autoload.php'</span>;</div><div class=\"line\"><span class=\"keyword\">use</span> <span class=\"title\">PhpAmqpLib</span>\\<span class=\"title\">Connection</span>\\<span class=\"title\">AMQPStreamConnection</span>;</div><div class=\"line\"></div><div class=\"line\">$connection = <span class=\"keyword\">new</span> AMQPStreamConnection(<span class=\"string\">'localhost'</span>,<span class=\"number\">5672</span>,<span class=\"string\">'guest'</span>,<span class=\"string\">'guest'</span>);</div><div class=\"line\">$channel = $connection-&gt;channel();</div><div class=\"line\"></div><div class=\"line\">$channel-&gt;queue_declare(<span class=\"string\">'task_queue'</span>,<span class=\"keyword\">false</span>,<span class=\"keyword\">true</span>,<span class=\"keyword\">false</span>,<span class=\"keyword\">false</span>);</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">echo</span> <span class=\"string\">'[*] Waiting for messages.To exit press CTRL+C'</span>,<span class=\"string\">\"\\n\"</span>;</div><div class=\"line\"></div><div class=\"line\">$callback = <span class=\"function\"><span class=\"keyword\">function</span><span class=\"params\">($msg)</span></span>&#123;</div><div class=\"line\">\t<span class=\"keyword\">echo</span> <span class=\"string\">\"[x]Received \"</span>,$msg-&gt;body,<span class=\"string\">\"\\n\"</span>;</div><div class=\"line\">\tsleep(substr_count($msg-&gt;body,<span class=\"string\">'.'</span>));</div><div class=\"line\">\t<span class=\"keyword\">echo</span> <span class=\"string\">\"[x]Done\"</span>,<span class=\"string\">\"\\n\"</span>;</div><div class=\"line\">\t$msg-&gt;delivery_info[<span class=\"string\">'chennel'</span>]-&gt;basic_ack($msg-&gt;delivery_info[<span class=\"string\">'delivery_tag'</span>]);</div><div class=\"line\">&#125;;</div><div class=\"line\"></div><div class=\"line\">$channel-&gt;basic_qos(<span class=\"keyword\">null</span>,<span class=\"number\">1</span>,<span class=\"keyword\">null</span>);</div><div class=\"line\">$channel-&gt;basic_consume(<span class=\"string\">'task_queue'</span>,<span class=\"string\">''</span>,<span class=\"keyword\">false</span>,<span class=\"keyword\">false</span>,<span class=\"keyword\">false</span>,<span class=\"keyword\">false</span>,$callback);</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">while</span>(count($channel-&gt;callbacks))&#123;</div><div class=\"line\">\t$channel-&gt;wait();</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\">$channel-&gt;close();</div><div class=\"line\">$connection-&gt;close();</div><div class=\"line\"><span class=\"meta\">?&gt;</span></div></pre></td></tr></table></figure>\n<p><a href=\"http://github.com/rabbitmq/rabbitmq-tutorials/blob/master/php/worker.php\" target=\"_blank\" rel=\"external\">worker.php</a></p>\n<p>使用消息应答和prefetch_count=1后，就可以运行一个工作队列了，持久模式选项会在即使RabbitMQ重启的情况下保留任务。</p>\n<p>现在我们可以继续学习第三部分的内容，学习如何发送相同的消息给多个消费者。</p>\n<p>原文地址：<a href=\"https://www.rabbitmq.com/tutorials/tutorial-two-php.html\" target=\"_blank\" rel=\"external\">Work queues</a></p>\n"},{"title":"PHP使用Redis作为缓存使用PDO读取MySQL数据","date":"2015-12-05T14:37:09.000Z","_content":"\n![](http://7b1hhm.com1.z0.glb.clouddn.com/hexo1414772222.jpg)\n\n图片转自：[Using PDO::fetchAll – Examples with codes and output results](http://blog.encodez.com/blog/using-pdofetchall-examples-with-codes-and-output-results)\n\n一个简单的例子。\n\n**实现功能：**\n\t\n\t1.使用PDO读取数据\n\t\n\t2.使用Redis缓存结果\n\t\n\t3.再次查询时会从Redis查询，减少MySQL查询\n\t\n没有注意代码的逻辑，仅实现思路。\n\n```\n<?php\n\n//一上来肯定是配置pdo的连接信息。其实这步在这个示例中可以放到第一个else中。\n$dsn = 'mysql:dbname=node;host=127.0.0.1';\n$user = 'root';\n$password = '';\n\n//连接Redis\n$redis= new Redis();\n$redis->connect('127.0.0.1',6379);\n\n//接收查询参数\n$id = intval($_GET['id']);\n\n//设置在Redis中存储的KEY\n$MY_NODE_KEY_ = 'TEST_PDO_REDIS_ID_';\n\n//拼接KEY和查询ID，读取Redis，\n$cache = $redis->get($MY_NODE_KEY_.$id);\n\n//用来插入log的时间参数\n$date = date(\"Y-m-d H:i:s\");\nif($cache){\n\t//Redis缓存存在则直接输出\n\tprint_r(json_decode($cache,true));\n\t//并记录log\n\terror_log($date.\"---read from redis \\r\\n\", 3, './debug.txt');\n}else{\n\t//缓存不存在，则连接PDO\n\ttry {\n    \t$pdo = new PDO($dsn, $user, $password);\n    \terror_log($date.\"---Connection Succcess \\r\\n\", 3, './debug.txt');\n\t\t\n\t\t//查询\n\t    $query = $pdo -> query(\"select * from news where id = '$id'\");\n\t\t//设置结果集为数组\n\t    // [PDOStatement::fetch](http://php.net/manual/zh/pdostatement.fetch.php)\n\t    $query->setFetchMode(PDO::FETCH_ASSOC);\n\t    \n\t    $rs = $query->fetch();\n\t\n\t    if (is_array($rs)) {\n\t    \t//查询完成，以json格式写入Redis中。\n\t\t\t$redis->set($MY_NODE_KEY_.$rs['id'],json_encode($rs));\n\t\t\tprint_r($rs);\n\t\t\terror_log($date.\"read from mysql \\r\\n\", 3, './debug.txt');\n\t    }\n\t    \n\t//PDO连接出错\n\t} catch (PDOException $e) {\n\t\t//输出错误信息，并记录log中\n    \techo 'Connection failed: ' . $e->getMessage();\n    \terror_log($date.\"---Connection failed \\r\\n\", 3, './debug.txt');\n\t}\n}\n\n```\n\n写的很糙，逻辑已经简单到没有逻辑了。\n\n一句话说一下思路就是：\n\t先看有没有缓存\n\t木有就查数据库，写入缓存\n\t\n\n参考资料：\n\t[PHP 数据对象](http://php.net/manual/zh/book.pdo.php)\n\t[PHP PDO的简单使用(query(),exec(),prepare(),Transaction,行锁)](http://www.cnblogs.com/zemliu/archive/2012/05/08/2490953.html)","source":"_posts/php-use-pdo-cache-query-result-with-redis.md","raw":"title: PHP使用Redis作为缓存使用PDO读取MySQL数据\ndate: 2015-12-05 22:37:09\ntags:  [php,pdo,redis,mysql]\ncategories: php\n---\n\n![](http://7b1hhm.com1.z0.glb.clouddn.com/hexo1414772222.jpg)\n\n图片转自：[Using PDO::fetchAll – Examples with codes and output results](http://blog.encodez.com/blog/using-pdofetchall-examples-with-codes-and-output-results)\n\n一个简单的例子。\n\n**实现功能：**\n\t\n\t1.使用PDO读取数据\n\t\n\t2.使用Redis缓存结果\n\t\n\t3.再次查询时会从Redis查询，减少MySQL查询\n\t\n没有注意代码的逻辑，仅实现思路。\n\n```\n<?php\n\n//一上来肯定是配置pdo的连接信息。其实这步在这个示例中可以放到第一个else中。\n$dsn = 'mysql:dbname=node;host=127.0.0.1';\n$user = 'root';\n$password = '';\n\n//连接Redis\n$redis= new Redis();\n$redis->connect('127.0.0.1',6379);\n\n//接收查询参数\n$id = intval($_GET['id']);\n\n//设置在Redis中存储的KEY\n$MY_NODE_KEY_ = 'TEST_PDO_REDIS_ID_';\n\n//拼接KEY和查询ID，读取Redis，\n$cache = $redis->get($MY_NODE_KEY_.$id);\n\n//用来插入log的时间参数\n$date = date(\"Y-m-d H:i:s\");\nif($cache){\n\t//Redis缓存存在则直接输出\n\tprint_r(json_decode($cache,true));\n\t//并记录log\n\terror_log($date.\"---read from redis \\r\\n\", 3, './debug.txt');\n}else{\n\t//缓存不存在，则连接PDO\n\ttry {\n    \t$pdo = new PDO($dsn, $user, $password);\n    \terror_log($date.\"---Connection Succcess \\r\\n\", 3, './debug.txt');\n\t\t\n\t\t//查询\n\t    $query = $pdo -> query(\"select * from news where id = '$id'\");\n\t\t//设置结果集为数组\n\t    // [PDOStatement::fetch](http://php.net/manual/zh/pdostatement.fetch.php)\n\t    $query->setFetchMode(PDO::FETCH_ASSOC);\n\t    \n\t    $rs = $query->fetch();\n\t\n\t    if (is_array($rs)) {\n\t    \t//查询完成，以json格式写入Redis中。\n\t\t\t$redis->set($MY_NODE_KEY_.$rs['id'],json_encode($rs));\n\t\t\tprint_r($rs);\n\t\t\terror_log($date.\"read from mysql \\r\\n\", 3, './debug.txt');\n\t    }\n\t    \n\t//PDO连接出错\n\t} catch (PDOException $e) {\n\t\t//输出错误信息，并记录log中\n    \techo 'Connection failed: ' . $e->getMessage();\n    \terror_log($date.\"---Connection failed \\r\\n\", 3, './debug.txt');\n\t}\n}\n\n```\n\n写的很糙，逻辑已经简单到没有逻辑了。\n\n一句话说一下思路就是：\n\t先看有没有缓存\n\t木有就查数据库，写入缓存\n\t\n\n参考资料：\n\t[PHP 数据对象](http://php.net/manual/zh/book.pdo.php)\n\t[PHP PDO的简单使用(query(),exec(),prepare(),Transaction,行锁)](http://www.cnblogs.com/zemliu/archive/2012/05/08/2490953.html)","slug":"php-use-pdo-cache-query-result-with-redis","published":1,"updated":"2015-12-06T01:31:01.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj830jvel002pul0rn5rsfjrp","content":"<p><img src=\"http://7b1hhm.com1.z0.glb.clouddn.com/hexo1414772222.jpg\" alt=\"\"></p>\n<p>图片转自：<a href=\"http://blog.encodez.com/blog/using-pdofetchall-examples-with-codes-and-output-results\" target=\"_blank\" rel=\"external\">Using PDO::fetchAll – Examples with codes and output results</a></p>\n<p>一个简单的例子。</p>\n<p><strong>实现功能：</strong></p>\n<pre><code>1.使用PDO读取数据\n\n2.使用Redis缓存结果\n\n3.再次查询时会从Redis查询，减少MySQL查询\n</code></pre><p>没有注意代码的逻辑，仅实现思路。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;?php</div><div class=\"line\"></div><div class=\"line\">//一上来肯定是配置pdo的连接信息。其实这步在这个示例中可以放到第一个else中。</div><div class=\"line\">$dsn = &apos;mysql:dbname=node;host=127.0.0.1&apos;;</div><div class=\"line\">$user = &apos;root&apos;;</div><div class=\"line\">$password = &apos;&apos;;</div><div class=\"line\"></div><div class=\"line\">//连接Redis</div><div class=\"line\">$redis= new Redis();</div><div class=\"line\">$redis-&gt;connect(&apos;127.0.0.1&apos;,6379);</div><div class=\"line\"></div><div class=\"line\">//接收查询参数</div><div class=\"line\">$id = intval($_GET[&apos;id&apos;]);</div><div class=\"line\"></div><div class=\"line\">//设置在Redis中存储的KEY</div><div class=\"line\">$MY_NODE_KEY_ = &apos;TEST_PDO_REDIS_ID_&apos;;</div><div class=\"line\"></div><div class=\"line\">//拼接KEY和查询ID，读取Redis，</div><div class=\"line\">$cache = $redis-&gt;get($MY_NODE_KEY_.$id);</div><div class=\"line\"></div><div class=\"line\">//用来插入log的时间参数</div><div class=\"line\">$date = date(&quot;Y-m-d H:i:s&quot;);</div><div class=\"line\">if($cache)&#123;</div><div class=\"line\">\t//Redis缓存存在则直接输出</div><div class=\"line\">\tprint_r(json_decode($cache,true));</div><div class=\"line\">\t//并记录log</div><div class=\"line\">\terror_log($date.&quot;---read from redis \\r\\n&quot;, 3, &apos;./debug.txt&apos;);</div><div class=\"line\">&#125;else&#123;</div><div class=\"line\">\t//缓存不存在，则连接PDO</div><div class=\"line\">\ttry &#123;</div><div class=\"line\">    \t$pdo = new PDO($dsn, $user, $password);</div><div class=\"line\">    \terror_log($date.&quot;---Connection Succcess \\r\\n&quot;, 3, &apos;./debug.txt&apos;);</div><div class=\"line\">\t\t</div><div class=\"line\">\t\t//查询</div><div class=\"line\">\t    $query = $pdo -&gt; query(&quot;select * from news where id = &apos;$id&apos;&quot;);</div><div class=\"line\">\t\t//设置结果集为数组</div><div class=\"line\">\t    // [PDOStatement::fetch](http://php.net/manual/zh/pdostatement.fetch.php)</div><div class=\"line\">\t    $query-&gt;setFetchMode(PDO::FETCH_ASSOC);</div><div class=\"line\">\t    </div><div class=\"line\">\t    $rs = $query-&gt;fetch();</div><div class=\"line\">\t</div><div class=\"line\">\t    if (is_array($rs)) &#123;</div><div class=\"line\">\t    \t//查询完成，以json格式写入Redis中。</div><div class=\"line\">\t\t\t$redis-&gt;set($MY_NODE_KEY_.$rs[&apos;id&apos;],json_encode($rs));</div><div class=\"line\">\t\t\tprint_r($rs);</div><div class=\"line\">\t\t\terror_log($date.&quot;read from mysql \\r\\n&quot;, 3, &apos;./debug.txt&apos;);</div><div class=\"line\">\t    &#125;</div><div class=\"line\">\t    </div><div class=\"line\">\t//PDO连接出错</div><div class=\"line\">\t&#125; catch (PDOException $e) &#123;</div><div class=\"line\">\t\t//输出错误信息，并记录log中</div><div class=\"line\">    \techo &apos;Connection failed: &apos; . $e-&gt;getMessage();</div><div class=\"line\">    \terror_log($date.&quot;---Connection failed \\r\\n&quot;, 3, &apos;./debug.txt&apos;);</div><div class=\"line\">\t&#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>写的很糙，逻辑已经简单到没有逻辑了。</p>\n<p>一句话说一下思路就是：<br>    先看有没有缓存<br>    木有就查数据库，写入缓存</p>\n<p>参考资料：<br>    <a href=\"http://php.net/manual/zh/book.pdo.php\" target=\"_blank\" rel=\"external\">PHP 数据对象</a><br>    <a href=\"http://www.cnblogs.com/zemliu/archive/2012/05/08/2490953.html\" target=\"_blank\" rel=\"external\">PHP PDO的简单使用(query(),exec(),prepare(),Transaction,行锁)</a></p>\n","site":{"data":{}},"excerpt":"","more":"<p><img src=\"http://7b1hhm.com1.z0.glb.clouddn.com/hexo1414772222.jpg\" alt=\"\"></p>\n<p>图片转自：<a href=\"http://blog.encodez.com/blog/using-pdofetchall-examples-with-codes-and-output-results\" target=\"_blank\" rel=\"external\">Using PDO::fetchAll – Examples with codes and output results</a></p>\n<p>一个简单的例子。</p>\n<p><strong>实现功能：</strong></p>\n<pre><code>1.使用PDO读取数据\n\n2.使用Redis缓存结果\n\n3.再次查询时会从Redis查询，减少MySQL查询\n</code></pre><p>没有注意代码的逻辑，仅实现思路。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;?php</div><div class=\"line\"></div><div class=\"line\">//一上来肯定是配置pdo的连接信息。其实这步在这个示例中可以放到第一个else中。</div><div class=\"line\">$dsn = &apos;mysql:dbname=node;host=127.0.0.1&apos;;</div><div class=\"line\">$user = &apos;root&apos;;</div><div class=\"line\">$password = &apos;&apos;;</div><div class=\"line\"></div><div class=\"line\">//连接Redis</div><div class=\"line\">$redis= new Redis();</div><div class=\"line\">$redis-&gt;connect(&apos;127.0.0.1&apos;,6379);</div><div class=\"line\"></div><div class=\"line\">//接收查询参数</div><div class=\"line\">$id = intval($_GET[&apos;id&apos;]);</div><div class=\"line\"></div><div class=\"line\">//设置在Redis中存储的KEY</div><div class=\"line\">$MY_NODE_KEY_ = &apos;TEST_PDO_REDIS_ID_&apos;;</div><div class=\"line\"></div><div class=\"line\">//拼接KEY和查询ID，读取Redis，</div><div class=\"line\">$cache = $redis-&gt;get($MY_NODE_KEY_.$id);</div><div class=\"line\"></div><div class=\"line\">//用来插入log的时间参数</div><div class=\"line\">$date = date(&quot;Y-m-d H:i:s&quot;);</div><div class=\"line\">if($cache)&#123;</div><div class=\"line\">\t//Redis缓存存在则直接输出</div><div class=\"line\">\tprint_r(json_decode($cache,true));</div><div class=\"line\">\t//并记录log</div><div class=\"line\">\terror_log($date.&quot;---read from redis \\r\\n&quot;, 3, &apos;./debug.txt&apos;);</div><div class=\"line\">&#125;else&#123;</div><div class=\"line\">\t//缓存不存在，则连接PDO</div><div class=\"line\">\ttry &#123;</div><div class=\"line\">    \t$pdo = new PDO($dsn, $user, $password);</div><div class=\"line\">    \terror_log($date.&quot;---Connection Succcess \\r\\n&quot;, 3, &apos;./debug.txt&apos;);</div><div class=\"line\">\t\t</div><div class=\"line\">\t\t//查询</div><div class=\"line\">\t    $query = $pdo -&gt; query(&quot;select * from news where id = &apos;$id&apos;&quot;);</div><div class=\"line\">\t\t//设置结果集为数组</div><div class=\"line\">\t    // [PDOStatement::fetch](http://php.net/manual/zh/pdostatement.fetch.php)</div><div class=\"line\">\t    $query-&gt;setFetchMode(PDO::FETCH_ASSOC);</div><div class=\"line\">\t    </div><div class=\"line\">\t    $rs = $query-&gt;fetch();</div><div class=\"line\">\t</div><div class=\"line\">\t    if (is_array($rs)) &#123;</div><div class=\"line\">\t    \t//查询完成，以json格式写入Redis中。</div><div class=\"line\">\t\t\t$redis-&gt;set($MY_NODE_KEY_.$rs[&apos;id&apos;],json_encode($rs));</div><div class=\"line\">\t\t\tprint_r($rs);</div><div class=\"line\">\t\t\terror_log($date.&quot;read from mysql \\r\\n&quot;, 3, &apos;./debug.txt&apos;);</div><div class=\"line\">\t    &#125;</div><div class=\"line\">\t    </div><div class=\"line\">\t//PDO连接出错</div><div class=\"line\">\t&#125; catch (PDOException $e) &#123;</div><div class=\"line\">\t\t//输出错误信息，并记录log中</div><div class=\"line\">    \techo &apos;Connection failed: &apos; . $e-&gt;getMessage();</div><div class=\"line\">    \terror_log($date.&quot;---Connection failed \\r\\n&quot;, 3, &apos;./debug.txt&apos;);</div><div class=\"line\">\t&#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>写的很糙，逻辑已经简单到没有逻辑了。</p>\n<p>一句话说一下思路就是：<br>    先看有没有缓存<br>    木有就查数据库，写入缓存</p>\n<p>参考资料：<br>    <a href=\"http://php.net/manual/zh/book.pdo.php\" target=\"_blank\" rel=\"external\">PHP 数据对象</a><br>    <a href=\"http://www.cnblogs.com/zemliu/archive/2012/05/08/2490953.html\" target=\"_blank\" rel=\"external\">PHP PDO的简单使用(query(),exec(),prepare(),Transaction,行锁)</a></p>\n"},{"title":"一个简单的input获得焦点时的小动画效果","date":"2016-01-11T13:42:58.000Z","_content":"\n以前经常见到的一种页面表单效果，但是并没有在项目中用过，前几天在sf上看到相关问题，顺手写了一个，还挺简单，没什么含量。\n\n此处省略HTML头信息等内容。\n\n### HTML\n\n```\n\t<div>\n\t  <input type=\"text\" id=\"uname\"/>\n\t  <label>Name</label>\n\t</div>\n\n```\n\n### CSS\n\n```\ndiv{\n  position:relative;\n  top:20px;\n}\ninput{\n  width:200px;\n  height:30px;\n  line-height:30px;\n  padding:0 3px;\n  border:none;\n  border-bottom:1px solod #666;\n\n}\nlabel{\n  position:absolute;\n  top:0;\n  left:5px;\n  color:#ccc;\n  height:30px;\n  line-height:30px;\n}\n```\n\n### JS\n\n```\n$(document).on('focus','input',function(){\n  $(this).siblings('label').animate({top:'-20px'});\n})\n.on('focusout','input',function(){\n  $(this).siblings('label').animate({top:'0'});\n})\n```\n\n### RESULT\n\n<iframe width=\"100%\" height=\"300\" src=\"//jsfiddle.net/qichengzx/zc91Lyx7/8/embedded/\" allowfullscreen=\"allowfullscreen\" frameborder=\"0\"></iframe>\n\n### 不足\n\n没有考虑label的鼠标点击事件。","source":"_posts/placeholder-animate.md","raw":"title: 一个简单的input获得焦点时的小动画效果\ncategories: javascript\ndate: 2016-01-11 21:42:58\ntags:  [javascript,input]\n\n---\n\n以前经常见到的一种页面表单效果，但是并没有在项目中用过，前几天在sf上看到相关问题，顺手写了一个，还挺简单，没什么含量。\n\n此处省略HTML头信息等内容。\n\n### HTML\n\n```\n\t<div>\n\t  <input type=\"text\" id=\"uname\"/>\n\t  <label>Name</label>\n\t</div>\n\n```\n\n### CSS\n\n```\ndiv{\n  position:relative;\n  top:20px;\n}\ninput{\n  width:200px;\n  height:30px;\n  line-height:30px;\n  padding:0 3px;\n  border:none;\n  border-bottom:1px solod #666;\n\n}\nlabel{\n  position:absolute;\n  top:0;\n  left:5px;\n  color:#ccc;\n  height:30px;\n  line-height:30px;\n}\n```\n\n### JS\n\n```\n$(document).on('focus','input',function(){\n  $(this).siblings('label').animate({top:'-20px'});\n})\n.on('focusout','input',function(){\n  $(this).siblings('label').animate({top:'0'});\n})\n```\n\n### RESULT\n\n<iframe width=\"100%\" height=\"300\" src=\"//jsfiddle.net/qichengzx/zc91Lyx7/8/embedded/\" allowfullscreen=\"allowfullscreen\" frameborder=\"0\"></iframe>\n\n### 不足\n\n没有考虑label的鼠标点击事件。","slug":"placeholder-animate","published":1,"updated":"2016-01-12T13:33:24.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj830jvem002sul0rcyo6fre3","content":"<p>以前经常见到的一种页面表单效果，但是并没有在项目中用过，前几天在sf上看到相关问题，顺手写了一个，还挺简单，没什么含量。</p>\n<p>此处省略HTML头信息等内容。</p>\n<h3 id=\"HTML\"><a href=\"#HTML\" class=\"headerlink\" title=\"HTML\"></a>HTML</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;div&gt;</div><div class=\"line\">  &lt;input type=&quot;text&quot; id=&quot;uname&quot;/&gt;</div><div class=\"line\">  &lt;label&gt;Name&lt;/label&gt;</div><div class=\"line\">&lt;/div&gt;</div></pre></td></tr></table></figure>\n<h3 id=\"CSS\"><a href=\"#CSS\" class=\"headerlink\" title=\"CSS\"></a>CSS</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div></pre></td><td class=\"code\"><pre><div class=\"line\">div&#123;</div><div class=\"line\">  position:relative;</div><div class=\"line\">  top:20px;</div><div class=\"line\">&#125;</div><div class=\"line\">input&#123;</div><div class=\"line\">  width:200px;</div><div class=\"line\">  height:30px;</div><div class=\"line\">  line-height:30px;</div><div class=\"line\">  padding:0 3px;</div><div class=\"line\">  border:none;</div><div class=\"line\">  border-bottom:1px solod #666;</div><div class=\"line\"></div><div class=\"line\">&#125;</div><div class=\"line\">label&#123;</div><div class=\"line\">  position:absolute;</div><div class=\"line\">  top:0;</div><div class=\"line\">  left:5px;</div><div class=\"line\">  color:#ccc;</div><div class=\"line\">  height:30px;</div><div class=\"line\">  line-height:30px;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h3 id=\"JS\"><a href=\"#JS\" class=\"headerlink\" title=\"JS\"></a>JS</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">$(document).on(&apos;focus&apos;,&apos;input&apos;,function()&#123;</div><div class=\"line\">  $(this).siblings(&apos;label&apos;).animate(&#123;top:&apos;-20px&apos;&#125;);</div><div class=\"line\">&#125;)</div><div class=\"line\">.on(&apos;focusout&apos;,&apos;input&apos;,function()&#123;</div><div class=\"line\">  $(this).siblings(&apos;label&apos;).animate(&#123;top:&apos;0&apos;&#125;);</div><div class=\"line\">&#125;)</div></pre></td></tr></table></figure>\n<h3 id=\"RESULT\"><a href=\"#RESULT\" class=\"headerlink\" title=\"RESULT\"></a>RESULT</h3><iframe width=\"100%\" height=\"300\" src=\"//jsfiddle.net/qichengzx/zc91Lyx7/8/embedded/\" allowfullscreen=\"allowfullscreen\" frameborder=\"0\"></iframe>\n\n<h3 id=\"不足\"><a href=\"#不足\" class=\"headerlink\" title=\"不足\"></a>不足</h3><p>没有考虑label的鼠标点击事件。</p>\n","site":{"data":{}},"excerpt":"","more":"<p>以前经常见到的一种页面表单效果，但是并没有在项目中用过，前几天在sf上看到相关问题，顺手写了一个，还挺简单，没什么含量。</p>\n<p>此处省略HTML头信息等内容。</p>\n<h3 id=\"HTML\"><a href=\"#HTML\" class=\"headerlink\" title=\"HTML\"></a>HTML</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;div&gt;</div><div class=\"line\">  &lt;input type=&quot;text&quot; id=&quot;uname&quot;/&gt;</div><div class=\"line\">  &lt;label&gt;Name&lt;/label&gt;</div><div class=\"line\">&lt;/div&gt;</div></pre></td></tr></table></figure>\n<h3 id=\"CSS\"><a href=\"#CSS\" class=\"headerlink\" title=\"CSS\"></a>CSS</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div></pre></td><td class=\"code\"><pre><div class=\"line\">div&#123;</div><div class=\"line\">  position:relative;</div><div class=\"line\">  top:20px;</div><div class=\"line\">&#125;</div><div class=\"line\">input&#123;</div><div class=\"line\">  width:200px;</div><div class=\"line\">  height:30px;</div><div class=\"line\">  line-height:30px;</div><div class=\"line\">  padding:0 3px;</div><div class=\"line\">  border:none;</div><div class=\"line\">  border-bottom:1px solod #666;</div><div class=\"line\"></div><div class=\"line\">&#125;</div><div class=\"line\">label&#123;</div><div class=\"line\">  position:absolute;</div><div class=\"line\">  top:0;</div><div class=\"line\">  left:5px;</div><div class=\"line\">  color:#ccc;</div><div class=\"line\">  height:30px;</div><div class=\"line\">  line-height:30px;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h3 id=\"JS\"><a href=\"#JS\" class=\"headerlink\" title=\"JS\"></a>JS</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">$(document).on(&apos;focus&apos;,&apos;input&apos;,function()&#123;</div><div class=\"line\">  $(this).siblings(&apos;label&apos;).animate(&#123;top:&apos;-20px&apos;&#125;);</div><div class=\"line\">&#125;)</div><div class=\"line\">.on(&apos;focusout&apos;,&apos;input&apos;,function()&#123;</div><div class=\"line\">  $(this).siblings(&apos;label&apos;).animate(&#123;top:&apos;0&apos;&#125;);</div><div class=\"line\">&#125;)</div></pre></td></tr></table></figure>\n<h3 id=\"RESULT\"><a href=\"#RESULT\" class=\"headerlink\" title=\"RESULT\"></a>RESULT</h3><iframe width=\"100%\" height=\"300\" src=\"//jsfiddle.net/qichengzx/zc91Lyx7/8/embedded/\" allowfullscreen=\"allowfullscreen\" frameborder=\"0\"></iframe>\n\n<h3 id=\"不足\"><a href=\"#不足\" class=\"headerlink\" title=\"不足\"></a>不足</h3><p>没有考虑label的鼠标点击事件。</p>\n"},{"title":"Go语言使用redigo操作GEO(1) - 添加和查询","date":"2017-09-17T11:45:29.000Z","_content":"\n周五的时候群里有人遇到在Go中使用Redis GEO的问题，顺手搜了下解决办法。发现还挺简单的，周末无事，写下来记一下。\n\nGEO是在Redis 3.2加入的功能，手册[见此](http://redisdoc.com/geo/index.html)\n\n本示例中只演示GEOADD和GEOPOS功能。\n\n[redigo](https://github.com/garyburd/redigo/tree/master/redis)这个客户端还挺好用的，但是个人觉得略有不足的是文档不全（指的是中文的文档），但是好在可以看源码解决一些不太清楚的问题。\n\n#### 0.连接Redis\n\n首先习惯性的创建了连接池，嗯，连接池。\n\n```Go\nfunc init() {\n\tRedisClient = &redis.Pool{\n\t\tMaxIdle:   MaxIdle,\n\t\tMaxActive: MaxActive,\n\n\t\tIdleTimeout: 60 * time.Second,\n\n\t\tDial: func() (redis.Conn, error) {\n\t\t\tc, err := redis.Dial(\"tcp\", RedisHost)\n\n\t\t\tif err != nil {\n\t\t\t\treturn nil, err\n\t\t\t}\n\n\t\t\t/*if _, err := c.Do(\"AUTH\", RedisPwd); err != nil {\n\t\t\t\tc.Close()\n\t\t\t\treturn nil, err\n\t\t\t}*/\n\t\t\tc.Do(\"SELECT\", RedisDb)\n\n\t\t\treturn c, nil\n\t\t},\n\t}\n}\n```\n\n#### 1.添加值\n\n为了简单起见，创建了一个方法用于向传入的key中写入name的坐标点。\n\n直接返回错误。\n\n```Go\nfunc push(key, name string, lat, lng float64) error {\n\trc := RedisClient.Get()\n\tdefer rc.Close()\n\n\t_, err := rc.Do(\"GEOADD\", key, lng, lat, name)\n\treturn err\n}\n\n```\n\n#### 2.取回值\n\n同样，创建一个方法，在Redis中取回key中name的坐标点的值。\n\n但是注意，这里在执行完 ``GEOPOS`` 后，调用 redigo 包中的 ``Positions`` 方法把返回结果转成 ``float64`` 的数组。\n\n然后返回这个数组和错误\n\n```Go\nfunc get(key, name string) ([]*[2]float64, error) {\n\trc := RedisClient.Get()\n\tdefer rc.Close()\n\n\tres, err := redis.Positions(rc.Do(\"GEOPOS\", key, name))\n\n\treturn res, err\n}\n```\n\n#### 3.main方法中的简单代码\n\n```Go \nfunc main() {\n\tkey := \"citylist\"\n\tname := \"beijing\"\n\tlat := 39.9329\n\tlng := 116.280316\n\terr := push(key, name, lat, lng)\n\tif err != nil {\n\t\tpanic(err)\n\t}\n\tfmt.Println(\"坐标写入完成\")\n\tfmt.Println(\"获取刚刚写入的值\")\n\n\tres, err := get(key, name)\n\tif err != nil {\n\t\tpanic(err)\n\t}\n\tfmt.Println(res[0][0], res[0][1])\n}\n```\n\n就这么简单。\n\nimport部分和定义的几个全局变量就不用写了，\n","source":"_posts/redis-geo-with-redigo-in-golang-part-1.md","raw":"title: Go语言使用redigo操作GEO(1) - 添加和查询\ncategories: golang\ndate: 2017-09-17 19:45:29\ntags:  [go,redis,redigo,geo]\n---\n\n周五的时候群里有人遇到在Go中使用Redis GEO的问题，顺手搜了下解决办法。发现还挺简单的，周末无事，写下来记一下。\n\nGEO是在Redis 3.2加入的功能，手册[见此](http://redisdoc.com/geo/index.html)\n\n本示例中只演示GEOADD和GEOPOS功能。\n\n[redigo](https://github.com/garyburd/redigo/tree/master/redis)这个客户端还挺好用的，但是个人觉得略有不足的是文档不全（指的是中文的文档），但是好在可以看源码解决一些不太清楚的问题。\n\n#### 0.连接Redis\n\n首先习惯性的创建了连接池，嗯，连接池。\n\n```Go\nfunc init() {\n\tRedisClient = &redis.Pool{\n\t\tMaxIdle:   MaxIdle,\n\t\tMaxActive: MaxActive,\n\n\t\tIdleTimeout: 60 * time.Second,\n\n\t\tDial: func() (redis.Conn, error) {\n\t\t\tc, err := redis.Dial(\"tcp\", RedisHost)\n\n\t\t\tif err != nil {\n\t\t\t\treturn nil, err\n\t\t\t}\n\n\t\t\t/*if _, err := c.Do(\"AUTH\", RedisPwd); err != nil {\n\t\t\t\tc.Close()\n\t\t\t\treturn nil, err\n\t\t\t}*/\n\t\t\tc.Do(\"SELECT\", RedisDb)\n\n\t\t\treturn c, nil\n\t\t},\n\t}\n}\n```\n\n#### 1.添加值\n\n为了简单起见，创建了一个方法用于向传入的key中写入name的坐标点。\n\n直接返回错误。\n\n```Go\nfunc push(key, name string, lat, lng float64) error {\n\trc := RedisClient.Get()\n\tdefer rc.Close()\n\n\t_, err := rc.Do(\"GEOADD\", key, lng, lat, name)\n\treturn err\n}\n\n```\n\n#### 2.取回值\n\n同样，创建一个方法，在Redis中取回key中name的坐标点的值。\n\n但是注意，这里在执行完 ``GEOPOS`` 后，调用 redigo 包中的 ``Positions`` 方法把返回结果转成 ``float64`` 的数组。\n\n然后返回这个数组和错误\n\n```Go\nfunc get(key, name string) ([]*[2]float64, error) {\n\trc := RedisClient.Get()\n\tdefer rc.Close()\n\n\tres, err := redis.Positions(rc.Do(\"GEOPOS\", key, name))\n\n\treturn res, err\n}\n```\n\n#### 3.main方法中的简单代码\n\n```Go \nfunc main() {\n\tkey := \"citylist\"\n\tname := \"beijing\"\n\tlat := 39.9329\n\tlng := 116.280316\n\terr := push(key, name, lat, lng)\n\tif err != nil {\n\t\tpanic(err)\n\t}\n\tfmt.Println(\"坐标写入完成\")\n\tfmt.Println(\"获取刚刚写入的值\")\n\n\tres, err := get(key, name)\n\tif err != nil {\n\t\tpanic(err)\n\t}\n\tfmt.Println(res[0][0], res[0][1])\n}\n```\n\n就这么简单。\n\nimport部分和定义的几个全局变量就不用写了，\n","slug":"redis-geo-with-redigo-in-golang-part-1","published":1,"updated":"2017-09-23T10:23:53.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj830jveo002uul0rb35o1gyc","content":"<p>周五的时候群里有人遇到在Go中使用Redis GEO的问题，顺手搜了下解决办法。发现还挺简单的，周末无事，写下来记一下。</p>\n<p>GEO是在Redis 3.2加入的功能，手册<a href=\"http://redisdoc.com/geo/index.html\" target=\"_blank\" rel=\"external\">见此</a></p>\n<p>本示例中只演示GEOADD和GEOPOS功能。</p>\n<p><a href=\"https://github.com/garyburd/redigo/tree/master/redis\" target=\"_blank\" rel=\"external\">redigo</a>这个客户端还挺好用的，但是个人觉得略有不足的是文档不全（指的是中文的文档），但是好在可以看源码解决一些不太清楚的问题。</p>\n<h4 id=\"0-连接Redis\"><a href=\"#0-连接Redis\" class=\"headerlink\" title=\"0.连接Redis\"></a>0.连接Redis</h4><p>首先习惯性的创建了连接池，嗯，连接池。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">init</span><span class=\"params\">()</span></span> &#123;</div><div class=\"line\">\tRedisClient = &amp;redis.Pool&#123;</div><div class=\"line\">\t\tMaxIdle:   MaxIdle,</div><div class=\"line\">\t\tMaxActive: MaxActive,</div><div class=\"line\"></div><div class=\"line\">\t\tIdleTimeout: <span class=\"number\">60</span> * time.Second,</div><div class=\"line\"></div><div class=\"line\">\t\tDial: <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span> <span class=\"params\">(redis.Conn, error)</span></span> &#123;</div><div class=\"line\">\t\t\tc, err := redis.Dial(<span class=\"string\">\"tcp\"</span>, RedisHost)</div><div class=\"line\"></div><div class=\"line\">\t\t\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</div><div class=\"line\">\t\t\t\t<span class=\"keyword\">return</span> <span class=\"literal\">nil</span>, err</div><div class=\"line\">\t\t\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t\t\t<span class=\"comment\">/*if _, err := c.Do(\"AUTH\", RedisPwd); err != nil &#123;</span></div><div class=\"line\"><span class=\"comment\">\t\t\t\tc.Close()</span></div><div class=\"line\"><span class=\"comment\">\t\t\t\treturn nil, err</span></div><div class=\"line\"><span class=\"comment\">\t\t\t&#125;*/</span></div><div class=\"line\">\t\t\tc.Do(<span class=\"string\">\"SELECT\"</span>, RedisDb)</div><div class=\"line\"></div><div class=\"line\">\t\t\t<span class=\"keyword\">return</span> c, <span class=\"literal\">nil</span></div><div class=\"line\">\t\t&#125;,</div><div class=\"line\">\t&#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h4 id=\"1-添加值\"><a href=\"#1-添加值\" class=\"headerlink\" title=\"1.添加值\"></a>1.添加值</h4><p>为了简单起见，创建了一个方法用于向传入的key中写入name的坐标点。</p>\n<p>直接返回错误。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">push</span><span class=\"params\">(key, name <span class=\"keyword\">string</span>, lat, lng <span class=\"keyword\">float64</span>)</span> <span class=\"title\">error</span></span> &#123;</div><div class=\"line\">\trc := RedisClient.Get()</div><div class=\"line\">\t<span class=\"keyword\">defer</span> rc.Close()</div><div class=\"line\"></div><div class=\"line\">\t_, err := rc.Do(<span class=\"string\">\"GEOADD\"</span>, key, lng, lat, name)</div><div class=\"line\">\t<span class=\"keyword\">return</span> err</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h4 id=\"2-取回值\"><a href=\"#2-取回值\" class=\"headerlink\" title=\"2.取回值\"></a>2.取回值</h4><p>同样，创建一个方法，在Redis中取回key中name的坐标点的值。</p>\n<p>但是注意，这里在执行完 <code>GEOPOS</code> 后，调用 redigo 包中的 <code>Positions</code> 方法把返回结果转成 <code>float64</code> 的数组。</p>\n<p>然后返回这个数组和错误</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">get</span><span class=\"params\">(key, name <span class=\"keyword\">string</span>)</span> <span class=\"params\">([]*[2]<span class=\"keyword\">float64</span>, error)</span></span> &#123;</div><div class=\"line\">\trc := RedisClient.Get()</div><div class=\"line\">\t<span class=\"keyword\">defer</span> rc.Close()</div><div class=\"line\"></div><div class=\"line\">\tres, err := redis.Positions(rc.Do(<span class=\"string\">\"GEOPOS\"</span>, key, name))</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"keyword\">return</span> res, err</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h4 id=\"3-main方法中的简单代码\"><a href=\"#3-main方法中的简单代码\" class=\"headerlink\" title=\"3.main方法中的简单代码\"></a>3.main方法中的简单代码</h4><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</div><div class=\"line\">\tkey := <span class=\"string\">\"citylist\"</span></div><div class=\"line\">\tname := <span class=\"string\">\"beijing\"</span></div><div class=\"line\">\tlat := <span class=\"number\">39.9329</span></div><div class=\"line\">\tlng := <span class=\"number\">116.280316</span></div><div class=\"line\">\terr := push(key, name, lat, lng)</div><div class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</div><div class=\"line\">\t\t<span class=\"built_in\">panic</span>(err)</div><div class=\"line\">\t&#125;</div><div class=\"line\">\tfmt.Println(<span class=\"string\">\"坐标写入完成\"</span>)</div><div class=\"line\">\tfmt.Println(<span class=\"string\">\"获取刚刚写入的值\"</span>)</div><div class=\"line\"></div><div class=\"line\">\tres, err := get(key, name)</div><div class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</div><div class=\"line\">\t\t<span class=\"built_in\">panic</span>(err)</div><div class=\"line\">\t&#125;</div><div class=\"line\">\tfmt.Println(res[<span class=\"number\">0</span>][<span class=\"number\">0</span>], res[<span class=\"number\">0</span>][<span class=\"number\">1</span>])</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>就这么简单。</p>\n<p>import部分和定义的几个全局变量就不用写了，</p>\n","site":{"data":{}},"excerpt":"","more":"<p>周五的时候群里有人遇到在Go中使用Redis GEO的问题，顺手搜了下解决办法。发现还挺简单的，周末无事，写下来记一下。</p>\n<p>GEO是在Redis 3.2加入的功能，手册<a href=\"http://redisdoc.com/geo/index.html\" target=\"_blank\" rel=\"external\">见此</a></p>\n<p>本示例中只演示GEOADD和GEOPOS功能。</p>\n<p><a href=\"https://github.com/garyburd/redigo/tree/master/redis\" target=\"_blank\" rel=\"external\">redigo</a>这个客户端还挺好用的，但是个人觉得略有不足的是文档不全（指的是中文的文档），但是好在可以看源码解决一些不太清楚的问题。</p>\n<h4 id=\"0-连接Redis\"><a href=\"#0-连接Redis\" class=\"headerlink\" title=\"0.连接Redis\"></a>0.连接Redis</h4><p>首先习惯性的创建了连接池，嗯，连接池。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">init</span><span class=\"params\">()</span></span> &#123;</div><div class=\"line\">\tRedisClient = &amp;redis.Pool&#123;</div><div class=\"line\">\t\tMaxIdle:   MaxIdle,</div><div class=\"line\">\t\tMaxActive: MaxActive,</div><div class=\"line\"></div><div class=\"line\">\t\tIdleTimeout: <span class=\"number\">60</span> * time.Second,</div><div class=\"line\"></div><div class=\"line\">\t\tDial: <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span> <span class=\"params\">(redis.Conn, error)</span></span> &#123;</div><div class=\"line\">\t\t\tc, err := redis.Dial(<span class=\"string\">\"tcp\"</span>, RedisHost)</div><div class=\"line\"></div><div class=\"line\">\t\t\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</div><div class=\"line\">\t\t\t\t<span class=\"keyword\">return</span> <span class=\"literal\">nil</span>, err</div><div class=\"line\">\t\t\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t\t\t<span class=\"comment\">/*if _, err := c.Do(\"AUTH\", RedisPwd); err != nil &#123;</span></div><div class=\"line\"><span class=\"comment\">\t\t\t\tc.Close()</span></div><div class=\"line\"><span class=\"comment\">\t\t\t\treturn nil, err</span></div><div class=\"line\"><span class=\"comment\">\t\t\t&#125;*/</span></div><div class=\"line\">\t\t\tc.Do(<span class=\"string\">\"SELECT\"</span>, RedisDb)</div><div class=\"line\"></div><div class=\"line\">\t\t\t<span class=\"keyword\">return</span> c, <span class=\"literal\">nil</span></div><div class=\"line\">\t\t&#125;,</div><div class=\"line\">\t&#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h4 id=\"1-添加值\"><a href=\"#1-添加值\" class=\"headerlink\" title=\"1.添加值\"></a>1.添加值</h4><p>为了简单起见，创建了一个方法用于向传入的key中写入name的坐标点。</p>\n<p>直接返回错误。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">push</span><span class=\"params\">(key, name <span class=\"keyword\">string</span>, lat, lng <span class=\"keyword\">float64</span>)</span> <span class=\"title\">error</span></span> &#123;</div><div class=\"line\">\trc := RedisClient.Get()</div><div class=\"line\">\t<span class=\"keyword\">defer</span> rc.Close()</div><div class=\"line\"></div><div class=\"line\">\t_, err := rc.Do(<span class=\"string\">\"GEOADD\"</span>, key, lng, lat, name)</div><div class=\"line\">\t<span class=\"keyword\">return</span> err</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h4 id=\"2-取回值\"><a href=\"#2-取回值\" class=\"headerlink\" title=\"2.取回值\"></a>2.取回值</h4><p>同样，创建一个方法，在Redis中取回key中name的坐标点的值。</p>\n<p>但是注意，这里在执行完 <code>GEOPOS</code> 后，调用 redigo 包中的 <code>Positions</code> 方法把返回结果转成 <code>float64</code> 的数组。</p>\n<p>然后返回这个数组和错误</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">get</span><span class=\"params\">(key, name <span class=\"keyword\">string</span>)</span> <span class=\"params\">([]*[2]<span class=\"keyword\">float64</span>, error)</span></span> &#123;</div><div class=\"line\">\trc := RedisClient.Get()</div><div class=\"line\">\t<span class=\"keyword\">defer</span> rc.Close()</div><div class=\"line\"></div><div class=\"line\">\tres, err := redis.Positions(rc.Do(<span class=\"string\">\"GEOPOS\"</span>, key, name))</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"keyword\">return</span> res, err</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h4 id=\"3-main方法中的简单代码\"><a href=\"#3-main方法中的简单代码\" class=\"headerlink\" title=\"3.main方法中的简单代码\"></a>3.main方法中的简单代码</h4><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</div><div class=\"line\">\tkey := <span class=\"string\">\"citylist\"</span></div><div class=\"line\">\tname := <span class=\"string\">\"beijing\"</span></div><div class=\"line\">\tlat := <span class=\"number\">39.9329</span></div><div class=\"line\">\tlng := <span class=\"number\">116.280316</span></div><div class=\"line\">\terr := push(key, name, lat, lng)</div><div class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</div><div class=\"line\">\t\t<span class=\"built_in\">panic</span>(err)</div><div class=\"line\">\t&#125;</div><div class=\"line\">\tfmt.Println(<span class=\"string\">\"坐标写入完成\"</span>)</div><div class=\"line\">\tfmt.Println(<span class=\"string\">\"获取刚刚写入的值\"</span>)</div><div class=\"line\"></div><div class=\"line\">\tres, err := get(key, name)</div><div class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</div><div class=\"line\">\t\t<span class=\"built_in\">panic</span>(err)</div><div class=\"line\">\t&#125;</div><div class=\"line\">\tfmt.Println(res[<span class=\"number\">0</span>][<span class=\"number\">0</span>], res[<span class=\"number\">0</span>][<span class=\"number\">1</span>])</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>就这么简单。</p>\n<p>import部分和定义的几个全局变量就不用写了，</p>\n"},{"title":"Go语言使用redigo操作GEO(2) - 获取两点距离","date":"2017-09-23T10:22:01.000Z","_content":"\n[上一篇](/2017/09/17/redis-geo-with-redigo-in-golang-part-1.html)简单记录了在Go中使用redigo这个包操作Redis，简单的使用了添加和查询。\n\n今天来试一下计算距离。之前也写到过在[MySQL中计算坐标的距离，及排序](/2017/06/27/order-by-distance-in-mysql.html)。\n\n在上一篇中疏忽了一个问题，使用的几个坐标点是用高德地图获取到的，但是Redis中GEO是使用了 WGS84 坐标系的。实际使用中需要注意一下，这里有一篇文章详细介绍了不同坐标系的区别。\n\n#### 添加测试数据\n\n先添加几条测试用的数据。\n\n```Go\npush(\"citylist\", \"tianjin\", 39.1252291, 117.0153461)\npush(\"citylist\", \"tangshan\", 39.0507819, 116.9421939)\npush(\"citylist\", \"baoding\", 38.8712164, 115.3353061)\n```\n\n添加了三个城市。\n\n#### 查询距离\n\n使用GEODIST方法查询两点的距离。手册[见此](http://redisdoc.com/geo/geodist.html)。\n\n语法： GEODIST key member1 member2 [unit]\n\n第四个参数可选,可选值为：\n\n- m 表示单位为米。\n- km 表示单位为千米。\n- mi 表示单位为英里。\n- ft 表示单位为英尺。\n\n默认是米。\n\n简单写一个方法，传入key和要查询的两点，及距离单位。\n\n```Go\nfunc dist(key, m1, m2, unit string) float64 {\n\trc := RedisClient.Get()\n\tdefer rc.Close()\n\n\trs1, _ := redis.Float64(rc.Do(\"GEODIST\", key, m1, m2, unit))\n\n\treturn rs\n}\n```\n\nGEODIST返回值是双精度浮点数，这里直接使用redigo包的Float64方法转换返回了。\n\n#### 使用\n```Go\nrs1 := dist(\"citylist\", \"beijing\", \"tianjin\", \"km\")\nrs2 := dist(\"citylist\", \"beijing\", \"tangshan\", \"km\")\nrs3 := dist(\"citylist\", \"beijing\", \"baoding\", \"km\")\n\nfmt.Println(\"北京-天津\", rs1)\nfmt.Println(\"北京-唐山\", rs2)\nfmt.Println(\"北京-保定\", rs3)\n```","source":"_posts/redis-geo-with-redigo-in-golang-part-2.md","raw":"title: Go语言使用redigo操作GEO(2) - 获取两点距离\ncategories: golang\ndate: 2017-09-23 18:22:01\ntags:  [go,redis,redigo,geo]\n---\n\n[上一篇](/2017/09/17/redis-geo-with-redigo-in-golang-part-1.html)简单记录了在Go中使用redigo这个包操作Redis，简单的使用了添加和查询。\n\n今天来试一下计算距离。之前也写到过在[MySQL中计算坐标的距离，及排序](/2017/06/27/order-by-distance-in-mysql.html)。\n\n在上一篇中疏忽了一个问题，使用的几个坐标点是用高德地图获取到的，但是Redis中GEO是使用了 WGS84 坐标系的。实际使用中需要注意一下，这里有一篇文章详细介绍了不同坐标系的区别。\n\n#### 添加测试数据\n\n先添加几条测试用的数据。\n\n```Go\npush(\"citylist\", \"tianjin\", 39.1252291, 117.0153461)\npush(\"citylist\", \"tangshan\", 39.0507819, 116.9421939)\npush(\"citylist\", \"baoding\", 38.8712164, 115.3353061)\n```\n\n添加了三个城市。\n\n#### 查询距离\n\n使用GEODIST方法查询两点的距离。手册[见此](http://redisdoc.com/geo/geodist.html)。\n\n语法： GEODIST key member1 member2 [unit]\n\n第四个参数可选,可选值为：\n\n- m 表示单位为米。\n- km 表示单位为千米。\n- mi 表示单位为英里。\n- ft 表示单位为英尺。\n\n默认是米。\n\n简单写一个方法，传入key和要查询的两点，及距离单位。\n\n```Go\nfunc dist(key, m1, m2, unit string) float64 {\n\trc := RedisClient.Get()\n\tdefer rc.Close()\n\n\trs1, _ := redis.Float64(rc.Do(\"GEODIST\", key, m1, m2, unit))\n\n\treturn rs\n}\n```\n\nGEODIST返回值是双精度浮点数，这里直接使用redigo包的Float64方法转换返回了。\n\n#### 使用\n```Go\nrs1 := dist(\"citylist\", \"beijing\", \"tianjin\", \"km\")\nrs2 := dist(\"citylist\", \"beijing\", \"tangshan\", \"km\")\nrs3 := dist(\"citylist\", \"beijing\", \"baoding\", \"km\")\n\nfmt.Println(\"北京-天津\", rs1)\nfmt.Println(\"北京-唐山\", rs2)\nfmt.Println(\"北京-保定\", rs3)\n```","slug":"redis-geo-with-redigo-in-golang-part-2","published":1,"updated":"2017-09-24T09:49:02.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj830jver002yul0r5qgtnzkg","content":"<p><a href=\"/2017/09/17/redis-geo-with-redigo-in-golang-part-1.html\">上一篇</a>简单记录了在Go中使用redigo这个包操作Redis，简单的使用了添加和查询。</p>\n<p>今天来试一下计算距离。之前也写到过在<a href=\"/2017/06/27/order-by-distance-in-mysql.html\">MySQL中计算坐标的距离，及排序</a>。</p>\n<p>在上一篇中疏忽了一个问题，使用的几个坐标点是用高德地图获取到的，但是Redis中GEO是使用了 WGS84 坐标系的。实际使用中需要注意一下，这里有一篇文章详细介绍了不同坐标系的区别。</p>\n<h4 id=\"添加测试数据\"><a href=\"#添加测试数据\" class=\"headerlink\" title=\"添加测试数据\"></a>添加测试数据</h4><p>先添加几条测试用的数据。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">push(<span class=\"string\">\"citylist\"</span>, <span class=\"string\">\"tianjin\"</span>, <span class=\"number\">39.1252291</span>, <span class=\"number\">117.0153461</span>)</div><div class=\"line\">push(<span class=\"string\">\"citylist\"</span>, <span class=\"string\">\"tangshan\"</span>, <span class=\"number\">39.0507819</span>, <span class=\"number\">116.9421939</span>)</div><div class=\"line\">push(<span class=\"string\">\"citylist\"</span>, <span class=\"string\">\"baoding\"</span>, <span class=\"number\">38.8712164</span>, <span class=\"number\">115.3353061</span>)</div></pre></td></tr></table></figure>\n<p>添加了三个城市。</p>\n<h4 id=\"查询距离\"><a href=\"#查询距离\" class=\"headerlink\" title=\"查询距离\"></a>查询距离</h4><p>使用GEODIST方法查询两点的距离。手册<a href=\"http://redisdoc.com/geo/geodist.html\" target=\"_blank\" rel=\"external\">见此</a>。</p>\n<p>语法： GEODIST key member1 member2 [unit]</p>\n<p>第四个参数可选,可选值为：</p>\n<ul>\n<li>m 表示单位为米。</li>\n<li>km 表示单位为千米。</li>\n<li>mi 表示单位为英里。</li>\n<li>ft 表示单位为英尺。</li>\n</ul>\n<p>默认是米。</p>\n<p>简单写一个方法，传入key和要查询的两点，及距离单位。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">dist</span><span class=\"params\">(key, m1, m2, unit <span class=\"keyword\">string</span>)</span> <span class=\"title\">float64</span></span> &#123;</div><div class=\"line\">\trc := RedisClient.Get()</div><div class=\"line\">\t<span class=\"keyword\">defer</span> rc.Close()</div><div class=\"line\"></div><div class=\"line\">\trs1, _ := redis.Float64(rc.Do(<span class=\"string\">\"GEODIST\"</span>, key, m1, m2, unit))</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"keyword\">return</span> rs</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>GEODIST返回值是双精度浮点数，这里直接使用redigo包的Float64方法转换返回了。</p>\n<h4 id=\"使用\"><a href=\"#使用\" class=\"headerlink\" title=\"使用\"></a>使用</h4><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">rs1 := dist(<span class=\"string\">\"citylist\"</span>, <span class=\"string\">\"beijing\"</span>, <span class=\"string\">\"tianjin\"</span>, <span class=\"string\">\"km\"</span>)</div><div class=\"line\">rs2 := dist(<span class=\"string\">\"citylist\"</span>, <span class=\"string\">\"beijing\"</span>, <span class=\"string\">\"tangshan\"</span>, <span class=\"string\">\"km\"</span>)</div><div class=\"line\">rs3 := dist(<span class=\"string\">\"citylist\"</span>, <span class=\"string\">\"beijing\"</span>, <span class=\"string\">\"baoding\"</span>, <span class=\"string\">\"km\"</span>)</div><div class=\"line\"></div><div class=\"line\">fmt.Println(<span class=\"string\">\"北京-天津\"</span>, rs1)</div><div class=\"line\">fmt.Println(<span class=\"string\">\"北京-唐山\"</span>, rs2)</div><div class=\"line\">fmt.Println(<span class=\"string\">\"北京-保定\"</span>, rs3)</div></pre></td></tr></table></figure>","site":{"data":{}},"excerpt":"","more":"<p><a href=\"/2017/09/17/redis-geo-with-redigo-in-golang-part-1.html\">上一篇</a>简单记录了在Go中使用redigo这个包操作Redis，简单的使用了添加和查询。</p>\n<p>今天来试一下计算距离。之前也写到过在<a href=\"/2017/06/27/order-by-distance-in-mysql.html\">MySQL中计算坐标的距离，及排序</a>。</p>\n<p>在上一篇中疏忽了一个问题，使用的几个坐标点是用高德地图获取到的，但是Redis中GEO是使用了 WGS84 坐标系的。实际使用中需要注意一下，这里有一篇文章详细介绍了不同坐标系的区别。</p>\n<h4 id=\"添加测试数据\"><a href=\"#添加测试数据\" class=\"headerlink\" title=\"添加测试数据\"></a>添加测试数据</h4><p>先添加几条测试用的数据。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">push(<span class=\"string\">\"citylist\"</span>, <span class=\"string\">\"tianjin\"</span>, <span class=\"number\">39.1252291</span>, <span class=\"number\">117.0153461</span>)</div><div class=\"line\">push(<span class=\"string\">\"citylist\"</span>, <span class=\"string\">\"tangshan\"</span>, <span class=\"number\">39.0507819</span>, <span class=\"number\">116.9421939</span>)</div><div class=\"line\">push(<span class=\"string\">\"citylist\"</span>, <span class=\"string\">\"baoding\"</span>, <span class=\"number\">38.8712164</span>, <span class=\"number\">115.3353061</span>)</div></pre></td></tr></table></figure>\n<p>添加了三个城市。</p>\n<h4 id=\"查询距离\"><a href=\"#查询距离\" class=\"headerlink\" title=\"查询距离\"></a>查询距离</h4><p>使用GEODIST方法查询两点的距离。手册<a href=\"http://redisdoc.com/geo/geodist.html\" target=\"_blank\" rel=\"external\">见此</a>。</p>\n<p>语法： GEODIST key member1 member2 [unit]</p>\n<p>第四个参数可选,可选值为：</p>\n<ul>\n<li>m 表示单位为米。</li>\n<li>km 表示单位为千米。</li>\n<li>mi 表示单位为英里。</li>\n<li>ft 表示单位为英尺。</li>\n</ul>\n<p>默认是米。</p>\n<p>简单写一个方法，传入key和要查询的两点，及距离单位。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">dist</span><span class=\"params\">(key, m1, m2, unit <span class=\"keyword\">string</span>)</span> <span class=\"title\">float64</span></span> &#123;</div><div class=\"line\">\trc := RedisClient.Get()</div><div class=\"line\">\t<span class=\"keyword\">defer</span> rc.Close()</div><div class=\"line\"></div><div class=\"line\">\trs1, _ := redis.Float64(rc.Do(<span class=\"string\">\"GEODIST\"</span>, key, m1, m2, unit))</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"keyword\">return</span> rs</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>GEODIST返回值是双精度浮点数，这里直接使用redigo包的Float64方法转换返回了。</p>\n<h4 id=\"使用\"><a href=\"#使用\" class=\"headerlink\" title=\"使用\"></a>使用</h4><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">rs1 := dist(<span class=\"string\">\"citylist\"</span>, <span class=\"string\">\"beijing\"</span>, <span class=\"string\">\"tianjin\"</span>, <span class=\"string\">\"km\"</span>)</div><div class=\"line\">rs2 := dist(<span class=\"string\">\"citylist\"</span>, <span class=\"string\">\"beijing\"</span>, <span class=\"string\">\"tangshan\"</span>, <span class=\"string\">\"km\"</span>)</div><div class=\"line\">rs3 := dist(<span class=\"string\">\"citylist\"</span>, <span class=\"string\">\"beijing\"</span>, <span class=\"string\">\"baoding\"</span>, <span class=\"string\">\"km\"</span>)</div><div class=\"line\"></div><div class=\"line\">fmt.Println(<span class=\"string\">\"北京-天津\"</span>, rs1)</div><div class=\"line\">fmt.Println(<span class=\"string\">\"北京-唐山\"</span>, rs2)</div><div class=\"line\">fmt.Println(<span class=\"string\">\"北京-保定\"</span>, rs3)</div></pre></td></tr></table></figure>"},{"title":"Go语言使用redigo操作GEO(3) - 获取范围集合","date":"2017-09-24T10:09:18.000Z","_content":"\n[上一篇](/2017/09/17/redis-geo-with-redigo-in-golang-part-2.html)记录了使用redigo操作Redis的获取两点距离的功能。\n\n今天继续来写一下，获取一个坐标点指定距离范围内地理位置的集合。\n\n完成此功能，需要使用Redis的 GEORADIUS 命令。\n\n语法：\n\n```shell\nGEORADIUS key longitude latitude radius [m|km|ft|mi] [WITHCOORD] [WITHDIST] [ASC|DESC] [WITHHASH] [COUNT count]\n```\n\n其中，longitude latitude 表示地理位置的坐标，radius表示范围的距离，单位可以是m，km，ft，mi，依次为米，千米，英里，英尺。\n\n后边的可选参数中：\n\n- WITHCOORD：传入WITHCOORD参数，返回结果会带上匹配位置的经纬度。\n- WITHDIST：传入WITHDIST参数，返回结果会带上匹配位置与给定地理位置的距离，距离的单位与 GEORADIUS 命令传入的单位一致。\n- ASC|DESC：默认结果是未排序的，ASC表示从近到远排序，DESC表示从远到近排序。\n- WITHHASH：传入WITHHASH参数，返回结果会带上匹配位置的hash值。hash为52位有符号整数。\n- COUNT count：传入COUNT参数，返回指定数量的结果。\n\n参照文档，可以发现，默认情况下 GEORADIUS 会返回全部匹配的元素，而传入 COUNT 参数会截取指定的部分元素返回，但是由于此命令还需要对返回结果进行排序，所以如果元素较多的情况下，即使使用了 COUNT 参数，查找速度也会很慢。所以此参数仅适用于减小带宽占用，一次性返回少数数据，多次查询。\n\nGEORADIUS 的返回值是一个数组:\n\n- 如果传入了WITHCOORD，WITHDIST，WITHHASH参数，会返回二维的数组，其中每个子数组表示一个元素\n- 如果没有传入上述参数，会返回一个一维的数组，值为元素名，如[\"tianjin\",\"baoding\"]\n\n如果返回的是二维数组，子数组的第一个元素是对应位置的名字，其他的会根据传入的参数当做数组的元素返回，其中：\n\n- 距离依然是一个双精度浮点数，单位与传入的单位参数一致。\n- GEOHASH 是一个整数。\n- 坐标分别为经度，纬度，其中经度在前。\n\n如：\n\n```shell\n GEORADIUS citylist 116.280316 39.9329 200 km WITHCOORD\n```\n会返回\n\n```shell\n1) 1) \"beijing\"\n   2) 1) \"116.40528291463851929\"\n      2) \"39.9049884229125027\"\n2) 1) \"baoding\"\n   2) 1) \"115.33530682325363159\"\n      2) \"38.87121760640306434\"\n3) 1) \"tangshan\"\n   2) 1) \"116.94219142198562622\"\n      2) \"39.05078232277295314\"\n4) 1) \"tianjin\"\n   2) 1) \"117.0153459906578064\"\n      2) \"39.12522961794389431\"\n```\n\n那么，使用redigo如何实现呢？\n\n#### 有WITHCOORD，WITHDIST，WITHHASH参数\n\n暂时还没想到怎么解决这个比较好。\n\n#### 无WITHCOORD，WITHDIST，WITHHASH参数\n\n```Go\nfunc radius(key string, lng, lat float64, radius int, unit string) []string {\n\trc := RedisClient.Get()\n\tdefer rc.Close()\n\n\tpos, _ := redis.Strings(rc.Do(\"GEORADIUS\", key, lng, lat, radius, unit))\n\treturn pos\n}\n\n```\n\n该方法则会返回符合条件的元素的名称，如：\n```shell\n[beijing baoding tangshan tianjin]\n```\n\n","source":"_posts/redis-geo-with-redigo-in-golang-part-3.md","raw":"title: Go语言使用redigo操作GEO(3) - 获取范围集合\ncategories: golang\ndate: 2017-09-24 18:09:18\ntags:  [go,redis,redigo,geo]\n---\n\n[上一篇](/2017/09/17/redis-geo-with-redigo-in-golang-part-2.html)记录了使用redigo操作Redis的获取两点距离的功能。\n\n今天继续来写一下，获取一个坐标点指定距离范围内地理位置的集合。\n\n完成此功能，需要使用Redis的 GEORADIUS 命令。\n\n语法：\n\n```shell\nGEORADIUS key longitude latitude radius [m|km|ft|mi] [WITHCOORD] [WITHDIST] [ASC|DESC] [WITHHASH] [COUNT count]\n```\n\n其中，longitude latitude 表示地理位置的坐标，radius表示范围的距离，单位可以是m，km，ft，mi，依次为米，千米，英里，英尺。\n\n后边的可选参数中：\n\n- WITHCOORD：传入WITHCOORD参数，返回结果会带上匹配位置的经纬度。\n- WITHDIST：传入WITHDIST参数，返回结果会带上匹配位置与给定地理位置的距离，距离的单位与 GEORADIUS 命令传入的单位一致。\n- ASC|DESC：默认结果是未排序的，ASC表示从近到远排序，DESC表示从远到近排序。\n- WITHHASH：传入WITHHASH参数，返回结果会带上匹配位置的hash值。hash为52位有符号整数。\n- COUNT count：传入COUNT参数，返回指定数量的结果。\n\n参照文档，可以发现，默认情况下 GEORADIUS 会返回全部匹配的元素，而传入 COUNT 参数会截取指定的部分元素返回，但是由于此命令还需要对返回结果进行排序，所以如果元素较多的情况下，即使使用了 COUNT 参数，查找速度也会很慢。所以此参数仅适用于减小带宽占用，一次性返回少数数据，多次查询。\n\nGEORADIUS 的返回值是一个数组:\n\n- 如果传入了WITHCOORD，WITHDIST，WITHHASH参数，会返回二维的数组，其中每个子数组表示一个元素\n- 如果没有传入上述参数，会返回一个一维的数组，值为元素名，如[\"tianjin\",\"baoding\"]\n\n如果返回的是二维数组，子数组的第一个元素是对应位置的名字，其他的会根据传入的参数当做数组的元素返回，其中：\n\n- 距离依然是一个双精度浮点数，单位与传入的单位参数一致。\n- GEOHASH 是一个整数。\n- 坐标分别为经度，纬度，其中经度在前。\n\n如：\n\n```shell\n GEORADIUS citylist 116.280316 39.9329 200 km WITHCOORD\n```\n会返回\n\n```shell\n1) 1) \"beijing\"\n   2) 1) \"116.40528291463851929\"\n      2) \"39.9049884229125027\"\n2) 1) \"baoding\"\n   2) 1) \"115.33530682325363159\"\n      2) \"38.87121760640306434\"\n3) 1) \"tangshan\"\n   2) 1) \"116.94219142198562622\"\n      2) \"39.05078232277295314\"\n4) 1) \"tianjin\"\n   2) 1) \"117.0153459906578064\"\n      2) \"39.12522961794389431\"\n```\n\n那么，使用redigo如何实现呢？\n\n#### 有WITHCOORD，WITHDIST，WITHHASH参数\n\n暂时还没想到怎么解决这个比较好。\n\n#### 无WITHCOORD，WITHDIST，WITHHASH参数\n\n```Go\nfunc radius(key string, lng, lat float64, radius int, unit string) []string {\n\trc := RedisClient.Get()\n\tdefer rc.Close()\n\n\tpos, _ := redis.Strings(rc.Do(\"GEORADIUS\", key, lng, lat, radius, unit))\n\treturn pos\n}\n\n```\n\n该方法则会返回符合条件的元素的名称，如：\n```shell\n[beijing baoding tangshan tianjin]\n```\n\n","slug":"redis-geo-with-redigo-in-golang-part-3","published":1,"updated":"2017-09-27T12:34:31.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj830jvev0031ul0riebzttix","content":"<p><a href=\"/2017/09/17/redis-geo-with-redigo-in-golang-part-2.html\">上一篇</a>记录了使用redigo操作Redis的获取两点距离的功能。</p>\n<p>今天继续来写一下，获取一个坐标点指定距离范围内地理位置的集合。</p>\n<p>完成此功能，需要使用Redis的 GEORADIUS 命令。</p>\n<p>语法：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">GEORADIUS key longitude latitude radius [m|km|ft|mi] [WITHCOORD] [WITHDIST] [ASC|DESC] [WITHHASH] [COUNT count]</div></pre></td></tr></table></figure>\n<p>其中，longitude latitude 表示地理位置的坐标，radius表示范围的距离，单位可以是m，km，ft，mi，依次为米，千米，英里，英尺。</p>\n<p>后边的可选参数中：</p>\n<ul>\n<li>WITHCOORD：传入WITHCOORD参数，返回结果会带上匹配位置的经纬度。</li>\n<li>WITHDIST：传入WITHDIST参数，返回结果会带上匹配位置与给定地理位置的距离，距离的单位与 GEORADIUS 命令传入的单位一致。</li>\n<li>ASC|DESC：默认结果是未排序的，ASC表示从近到远排序，DESC表示从远到近排序。</li>\n<li>WITHHASH：传入WITHHASH参数，返回结果会带上匹配位置的hash值。hash为52位有符号整数。</li>\n<li>COUNT count：传入COUNT参数，返回指定数量的结果。</li>\n</ul>\n<p>参照文档，可以发现，默认情况下 GEORADIUS 会返回全部匹配的元素，而传入 COUNT 参数会截取指定的部分元素返回，但是由于此命令还需要对返回结果进行排序，所以如果元素较多的情况下，即使使用了 COUNT 参数，查找速度也会很慢。所以此参数仅适用于减小带宽占用，一次性返回少数数据，多次查询。</p>\n<p>GEORADIUS 的返回值是一个数组:</p>\n<ul>\n<li>如果传入了WITHCOORD，WITHDIST，WITHHASH参数，会返回二维的数组，其中每个子数组表示一个元素</li>\n<li>如果没有传入上述参数，会返回一个一维的数组，值为元素名，如[“tianjin”,”baoding”]</li>\n</ul>\n<p>如果返回的是二维数组，子数组的第一个元素是对应位置的名字，其他的会根据传入的参数当做数组的元素返回，其中：</p>\n<ul>\n<li>距离依然是一个双精度浮点数，单位与传入的单位参数一致。</li>\n<li>GEOHASH 是一个整数。</li>\n<li>坐标分别为经度，纬度，其中经度在前。</li>\n</ul>\n<p>如：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">GEORADIUS citylist 116.280316 39.9329 200 km WITHCOORD</div></pre></td></tr></table></figure>\n<p>会返回</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div></pre></td><td class=\"code\"><pre><div class=\"line\">1) 1) \"beijing\"</div><div class=\"line\">   2) 1) \"116.40528291463851929\"</div><div class=\"line\">      2) \"39.9049884229125027\"</div><div class=\"line\">2) 1) \"baoding\"</div><div class=\"line\">   2) 1) \"115.33530682325363159\"</div><div class=\"line\">      2) \"38.87121760640306434\"</div><div class=\"line\">3) 1) \"tangshan\"</div><div class=\"line\">   2) 1) \"116.94219142198562622\"</div><div class=\"line\">      2) \"39.05078232277295314\"</div><div class=\"line\">4) 1) \"tianjin\"</div><div class=\"line\">   2) 1) \"117.0153459906578064\"</div><div class=\"line\">      2) \"39.12522961794389431\"</div></pre></td></tr></table></figure>\n<p>那么，使用redigo如何实现呢？</p>\n<h4 id=\"有WITHCOORD，WITHDIST，WITHHASH参数\"><a href=\"#有WITHCOORD，WITHDIST，WITHHASH参数\" class=\"headerlink\" title=\"有WITHCOORD，WITHDIST，WITHHASH参数\"></a>有WITHCOORD，WITHDIST，WITHHASH参数</h4><p>暂时还没想到怎么解决这个比较好。</p>\n<h4 id=\"无WITHCOORD，WITHDIST，WITHHASH参数\"><a href=\"#无WITHCOORD，WITHDIST，WITHHASH参数\" class=\"headerlink\" title=\"无WITHCOORD，WITHDIST，WITHHASH参数\"></a>无WITHCOORD，WITHDIST，WITHHASH参数</h4><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">radius</span><span class=\"params\">(key <span class=\"keyword\">string</span>, lng, lat <span class=\"keyword\">float64</span>, radius <span class=\"keyword\">int</span>, unit <span class=\"keyword\">string</span>)</span> []<span class=\"title\">string</span></span> &#123;</div><div class=\"line\">\trc := RedisClient.Get()</div><div class=\"line\">\t<span class=\"keyword\">defer</span> rc.Close()</div><div class=\"line\"></div><div class=\"line\">\tpos, _ := redis.Strings(rc.Do(<span class=\"string\">\"GEORADIUS\"</span>, key, lng, lat, radius, unit))</div><div class=\"line\">\t<span class=\"keyword\">return</span> pos</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>该方法则会返回符合条件的元素的名称，如：<br><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">[beijing baoding tangshan tianjin]</div></pre></td></tr></table></figure></p>\n","site":{"data":{}},"excerpt":"","more":"<p><a href=\"/2017/09/17/redis-geo-with-redigo-in-golang-part-2.html\">上一篇</a>记录了使用redigo操作Redis的获取两点距离的功能。</p>\n<p>今天继续来写一下，获取一个坐标点指定距离范围内地理位置的集合。</p>\n<p>完成此功能，需要使用Redis的 GEORADIUS 命令。</p>\n<p>语法：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">GEORADIUS key longitude latitude radius [m|km|ft|mi] [WITHCOORD] [WITHDIST] [ASC|DESC] [WITHHASH] [COUNT count]</div></pre></td></tr></table></figure>\n<p>其中，longitude latitude 表示地理位置的坐标，radius表示范围的距离，单位可以是m，km，ft，mi，依次为米，千米，英里，英尺。</p>\n<p>后边的可选参数中：</p>\n<ul>\n<li>WITHCOORD：传入WITHCOORD参数，返回结果会带上匹配位置的经纬度。</li>\n<li>WITHDIST：传入WITHDIST参数，返回结果会带上匹配位置与给定地理位置的距离，距离的单位与 GEORADIUS 命令传入的单位一致。</li>\n<li>ASC|DESC：默认结果是未排序的，ASC表示从近到远排序，DESC表示从远到近排序。</li>\n<li>WITHHASH：传入WITHHASH参数，返回结果会带上匹配位置的hash值。hash为52位有符号整数。</li>\n<li>COUNT count：传入COUNT参数，返回指定数量的结果。</li>\n</ul>\n<p>参照文档，可以发现，默认情况下 GEORADIUS 会返回全部匹配的元素，而传入 COUNT 参数会截取指定的部分元素返回，但是由于此命令还需要对返回结果进行排序，所以如果元素较多的情况下，即使使用了 COUNT 参数，查找速度也会很慢。所以此参数仅适用于减小带宽占用，一次性返回少数数据，多次查询。</p>\n<p>GEORADIUS 的返回值是一个数组:</p>\n<ul>\n<li>如果传入了WITHCOORD，WITHDIST，WITHHASH参数，会返回二维的数组，其中每个子数组表示一个元素</li>\n<li>如果没有传入上述参数，会返回一个一维的数组，值为元素名，如[“tianjin”,”baoding”]</li>\n</ul>\n<p>如果返回的是二维数组，子数组的第一个元素是对应位置的名字，其他的会根据传入的参数当做数组的元素返回，其中：</p>\n<ul>\n<li>距离依然是一个双精度浮点数，单位与传入的单位参数一致。</li>\n<li>GEOHASH 是一个整数。</li>\n<li>坐标分别为经度，纬度，其中经度在前。</li>\n</ul>\n<p>如：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">GEORADIUS citylist 116.280316 39.9329 200 km WITHCOORD</div></pre></td></tr></table></figure>\n<p>会返回</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div></pre></td><td class=\"code\"><pre><div class=\"line\">1) 1) \"beijing\"</div><div class=\"line\">   2) 1) \"116.40528291463851929\"</div><div class=\"line\">      2) \"39.9049884229125027\"</div><div class=\"line\">2) 1) \"baoding\"</div><div class=\"line\">   2) 1) \"115.33530682325363159\"</div><div class=\"line\">      2) \"38.87121760640306434\"</div><div class=\"line\">3) 1) \"tangshan\"</div><div class=\"line\">   2) 1) \"116.94219142198562622\"</div><div class=\"line\">      2) \"39.05078232277295314\"</div><div class=\"line\">4) 1) \"tianjin\"</div><div class=\"line\">   2) 1) \"117.0153459906578064\"</div><div class=\"line\">      2) \"39.12522961794389431\"</div></pre></td></tr></table></figure>\n<p>那么，使用redigo如何实现呢？</p>\n<h4 id=\"有WITHCOORD，WITHDIST，WITHHASH参数\"><a href=\"#有WITHCOORD，WITHDIST，WITHHASH参数\" class=\"headerlink\" title=\"有WITHCOORD，WITHDIST，WITHHASH参数\"></a>有WITHCOORD，WITHDIST，WITHHASH参数</h4><p>暂时还没想到怎么解决这个比较好。</p>\n<h4 id=\"无WITHCOORD，WITHDIST，WITHHASH参数\"><a href=\"#无WITHCOORD，WITHDIST，WITHHASH参数\" class=\"headerlink\" title=\"无WITHCOORD，WITHDIST，WITHHASH参数\"></a>无WITHCOORD，WITHDIST，WITHHASH参数</h4><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">radius</span><span class=\"params\">(key <span class=\"keyword\">string</span>, lng, lat <span class=\"keyword\">float64</span>, radius <span class=\"keyword\">int</span>, unit <span class=\"keyword\">string</span>)</span> []<span class=\"title\">string</span></span> &#123;</div><div class=\"line\">\trc := RedisClient.Get()</div><div class=\"line\">\t<span class=\"keyword\">defer</span> rc.Close()</div><div class=\"line\"></div><div class=\"line\">\tpos, _ := redis.Strings(rc.Do(<span class=\"string\">\"GEORADIUS\"</span>, key, lng, lat, radius, unit))</div><div class=\"line\">\t<span class=\"keyword\">return</span> pos</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>该方法则会返回符合条件的元素的名称，如：<br><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">[beijing baoding tangshan tianjin]</div></pre></td></tr></table></figure></p>\n"},{"title":"使用Let's Encrypt制作数字证书","date":"2015-12-19T08:38:37.000Z","_content":"![](https://s.qichengzx.com/img/201512/https.png)\n\nLet's Encrypt是一个新的CA机构，提供非常简单并且免费的TLS／SSL证书服务。\n\n可谓万众期待。\n\n说下我的环境：\n\t\n\tUbuntu 14.04.3\n\tNginx 1.4.6\n\t\n\n首先你要有个域名，其次要有个服务器。\n\n### STEP 0 － 安装Let's Encrypt 客户端\n \n##### 安装git\n\n先更新下系统\n\n```\nsudo apt-get update\nsudo apt-get -y install git\n```\n\n##### Clone Let's Encrypt\n\n```\nsudo git clone https://github.com/letsencrypt/letsencrypt /opt/letsencrypt\n```\n\n这里把下载的文件放到了/opt/letsencrypt文件夹\n\n### STEP 1－生成证书\n\n首先需要关闭80端口\n\n```\nsudo nginx -s stop\n```\n\n接下来运行Let's Encrypt\n\n```\ncd /opt/letsencrypt\n./letsencrypt-auto certonly --standalone\n```\n\n注意：需要超级用户权限，所以需要输入密码\n\n之后会出现提示框，需要输入邮箱，用于接收提醒和，如果不幸丢失了Key，找回的时候也需要邮箱。\n\n根据提示进行操作即可，接下来啥同意用户协议。\n\n下一步则是输入你需要生成证书的域名了，如果需要一个证书给多个域名使用，这些域名则要全部输入，（example.com和www.example.com是不同的域名），域名之间用空格，逗号，左斜杠 分隔。\n\n成功后会有如下提示：\n\n```\nIMPORTANT NOTES:\n\n - If you lose your account credentials, you can recover through\n   e-mails sent to sammy@digitalocean.com\n - Congratulations! Your certificate and chain have been saved at\n    /etc/letsencrypt/live/example.com/fullchain.pem. Your\n   cert will expire on 2016-03-15. To obtain a new version of the\n   certificate in the future, simply run Let's Encrypt again.\n - Your account credentials have been saved in your Let's Encrypt\n   configuration directory at /etc/letsencrypt. You should make a\n   secure backup of this folder now. This configuration directory will\n   also contain certificates and private keys obtained by Let's\n   Encrypt so making regular backups of this folder is ideal.\n - If like Let's Encrypt, please consider supporting our work by:\n\n   Donating to ISRG / Let's Encrypt:   https://letsencrypt.org/donate\n   Donating to EFF:                    https://eff.org/donate-le\n\n```\n\n证书位置：/etc/letsencrypt/live/example.com/fullchain.pem\n\n过期时间：2016-03-15\n\n至于过期时间为什么这么短则是出于安全考虑。不宜使用同一个证书太长时间。\n\n##### 证书文件：\n\n上一步成功后，会有如下4个文件生成。\n\n    \n```\nsudo ls /etc/letsencrypt/live/your_domain_name\n```\n\n\n    cert.pem: 证书\n    chain.pem: The Let's Encrypt chain certificate（不知道什么鬼）\n    fullchain.pem: cert.pem and chain.pem combined\n    privkey.pem: 证书私钥\n\n\n### STEP 2－配置Web服务器(Nginx)\n\n证书生成完毕，现在可以配置Web服务器了。\n\n编辑配置文件：\n\n```\nsudo vi /etc/nginx/sites-available/default\n```\n\n在server区块中，增加如下代码：\n\n```\nlisten 443 ssl;\nserver_name example.com;\nssl_certificate /etc/letsencrypt/live/example.com/fullchain.pem;\nssl_certificate_key /etc/letsencrypt/live/example.com/privkey.pem;\n```\n\n如果之前是绑定的80端口，直接改为443即可，后边增加 ssl 。\n\n如果想使用最安全的SSL协议，增加如下代码：\n\n```\nssl_protocols TLSv1 TLSv1.1 TLSv1.2;\nssl_prefer_server_ciphers on;\nssl_ciphers AES256+EECDH:AES256+EDH:!aNULL;\n```\n\n最后，在server区块后再增加一段，用于从HTTP跳转到HTTPS。\n\n```\nserver {\n    listen 80;\n    server_name example.com;\n    rewrite ^/(.*) https://example.com/$1 permanent;\n}\n\n```\n\n保存，退出。\n\n重启Nginx服务器。\n\n```\nsudo nginx -s reopen\n```\n\n现在已经可以通过HTTPS访问网站了。\n\n原文中还有设置自动生成证书的部分，出于懒的原因此处不再写。\n\n参考资料：\n[How To Secure Nginx with Let's Encrypt on Ubuntu 14.04](https://www.digitalocean.com/community/tutorials/how-to-secure-nginx-with-let-s-encrypt-on-ubuntu-14-04)","source":"_posts/secure-your-website-with-lets-encrypt.md","raw":"title: 使用Let's Encrypt制作数字证书\ndate: 2015-12-19 16:38:37\ntags:  [https,ssl]\n---\n![](https://s.qichengzx.com/img/201512/https.png)\n\nLet's Encrypt是一个新的CA机构，提供非常简单并且免费的TLS／SSL证书服务。\n\n可谓万众期待。\n\n说下我的环境：\n\t\n\tUbuntu 14.04.3\n\tNginx 1.4.6\n\t\n\n首先你要有个域名，其次要有个服务器。\n\n### STEP 0 － 安装Let's Encrypt 客户端\n \n##### 安装git\n\n先更新下系统\n\n```\nsudo apt-get update\nsudo apt-get -y install git\n```\n\n##### Clone Let's Encrypt\n\n```\nsudo git clone https://github.com/letsencrypt/letsencrypt /opt/letsencrypt\n```\n\n这里把下载的文件放到了/opt/letsencrypt文件夹\n\n### STEP 1－生成证书\n\n首先需要关闭80端口\n\n```\nsudo nginx -s stop\n```\n\n接下来运行Let's Encrypt\n\n```\ncd /opt/letsencrypt\n./letsencrypt-auto certonly --standalone\n```\n\n注意：需要超级用户权限，所以需要输入密码\n\n之后会出现提示框，需要输入邮箱，用于接收提醒和，如果不幸丢失了Key，找回的时候也需要邮箱。\n\n根据提示进行操作即可，接下来啥同意用户协议。\n\n下一步则是输入你需要生成证书的域名了，如果需要一个证书给多个域名使用，这些域名则要全部输入，（example.com和www.example.com是不同的域名），域名之间用空格，逗号，左斜杠 分隔。\n\n成功后会有如下提示：\n\n```\nIMPORTANT NOTES:\n\n - If you lose your account credentials, you can recover through\n   e-mails sent to sammy@digitalocean.com\n - Congratulations! Your certificate and chain have been saved at\n    /etc/letsencrypt/live/example.com/fullchain.pem. Your\n   cert will expire on 2016-03-15. To obtain a new version of the\n   certificate in the future, simply run Let's Encrypt again.\n - Your account credentials have been saved in your Let's Encrypt\n   configuration directory at /etc/letsencrypt. You should make a\n   secure backup of this folder now. This configuration directory will\n   also contain certificates and private keys obtained by Let's\n   Encrypt so making regular backups of this folder is ideal.\n - If like Let's Encrypt, please consider supporting our work by:\n\n   Donating to ISRG / Let's Encrypt:   https://letsencrypt.org/donate\n   Donating to EFF:                    https://eff.org/donate-le\n\n```\n\n证书位置：/etc/letsencrypt/live/example.com/fullchain.pem\n\n过期时间：2016-03-15\n\n至于过期时间为什么这么短则是出于安全考虑。不宜使用同一个证书太长时间。\n\n##### 证书文件：\n\n上一步成功后，会有如下4个文件生成。\n\n    \n```\nsudo ls /etc/letsencrypt/live/your_domain_name\n```\n\n\n    cert.pem: 证书\n    chain.pem: The Let's Encrypt chain certificate（不知道什么鬼）\n    fullchain.pem: cert.pem and chain.pem combined\n    privkey.pem: 证书私钥\n\n\n### STEP 2－配置Web服务器(Nginx)\n\n证书生成完毕，现在可以配置Web服务器了。\n\n编辑配置文件：\n\n```\nsudo vi /etc/nginx/sites-available/default\n```\n\n在server区块中，增加如下代码：\n\n```\nlisten 443 ssl;\nserver_name example.com;\nssl_certificate /etc/letsencrypt/live/example.com/fullchain.pem;\nssl_certificate_key /etc/letsencrypt/live/example.com/privkey.pem;\n```\n\n如果之前是绑定的80端口，直接改为443即可，后边增加 ssl 。\n\n如果想使用最安全的SSL协议，增加如下代码：\n\n```\nssl_protocols TLSv1 TLSv1.1 TLSv1.2;\nssl_prefer_server_ciphers on;\nssl_ciphers AES256+EECDH:AES256+EDH:!aNULL;\n```\n\n最后，在server区块后再增加一段，用于从HTTP跳转到HTTPS。\n\n```\nserver {\n    listen 80;\n    server_name example.com;\n    rewrite ^/(.*) https://example.com/$1 permanent;\n}\n\n```\n\n保存，退出。\n\n重启Nginx服务器。\n\n```\nsudo nginx -s reopen\n```\n\n现在已经可以通过HTTPS访问网站了。\n\n原文中还有设置自动生成证书的部分，出于懒的原因此处不再写。\n\n参考资料：\n[How To Secure Nginx with Let's Encrypt on Ubuntu 14.04](https://www.digitalocean.com/community/tutorials/how-to-secure-nginx-with-let-s-encrypt-on-ubuntu-14-04)","slug":"secure-your-website-with-lets-encrypt","published":1,"updated":"2015-12-19T13:31:45.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj830jvew0035ul0rxgrocc24","content":"<p><img src=\"https://s.qichengzx.com/img/201512/https.png\" alt=\"\"></p>\n<p>Let’s Encrypt是一个新的CA机构，提供非常简单并且免费的TLS／SSL证书服务。</p>\n<p>可谓万众期待。</p>\n<p>说下我的环境：</p>\n<pre><code>Ubuntu 14.04.3\nNginx 1.4.6\n</code></pre><p>首先你要有个域名，其次要有个服务器。</p>\n<h3 id=\"STEP-0-－-安装Let’s-Encrypt-客户端\"><a href=\"#STEP-0-－-安装Let’s-Encrypt-客户端\" class=\"headerlink\" title=\"STEP 0 － 安装Let’s Encrypt 客户端\"></a>STEP 0 － 安装Let’s Encrypt 客户端</h3><h5 id=\"安装git\"><a href=\"#安装git\" class=\"headerlink\" title=\"安装git\"></a>安装git</h5><p>先更新下系统</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">sudo apt-get update</div><div class=\"line\">sudo apt-get -y install git</div></pre></td></tr></table></figure>\n<h5 id=\"Clone-Let’s-Encrypt\"><a href=\"#Clone-Let’s-Encrypt\" class=\"headerlink\" title=\"Clone Let’s Encrypt\"></a>Clone Let’s Encrypt</h5><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">sudo git clone https://github.com/letsencrypt/letsencrypt /opt/letsencrypt</div></pre></td></tr></table></figure>\n<p>这里把下载的文件放到了/opt/letsencrypt文件夹</p>\n<h3 id=\"STEP-1－生成证书\"><a href=\"#STEP-1－生成证书\" class=\"headerlink\" title=\"STEP 1－生成证书\"></a>STEP 1－生成证书</h3><p>首先需要关闭80端口</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">sudo nginx -s stop</div></pre></td></tr></table></figure>\n<p>接下来运行Let’s Encrypt</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">cd /opt/letsencrypt</div><div class=\"line\">./letsencrypt-auto certonly --standalone</div></pre></td></tr></table></figure>\n<p>注意：需要超级用户权限，所以需要输入密码</p>\n<p>之后会出现提示框，需要输入邮箱，用于接收提醒和，如果不幸丢失了Key，找回的时候也需要邮箱。</p>\n<p>根据提示进行操作即可，接下来啥同意用户协议。</p>\n<p>下一步则是输入你需要生成证书的域名了，如果需要一个证书给多个域名使用，这些域名则要全部输入，（example.com和www.example.com是不同的域名），域名之间用空格，逗号，左斜杠 分隔。</p>\n<p>成功后会有如下提示：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div></pre></td><td class=\"code\"><pre><div class=\"line\">IMPORTANT NOTES:</div><div class=\"line\"></div><div class=\"line\"> - If you lose your account credentials, you can recover through</div><div class=\"line\">   e-mails sent to sammy@digitalocean.com</div><div class=\"line\"> - Congratulations! Your certificate and chain have been saved at</div><div class=\"line\">    /etc/letsencrypt/live/example.com/fullchain.pem. Your</div><div class=\"line\">   cert will expire on 2016-03-15. To obtain a new version of the</div><div class=\"line\">   certificate in the future, simply run Let&apos;s Encrypt again.</div><div class=\"line\"> - Your account credentials have been saved in your Let&apos;s Encrypt</div><div class=\"line\">   configuration directory at /etc/letsencrypt. You should make a</div><div class=\"line\">   secure backup of this folder now. This configuration directory will</div><div class=\"line\">   also contain certificates and private keys obtained by Let&apos;s</div><div class=\"line\">   Encrypt so making regular backups of this folder is ideal.</div><div class=\"line\"> - If like Let&apos;s Encrypt, please consider supporting our work by:</div><div class=\"line\"></div><div class=\"line\">   Donating to ISRG / Let&apos;s Encrypt:   https://letsencrypt.org/donate</div><div class=\"line\">   Donating to EFF:                    https://eff.org/donate-le</div></pre></td></tr></table></figure>\n<p>证书位置：/etc/letsencrypt/live/example.com/fullchain.pem</p>\n<p>过期时间：2016-03-15</p>\n<p>至于过期时间为什么这么短则是出于安全考虑。不宜使用同一个证书太长时间。</p>\n<h5 id=\"证书文件：\"><a href=\"#证书文件：\" class=\"headerlink\" title=\"证书文件：\"></a>证书文件：</h5><p>上一步成功后，会有如下4个文件生成。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">sudo ls /etc/letsencrypt/live/your_domain_name</div></pre></td></tr></table></figure>\n<pre><code>cert.pem: 证书\nchain.pem: The Let&apos;s Encrypt chain certificate（不知道什么鬼）\nfullchain.pem: cert.pem and chain.pem combined\nprivkey.pem: 证书私钥\n</code></pre><h3 id=\"STEP-2－配置Web服务器-Nginx\"><a href=\"#STEP-2－配置Web服务器-Nginx\" class=\"headerlink\" title=\"STEP 2－配置Web服务器(Nginx)\"></a>STEP 2－配置Web服务器(Nginx)</h3><p>证书生成完毕，现在可以配置Web服务器了。</p>\n<p>编辑配置文件：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">sudo vi /etc/nginx/sites-available/default</div></pre></td></tr></table></figure>\n<p>在server区块中，增加如下代码：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">listen 443 ssl;</div><div class=\"line\">server_name example.com;</div><div class=\"line\">ssl_certificate /etc/letsencrypt/live/example.com/fullchain.pem;</div><div class=\"line\">ssl_certificate_key /etc/letsencrypt/live/example.com/privkey.pem;</div></pre></td></tr></table></figure>\n<p>如果之前是绑定的80端口，直接改为443即可，后边增加 ssl 。</p>\n<p>如果想使用最安全的SSL协议，增加如下代码：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">ssl_protocols TLSv1 TLSv1.1 TLSv1.2;</div><div class=\"line\">ssl_prefer_server_ciphers on;</div><div class=\"line\">ssl_ciphers AES256+EECDH:AES256+EDH:!aNULL;</div></pre></td></tr></table></figure>\n<p>最后，在server区块后再增加一段，用于从HTTP跳转到HTTPS。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">server &#123;</div><div class=\"line\">    listen 80;</div><div class=\"line\">    server_name example.com;</div><div class=\"line\">    rewrite ^/(.*) https://example.com/$1 permanent;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>保存，退出。</p>\n<p>重启Nginx服务器。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">sudo nginx -s reopen</div></pre></td></tr></table></figure>\n<p>现在已经可以通过HTTPS访问网站了。</p>\n<p>原文中还有设置自动生成证书的部分，出于懒的原因此处不再写。</p>\n<p>参考资料：<br><a href=\"https://www.digitalocean.com/community/tutorials/how-to-secure-nginx-with-let-s-encrypt-on-ubuntu-14-04\" target=\"_blank\" rel=\"external\">How To Secure Nginx with Let’s Encrypt on Ubuntu 14.04</a></p>\n","site":{"data":{}},"excerpt":"","more":"<p><img src=\"https://s.qichengzx.com/img/201512/https.png\" alt=\"\"></p>\n<p>Let’s Encrypt是一个新的CA机构，提供非常简单并且免费的TLS／SSL证书服务。</p>\n<p>可谓万众期待。</p>\n<p>说下我的环境：</p>\n<pre><code>Ubuntu 14.04.3\nNginx 1.4.6\n</code></pre><p>首先你要有个域名，其次要有个服务器。</p>\n<h3 id=\"STEP-0-－-安装Let’s-Encrypt-客户端\"><a href=\"#STEP-0-－-安装Let’s-Encrypt-客户端\" class=\"headerlink\" title=\"STEP 0 － 安装Let’s Encrypt 客户端\"></a>STEP 0 － 安装Let’s Encrypt 客户端</h3><h5 id=\"安装git\"><a href=\"#安装git\" class=\"headerlink\" title=\"安装git\"></a>安装git</h5><p>先更新下系统</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">sudo apt-get update</div><div class=\"line\">sudo apt-get -y install git</div></pre></td></tr></table></figure>\n<h5 id=\"Clone-Let’s-Encrypt\"><a href=\"#Clone-Let’s-Encrypt\" class=\"headerlink\" title=\"Clone Let’s Encrypt\"></a>Clone Let’s Encrypt</h5><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">sudo git clone https://github.com/letsencrypt/letsencrypt /opt/letsencrypt</div></pre></td></tr></table></figure>\n<p>这里把下载的文件放到了/opt/letsencrypt文件夹</p>\n<h3 id=\"STEP-1－生成证书\"><a href=\"#STEP-1－生成证书\" class=\"headerlink\" title=\"STEP 1－生成证书\"></a>STEP 1－生成证书</h3><p>首先需要关闭80端口</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">sudo nginx -s stop</div></pre></td></tr></table></figure>\n<p>接下来运行Let’s Encrypt</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">cd /opt/letsencrypt</div><div class=\"line\">./letsencrypt-auto certonly --standalone</div></pre></td></tr></table></figure>\n<p>注意：需要超级用户权限，所以需要输入密码</p>\n<p>之后会出现提示框，需要输入邮箱，用于接收提醒和，如果不幸丢失了Key，找回的时候也需要邮箱。</p>\n<p>根据提示进行操作即可，接下来啥同意用户协议。</p>\n<p>下一步则是输入你需要生成证书的域名了，如果需要一个证书给多个域名使用，这些域名则要全部输入，（example.com和www.example.com是不同的域名），域名之间用空格，逗号，左斜杠 分隔。</p>\n<p>成功后会有如下提示：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div></pre></td><td class=\"code\"><pre><div class=\"line\">IMPORTANT NOTES:</div><div class=\"line\"></div><div class=\"line\"> - If you lose your account credentials, you can recover through</div><div class=\"line\">   e-mails sent to sammy@digitalocean.com</div><div class=\"line\"> - Congratulations! Your certificate and chain have been saved at</div><div class=\"line\">    /etc/letsencrypt/live/example.com/fullchain.pem. Your</div><div class=\"line\">   cert will expire on 2016-03-15. To obtain a new version of the</div><div class=\"line\">   certificate in the future, simply run Let&apos;s Encrypt again.</div><div class=\"line\"> - Your account credentials have been saved in your Let&apos;s Encrypt</div><div class=\"line\">   configuration directory at /etc/letsencrypt. You should make a</div><div class=\"line\">   secure backup of this folder now. This configuration directory will</div><div class=\"line\">   also contain certificates and private keys obtained by Let&apos;s</div><div class=\"line\">   Encrypt so making regular backups of this folder is ideal.</div><div class=\"line\"> - If like Let&apos;s Encrypt, please consider supporting our work by:</div><div class=\"line\"></div><div class=\"line\">   Donating to ISRG / Let&apos;s Encrypt:   https://letsencrypt.org/donate</div><div class=\"line\">   Donating to EFF:                    https://eff.org/donate-le</div></pre></td></tr></table></figure>\n<p>证书位置：/etc/letsencrypt/live/example.com/fullchain.pem</p>\n<p>过期时间：2016-03-15</p>\n<p>至于过期时间为什么这么短则是出于安全考虑。不宜使用同一个证书太长时间。</p>\n<h5 id=\"证书文件：\"><a href=\"#证书文件：\" class=\"headerlink\" title=\"证书文件：\"></a>证书文件：</h5><p>上一步成功后，会有如下4个文件生成。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">sudo ls /etc/letsencrypt/live/your_domain_name</div></pre></td></tr></table></figure>\n<pre><code>cert.pem: 证书\nchain.pem: The Let&apos;s Encrypt chain certificate（不知道什么鬼）\nfullchain.pem: cert.pem and chain.pem combined\nprivkey.pem: 证书私钥\n</code></pre><h3 id=\"STEP-2－配置Web服务器-Nginx\"><a href=\"#STEP-2－配置Web服务器-Nginx\" class=\"headerlink\" title=\"STEP 2－配置Web服务器(Nginx)\"></a>STEP 2－配置Web服务器(Nginx)</h3><p>证书生成完毕，现在可以配置Web服务器了。</p>\n<p>编辑配置文件：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">sudo vi /etc/nginx/sites-available/default</div></pre></td></tr></table></figure>\n<p>在server区块中，增加如下代码：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">listen 443 ssl;</div><div class=\"line\">server_name example.com;</div><div class=\"line\">ssl_certificate /etc/letsencrypt/live/example.com/fullchain.pem;</div><div class=\"line\">ssl_certificate_key /etc/letsencrypt/live/example.com/privkey.pem;</div></pre></td></tr></table></figure>\n<p>如果之前是绑定的80端口，直接改为443即可，后边增加 ssl 。</p>\n<p>如果想使用最安全的SSL协议，增加如下代码：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">ssl_protocols TLSv1 TLSv1.1 TLSv1.2;</div><div class=\"line\">ssl_prefer_server_ciphers on;</div><div class=\"line\">ssl_ciphers AES256+EECDH:AES256+EDH:!aNULL;</div></pre></td></tr></table></figure>\n<p>最后，在server区块后再增加一段，用于从HTTP跳转到HTTPS。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">server &#123;</div><div class=\"line\">    listen 80;</div><div class=\"line\">    server_name example.com;</div><div class=\"line\">    rewrite ^/(.*) https://example.com/$1 permanent;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>保存，退出。</p>\n<p>重启Nginx服务器。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">sudo nginx -s reopen</div></pre></td></tr></table></figure>\n<p>现在已经可以通过HTTPS访问网站了。</p>\n<p>原文中还有设置自动生成证书的部分，出于懒的原因此处不再写。</p>\n<p>参考资料：<br><a href=\"https://www.digitalocean.com/community/tutorials/how-to-secure-nginx-with-let-s-encrypt-on-ubuntu-14-04\" target=\"_blank\" rel=\"external\">How To Secure Nginx with Let’s Encrypt on Ubuntu 14.04</a></p>\n"},{"title":"Go语言写的一个短网址服务","date":"2016-12-27T13:27:34.000Z","_content":"\n![](/images/go/best-url-shortener-to-make-earn-money.png)\n<center>题图来自[http://www.dwtricks.com/](http://www.dwtricks.com/2015/05/best-10-url-shortener-networks-to-earn-money-2015.html/)</center>\n\n\"缩址，又称短址、短网址、网址缩短、缩短网址、URL缩短等，指的是一种互联网上的技术与服务。此服务可以提供一个非常短小的URL以代替原来的可能较长的URL，将长的URL地址缩短。\n用户访问缩短后的URL时，通常将会重定向到原来的URL。\"\n\n-- Wikipedia\n\n\n虽然短网址早已不再那么受广泛关注。但是不妨拿来练手。\n\n根据公开可以搜索到的资料，短网址一般是将一个ID转换到一串字母，生成短的网址用于传播，实际访问会重定向到原网址。如上所述。\n\n那么使用Go来写这个有什么优势呢，优势之一当然是，Go部署简单，只需要copy执行文件即可。执行速度也快，甚至连HTTP服务器都不需要。\n\n##### 下边就边写边说明。\n\n```go\npackage main\n\nimport (\n\t\"fmt\"\n\t\"strings\"\n\t\"time\"\n\t\"net/http\"\n\t\"database/sql\"\n\n\t\"github.com/gin-gonic/gin\"\n\n\t\"github.com/garyburd/redigo/redis\"\n\t_ \"github.com/go-sql-driver/mysql\"\n\n\t\"github.com/speps/go-hashids\"\n)\n```\n\n###### 定义hashid包需要的salt，即生成字符串的最短位数。\n\n```go\nconst (\n\thdSalt        = \"mysalt\"\n\thdMinLength   = 5\n\tdefaultDomain = \"http://localhost:8000/\"\n)\n```\n\n###### 定义redis和MySQL的配置信息\n\n```go\nvar (\n\tRedisClient *redis.Pool\n\tRedisHost   = \"127.0.0.1:6379\"\n\tRedisDb     = 0\n\tRedisPwd    = \"\"\n\n\tdb      *sql.DB\n\tDB_HOST = \"tcp(127.0.0.1:3306)\"\n\tDB_NAME = \"short\"\n\tDB_USER = \"root\"\n\tDB_PASS = \"\"\n)\n```\n\n##### main函数，首先连接redis和MySQL。定义如下路由：\n\n- 访问首页\n- 访问hash\n- 访问短网址信息页\n- 生成短网址接口\n\n熟悉的朋友应该都知道，访问短网址服务的首页一般会跳转到一个固定的网址，比如渣浪微博会跳转到微博首页，Twitter则是给出“Twitter uses the t.co domain as part of a service to protect users from harmful activity”的提示。这里我们也让它跳转到一个指定的网页。\n\n最后，以8080端口运行，实际线上会使用80端口，可以自行修改。\n\n```go\nfunc main() {\n\tinitRedis()\n\tinitMysql()\n\n\tgin.SetMode(gin.DebugMode)\n\tr := gin.Default()\n\n\tr.GET(\"/\", func(c *gin.Context) {\n\t\t//http code can be StatusFound or StatusMovedPermanently \n\t\tc.Redirect(http.StatusFound, defaultDomain)\n\t})\n\tr.GET(\"/:hash\", expandUrl)\n\tr.GET(\"/:hash/info\", expandUrlApi)\n\tr.POST(\"/short\", shortUrl)\n\n\tr.Run(\":8000\")\n}\n```\n\n##### 连接redis和MySQL\n\n```go\nfunc initRedis() {\n\t// 建立连接池\n\tRedisClient = &redis.Pool{\n\t\tMaxIdle:     1,\n\t\tMaxActive:   10,\n\t\tIdleTimeout: 180 * time.Second,\n\t\tDial: func() (redis.Conn, error) {\n\t\t\tc, err := redis.Dial(\"tcp\", RedisHost)\n\t\t\tif err != nil {\n\t\t\t\treturn nil, err\n\t\t\t}\n\t\t\tif _, err := c.Do(\"AUTH\", RedisPwd); err != nil {\n\t\t\t\tc.Close()\n\t\t\t\treturn nil, err\n\t\t\t}\n\t\t\tc.Do(\"SELECT\", RedisDb)\n\t\t\treturn c, nil\n\t\t},\n\t}\n}\n\nfunc initMysql() {\n\tdsn := DB_USER + \":\" + DB_PASS + \"@\" + DB_HOST + \"/\" + DB_NAME + \"?charset=utf8\"\n\tdb, _ = sql.Open(\"mysql\", dsn)\n\tdb.SetMaxOpenConns(5)\n\tdb.SetMaxIdleConns(20)\n\tdb.Ping()\n}\n```\n\n##### 生成短网址的接口函数。\n\n根据传入的URL参数，进行简单的验证后，写入数据库。根据写入后生成的ID，再生成一个字符串，然后返回给调用方。\n\n```go\nfunc shortUrl(c *gin.Context) {\n\tlongUrl := c.PostForm(\"url\")\n\n\tif longUrl == \"\" {\n\t\tc.JSON(200, gin.H{\n\t\t\t\"status\":  500,\n\t\t\t\"message\": \"请传入网址\",\n\t\t})\n\t\treturn\n\t}\n\n\tif !strings.HasPrefix(longUrl, \"http\") {\n\t\tlongUrl = \"http://\" + longUrl\n\t}\n\n\tif hash, ok := insert(longUrl); ok {\n\t\tc.JSON(200, gin.H{\n\t\t\t\"status\":  200,\n\t\t\t\"message\": \"ok\",\n\t\t\t\"short\":   defaultDomain + hash,\n\t\t})\n\t}\n}\n```\n\n##### 根据HASH解析并跳转到对应的长URL，不存在则跳转到默认地址\n\n```go\nfunc expandUrl(c *gin.Context) {\n\thash := c.Param(\"hash\")\n\n\tif url, ok := findByHash(hash); ok {\n\t\tc.Redirect(http.StatusMovedPermanently, url)\n\t}\n\t// 注意:\n\t// \t实际中，此应用的运行域名可能与默认域名不同，如a.com运行此程序，默认域名为b.com\n\t// \t当访问一个不存在的HASH或a.com时，可以跳转到任意域名，即defaultDomain\n\tc.Redirect(http.StatusMovedPermanently, defaultDomain)\n}\n```\n\n##### 根据HASH在redis中查找并返回结果，不存在则返回404状态\n\n```go\nfunc expandUrlApi(c *gin.Context) {\n\thash := c.Param(\"hash\")\n\n\tif url, ok := findByHash(hash); ok {\n\t\tc.JSON(200, gin.H{\n\t\t\t\"status\":  200,\n\t\t\t\"message\": \"ok\",\n\t\t\t\"data\":    url,\n\t\t})\n\t\treturn\n\t}\n\n\t// 此处可以尝试在MySQL中再次查询\n\tc.JSON(200, gin.H{\n\t\t\"status\":  404,\n\t\t\"message\": \"url of hash is not exist\",\n\t})\n}\n```\n\n##### 将ID转换成对应的HASH值，hdSalt与hdMinLength 会影响生成结果，确定后不要改动\n\n```go\nfunc shortenURL(id int) string {\n\thd := hashids.NewData()\n\thd.Salt = hdSalt\n\thd.MinLength = hdMinLength\n\n\th := hashids.NewWithData(hd)\n\te, _ := h.Encode([]int{id})\n\n\treturn e\n}\n```\n\n##### 根据HASH解析出对应的ID值, hdSalt与hdMinLength 会影响生成结果，确定后不要改动\n\n```go\nfunc expand(hash string) int {\n\thd := hashids.NewData()\n\thd.Salt = hdSalt\n\thd.MinLength = hdMinLength\n\n\th := hashids.NewWithData(hd)\n\td, _ := h.DecodeWithError(hash)\n\n\treturn d[0]\n}\n```\n\n##### 数据库中根据ID查找\n\n```go\nfunc find(id int) (string, bool) {\n\tvar url string\n\terr := db.QueryRow(\"SELECT url FROM url WHERE id = ?\", id).Scan(&url)\n\tif err == nil {\n\t\treturn url, true\n\t} else {\n\t\treturn \"\", false\n\t}\n}\n```\n\n##### 在redis中根据HASH查找\n\n```go\nfunc findByHash(h string) (string, bool) {\n\trc := RedisClient.Get()\n\n\tdefer rc.Close()\n\turl, _ := redis.String(rc.Do(\"GET\", \"URL:\"+h))\n\n\tif url != \"\" {\n\t\treturn url, true\n\t}\n\n\tid := expand(h)\n\tif urldb, ok := find(id); ok {\n\t\treturn urldb, true\n\t}\n\n\treturn \"\", false\n}\n```\n\n##### 将长网址插入到数据库中，并把返回的ID生成HASH和长网址存入redis\n\n```go\nfunc insert(url string) (string, bool) {\n\tstmt, _ := db.Prepare(`INSERT INTO url (url) values (?)`)\n\tres, err := stmt.Exec(url)\n\tcheckErr(err)\n\n\tid, _ := res.LastInsertId()\n\n\trc := RedisClient.Get()\n\tdefer rc.Close()\n\n\thash := shortenURL(int(id))\n\trc.Do(\"SET\", \"URL:\"+hash, url)\n\n\treturn hash, true\n}\n```\n\n#### 打印方法，和检查错误的方法\n\n```go\nfunc Log(v ...interface{}) {\n\tfmt.Println(v...)\n}\n\nfunc checkErr(err error) {\n\tif err != nil {\n\t\tpanic(err)\n\t}\n}\n```\n\n有些地方还需修改，就算是抛砖引玉吧。\n\n感谢[hashids](http://hashids.org/)\n\n#### Github地址 ： [shortme](https://github.com/qichengzx/shortme)\n\n相关资料：\n\n[URL Toolbox: 90+ URL Shortening Services](http://mashable.com/2008/01/08/url-shortening-services/#CgEzOrfnzPqb)\n[TinyURL](http://tinyurl.com/)\n","source":"_posts/shortlen-url-by-go.md","raw":"title: Go语言写的一个短网址服务\ncategories: golang\ndate: 2016-12-27 21:27:34\ntags:  [go,短网址]\n---\n\n![](/images/go/best-url-shortener-to-make-earn-money.png)\n<center>题图来自[http://www.dwtricks.com/](http://www.dwtricks.com/2015/05/best-10-url-shortener-networks-to-earn-money-2015.html/)</center>\n\n\"缩址，又称短址、短网址、网址缩短、缩短网址、URL缩短等，指的是一种互联网上的技术与服务。此服务可以提供一个非常短小的URL以代替原来的可能较长的URL，将长的URL地址缩短。\n用户访问缩短后的URL时，通常将会重定向到原来的URL。\"\n\n-- Wikipedia\n\n\n虽然短网址早已不再那么受广泛关注。但是不妨拿来练手。\n\n根据公开可以搜索到的资料，短网址一般是将一个ID转换到一串字母，生成短的网址用于传播，实际访问会重定向到原网址。如上所述。\n\n那么使用Go来写这个有什么优势呢，优势之一当然是，Go部署简单，只需要copy执行文件即可。执行速度也快，甚至连HTTP服务器都不需要。\n\n##### 下边就边写边说明。\n\n```go\npackage main\n\nimport (\n\t\"fmt\"\n\t\"strings\"\n\t\"time\"\n\t\"net/http\"\n\t\"database/sql\"\n\n\t\"github.com/gin-gonic/gin\"\n\n\t\"github.com/garyburd/redigo/redis\"\n\t_ \"github.com/go-sql-driver/mysql\"\n\n\t\"github.com/speps/go-hashids\"\n)\n```\n\n###### 定义hashid包需要的salt，即生成字符串的最短位数。\n\n```go\nconst (\n\thdSalt        = \"mysalt\"\n\thdMinLength   = 5\n\tdefaultDomain = \"http://localhost:8000/\"\n)\n```\n\n###### 定义redis和MySQL的配置信息\n\n```go\nvar (\n\tRedisClient *redis.Pool\n\tRedisHost   = \"127.0.0.1:6379\"\n\tRedisDb     = 0\n\tRedisPwd    = \"\"\n\n\tdb      *sql.DB\n\tDB_HOST = \"tcp(127.0.0.1:3306)\"\n\tDB_NAME = \"short\"\n\tDB_USER = \"root\"\n\tDB_PASS = \"\"\n)\n```\n\n##### main函数，首先连接redis和MySQL。定义如下路由：\n\n- 访问首页\n- 访问hash\n- 访问短网址信息页\n- 生成短网址接口\n\n熟悉的朋友应该都知道，访问短网址服务的首页一般会跳转到一个固定的网址，比如渣浪微博会跳转到微博首页，Twitter则是给出“Twitter uses the t.co domain as part of a service to protect users from harmful activity”的提示。这里我们也让它跳转到一个指定的网页。\n\n最后，以8080端口运行，实际线上会使用80端口，可以自行修改。\n\n```go\nfunc main() {\n\tinitRedis()\n\tinitMysql()\n\n\tgin.SetMode(gin.DebugMode)\n\tr := gin.Default()\n\n\tr.GET(\"/\", func(c *gin.Context) {\n\t\t//http code can be StatusFound or StatusMovedPermanently \n\t\tc.Redirect(http.StatusFound, defaultDomain)\n\t})\n\tr.GET(\"/:hash\", expandUrl)\n\tr.GET(\"/:hash/info\", expandUrlApi)\n\tr.POST(\"/short\", shortUrl)\n\n\tr.Run(\":8000\")\n}\n```\n\n##### 连接redis和MySQL\n\n```go\nfunc initRedis() {\n\t// 建立连接池\n\tRedisClient = &redis.Pool{\n\t\tMaxIdle:     1,\n\t\tMaxActive:   10,\n\t\tIdleTimeout: 180 * time.Second,\n\t\tDial: func() (redis.Conn, error) {\n\t\t\tc, err := redis.Dial(\"tcp\", RedisHost)\n\t\t\tif err != nil {\n\t\t\t\treturn nil, err\n\t\t\t}\n\t\t\tif _, err := c.Do(\"AUTH\", RedisPwd); err != nil {\n\t\t\t\tc.Close()\n\t\t\t\treturn nil, err\n\t\t\t}\n\t\t\tc.Do(\"SELECT\", RedisDb)\n\t\t\treturn c, nil\n\t\t},\n\t}\n}\n\nfunc initMysql() {\n\tdsn := DB_USER + \":\" + DB_PASS + \"@\" + DB_HOST + \"/\" + DB_NAME + \"?charset=utf8\"\n\tdb, _ = sql.Open(\"mysql\", dsn)\n\tdb.SetMaxOpenConns(5)\n\tdb.SetMaxIdleConns(20)\n\tdb.Ping()\n}\n```\n\n##### 生成短网址的接口函数。\n\n根据传入的URL参数，进行简单的验证后，写入数据库。根据写入后生成的ID，再生成一个字符串，然后返回给调用方。\n\n```go\nfunc shortUrl(c *gin.Context) {\n\tlongUrl := c.PostForm(\"url\")\n\n\tif longUrl == \"\" {\n\t\tc.JSON(200, gin.H{\n\t\t\t\"status\":  500,\n\t\t\t\"message\": \"请传入网址\",\n\t\t})\n\t\treturn\n\t}\n\n\tif !strings.HasPrefix(longUrl, \"http\") {\n\t\tlongUrl = \"http://\" + longUrl\n\t}\n\n\tif hash, ok := insert(longUrl); ok {\n\t\tc.JSON(200, gin.H{\n\t\t\t\"status\":  200,\n\t\t\t\"message\": \"ok\",\n\t\t\t\"short\":   defaultDomain + hash,\n\t\t})\n\t}\n}\n```\n\n##### 根据HASH解析并跳转到对应的长URL，不存在则跳转到默认地址\n\n```go\nfunc expandUrl(c *gin.Context) {\n\thash := c.Param(\"hash\")\n\n\tif url, ok := findByHash(hash); ok {\n\t\tc.Redirect(http.StatusMovedPermanently, url)\n\t}\n\t// 注意:\n\t// \t实际中，此应用的运行域名可能与默认域名不同，如a.com运行此程序，默认域名为b.com\n\t// \t当访问一个不存在的HASH或a.com时，可以跳转到任意域名，即defaultDomain\n\tc.Redirect(http.StatusMovedPermanently, defaultDomain)\n}\n```\n\n##### 根据HASH在redis中查找并返回结果，不存在则返回404状态\n\n```go\nfunc expandUrlApi(c *gin.Context) {\n\thash := c.Param(\"hash\")\n\n\tif url, ok := findByHash(hash); ok {\n\t\tc.JSON(200, gin.H{\n\t\t\t\"status\":  200,\n\t\t\t\"message\": \"ok\",\n\t\t\t\"data\":    url,\n\t\t})\n\t\treturn\n\t}\n\n\t// 此处可以尝试在MySQL中再次查询\n\tc.JSON(200, gin.H{\n\t\t\"status\":  404,\n\t\t\"message\": \"url of hash is not exist\",\n\t})\n}\n```\n\n##### 将ID转换成对应的HASH值，hdSalt与hdMinLength 会影响生成结果，确定后不要改动\n\n```go\nfunc shortenURL(id int) string {\n\thd := hashids.NewData()\n\thd.Salt = hdSalt\n\thd.MinLength = hdMinLength\n\n\th := hashids.NewWithData(hd)\n\te, _ := h.Encode([]int{id})\n\n\treturn e\n}\n```\n\n##### 根据HASH解析出对应的ID值, hdSalt与hdMinLength 会影响生成结果，确定后不要改动\n\n```go\nfunc expand(hash string) int {\n\thd := hashids.NewData()\n\thd.Salt = hdSalt\n\thd.MinLength = hdMinLength\n\n\th := hashids.NewWithData(hd)\n\td, _ := h.DecodeWithError(hash)\n\n\treturn d[0]\n}\n```\n\n##### 数据库中根据ID查找\n\n```go\nfunc find(id int) (string, bool) {\n\tvar url string\n\terr := db.QueryRow(\"SELECT url FROM url WHERE id = ?\", id).Scan(&url)\n\tif err == nil {\n\t\treturn url, true\n\t} else {\n\t\treturn \"\", false\n\t}\n}\n```\n\n##### 在redis中根据HASH查找\n\n```go\nfunc findByHash(h string) (string, bool) {\n\trc := RedisClient.Get()\n\n\tdefer rc.Close()\n\turl, _ := redis.String(rc.Do(\"GET\", \"URL:\"+h))\n\n\tif url != \"\" {\n\t\treturn url, true\n\t}\n\n\tid := expand(h)\n\tif urldb, ok := find(id); ok {\n\t\treturn urldb, true\n\t}\n\n\treturn \"\", false\n}\n```\n\n##### 将长网址插入到数据库中，并把返回的ID生成HASH和长网址存入redis\n\n```go\nfunc insert(url string) (string, bool) {\n\tstmt, _ := db.Prepare(`INSERT INTO url (url) values (?)`)\n\tres, err := stmt.Exec(url)\n\tcheckErr(err)\n\n\tid, _ := res.LastInsertId()\n\n\trc := RedisClient.Get()\n\tdefer rc.Close()\n\n\thash := shortenURL(int(id))\n\trc.Do(\"SET\", \"URL:\"+hash, url)\n\n\treturn hash, true\n}\n```\n\n#### 打印方法，和检查错误的方法\n\n```go\nfunc Log(v ...interface{}) {\n\tfmt.Println(v...)\n}\n\nfunc checkErr(err error) {\n\tif err != nil {\n\t\tpanic(err)\n\t}\n}\n```\n\n有些地方还需修改，就算是抛砖引玉吧。\n\n感谢[hashids](http://hashids.org/)\n\n#### Github地址 ： [shortme](https://github.com/qichengzx/shortme)\n\n相关资料：\n\n[URL Toolbox: 90+ URL Shortening Services](http://mashable.com/2008/01/08/url-shortening-services/#CgEzOrfnzPqb)\n[TinyURL](http://tinyurl.com/)\n","slug":"shortlen-url-by-go","published":1,"updated":"2016-12-27T14:26:51.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj830jvex0037ul0r1io724r8","content":"<p><img src=\"/images/go/best-url-shortener-to-make-earn-money.png\" alt=\"\"></p>\n<center>题图来自<a href=\"http://www.dwtricks.com/2015/05/best-10-url-shortener-networks-to-earn-money-2015.html/\" target=\"_blank\" rel=\"external\">http://www.dwtricks.com/</a></center>\n\n<p>“缩址，又称短址、短网址、网址缩短、缩短网址、URL缩短等，指的是一种互联网上的技术与服务。此服务可以提供一个非常短小的URL以代替原来的可能较长的URL，将长的URL地址缩短。<br>用户访问缩短后的URL时，通常将会重定向到原来的URL。”</p>\n<p>– Wikipedia</p>\n<p>虽然短网址早已不再那么受广泛关注。但是不妨拿来练手。</p>\n<p>根据公开可以搜索到的资料，短网址一般是将一个ID转换到一串字母，生成短的网址用于传播，实际访问会重定向到原网址。如上所述。</p>\n<p>那么使用Go来写这个有什么优势呢，优势之一当然是，Go部署简单，只需要copy执行文件即可。执行速度也快，甚至连HTTP服务器都不需要。</p>\n<h5 id=\"下边就边写边说明。\"><a href=\"#下边就边写边说明。\" class=\"headerlink\" title=\"下边就边写边说明。\"></a>下边就边写边说明。</h5><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">package</span> main</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">import</span> (</div><div class=\"line\">\t<span class=\"string\">\"fmt\"</span></div><div class=\"line\">\t<span class=\"string\">\"strings\"</span></div><div class=\"line\">\t<span class=\"string\">\"time\"</span></div><div class=\"line\">\t<span class=\"string\">\"net/http\"</span></div><div class=\"line\">\t<span class=\"string\">\"database/sql\"</span></div><div class=\"line\"></div><div class=\"line\">\t<span class=\"string\">\"github.com/gin-gonic/gin\"</span></div><div class=\"line\"></div><div class=\"line\">\t<span class=\"string\">\"github.com/garyburd/redigo/redis\"</span></div><div class=\"line\">\t_ <span class=\"string\">\"github.com/go-sql-driver/mysql\"</span></div><div class=\"line\"></div><div class=\"line\">\t<span class=\"string\">\"github.com/speps/go-hashids\"</span></div><div class=\"line\">)</div></pre></td></tr></table></figure>\n<h6 id=\"定义hashid包需要的salt，即生成字符串的最短位数。\"><a href=\"#定义hashid包需要的salt，即生成字符串的最短位数。\" class=\"headerlink\" title=\"定义hashid包需要的salt，即生成字符串的最短位数。\"></a>定义hashid包需要的salt，即生成字符串的最短位数。</h6><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">const</span> (</div><div class=\"line\">\thdSalt        = <span class=\"string\">\"mysalt\"</span></div><div class=\"line\">\thdMinLength   = <span class=\"number\">5</span></div><div class=\"line\">\tdefaultDomain = <span class=\"string\">\"http://localhost:8000/\"</span></div><div class=\"line\">)</div></pre></td></tr></table></figure>\n<h6 id=\"定义redis和MySQL的配置信息\"><a href=\"#定义redis和MySQL的配置信息\" class=\"headerlink\" title=\"定义redis和MySQL的配置信息\"></a>定义redis和MySQL的配置信息</h6><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> (</div><div class=\"line\">\tRedisClient *redis.Pool</div><div class=\"line\">\tRedisHost   = <span class=\"string\">\"127.0.0.1:6379\"</span></div><div class=\"line\">\tRedisDb     = <span class=\"number\">0</span></div><div class=\"line\">\tRedisPwd    = <span class=\"string\">\"\"</span></div><div class=\"line\"></div><div class=\"line\">\tdb      *sql.DB</div><div class=\"line\">\tDB_HOST = <span class=\"string\">\"tcp(127.0.0.1:3306)\"</span></div><div class=\"line\">\tDB_NAME = <span class=\"string\">\"short\"</span></div><div class=\"line\">\tDB_USER = <span class=\"string\">\"root\"</span></div><div class=\"line\">\tDB_PASS = <span class=\"string\">\"\"</span></div><div class=\"line\">)</div></pre></td></tr></table></figure>\n<h5 id=\"main函数，首先连接redis和MySQL。定义如下路由：\"><a href=\"#main函数，首先连接redis和MySQL。定义如下路由：\" class=\"headerlink\" title=\"main函数，首先连接redis和MySQL。定义如下路由：\"></a>main函数，首先连接redis和MySQL。定义如下路由：</h5><ul>\n<li>访问首页</li>\n<li>访问hash</li>\n<li>访问短网址信息页</li>\n<li>生成短网址接口</li>\n</ul>\n<p>熟悉的朋友应该都知道，访问短网址服务的首页一般会跳转到一个固定的网址，比如渣浪微博会跳转到微博首页，Twitter则是给出“Twitter uses the t.co domain as part of a service to protect users from harmful activity”的提示。这里我们也让它跳转到一个指定的网页。</p>\n<p>最后，以8080端口运行，实际线上会使用80端口，可以自行修改。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</div><div class=\"line\">\tinitRedis()</div><div class=\"line\">\tinitMysql()</div><div class=\"line\"></div><div class=\"line\">\tgin.SetMode(gin.DebugMode)</div><div class=\"line\">\tr := gin.Default()</div><div class=\"line\"></div><div class=\"line\">\tr.GET(<span class=\"string\">\"/\"</span>, <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">(c *gin.Context)</span></span> &#123;</div><div class=\"line\">\t\t<span class=\"comment\">//http code can be StatusFound or StatusMovedPermanently </span></div><div class=\"line\">\t\tc.Redirect(http.StatusFound, defaultDomain)</div><div class=\"line\">\t&#125;)</div><div class=\"line\">\tr.GET(<span class=\"string\">\"/:hash\"</span>, expandUrl)</div><div class=\"line\">\tr.GET(<span class=\"string\">\"/:hash/info\"</span>, expandUrlApi)</div><div class=\"line\">\tr.POST(<span class=\"string\">\"/short\"</span>, shortUrl)</div><div class=\"line\"></div><div class=\"line\">\tr.Run(<span class=\"string\">\":8000\"</span>)</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h5 id=\"连接redis和MySQL\"><a href=\"#连接redis和MySQL\" class=\"headerlink\" title=\"连接redis和MySQL\"></a>连接redis和MySQL</h5><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">initRedis</span><span class=\"params\">()</span></span> &#123;</div><div class=\"line\">\t<span class=\"comment\">// 建立连接池</span></div><div class=\"line\">\tRedisClient = &amp;redis.Pool&#123;</div><div class=\"line\">\t\tMaxIdle:     <span class=\"number\">1</span>,</div><div class=\"line\">\t\tMaxActive:   <span class=\"number\">10</span>,</div><div class=\"line\">\t\tIdleTimeout: <span class=\"number\">180</span> * time.Second,</div><div class=\"line\">\t\tDial: <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span> <span class=\"params\">(redis.Conn, error)</span></span> &#123;</div><div class=\"line\">\t\t\tc, err := redis.Dial(<span class=\"string\">\"tcp\"</span>, RedisHost)</div><div class=\"line\">\t\t\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</div><div class=\"line\">\t\t\t\t<span class=\"keyword\">return</span> <span class=\"literal\">nil</span>, err</div><div class=\"line\">\t\t\t&#125;</div><div class=\"line\">\t\t\t<span class=\"keyword\">if</span> _, err := c.Do(<span class=\"string\">\"AUTH\"</span>, RedisPwd); err != <span class=\"literal\">nil</span> &#123;</div><div class=\"line\">\t\t\t\tc.Close()</div><div class=\"line\">\t\t\t\t<span class=\"keyword\">return</span> <span class=\"literal\">nil</span>, err</div><div class=\"line\">\t\t\t&#125;</div><div class=\"line\">\t\t\tc.Do(<span class=\"string\">\"SELECT\"</span>, RedisDb)</div><div class=\"line\">\t\t\t<span class=\"keyword\">return</span> c, <span class=\"literal\">nil</span></div><div class=\"line\">\t\t&#125;,</div><div class=\"line\">\t&#125;</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">initMysql</span><span class=\"params\">()</span></span> &#123;</div><div class=\"line\">\tdsn := DB_USER + <span class=\"string\">\":\"</span> + DB_PASS + <span class=\"string\">\"@\"</span> + DB_HOST + <span class=\"string\">\"/\"</span> + DB_NAME + <span class=\"string\">\"?charset=utf8\"</span></div><div class=\"line\">\tdb, _ = sql.Open(<span class=\"string\">\"mysql\"</span>, dsn)</div><div class=\"line\">\tdb.SetMaxOpenConns(<span class=\"number\">5</span>)</div><div class=\"line\">\tdb.SetMaxIdleConns(<span class=\"number\">20</span>)</div><div class=\"line\">\tdb.Ping()</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h5 id=\"生成短网址的接口函数。\"><a href=\"#生成短网址的接口函数。\" class=\"headerlink\" title=\"生成短网址的接口函数。\"></a>生成短网址的接口函数。</h5><p>根据传入的URL参数，进行简单的验证后，写入数据库。根据写入后生成的ID，再生成一个字符串，然后返回给调用方。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">shortUrl</span><span class=\"params\">(c *gin.Context)</span></span> &#123;</div><div class=\"line\">\tlongUrl := c.PostForm(<span class=\"string\">\"url\"</span>)</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"keyword\">if</span> longUrl == <span class=\"string\">\"\"</span> &#123;</div><div class=\"line\">\t\tc.JSON(<span class=\"number\">200</span>, gin.H&#123;</div><div class=\"line\">\t\t\t<span class=\"string\">\"status\"</span>:  <span class=\"number\">500</span>,</div><div class=\"line\">\t\t\t<span class=\"string\">\"message\"</span>: <span class=\"string\">\"请传入网址\"</span>,</div><div class=\"line\">\t\t&#125;)</div><div class=\"line\">\t\t<span class=\"keyword\">return</span></div><div class=\"line\">\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"keyword\">if</span> !strings.HasPrefix(longUrl, <span class=\"string\">\"http\"</span>) &#123;</div><div class=\"line\">\t\tlongUrl = <span class=\"string\">\"http://\"</span> + longUrl</div><div class=\"line\">\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"keyword\">if</span> hash, ok := insert(longUrl); ok &#123;</div><div class=\"line\">\t\tc.JSON(<span class=\"number\">200</span>, gin.H&#123;</div><div class=\"line\">\t\t\t<span class=\"string\">\"status\"</span>:  <span class=\"number\">200</span>,</div><div class=\"line\">\t\t\t<span class=\"string\">\"message\"</span>: <span class=\"string\">\"ok\"</span>,</div><div class=\"line\">\t\t\t<span class=\"string\">\"short\"</span>:   defaultDomain + hash,</div><div class=\"line\">\t\t&#125;)</div><div class=\"line\">\t&#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h5 id=\"根据HASH解析并跳转到对应的长URL，不存在则跳转到默认地址\"><a href=\"#根据HASH解析并跳转到对应的长URL，不存在则跳转到默认地址\" class=\"headerlink\" title=\"根据HASH解析并跳转到对应的长URL，不存在则跳转到默认地址\"></a>根据HASH解析并跳转到对应的长URL，不存在则跳转到默认地址</h5><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">expandUrl</span><span class=\"params\">(c *gin.Context)</span></span> &#123;</div><div class=\"line\">\thash := c.Param(<span class=\"string\">\"hash\"</span>)</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"keyword\">if</span> url, ok := findByHash(hash); ok &#123;</div><div class=\"line\">\t\tc.Redirect(http.StatusMovedPermanently, url)</div><div class=\"line\">\t&#125;</div><div class=\"line\">\t<span class=\"comment\">// 注意:</span></div><div class=\"line\">\t<span class=\"comment\">// \t实际中，此应用的运行域名可能与默认域名不同，如a.com运行此程序，默认域名为b.com</span></div><div class=\"line\">\t<span class=\"comment\">// \t当访问一个不存在的HASH或a.com时，可以跳转到任意域名，即defaultDomain</span></div><div class=\"line\">\tc.Redirect(http.StatusMovedPermanently, defaultDomain)</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h5 id=\"根据HASH在redis中查找并返回结果，不存在则返回404状态\"><a href=\"#根据HASH在redis中查找并返回结果，不存在则返回404状态\" class=\"headerlink\" title=\"根据HASH在redis中查找并返回结果，不存在则返回404状态\"></a>根据HASH在redis中查找并返回结果，不存在则返回404状态</h5><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">expandUrlApi</span><span class=\"params\">(c *gin.Context)</span></span> &#123;</div><div class=\"line\">\thash := c.Param(<span class=\"string\">\"hash\"</span>)</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"keyword\">if</span> url, ok := findByHash(hash); ok &#123;</div><div class=\"line\">\t\tc.JSON(<span class=\"number\">200</span>, gin.H&#123;</div><div class=\"line\">\t\t\t<span class=\"string\">\"status\"</span>:  <span class=\"number\">200</span>,</div><div class=\"line\">\t\t\t<span class=\"string\">\"message\"</span>: <span class=\"string\">\"ok\"</span>,</div><div class=\"line\">\t\t\t<span class=\"string\">\"data\"</span>:    url,</div><div class=\"line\">\t\t&#125;)</div><div class=\"line\">\t\t<span class=\"keyword\">return</span></div><div class=\"line\">\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"comment\">// 此处可以尝试在MySQL中再次查询</span></div><div class=\"line\">\tc.JSON(<span class=\"number\">200</span>, gin.H&#123;</div><div class=\"line\">\t\t<span class=\"string\">\"status\"</span>:  <span class=\"number\">404</span>,</div><div class=\"line\">\t\t<span class=\"string\">\"message\"</span>: <span class=\"string\">\"url of hash is not exist\"</span>,</div><div class=\"line\">\t&#125;)</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h5 id=\"将ID转换成对应的HASH值，hdSalt与hdMinLength-会影响生成结果，确定后不要改动\"><a href=\"#将ID转换成对应的HASH值，hdSalt与hdMinLength-会影响生成结果，确定后不要改动\" class=\"headerlink\" title=\"将ID转换成对应的HASH值，hdSalt与hdMinLength 会影响生成结果，确定后不要改动\"></a>将ID转换成对应的HASH值，hdSalt与hdMinLength 会影响生成结果，确定后不要改动</h5><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">shortenURL</span><span class=\"params\">(id <span class=\"keyword\">int</span>)</span> <span class=\"title\">string</span></span> &#123;</div><div class=\"line\">\thd := hashids.NewData()</div><div class=\"line\">\thd.Salt = hdSalt</div><div class=\"line\">\thd.MinLength = hdMinLength</div><div class=\"line\"></div><div class=\"line\">\th := hashids.NewWithData(hd)</div><div class=\"line\">\te, _ := h.Encode([]<span class=\"keyword\">int</span>&#123;id&#125;)</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"keyword\">return</span> e</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h5 id=\"根据HASH解析出对应的ID值-hdSalt与hdMinLength-会影响生成结果，确定后不要改动\"><a href=\"#根据HASH解析出对应的ID值-hdSalt与hdMinLength-会影响生成结果，确定后不要改动\" class=\"headerlink\" title=\"根据HASH解析出对应的ID值, hdSalt与hdMinLength 会影响生成结果，确定后不要改动\"></a>根据HASH解析出对应的ID值, hdSalt与hdMinLength 会影响生成结果，确定后不要改动</h5><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">expand</span><span class=\"params\">(hash <span class=\"keyword\">string</span>)</span> <span class=\"title\">int</span></span> &#123;</div><div class=\"line\">\thd := hashids.NewData()</div><div class=\"line\">\thd.Salt = hdSalt</div><div class=\"line\">\thd.MinLength = hdMinLength</div><div class=\"line\"></div><div class=\"line\">\th := hashids.NewWithData(hd)</div><div class=\"line\">\td, _ := h.DecodeWithError(hash)</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"keyword\">return</span> d[<span class=\"number\">0</span>]</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h5 id=\"数据库中根据ID查找\"><a href=\"#数据库中根据ID查找\" class=\"headerlink\" title=\"数据库中根据ID查找\"></a>数据库中根据ID查找</h5><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">find</span><span class=\"params\">(id <span class=\"keyword\">int</span>)</span> <span class=\"params\">(<span class=\"keyword\">string</span>, <span class=\"keyword\">bool</span>)</span></span> &#123;</div><div class=\"line\">\t<span class=\"keyword\">var</span> url <span class=\"keyword\">string</span></div><div class=\"line\">\terr := db.QueryRow(<span class=\"string\">\"SELECT url FROM url WHERE id = ?\"</span>, id).Scan(&amp;url)</div><div class=\"line\">\t<span class=\"keyword\">if</span> err == <span class=\"literal\">nil</span> &#123;</div><div class=\"line\">\t\t<span class=\"keyword\">return</span> url, <span class=\"literal\">true</span></div><div class=\"line\">\t&#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"string\">\"\"</span>, <span class=\"literal\">false</span></div><div class=\"line\">\t&#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h5 id=\"在redis中根据HASH查找\"><a href=\"#在redis中根据HASH查找\" class=\"headerlink\" title=\"在redis中根据HASH查找\"></a>在redis中根据HASH查找</h5><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">findByHash</span><span class=\"params\">(h <span class=\"keyword\">string</span>)</span> <span class=\"params\">(<span class=\"keyword\">string</span>, <span class=\"keyword\">bool</span>)</span></span> &#123;</div><div class=\"line\">\trc := RedisClient.Get()</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"keyword\">defer</span> rc.Close()</div><div class=\"line\">\turl, _ := redis.String(rc.Do(<span class=\"string\">\"GET\"</span>, <span class=\"string\">\"URL:\"</span>+h))</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"keyword\">if</span> url != <span class=\"string\">\"\"</span> &#123;</div><div class=\"line\">\t\t<span class=\"keyword\">return</span> url, <span class=\"literal\">true</span></div><div class=\"line\">\t&#125;</div><div class=\"line\"></div><div class=\"line\">\tid := expand(h)</div><div class=\"line\">\t<span class=\"keyword\">if</span> urldb, ok := find(id); ok &#123;</div><div class=\"line\">\t\t<span class=\"keyword\">return</span> urldb, <span class=\"literal\">true</span></div><div class=\"line\">\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"string\">\"\"</span>, <span class=\"literal\">false</span></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h5 id=\"将长网址插入到数据库中，并把返回的ID生成HASH和长网址存入redis\"><a href=\"#将长网址插入到数据库中，并把返回的ID生成HASH和长网址存入redis\" class=\"headerlink\" title=\"将长网址插入到数据库中，并把返回的ID生成HASH和长网址存入redis\"></a>将长网址插入到数据库中，并把返回的ID生成HASH和长网址存入redis</h5><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">insert</span><span class=\"params\">(url <span class=\"keyword\">string</span>)</span> <span class=\"params\">(<span class=\"keyword\">string</span>, <span class=\"keyword\">bool</span>)</span></span> &#123;</div><div class=\"line\">\tstmt, _ := db.Prepare(<span class=\"string\">`INSERT INTO url (url) values (?)`</span>)</div><div class=\"line\">\tres, err := stmt.Exec(url)</div><div class=\"line\">\tcheckErr(err)</div><div class=\"line\"></div><div class=\"line\">\tid, _ := res.LastInsertId()</div><div class=\"line\"></div><div class=\"line\">\trc := RedisClient.Get()</div><div class=\"line\">\t<span class=\"keyword\">defer</span> rc.Close()</div><div class=\"line\"></div><div class=\"line\">\thash := shortenURL(<span class=\"keyword\">int</span>(id))</div><div class=\"line\">\trc.Do(<span class=\"string\">\"SET\"</span>, <span class=\"string\">\"URL:\"</span>+hash, url)</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"keyword\">return</span> hash, <span class=\"literal\">true</span></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h4 id=\"打印方法，和检查错误的方法\"><a href=\"#打印方法，和检查错误的方法\" class=\"headerlink\" title=\"打印方法，和检查错误的方法\"></a>打印方法，和检查错误的方法</h4><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">Log</span><span class=\"params\">(v ...<span class=\"keyword\">interface</span>&#123;&#125;)</span></span> &#123;</div><div class=\"line\">\tfmt.Println(v...)</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">checkErr</span><span class=\"params\">(err error)</span></span> &#123;</div><div class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</div><div class=\"line\">\t\t<span class=\"built_in\">panic</span>(err)</div><div class=\"line\">\t&#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>有些地方还需修改，就算是抛砖引玉吧。</p>\n<p>感谢<a href=\"http://hashids.org/\" target=\"_blank\" rel=\"external\">hashids</a></p>\n<h4 id=\"Github地址-：-shortme\"><a href=\"#Github地址-：-shortme\" class=\"headerlink\" title=\"Github地址 ： shortme\"></a>Github地址 ： <a href=\"https://github.com/qichengzx/shortme\" target=\"_blank\" rel=\"external\">shortme</a></h4><p>相关资料：</p>\n<p><a href=\"http://mashable.com/2008/01/08/url-shortening-services/#CgEzOrfnzPqb\" target=\"_blank\" rel=\"external\">URL Toolbox: 90+ URL Shortening Services</a><br><a href=\"http://tinyurl.com/\" target=\"_blank\" rel=\"external\">TinyURL</a></p>\n","site":{"data":{}},"excerpt":"","more":"<p><img src=\"/images/go/best-url-shortener-to-make-earn-money.png\" alt=\"\"></p>\n<center>题图来自<a href=\"http://www.dwtricks.com/2015/05/best-10-url-shortener-networks-to-earn-money-2015.html/\" target=\"_blank\" rel=\"external\">http://www.dwtricks.com/</a></center>\n\n<p>“缩址，又称短址、短网址、网址缩短、缩短网址、URL缩短等，指的是一种互联网上的技术与服务。此服务可以提供一个非常短小的URL以代替原来的可能较长的URL，将长的URL地址缩短。<br>用户访问缩短后的URL时，通常将会重定向到原来的URL。”</p>\n<p>– Wikipedia</p>\n<p>虽然短网址早已不再那么受广泛关注。但是不妨拿来练手。</p>\n<p>根据公开可以搜索到的资料，短网址一般是将一个ID转换到一串字母，生成短的网址用于传播，实际访问会重定向到原网址。如上所述。</p>\n<p>那么使用Go来写这个有什么优势呢，优势之一当然是，Go部署简单，只需要copy执行文件即可。执行速度也快，甚至连HTTP服务器都不需要。</p>\n<h5 id=\"下边就边写边说明。\"><a href=\"#下边就边写边说明。\" class=\"headerlink\" title=\"下边就边写边说明。\"></a>下边就边写边说明。</h5><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">package</span> main</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">import</span> (</div><div class=\"line\">\t<span class=\"string\">\"fmt\"</span></div><div class=\"line\">\t<span class=\"string\">\"strings\"</span></div><div class=\"line\">\t<span class=\"string\">\"time\"</span></div><div class=\"line\">\t<span class=\"string\">\"net/http\"</span></div><div class=\"line\">\t<span class=\"string\">\"database/sql\"</span></div><div class=\"line\"></div><div class=\"line\">\t<span class=\"string\">\"github.com/gin-gonic/gin\"</span></div><div class=\"line\"></div><div class=\"line\">\t<span class=\"string\">\"github.com/garyburd/redigo/redis\"</span></div><div class=\"line\">\t_ <span class=\"string\">\"github.com/go-sql-driver/mysql\"</span></div><div class=\"line\"></div><div class=\"line\">\t<span class=\"string\">\"github.com/speps/go-hashids\"</span></div><div class=\"line\">)</div></pre></td></tr></table></figure>\n<h6 id=\"定义hashid包需要的salt，即生成字符串的最短位数。\"><a href=\"#定义hashid包需要的salt，即生成字符串的最短位数。\" class=\"headerlink\" title=\"定义hashid包需要的salt，即生成字符串的最短位数。\"></a>定义hashid包需要的salt，即生成字符串的最短位数。</h6><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">const</span> (</div><div class=\"line\">\thdSalt        = <span class=\"string\">\"mysalt\"</span></div><div class=\"line\">\thdMinLength   = <span class=\"number\">5</span></div><div class=\"line\">\tdefaultDomain = <span class=\"string\">\"http://localhost:8000/\"</span></div><div class=\"line\">)</div></pre></td></tr></table></figure>\n<h6 id=\"定义redis和MySQL的配置信息\"><a href=\"#定义redis和MySQL的配置信息\" class=\"headerlink\" title=\"定义redis和MySQL的配置信息\"></a>定义redis和MySQL的配置信息</h6><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> (</div><div class=\"line\">\tRedisClient *redis.Pool</div><div class=\"line\">\tRedisHost   = <span class=\"string\">\"127.0.0.1:6379\"</span></div><div class=\"line\">\tRedisDb     = <span class=\"number\">0</span></div><div class=\"line\">\tRedisPwd    = <span class=\"string\">\"\"</span></div><div class=\"line\"></div><div class=\"line\">\tdb      *sql.DB</div><div class=\"line\">\tDB_HOST = <span class=\"string\">\"tcp(127.0.0.1:3306)\"</span></div><div class=\"line\">\tDB_NAME = <span class=\"string\">\"short\"</span></div><div class=\"line\">\tDB_USER = <span class=\"string\">\"root\"</span></div><div class=\"line\">\tDB_PASS = <span class=\"string\">\"\"</span></div><div class=\"line\">)</div></pre></td></tr></table></figure>\n<h5 id=\"main函数，首先连接redis和MySQL。定义如下路由：\"><a href=\"#main函数，首先连接redis和MySQL。定义如下路由：\" class=\"headerlink\" title=\"main函数，首先连接redis和MySQL。定义如下路由：\"></a>main函数，首先连接redis和MySQL。定义如下路由：</h5><ul>\n<li>访问首页</li>\n<li>访问hash</li>\n<li>访问短网址信息页</li>\n<li>生成短网址接口</li>\n</ul>\n<p>熟悉的朋友应该都知道，访问短网址服务的首页一般会跳转到一个固定的网址，比如渣浪微博会跳转到微博首页，Twitter则是给出“Twitter uses the t.co domain as part of a service to protect users from harmful activity”的提示。这里我们也让它跳转到一个指定的网页。</p>\n<p>最后，以8080端口运行，实际线上会使用80端口，可以自行修改。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</div><div class=\"line\">\tinitRedis()</div><div class=\"line\">\tinitMysql()</div><div class=\"line\"></div><div class=\"line\">\tgin.SetMode(gin.DebugMode)</div><div class=\"line\">\tr := gin.Default()</div><div class=\"line\"></div><div class=\"line\">\tr.GET(<span class=\"string\">\"/\"</span>, <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">(c *gin.Context)</span></span> &#123;</div><div class=\"line\">\t\t<span class=\"comment\">//http code can be StatusFound or StatusMovedPermanently </span></div><div class=\"line\">\t\tc.Redirect(http.StatusFound, defaultDomain)</div><div class=\"line\">\t&#125;)</div><div class=\"line\">\tr.GET(<span class=\"string\">\"/:hash\"</span>, expandUrl)</div><div class=\"line\">\tr.GET(<span class=\"string\">\"/:hash/info\"</span>, expandUrlApi)</div><div class=\"line\">\tr.POST(<span class=\"string\">\"/short\"</span>, shortUrl)</div><div class=\"line\"></div><div class=\"line\">\tr.Run(<span class=\"string\">\":8000\"</span>)</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h5 id=\"连接redis和MySQL\"><a href=\"#连接redis和MySQL\" class=\"headerlink\" title=\"连接redis和MySQL\"></a>连接redis和MySQL</h5><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">initRedis</span><span class=\"params\">()</span></span> &#123;</div><div class=\"line\">\t<span class=\"comment\">// 建立连接池</span></div><div class=\"line\">\tRedisClient = &amp;redis.Pool&#123;</div><div class=\"line\">\t\tMaxIdle:     <span class=\"number\">1</span>,</div><div class=\"line\">\t\tMaxActive:   <span class=\"number\">10</span>,</div><div class=\"line\">\t\tIdleTimeout: <span class=\"number\">180</span> * time.Second,</div><div class=\"line\">\t\tDial: <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span> <span class=\"params\">(redis.Conn, error)</span></span> &#123;</div><div class=\"line\">\t\t\tc, err := redis.Dial(<span class=\"string\">\"tcp\"</span>, RedisHost)</div><div class=\"line\">\t\t\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</div><div class=\"line\">\t\t\t\t<span class=\"keyword\">return</span> <span class=\"literal\">nil</span>, err</div><div class=\"line\">\t\t\t&#125;</div><div class=\"line\">\t\t\t<span class=\"keyword\">if</span> _, err := c.Do(<span class=\"string\">\"AUTH\"</span>, RedisPwd); err != <span class=\"literal\">nil</span> &#123;</div><div class=\"line\">\t\t\t\tc.Close()</div><div class=\"line\">\t\t\t\t<span class=\"keyword\">return</span> <span class=\"literal\">nil</span>, err</div><div class=\"line\">\t\t\t&#125;</div><div class=\"line\">\t\t\tc.Do(<span class=\"string\">\"SELECT\"</span>, RedisDb)</div><div class=\"line\">\t\t\t<span class=\"keyword\">return</span> c, <span class=\"literal\">nil</span></div><div class=\"line\">\t\t&#125;,</div><div class=\"line\">\t&#125;</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">initMysql</span><span class=\"params\">()</span></span> &#123;</div><div class=\"line\">\tdsn := DB_USER + <span class=\"string\">\":\"</span> + DB_PASS + <span class=\"string\">\"@\"</span> + DB_HOST + <span class=\"string\">\"/\"</span> + DB_NAME + <span class=\"string\">\"?charset=utf8\"</span></div><div class=\"line\">\tdb, _ = sql.Open(<span class=\"string\">\"mysql\"</span>, dsn)</div><div class=\"line\">\tdb.SetMaxOpenConns(<span class=\"number\">5</span>)</div><div class=\"line\">\tdb.SetMaxIdleConns(<span class=\"number\">20</span>)</div><div class=\"line\">\tdb.Ping()</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h5 id=\"生成短网址的接口函数。\"><a href=\"#生成短网址的接口函数。\" class=\"headerlink\" title=\"生成短网址的接口函数。\"></a>生成短网址的接口函数。</h5><p>根据传入的URL参数，进行简单的验证后，写入数据库。根据写入后生成的ID，再生成一个字符串，然后返回给调用方。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">shortUrl</span><span class=\"params\">(c *gin.Context)</span></span> &#123;</div><div class=\"line\">\tlongUrl := c.PostForm(<span class=\"string\">\"url\"</span>)</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"keyword\">if</span> longUrl == <span class=\"string\">\"\"</span> &#123;</div><div class=\"line\">\t\tc.JSON(<span class=\"number\">200</span>, gin.H&#123;</div><div class=\"line\">\t\t\t<span class=\"string\">\"status\"</span>:  <span class=\"number\">500</span>,</div><div class=\"line\">\t\t\t<span class=\"string\">\"message\"</span>: <span class=\"string\">\"请传入网址\"</span>,</div><div class=\"line\">\t\t&#125;)</div><div class=\"line\">\t\t<span class=\"keyword\">return</span></div><div class=\"line\">\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"keyword\">if</span> !strings.HasPrefix(longUrl, <span class=\"string\">\"http\"</span>) &#123;</div><div class=\"line\">\t\tlongUrl = <span class=\"string\">\"http://\"</span> + longUrl</div><div class=\"line\">\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"keyword\">if</span> hash, ok := insert(longUrl); ok &#123;</div><div class=\"line\">\t\tc.JSON(<span class=\"number\">200</span>, gin.H&#123;</div><div class=\"line\">\t\t\t<span class=\"string\">\"status\"</span>:  <span class=\"number\">200</span>,</div><div class=\"line\">\t\t\t<span class=\"string\">\"message\"</span>: <span class=\"string\">\"ok\"</span>,</div><div class=\"line\">\t\t\t<span class=\"string\">\"short\"</span>:   defaultDomain + hash,</div><div class=\"line\">\t\t&#125;)</div><div class=\"line\">\t&#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h5 id=\"根据HASH解析并跳转到对应的长URL，不存在则跳转到默认地址\"><a href=\"#根据HASH解析并跳转到对应的长URL，不存在则跳转到默认地址\" class=\"headerlink\" title=\"根据HASH解析并跳转到对应的长URL，不存在则跳转到默认地址\"></a>根据HASH解析并跳转到对应的长URL，不存在则跳转到默认地址</h5><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">expandUrl</span><span class=\"params\">(c *gin.Context)</span></span> &#123;</div><div class=\"line\">\thash := c.Param(<span class=\"string\">\"hash\"</span>)</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"keyword\">if</span> url, ok := findByHash(hash); ok &#123;</div><div class=\"line\">\t\tc.Redirect(http.StatusMovedPermanently, url)</div><div class=\"line\">\t&#125;</div><div class=\"line\">\t<span class=\"comment\">// 注意:</span></div><div class=\"line\">\t<span class=\"comment\">// \t实际中，此应用的运行域名可能与默认域名不同，如a.com运行此程序，默认域名为b.com</span></div><div class=\"line\">\t<span class=\"comment\">// \t当访问一个不存在的HASH或a.com时，可以跳转到任意域名，即defaultDomain</span></div><div class=\"line\">\tc.Redirect(http.StatusMovedPermanently, defaultDomain)</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h5 id=\"根据HASH在redis中查找并返回结果，不存在则返回404状态\"><a href=\"#根据HASH在redis中查找并返回结果，不存在则返回404状态\" class=\"headerlink\" title=\"根据HASH在redis中查找并返回结果，不存在则返回404状态\"></a>根据HASH在redis中查找并返回结果，不存在则返回404状态</h5><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">expandUrlApi</span><span class=\"params\">(c *gin.Context)</span></span> &#123;</div><div class=\"line\">\thash := c.Param(<span class=\"string\">\"hash\"</span>)</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"keyword\">if</span> url, ok := findByHash(hash); ok &#123;</div><div class=\"line\">\t\tc.JSON(<span class=\"number\">200</span>, gin.H&#123;</div><div class=\"line\">\t\t\t<span class=\"string\">\"status\"</span>:  <span class=\"number\">200</span>,</div><div class=\"line\">\t\t\t<span class=\"string\">\"message\"</span>: <span class=\"string\">\"ok\"</span>,</div><div class=\"line\">\t\t\t<span class=\"string\">\"data\"</span>:    url,</div><div class=\"line\">\t\t&#125;)</div><div class=\"line\">\t\t<span class=\"keyword\">return</span></div><div class=\"line\">\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"comment\">// 此处可以尝试在MySQL中再次查询</span></div><div class=\"line\">\tc.JSON(<span class=\"number\">200</span>, gin.H&#123;</div><div class=\"line\">\t\t<span class=\"string\">\"status\"</span>:  <span class=\"number\">404</span>,</div><div class=\"line\">\t\t<span class=\"string\">\"message\"</span>: <span class=\"string\">\"url of hash is not exist\"</span>,</div><div class=\"line\">\t&#125;)</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h5 id=\"将ID转换成对应的HASH值，hdSalt与hdMinLength-会影响生成结果，确定后不要改动\"><a href=\"#将ID转换成对应的HASH值，hdSalt与hdMinLength-会影响生成结果，确定后不要改动\" class=\"headerlink\" title=\"将ID转换成对应的HASH值，hdSalt与hdMinLength 会影响生成结果，确定后不要改动\"></a>将ID转换成对应的HASH值，hdSalt与hdMinLength 会影响生成结果，确定后不要改动</h5><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">shortenURL</span><span class=\"params\">(id <span class=\"keyword\">int</span>)</span> <span class=\"title\">string</span></span> &#123;</div><div class=\"line\">\thd := hashids.NewData()</div><div class=\"line\">\thd.Salt = hdSalt</div><div class=\"line\">\thd.MinLength = hdMinLength</div><div class=\"line\"></div><div class=\"line\">\th := hashids.NewWithData(hd)</div><div class=\"line\">\te, _ := h.Encode([]<span class=\"keyword\">int</span>&#123;id&#125;)</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"keyword\">return</span> e</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h5 id=\"根据HASH解析出对应的ID值-hdSalt与hdMinLength-会影响生成结果，确定后不要改动\"><a href=\"#根据HASH解析出对应的ID值-hdSalt与hdMinLength-会影响生成结果，确定后不要改动\" class=\"headerlink\" title=\"根据HASH解析出对应的ID值, hdSalt与hdMinLength 会影响生成结果，确定后不要改动\"></a>根据HASH解析出对应的ID值, hdSalt与hdMinLength 会影响生成结果，确定后不要改动</h5><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">expand</span><span class=\"params\">(hash <span class=\"keyword\">string</span>)</span> <span class=\"title\">int</span></span> &#123;</div><div class=\"line\">\thd := hashids.NewData()</div><div class=\"line\">\thd.Salt = hdSalt</div><div class=\"line\">\thd.MinLength = hdMinLength</div><div class=\"line\"></div><div class=\"line\">\th := hashids.NewWithData(hd)</div><div class=\"line\">\td, _ := h.DecodeWithError(hash)</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"keyword\">return</span> d[<span class=\"number\">0</span>]</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h5 id=\"数据库中根据ID查找\"><a href=\"#数据库中根据ID查找\" class=\"headerlink\" title=\"数据库中根据ID查找\"></a>数据库中根据ID查找</h5><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">find</span><span class=\"params\">(id <span class=\"keyword\">int</span>)</span> <span class=\"params\">(<span class=\"keyword\">string</span>, <span class=\"keyword\">bool</span>)</span></span> &#123;</div><div class=\"line\">\t<span class=\"keyword\">var</span> url <span class=\"keyword\">string</span></div><div class=\"line\">\terr := db.QueryRow(<span class=\"string\">\"SELECT url FROM url WHERE id = ?\"</span>, id).Scan(&amp;url)</div><div class=\"line\">\t<span class=\"keyword\">if</span> err == <span class=\"literal\">nil</span> &#123;</div><div class=\"line\">\t\t<span class=\"keyword\">return</span> url, <span class=\"literal\">true</span></div><div class=\"line\">\t&#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"string\">\"\"</span>, <span class=\"literal\">false</span></div><div class=\"line\">\t&#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h5 id=\"在redis中根据HASH查找\"><a href=\"#在redis中根据HASH查找\" class=\"headerlink\" title=\"在redis中根据HASH查找\"></a>在redis中根据HASH查找</h5><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">findByHash</span><span class=\"params\">(h <span class=\"keyword\">string</span>)</span> <span class=\"params\">(<span class=\"keyword\">string</span>, <span class=\"keyword\">bool</span>)</span></span> &#123;</div><div class=\"line\">\trc := RedisClient.Get()</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"keyword\">defer</span> rc.Close()</div><div class=\"line\">\turl, _ := redis.String(rc.Do(<span class=\"string\">\"GET\"</span>, <span class=\"string\">\"URL:\"</span>+h))</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"keyword\">if</span> url != <span class=\"string\">\"\"</span> &#123;</div><div class=\"line\">\t\t<span class=\"keyword\">return</span> url, <span class=\"literal\">true</span></div><div class=\"line\">\t&#125;</div><div class=\"line\"></div><div class=\"line\">\tid := expand(h)</div><div class=\"line\">\t<span class=\"keyword\">if</span> urldb, ok := find(id); ok &#123;</div><div class=\"line\">\t\t<span class=\"keyword\">return</span> urldb, <span class=\"literal\">true</span></div><div class=\"line\">\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"string\">\"\"</span>, <span class=\"literal\">false</span></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h5 id=\"将长网址插入到数据库中，并把返回的ID生成HASH和长网址存入redis\"><a href=\"#将长网址插入到数据库中，并把返回的ID生成HASH和长网址存入redis\" class=\"headerlink\" title=\"将长网址插入到数据库中，并把返回的ID生成HASH和长网址存入redis\"></a>将长网址插入到数据库中，并把返回的ID生成HASH和长网址存入redis</h5><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">insert</span><span class=\"params\">(url <span class=\"keyword\">string</span>)</span> <span class=\"params\">(<span class=\"keyword\">string</span>, <span class=\"keyword\">bool</span>)</span></span> &#123;</div><div class=\"line\">\tstmt, _ := db.Prepare(<span class=\"string\">`INSERT INTO url (url) values (?)`</span>)</div><div class=\"line\">\tres, err := stmt.Exec(url)</div><div class=\"line\">\tcheckErr(err)</div><div class=\"line\"></div><div class=\"line\">\tid, _ := res.LastInsertId()</div><div class=\"line\"></div><div class=\"line\">\trc := RedisClient.Get()</div><div class=\"line\">\t<span class=\"keyword\">defer</span> rc.Close()</div><div class=\"line\"></div><div class=\"line\">\thash := shortenURL(<span class=\"keyword\">int</span>(id))</div><div class=\"line\">\trc.Do(<span class=\"string\">\"SET\"</span>, <span class=\"string\">\"URL:\"</span>+hash, url)</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"keyword\">return</span> hash, <span class=\"literal\">true</span></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h4 id=\"打印方法，和检查错误的方法\"><a href=\"#打印方法，和检查错误的方法\" class=\"headerlink\" title=\"打印方法，和检查错误的方法\"></a>打印方法，和检查错误的方法</h4><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">Log</span><span class=\"params\">(v ...<span class=\"keyword\">interface</span>&#123;&#125;)</span></span> &#123;</div><div class=\"line\">\tfmt.Println(v...)</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">checkErr</span><span class=\"params\">(err error)</span></span> &#123;</div><div class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</div><div class=\"line\">\t\t<span class=\"built_in\">panic</span>(err)</div><div class=\"line\">\t&#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>有些地方还需修改，就算是抛砖引玉吧。</p>\n<p>感谢<a href=\"http://hashids.org/\" target=\"_blank\" rel=\"external\">hashids</a></p>\n<h4 id=\"Github地址-：-shortme\"><a href=\"#Github地址-：-shortme\" class=\"headerlink\" title=\"Github地址 ： shortme\"></a>Github地址 ： <a href=\"https://github.com/qichengzx/shortme\" target=\"_blank\" rel=\"external\">shortme</a></h4><p>相关资料：</p>\n<p><a href=\"http://mashable.com/2008/01/08/url-shortening-services/#CgEzOrfnzPqb\" target=\"_blank\" rel=\"external\">URL Toolbox: 90+ URL Shortening Services</a><br><a href=\"http://tinyurl.com/\" target=\"_blank\" rel=\"external\">TinyURL</a></p>\n"},{"title":"为hexo加一个时钟小挂件","date":"2015-11-11T06:16:29.000Z","_content":"\n\n之前在 [HTML+CSS3再加一点点JS做的一个小时钟](http://segmentfault.com/a/1190000003055672) 看到的这个问题，觉得很好把代码存下来了，今天突发奇想把它放到hexo的新博客上。\n\n### STEP 0\n\n把HTML内容放到新建的模板里，我命名为time.ejs。\n\n\t\t<div class=\"widget-wrap\">\n\t\t<h3 class=\"widget-title\">Time</h3>\n\t\t<div class=\"widget time\">\n\t\t\t<style id=\"clock-animations\"></style>\n\t\t\t<div class=\"clock-wrapper\">\n\t\t\t\t<div class=\"clock-base\">\n\t\t\t\t\t\t<div class=\"clock-indicator\">\n\t\t\t\t\t\t\t<div></div>\n\t\t\t\t\t\t\t<div></div>\n\t\t\t\t\t\t\t<div></div>\n\t\t\t\t\t\t\t<div></div>\n\t\t\t\t\t\t\t<div></div>\n\t\t\t\t\t\t\t<div></div>\n\t\t\t\t\t\t\t<div></div>\n\t\t\t\t\t\t\t<div></div>\n\t\t\t\t\t\t\t<div></div>\n\t\t\t\t\t\t\t<div></div>\n\t\t\t\t\t\t\t<div></div>\n\t\t\t\t\t\t\t<div></div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class=\"clock-hour\"></div>\n\t\t\t\t\t\t<div class=\"clock-minute\"></div>\n\t\t\t\t\t\t<div class=\"clock-second\"></div>\n\t\t\t\t\t\t<div class=\"clock-center\"></div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t</div>\n\n原文中`<style id=\"clock-animations\"></style>`是放在head区域的，为了减小对全局的影响，我拿到这个挂件中了，实际上并没有影响。\n\n这里要注意挂件的代码结构要尽量与主题自带的结构一致。（仅仅是为了好看，和好整理）\n\n当然了，这个文件要放在`layout/_widget`下。\n\n### STEP 1\njs脚本\n\n由于脚本内容较少，我就直接放在了script.js中，文件位置再source/js。\n\n\tvar now = new Date();\n  \tvar second = now.getSeconds();\n  \tvar minute = now.getMinutes();\n  \tvar hour = now.getHours();\n  \tif (hour > 12) {\n      \thour = hour - 12;\n  \t}\n  \thourDeg   = hour * 30 + now.getMinutes() / 60 * 30;\n  \tminuteDeg = now.getMinutes() * 6;\n  \tsecondDeg = now.getSeconds() * 6;\n  \tstylesDeg = [\n      \t\"@keyframes rotate-hour{ from{transform:rotate(\" + hourDeg + \"deg);}to{transform:rotate(\" + (hourDeg + 360) + \"deg);}}\",\n      \t\"@keyframes rotate-minute{from{transform:rotate(\" + minuteDeg + \"deg);}to{transform:rotate(\" + (minuteDeg + 360) + \"deg);}}\",\n      \t\"@keyframes rotate-second{from{transform:rotate(\" + secondDeg + \"deg);}to{transform:rotate(\" + (secondDeg + 360) + \"deg);}}\",\n      \t\"@-moz-keyframes rotate-hour{ from{transform:rotate(\" + hourDeg + \"deg);}to{transform:rotate(\" + (hourDeg + 360) + \"deg);}}\",\n      \t\"@-moz-keyframes rotate-minute{from{transform:rotate(\" + minuteDeg + \"deg);}to{transform:rotate(\" + (minuteDeg + 360) + \"deg);}}\",\n      \t\"@-moz-keyframes rotate-second{from{transform:rotate(\" + secondDeg + \"deg);}to{transform:rotate(\" + (secondDeg + 360) + \"deg);}}\",\n      \t\"@-webkit-keyframes rotate-hour{from{transform:rotate(\" + hourDeg + \"deg);}to{transform:rotate(\" + (hourDeg + 360) + \"deg);}}\",\n      \t\"@-webkit-keyframes rotate-minute{from{transform:rotate(\" + minuteDeg + \"deg);}to{transform:rotate(\" + (minuteDeg + 360) + \"deg);}}\",\n      \t\"@-webkit-keyframes rotate-second{from{transform:rotate(\" + secondDeg + \"deg);}to{transform:rotate(\" + (secondDeg + 360) + \"deg);}}\"\n  \t].join(\"\");\n  \t$('#clock-animations').html(stylesDeg);\n  \n \n### STEP 2\nCSS样式\n\n新建文件time.styl，路径为`/source/css/_partial/time.styl`\n\n内容略多，主要是给多浏览器写前缀。\n\n\t.clock-wrapper {\n\t\tposition: relative;\n\t\theight: 250px;\n\t\twidth: 250px;\n\t\tbackground-image: linear-gradient(#f7f7f7,#e0e0e0);\n\t\tborder-radius: 50%;\n\t\tbox-shadow: 0 10px 15px rgba(0,0,0,.15),0 2px 2px rgba(0,0,0,.2);\n\t}\n\t.clock-base {\n\t\twidth: 250px;\n\t\theight: 250px;\n\t\tbackground-color: #eee;\n\t\tborder-radius: 50%;\n\t\tbox-shadow: 0 0 5px #eee;\n\t}\n\t.clock-indicator {\n\t\tz-index: 1;\n\t\tposition: absolute;\n\t\ttop: 15px;\n\t\tleft: 15px;\n\t\twidth: 230px;\n\t\theight: 230px;\n\t}\n\t.clock-indicator div {\n\t\tposition: absolute;\n\t\twidth: 2px;\n\t\theight: 4px;\n\t\tmargin: 113px 114px;\n\t\tbackground-color: #a4a4a4;\n\t}\n\t.clock-indicator div:nth-child(1) {\n\t\ttransform:rotate(30deg) translateY(-113px);\n\t\t-ms-transform:rotate(30deg) translateY(-113px);     /* IE 9 */\n\t\t-moz-transform:rotate(30deg) translateY(-113px);    /* Firefox */\n\t\t-webkit-transform:rotate(30deg) translateY(-113px); /* Safari 和 Chrome */\n\t\t-o-transform:rotate(30deg) translateY(-113px);  /* Opera */        }\n\t\t.clock-indicator div:nth-child(2) {\n\t\ttransform:rotate(60deg) translateY(-113px);\n\t\t-ms-transform:rotate(60deg) translateY(-113px);     /* IE 9 */\n\t\t-moz-transform:rotate(60deg) translateY(-113px);    /* Firefox */\n\t\t-webkit-transform:rotate(60deg) translateY(-113px); /* Safari 和 Chrome */\n\t\t-o-transform:rotate(60deg) translateY(-113px);  /* Opera */\n\t}\n\t.clock-indicator div:nth-child(3) {\n\t\ttransform:rotate(90deg) translateY(-113px);\n\t\t-ms-transform:rotate(90deg) translateY(-113px);     /* IE 9 */\n\t\t-moz-transform:rotate(90deg) translateY(-113px);    /* Firefox */\n\t\t-webkit-transform:rotate(90deg) translateY(-113px); /* Safari 和 Chrome */\n\t\t-o-transform:rotate(90deg) translateY(-113px);  /* Opera */\n\t\tbackground-color: #5a5a5a;\n\t}\n\t.clock-indicator div:nth-child(4) {\n\t\ttransform:rotate(120deg) translateY(-113px);\n\t\t-ms-transform:rotate(120deg) translateY(-113px);    /* IE 9 */\n\t\t-moz-transform:rotate(120deg) translateY(-113px);   /* Firefox */\n\t\t-webkit-transform:rotate(120deg) translateY(-113px); /* Safari 和 Chrome */\n\t\t-o-transform:rotate(120deg) translateY(-113px);     /* Opera */\n\t}\n\t.clock-indicator div:nth-child(5) {\n\t\ttransform:rotate(150deg) translateY(-113px);\n\t\t-ms-transform:rotate(150deg) translateY(-113px);    /* IE 9 */\n\t\t-moz-transform:rotate(150deg) translateY(-113px);   /* Firefox */\n\t\t-webkit-transform:rotate(150deg) translateY(-113px); /* Safari 和 Chrome */\n\t\t-o-transform:rotate(150deg) translateY(-113px);     /* Opera */\n\t}\n\t.clock-indicator div:nth-child(6) {\n\t\ttransform:rotate(180deg) translateY(-113px);\n\t\t-ms-transform:rotate(180deg) translateY(-113px);    /* IE 9 */\n\t\t-moz-transform:rotate(180deg) translateY(-113px);   /* Firefox */\n\t\t-webkit-transform:rotate(180deg) translateY(-113px); /* Safari 和 Chrome */\n\t\t-o-transform:rotate(180deg) translateY(-113px);     /* Opera */\n\t\tbackground-color: #5a5a5a;\n\t}\n\t.clock-indicator div:nth-child(7) {\n\t\ttransform:rotate(210deg) translateY(-113px);\n\t\t-ms-transform:rotate(210deg) translateY(-113px);    /* IE 9 */\n\t\t-moz-transform:rotate(210deg) translateY(-113px);   /* Firefox */\n\t\t-webkit-transform:rotate(210deg) translateY(-113px); /* Safari 和 Chrome */\n\t\t-o-transform:rotate(210deg) translateY(-113px);     /* Opera */\n\t}\n\t.clock-indicator div:nth-child(8) {\n\t\ttransform:rotate(240deg) translateY(-113px);\n\t\t-ms-transform:rotate(240deg) translateY(-113px);    /* IE 9 */\n\t\t-moz-transform:rotate(240deg) translateY(-113px);   /* Firefox */\n\t\t-webkit-transform:rotate(240deg) translateY(-113px); /* Safari 和 Chrome */\n\t\t-o-transform:rotate(240deg) translateY(-113px);     /* Opera */\n\t}\n\t.clock-indicator div:nth-child(9) {\n\t\ttransform:rotate(270deg) translateY(-113px);\n\t\t-ms-transform:rotate(270deg) translateY(-113px);    /* IE 9 */\n\t\t-moz-transform:rotate(270deg) translateY(-113px);   /* Firefox */\n\t\t-webkit-transform:rotate(270deg) translateY(-113px); /* Safari 和 Chrome */\n\t\t-o-transform:rotate(270deg) translateY(-113px);     /* Opera */\n\t\tbackground-color: #5a5a5a;\n\t}\n\t.clock-indicator div:nth-child(10) {\n\t\ttransform:rotate(300deg) translateY(-113px);\n\t\t-ms-transform:rotate(300deg) translateY(-113px);    /* IE 9 */\n\t\t-moz-transform:rotate(300deg) translateY(-113px);   /* Firefox */\n\t\t-webkit-transform:rotate(300deg) translateY(-113px); /* Safari 和 Chrome */\n\t\t-o-transform:rotate(300deg) translateY(-113px);     /* Opera */\n\t}\n\t.clock-indicator div:nth-child(11) {\n\t\ttransform:rotate(330deg) translateY(-113px);\n\t\t-ms-transform:rotate(330deg) translateY(-113px);    /* IE 9 */\n\t\t-moz-transform:rotate(330deg) translateY(-113px);   /* Firefox */\n\t\t-webkit-transform:rotate(330deg) translateY(-113px); /* Safari 和 Chrome */\n\t\t-o-transform:rotate(330deg) translateY(-113px);     /* Opera */\n\t}\n\t.clock-indicator div:nth-child(12) {\n\t\ttransform:rotate(360deg) translateY(-113px);\n\t\t-ms-transform:rotate(360deg) translateY(-113px);    /* IE 9 */\n\t\t-moz-transform:rotate(360deg) translateY(-113px);   /* Firefox */\n\t\t-webkit-transform:rotate(360deg) translateY(-113px); /* Safari 和 Chrome */\n\t\t-o-transform:rotate(360deg) translateY(-113px);     /* Opera */\n\t\tbackground-color: #5a5a5a;\n\t}\n\t.clock-hour {\n\t\tz-index: 2;\n\t\tposition: absolute;\n\t\tleft: 128px;\n\t\ttop: 80px;\n\t\twidth: 4px;\n\t\theight: 65px;\n\t\tborder-radius: 2px;\n\t\tbackground-color: #555;\n\t\tbox-shadow: 0 0 2px rgba(0,0,0,0.2); \n\t\ttransform-origin: 2px 50px;\n\t\t-moz-transform-origin: 2px 50px;\n\t\t-ms-transform-origin: 2px 50px;\n\t\t-o-transform-origin: 2px 50px;\n\t\t-webkit-transform-origin: 2px 50px;\n\t\ttransition: 1s;\n\t\t-moz-transition: 1s; /* Firefox 4 */\n\t\t-webkit-transition: 1s; /* Safari 和 Chrome */\n\t\t-o-transition: 1s; /* Opera */\n\t\tanimation:rotate-hour 43200s linear infinite;\n\t\t-webkit-animation: rotate-hour 43200s linear infinite; /* Safari 和 Chrome */\n\t}\n\t.clock-minute {\n\t\tz-index: 3;\n\t\tposition: absolute;\n\t\tleft: 128px;\n\t\ttop: 60px;\n\t\twidth: 4px;\n\t\theight: 85px;\n\t\tborder-radius: 2px;\n\t\tbackground-color: #555;\n\t\tbox-shadow: 0 0 2px rgba(0,0,0,0.2); \n\t\ttransition: 1s;\n\t\t-moz-transition: 1s; /* Firefox 4 */\n\t\t-webkit-transition: 1s; /* Safari 和 Chrome */\n\t\t-o-transition: 1s; /* Opera */\n\t\ttransform-origin: 2px 70px;\n\t\t-moz-transform-origin: 2px 70px;\n\t\t-ms-transform-origin: 2px 70px;\n\t\t-o-transform-origin: 2px 70px;\n\t\t-webkit-transform-origin: 2px 70px;\n\t\tanimation:rotate-minute 3600s linear infinite;\n\t\t-webkit-animation: rotate-minute 3600s linear infinite; /* Safari 和 Chrome */\n\t}\n\t.clock-second {\n\t\tz-index: 4;\n\t\tposition: absolute;\n\t\tleft: 129px;\n\t\ttop: 15px;\n\t\twidth: 2px;\n\t\theight: 140px;\n\t\tborder-radius: 2px;\n\t\tbackground-color: #a00;\n\t\tbox-shadow: 0 0 1px rgba(0,0,0,0.2); \n\t\ttransform-origin: 1px 115px;\n\t\t-moz-transform-origin: 1px 115px;\n\t\t-ms-transform-origin: 1px 115px;\n\t\t-o-transform-origin: 1px 115px;\n\t\t-webkit-transform-origin: 1px 115px;\n\t\ttransition: 1s;\n\t\t-moz-transition: 1s; /* Firefox 4 */\n\t\t-webkit-transition: 1s; /* Safari 和 Chrome */\n\t\t-o-transition: 1s; /* Opera */\n\t\tanimation:rotate-hour 60s linear infinite;\n\t\t -webkit-animation: rotate-second 60s linear infinite;  /* Safari 和 Chrome */\n\t}\n\t.clock-second:after {\n\t\tcontent: \"\";\n\t\tdisplay: block;\n\t\tposition: absolute;\n\t\twidth: 8px;\n\t\theight: 8px;\n\t\tborder-radius: 50%;\n\t\tleft: -3px;\n\t\ttop:110px;\n\t\tbackground-color: #a00;\n\t\tbox-shadow: 0 0 3px rgba(0,0,0,0.2);\n\t}\n\t.clock-center {\n\t\tz-index: 1;\n\t\tposition: absolute;\n\t\tleft: 55px;\n\t\ttop: 55px;\n\t\tbackground-image: linear-gradient(#e3e3e3,#f7f7f7); \n\t\tborder-radius: 50%;\n\t\twidth: 150px;\n\t\theight: 150px;\n\t\tbox-shadow: inset 0 -1px 0 #fafafa, inset 0 1px 0 #e3e3e3;\n\t}\n\t.clock-center:after{\n\t\tcontent: \"\";\n\t\tdisplay: block;\n\t\twidth: 20px;\n\t\theight: 20px;\n\t\tmargin: 65px;\n\t\tbackground-color: #ddd;\n\t\tborder-radius: 50%;\n\t}\n \n 之后，在sidebar.styl 末尾加入 `@import \"time\"`,这是styl的语法，表示引入一个文件，因为两个文件是同级，所以可以直接这么写，加`./`也可以。\n \n### STEP 3\n最后，在themes的config文件中注册这个挂件。\n\n在_config.yml中，找到`widgets`，在你想要加的位置中加入 `- time`，即模板文件名。\n比如我的widgets变成了这样：\n\n\twidgets:\n\t- clock\n\t- category\n\t- tag\n\t- tagcloud\n\t- archive\n\t- recent_posts\n\t\n### LAST \n至此，就全部完事，可以去`hexo generate`或`hexo server`了。","source":"_posts/time-widget-for-hexo.md","raw":"title: 为hexo加一个时钟小挂件\ndate: 2015-11-11 14:16:29\ntags:  [hexo,time,widget]\n---\n\n\n之前在 [HTML+CSS3再加一点点JS做的一个小时钟](http://segmentfault.com/a/1190000003055672) 看到的这个问题，觉得很好把代码存下来了，今天突发奇想把它放到hexo的新博客上。\n\n### STEP 0\n\n把HTML内容放到新建的模板里，我命名为time.ejs。\n\n\t\t<div class=\"widget-wrap\">\n\t\t<h3 class=\"widget-title\">Time</h3>\n\t\t<div class=\"widget time\">\n\t\t\t<style id=\"clock-animations\"></style>\n\t\t\t<div class=\"clock-wrapper\">\n\t\t\t\t<div class=\"clock-base\">\n\t\t\t\t\t\t<div class=\"clock-indicator\">\n\t\t\t\t\t\t\t<div></div>\n\t\t\t\t\t\t\t<div></div>\n\t\t\t\t\t\t\t<div></div>\n\t\t\t\t\t\t\t<div></div>\n\t\t\t\t\t\t\t<div></div>\n\t\t\t\t\t\t\t<div></div>\n\t\t\t\t\t\t\t<div></div>\n\t\t\t\t\t\t\t<div></div>\n\t\t\t\t\t\t\t<div></div>\n\t\t\t\t\t\t\t<div></div>\n\t\t\t\t\t\t\t<div></div>\n\t\t\t\t\t\t\t<div></div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class=\"clock-hour\"></div>\n\t\t\t\t\t\t<div class=\"clock-minute\"></div>\n\t\t\t\t\t\t<div class=\"clock-second\"></div>\n\t\t\t\t\t\t<div class=\"clock-center\"></div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t</div>\n\n原文中`<style id=\"clock-animations\"></style>`是放在head区域的，为了减小对全局的影响，我拿到这个挂件中了，实际上并没有影响。\n\n这里要注意挂件的代码结构要尽量与主题自带的结构一致。（仅仅是为了好看，和好整理）\n\n当然了，这个文件要放在`layout/_widget`下。\n\n### STEP 1\njs脚本\n\n由于脚本内容较少，我就直接放在了script.js中，文件位置再source/js。\n\n\tvar now = new Date();\n  \tvar second = now.getSeconds();\n  \tvar minute = now.getMinutes();\n  \tvar hour = now.getHours();\n  \tif (hour > 12) {\n      \thour = hour - 12;\n  \t}\n  \thourDeg   = hour * 30 + now.getMinutes() / 60 * 30;\n  \tminuteDeg = now.getMinutes() * 6;\n  \tsecondDeg = now.getSeconds() * 6;\n  \tstylesDeg = [\n      \t\"@keyframes rotate-hour{ from{transform:rotate(\" + hourDeg + \"deg);}to{transform:rotate(\" + (hourDeg + 360) + \"deg);}}\",\n      \t\"@keyframes rotate-minute{from{transform:rotate(\" + minuteDeg + \"deg);}to{transform:rotate(\" + (minuteDeg + 360) + \"deg);}}\",\n      \t\"@keyframes rotate-second{from{transform:rotate(\" + secondDeg + \"deg);}to{transform:rotate(\" + (secondDeg + 360) + \"deg);}}\",\n      \t\"@-moz-keyframes rotate-hour{ from{transform:rotate(\" + hourDeg + \"deg);}to{transform:rotate(\" + (hourDeg + 360) + \"deg);}}\",\n      \t\"@-moz-keyframes rotate-minute{from{transform:rotate(\" + minuteDeg + \"deg);}to{transform:rotate(\" + (minuteDeg + 360) + \"deg);}}\",\n      \t\"@-moz-keyframes rotate-second{from{transform:rotate(\" + secondDeg + \"deg);}to{transform:rotate(\" + (secondDeg + 360) + \"deg);}}\",\n      \t\"@-webkit-keyframes rotate-hour{from{transform:rotate(\" + hourDeg + \"deg);}to{transform:rotate(\" + (hourDeg + 360) + \"deg);}}\",\n      \t\"@-webkit-keyframes rotate-minute{from{transform:rotate(\" + minuteDeg + \"deg);}to{transform:rotate(\" + (minuteDeg + 360) + \"deg);}}\",\n      \t\"@-webkit-keyframes rotate-second{from{transform:rotate(\" + secondDeg + \"deg);}to{transform:rotate(\" + (secondDeg + 360) + \"deg);}}\"\n  \t].join(\"\");\n  \t$('#clock-animations').html(stylesDeg);\n  \n \n### STEP 2\nCSS样式\n\n新建文件time.styl，路径为`/source/css/_partial/time.styl`\n\n内容略多，主要是给多浏览器写前缀。\n\n\t.clock-wrapper {\n\t\tposition: relative;\n\t\theight: 250px;\n\t\twidth: 250px;\n\t\tbackground-image: linear-gradient(#f7f7f7,#e0e0e0);\n\t\tborder-radius: 50%;\n\t\tbox-shadow: 0 10px 15px rgba(0,0,0,.15),0 2px 2px rgba(0,0,0,.2);\n\t}\n\t.clock-base {\n\t\twidth: 250px;\n\t\theight: 250px;\n\t\tbackground-color: #eee;\n\t\tborder-radius: 50%;\n\t\tbox-shadow: 0 0 5px #eee;\n\t}\n\t.clock-indicator {\n\t\tz-index: 1;\n\t\tposition: absolute;\n\t\ttop: 15px;\n\t\tleft: 15px;\n\t\twidth: 230px;\n\t\theight: 230px;\n\t}\n\t.clock-indicator div {\n\t\tposition: absolute;\n\t\twidth: 2px;\n\t\theight: 4px;\n\t\tmargin: 113px 114px;\n\t\tbackground-color: #a4a4a4;\n\t}\n\t.clock-indicator div:nth-child(1) {\n\t\ttransform:rotate(30deg) translateY(-113px);\n\t\t-ms-transform:rotate(30deg) translateY(-113px);     /* IE 9 */\n\t\t-moz-transform:rotate(30deg) translateY(-113px);    /* Firefox */\n\t\t-webkit-transform:rotate(30deg) translateY(-113px); /* Safari 和 Chrome */\n\t\t-o-transform:rotate(30deg) translateY(-113px);  /* Opera */        }\n\t\t.clock-indicator div:nth-child(2) {\n\t\ttransform:rotate(60deg) translateY(-113px);\n\t\t-ms-transform:rotate(60deg) translateY(-113px);     /* IE 9 */\n\t\t-moz-transform:rotate(60deg) translateY(-113px);    /* Firefox */\n\t\t-webkit-transform:rotate(60deg) translateY(-113px); /* Safari 和 Chrome */\n\t\t-o-transform:rotate(60deg) translateY(-113px);  /* Opera */\n\t}\n\t.clock-indicator div:nth-child(3) {\n\t\ttransform:rotate(90deg) translateY(-113px);\n\t\t-ms-transform:rotate(90deg) translateY(-113px);     /* IE 9 */\n\t\t-moz-transform:rotate(90deg) translateY(-113px);    /* Firefox */\n\t\t-webkit-transform:rotate(90deg) translateY(-113px); /* Safari 和 Chrome */\n\t\t-o-transform:rotate(90deg) translateY(-113px);  /* Opera */\n\t\tbackground-color: #5a5a5a;\n\t}\n\t.clock-indicator div:nth-child(4) {\n\t\ttransform:rotate(120deg) translateY(-113px);\n\t\t-ms-transform:rotate(120deg) translateY(-113px);    /* IE 9 */\n\t\t-moz-transform:rotate(120deg) translateY(-113px);   /* Firefox */\n\t\t-webkit-transform:rotate(120deg) translateY(-113px); /* Safari 和 Chrome */\n\t\t-o-transform:rotate(120deg) translateY(-113px);     /* Opera */\n\t}\n\t.clock-indicator div:nth-child(5) {\n\t\ttransform:rotate(150deg) translateY(-113px);\n\t\t-ms-transform:rotate(150deg) translateY(-113px);    /* IE 9 */\n\t\t-moz-transform:rotate(150deg) translateY(-113px);   /* Firefox */\n\t\t-webkit-transform:rotate(150deg) translateY(-113px); /* Safari 和 Chrome */\n\t\t-o-transform:rotate(150deg) translateY(-113px);     /* Opera */\n\t}\n\t.clock-indicator div:nth-child(6) {\n\t\ttransform:rotate(180deg) translateY(-113px);\n\t\t-ms-transform:rotate(180deg) translateY(-113px);    /* IE 9 */\n\t\t-moz-transform:rotate(180deg) translateY(-113px);   /* Firefox */\n\t\t-webkit-transform:rotate(180deg) translateY(-113px); /* Safari 和 Chrome */\n\t\t-o-transform:rotate(180deg) translateY(-113px);     /* Opera */\n\t\tbackground-color: #5a5a5a;\n\t}\n\t.clock-indicator div:nth-child(7) {\n\t\ttransform:rotate(210deg) translateY(-113px);\n\t\t-ms-transform:rotate(210deg) translateY(-113px);    /* IE 9 */\n\t\t-moz-transform:rotate(210deg) translateY(-113px);   /* Firefox */\n\t\t-webkit-transform:rotate(210deg) translateY(-113px); /* Safari 和 Chrome */\n\t\t-o-transform:rotate(210deg) translateY(-113px);     /* Opera */\n\t}\n\t.clock-indicator div:nth-child(8) {\n\t\ttransform:rotate(240deg) translateY(-113px);\n\t\t-ms-transform:rotate(240deg) translateY(-113px);    /* IE 9 */\n\t\t-moz-transform:rotate(240deg) translateY(-113px);   /* Firefox */\n\t\t-webkit-transform:rotate(240deg) translateY(-113px); /* Safari 和 Chrome */\n\t\t-o-transform:rotate(240deg) translateY(-113px);     /* Opera */\n\t}\n\t.clock-indicator div:nth-child(9) {\n\t\ttransform:rotate(270deg) translateY(-113px);\n\t\t-ms-transform:rotate(270deg) translateY(-113px);    /* IE 9 */\n\t\t-moz-transform:rotate(270deg) translateY(-113px);   /* Firefox */\n\t\t-webkit-transform:rotate(270deg) translateY(-113px); /* Safari 和 Chrome */\n\t\t-o-transform:rotate(270deg) translateY(-113px);     /* Opera */\n\t\tbackground-color: #5a5a5a;\n\t}\n\t.clock-indicator div:nth-child(10) {\n\t\ttransform:rotate(300deg) translateY(-113px);\n\t\t-ms-transform:rotate(300deg) translateY(-113px);    /* IE 9 */\n\t\t-moz-transform:rotate(300deg) translateY(-113px);   /* Firefox */\n\t\t-webkit-transform:rotate(300deg) translateY(-113px); /* Safari 和 Chrome */\n\t\t-o-transform:rotate(300deg) translateY(-113px);     /* Opera */\n\t}\n\t.clock-indicator div:nth-child(11) {\n\t\ttransform:rotate(330deg) translateY(-113px);\n\t\t-ms-transform:rotate(330deg) translateY(-113px);    /* IE 9 */\n\t\t-moz-transform:rotate(330deg) translateY(-113px);   /* Firefox */\n\t\t-webkit-transform:rotate(330deg) translateY(-113px); /* Safari 和 Chrome */\n\t\t-o-transform:rotate(330deg) translateY(-113px);     /* Opera */\n\t}\n\t.clock-indicator div:nth-child(12) {\n\t\ttransform:rotate(360deg) translateY(-113px);\n\t\t-ms-transform:rotate(360deg) translateY(-113px);    /* IE 9 */\n\t\t-moz-transform:rotate(360deg) translateY(-113px);   /* Firefox */\n\t\t-webkit-transform:rotate(360deg) translateY(-113px); /* Safari 和 Chrome */\n\t\t-o-transform:rotate(360deg) translateY(-113px);     /* Opera */\n\t\tbackground-color: #5a5a5a;\n\t}\n\t.clock-hour {\n\t\tz-index: 2;\n\t\tposition: absolute;\n\t\tleft: 128px;\n\t\ttop: 80px;\n\t\twidth: 4px;\n\t\theight: 65px;\n\t\tborder-radius: 2px;\n\t\tbackground-color: #555;\n\t\tbox-shadow: 0 0 2px rgba(0,0,0,0.2); \n\t\ttransform-origin: 2px 50px;\n\t\t-moz-transform-origin: 2px 50px;\n\t\t-ms-transform-origin: 2px 50px;\n\t\t-o-transform-origin: 2px 50px;\n\t\t-webkit-transform-origin: 2px 50px;\n\t\ttransition: 1s;\n\t\t-moz-transition: 1s; /* Firefox 4 */\n\t\t-webkit-transition: 1s; /* Safari 和 Chrome */\n\t\t-o-transition: 1s; /* Opera */\n\t\tanimation:rotate-hour 43200s linear infinite;\n\t\t-webkit-animation: rotate-hour 43200s linear infinite; /* Safari 和 Chrome */\n\t}\n\t.clock-minute {\n\t\tz-index: 3;\n\t\tposition: absolute;\n\t\tleft: 128px;\n\t\ttop: 60px;\n\t\twidth: 4px;\n\t\theight: 85px;\n\t\tborder-radius: 2px;\n\t\tbackground-color: #555;\n\t\tbox-shadow: 0 0 2px rgba(0,0,0,0.2); \n\t\ttransition: 1s;\n\t\t-moz-transition: 1s; /* Firefox 4 */\n\t\t-webkit-transition: 1s; /* Safari 和 Chrome */\n\t\t-o-transition: 1s; /* Opera */\n\t\ttransform-origin: 2px 70px;\n\t\t-moz-transform-origin: 2px 70px;\n\t\t-ms-transform-origin: 2px 70px;\n\t\t-o-transform-origin: 2px 70px;\n\t\t-webkit-transform-origin: 2px 70px;\n\t\tanimation:rotate-minute 3600s linear infinite;\n\t\t-webkit-animation: rotate-minute 3600s linear infinite; /* Safari 和 Chrome */\n\t}\n\t.clock-second {\n\t\tz-index: 4;\n\t\tposition: absolute;\n\t\tleft: 129px;\n\t\ttop: 15px;\n\t\twidth: 2px;\n\t\theight: 140px;\n\t\tborder-radius: 2px;\n\t\tbackground-color: #a00;\n\t\tbox-shadow: 0 0 1px rgba(0,0,0,0.2); \n\t\ttransform-origin: 1px 115px;\n\t\t-moz-transform-origin: 1px 115px;\n\t\t-ms-transform-origin: 1px 115px;\n\t\t-o-transform-origin: 1px 115px;\n\t\t-webkit-transform-origin: 1px 115px;\n\t\ttransition: 1s;\n\t\t-moz-transition: 1s; /* Firefox 4 */\n\t\t-webkit-transition: 1s; /* Safari 和 Chrome */\n\t\t-o-transition: 1s; /* Opera */\n\t\tanimation:rotate-hour 60s linear infinite;\n\t\t -webkit-animation: rotate-second 60s linear infinite;  /* Safari 和 Chrome */\n\t}\n\t.clock-second:after {\n\t\tcontent: \"\";\n\t\tdisplay: block;\n\t\tposition: absolute;\n\t\twidth: 8px;\n\t\theight: 8px;\n\t\tborder-radius: 50%;\n\t\tleft: -3px;\n\t\ttop:110px;\n\t\tbackground-color: #a00;\n\t\tbox-shadow: 0 0 3px rgba(0,0,0,0.2);\n\t}\n\t.clock-center {\n\t\tz-index: 1;\n\t\tposition: absolute;\n\t\tleft: 55px;\n\t\ttop: 55px;\n\t\tbackground-image: linear-gradient(#e3e3e3,#f7f7f7); \n\t\tborder-radius: 50%;\n\t\twidth: 150px;\n\t\theight: 150px;\n\t\tbox-shadow: inset 0 -1px 0 #fafafa, inset 0 1px 0 #e3e3e3;\n\t}\n\t.clock-center:after{\n\t\tcontent: \"\";\n\t\tdisplay: block;\n\t\twidth: 20px;\n\t\theight: 20px;\n\t\tmargin: 65px;\n\t\tbackground-color: #ddd;\n\t\tborder-radius: 50%;\n\t}\n \n 之后，在sidebar.styl 末尾加入 `@import \"time\"`,这是styl的语法，表示引入一个文件，因为两个文件是同级，所以可以直接这么写，加`./`也可以。\n \n### STEP 3\n最后，在themes的config文件中注册这个挂件。\n\n在_config.yml中，找到`widgets`，在你想要加的位置中加入 `- time`，即模板文件名。\n比如我的widgets变成了这样：\n\n\twidgets:\n\t- clock\n\t- category\n\t- tag\n\t- tagcloud\n\t- archive\n\t- recent_posts\n\t\n### LAST \n至此，就全部完事，可以去`hexo generate`或`hexo server`了。","slug":"time-widget-for-hexo","published":1,"updated":"2015-11-11T09:28:05.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj830jvey003aul0rm731fme0","content":"<p>之前在 <a href=\"http://segmentfault.com/a/1190000003055672\" target=\"_blank\" rel=\"external\">HTML+CSS3再加一点点JS做的一个小时钟</a> 看到的这个问题，觉得很好把代码存下来了，今天突发奇想把它放到hexo的新博客上。</p>\n<h3 id=\"STEP-0\"><a href=\"#STEP-0\" class=\"headerlink\" title=\"STEP 0\"></a>STEP 0</h3><p>把HTML内容放到新建的模板里，我命名为time.ejs。</p>\n<pre><code>    &lt;div class=&quot;widget-wrap&quot;&gt;\n    &lt;h3 class=&quot;widget-title&quot;&gt;Time&lt;/h3&gt;\n    &lt;div class=&quot;widget time&quot;&gt;\n        &lt;style id=&quot;clock-animations&quot;&gt;&lt;/style&gt;\n        &lt;div class=&quot;clock-wrapper&quot;&gt;\n            &lt;div class=&quot;clock-base&quot;&gt;\n                    &lt;div class=&quot;clock-indicator&quot;&gt;\n                        &lt;div&gt;&lt;/div&gt;\n                        &lt;div&gt;&lt;/div&gt;\n                        &lt;div&gt;&lt;/div&gt;\n                        &lt;div&gt;&lt;/div&gt;\n                        &lt;div&gt;&lt;/div&gt;\n                        &lt;div&gt;&lt;/div&gt;\n                        &lt;div&gt;&lt;/div&gt;\n                        &lt;div&gt;&lt;/div&gt;\n                        &lt;div&gt;&lt;/div&gt;\n                        &lt;div&gt;&lt;/div&gt;\n                        &lt;div&gt;&lt;/div&gt;\n                        &lt;div&gt;&lt;/div&gt;\n                    &lt;/div&gt;\n                    &lt;div class=&quot;clock-hour&quot;&gt;&lt;/div&gt;\n                    &lt;div class=&quot;clock-minute&quot;&gt;&lt;/div&gt;\n                    &lt;div class=&quot;clock-second&quot;&gt;&lt;/div&gt;\n                    &lt;div class=&quot;clock-center&quot;&gt;&lt;/div&gt;\n            &lt;/div&gt;\n        &lt;/div&gt;\n    &lt;/div&gt;\n&lt;/div&gt;\n</code></pre><p>原文中<code>&lt;style id=&quot;clock-animations&quot;&gt;&lt;/style&gt;</code>是放在head区域的，为了减小对全局的影响，我拿到这个挂件中了，实际上并没有影响。</p>\n<p>这里要注意挂件的代码结构要尽量与主题自带的结构一致。（仅仅是为了好看，和好整理）</p>\n<p>当然了，这个文件要放在<code>layout/_widget</code>下。</p>\n<h3 id=\"STEP-1\"><a href=\"#STEP-1\" class=\"headerlink\" title=\"STEP 1\"></a>STEP 1</h3><p>js脚本</p>\n<p>由于脚本内容较少，我就直接放在了script.js中，文件位置再source/js。</p>\n<pre><code>var now = new Date();\n  var second = now.getSeconds();\n  var minute = now.getMinutes();\n  var hour = now.getHours();\n  if (hour &gt; 12) {\n      hour = hour - 12;\n  }\n  hourDeg   = hour * 30 + now.getMinutes() / 60 * 30;\n  minuteDeg = now.getMinutes() * 6;\n  secondDeg = now.getSeconds() * 6;\n  stylesDeg = [\n      &quot;@keyframes rotate-hour{ from{transform:rotate(&quot; + hourDeg + &quot;deg);}to{transform:rotate(&quot; + (hourDeg + 360) + &quot;deg);}}&quot;,\n      &quot;@keyframes rotate-minute{from{transform:rotate(&quot; + minuteDeg + &quot;deg);}to{transform:rotate(&quot; + (minuteDeg + 360) + &quot;deg);}}&quot;,\n      &quot;@keyframes rotate-second{from{transform:rotate(&quot; + secondDeg + &quot;deg);}to{transform:rotate(&quot; + (secondDeg + 360) + &quot;deg);}}&quot;,\n      &quot;@-moz-keyframes rotate-hour{ from{transform:rotate(&quot; + hourDeg + &quot;deg);}to{transform:rotate(&quot; + (hourDeg + 360) + &quot;deg);}}&quot;,\n      &quot;@-moz-keyframes rotate-minute{from{transform:rotate(&quot; + minuteDeg + &quot;deg);}to{transform:rotate(&quot; + (minuteDeg + 360) + &quot;deg);}}&quot;,\n      &quot;@-moz-keyframes rotate-second{from{transform:rotate(&quot; + secondDeg + &quot;deg);}to{transform:rotate(&quot; + (secondDeg + 360) + &quot;deg);}}&quot;,\n      &quot;@-webkit-keyframes rotate-hour{from{transform:rotate(&quot; + hourDeg + &quot;deg);}to{transform:rotate(&quot; + (hourDeg + 360) + &quot;deg);}}&quot;,\n      &quot;@-webkit-keyframes rotate-minute{from{transform:rotate(&quot; + minuteDeg + &quot;deg);}to{transform:rotate(&quot; + (minuteDeg + 360) + &quot;deg);}}&quot;,\n      &quot;@-webkit-keyframes rotate-second{from{transform:rotate(&quot; + secondDeg + &quot;deg);}to{transform:rotate(&quot; + (secondDeg + 360) + &quot;deg);}}&quot;\n  ].join(&quot;&quot;);\n  $(&apos;#clock-animations&apos;).html(stylesDeg);\n</code></pre><h3 id=\"STEP-2\"><a href=\"#STEP-2\" class=\"headerlink\" title=\"STEP 2\"></a>STEP 2</h3><p>CSS样式</p>\n<p>新建文件time.styl，路径为<code>/source/css/_partial/time.styl</code></p>\n<p>内容略多，主要是给多浏览器写前缀。</p>\n<pre><code>.clock-wrapper {\n    position: relative;\n    height: 250px;\n    width: 250px;\n    background-image: linear-gradient(#f7f7f7,#e0e0e0);\n    border-radius: 50%;\n    box-shadow: 0 10px 15px rgba(0,0,0,.15),0 2px 2px rgba(0,0,0,.2);\n}\n.clock-base {\n    width: 250px;\n    height: 250px;\n    background-color: #eee;\n    border-radius: 50%;\n    box-shadow: 0 0 5px #eee;\n}\n.clock-indicator {\n    z-index: 1;\n    position: absolute;\n    top: 15px;\n    left: 15px;\n    width: 230px;\n    height: 230px;\n}\n.clock-indicator div {\n    position: absolute;\n    width: 2px;\n    height: 4px;\n    margin: 113px 114px;\n    background-color: #a4a4a4;\n}\n.clock-indicator div:nth-child(1) {\n    transform:rotate(30deg) translateY(-113px);\n    -ms-transform:rotate(30deg) translateY(-113px);     /* IE 9 */\n    -moz-transform:rotate(30deg) translateY(-113px);    /* Firefox */\n    -webkit-transform:rotate(30deg) translateY(-113px); /* Safari 和 Chrome */\n    -o-transform:rotate(30deg) translateY(-113px);  /* Opera */        }\n    .clock-indicator div:nth-child(2) {\n    transform:rotate(60deg) translateY(-113px);\n    -ms-transform:rotate(60deg) translateY(-113px);     /* IE 9 */\n    -moz-transform:rotate(60deg) translateY(-113px);    /* Firefox */\n    -webkit-transform:rotate(60deg) translateY(-113px); /* Safari 和 Chrome */\n    -o-transform:rotate(60deg) translateY(-113px);  /* Opera */\n}\n.clock-indicator div:nth-child(3) {\n    transform:rotate(90deg) translateY(-113px);\n    -ms-transform:rotate(90deg) translateY(-113px);     /* IE 9 */\n    -moz-transform:rotate(90deg) translateY(-113px);    /* Firefox */\n    -webkit-transform:rotate(90deg) translateY(-113px); /* Safari 和 Chrome */\n    -o-transform:rotate(90deg) translateY(-113px);  /* Opera */\n    background-color: #5a5a5a;\n}\n.clock-indicator div:nth-child(4) {\n    transform:rotate(120deg) translateY(-113px);\n    -ms-transform:rotate(120deg) translateY(-113px);    /* IE 9 */\n    -moz-transform:rotate(120deg) translateY(-113px);   /* Firefox */\n    -webkit-transform:rotate(120deg) translateY(-113px); /* Safari 和 Chrome */\n    -o-transform:rotate(120deg) translateY(-113px);     /* Opera */\n}\n.clock-indicator div:nth-child(5) {\n    transform:rotate(150deg) translateY(-113px);\n    -ms-transform:rotate(150deg) translateY(-113px);    /* IE 9 */\n    -moz-transform:rotate(150deg) translateY(-113px);   /* Firefox */\n    -webkit-transform:rotate(150deg) translateY(-113px); /* Safari 和 Chrome */\n    -o-transform:rotate(150deg) translateY(-113px);     /* Opera */\n}\n.clock-indicator div:nth-child(6) {\n    transform:rotate(180deg) translateY(-113px);\n    -ms-transform:rotate(180deg) translateY(-113px);    /* IE 9 */\n    -moz-transform:rotate(180deg) translateY(-113px);   /* Firefox */\n    -webkit-transform:rotate(180deg) translateY(-113px); /* Safari 和 Chrome */\n    -o-transform:rotate(180deg) translateY(-113px);     /* Opera */\n    background-color: #5a5a5a;\n}\n.clock-indicator div:nth-child(7) {\n    transform:rotate(210deg) translateY(-113px);\n    -ms-transform:rotate(210deg) translateY(-113px);    /* IE 9 */\n    -moz-transform:rotate(210deg) translateY(-113px);   /* Firefox */\n    -webkit-transform:rotate(210deg) translateY(-113px); /* Safari 和 Chrome */\n    -o-transform:rotate(210deg) translateY(-113px);     /* Opera */\n}\n.clock-indicator div:nth-child(8) {\n    transform:rotate(240deg) translateY(-113px);\n    -ms-transform:rotate(240deg) translateY(-113px);    /* IE 9 */\n    -moz-transform:rotate(240deg) translateY(-113px);   /* Firefox */\n    -webkit-transform:rotate(240deg) translateY(-113px); /* Safari 和 Chrome */\n    -o-transform:rotate(240deg) translateY(-113px);     /* Opera */\n}\n.clock-indicator div:nth-child(9) {\n    transform:rotate(270deg) translateY(-113px);\n    -ms-transform:rotate(270deg) translateY(-113px);    /* IE 9 */\n    -moz-transform:rotate(270deg) translateY(-113px);   /* Firefox */\n    -webkit-transform:rotate(270deg) translateY(-113px); /* Safari 和 Chrome */\n    -o-transform:rotate(270deg) translateY(-113px);     /* Opera */\n    background-color: #5a5a5a;\n}\n.clock-indicator div:nth-child(10) {\n    transform:rotate(300deg) translateY(-113px);\n    -ms-transform:rotate(300deg) translateY(-113px);    /* IE 9 */\n    -moz-transform:rotate(300deg) translateY(-113px);   /* Firefox */\n    -webkit-transform:rotate(300deg) translateY(-113px); /* Safari 和 Chrome */\n    -o-transform:rotate(300deg) translateY(-113px);     /* Opera */\n}\n.clock-indicator div:nth-child(11) {\n    transform:rotate(330deg) translateY(-113px);\n    -ms-transform:rotate(330deg) translateY(-113px);    /* IE 9 */\n    -moz-transform:rotate(330deg) translateY(-113px);   /* Firefox */\n    -webkit-transform:rotate(330deg) translateY(-113px); /* Safari 和 Chrome */\n    -o-transform:rotate(330deg) translateY(-113px);     /* Opera */\n}\n.clock-indicator div:nth-child(12) {\n    transform:rotate(360deg) translateY(-113px);\n    -ms-transform:rotate(360deg) translateY(-113px);    /* IE 9 */\n    -moz-transform:rotate(360deg) translateY(-113px);   /* Firefox */\n    -webkit-transform:rotate(360deg) translateY(-113px); /* Safari 和 Chrome */\n    -o-transform:rotate(360deg) translateY(-113px);     /* Opera */\n    background-color: #5a5a5a;\n}\n.clock-hour {\n    z-index: 2;\n    position: absolute;\n    left: 128px;\n    top: 80px;\n    width: 4px;\n    height: 65px;\n    border-radius: 2px;\n    background-color: #555;\n    box-shadow: 0 0 2px rgba(0,0,0,0.2); \n    transform-origin: 2px 50px;\n    -moz-transform-origin: 2px 50px;\n    -ms-transform-origin: 2px 50px;\n    -o-transform-origin: 2px 50px;\n    -webkit-transform-origin: 2px 50px;\n    transition: 1s;\n    -moz-transition: 1s; /* Firefox 4 */\n    -webkit-transition: 1s; /* Safari 和 Chrome */\n    -o-transition: 1s; /* Opera */\n    animation:rotate-hour 43200s linear infinite;\n    -webkit-animation: rotate-hour 43200s linear infinite; /* Safari 和 Chrome */\n}\n.clock-minute {\n    z-index: 3;\n    position: absolute;\n    left: 128px;\n    top: 60px;\n    width: 4px;\n    height: 85px;\n    border-radius: 2px;\n    background-color: #555;\n    box-shadow: 0 0 2px rgba(0,0,0,0.2); \n    transition: 1s;\n    -moz-transition: 1s; /* Firefox 4 */\n    -webkit-transition: 1s; /* Safari 和 Chrome */\n    -o-transition: 1s; /* Opera */\n    transform-origin: 2px 70px;\n    -moz-transform-origin: 2px 70px;\n    -ms-transform-origin: 2px 70px;\n    -o-transform-origin: 2px 70px;\n    -webkit-transform-origin: 2px 70px;\n    animation:rotate-minute 3600s linear infinite;\n    -webkit-animation: rotate-minute 3600s linear infinite; /* Safari 和 Chrome */\n}\n.clock-second {\n    z-index: 4;\n    position: absolute;\n    left: 129px;\n    top: 15px;\n    width: 2px;\n    height: 140px;\n    border-radius: 2px;\n    background-color: #a00;\n    box-shadow: 0 0 1px rgba(0,0,0,0.2); \n    transform-origin: 1px 115px;\n    -moz-transform-origin: 1px 115px;\n    -ms-transform-origin: 1px 115px;\n    -o-transform-origin: 1px 115px;\n    -webkit-transform-origin: 1px 115px;\n    transition: 1s;\n    -moz-transition: 1s; /* Firefox 4 */\n    -webkit-transition: 1s; /* Safari 和 Chrome */\n    -o-transition: 1s; /* Opera */\n    animation:rotate-hour 60s linear infinite;\n     -webkit-animation: rotate-second 60s linear infinite;  /* Safari 和 Chrome */\n}\n.clock-second:after {\n    content: &quot;&quot;;\n    display: block;\n    position: absolute;\n    width: 8px;\n    height: 8px;\n    border-radius: 50%;\n    left: -3px;\n    top:110px;\n    background-color: #a00;\n    box-shadow: 0 0 3px rgba(0,0,0,0.2);\n}\n.clock-center {\n    z-index: 1;\n    position: absolute;\n    left: 55px;\n    top: 55px;\n    background-image: linear-gradient(#e3e3e3,#f7f7f7); \n    border-radius: 50%;\n    width: 150px;\n    height: 150px;\n    box-shadow: inset 0 -1px 0 #fafafa, inset 0 1px 0 #e3e3e3;\n}\n.clock-center:after{\n    content: &quot;&quot;;\n    display: block;\n    width: 20px;\n    height: 20px;\n    margin: 65px;\n    background-color: #ddd;\n    border-radius: 50%;\n}\n</code></pre><p> 之后，在sidebar.styl 末尾加入 <code>@import &quot;time&quot;</code>,这是styl的语法，表示引入一个文件，因为两个文件是同级，所以可以直接这么写，加<code>./</code>也可以。</p>\n<h3 id=\"STEP-3\"><a href=\"#STEP-3\" class=\"headerlink\" title=\"STEP 3\"></a>STEP 3</h3><p>最后，在themes的config文件中注册这个挂件。</p>\n<p>在_config.yml中，找到<code>widgets</code>，在你想要加的位置中加入 <code>- time</code>，即模板文件名。<br>比如我的widgets变成了这样：</p>\n<pre><code>widgets:\n- clock\n- category\n- tag\n- tagcloud\n- archive\n- recent_posts\n</code></pre><h3 id=\"LAST\"><a href=\"#LAST\" class=\"headerlink\" title=\"LAST\"></a>LAST</h3><p>至此，就全部完事，可以去<code>hexo generate</code>或<code>hexo server</code>了。</p>\n","site":{"data":{}},"excerpt":"","more":"<p>之前在 <a href=\"http://segmentfault.com/a/1190000003055672\" target=\"_blank\" rel=\"external\">HTML+CSS3再加一点点JS做的一个小时钟</a> 看到的这个问题，觉得很好把代码存下来了，今天突发奇想把它放到hexo的新博客上。</p>\n<h3 id=\"STEP-0\"><a href=\"#STEP-0\" class=\"headerlink\" title=\"STEP 0\"></a>STEP 0</h3><p>把HTML内容放到新建的模板里，我命名为time.ejs。</p>\n<pre><code>    &lt;div class=&quot;widget-wrap&quot;&gt;\n    &lt;h3 class=&quot;widget-title&quot;&gt;Time&lt;/h3&gt;\n    &lt;div class=&quot;widget time&quot;&gt;\n        &lt;style id=&quot;clock-animations&quot;&gt;&lt;/style&gt;\n        &lt;div class=&quot;clock-wrapper&quot;&gt;\n            &lt;div class=&quot;clock-base&quot;&gt;\n                    &lt;div class=&quot;clock-indicator&quot;&gt;\n                        &lt;div&gt;&lt;/div&gt;\n                        &lt;div&gt;&lt;/div&gt;\n                        &lt;div&gt;&lt;/div&gt;\n                        &lt;div&gt;&lt;/div&gt;\n                        &lt;div&gt;&lt;/div&gt;\n                        &lt;div&gt;&lt;/div&gt;\n                        &lt;div&gt;&lt;/div&gt;\n                        &lt;div&gt;&lt;/div&gt;\n                        &lt;div&gt;&lt;/div&gt;\n                        &lt;div&gt;&lt;/div&gt;\n                        &lt;div&gt;&lt;/div&gt;\n                        &lt;div&gt;&lt;/div&gt;\n                    &lt;/div&gt;\n                    &lt;div class=&quot;clock-hour&quot;&gt;&lt;/div&gt;\n                    &lt;div class=&quot;clock-minute&quot;&gt;&lt;/div&gt;\n                    &lt;div class=&quot;clock-second&quot;&gt;&lt;/div&gt;\n                    &lt;div class=&quot;clock-center&quot;&gt;&lt;/div&gt;\n            &lt;/div&gt;\n        &lt;/div&gt;\n    &lt;/div&gt;\n&lt;/div&gt;\n</code></pre><p>原文中<code>&lt;style id=&quot;clock-animations&quot;&gt;&lt;/style&gt;</code>是放在head区域的，为了减小对全局的影响，我拿到这个挂件中了，实际上并没有影响。</p>\n<p>这里要注意挂件的代码结构要尽量与主题自带的结构一致。（仅仅是为了好看，和好整理）</p>\n<p>当然了，这个文件要放在<code>layout/_widget</code>下。</p>\n<h3 id=\"STEP-1\"><a href=\"#STEP-1\" class=\"headerlink\" title=\"STEP 1\"></a>STEP 1</h3><p>js脚本</p>\n<p>由于脚本内容较少，我就直接放在了script.js中，文件位置再source/js。</p>\n<pre><code>var now = new Date();\n  var second = now.getSeconds();\n  var minute = now.getMinutes();\n  var hour = now.getHours();\n  if (hour &gt; 12) {\n      hour = hour - 12;\n  }\n  hourDeg   = hour * 30 + now.getMinutes() / 60 * 30;\n  minuteDeg = now.getMinutes() * 6;\n  secondDeg = now.getSeconds() * 6;\n  stylesDeg = [\n      &quot;@keyframes rotate-hour{ from{transform:rotate(&quot; + hourDeg + &quot;deg);}to{transform:rotate(&quot; + (hourDeg + 360) + &quot;deg);}}&quot;,\n      &quot;@keyframes rotate-minute{from{transform:rotate(&quot; + minuteDeg + &quot;deg);}to{transform:rotate(&quot; + (minuteDeg + 360) + &quot;deg);}}&quot;,\n      &quot;@keyframes rotate-second{from{transform:rotate(&quot; + secondDeg + &quot;deg);}to{transform:rotate(&quot; + (secondDeg + 360) + &quot;deg);}}&quot;,\n      &quot;@-moz-keyframes rotate-hour{ from{transform:rotate(&quot; + hourDeg + &quot;deg);}to{transform:rotate(&quot; + (hourDeg + 360) + &quot;deg);}}&quot;,\n      &quot;@-moz-keyframes rotate-minute{from{transform:rotate(&quot; + minuteDeg + &quot;deg);}to{transform:rotate(&quot; + (minuteDeg + 360) + &quot;deg);}}&quot;,\n      &quot;@-moz-keyframes rotate-second{from{transform:rotate(&quot; + secondDeg + &quot;deg);}to{transform:rotate(&quot; + (secondDeg + 360) + &quot;deg);}}&quot;,\n      &quot;@-webkit-keyframes rotate-hour{from{transform:rotate(&quot; + hourDeg + &quot;deg);}to{transform:rotate(&quot; + (hourDeg + 360) + &quot;deg);}}&quot;,\n      &quot;@-webkit-keyframes rotate-minute{from{transform:rotate(&quot; + minuteDeg + &quot;deg);}to{transform:rotate(&quot; + (minuteDeg + 360) + &quot;deg);}}&quot;,\n      &quot;@-webkit-keyframes rotate-second{from{transform:rotate(&quot; + secondDeg + &quot;deg);}to{transform:rotate(&quot; + (secondDeg + 360) + &quot;deg);}}&quot;\n  ].join(&quot;&quot;);\n  $(&apos;#clock-animations&apos;).html(stylesDeg);\n</code></pre><h3 id=\"STEP-2\"><a href=\"#STEP-2\" class=\"headerlink\" title=\"STEP 2\"></a>STEP 2</h3><p>CSS样式</p>\n<p>新建文件time.styl，路径为<code>/source/css/_partial/time.styl</code></p>\n<p>内容略多，主要是给多浏览器写前缀。</p>\n<pre><code>.clock-wrapper {\n    position: relative;\n    height: 250px;\n    width: 250px;\n    background-image: linear-gradient(#f7f7f7,#e0e0e0);\n    border-radius: 50%;\n    box-shadow: 0 10px 15px rgba(0,0,0,.15),0 2px 2px rgba(0,0,0,.2);\n}\n.clock-base {\n    width: 250px;\n    height: 250px;\n    background-color: #eee;\n    border-radius: 50%;\n    box-shadow: 0 0 5px #eee;\n}\n.clock-indicator {\n    z-index: 1;\n    position: absolute;\n    top: 15px;\n    left: 15px;\n    width: 230px;\n    height: 230px;\n}\n.clock-indicator div {\n    position: absolute;\n    width: 2px;\n    height: 4px;\n    margin: 113px 114px;\n    background-color: #a4a4a4;\n}\n.clock-indicator div:nth-child(1) {\n    transform:rotate(30deg) translateY(-113px);\n    -ms-transform:rotate(30deg) translateY(-113px);     /* IE 9 */\n    -moz-transform:rotate(30deg) translateY(-113px);    /* Firefox */\n    -webkit-transform:rotate(30deg) translateY(-113px); /* Safari 和 Chrome */\n    -o-transform:rotate(30deg) translateY(-113px);  /* Opera */        }\n    .clock-indicator div:nth-child(2) {\n    transform:rotate(60deg) translateY(-113px);\n    -ms-transform:rotate(60deg) translateY(-113px);     /* IE 9 */\n    -moz-transform:rotate(60deg) translateY(-113px);    /* Firefox */\n    -webkit-transform:rotate(60deg) translateY(-113px); /* Safari 和 Chrome */\n    -o-transform:rotate(60deg) translateY(-113px);  /* Opera */\n}\n.clock-indicator div:nth-child(3) {\n    transform:rotate(90deg) translateY(-113px);\n    -ms-transform:rotate(90deg) translateY(-113px);     /* IE 9 */\n    -moz-transform:rotate(90deg) translateY(-113px);    /* Firefox */\n    -webkit-transform:rotate(90deg) translateY(-113px); /* Safari 和 Chrome */\n    -o-transform:rotate(90deg) translateY(-113px);  /* Opera */\n    background-color: #5a5a5a;\n}\n.clock-indicator div:nth-child(4) {\n    transform:rotate(120deg) translateY(-113px);\n    -ms-transform:rotate(120deg) translateY(-113px);    /* IE 9 */\n    -moz-transform:rotate(120deg) translateY(-113px);   /* Firefox */\n    -webkit-transform:rotate(120deg) translateY(-113px); /* Safari 和 Chrome */\n    -o-transform:rotate(120deg) translateY(-113px);     /* Opera */\n}\n.clock-indicator div:nth-child(5) {\n    transform:rotate(150deg) translateY(-113px);\n    -ms-transform:rotate(150deg) translateY(-113px);    /* IE 9 */\n    -moz-transform:rotate(150deg) translateY(-113px);   /* Firefox */\n    -webkit-transform:rotate(150deg) translateY(-113px); /* Safari 和 Chrome */\n    -o-transform:rotate(150deg) translateY(-113px);     /* Opera */\n}\n.clock-indicator div:nth-child(6) {\n    transform:rotate(180deg) translateY(-113px);\n    -ms-transform:rotate(180deg) translateY(-113px);    /* IE 9 */\n    -moz-transform:rotate(180deg) translateY(-113px);   /* Firefox */\n    -webkit-transform:rotate(180deg) translateY(-113px); /* Safari 和 Chrome */\n    -o-transform:rotate(180deg) translateY(-113px);     /* Opera */\n    background-color: #5a5a5a;\n}\n.clock-indicator div:nth-child(7) {\n    transform:rotate(210deg) translateY(-113px);\n    -ms-transform:rotate(210deg) translateY(-113px);    /* IE 9 */\n    -moz-transform:rotate(210deg) translateY(-113px);   /* Firefox */\n    -webkit-transform:rotate(210deg) translateY(-113px); /* Safari 和 Chrome */\n    -o-transform:rotate(210deg) translateY(-113px);     /* Opera */\n}\n.clock-indicator div:nth-child(8) {\n    transform:rotate(240deg) translateY(-113px);\n    -ms-transform:rotate(240deg) translateY(-113px);    /* IE 9 */\n    -moz-transform:rotate(240deg) translateY(-113px);   /* Firefox */\n    -webkit-transform:rotate(240deg) translateY(-113px); /* Safari 和 Chrome */\n    -o-transform:rotate(240deg) translateY(-113px);     /* Opera */\n}\n.clock-indicator div:nth-child(9) {\n    transform:rotate(270deg) translateY(-113px);\n    -ms-transform:rotate(270deg) translateY(-113px);    /* IE 9 */\n    -moz-transform:rotate(270deg) translateY(-113px);   /* Firefox */\n    -webkit-transform:rotate(270deg) translateY(-113px); /* Safari 和 Chrome */\n    -o-transform:rotate(270deg) translateY(-113px);     /* Opera */\n    background-color: #5a5a5a;\n}\n.clock-indicator div:nth-child(10) {\n    transform:rotate(300deg) translateY(-113px);\n    -ms-transform:rotate(300deg) translateY(-113px);    /* IE 9 */\n    -moz-transform:rotate(300deg) translateY(-113px);   /* Firefox */\n    -webkit-transform:rotate(300deg) translateY(-113px); /* Safari 和 Chrome */\n    -o-transform:rotate(300deg) translateY(-113px);     /* Opera */\n}\n.clock-indicator div:nth-child(11) {\n    transform:rotate(330deg) translateY(-113px);\n    -ms-transform:rotate(330deg) translateY(-113px);    /* IE 9 */\n    -moz-transform:rotate(330deg) translateY(-113px);   /* Firefox */\n    -webkit-transform:rotate(330deg) translateY(-113px); /* Safari 和 Chrome */\n    -o-transform:rotate(330deg) translateY(-113px);     /* Opera */\n}\n.clock-indicator div:nth-child(12) {\n    transform:rotate(360deg) translateY(-113px);\n    -ms-transform:rotate(360deg) translateY(-113px);    /* IE 9 */\n    -moz-transform:rotate(360deg) translateY(-113px);   /* Firefox */\n    -webkit-transform:rotate(360deg) translateY(-113px); /* Safari 和 Chrome */\n    -o-transform:rotate(360deg) translateY(-113px);     /* Opera */\n    background-color: #5a5a5a;\n}\n.clock-hour {\n    z-index: 2;\n    position: absolute;\n    left: 128px;\n    top: 80px;\n    width: 4px;\n    height: 65px;\n    border-radius: 2px;\n    background-color: #555;\n    box-shadow: 0 0 2px rgba(0,0,0,0.2); \n    transform-origin: 2px 50px;\n    -moz-transform-origin: 2px 50px;\n    -ms-transform-origin: 2px 50px;\n    -o-transform-origin: 2px 50px;\n    -webkit-transform-origin: 2px 50px;\n    transition: 1s;\n    -moz-transition: 1s; /* Firefox 4 */\n    -webkit-transition: 1s; /* Safari 和 Chrome */\n    -o-transition: 1s; /* Opera */\n    animation:rotate-hour 43200s linear infinite;\n    -webkit-animation: rotate-hour 43200s linear infinite; /* Safari 和 Chrome */\n}\n.clock-minute {\n    z-index: 3;\n    position: absolute;\n    left: 128px;\n    top: 60px;\n    width: 4px;\n    height: 85px;\n    border-radius: 2px;\n    background-color: #555;\n    box-shadow: 0 0 2px rgba(0,0,0,0.2); \n    transition: 1s;\n    -moz-transition: 1s; /* Firefox 4 */\n    -webkit-transition: 1s; /* Safari 和 Chrome */\n    -o-transition: 1s; /* Opera */\n    transform-origin: 2px 70px;\n    -moz-transform-origin: 2px 70px;\n    -ms-transform-origin: 2px 70px;\n    -o-transform-origin: 2px 70px;\n    -webkit-transform-origin: 2px 70px;\n    animation:rotate-minute 3600s linear infinite;\n    -webkit-animation: rotate-minute 3600s linear infinite; /* Safari 和 Chrome */\n}\n.clock-second {\n    z-index: 4;\n    position: absolute;\n    left: 129px;\n    top: 15px;\n    width: 2px;\n    height: 140px;\n    border-radius: 2px;\n    background-color: #a00;\n    box-shadow: 0 0 1px rgba(0,0,0,0.2); \n    transform-origin: 1px 115px;\n    -moz-transform-origin: 1px 115px;\n    -ms-transform-origin: 1px 115px;\n    -o-transform-origin: 1px 115px;\n    -webkit-transform-origin: 1px 115px;\n    transition: 1s;\n    -moz-transition: 1s; /* Firefox 4 */\n    -webkit-transition: 1s; /* Safari 和 Chrome */\n    -o-transition: 1s; /* Opera */\n    animation:rotate-hour 60s linear infinite;\n     -webkit-animation: rotate-second 60s linear infinite;  /* Safari 和 Chrome */\n}\n.clock-second:after {\n    content: &quot;&quot;;\n    display: block;\n    position: absolute;\n    width: 8px;\n    height: 8px;\n    border-radius: 50%;\n    left: -3px;\n    top:110px;\n    background-color: #a00;\n    box-shadow: 0 0 3px rgba(0,0,0,0.2);\n}\n.clock-center {\n    z-index: 1;\n    position: absolute;\n    left: 55px;\n    top: 55px;\n    background-image: linear-gradient(#e3e3e3,#f7f7f7); \n    border-radius: 50%;\n    width: 150px;\n    height: 150px;\n    box-shadow: inset 0 -1px 0 #fafafa, inset 0 1px 0 #e3e3e3;\n}\n.clock-center:after{\n    content: &quot;&quot;;\n    display: block;\n    width: 20px;\n    height: 20px;\n    margin: 65px;\n    background-color: #ddd;\n    border-radius: 50%;\n}\n</code></pre><p> 之后，在sidebar.styl 末尾加入 <code>@import &quot;time&quot;</code>,这是styl的语法，表示引入一个文件，因为两个文件是同级，所以可以直接这么写，加<code>./</code>也可以。</p>\n<h3 id=\"STEP-3\"><a href=\"#STEP-3\" class=\"headerlink\" title=\"STEP 3\"></a>STEP 3</h3><p>最后，在themes的config文件中注册这个挂件。</p>\n<p>在_config.yml中，找到<code>widgets</code>，在你想要加的位置中加入 <code>- time</code>，即模板文件名。<br>比如我的widgets变成了这样：</p>\n<pre><code>widgets:\n- clock\n- category\n- tag\n- tagcloud\n- archive\n- recent_posts\n</code></pre><h3 id=\"LAST\"><a href=\"#LAST\" class=\"headerlink\" title=\"LAST\"></a>LAST</h3><p>至此，就全部完事，可以去<code>hexo generate</code>或<code>hexo server</code>了。</p>\n"},{"title":"Go 福利小爬虫 爬取今日头条美女图","date":"2016-12-14T08:28:36.000Z","_content":"\n![](/images/go/toutiao.gif)\n\n写完爬取糗百热门后没几天，又开始写了爬取今日头条图片的[工具](https://github.com/qichengzx/toutiaoSpider)。\n\n灵感来源于[Python 福利小爬虫，爬取今日头条街拍美女图](http://www.jianshu.com/p/d67b1d4b99ad)，作者很详细的分析了今日头条一个搜索接口，并列出了步骤。\n\n而我用Go写的，稍稍做了改动，加入了可以自定义爬取标签的功能，并在写本文前完成了以 \"标签/文章名/图片名\" 结构存储图片的功能。\n\n分析网页依然使用[goquery](https://github.com/PuerkitoBio/goquery)。\n\n### 分析接口返回结构\n\n```json\n{\n\t\"count\": 30,\n\t\"action_label\": \"click_search\",\n\t\"return_count\": 0,\n\t\"has_more\": 0,\n\t\"page_id\": \"/search/\",\n\t\"cur_tab\": 1,\n\t\"offset\": 150,\n\t\"action_label_web\": \"click_search\",\n\t\"show_tabs\": 1,\n\t\"data\": [\n\t\t{\n\t\t\t\"play_effective_count\": \"6412\",\n\t\t\t\"media_name\": \"开物志\",\n\t\t\t\"repin_count\": 49,\n\t\t\t\"ban_comment\": 0,\n\t\t\t\"show_play_effective_count\": 1,\n\t\t\t\"abstract\": \"\",\n\t\t\t\"display_title\": \"\",\n\t\t\t\"datetime\": \"2016-12-13 21:35\",\n\t\t\t\"article_type\": 0,\n\t\t\t\"more_mode\": false,\n\t\t\t\"create_time\": 1481636117,\n\t\t\t\"has_m3u8_video\": 0,\n\t\t\t\"keywords\": \"\",\n\t\t\t\"video_duration\": 161,\n\t\t\t\"has_mp4_video\": 0,\n\t\t\t\"favorite_count\": 49,\n\t\t\t\"aggr_type\": 0,\n\t\t\t\"article_sub_type\": 0,\n\t\t\t\"bury_count\": 2,\n\t\t\t\"title\": \"沃尔沃Tier 4 Final大型引擎的工作原理揭秘\",\n\t\t\t\"has_video\": true,\n\t\t\t\"share_url\": \"http://toutiao.com/group/6363577276176531969/?iid=0&app=news_article\",\n\t\t\t\"id\": 6363577276176532000,\n\t\t\t\"source\": \"开物志\",\n\t\t\t\"comment_count\": 4,\n\t\t\t\"article_url\": \"http://toutiao.com/group/6363577276176531969/\",\n\t\t\t\"image_url\": \"http://p3.pstatp.com/list/12f0000909de79ceeabc\",\n\t\t\t\"middle_mode\": true,\n\t\t\t\"large_mode\": false,\n\t\t\t\"item_source_url\": \"/group/6363577276176531969/\",\n\t\t\t\"media_url\": \"http://toutiao.com/m6643043415/\",\n\t\t\t\"display_time\": 1481635793,\n\t\t\t\"publish_time\": 1481635793,\n\t\t\t\"go_detail_count\": 2290,\n\t\t\t\"image_list\": [],\n\t\t\t\"item_seo_url\": \"/group/6363577276176531969/\",\n\t\t\t\"video_duration_str\": \"02:41\",\n\t\t\t\"source_url\": \"/group/6363577276176531969/\",\n\t\t\t\"tag_id\": 6363577276176532000,\n\t\t\t\"natant_level\": 0,\n\t\t\t\"seo_url\": \"/group/6363577276176531969/\",\n\t\t\t\"display_url\": \"http://toutiao.com/group/6363577276176531969/\",\n\t\t\t\"url\": \"http://toutiao.com/group/6363577276176531969/\",\n\t\t\t\"level\": 0,\n\t\t\t\"digg_count\": 4,\n\t\t\t\"behot_time\": 1481635793,\n\t\t\t\"tag\": \"news_car\",\n\t\t\t\"has_gallery\": false,\n\t\t\t\"has_image\": false,\n\t\t\t\"highlight\": {\n\t\t\t\"source\": [],\n\t\t\t\"abstract\": [],\n\t\t\t\"title\": []\n\t\t\t},\n\t\t\t\"group_id\": 6363577276176532000,\n\t\t\t\"middle_image\": \"http://p3.pstatp.com/list/12f0000909de79ceeabc\"\n\t\t},\n\t],\n\t\"message\": \"success\",\n\t\"action_label_pgc\": \"click_search\"\n}\n```\n\n嗯，特别多，其实只需要 data 里的内容就可以了。\n\n所以\n\n#### 构造一个请求结果的struct。\n\n```go\ntype ApiData struct {\n\tHas_more int    `json:\"has_more\"`\n\tData     []Data `json:\"data\"`\n}\n```\n\n再看下data里，嗯，没用的又一大堆。\n\n#### 只需要文章链接就够了。\n\n```go\ntype Data struct {\n\tArticle_url string `json:\"article_url\"`\n}\n```\n\n有了文章链接，那就好说了，啥都好商量。\n\n#### 分析文章结构\n\nid=\"J_content\" 下是文章的主要内容，class=\"article-title\"是文章标题，class=\"article-content\"里是文章内容，只需要article-content里所有img元素就可以了。\n\n```go\ntype Img struct {\n\tSrc string `json:\"src\"`\n}\n```\n\n由于需要一直更改查询接口的offset参数，所以直接把接口地址拿到外边做了全局变量。并且默认存在下一页。tag用来表示当前爬取的标签的名称。\n\n```go\nvar (\n\thost    string = \"http://www.toutiao.com/search_content/?format=json&keyword=%s&count=30&offset=%d\"\n\thasmore bool   = true\n\ttag     string\n)\n```\n\n### 正菜\n\n#### 0. 接收参数\n首先，接收并遍历命令行中传入的标签。\n\n```go\nfunc main() {\n\tfor _, tag = range os.Args[1:] {\n\t\thasmore = true\n\t\tgetByTag()\n\t}\n\tlog.Println(\"全部抓取完毕\")\n}\n```\n\n每个循环开始时重置 hasmore 。\n\n#### 1. 循环请求接口\n\n```go\nfunc getByTag() {\n\ti, offset := 1, 0\n\tfor {\n\t\tif hasmore {\n\t\t\tlog.Printf(\"标签: '%s'，第 '%d' 页, OFFSET: '%d' \\n\", tag, i, offset)\n\t\t\ttmpUrl := fmt.Sprintf(host, tag, offset)\n\t\t\tgetResFromApi(tmpUrl)\n\t\t\toffset += 30\n\t\t\ti++\n\n\t\t\ttime.Sleep(500 * time.Millisecond)\n\t\t} else {\n\t\t\tbreak\n\t\t}\n\t}\n\tlog.Printf(\"标签: '%s', 共 %v 页，爬取完毕\\n\", tag, i-1)\n}\n```\n\n重置当前页，和当前offset。页数从第一页开始，主要是显示进度看起来更人性化一些。但是程序员的世界是从0开始。。。想改成0就改成0吧。\n\nhasmore = true 表示存在下一页，使用fmt包的Sprintf方法格式化请求链接。然后对offset+30，对当前页i+1。再之后停顿了500毫秒。\n\n这里其实有个问题，如果实际内容以每页30请求，可能恰好有150条，即每页数量的整数倍，但是这个时候接口返回的has_more依然等于1，即服务端认为还有下一页。。。但是其实没有了，所以会有一次空循环。\n\n#### 2. 处理请求结果\n\n```go\nfunc getResFromApi(url string) {\n\tresp, err := http.Get(url)\n\tif err != nil {\n\t\tlog.Fatal(err)\n\t}\n\n\tdefer resp.Body.Close()\n\tbody, err := ioutil.ReadAll(resp.Body)\n\n\tif err != nil {\n\t\tlog.Fatal(err)\n\t}\n\n\tvar res ApiData\n\tjson.Unmarshal([]byte(string(body)), &res)\n\n\tfor _, item := range res.Data {\n\t\tgetImgByPage(item.Article_url)\n\t}\n\n\tif res.Has_more == 0 {\n\t\thasmore = false\n\t}\n}\n```\n\n没啥说的，拿到每一个请求接口的链接后打开，把结果数组中的data解析到ApiData中，于是就拿到了文章链接，然后遍历处理。\n\n遍历完后要看下has_more的值，如果为0表示没有下一页了，修改全局变量hasmore的值，结束最外层的循环。\n\n#### 3. 处理文章\n\n```go\nfunc getImgByPage(url string) {\n\t//部分请求结果中包含其他网站的链接，会导致下面的query出现问题\n\tif strings.Contains(url, \"toutiao.com\") {\n\t\tdoc, err := goquery.NewDocument(url)\n\t\tif err != nil {\n\t\t\tlog.Fatal(err)\n\t\t}\n\n\t\ttitle := doc.Find(\"#article-main .article-title\").Text()\n\t\ttitle = strings.Replace(title, \"/\", \"\", -1)\n\t\tos.MkdirAll(tag+\"/\"+title, 0777)\n\n\t\tdoc.Find(\"#J_content .article-content img\").Each(func(i int, s *goquery.Selection) {\n\t\t\tsrc, _ := s.Attr(\"src\")\n\t\t\tlog.Println(title, src)\n\t\t\tgetImgAndSave(src, title)\n\t\t})\n\t}\n}\n\n```\n\n最外层加了判断，是因为有一部分结果的链接是其他网站的。。。。\n\n虽然这个判断很low，但是也够用了。\n\n然后终于该用上goquery了，拿到标题，然后遍历文章内容中的img标签，就拿到了每一篇文章的每一张图片。\n\n#### 4. 保存图片\n\n在上一步把图片地址和文章名称传递给了getImgAndSave。\n\n```go\nfunc getImgAndSave(url string, dirname string) {\n\tpath := strings.Split(url, \"/\")\n\tvar name string\n\tif len(path) > 1 {\n\t\tname = path[len(path)-1]\n\t}\n\n\tresp, err := http.Get(url)\n\tdefer resp.Body.Close()\n\n\tif resp.StatusCode != http.StatusOK {\n\t\tlog.Fatal(\"请求失败\", err)\n\t\treturn\n\t}\n\n\tcontents, err := ioutil.ReadAll(resp.Body)\n\tdefer func() {\n\t\tif x := recover(); x != nil {\n\t\t\treturn\n\t\t}\n\t}()\n\terr = ioutil.WriteFile(\"./\"+tag+\"/\"+dirname+\"/\"+name+\".jpg\", contents, 0644)\n\tif err != nil {\n\t\tlog.Fatal(\"写入文件失败\", err)\n\t}\n}\n```\n\n先分割图片链接，把最后一个\"/\"后的内容当成文件名。\n\n后边get图片内容，但是有时候会出现对方服务器出错的情况，http状态码为500，所以加了判断请求是否成功的判断。\n\n然后就是读取内容，保存到文件中了。\n\n这里使用了WriteFile方式，查资料的时候还看到有闲Create文件，然后io.Copy写入的。\n\n#### 到这里就结束了。\n\n### RUN\n\n```\ngo run main.go 美女 模特\n```\n\n等着看图吧。\n\ngithub地址：[toutiaoSpider](https://github.com/qichengzx/toutiaoSpider)，欢迎star。","source":"_posts/toutiao-images-spider-by-golang.md","raw":"title: Go 福利小爬虫 爬取今日头条美女图\ncategories: golang\ndate: 2016-12-14 16:28:36\ntags:  [go,今日头条,goquery]\n---\n\n![](/images/go/toutiao.gif)\n\n写完爬取糗百热门后没几天，又开始写了爬取今日头条图片的[工具](https://github.com/qichengzx/toutiaoSpider)。\n\n灵感来源于[Python 福利小爬虫，爬取今日头条街拍美女图](http://www.jianshu.com/p/d67b1d4b99ad)，作者很详细的分析了今日头条一个搜索接口，并列出了步骤。\n\n而我用Go写的，稍稍做了改动，加入了可以自定义爬取标签的功能，并在写本文前完成了以 \"标签/文章名/图片名\" 结构存储图片的功能。\n\n分析网页依然使用[goquery](https://github.com/PuerkitoBio/goquery)。\n\n### 分析接口返回结构\n\n```json\n{\n\t\"count\": 30,\n\t\"action_label\": \"click_search\",\n\t\"return_count\": 0,\n\t\"has_more\": 0,\n\t\"page_id\": \"/search/\",\n\t\"cur_tab\": 1,\n\t\"offset\": 150,\n\t\"action_label_web\": \"click_search\",\n\t\"show_tabs\": 1,\n\t\"data\": [\n\t\t{\n\t\t\t\"play_effective_count\": \"6412\",\n\t\t\t\"media_name\": \"开物志\",\n\t\t\t\"repin_count\": 49,\n\t\t\t\"ban_comment\": 0,\n\t\t\t\"show_play_effective_count\": 1,\n\t\t\t\"abstract\": \"\",\n\t\t\t\"display_title\": \"\",\n\t\t\t\"datetime\": \"2016-12-13 21:35\",\n\t\t\t\"article_type\": 0,\n\t\t\t\"more_mode\": false,\n\t\t\t\"create_time\": 1481636117,\n\t\t\t\"has_m3u8_video\": 0,\n\t\t\t\"keywords\": \"\",\n\t\t\t\"video_duration\": 161,\n\t\t\t\"has_mp4_video\": 0,\n\t\t\t\"favorite_count\": 49,\n\t\t\t\"aggr_type\": 0,\n\t\t\t\"article_sub_type\": 0,\n\t\t\t\"bury_count\": 2,\n\t\t\t\"title\": \"沃尔沃Tier 4 Final大型引擎的工作原理揭秘\",\n\t\t\t\"has_video\": true,\n\t\t\t\"share_url\": \"http://toutiao.com/group/6363577276176531969/?iid=0&app=news_article\",\n\t\t\t\"id\": 6363577276176532000,\n\t\t\t\"source\": \"开物志\",\n\t\t\t\"comment_count\": 4,\n\t\t\t\"article_url\": \"http://toutiao.com/group/6363577276176531969/\",\n\t\t\t\"image_url\": \"http://p3.pstatp.com/list/12f0000909de79ceeabc\",\n\t\t\t\"middle_mode\": true,\n\t\t\t\"large_mode\": false,\n\t\t\t\"item_source_url\": \"/group/6363577276176531969/\",\n\t\t\t\"media_url\": \"http://toutiao.com/m6643043415/\",\n\t\t\t\"display_time\": 1481635793,\n\t\t\t\"publish_time\": 1481635793,\n\t\t\t\"go_detail_count\": 2290,\n\t\t\t\"image_list\": [],\n\t\t\t\"item_seo_url\": \"/group/6363577276176531969/\",\n\t\t\t\"video_duration_str\": \"02:41\",\n\t\t\t\"source_url\": \"/group/6363577276176531969/\",\n\t\t\t\"tag_id\": 6363577276176532000,\n\t\t\t\"natant_level\": 0,\n\t\t\t\"seo_url\": \"/group/6363577276176531969/\",\n\t\t\t\"display_url\": \"http://toutiao.com/group/6363577276176531969/\",\n\t\t\t\"url\": \"http://toutiao.com/group/6363577276176531969/\",\n\t\t\t\"level\": 0,\n\t\t\t\"digg_count\": 4,\n\t\t\t\"behot_time\": 1481635793,\n\t\t\t\"tag\": \"news_car\",\n\t\t\t\"has_gallery\": false,\n\t\t\t\"has_image\": false,\n\t\t\t\"highlight\": {\n\t\t\t\"source\": [],\n\t\t\t\"abstract\": [],\n\t\t\t\"title\": []\n\t\t\t},\n\t\t\t\"group_id\": 6363577276176532000,\n\t\t\t\"middle_image\": \"http://p3.pstatp.com/list/12f0000909de79ceeabc\"\n\t\t},\n\t],\n\t\"message\": \"success\",\n\t\"action_label_pgc\": \"click_search\"\n}\n```\n\n嗯，特别多，其实只需要 data 里的内容就可以了。\n\n所以\n\n#### 构造一个请求结果的struct。\n\n```go\ntype ApiData struct {\n\tHas_more int    `json:\"has_more\"`\n\tData     []Data `json:\"data\"`\n}\n```\n\n再看下data里，嗯，没用的又一大堆。\n\n#### 只需要文章链接就够了。\n\n```go\ntype Data struct {\n\tArticle_url string `json:\"article_url\"`\n}\n```\n\n有了文章链接，那就好说了，啥都好商量。\n\n#### 分析文章结构\n\nid=\"J_content\" 下是文章的主要内容，class=\"article-title\"是文章标题，class=\"article-content\"里是文章内容，只需要article-content里所有img元素就可以了。\n\n```go\ntype Img struct {\n\tSrc string `json:\"src\"`\n}\n```\n\n由于需要一直更改查询接口的offset参数，所以直接把接口地址拿到外边做了全局变量。并且默认存在下一页。tag用来表示当前爬取的标签的名称。\n\n```go\nvar (\n\thost    string = \"http://www.toutiao.com/search_content/?format=json&keyword=%s&count=30&offset=%d\"\n\thasmore bool   = true\n\ttag     string\n)\n```\n\n### 正菜\n\n#### 0. 接收参数\n首先，接收并遍历命令行中传入的标签。\n\n```go\nfunc main() {\n\tfor _, tag = range os.Args[1:] {\n\t\thasmore = true\n\t\tgetByTag()\n\t}\n\tlog.Println(\"全部抓取完毕\")\n}\n```\n\n每个循环开始时重置 hasmore 。\n\n#### 1. 循环请求接口\n\n```go\nfunc getByTag() {\n\ti, offset := 1, 0\n\tfor {\n\t\tif hasmore {\n\t\t\tlog.Printf(\"标签: '%s'，第 '%d' 页, OFFSET: '%d' \\n\", tag, i, offset)\n\t\t\ttmpUrl := fmt.Sprintf(host, tag, offset)\n\t\t\tgetResFromApi(tmpUrl)\n\t\t\toffset += 30\n\t\t\ti++\n\n\t\t\ttime.Sleep(500 * time.Millisecond)\n\t\t} else {\n\t\t\tbreak\n\t\t}\n\t}\n\tlog.Printf(\"标签: '%s', 共 %v 页，爬取完毕\\n\", tag, i-1)\n}\n```\n\n重置当前页，和当前offset。页数从第一页开始，主要是显示进度看起来更人性化一些。但是程序员的世界是从0开始。。。想改成0就改成0吧。\n\nhasmore = true 表示存在下一页，使用fmt包的Sprintf方法格式化请求链接。然后对offset+30，对当前页i+1。再之后停顿了500毫秒。\n\n这里其实有个问题，如果实际内容以每页30请求，可能恰好有150条，即每页数量的整数倍，但是这个时候接口返回的has_more依然等于1，即服务端认为还有下一页。。。但是其实没有了，所以会有一次空循环。\n\n#### 2. 处理请求结果\n\n```go\nfunc getResFromApi(url string) {\n\tresp, err := http.Get(url)\n\tif err != nil {\n\t\tlog.Fatal(err)\n\t}\n\n\tdefer resp.Body.Close()\n\tbody, err := ioutil.ReadAll(resp.Body)\n\n\tif err != nil {\n\t\tlog.Fatal(err)\n\t}\n\n\tvar res ApiData\n\tjson.Unmarshal([]byte(string(body)), &res)\n\n\tfor _, item := range res.Data {\n\t\tgetImgByPage(item.Article_url)\n\t}\n\n\tif res.Has_more == 0 {\n\t\thasmore = false\n\t}\n}\n```\n\n没啥说的，拿到每一个请求接口的链接后打开，把结果数组中的data解析到ApiData中，于是就拿到了文章链接，然后遍历处理。\n\n遍历完后要看下has_more的值，如果为0表示没有下一页了，修改全局变量hasmore的值，结束最外层的循环。\n\n#### 3. 处理文章\n\n```go\nfunc getImgByPage(url string) {\n\t//部分请求结果中包含其他网站的链接，会导致下面的query出现问题\n\tif strings.Contains(url, \"toutiao.com\") {\n\t\tdoc, err := goquery.NewDocument(url)\n\t\tif err != nil {\n\t\t\tlog.Fatal(err)\n\t\t}\n\n\t\ttitle := doc.Find(\"#article-main .article-title\").Text()\n\t\ttitle = strings.Replace(title, \"/\", \"\", -1)\n\t\tos.MkdirAll(tag+\"/\"+title, 0777)\n\n\t\tdoc.Find(\"#J_content .article-content img\").Each(func(i int, s *goquery.Selection) {\n\t\t\tsrc, _ := s.Attr(\"src\")\n\t\t\tlog.Println(title, src)\n\t\t\tgetImgAndSave(src, title)\n\t\t})\n\t}\n}\n\n```\n\n最外层加了判断，是因为有一部分结果的链接是其他网站的。。。。\n\n虽然这个判断很low，但是也够用了。\n\n然后终于该用上goquery了，拿到标题，然后遍历文章内容中的img标签，就拿到了每一篇文章的每一张图片。\n\n#### 4. 保存图片\n\n在上一步把图片地址和文章名称传递给了getImgAndSave。\n\n```go\nfunc getImgAndSave(url string, dirname string) {\n\tpath := strings.Split(url, \"/\")\n\tvar name string\n\tif len(path) > 1 {\n\t\tname = path[len(path)-1]\n\t}\n\n\tresp, err := http.Get(url)\n\tdefer resp.Body.Close()\n\n\tif resp.StatusCode != http.StatusOK {\n\t\tlog.Fatal(\"请求失败\", err)\n\t\treturn\n\t}\n\n\tcontents, err := ioutil.ReadAll(resp.Body)\n\tdefer func() {\n\t\tif x := recover(); x != nil {\n\t\t\treturn\n\t\t}\n\t}()\n\terr = ioutil.WriteFile(\"./\"+tag+\"/\"+dirname+\"/\"+name+\".jpg\", contents, 0644)\n\tif err != nil {\n\t\tlog.Fatal(\"写入文件失败\", err)\n\t}\n}\n```\n\n先分割图片链接，把最后一个\"/\"后的内容当成文件名。\n\n后边get图片内容，但是有时候会出现对方服务器出错的情况，http状态码为500，所以加了判断请求是否成功的判断。\n\n然后就是读取内容，保存到文件中了。\n\n这里使用了WriteFile方式，查资料的时候还看到有闲Create文件，然后io.Copy写入的。\n\n#### 到这里就结束了。\n\n### RUN\n\n```\ngo run main.go 美女 模特\n```\n\n等着看图吧。\n\ngithub地址：[toutiaoSpider](https://github.com/qichengzx/toutiaoSpider)，欢迎star。","slug":"toutiao-images-spider-by-golang","published":1,"updated":"2016-12-16T13:38:03.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj830jvez003cul0r02bth2v2","content":"<p><img src=\"/images/go/toutiao.gif\" alt=\"\"></p>\n<p>写完爬取糗百热门后没几天，又开始写了爬取今日头条图片的<a href=\"https://github.com/qichengzx/toutiaoSpider\" target=\"_blank\" rel=\"external\">工具</a>。</p>\n<p>灵感来源于<a href=\"http://www.jianshu.com/p/d67b1d4b99ad\" target=\"_blank\" rel=\"external\">Python 福利小爬虫，爬取今日头条街拍美女图</a>，作者很详细的分析了今日头条一个搜索接口，并列出了步骤。</p>\n<p>而我用Go写的，稍稍做了改动，加入了可以自定义爬取标签的功能，并在写本文前完成了以 “标签/文章名/图片名” 结构存储图片的功能。</p>\n<p>分析网页依然使用<a href=\"https://github.com/PuerkitoBio/goquery\" target=\"_blank\" rel=\"external\">goquery</a>。</p>\n<h3 id=\"分析接口返回结构\"><a href=\"#分析接口返回结构\" class=\"headerlink\" title=\"分析接口返回结构\"></a>分析接口返回结构</h3><figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div></pre></td><td class=\"code\"><pre><div class=\"line\">&#123;</div><div class=\"line\">\t<span class=\"attr\">\"count\"</span>: <span class=\"number\">30</span>,</div><div class=\"line\">\t<span class=\"attr\">\"action_label\"</span>: <span class=\"string\">\"click_search\"</span>,</div><div class=\"line\">\t<span class=\"attr\">\"return_count\"</span>: <span class=\"number\">0</span>,</div><div class=\"line\">\t<span class=\"attr\">\"has_more\"</span>: <span class=\"number\">0</span>,</div><div class=\"line\">\t<span class=\"attr\">\"page_id\"</span>: <span class=\"string\">\"/search/\"</span>,</div><div class=\"line\">\t<span class=\"attr\">\"cur_tab\"</span>: <span class=\"number\">1</span>,</div><div class=\"line\">\t<span class=\"attr\">\"offset\"</span>: <span class=\"number\">150</span>,</div><div class=\"line\">\t<span class=\"attr\">\"action_label_web\"</span>: <span class=\"string\">\"click_search\"</span>,</div><div class=\"line\">\t<span class=\"attr\">\"show_tabs\"</span>: <span class=\"number\">1</span>,</div><div class=\"line\">\t<span class=\"attr\">\"data\"</span>: [</div><div class=\"line\">\t\t&#123;</div><div class=\"line\">\t\t\t<span class=\"attr\">\"play_effective_count\"</span>: <span class=\"string\">\"6412\"</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"media_name\"</span>: <span class=\"string\">\"开物志\"</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"repin_count\"</span>: <span class=\"number\">49</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"ban_comment\"</span>: <span class=\"number\">0</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"show_play_effective_count\"</span>: <span class=\"number\">1</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"abstract\"</span>: <span class=\"string\">\"\"</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"display_title\"</span>: <span class=\"string\">\"\"</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"datetime\"</span>: <span class=\"string\">\"2016-12-13 21:35\"</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"article_type\"</span>: <span class=\"number\">0</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"more_mode\"</span>: <span class=\"literal\">false</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"create_time\"</span>: <span class=\"number\">1481636117</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"has_m3u8_video\"</span>: <span class=\"number\">0</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"keywords\"</span>: <span class=\"string\">\"\"</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"video_duration\"</span>: <span class=\"number\">161</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"has_mp4_video\"</span>: <span class=\"number\">0</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"favorite_count\"</span>: <span class=\"number\">49</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"aggr_type\"</span>: <span class=\"number\">0</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"article_sub_type\"</span>: <span class=\"number\">0</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"bury_count\"</span>: <span class=\"number\">2</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"title\"</span>: <span class=\"string\">\"沃尔沃Tier 4 Final大型引擎的工作原理揭秘\"</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"has_video\"</span>: <span class=\"literal\">true</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"share_url\"</span>: <span class=\"string\">\"http://toutiao.com/group/6363577276176531969/?iid=0&amp;app=news_article\"</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"id\"</span>: <span class=\"number\">6363577276176532000</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"source\"</span>: <span class=\"string\">\"开物志\"</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"comment_count\"</span>: <span class=\"number\">4</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"article_url\"</span>: <span class=\"string\">\"http://toutiao.com/group/6363577276176531969/\"</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"image_url\"</span>: <span class=\"string\">\"http://p3.pstatp.com/list/12f0000909de79ceeabc\"</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"middle_mode\"</span>: <span class=\"literal\">true</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"large_mode\"</span>: <span class=\"literal\">false</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"item_source_url\"</span>: <span class=\"string\">\"/group/6363577276176531969/\"</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"media_url\"</span>: <span class=\"string\">\"http://toutiao.com/m6643043415/\"</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"display_time\"</span>: <span class=\"number\">1481635793</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"publish_time\"</span>: <span class=\"number\">1481635793</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"go_detail_count\"</span>: <span class=\"number\">2290</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"image_list\"</span>: [],</div><div class=\"line\">\t\t\t<span class=\"attr\">\"item_seo_url\"</span>: <span class=\"string\">\"/group/6363577276176531969/\"</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"video_duration_str\"</span>: <span class=\"string\">\"02:41\"</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"source_url\"</span>: <span class=\"string\">\"/group/6363577276176531969/\"</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"tag_id\"</span>: <span class=\"number\">6363577276176532000</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"natant_level\"</span>: <span class=\"number\">0</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"seo_url\"</span>: <span class=\"string\">\"/group/6363577276176531969/\"</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"display_url\"</span>: <span class=\"string\">\"http://toutiao.com/group/6363577276176531969/\"</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"url\"</span>: <span class=\"string\">\"http://toutiao.com/group/6363577276176531969/\"</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"level\"</span>: <span class=\"number\">0</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"digg_count\"</span>: <span class=\"number\">4</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"behot_time\"</span>: <span class=\"number\">1481635793</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"tag\"</span>: <span class=\"string\">\"news_car\"</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"has_gallery\"</span>: <span class=\"literal\">false</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"has_image\"</span>: <span class=\"literal\">false</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"highlight\"</span>: &#123;</div><div class=\"line\">\t\t\t<span class=\"attr\">\"source\"</span>: [],</div><div class=\"line\">\t\t\t<span class=\"attr\">\"abstract\"</span>: [],</div><div class=\"line\">\t\t\t<span class=\"attr\">\"title\"</span>: []</div><div class=\"line\">\t\t\t&#125;,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"group_id\"</span>: <span class=\"number\">6363577276176532000</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"middle_image\"</span>: <span class=\"string\">\"http://p3.pstatp.com/list/12f0000909de79ceeabc\"</span></div><div class=\"line\">\t\t&#125;,</div><div class=\"line\">\t],</div><div class=\"line\">\t<span class=\"attr\">\"message\"</span>: <span class=\"string\">\"success\"</span>,</div><div class=\"line\">\t<span class=\"attr\">\"action_label_pgc\"</span>: <span class=\"string\">\"click_search\"</span></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>嗯，特别多，其实只需要 data 里的内容就可以了。</p>\n<p>所以</p>\n<h4 id=\"构造一个请求结果的struct。\"><a href=\"#构造一个请求结果的struct。\" class=\"headerlink\" title=\"构造一个请求结果的struct。\"></a>构造一个请求结果的struct。</h4><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">type</span> ApiData <span class=\"keyword\">struct</span> &#123;</div><div class=\"line\">\tHas_more <span class=\"keyword\">int</span>    <span class=\"string\">`json:\"has_more\"`</span></div><div class=\"line\">\tData     []Data <span class=\"string\">`json:\"data\"`</span></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>再看下data里，嗯，没用的又一大堆。</p>\n<h4 id=\"只需要文章链接就够了。\"><a href=\"#只需要文章链接就够了。\" class=\"headerlink\" title=\"只需要文章链接就够了。\"></a>只需要文章链接就够了。</h4><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">type</span> Data <span class=\"keyword\">struct</span> &#123;</div><div class=\"line\">\tArticle_url <span class=\"keyword\">string</span> <span class=\"string\">`json:\"article_url\"`</span></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>有了文章链接，那就好说了，啥都好商量。</p>\n<h4 id=\"分析文章结构\"><a href=\"#分析文章结构\" class=\"headerlink\" title=\"分析文章结构\"></a>分析文章结构</h4><p>id=”J_content” 下是文章的主要内容，class=”article-title”是文章标题，class=”article-content”里是文章内容，只需要article-content里所有img元素就可以了。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">type</span> Img <span class=\"keyword\">struct</span> &#123;</div><div class=\"line\">\tSrc <span class=\"keyword\">string</span> <span class=\"string\">`json:\"src\"`</span></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>由于需要一直更改查询接口的offset参数，所以直接把接口地址拿到外边做了全局变量。并且默认存在下一页。tag用来表示当前爬取的标签的名称。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> (</div><div class=\"line\">\thost    <span class=\"keyword\">string</span> = <span class=\"string\">\"http://www.toutiao.com/search_content/?format=json&amp;keyword=%s&amp;count=30&amp;offset=%d\"</span></div><div class=\"line\">\thasmore <span class=\"keyword\">bool</span>   = <span class=\"literal\">true</span></div><div class=\"line\">\ttag     <span class=\"keyword\">string</span></div><div class=\"line\">)</div></pre></td></tr></table></figure>\n<h3 id=\"正菜\"><a href=\"#正菜\" class=\"headerlink\" title=\"正菜\"></a>正菜</h3><h4 id=\"0-接收参数\"><a href=\"#0-接收参数\" class=\"headerlink\" title=\"0. 接收参数\"></a>0. 接收参数</h4><p>首先，接收并遍历命令行中传入的标签。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</div><div class=\"line\">\t<span class=\"keyword\">for</span> _, tag = <span class=\"keyword\">range</span> os.Args[<span class=\"number\">1</span>:] &#123;</div><div class=\"line\">\t\thasmore = <span class=\"literal\">true</span></div><div class=\"line\">\t\tgetByTag()</div><div class=\"line\">\t&#125;</div><div class=\"line\">\tlog.Println(<span class=\"string\">\"全部抓取完毕\"</span>)</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>每个循环开始时重置 hasmore 。</p>\n<h4 id=\"1-循环请求接口\"><a href=\"#1-循环请求接口\" class=\"headerlink\" title=\"1. 循环请求接口\"></a>1. 循环请求接口</h4><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">getByTag</span><span class=\"params\">()</span></span> &#123;</div><div class=\"line\">\ti, offset := <span class=\"number\">1</span>, <span class=\"number\">0</span></div><div class=\"line\">\t<span class=\"keyword\">for</span> &#123;</div><div class=\"line\">\t\t<span class=\"keyword\">if</span> hasmore &#123;</div><div class=\"line\">\t\t\tlog.Printf(<span class=\"string\">\"标签: '%s'，第 '%d' 页, OFFSET: '%d' \\n\"</span>, tag, i, offset)</div><div class=\"line\">\t\t\ttmpUrl := fmt.Sprintf(host, tag, offset)</div><div class=\"line\">\t\t\tgetResFromApi(tmpUrl)</div><div class=\"line\">\t\t\toffset += <span class=\"number\">30</span></div><div class=\"line\">\t\t\ti++</div><div class=\"line\"></div><div class=\"line\">\t\t\ttime.Sleep(<span class=\"number\">500</span> * time.Millisecond)</div><div class=\"line\">\t\t&#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">\t\t\t<span class=\"keyword\">break</span></div><div class=\"line\">\t\t&#125;</div><div class=\"line\">\t&#125;</div><div class=\"line\">\tlog.Printf(<span class=\"string\">\"标签: '%s', 共 %v 页，爬取完毕\\n\"</span>, tag, i<span class=\"number\">-1</span>)</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>重置当前页，和当前offset。页数从第一页开始，主要是显示进度看起来更人性化一些。但是程序员的世界是从0开始。。。想改成0就改成0吧。</p>\n<p>hasmore = true 表示存在下一页，使用fmt包的Sprintf方法格式化请求链接。然后对offset+30，对当前页i+1。再之后停顿了500毫秒。</p>\n<p>这里其实有个问题，如果实际内容以每页30请求，可能恰好有150条，即每页数量的整数倍，但是这个时候接口返回的has_more依然等于1，即服务端认为还有下一页。。。但是其实没有了，所以会有一次空循环。</p>\n<h4 id=\"2-处理请求结果\"><a href=\"#2-处理请求结果\" class=\"headerlink\" title=\"2. 处理请求结果\"></a>2. 处理请求结果</h4><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">getResFromApi</span><span class=\"params\">(url <span class=\"keyword\">string</span>)</span></span> &#123;</div><div class=\"line\">\tresp, err := http.Get(url)</div><div class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</div><div class=\"line\">\t\tlog.Fatal(err)</div><div class=\"line\">\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"keyword\">defer</span> resp.Body.Close()</div><div class=\"line\">\tbody, err := ioutil.ReadAll(resp.Body)</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</div><div class=\"line\">\t\tlog.Fatal(err)</div><div class=\"line\">\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"keyword\">var</span> res ApiData</div><div class=\"line\">\tjson.Unmarshal([]<span class=\"keyword\">byte</span>(<span class=\"keyword\">string</span>(body)), &amp;res)</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"keyword\">for</span> _, item := <span class=\"keyword\">range</span> res.Data &#123;</div><div class=\"line\">\t\tgetImgByPage(item.Article_url)</div><div class=\"line\">\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"keyword\">if</span> res.Has_more == <span class=\"number\">0</span> &#123;</div><div class=\"line\">\t\thasmore = <span class=\"literal\">false</span></div><div class=\"line\">\t&#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>没啥说的，拿到每一个请求接口的链接后打开，把结果数组中的data解析到ApiData中，于是就拿到了文章链接，然后遍历处理。</p>\n<p>遍历完后要看下has_more的值，如果为0表示没有下一页了，修改全局变量hasmore的值，结束最外层的循环。</p>\n<h4 id=\"3-处理文章\"><a href=\"#3-处理文章\" class=\"headerlink\" title=\"3. 处理文章\"></a>3. 处理文章</h4><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">getImgByPage</span><span class=\"params\">(url <span class=\"keyword\">string</span>)</span></span> &#123;</div><div class=\"line\">\t<span class=\"comment\">//部分请求结果中包含其他网站的链接，会导致下面的query出现问题</span></div><div class=\"line\">\t<span class=\"keyword\">if</span> strings.Contains(url, <span class=\"string\">\"toutiao.com\"</span>) &#123;</div><div class=\"line\">\t\tdoc, err := goquery.NewDocument(url)</div><div class=\"line\">\t\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</div><div class=\"line\">\t\t\tlog.Fatal(err)</div><div class=\"line\">\t\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t\ttitle := doc.Find(<span class=\"string\">\"#article-main .article-title\"</span>).Text()</div><div class=\"line\">\t\ttitle = strings.Replace(title, <span class=\"string\">\"/\"</span>, <span class=\"string\">\"\"</span>, <span class=\"number\">-1</span>)</div><div class=\"line\">\t\tos.MkdirAll(tag+<span class=\"string\">\"/\"</span>+title, <span class=\"number\">0777</span>)</div><div class=\"line\"></div><div class=\"line\">\t\tdoc.Find(<span class=\"string\">\"#J_content .article-content img\"</span>).Each(<span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">(i <span class=\"keyword\">int</span>, s *goquery.Selection)</span></span> &#123;</div><div class=\"line\">\t\t\tsrc, _ := s.Attr(<span class=\"string\">\"src\"</span>)</div><div class=\"line\">\t\t\tlog.Println(title, src)</div><div class=\"line\">\t\t\tgetImgAndSave(src, title)</div><div class=\"line\">\t\t&#125;)</div><div class=\"line\">\t&#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>最外层加了判断，是因为有一部分结果的链接是其他网站的。。。。</p>\n<p>虽然这个判断很low，但是也够用了。</p>\n<p>然后终于该用上goquery了，拿到标题，然后遍历文章内容中的img标签，就拿到了每一篇文章的每一张图片。</p>\n<h4 id=\"4-保存图片\"><a href=\"#4-保存图片\" class=\"headerlink\" title=\"4. 保存图片\"></a>4. 保存图片</h4><p>在上一步把图片地址和文章名称传递给了getImgAndSave。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">getImgAndSave</span><span class=\"params\">(url <span class=\"keyword\">string</span>, dirname <span class=\"keyword\">string</span>)</span></span> &#123;</div><div class=\"line\">\tpath := strings.Split(url, <span class=\"string\">\"/\"</span>)</div><div class=\"line\">\t<span class=\"keyword\">var</span> name <span class=\"keyword\">string</span></div><div class=\"line\">\t<span class=\"keyword\">if</span> <span class=\"built_in\">len</span>(path) &gt; <span class=\"number\">1</span> &#123;</div><div class=\"line\">\t\tname = path[<span class=\"built_in\">len</span>(path)<span class=\"number\">-1</span>]</div><div class=\"line\">\t&#125;</div><div class=\"line\"></div><div class=\"line\">\tresp, err := http.Get(url)</div><div class=\"line\">\t<span class=\"keyword\">defer</span> resp.Body.Close()</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"keyword\">if</span> resp.StatusCode != http.StatusOK &#123;</div><div class=\"line\">\t\tlog.Fatal(<span class=\"string\">\"请求失败\"</span>, err)</div><div class=\"line\">\t\t<span class=\"keyword\">return</span></div><div class=\"line\">\t&#125;</div><div class=\"line\"></div><div class=\"line\">\tcontents, err := ioutil.ReadAll(resp.Body)</div><div class=\"line\">\t<span class=\"keyword\">defer</span> <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span></span> &#123;</div><div class=\"line\">\t\t<span class=\"keyword\">if</span> x := <span class=\"built_in\">recover</span>(); x != <span class=\"literal\">nil</span> &#123;</div><div class=\"line\">\t\t\t<span class=\"keyword\">return</span></div><div class=\"line\">\t\t&#125;</div><div class=\"line\">\t&#125;()</div><div class=\"line\">\terr = ioutil.WriteFile(<span class=\"string\">\"./\"</span>+tag+<span class=\"string\">\"/\"</span>+dirname+<span class=\"string\">\"/\"</span>+name+<span class=\"string\">\".jpg\"</span>, contents, <span class=\"number\">0644</span>)</div><div class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</div><div class=\"line\">\t\tlog.Fatal(<span class=\"string\">\"写入文件失败\"</span>, err)</div><div class=\"line\">\t&#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>先分割图片链接，把最后一个”/“后的内容当成文件名。</p>\n<p>后边get图片内容，但是有时候会出现对方服务器出错的情况，http状态码为500，所以加了判断请求是否成功的判断。</p>\n<p>然后就是读取内容，保存到文件中了。</p>\n<p>这里使用了WriteFile方式，查资料的时候还看到有闲Create文件，然后io.Copy写入的。</p>\n<h4 id=\"到这里就结束了。\"><a href=\"#到这里就结束了。\" class=\"headerlink\" title=\"到这里就结束了。\"></a>到这里就结束了。</h4><h3 id=\"RUN\"><a href=\"#RUN\" class=\"headerlink\" title=\"RUN\"></a>RUN</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">go run main.go 美女 模特</div></pre></td></tr></table></figure>\n<p>等着看图吧。</p>\n<p>github地址：<a href=\"https://github.com/qichengzx/toutiaoSpider\" target=\"_blank\" rel=\"external\">toutiaoSpider</a>，欢迎star。</p>\n","site":{"data":{}},"excerpt":"","more":"<p><img src=\"/images/go/toutiao.gif\" alt=\"\"></p>\n<p>写完爬取糗百热门后没几天，又开始写了爬取今日头条图片的<a href=\"https://github.com/qichengzx/toutiaoSpider\" target=\"_blank\" rel=\"external\">工具</a>。</p>\n<p>灵感来源于<a href=\"http://www.jianshu.com/p/d67b1d4b99ad\" target=\"_blank\" rel=\"external\">Python 福利小爬虫，爬取今日头条街拍美女图</a>，作者很详细的分析了今日头条一个搜索接口，并列出了步骤。</p>\n<p>而我用Go写的，稍稍做了改动，加入了可以自定义爬取标签的功能，并在写本文前完成了以 “标签/文章名/图片名” 结构存储图片的功能。</p>\n<p>分析网页依然使用<a href=\"https://github.com/PuerkitoBio/goquery\" target=\"_blank\" rel=\"external\">goquery</a>。</p>\n<h3 id=\"分析接口返回结构\"><a href=\"#分析接口返回结构\" class=\"headerlink\" title=\"分析接口返回结构\"></a>分析接口返回结构</h3><figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div></pre></td><td class=\"code\"><pre><div class=\"line\">&#123;</div><div class=\"line\">\t<span class=\"attr\">\"count\"</span>: <span class=\"number\">30</span>,</div><div class=\"line\">\t<span class=\"attr\">\"action_label\"</span>: <span class=\"string\">\"click_search\"</span>,</div><div class=\"line\">\t<span class=\"attr\">\"return_count\"</span>: <span class=\"number\">0</span>,</div><div class=\"line\">\t<span class=\"attr\">\"has_more\"</span>: <span class=\"number\">0</span>,</div><div class=\"line\">\t<span class=\"attr\">\"page_id\"</span>: <span class=\"string\">\"/search/\"</span>,</div><div class=\"line\">\t<span class=\"attr\">\"cur_tab\"</span>: <span class=\"number\">1</span>,</div><div class=\"line\">\t<span class=\"attr\">\"offset\"</span>: <span class=\"number\">150</span>,</div><div class=\"line\">\t<span class=\"attr\">\"action_label_web\"</span>: <span class=\"string\">\"click_search\"</span>,</div><div class=\"line\">\t<span class=\"attr\">\"show_tabs\"</span>: <span class=\"number\">1</span>,</div><div class=\"line\">\t<span class=\"attr\">\"data\"</span>: [</div><div class=\"line\">\t\t&#123;</div><div class=\"line\">\t\t\t<span class=\"attr\">\"play_effective_count\"</span>: <span class=\"string\">\"6412\"</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"media_name\"</span>: <span class=\"string\">\"开物志\"</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"repin_count\"</span>: <span class=\"number\">49</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"ban_comment\"</span>: <span class=\"number\">0</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"show_play_effective_count\"</span>: <span class=\"number\">1</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"abstract\"</span>: <span class=\"string\">\"\"</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"display_title\"</span>: <span class=\"string\">\"\"</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"datetime\"</span>: <span class=\"string\">\"2016-12-13 21:35\"</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"article_type\"</span>: <span class=\"number\">0</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"more_mode\"</span>: <span class=\"literal\">false</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"create_time\"</span>: <span class=\"number\">1481636117</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"has_m3u8_video\"</span>: <span class=\"number\">0</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"keywords\"</span>: <span class=\"string\">\"\"</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"video_duration\"</span>: <span class=\"number\">161</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"has_mp4_video\"</span>: <span class=\"number\">0</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"favorite_count\"</span>: <span class=\"number\">49</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"aggr_type\"</span>: <span class=\"number\">0</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"article_sub_type\"</span>: <span class=\"number\">0</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"bury_count\"</span>: <span class=\"number\">2</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"title\"</span>: <span class=\"string\">\"沃尔沃Tier 4 Final大型引擎的工作原理揭秘\"</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"has_video\"</span>: <span class=\"literal\">true</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"share_url\"</span>: <span class=\"string\">\"http://toutiao.com/group/6363577276176531969/?iid=0&amp;app=news_article\"</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"id\"</span>: <span class=\"number\">6363577276176532000</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"source\"</span>: <span class=\"string\">\"开物志\"</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"comment_count\"</span>: <span class=\"number\">4</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"article_url\"</span>: <span class=\"string\">\"http://toutiao.com/group/6363577276176531969/\"</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"image_url\"</span>: <span class=\"string\">\"http://p3.pstatp.com/list/12f0000909de79ceeabc\"</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"middle_mode\"</span>: <span class=\"literal\">true</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"large_mode\"</span>: <span class=\"literal\">false</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"item_source_url\"</span>: <span class=\"string\">\"/group/6363577276176531969/\"</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"media_url\"</span>: <span class=\"string\">\"http://toutiao.com/m6643043415/\"</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"display_time\"</span>: <span class=\"number\">1481635793</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"publish_time\"</span>: <span class=\"number\">1481635793</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"go_detail_count\"</span>: <span class=\"number\">2290</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"image_list\"</span>: [],</div><div class=\"line\">\t\t\t<span class=\"attr\">\"item_seo_url\"</span>: <span class=\"string\">\"/group/6363577276176531969/\"</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"video_duration_str\"</span>: <span class=\"string\">\"02:41\"</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"source_url\"</span>: <span class=\"string\">\"/group/6363577276176531969/\"</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"tag_id\"</span>: <span class=\"number\">6363577276176532000</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"natant_level\"</span>: <span class=\"number\">0</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"seo_url\"</span>: <span class=\"string\">\"/group/6363577276176531969/\"</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"display_url\"</span>: <span class=\"string\">\"http://toutiao.com/group/6363577276176531969/\"</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"url\"</span>: <span class=\"string\">\"http://toutiao.com/group/6363577276176531969/\"</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"level\"</span>: <span class=\"number\">0</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"digg_count\"</span>: <span class=\"number\">4</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"behot_time\"</span>: <span class=\"number\">1481635793</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"tag\"</span>: <span class=\"string\">\"news_car\"</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"has_gallery\"</span>: <span class=\"literal\">false</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"has_image\"</span>: <span class=\"literal\">false</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"highlight\"</span>: &#123;</div><div class=\"line\">\t\t\t<span class=\"attr\">\"source\"</span>: [],</div><div class=\"line\">\t\t\t<span class=\"attr\">\"abstract\"</span>: [],</div><div class=\"line\">\t\t\t<span class=\"attr\">\"title\"</span>: []</div><div class=\"line\">\t\t\t&#125;,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"group_id\"</span>: <span class=\"number\">6363577276176532000</span>,</div><div class=\"line\">\t\t\t<span class=\"attr\">\"middle_image\"</span>: <span class=\"string\">\"http://p3.pstatp.com/list/12f0000909de79ceeabc\"</span></div><div class=\"line\">\t\t&#125;,</div><div class=\"line\">\t],</div><div class=\"line\">\t<span class=\"attr\">\"message\"</span>: <span class=\"string\">\"success\"</span>,</div><div class=\"line\">\t<span class=\"attr\">\"action_label_pgc\"</span>: <span class=\"string\">\"click_search\"</span></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>嗯，特别多，其实只需要 data 里的内容就可以了。</p>\n<p>所以</p>\n<h4 id=\"构造一个请求结果的struct。\"><a href=\"#构造一个请求结果的struct。\" class=\"headerlink\" title=\"构造一个请求结果的struct。\"></a>构造一个请求结果的struct。</h4><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">type</span> ApiData <span class=\"keyword\">struct</span> &#123;</div><div class=\"line\">\tHas_more <span class=\"keyword\">int</span>    <span class=\"string\">`json:\"has_more\"`</span></div><div class=\"line\">\tData     []Data <span class=\"string\">`json:\"data\"`</span></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>再看下data里，嗯，没用的又一大堆。</p>\n<h4 id=\"只需要文章链接就够了。\"><a href=\"#只需要文章链接就够了。\" class=\"headerlink\" title=\"只需要文章链接就够了。\"></a>只需要文章链接就够了。</h4><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">type</span> Data <span class=\"keyword\">struct</span> &#123;</div><div class=\"line\">\tArticle_url <span class=\"keyword\">string</span> <span class=\"string\">`json:\"article_url\"`</span></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>有了文章链接，那就好说了，啥都好商量。</p>\n<h4 id=\"分析文章结构\"><a href=\"#分析文章结构\" class=\"headerlink\" title=\"分析文章结构\"></a>分析文章结构</h4><p>id=”J_content” 下是文章的主要内容，class=”article-title”是文章标题，class=”article-content”里是文章内容，只需要article-content里所有img元素就可以了。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">type</span> Img <span class=\"keyword\">struct</span> &#123;</div><div class=\"line\">\tSrc <span class=\"keyword\">string</span> <span class=\"string\">`json:\"src\"`</span></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>由于需要一直更改查询接口的offset参数，所以直接把接口地址拿到外边做了全局变量。并且默认存在下一页。tag用来表示当前爬取的标签的名称。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> (</div><div class=\"line\">\thost    <span class=\"keyword\">string</span> = <span class=\"string\">\"http://www.toutiao.com/search_content/?format=json&amp;keyword=%s&amp;count=30&amp;offset=%d\"</span></div><div class=\"line\">\thasmore <span class=\"keyword\">bool</span>   = <span class=\"literal\">true</span></div><div class=\"line\">\ttag     <span class=\"keyword\">string</span></div><div class=\"line\">)</div></pre></td></tr></table></figure>\n<h3 id=\"正菜\"><a href=\"#正菜\" class=\"headerlink\" title=\"正菜\"></a>正菜</h3><h4 id=\"0-接收参数\"><a href=\"#0-接收参数\" class=\"headerlink\" title=\"0. 接收参数\"></a>0. 接收参数</h4><p>首先，接收并遍历命令行中传入的标签。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</div><div class=\"line\">\t<span class=\"keyword\">for</span> _, tag = <span class=\"keyword\">range</span> os.Args[<span class=\"number\">1</span>:] &#123;</div><div class=\"line\">\t\thasmore = <span class=\"literal\">true</span></div><div class=\"line\">\t\tgetByTag()</div><div class=\"line\">\t&#125;</div><div class=\"line\">\tlog.Println(<span class=\"string\">\"全部抓取完毕\"</span>)</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>每个循环开始时重置 hasmore 。</p>\n<h4 id=\"1-循环请求接口\"><a href=\"#1-循环请求接口\" class=\"headerlink\" title=\"1. 循环请求接口\"></a>1. 循环请求接口</h4><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">getByTag</span><span class=\"params\">()</span></span> &#123;</div><div class=\"line\">\ti, offset := <span class=\"number\">1</span>, <span class=\"number\">0</span></div><div class=\"line\">\t<span class=\"keyword\">for</span> &#123;</div><div class=\"line\">\t\t<span class=\"keyword\">if</span> hasmore &#123;</div><div class=\"line\">\t\t\tlog.Printf(<span class=\"string\">\"标签: '%s'，第 '%d' 页, OFFSET: '%d' \\n\"</span>, tag, i, offset)</div><div class=\"line\">\t\t\ttmpUrl := fmt.Sprintf(host, tag, offset)</div><div class=\"line\">\t\t\tgetResFromApi(tmpUrl)</div><div class=\"line\">\t\t\toffset += <span class=\"number\">30</span></div><div class=\"line\">\t\t\ti++</div><div class=\"line\"></div><div class=\"line\">\t\t\ttime.Sleep(<span class=\"number\">500</span> * time.Millisecond)</div><div class=\"line\">\t\t&#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">\t\t\t<span class=\"keyword\">break</span></div><div class=\"line\">\t\t&#125;</div><div class=\"line\">\t&#125;</div><div class=\"line\">\tlog.Printf(<span class=\"string\">\"标签: '%s', 共 %v 页，爬取完毕\\n\"</span>, tag, i<span class=\"number\">-1</span>)</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>重置当前页，和当前offset。页数从第一页开始，主要是显示进度看起来更人性化一些。但是程序员的世界是从0开始。。。想改成0就改成0吧。</p>\n<p>hasmore = true 表示存在下一页，使用fmt包的Sprintf方法格式化请求链接。然后对offset+30，对当前页i+1。再之后停顿了500毫秒。</p>\n<p>这里其实有个问题，如果实际内容以每页30请求，可能恰好有150条，即每页数量的整数倍，但是这个时候接口返回的has_more依然等于1，即服务端认为还有下一页。。。但是其实没有了，所以会有一次空循环。</p>\n<h4 id=\"2-处理请求结果\"><a href=\"#2-处理请求结果\" class=\"headerlink\" title=\"2. 处理请求结果\"></a>2. 处理请求结果</h4><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">getResFromApi</span><span class=\"params\">(url <span class=\"keyword\">string</span>)</span></span> &#123;</div><div class=\"line\">\tresp, err := http.Get(url)</div><div class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</div><div class=\"line\">\t\tlog.Fatal(err)</div><div class=\"line\">\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"keyword\">defer</span> resp.Body.Close()</div><div class=\"line\">\tbody, err := ioutil.ReadAll(resp.Body)</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</div><div class=\"line\">\t\tlog.Fatal(err)</div><div class=\"line\">\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"keyword\">var</span> res ApiData</div><div class=\"line\">\tjson.Unmarshal([]<span class=\"keyword\">byte</span>(<span class=\"keyword\">string</span>(body)), &amp;res)</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"keyword\">for</span> _, item := <span class=\"keyword\">range</span> res.Data &#123;</div><div class=\"line\">\t\tgetImgByPage(item.Article_url)</div><div class=\"line\">\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"keyword\">if</span> res.Has_more == <span class=\"number\">0</span> &#123;</div><div class=\"line\">\t\thasmore = <span class=\"literal\">false</span></div><div class=\"line\">\t&#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>没啥说的，拿到每一个请求接口的链接后打开，把结果数组中的data解析到ApiData中，于是就拿到了文章链接，然后遍历处理。</p>\n<p>遍历完后要看下has_more的值，如果为0表示没有下一页了，修改全局变量hasmore的值，结束最外层的循环。</p>\n<h4 id=\"3-处理文章\"><a href=\"#3-处理文章\" class=\"headerlink\" title=\"3. 处理文章\"></a>3. 处理文章</h4><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">getImgByPage</span><span class=\"params\">(url <span class=\"keyword\">string</span>)</span></span> &#123;</div><div class=\"line\">\t<span class=\"comment\">//部分请求结果中包含其他网站的链接，会导致下面的query出现问题</span></div><div class=\"line\">\t<span class=\"keyword\">if</span> strings.Contains(url, <span class=\"string\">\"toutiao.com\"</span>) &#123;</div><div class=\"line\">\t\tdoc, err := goquery.NewDocument(url)</div><div class=\"line\">\t\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</div><div class=\"line\">\t\t\tlog.Fatal(err)</div><div class=\"line\">\t\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t\ttitle := doc.Find(<span class=\"string\">\"#article-main .article-title\"</span>).Text()</div><div class=\"line\">\t\ttitle = strings.Replace(title, <span class=\"string\">\"/\"</span>, <span class=\"string\">\"\"</span>, <span class=\"number\">-1</span>)</div><div class=\"line\">\t\tos.MkdirAll(tag+<span class=\"string\">\"/\"</span>+title, <span class=\"number\">0777</span>)</div><div class=\"line\"></div><div class=\"line\">\t\tdoc.Find(<span class=\"string\">\"#J_content .article-content img\"</span>).Each(<span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">(i <span class=\"keyword\">int</span>, s *goquery.Selection)</span></span> &#123;</div><div class=\"line\">\t\t\tsrc, _ := s.Attr(<span class=\"string\">\"src\"</span>)</div><div class=\"line\">\t\t\tlog.Println(title, src)</div><div class=\"line\">\t\t\tgetImgAndSave(src, title)</div><div class=\"line\">\t\t&#125;)</div><div class=\"line\">\t&#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>最外层加了判断，是因为有一部分结果的链接是其他网站的。。。。</p>\n<p>虽然这个判断很low，但是也够用了。</p>\n<p>然后终于该用上goquery了，拿到标题，然后遍历文章内容中的img标签，就拿到了每一篇文章的每一张图片。</p>\n<h4 id=\"4-保存图片\"><a href=\"#4-保存图片\" class=\"headerlink\" title=\"4. 保存图片\"></a>4. 保存图片</h4><p>在上一步把图片地址和文章名称传递给了getImgAndSave。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">getImgAndSave</span><span class=\"params\">(url <span class=\"keyword\">string</span>, dirname <span class=\"keyword\">string</span>)</span></span> &#123;</div><div class=\"line\">\tpath := strings.Split(url, <span class=\"string\">\"/\"</span>)</div><div class=\"line\">\t<span class=\"keyword\">var</span> name <span class=\"keyword\">string</span></div><div class=\"line\">\t<span class=\"keyword\">if</span> <span class=\"built_in\">len</span>(path) &gt; <span class=\"number\">1</span> &#123;</div><div class=\"line\">\t\tname = path[<span class=\"built_in\">len</span>(path)<span class=\"number\">-1</span>]</div><div class=\"line\">\t&#125;</div><div class=\"line\"></div><div class=\"line\">\tresp, err := http.Get(url)</div><div class=\"line\">\t<span class=\"keyword\">defer</span> resp.Body.Close()</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"keyword\">if</span> resp.StatusCode != http.StatusOK &#123;</div><div class=\"line\">\t\tlog.Fatal(<span class=\"string\">\"请求失败\"</span>, err)</div><div class=\"line\">\t\t<span class=\"keyword\">return</span></div><div class=\"line\">\t&#125;</div><div class=\"line\"></div><div class=\"line\">\tcontents, err := ioutil.ReadAll(resp.Body)</div><div class=\"line\">\t<span class=\"keyword\">defer</span> <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span></span> &#123;</div><div class=\"line\">\t\t<span class=\"keyword\">if</span> x := <span class=\"built_in\">recover</span>(); x != <span class=\"literal\">nil</span> &#123;</div><div class=\"line\">\t\t\t<span class=\"keyword\">return</span></div><div class=\"line\">\t\t&#125;</div><div class=\"line\">\t&#125;()</div><div class=\"line\">\terr = ioutil.WriteFile(<span class=\"string\">\"./\"</span>+tag+<span class=\"string\">\"/\"</span>+dirname+<span class=\"string\">\"/\"</span>+name+<span class=\"string\">\".jpg\"</span>, contents, <span class=\"number\">0644</span>)</div><div class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</div><div class=\"line\">\t\tlog.Fatal(<span class=\"string\">\"写入文件失败\"</span>, err)</div><div class=\"line\">\t&#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>先分割图片链接，把最后一个”/“后的内容当成文件名。</p>\n<p>后边get图片内容，但是有时候会出现对方服务器出错的情况，http状态码为500，所以加了判断请求是否成功的判断。</p>\n<p>然后就是读取内容，保存到文件中了。</p>\n<p>这里使用了WriteFile方式，查资料的时候还看到有闲Create文件，然后io.Copy写入的。</p>\n<h4 id=\"到这里就结束了。\"><a href=\"#到这里就结束了。\" class=\"headerlink\" title=\"到这里就结束了。\"></a>到这里就结束了。</h4><h3 id=\"RUN\"><a href=\"#RUN\" class=\"headerlink\" title=\"RUN\"></a>RUN</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">go run main.go 美女 模特</div></pre></td></tr></table></figure>\n<p>等着看图吧。</p>\n<p>github地址：<a href=\"https://github.com/qichengzx/toutiaoSpider\" target=\"_blank\" rel=\"external\">toutiaoSpider</a>，欢迎star。</p>\n"}],"PostAsset":[],"PostCategory":[{"post_id":"cj830jvcs0000ul0rjjmbwzdl","category_id":"cj830jvcy0002ul0r0q35ffni","_id":"cj830jvda000dul0rd9h4sj22"},{"post_id":"cj830jvcw0001ul0rg6s0mrtx","category_id":"cj830jvcy0002ul0r0q35ffni","_id":"cj830jvdd000iul0ry7vduf1q"},{"post_id":"cj830jvd00004ul0rnsvh6cys","category_id":"cj830jvda000cul0rt6fq41om","_id":"cj830jvdh000pul0r0fgjszw9"},{"post_id":"cj830jvdf000lul0r21zmixge","category_id":"cj830jvcy0002ul0r0q35ffni","_id":"cj830jvdm000vul0r3m1997ix"},{"post_id":"cj830jvd00005ul0r8wf665k2","category_id":"cj830jvda000cul0rt6fq41om","_id":"cj830jvdp0010ul0rpn831cxt"},{"post_id":"cj830jvdh000sul0rd2byw5k9","category_id":"cj830jvcy0002ul0r0q35ffni","_id":"cj830jvdq0012ul0rcxydp3jq"},{"post_id":"cj830jvd9000bul0rt8yvx34i","category_id":"cj830jvdh000oul0rdgtuqr7e","_id":"cj830jvdt0017ul0rm0f5igte"},{"post_id":"cj830jvdn000zul0r0okrn9sk","category_id":"cj830jvcy0002ul0r0q35ffni","_id":"cj830jvdv0019ul0rrk61dn5d"},{"post_id":"cj830jvdb000gul0rf5wxwgto","category_id":"cj830jvdn000wul0r5fr74bn5","_id":"cj830jvdw001bul0rn6s6br20"},{"post_id":"cj830jvdu0018ul0r46s4ia1j","category_id":"cj830jvdh000oul0rdgtuqr7e","_id":"cj830jvdy001iul0r6f54vgh0"},{"post_id":"cj830jvdd000hul0r4a3lu9px","category_id":"cj830jvdr0014ul0rhm684gy3","_id":"cj830jve1001nul0r6eqnv4fo"},{"post_id":"cj830jvdv001aul0rmmsoskc2","category_id":"cj830jvda000cul0rt6fq41om","_id":"cj830jve2001pul0r2yttgnfq"},{"post_id":"cj830jvdx001ful0rkogyrta5","category_id":"cj830jvcy0002ul0r0q35ffni","_id":"cj830jve4001tul0r0p5xb81o"},{"post_id":"cj830jvdg000nul0rh4gfdqa7","category_id":"cj830jvdh000oul0rdgtuqr7e","_id":"cj830jve5001wul0rv1xq04a8"},{"post_id":"cj830jvdz001mul0r7hnyqvsh","category_id":"cj830jvcy0002ul0r0q35ffni","_id":"cj830jve70020ul0r9bur68ud"},{"post_id":"cj830jvdk000uul0r54ell83a","category_id":"cj830jvdn000wul0r5fr74bn5","_id":"cj830jve80023ul0ruvx95w93"},{"post_id":"cj830jve1001oul0rqu9ajrpl","category_id":"cj830jvdn000wul0r5fr74bn5","_id":"cj830jvea0025ul0re2n7hkv4"},{"post_id":"cj830jve3001sul0r7xsq6ifv","category_id":"cj830jvdh000oul0rdgtuqr7e","_id":"cj830jveb0029ul0r0k5jio6x"},{"post_id":"cj830jve5001vul0ru7vhvsfe","category_id":"cj830jvdh000oul0rdgtuqr7e","_id":"cj830jved002bul0rlkk1joa4"},{"post_id":"cj830jve6001zul0rquqwbb97","category_id":"cj830jvcy0002ul0r0q35ffni","_id":"cj830jveg002eul0rq2oy47do"},{"post_id":"cj830jve80022ul0rxudilj9i","category_id":"cj830jvda000cul0rt6fq41om","_id":"cj830jveh002gul0r72qqbbnc"},{"post_id":"cj830jve90024ul0rvtgsntxa","category_id":"cj830jvdn000wul0r5fr74bn5","_id":"cj830jvek002jul0rzcawlk65"},{"post_id":"cj830jveb0028ul0r4jhajrqw","category_id":"cj830jvdn000wul0r5fr74bn5","_id":"cj830jvel002mul0rspbrcqpi"},{"post_id":"cj830jvec002aul0r261rubxu","category_id":"cj830jvdn000wul0r5fr74bn5","_id":"cj830jvem002qul0rz9hrzu6z"},{"post_id":"cj830jvef002dul0ro3jk3gq4","category_id":"cj830jvdn000wul0r5fr74bn5","_id":"cj830jven002tul0r5f0c33pm"},{"post_id":"cj830jveg002ful0rwvkr05ta","category_id":"cj830jvdn000wul0r5fr74bn5","_id":"cj830jveq002vul0rhicgck10"},{"post_id":"cj830jveh002iul0rqhu62xsd","category_id":"cj830jvdn000wul0r5fr74bn5","_id":"cj830jves002zul0r9in02ak2"},{"post_id":"cj830jvek002lul0ryxte2vgo","category_id":"cj830jvdn000wul0r5fr74bn5","_id":"cj830jvew0032ul0rnjzwxkus"},{"post_id":"cj830jvel002pul0rn5rsfjrp","category_id":"cj830jvdn000wul0r5fr74bn5","_id":"cj830jvex0036ul0rte8ydt5j"},{"post_id":"cj830jvem002sul0rcyo6fre3","category_id":"cj830jvdh000oul0rdgtuqr7e","_id":"cj830jvey0038ul0r9yixoqe8"},{"post_id":"cj830jveo002uul0rb35o1gyc","category_id":"cj830jvcy0002ul0r0q35ffni","_id":"cj830jvey003bul0r1v8tr959"},{"post_id":"cj830jver002yul0r5qgtnzkg","category_id":"cj830jvcy0002ul0r0q35ffni","_id":"cj830jvez003dul0rc2und3rp"},{"post_id":"cj830jvev0031ul0riebzttix","category_id":"cj830jvcy0002ul0r0q35ffni","_id":"cj830jvf1003ful0rxmfvhyko"},{"post_id":"cj830jvex0037ul0r1io724r8","category_id":"cj830jvcy0002ul0r0q35ffni","_id":"cj830jvf1003hul0r2au4xxn0"},{"post_id":"cj830jvez003cul0r02bth2v2","category_id":"cj830jvcy0002ul0r0q35ffni","_id":"cj830jvf1003kul0rzaykr2u4"}],"PostTag":[{"post_id":"cj830jvcs0000ul0rjjmbwzdl","tag_id":"cj830jvcz0003ul0rz3o5aflt","_id":"cj830jvd60009ul0r962lycqo"},{"post_id":"cj830jvcw0001ul0rg6s0mrtx","tag_id":"cj830jvcz0003ul0rz3o5aflt","_id":"cj830jvdb000ful0rx0emzaee"},{"post_id":"cj830jvd00004ul0rnsvh6cys","tag_id":"cj830jvda000eul0rx2dql1db","_id":"cj830jvdf000mul0rte7v64qp"},{"post_id":"cj830jvdf000lul0r21zmixge","tag_id":"cj830jvcz0003ul0rz3o5aflt","_id":"cj830jvdh000rul0r3n9hoh4f"},{"post_id":"cj830jvd00005ul0r8wf665k2","tag_id":"cj830jvda000eul0rx2dql1db","_id":"cj830jvdk000tul0rtci6jxnh"},{"post_id":"cj830jvdh000sul0rd2byw5k9","tag_id":"cj830jvcz0003ul0rz3o5aflt","_id":"cj830jvdn000yul0rc6gjyuhf"},{"post_id":"cj830jvdn000zul0r0okrn9sk","tag_id":"cj830jvcz0003ul0rz3o5aflt","_id":"cj830jvdr0013ul0r6y3usdmp"},{"post_id":"cj830jvd30006ul0rqf7jdpw3","tag_id":"cj830jvdh000qul0rtkfyadqq","_id":"cj830jvdx001eul0rszpcmtrx"},{"post_id":"cj830jvd30006ul0rqf7jdpw3","tag_id":"cj830jvdn000xul0ruoso5jew","_id":"cj830jvdy001gul0rdejekc2e"},{"post_id":"cj830jvd30006ul0rqf7jdpw3","tag_id":"cj830jvdr0015ul0rzmyxo6za","_id":"cj830jvdz001lul0r99o5z2ue"},{"post_id":"cj830jvdz001mul0r7hnyqvsh","tag_id":"cj830jvcz0003ul0rz3o5aflt","_id":"cj830jve3001rul0rihd1a1oy"},{"post_id":"cj830jvd7000aul0r11eg7gop","tag_id":"cj830jvdw001dul0rvdsz9gbo","_id":"cj830jve4001uul0r8bl73cbm"},{"post_id":"cj830jvd7000aul0r11eg7gop","tag_id":"cj830jvdz001kul0rkuqq9jt7","_id":"cj830jve6001xul0rb9yhxj7f"},{"post_id":"cj830jvd9000bul0rt8yvx34i","tag_id":"cj830jve2001qul0r1xxkp0ey","_id":"cj830jve80021ul0r2mo5c9o8"},{"post_id":"cj830jve80022ul0rxudilj9i","tag_id":"cj830jvda000eul0rx2dql1db","_id":"cj830jveb0027ul0r81syuwy4"},{"post_id":"cj830jvdb000gul0rf5wxwgto","tag_id":"cj830jve6001yul0r8745w2vq","_id":"cj830jvek002kul0rkc3bbpqb"},{"post_id":"cj830jvdb000gul0rf5wxwgto","tag_id":"cj830jvea0026ul0rtm9cddyj","_id":"cj830jvel002nul0r04yu21io"},{"post_id":"cj830jvdb000gul0rf5wxwgto","tag_id":"cj830jvee002cul0rtg6adri3","_id":"cj830jvem002rul0r1r04dxdu"},{"post_id":"cj830jvdd000hul0r4a3lu9px","tag_id":"cj830jveh002hul0r6ephx1ay","_id":"cj830jver002xul0r7ebk3slo"},{"post_id":"cj830jvdd000hul0r4a3lu9px","tag_id":"cj830jvda000eul0rx2dql1db","_id":"cj830jvev0030ul0rpydjkzxe"},{"post_id":"cj830jvdd000hul0r4a3lu9px","tag_id":"cj830jvel002oul0rgf8lfbpk","_id":"cj830jvew0034ul0rhynf2oko"},{"post_id":"cj830jvdg000nul0rh4gfdqa7","tag_id":"cj830jve2001qul0r1xxkp0ey","_id":"cj830jvf1003gul0rq98za7pr"},{"post_id":"cj830jvdg000nul0rh4gfdqa7","tag_id":"cj830jvew0033ul0rn1g6gl3p","_id":"cj830jvf1003iul0r7bjrnhml"},{"post_id":"cj830jvdg000nul0rh4gfdqa7","tag_id":"cj830jvey0039ul0rb5zu68w3","_id":"cj830jvf1003lul0ry7nvkszo"},{"post_id":"cj830jvdk000uul0r54ell83a","tag_id":"cj830jvea0026ul0rtm9cddyj","_id":"cj830jvf2003nul0rc3jfr12d"},{"post_id":"cj830jvdk000uul0r54ell83a","tag_id":"cj830jvf1003jul0rk40443o3","_id":"cj830jvf2003oul0rs2nwx8eq"},{"post_id":"cj830jvdq0011ul0rujaht2om","tag_id":"cj830jvf1003mul0rekvgdidg","_id":"cj830jvf2003rul0rolg0nbff"},{"post_id":"cj830jvdq0011ul0rujaht2om","tag_id":"cj830jvf2003pul0rafw7w5j4","_id":"cj830jvf2003sul0rrtglc6k0"},{"post_id":"cj830jvds0016ul0r3nthdxw7","tag_id":"cj830jvf2003pul0rafw7w5j4","_id":"cj830jvf3003vul0ri0wv2q4u"},{"post_id":"cj830jvds0016ul0r3nthdxw7","tag_id":"cj830jvf1003mul0rekvgdidg","_id":"cj830jvf3003wul0rwt8dj609"},{"post_id":"cj830jvdu0018ul0r46s4ia1j","tag_id":"cj830jvf3003uul0rwd6t3of3","_id":"cj830jvf40041ul0r7dxnz9ig"},{"post_id":"cj830jvdu0018ul0r46s4ia1j","tag_id":"cj830jvea0026ul0rtm9cddyj","_id":"cj830jvf40042ul0ry0ud6r05"},{"post_id":"cj830jvdu0018ul0r46s4ia1j","tag_id":"cj830jvf3003yul0r63ed9hpr","_id":"cj830jvf40044ul0rnb4whvqs"},{"post_id":"cj830jvdu0018ul0r46s4ia1j","tag_id":"cj830jvea0026ul0rtm9cddyj","_id":"cj830jvf40045ul0r9rjm2tle"},{"post_id":"cj830jvdv001aul0rmmsoskc2","tag_id":"cj830jvda000eul0rx2dql1db","_id":"cj830jvf40047ul0rzw77d3cj"},{"post_id":"cj830jvdv001aul0rmmsoskc2","tag_id":"cj830jvf40040ul0rrpe1it56","_id":"cj830jvf50048ul0ruwoucqge"},{"post_id":"cj830jvdx001ful0rkogyrta5","tag_id":"cj830jvcz0003ul0rz3o5aflt","_id":"cj830jvf5004bul0rjjo3glor"},{"post_id":"cj830jvdx001ful0rkogyrta5","tag_id":"cj830jvf40043ul0rzj71lxa5","_id":"cj830jvf5004cul0rvnbajo4i"},{"post_id":"cj830jvdx001ful0rkogyrta5","tag_id":"cj830jvf40046ul0regrx3czl","_id":"cj830jvf5004eul0rpo2i8784"},{"post_id":"cj830jvdx001ful0rkogyrta5","tag_id":"cj830jvf50049ul0req5e55k7","_id":"cj830jvf5004ful0r8guu5a7i"},{"post_id":"cj830jve1001oul0rqu9ajrpl","tag_id":"cj830jvea0026ul0rtm9cddyj","_id":"cj830jvf6004hul0rq0efalt1"},{"post_id":"cj830jve3001sul0r7xsq6ifv","tag_id":"cj830jvf3003uul0rwd6t3of3","_id":"cj830jvf6004jul0rcyerc7p6"},{"post_id":"cj830jve3001sul0r7xsq6ifv","tag_id":"cj830jvf5004gul0rd7d1nags","_id":"cj830jvf6004kul0remdxh5gf"},{"post_id":"cj830jve5001vul0ru7vhvsfe","tag_id":"cj830jvf6004iul0rvt72rrtf","_id":"cj830jvf6004mul0rhzqwpfj2"},{"post_id":"cj830jve5001vul0ru7vhvsfe","tag_id":"cj830jvda000eul0rx2dql1db","_id":"cj830jvf6004nul0rrwlmtmwo"},{"post_id":"cj830jve6001zul0rquqwbb97","tag_id":"cj830jvcz0003ul0rz3o5aflt","_id":"cj830jvf7004pul0r2h250nqy"},{"post_id":"cj830jve6001zul0rquqwbb97","tag_id":"cj830jvf6004lul0rbdq4dskf","_id":"cj830jvf7004qul0rcp82k11f"},{"post_id":"cj830jve90024ul0rvtgsntxa","tag_id":"cj830jvea0026ul0rtm9cddyj","_id":"cj830jvf8004sul0r2ikbq32i"},{"post_id":"cj830jveb0028ul0r4jhajrqw","tag_id":"cj830jvea0026ul0rtm9cddyj","_id":"cj830jvfa004uul0r6zesdjw9"},{"post_id":"cj830jveb0028ul0r4jhajrqw","tag_id":"cj830jvf7004rul0rc9m3wlxu","_id":"cj830jvfa004vul0r57vc9760"},{"post_id":"cj830jvec002aul0r261rubxu","tag_id":"cj830jvea0026ul0rtm9cddyj","_id":"cj830jvfb004xul0rprp817rl"},{"post_id":"cj830jvec002aul0r261rubxu","tag_id":"cj830jvf7004rul0rc9m3wlxu","_id":"cj830jvfb004yul0rb35hrl7a"},{"post_id":"cj830jvef002dul0ro3jk3gq4","tag_id":"cj830jvea0026ul0rtm9cddyj","_id":"cj830jvfc0050ul0r9ihh49ad"},{"post_id":"cj830jvef002dul0ro3jk3gq4","tag_id":"cj830jvf7004rul0rc9m3wlxu","_id":"cj830jvfc0051ul0r3x12ptmq"},{"post_id":"cj830jveg002ful0rwvkr05ta","tag_id":"cj830jvea0026ul0rtm9cddyj","_id":"cj830jvfc0053ul0rbi0oasex"},{"post_id":"cj830jveg002ful0rwvkr05ta","tag_id":"cj830jvf7004rul0rc9m3wlxu","_id":"cj830jvfc0054ul0rkvn8u2ak"},{"post_id":"cj830jveh002iul0rqhu62xsd","tag_id":"cj830jvea0026ul0rtm9cddyj","_id":"cj830jvfd0056ul0rbxy4t0fh"},{"post_id":"cj830jveh002iul0rqhu62xsd","tag_id":"cj830jvf7004rul0rc9m3wlxu","_id":"cj830jvfd0057ul0r0109jnd7"},{"post_id":"cj830jvek002lul0ryxte2vgo","tag_id":"cj830jvea0026ul0rtm9cddyj","_id":"cj830jvfe0059ul0roiahduw9"},{"post_id":"cj830jvek002lul0ryxte2vgo","tag_id":"cj830jvf7004rul0rc9m3wlxu","_id":"cj830jvfe005aul0rgq19ymp3"},{"post_id":"cj830jvel002pul0rn5rsfjrp","tag_id":"cj830jvea0026ul0rtm9cddyj","_id":"cj830jvfe005cul0ro0l4wrzf"},{"post_id":"cj830jvel002pul0rn5rsfjrp","tag_id":"cj830jvfd0058ul0rwwxu4sg8","_id":"cj830jvfe005dul0rf956belh"},{"post_id":"cj830jvel002pul0rn5rsfjrp","tag_id":"cj830jve6001yul0r8745w2vq","_id":"cj830jvfe005ful0rjj8m9cgt"},{"post_id":"cj830jvel002pul0rn5rsfjrp","tag_id":"cj830jvda000eul0rx2dql1db","_id":"cj830jvfe005gul0r7swk4ekv"},{"post_id":"cj830jvem002sul0rcyo6fre3","tag_id":"cj830jvf3003uul0rwd6t3of3","_id":"cj830jvff005iul0rl9z856o6"},{"post_id":"cj830jvem002sul0rcyo6fre3","tag_id":"cj830jvfe005eul0rbhnixac2","_id":"cj830jvff005jul0rvobjqcnb"},{"post_id":"cj830jveo002uul0rb35o1gyc","tag_id":"cj830jvcz0003ul0rz3o5aflt","_id":"cj830jvff005mul0r79jd98s9"},{"post_id":"cj830jveo002uul0rb35o1gyc","tag_id":"cj830jve6001yul0r8745w2vq","_id":"cj830jvff005nul0rswub7j5h"},{"post_id":"cj830jveo002uul0rb35o1gyc","tag_id":"cj830jvfe005hul0rh0dqr1d0","_id":"cj830jvfg005pul0rwbce96ud"},{"post_id":"cj830jveo002uul0rb35o1gyc","tag_id":"cj830jvff005kul0rr7y6k9yx","_id":"cj830jvfg005qul0r90cjl89r"},{"post_id":"cj830jver002yul0r5qgtnzkg","tag_id":"cj830jvcz0003ul0rz3o5aflt","_id":"cj830jvfg005sul0rb96ukmzz"},{"post_id":"cj830jver002yul0r5qgtnzkg","tag_id":"cj830jve6001yul0r8745w2vq","_id":"cj830jvfg005tul0rajildqgc"},{"post_id":"cj830jver002yul0r5qgtnzkg","tag_id":"cj830jvfe005hul0rh0dqr1d0","_id":"cj830jvfh005vul0rdoaclx9l"},{"post_id":"cj830jver002yul0r5qgtnzkg","tag_id":"cj830jvff005kul0rr7y6k9yx","_id":"cj830jvfh005wul0rk3psheu5"},{"post_id":"cj830jvev0031ul0riebzttix","tag_id":"cj830jvcz0003ul0rz3o5aflt","_id":"cj830jvfh005yul0rqh9z6o30"},{"post_id":"cj830jvev0031ul0riebzttix","tag_id":"cj830jve6001yul0r8745w2vq","_id":"cj830jvfh005zul0ru5f3drdx"},{"post_id":"cj830jvev0031ul0riebzttix","tag_id":"cj830jvfe005hul0rh0dqr1d0","_id":"cj830jvfh0061ul0rpafnzchl"},{"post_id":"cj830jvev0031ul0riebzttix","tag_id":"cj830jvff005kul0rr7y6k9yx","_id":"cj830jvfh0062ul0rn35e07ye"},{"post_id":"cj830jvew0035ul0rxgrocc24","tag_id":"cj830jvfh005xul0rzedjen3y","_id":"cj830jvfh0064ul0r821mah3z"},{"post_id":"cj830jvew0035ul0rxgrocc24","tag_id":"cj830jvfh0060ul0r3o0wama5","_id":"cj830jvfi0065ul0r4zcmqg83"},{"post_id":"cj830jvex0037ul0r1io724r8","tag_id":"cj830jvcz0003ul0rz3o5aflt","_id":"cj830jvfi0067ul0r7hobc3ht"},{"post_id":"cj830jvex0037ul0r1io724r8","tag_id":"cj830jvfh0063ul0rrlg7mwau","_id":"cj830jvfi0068ul0rsd9cish3"},{"post_id":"cj830jvey003aul0rm731fme0","tag_id":"cj830jvf2003pul0rafw7w5j4","_id":"cj830jvfj006cul0roj58yxry"},{"post_id":"cj830jvey003aul0rm731fme0","tag_id":"cj830jvfj0069ul0rlc8itfog","_id":"cj830jvfj006dul0rsarrl2n1"},{"post_id":"cj830jvey003aul0rm731fme0","tag_id":"cj830jvfj006aul0ry2lm8mza","_id":"cj830jvfk006ful0r7jpoquil"},{"post_id":"cj830jvez003cul0r02bth2v2","tag_id":"cj830jvcz0003ul0rz3o5aflt","_id":"cj830jvfk006gul0rpifgq9em"},{"post_id":"cj830jvez003cul0r02bth2v2","tag_id":"cj830jvfj006bul0rh1f4pg9s","_id":"cj830jvfk006hul0rzssna5gm"},{"post_id":"cj830jvez003cul0r02bth2v2","tag_id":"cj830jvf40046ul0regrx3czl","_id":"cj830jvfk006iul0rop73vugk"}],"Tag":[{"name":"go","_id":"cj830jvcz0003ul0rz3o5aflt"},{"name":"mysql","_id":"cj830jvda000eul0rx2dql1db"},{"name":"react-native","_id":"cj830jvdh000qul0rtkfyadqq"},{"name":"fetch","_id":"cj830jvdn000xul0ruoso5jew"},{"name":"网络请求","_id":"cj830jvdr0015ul0rzmyxo6za"},{"name":"vps","_id":"cj830jvdw001dul0rvdsz9gbo"},{"name":"git","_id":"cj830jvdz001kul0rkuqq9jt7"},{"name":"js","_id":"cj830jve2001qul0r1xxkp0ey"},{"name":"redis","_id":"cj830jve6001yul0r8745w2vq"},{"name":"php","_id":"cj830jvea0026ul0rtm9cddyj"},{"name":"队列","_id":"cj830jvee002cul0rtg6adri3"},{"name":"crontab","_id":"cj830jveh002hul0r6ephx1ay"},{"name":"linux","_id":"cj830jvel002oul0rgf8lfbpk"},{"name":"discuz","_id":"cj830jvew0033ul0rn1g6gl3p"},{"name":"爱奇艺","_id":"cj830jvey0039ul0rb5zu68w3"},{"name":"laravel","_id":"cj830jvf1003jul0rk40443o3"},{"name":"dropbox","_id":"cj830jvf1003mul0rekvgdidg"},{"name":"hexo","_id":"cj830jvf2003pul0rafw7w5j4"},{"name":"javascript","_id":"cj830jvf3003uul0rwd6t3of3"},{"name":"ECharts","_id":"cj830jvf3003yul0r63ed9hpr"},{"name":"excel","_id":"cj830jvf40040ul0rrpe1it56"},{"name":"糗百","_id":"cj830jvf40043ul0rzj71lxa5"},{"name":"goquery","_id":"cj830jvf40046ul0regrx3czl"},{"name":"gin","_id":"cj830jvf50049ul0req5e55k7"},{"name":"标识符","_id":"cj830jvf5004gul0rd7d1nags"},{"name":"node","_id":"cj830jvf6004iul0rvt72rrtf"},{"name":"leetcode","_id":"cj830jvf6004lul0rbdq4dskf"},{"name":"rabbitmq","_id":"cj830jvf7004rul0rc9m3wlxu"},{"name":"pdo","_id":"cj830jvfd0058ul0rwwxu4sg8"},{"name":"input","_id":"cj830jvfe005eul0rbhnixac2"},{"name":"redigo","_id":"cj830jvfe005hul0rh0dqr1d0"},{"name":"geo","_id":"cj830jvff005kul0rr7y6k9yx"},{"name":"https","_id":"cj830jvfh005xul0rzedjen3y"},{"name":"ssl","_id":"cj830jvfh0060ul0r3o0wama5"},{"name":"短网址","_id":"cj830jvfh0063ul0rrlg7mwau"},{"name":"time","_id":"cj830jvfj0069ul0rlc8itfog"},{"name":"widget","_id":"cj830jvfj006aul0ry2lm8mza"},{"name":"今日头条","_id":"cj830jvfj006bul0rh1f4pg9s"}]}}