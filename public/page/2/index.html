<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  
  <title>启程</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta http-equiv="Access-Control-Allow-Origin" content="*">
  <meta name="description" content="记录写代码过程中的成长，不要把你仅知道的那一点点东西当成全世界">
<meta property="og:type" content="website">
<meta property="og:title" content="启程">
<meta property="og:url" content="http://www.qichengzx.com/page/2/index.html">
<meta property="og:site_name" content="启程">
<meta property="og:description" content="记录写代码过程中的成长，不要把你仅知道的那一点点东西当成全世界">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="启程">
<meta name="twitter:description" content="记录写代码过程中的成长，不要把你仅知道的那一点点东西当成全世界">
<meta name="twitter:creator" content="@qichengzx">
  
    <link rel="alternative" href="/atom.xml" title="启程" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">启程</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://www.qichengzx.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-php-rabbitmq-tutorial-six" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/05/03/php-rabbitmq-tutorial-six.html" class="article-date">
  <time datetime="2016-05-03T06:35:20.000Z" itemprop="datePublished">2016-05-03</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/php/">php</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/05/03/php-rabbitmq-tutorial-six.html">PHP RabbitMQ 教程（六） - 远程调用</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="远程调用">远程调用</h3><p>在<a href="/2016/04/17/php-rabbitmq-tutorial-two.html">第二节</a>中，我们学习了如何使用工作队列在多个worker中分发耗时任务。</p>
<p>但是如果我们需要在远程运行一个函数并等待返回结果怎么办？这是两码事，这个模式通常被称为远程过程调用（Remote Procedure Call，RPC）。</p>
<p>在本节中我们准备使用RabbitMQ构建一个RPC系统：一个客户端和一个可扩展的RPC服务端。由于我们没有值得分发的耗时任务，我们准备创建一个假的返回<a href="https://en.wikipedia.org/wiki/Fibonacci_number" target="_blank" rel="external">斐波那契数列</a>的RPC服务。</p>
<h3 id="客户端接口">客户端接口</h3><p>我们创建一个简单的客户端类来说明RPC服务如何使用。这个类会展示call方法如何发送一个RPC请求并且阻塞，直到接收到返回值。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$fibonacci_rpc = <span class="keyword">new</span> FibonacciRpcClient();</div><div class="line">$response = $fibonacci_rpc-&gt;call(<span class="number">30</span>);</div><div class="line"><span class="keyword">echo</span> <span class="string">"[.] Got "</span>, $response, <span class="string">"\n"</span>;</div></pre></td></tr></table></figure>
<h4 id="RPC注意事项">RPC注意事项</h4><p>尽管RPC在计算机学中很常见，但它十分挑剔。当程序员不知道是否是调用一个本地的方法还是一个很慢的RPC会出现这个问题。这样的困惑便导致不可预测的系统并增加不必要的调试复杂性。比起简化的软件，误用RPC会导致不可维护的无头绪代码。</p>
<p>记住刚才的内容，考虑下面的建议：</p>
<p>​    确保可以明显的看出哪个方法调用的是本地的哪个是远程的。</p>
<p>​    系统文档化。让组件之间的依赖变得清晰可见。</p>
<p>​    错误处理。当RPC服务长时间关闭客户端该作何反应？</p>
<p>如果有疑问，则尽量避免使用RPC。如果可以话，你应该使用异步管道——而不是RPC——像阻塞，结果被异步推送到下个计算阶段。</p>
<h3 id="回调队列">回调队列</h3><p>通常在RabbitMQ上做RPC很简单。客户端发送请求消息，服务端回复消息。为了接收响应消息，我们需要在请求中附带一个”callback”队列地址，我们可以使用默认的队列。来试一试：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">list</span>($queue_name, ,) = $channel-&gt;queue_declare(<span class="string">""</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">true</span>, <span class="keyword">false</span>);</div><div class="line"></div><div class="line">$msg = <span class="keyword">new</span> AMQPMessage(</div><div class="line">	$payload,</div><div class="line">	<span class="keyword">array</span>(<span class="string">'reply_to'</span> =&gt; $queue_name));</div><div class="line"></div><div class="line">$channel-&gt;basic_publish($msg, <span class="string">''</span>, <span class="string">'rpc_queue'</span>);</div><div class="line"></div><div class="line"><span class="comment"># ... then code to read a response message from the callback_queue</span></div></pre></td></tr></table></figure>
<h4 id="消息属性">消息属性</h4><p>AMQP协议定义了14个消息属性。大部分不常用，下面的除外：</p>
<p>​    delivery_mode：值为2时表示持久化，1为临时的。也许你还记得这个属性来自第二节。</p>
<p>​    content_type：编码格式，比如经常用的JSON格式，良好的做法是设置为：application/json。</p>
<p>​    reply_to：通常用来定义回调队列名称。</p>
<p>​    correlation_id：用来关联RPC的响应和请求。</p>
<h3 id="Correlation_Id">Correlation Id</h3><p>在上面的方法中我们建议为每一个RPC请求创建一个回调队列。这样非常低效，但是幸运的是有更好的办法 - 我们可以为每一个客户端创建一个单独的回调队列。</p>
<p>这样又带来一个新的问题，在队列接收到响应时，并不知道属于哪个请求。这也正是correlation_id属性要发挥的作用。我们为每一个请求的设定一个唯一的correlation_id值，然后，当在回调队列接收到消息时会查看它的属性，基于此，我们就可以把响应和请求进行匹配。如果发现一个未知的correlation_id值，可以安全的忽略掉这条消息 - 因为它不属于任何请求。</p>
<p>也许你会问，为什么应该忽略回调队列里的未知消息，而不是返回一个错误？因为服务可能会出现紊乱的情况，虽然不太可能，但是如果发生这种情况，RPC服务会在发送完响应后挂掉，但是还没有进行消息确认。如果发生了，重启RPC服务后会再次处理这个请求。这就是为什么在客户端我们必须适当的处理重复请求，而RPC服务最好的幂等的。</p>
<h3 id="总结">总结</h3><p><img src="/images/rabbitmq/python-six.png" alt=""></p>
<p>RPC工作流程：</p>
<p>​    当客户端开始运行时会创建一个匿名独有回调队列。</p>
<p>​    RPC请求中，客户端消息带有两个属性：reply_to用来设置回调队列，correlation_id用来唯一标识每一个请求。</p>
<p>​    请求被发送到rpc_queue队列。</p>
<p>​    RPC worker（又称worker）在队列中守护，等待新请求。当请求到达，它会进行处理，然后把结果以消息的形式发送回客户端的队列，队列名便是客户端消息带有的reply_to的值。</p>
<p>​    客户端等待回调队列中的数据。当消息到达，检查它的correlation_id的值。如果符合客户端发送给RPC服务器中请求的值，客户端会返回响应内容到应用中。</p>
<h3 id="整合">整合</h3><p>斐波那契方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">fib</span><span class="params">($n)</span></span>&#123;</div><div class="line">  <span class="keyword">if</span>($n == <span class="number">0</span>)</div><div class="line">  	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">  <span class="keyword">if</span>($n == <span class="number">1</span>)</div><div class="line">  	<span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">  <span class="keyword">return</span> fib($n<span class="number">-1</span>) + fib($n<span class="number">-2</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>定义完斐波那契方法。假定它仅接受数字类型的输入。（别期望它能处理大的数字，它很可能非常慢的处理完。）</p>
<p>RPC服务处理程序rpc_server.php：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">require_once</span> <span class="keyword">__DIR__</span> . <span class="string">'/vendor/autoload.php'</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">PhpAmqpLib</span>\<span class="title">Connection</span>\<span class="title">AMQPStreamConnection</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">PhpAmqpLib</span>\<span class="title">Message</span>\<span class="title">AMQPMessage</span>;</div><div class="line"></div><div class="line">$connection = <span class="keyword">new</span> AMQPStreamConnection(<span class="string">'localhost'</span>, <span class="number">5672</span>, <span class="string">'guest'</span>, <span class="string">'guest'</span>);</div><div class="line">$channel = $connection-&gt;channel();</div><div class="line"></div><div class="line">$channel-&gt;queue_declare(<span class="string">'rpc_queue'</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>);</div><div class="line"></div><div class="line">fuction fib($n)&#123;</div><div class="line">  <span class="keyword">if</span>($n == <span class="number">0</span>)</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">  <span class="keyword">if</span>($n == <span class="number">1</span>)</div><div class="line">    <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">  </div><div class="line">  <span class="keyword">return</span> fib($n<span class="number">-1</span>) + fib($n<span class="number">-2</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">echo</span> <span class="string">" [x] Awaiting RPC requests\n"</span>;</div><div class="line"></div><div class="line">$callback = <span class="function"><span class="keyword">function</span><span class="params">($req)</span></span>&#123;</div><div class="line">  $n = intval($req-&gt;body);</div><div class="line">  <span class="keyword">echo</span> <span class="string">" [.] fib("</span>,$n,<span class="string">")\n"</span>;</div><div class="line">  </div><div class="line">  $msg = <span class="keyword">new</span> AMQPMessage(</div><div class="line">  	(string)fib($n),</div><div class="line">    <span class="keyword">array</span>(<span class="string">'correlation_id'</span> =&gt; $req-&gt;get(<span class="string">'correlation_id'</span>))</div><div class="line">  );</div><div class="line">  </div><div class="line">  $req-&gt;delivery_info[<span class="string">'channel'</span>]-&gt;basic_publish($msg, <span class="string">''</span>, $req-&gt;get(<span class="string">'reply_to'</span>));</div><div class="line">  $req-&gt;delivery_info[<span class="string">'channel'</span>]-&gt;basic_ack($req-&gt;delivery_info[<span class="string">'delivery_tag'</span>]);</div><div class="line">&#125;;</div><div class="line"></div><div class="line">$channel-&gt;basic_qos(<span class="keyword">null</span>, <span class="number">1</span>, <span class="keyword">null</span>);</div><div class="line">$channel-&gt;basic_consume(<span class="string">'rpc_queue'</span>, <span class="string">''</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, $callback);</div><div class="line"></div><div class="line"><span class="keyword">while</span>(count($channel-&gt;callbacks))&#123;</div><div class="line">  $channel-&gt;wait();</div><div class="line">&#125;</div><div class="line"></div><div class="line">$channel-&gt;close();</div><div class="line">$connection-&gt;close();</div><div class="line"></div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
<p>服务端代码相当简单：</p>
<p>​    和以往一样我们会从创建连接，频道，和声明队列开始</p>
<p>​    也许我们想要运行更多的进程。为了在多个服务器之间负载均衡，需要在$channel.basic_qos中设置prefech_count；</p>
<p>​    我们使用basic_consume访问队列。然后进入while循环等待请求消息，处理，然后返回响应消息。</p>
<p>RPC客户端 rpc_client.php：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">require_once</span> <span class="keyword">__DIR__</span> . <span class="string">'/vendor/autoload.php'</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">PhpAmqpLib</span>\<span class="title">Connection</span>\<span class="title">AMQPStreamConnection</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">PhpAmqpLib</span>\<span class="title">Message</span>\<span class="title">AMQPMessage</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">FibonacciRpcClient</span></span>&#123;</div><div class="line">	<span class="keyword">private</span> $connection;</div><div class="line">	<span class="keyword">private</span> $channel;</div><div class="line">	<span class="keyword">private</span> $callback_queue;</div><div class="line">	<span class="keyword">private</span> $response;</div><div class="line">	<span class="keyword">private</span> $corr_id;</div><div class="line">  </div><div class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</div><div class="line">		<span class="keyword">$this</span>-&gt;connection = <span class="keyword">new</span> AMQPStreamConnection(</div><div class="line">		  <span class="string">'localhost'</span>, <span class="number">5672</span>, <span class="string">'guest'</span>, <span class="string">'guest'</span></div><div class="line">		);</div><div class="line">		<span class="keyword">$this</span>-&gt;channel = <span class="keyword">$this</span>-&gt;connection-&gt;channel();</div><div class="line">		<span class="keyword">list</span>(<span class="keyword">$this</span>-&gt;callback_queue, ,) = <span class="keyword">$this</span>-&gt;channel-&gt;queue_declare(<span class="string">""</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">true</span>, <span class="keyword">false</span>);</div><div class="line">		<span class="keyword">$this</span>-&gt;channel-&gt;basic_consume(</div><div class="line">			<span class="keyword">$this</span>-&gt;callback_queue, <span class="string">''</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>,</div><div class="line">			<span class="keyword">array</span>(<span class="keyword">$this</span>, <span class="string">'on_response'</span>));</div><div class="line">	&#125;</div><div class="line">  </div><div class="line"> 	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">on_response</span><span class="params">($req)</span></span>&#123;</div><div class="line"> 		<span class="keyword">if</span>($req-&gt;get(<span class="string">'correlation_id'</span>) == <span class="keyword">$this</span>-&gt;corr_id)&#123;</div><div class="line"> 			<span class="keyword">$this</span>-&gt;response = $req-&gt;body;</div><div class="line"> 		&#125;</div><div class="line"> 	&#125;</div><div class="line">  	</div><div class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">call</span><span class="params">($n)</span></span>&#123;</div><div class="line">		<span class="keyword">$this</span>-&gt;response = <span class="keyword">null</span>;</div><div class="line">		<span class="keyword">$this</span>-&gt;corr_id = uniqid();</div><div class="line"></div><div class="line">		$msg = <span class="keyword">new</span> AMQPMessage(</div><div class="line">  		(string) $n,</div><div class="line">  		<span class="keyword">array</span>(</div><div class="line">  			<span class="string">'correlation_id'</span> =&gt; <span class="keyword">$this</span>-&gt;corr_id,</div><div class="line">  			<span class="string">'reply_to'</span> =&gt; <span class="keyword">$this</span>-&gt;callback_queue)</div><div class="line">  		);</div><div class="line">    )</div><div class="line">      </div><div class="line">    <span class="keyword">$this</span>-&gt;channel-&gt;basic_publish($msg, <span class="string">''</span>, <span class="string">'rpc_queue'</span>);</div><div class="line">    <span class="keyword">while</span>(!<span class="keyword">$this</span>-&gt;response)&#123;</div><div class="line">    	<span class="keyword">$this</span>-&gt;channel-&gt;wait();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> intval(<span class="keyword">$this</span>-&gt;response);</div><div class="line">  &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">$fibonacci_rpc = <span class="keyword">new</span> FibonacciRpcClient();</div><div class="line">$response = $fibonacci_rpc-&gt;call(<span class="number">30</span>);</div><div class="line"><span class="keyword">echo</span> <span class="string">" [.] Got "</span>, $response, <span class="string">"\n"</span>;</div><div class="line"></div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
<p>现在可以查看示例的完整代码了。<a href="https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/php/rpc_client.php" target="_blank" rel="external">rpc_client.php</a> 和 <a href="https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/php/rpc_server.php" target="_blank" rel="external">rpc_server.php</a>。</p>
<p>现在RPC服务端可以运行了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">php rpc_server.php</div><div class="line">[x] Awiting RPC resquests</div></pre></td></tr></table></figure>
<p>接收斐波那契数列运行：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">php</span> <span class="selector-tag">rpc_client</span><span class="selector-class">.php</span></div><div class="line"><span class="selector-attr">[x]</span> <span class="selector-tag">Requesting</span> <span class="selector-tag">fib</span>(30)</div></pre></td></tr></table></figure>
<p>这里展现的并不是RPC服务的唯一可能实现，但它有一些重要的优势：</p>
<p>​    如果RPC服务太慢，可以按比例增加运行数量。试试在新控制台裕兴第二个rpc_server.php服务。</p>
<p>​    在客户端，RPC要求只发送和接收一条消息。不能有像队列声明一样的异步调用。结果就是，对于单一的RPC请求，客户端仅需要一个网络往返。</p>
<p>现在的代码还是过于简单，并没有想解决更复杂（更重要）的问题，比如：</p>
<p>​    要是没有服务端守护运行，客户端作何反应？</p>
<p>​    RPC客户端是否需要设置超时？</p>
<p>​    如果服务端引发异常，是否该把它发送到客户端？</p>
<p>​    处理前阻止无效消息（如检查范围，类型）进入？</p>
<p>如果想尝试，可以在<a href="https://www.rabbitmq.com/plugins.html" target="_blank" rel="external">rabbitmq-management</a> 里找到一些有用的查看队列的插件。</p>
<p>原文地址：<a href="https://www.rabbitmq.com/tutorials/tutorial-six-php.html" target="_blank" rel="external">Remote procedure call (RPC)</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.qichengzx.com/2016/05/03/php-rabbitmq-tutorial-six.html" data-id="ciwt84yak0020hw0rj80bxj6q" class="article-share-link">Share</a>
      
        <a href="http://www.qichengzx.com/2016/05/03/php-rabbitmq-tutorial-six.html#comments" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/php/">php</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/rabbitmq/">rabbitmq</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-php-rabbitmq-tutorial-five" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/04/27/php-rabbitmq-tutorial-five.html" class="article-date">
  <time datetime="2016-04-27T10:27:03.000Z" itemprop="datePublished">2016-04-27</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/php/">php</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/04/27/php-rabbitmq-tutorial-five.html">PHP RabbitMQ 教程（五） - 主题</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="主题">主题</h3><p>(<a href="https://github.com/php-amqplib/php-amqplib" target="_blank" rel="external">使用php-amqplib</a>)</p>
<p>在<a href="/2016/04/24/php-rabbitmq-tutorial-four.html">上一节</a>我们改善了日志系统(logging system，以下简称日志系统)，为了替代fanout类型的交换器，我们使用了一个direct类型的交换器，带来的好处是可以有选择的接收日志。</p>
<p>虽然使用direct交换器改善了系统，但是仍然有局限性 - 它不能根据多个条件进行路由。</p>
<p>在日志系统中，我们也许不仅仅想订阅严重等级的日志，也想订阅基于消息发布源的内容。也许你已经知道这个概念来自于UNIX的<a href="http://en.wikipedia.org/wiki/Syslog" target="_blank" rel="external">syslog</a>工具，基于严重性(info/warn/crit…)和设备路由日志(auth/cron/kern…)的工具。</p>
<p>这可以提高灵活性 - 我们也许只想要监听来自’cron’的关键错误而不是来自’kern’的全部日志。</p>
<p>为了在我们的日志系统上实现这个功能，需要学习一个更复杂的 topic 交换器。</p>
<h3 id="Topic_交换器">Topic 交换器</h3><p>发送到 topic 交换器的消息不能随意设置 routing_key - 它必须是一个单词列表，以’.’分隔。单词可以是任何内容，但是通常会具体说明消息的功能。一些有效的routing key示例：样：”stock.usd.nyse”，”nyse.vmw”，”quick.orange.rabbit”。routing key 可以是任何长度的你喜欢的单词，最大255个字节。</p>
<p>binding key 也必须是同样的格式，topic交换器的逻辑和direct交换器类似 - 带有特定routing key的消息会被派发到所有绑定了binding key的队列，然而对于binding key依然有两个重要的特殊情况：</p>
<pre><code>*可以代替一个单词

<span class="preprocessor">#可以代替<span class="number">0</span>个或多个单词</span>
</code></pre><p>下图比较好的解释了这个情况：</p>
<p><img src="/images/rabbitmq/python-five.png" alt="">    </p>
<p>在这个例子中，我们准备全部发送描述动物的消息。这些消息带有由三个单词(两个点号分隔)组成的routing key，其中第一个单词表示速度，第二个表示颜色，第三个表示种类：”<speed>.<colour>.<species>“。</species></colour></speed></p>
<p>我们创建三个绑定：Q1的binding key为”*.orange”，Q2的binding key为”*.*.rabbit”和”lazy.#“。</p>
<p>这些绑定可以概括为：</p>
<pre><code>Q1 关注所有orange的动物

Q2 想知道所有关于兔子（rabbits）和懒惰动物（<span class="keyword">lazy</span> animals）的消息。
</code></pre><p>routing key为”quick.orange.rabbit”的消息会被发送到两个队列，”lazy.orange.elephant”也会被发送到这两个队列。而”quick.orange.fox”则只会发送到第一个队列，”lazy.brown.fox”会被只发送到第二个队列。”lazy.pink.rabbit”会只被发送到第二个队列一次，即使它匹配两个绑定。”quick.brown.fox”不匹配任何绑定，所以会被丢弃。</p>
<p>如果打破规则，发送一条带有一个或四个单词，如”orange”或”quick.orange.male.rabbit”会怎么样？好吧，消息会丢失，因为它不匹配任何一个绑定。</p>
<p>但是，”lazy.orange.male.rabbit”这种消息，即使它有4个单词，依然会匹配最后一个绑定，然后被发送到第二个队列。</p>
<h4 id="topic_交换器">topic 交换器</h4><figure class="highlight maxima"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">topic 交换器非常强大，可以表现得跟其他交换器一样。</div><div class="line"></div><div class="line">当一个队列的binding <span class="built_in">key</span>为<span class="string">"#"</span>时，它会接收所有消息，忽略routing <span class="built_in">key</span>，像fanout交换器一样。</div><div class="line"></div><div class="line">当绑定中不存在<span class="string">"*"</span>和<span class="string">"#"</span>时，topic交换器会表现的跟<span class="built_in">direct</span>交换器一样。</div></pre></td></tr></table></figure>
<h3 id="整合">整合</h3><p>我们准备在日志系统中使用topic交换器。假定日志的routing key由两个单词：”<facility>.<severity>“组成。</severity></facility></p>
<p>代码与上一节的几乎一致。</p>
<p>emit_log_topic.php：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">require_once</span> <span class="keyword">__DIR__</span> . <span class="string">'/vendor/autoload.php'</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">PhpAmqpLib</span>\<span class="title">Connection</span>\<span class="title">AMQPStreamConnection</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">PhpAmqpLib</span>\<span class="title">Message</span>\<span class="title">AMQPMessage</span>;</div><div class="line"></div><div class="line">$connection = <span class="keyword">new</span> AMQPStreamConnection(<span class="string">'localhost'</span>, <span class="number">5672</span>, <span class="string">'guest'</span>, <span class="string">'guest'</span>);</div><div class="line">$channel = $connection-&gt;channel();</div><div class="line"></div><div class="line">$channel-&gt;exchange_declare(<span class="string">'topic_logs'</span>, <span class="string">'topic'</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>);</div><div class="line"></div><div class="line">$routing_key = <span class="keyword">isset</span>($argv[<span class="number">1</span>]) &amp;&amp; !<span class="keyword">empty</span>($argv[<span class="number">1</span>]) ? $argv[<span class="number">1</span>] : <span class="string">'anonymous.info'</span>;</div><div class="line">$data = implode(<span class="string">' '</span>, array_slice($agrv, <span class="number">2</span>));</div><div class="line"><span class="keyword">if</span>(<span class="keyword">empty</span>($data)) $data = <span class="string">"Hello Wrold!"</span>;</div><div class="line"></div><div class="line">$msg = <span class="keyword">new</span> AMQPMessage($data);</div><div class="line"></div><div class="line">$channel-&gt;basic_publish($msg, <span class="string">'topic_logs'</span>, $routing_key);</div><div class="line"></div><div class="line"><span class="keyword">echo</span> <span class="string">" [x] Sent "</span>,$routing_key,<span class="string">':'</span>,$data,<span class="string">" \n"</span>;</div><div class="line"></div><div class="line">$channel-&gt;close();</div><div class="line">$connection-&gt;close();</div><div class="line"></div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
<p>receive_logs_topic.php：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">require_once</span> <span class="keyword">__DIR__</span> . <span class="string">'/vendor/autoload.php'</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">PhpAmqpLib</span>\<span class="title">Connection</span>\<span class="title">AMQPStreamConnection</span>;</div><div class="line"></div><div class="line">$connection = <span class="keyword">new</span> AMQPStreamConnection(<span class="string">'localhost'</span>, <span class="number">5672</span>, <span class="string">'guest'</span>, <span class="string">'guest'</span>);</div><div class="line">$channel = $connection-&gt;channel();</div><div class="line"></div><div class="line">$channel-&gt;exchange_declare(<span class="string">'topic_logs'</span>, <span class="string">'topic'</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>);</div><div class="line"></div><div class="line"><span class="keyword">list</span>($queue_name, ,) = $channel-&gt;queue_declare(<span class="string">""</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">true</span>, <span class="keyword">false</span>);</div><div class="line"></div><div class="line">$binding_keys = array_slice($argv, <span class="number">1</span>);</div><div class="line"><span class="keyword">if</span>( <span class="keyword">empty</span>($binding_keys) )&#123;</div><div class="line">  file_put_contents(<span class="string">'php://stderr'</span>, <span class="string">"Usage: $argv[0] [binding_key]\n"</span>);</div><div class="line">  <span class="keyword">exit</span>(<span class="number">1</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">foreach</span>($binding_keys <span class="keyword">as</span> $binding_key)&#123;</div><div class="line">  $channel-&gt;queue_bind($queue_name, <span class="string">'topic_logs'</span>, $binding_key);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">echo</span> <span class="string">' [*] Waiting for logs. To exit press CTRL+C'</span>, <span class="string">"\n"</span>;</div><div class="line"></div><div class="line">$callback = <span class="function"><span class="keyword">function</span><span class="params">($msg)</span></span>&#123;</div><div class="line">  <span class="keyword">echo</span> <span class="string">' [*] '</span>,$msg-&gt;delivery_info[<span class="string">'routing_key'</span>], <span class="string">':'</span>, $msg-&gt;body, <span class="string">"\n"</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">$channel-&gt;basic_consume($queue_name, <span class="string">''</span>, <span class="keyword">false</span>, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, $callback);</div><div class="line"></div><div class="line"><span class="keyword">while</span>(count($channel-&gt;callbacks))&#123;</div><div class="line">  $channel-&gt;wait();</div><div class="line">&#125;</div><div class="line"></div><div class="line">$channel-&gt;close();</div><div class="line">$connection-&gt;close();</div><div class="line"></div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
<p>接收所有日志：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">php receive_logs_topic<span class="selector-class">.php</span> <span class="string">'#'</span></div></pre></td></tr></table></figure>
<p>接收所有来自”kern”的日志：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">php receive_logs_topic<span class="selector-class">.php</span> <span class="string">"kern.*"</span></div></pre></td></tr></table></figure>
<p>只接收”致命(critical)”日志：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">php receive_logs_topic.php &quot;*.critical&quot;</div></pre></td></tr></table></figure>
<p>创建多个绑定：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">php receive_logs_topic.php &quot;kern.*&quot; &quot;*.critical&quot;</div></pre></td></tr></table></figure>
<p>发布routing key为”kern.critical”的日志就输入：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">php emit_log_topic.php &quot;kern.critical&quot; &quot;A critical kernel error&quot;</div></pre></td></tr></table></figure>
<p>注意此代码并没有做路由或捆绑的例子，也许你想试一下两个以上的routing key参数。</p>
<p>一些问题：</p>
<p>​    <a href="http://www.rabbitmq.com/tutorials/tutorial-five-php.html#teaser_answer_1" target="_blank" rel="external">“*”会匹配routing key为空的消息吗？</a></p>
<p>​    <a href="http://www.rabbitmq.com/tutorials/tutorial-five-php.html#teaser_answer_2" target="_blank" rel="external">“#.*”会匹配内容为”..”的消息吗？会匹配一个单词的消息吗？</a></p>
<p>​    <a href="http://www.rabbitmq.com/tutorials/tutorial-five-php.html#teaser_answer_3" target="_blank" rel="external">“a.*.#”和”a.#”的区别是什么？</a></p>
<p><a href="https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/php/emit_log_topic.php" target="_blank" rel="external">emit_log_topic.php完整代码</a> <a href="https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/php/receive_logs_topic.php" target="_blank" rel="external">receive_logs_topic.php完整代码</a></p>
<p>下一步，在第六节中学习像远程过程调用一样完成消息往返。</p>
<p>原文地址：<a href="https://www.rabbitmq.com/tutorials/tutorial-five-php.html" target="_blank" rel="external">Topics</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.qichengzx.com/2016/04/27/php-rabbitmq-tutorial-five.html" data-id="ciwt84yaf001qhw0r9koxknmq" class="article-share-link">Share</a>
      
        <a href="http://www.qichengzx.com/2016/04/27/php-rabbitmq-tutorial-five.html#comments" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/php/">php</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/rabbitmq/">rabbitmq</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-php-rabbitmq-tutorial-four" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/04/24/php-rabbitmq-tutorial-four.html" class="article-date">
  <time datetime="2016-04-24T06:16:41.000Z" itemprop="datePublished">2016-04-24</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/php/">php</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/04/24/php-rabbitmq-tutorial-four.html">PHP RabbitMQ 教程（四） - 路由</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="路由">路由</h3><p>（使用<a href="https://github.com/php-amqplib/php-amqplib" target="_blank" rel="external">php-amqplib</a>）<br>在<a href="/2016/04/23/php-rabbitmq-tutorial-three.html">上一节</a>中，我们创建了一个简单的日志系统（logging system）。我们已经可以广播日志消息到多个接收者了。</p>
<p>在本节中，我们要给它增加一个功能-使它能够只订阅消息的一个子集。比如，只把严重的错误信息写入到日志文件（存储到磁盘）中，但同时仍然会把所有日志信息输出到控制台中。</p>
<h3 id="绑定">绑定</h3><p>在上一节中我们已经创建了绑定（bindings），代码如下：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$channel</span>-&gt;queue_bind(<span class="variable">$queue_name</span>,<span class="string">'logs'</span>);</div></pre></td></tr></table></figure>
<p>绑定（bindings）是指交换器（exchange）和队列（queue）的关系。可以简单的理解为：这个队列对这个交换器中的消息感兴趣。</p>
<p>绑定的时候可以带一个额外的 routing_key 参数。为了避免与$channel::basic_publish的参数混淆，我们把它叫做 binding_key，所以我们这样使用key创建一个绑定：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$binding_key</span> = <span class="string">'black'</span>;</div><div class="line"><span class="variable">$channel</span>-&gt;queue_bind(<span class="variable">$queue_name</span>,<span class="variable">$exchange_name</span>,<span class="variable">$binding_key</span>);</div></pre></td></tr></table></figure>
<p>binding key的意义取决于交换器的类型。我们之前使用过的fanout类型的交换器，会忽略这个值。</p>
<h3 id="Direct_交换器">Direct 交换器</h3><p>之前创建的日志系统分发所有消息到所有的消费者。我们打算扩展一下，使它可以过滤严重的消息。比如，我们只想在接收到严重错误的时候才写入到磁盘中，不在警告或普通的消息上浪费磁盘空间。</p>
<p>我们使用的是没有太多扩展性的fanout交换器，它仅能够简单的广播消息。</p>
<p>我们将要使用一个direct交换器代替fanout交换器。路由算法很简单-只有binding key完全匹配routing key的消息会进入队列。</p>
<p>为了说明，考虑如下的场景：</p>
<p><img src="/images/rabbitmq/direct-exchange.png" alt=""></p>
<p>在这个场景中，我们可以看到direct类型的交换器X有两个队列，第一个队列使用orange作为binding key，第二个队列有两个绑定，一个是black另一个是green。</p>
<p>在这个场景中，当routing key为orange的消息发送到交换器，将会被路由到队列Q1。routing key为black或green的消息将会发送到Q2。其他的消息则会被丢弃。</p>
<h3 id="多个绑定">多个绑定</h3><p><img src="/images/rabbitmq/direct-exchange-multiple.png" alt=""></p>
<p>使用相同的binding key绑定多个队列是合法的。在这个例子中，我们会使用black作为binding key为X和Q1之间添加一个绑定。这样一来，direct 交换器就表现得跟fanout交换器一样，分发消息到匹配的队列。routing key为black的消息就会被分发到Q1和Q2。</p>
<h3 id="发送日志">发送日志</h3><p>我们将要对日志系统使用这个模型，我们将要发送消息到一个direct交换器。将日志级别作为routing key。这样一来接收端程序就可以选择它想要接收的消息了。首先来看看发送日志。</p>
<p>和以往一样，需要创建一个交换器：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$channel</span>-&gt;exchange_declare(<span class="string">'direct_logs'</span>,<span class="string">'direct'</span>,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">false</span>);</div></pre></td></tr></table></figure>
<p>然后准备发送消息：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$channel</span>-&gt;exchange_declare(<span class="string">'direct_logs'</span>,<span class="string">'direct'</span>,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">false</span>);</div><div class="line"><span class="variable">$channel</span>-&gt;basic_publish(<span class="variable">$msg</span>,<span class="string">'direct_logs'</span>,<span class="variable">$severity</span>);</div></pre></td></tr></table></figure>
<p>为了简化，我们可以假定’severity’的值可以是’info’,’warning’,’error’中的一个。</p>
<h3 id="订阅">订阅</h3><p>接收消息的脚本会跟之前一样正常工作，但是我们准备为每一个我们感兴趣的日志级别创建一个新的绑定。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">foreach</span>($severities <span class="keyword">as</span> $severity)&#123;</div><div class="line">	$channel-&gt;queue_bind($queue_name,<span class="string">'direct_logs'</span>,$severity);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="整合">整合</h3><p><img src="/images/rabbitmq/python-four.png" alt=""></p>
<p>emit_log_direct.php类的代码为：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"><span class="keyword">require_once</span> <span class="keyword">__DIR__</span> . <span class="string">'/vendor/autoload.php'</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">PhpAmqpLib</span>\<span class="title">Connection</span>\<span class="title">AMQPStreamConnection</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">PhpAmqpLib</span>\<span class="title">Message</span>\<span class="title">AMQPMessage</span>;</div><div class="line"></div><div class="line">$connection = <span class="keyword">new</span> AMQPStremConnection(<span class="string">'localhost'</span>,<span class="number">5672</span>,<span class="string">'guest'</span>,<span class="string">'guest'</span>);</div><div class="line">$channel = $connection-&gt;channel();</div><div class="line"></div><div class="line">$channel-&gt;exchange_declare(<span class="string">'direct_logs'</span>,<span class="string">'direct'</span>,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">false</span>);</div><div class="line"></div><div class="line">$severity = <span class="keyword">isset</span>($argv[<span class="number">1</span>]) &amp;&amp; !<span class="keyword">empty</span>($argv[<span class="number">1</span>]) ? $argv[<span class="number">1</span>] : <span class="string">'info'</span>;</div><div class="line"></div><div class="line">$data = implode(<span class="string">' '</span>,array_slice($argv,<span class="number">2</span>));</div><div class="line"><span class="keyword">if</span>(<span class="keyword">empty</span>($data)) $data = “Hello World!”;</div><div class="line"></div><div class="line">$msg = “[x] Sent ”,$severity,<span class="string">':'</span>,$data,” \n”;</div><div class="line"></div><div class="line">$channel-&gt;close();</div><div class="line">$connection-&gt;close();</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
<p>receive_logs_direct.php的代码为：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">require_once</span> <span class="keyword">__DIR__</span> . <span class="string">'/vendor/autoload.php'</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">PhpAmqpLib</span>\<span class="title">Connection</span>\<span class="title">AMQPStreamConnection</span>;</div><div class="line"></div><div class="line">$connection = <span class="keyword">new</span> AMQPStreamConnection(<span class="string">'localhost'</span>,<span class="number">5672</span>,<span class="string">'guest'</span>,<span class="string">'guest'</span>);</div><div class="line">$channel = $connection-&gt;channel();</div><div class="line"></div><div class="line">$channel-&gt;exchange_declare(<span class="string">'direct_logs'</span>,<span class="string">'direct'</span>,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">false</span>);</div><div class="line"></div><div class="line"><span class="keyword">list</span>($queue_name, ,) = $channel-&gt;queue_declare(“”,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">true</span>,<span class="keyword">false</span>);</div><div class="line"></div><div class="line">$severities = array_slice($argv,<span class="number">1</span>);</div><div class="line"><span class="keyword">if</span>(<span class="keyword">empty</span>($severities))&#123;</div><div class="line">	file_put_contents(<span class="string">'php://stderr'</span>,”Usage:$argv[<span class="number">0</span>][info][warning][error]\n”);</div><div class="line">	<span class="keyword">exit</span>(<span class="number">1</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">foreach</span>($severities <span class="keyword">as</span> $severity)&#123;</div><div class="line">	$channel-&gt;queue_bind($queue_name,<span class="string">'direct_logs'</span>,$severity);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">echo</span> <span class="string">'[*]Waiting for logs.To exit press CTRL+C'</span>,”\n”;</div><div class="line"></div><div class="line">$callback = <span class="function"><span class="keyword">function</span><span class="params">($msg)</span></span>&#123;</div><div class="line">	<span class="keyword">echo</span> <span class="string">'[*]'</span>,$msg-&gt;delivery_info[<span class="string">'routing_key'</span>],<span class="string">':'</span>,$msg-&gt;body,”\n”;	</div><div class="line">&#125;;</div><div class="line"></div><div class="line">$channel-&gt;basic_consume($queue_name,<span class="string">''</span>,<span class="keyword">false</span>,<span class="keyword">true</span>,<span class="keyword">false</span>,<span class="keyword">false</span>,$callback);</div><div class="line"></div><div class="line"><span class="keyword">while</span>(count($channel-&gt;callbacks))&#123;</div><div class="line">	$channel-&gt;wait();</div><div class="line">&#125;</div><div class="line"></div><div class="line">$channel-&gt;close();</div><div class="line">$connection-&gt;close();</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
<p>如果你想只保存’warning’或’error’（而不是’info’）级别的消息，只需要打开命令行输入：</p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">php receive_logs_direct.php <span class="keyword">warning</span> <span class="keyword">error</span> &gt; logs_from_rabbit.<span class="keyword">log</span></div></pre></td></tr></table></figure>
<p>如果你想在屏幕上输出所有的消息，打开一个新的终端，输入：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">php receive_logs_direct.php info warning error</div><div class="line">[*]Waiting <span class="keyword">for</span> logs.To <span class="keyword">exit</span> press CTRL+C</div></pre></td></tr></table></figure>
<p>例如，发送error消息，输入：</p>
<figure class="highlight gauss"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">php emit_log_direct.php <span class="built_in">error</span> <span class="string">"Run. Run. Or it will explode."</span></div><div class="line">[x] Sent '<span class="built_in">error</span>':'<span class="keyword">Run</span>. <span class="keyword">Run</span>. <span class="keyword">Or</span> it will explode.'</div></pre></td></tr></table></figure>
<p><a href="https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/php/emit_log_direct.php" target="_blank" rel="external">emit_log_direct.php源码</a>  <a href="https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/php/receive_logs_direct.php" target="_blank" rel="external">receive_logs_direct.php源码</a></p>
<p>转到第五节，查看如何监听基于模式的消息。</p>
<p>原文地址：<a href="https://www.rabbitmq.com/tutorials/tutorial-four-php.html" target="_blank" rel="external">Routing</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.qichengzx.com/2016/04/24/php-rabbitmq-tutorial-four.html" data-id="ciwt84yag001thw0rhm7tl7sc" class="article-share-link">Share</a>
      
        <a href="http://www.qichengzx.com/2016/04/24/php-rabbitmq-tutorial-four.html#comments" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/php/">php</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/rabbitmq/">rabbitmq</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-php-rabbitmq-tutorial-three" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/04/23/php-rabbitmq-tutorial-three.html" class="article-date">
  <time datetime="2016-04-23T11:58:17.000Z" itemprop="datePublished">2016-04-23</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/php/">php</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/04/23/php-rabbitmq-tutorial-three.html">PHP RabbitMQ 教程（三） - 发布/订阅</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="发布/订阅">发布/订阅</h3><p>我们在<a href="/2016/04/17/php-rabbitmq-tutorial-two.html">上一节</a>创建了一个工作队列，并假定队列对应的任务传送给了某个客户端。在这一章节我们会做一些完全不一样的东西–我们会发送一条消息到多个消费者，也称之为“发布/订阅”模式。</p>
<p>为了说明这个模式，我们会创建一个简单的日志系统（logging system，以下简称日志系统），它由两个程序组成–第一个是发送日志信息，第二个是接收日志并打印。</p>
<p>日志系统的每一个运行的接收端程序都会接收信息，这样就可以运行一个接收端就把日志保存到硬盘里，同时运行另一个接收端去实时显示日志到屏幕。</p>
<p>本质上，日志内容是广播给所有的接收端的。</p>
<h3 id="交换器">交换器</h3><p>在之前的章节中我们从一个队列里发送和接收消息，现在该把完整的RabbitMQ消息模型介绍给大家了。</p>
<p>让我们快速的回看一遍在之前的章节中的内容：</p>
<pre><code>&gt;生产者是一个用来发送消息的程序

&gt;队列是一个存储消息的缓冲区

&gt;消费者是一个接收消息的程序
</code></pre><p>RabbitMQ消息模型的核心思想是，生产者永远不会直接发送给任何消息队列，实际上，生产者一般情况下甚至不知道消息应该发送给哪个队列。</p>
<p>生产者只能发送消息到交换器中，交换器非常简单。一方面从生产者接收消息，另一方面把消息推送到队列中。交换器必须知道如何处理接收到的消息，是推送到某个队列？推送到多个队列？还是丢弃这条消息。这个规则通过交换器类型(exchange type)来指定。</p>
<p><img src="/images/rabbitmq/exchanges.png" alt=""></p>
<p>这里是交换器的几个类型：direct,topic,headers,fanout。这里我们主要关注最后一个–fanout，创建一个类型为 fanout 的交换器，命名为 logs。</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$channel</span>-&gt;exchange_declare(<span class="string">'logs'</span>,<span class="string">'fanout'</span>,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">false</span>);</div></pre></td></tr></table></figure>
<p>fanout交换器非常简单，你可以从名称中猜出它的功能，它把所有接收到的消息广播给所有它知道的队列，这也正是我们的日志系统需要的功能。</p>
<h4 id="列出交换器">列出交换器</h4><p>可以使用rabbitmqctl 命令列出服务器上的所有交换器：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">sudo rabbitmqctl list_exchanges</div><div class="line"></div><div class="line">Listing exchanges ...</div><div class="line">        direct</div><div class="line">amq<span class="selector-class">.direct</span>      direct</div><div class="line">amq<span class="selector-class">.fanout</span>      fanout</div><div class="line">amq<span class="selector-class">.headers</span>     headers</div><div class="line">amq<span class="selector-class">.match</span>       headers</div><div class="line">amq<span class="selector-class">.rabbitmq</span><span class="selector-class">.log</span>        topic</div><div class="line">amq<span class="selector-class">.rabbitmq</span><span class="selector-class">.trace</span>      topic</div><div class="line">amq<span class="selector-class">.topic</span>       topic</div><div class="line">logs    fanout</div><div class="line">..<span class="selector-class">.done</span>.</div></pre></td></tr></table></figure>
<p>结果中有一些amq.*和一些未命名的交换器，这是一些默认创建的交换器，它们不太可能是现在需要用到的。</p>
<h4 id="未命名交换器">未命名交换器</h4><p>在之前的章节中我们对交换器一无所知，直到可以发送消息给队列。大概是因为我们当时正在使用一个以空字符串“”定义的默认的交换器。</p>
<p>回想一下之前怎么发布消息：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$channel</span>-&gt;basic_publish(<span class="variable">$msg</span>,<span class="string">''</span>,<span class="string">'hello'</span>);</div></pre></td></tr></table></figure>
<p>这里就是使用默认或者说未命名的交换器：消息被routing_key的值<br>Here we use the default or nameless exchange: messages are routed to the queue with the name specified by routing_key, if it exists. The routing key is the second argument to basic_publish</p>
<p>现在，可以发布消息到这个队列。</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$channel</span>-&gt;exchange_declare(<span class="string">'logs'</span>,<span class="string">'fanout'</span>,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">false</span>);</div><div class="line"><span class="variable">$channel</span>-&gt;basic_publish(<span class="variable">$msg</span>,<span class="string">'logs'</span>);</div></pre></td></tr></table></figure>
<h3 id="临时队列">临时队列</h3><p>也许你还记得在之前我们使用了一个指定的队列（还记得 hello 队列 和 task_queue 队列吗？）。可以命名一个队列是至关重要的–我们需要指定一个worker到同一个队列。当想让生产者和消费者使用同一个队列时给队列命名是非常重要的。</p>
<p>但是在我们的日志系统中情况不同了，我们想要接收所有的消息，不仅仅是其中的一部分，我们关心的是最新的消息而不是旧的，因此需要做两件事。</p>
<p>首先，当连接到RabbitMQ时，需要一个空的队列，可以手动创建一个名字随机的队列，或者，更好的办法是，让服务器为我们随机选一个队列名字。</p>
<p>其次，一旦与消费者失去连接，队列需要自动删除。</p>
<p>在<a href="https://github.com/php-amqplib/php-amqplib" target="_blank" rel="external">php-amqplib</a>中，当我们创建了一个名字为空的队列时，实际上是创建了一个被生成了名字的非持久化的队列。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">list</span>($queue_name, ,) = $channel-&gt;queue_declare(<span class="string">""</span>);</div></pre></td></tr></table></figure>
<p>方法执行后，$queue_name变量包含了一个RabbitMQ生成的字符串。比如也许是这样的：amq.gen-JzTY20BRgKO-HjmUJj0wLg。</p>
<p>当连接被关闭的时候，队列也会被删掉，因为队列是独有的。</p>
<h3 id="绑定(Bindlings)">绑定(Bindlings)</h3><p><img src="/images/rabbitmq/bindings.png" alt=""></p>
<p>我们已经创建了一个fanout类型的交换器和一个队列。现在需要让交换器发送消息给队列。交换器和队列之间的关系称之为绑定(binding)</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$channel</span>-&gt;queue_bind(<span class="variable">$queue_name</span>,<span class="string">'logs'</span>);</div></pre></td></tr></table></figure>
<p>现在开始，logs 交换器会把消息附加到队列中。</p>
<h4 id="列出绑定（Listing_bindings）">列出绑定（Listing bindings）</h4><p>可以使用 rabbitmqctl list_bindings列出所有存在的正在使用的绑定。</p>
<h3 id="整合">整合</h3><p><img src="/images/rabbitmq/python-three-overall.png" alt=""></p>
<p>发送日志消息的生产者，与之前的代码看起来没什么不同，最重要的变化是现在想要发送消息到我们的 logs 交换器中，需要在发送时提供一个routing_key，但是在 fanout类型的交换器中这个值是可以忽略的。下边是emit_log.php的代码。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">require_once</span> <span class="keyword">__DIR__</span> .<span class="string">'/verdor/autoload.php'</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">PhpAmqpLib</span>\<span class="title">Connection</span>\<span class="title">AMQPStreamConnection</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">PhpAmqpLib</span>\<span class="title">Message</span>\<span class="title">AMQPMessage</span>;</div><div class="line"></div><div class="line">$connection = <span class="keyword">new</span> AMQPStreamConnection(<span class="string">'localhost'</span>,<span class="number">5672</span>,<span class="string">'guest'</span>,<span class="string">'guest'</span>);</div><div class="line">$channel = $channel-&gt;channel();</div><div class="line"></div><div class="line">$channel-&gt;exchange_declare(<span class="string">'logs'</span>,<span class="string">'fanout'</span>,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">false</span>);</div><div class="line"></div><div class="line">$data = implode(<span class="string">' '</span>,array_slice($argv,<span class="number">1</span>));</div><div class="line"></div><div class="line"><span class="keyword">if</span>(<span class="keyword">empty</span>($data)) $data = <span class="string">"info:Hello World"</span>;</div><div class="line">$msg = <span class="keyword">new</span> AMQPMessage($data);</div><div class="line"></div><div class="line">$channel-&gt;basic_publish($msg,<span class="string">'logs'</span>);</div><div class="line"></div><div class="line"><span class="keyword">echo</span> <span class="string">"[x]Sent "</span>,$data,<span class="string">"\n"</span>;</div><div class="line"></div><div class="line">$channel-&gt;close();</div><div class="line">$connection-&gt;close();</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
<p>(<a href="https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/php/emit_log.php" target="_blank" rel="external">emit_log.php</a>)</p>
<p>如你所见，建立连接后声明了交换器，这一步是必须的，因为发送消息到一个不存在的交换器是被禁止的。</p>
<p>如果还没有队列绑定到交换器，信息会丢失，但是这对于我们是可以的，如果没有消费者监听，我们可以安全的丢弃消息。</p>
<p>receive_logs.php：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">require_once</span> <span class="keyword">__DIR__</span> .<span class="string">'/vendor/autoload.php'</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">PhpAmqpLib</span>\<span class="title">Connection</span>\<span class="title">QMAPStreamConnection</span>;</div><div class="line"></div><div class="line">$connection = <span class="keyword">new</span> AMQPStreamConnection(<span class="string">'localhost'</span>,<span class="number">5672</span>,<span class="string">'guest'</span>,<span class="string">'guest'</span>);</div><div class="line">$channel = $connection-&gt;channel();</div><div class="line"></div><div class="line">$channel-&gt;queue_bind($queue_name,<span class="string">'logs'</span>);</div><div class="line"></div><div class="line"><span class="keyword">echo</span> <span class="string">'[*] Waiting for logs. To exit press CTRL+C'</span>,<span class="string">"\n"</span>;</div><div class="line"></div><div class="line">$callback = <span class="function"><span class="keyword">function</span><span class="params">($msg)</span></span>&#123;</div><div class="line">	<span class="keyword">echo</span> <span class="string">'[x]'</span>,$msg-&gt;body,<span class="string">"\n"</span>;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">$channel-&gt;basic_consume($queue_name,<span class="string">''</span>,<span class="keyword">false</span>,<span class="keyword">true</span>,<span class="keyword">false</span>,<span class="keyword">false</span>,$callback);</div><div class="line"></div><div class="line">whild(count($channel-&gt;callbacks))&#123;</div><div class="line">	$channel-&gt;wait();</div><div class="line">&#125;</div><div class="line"></div><div class="line">$channel-&gt;close();</div><div class="line">$connection-&gt;close();</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
<p>(<a href="https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/php/receive_logs.php" target="_blank" rel="external">receive_logs.php</a>)</p>
<p>如果想保存日志到文件中，可以在命令中输入</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">php</span> <span class="selector-tag">receive_logs</span><span class="selector-class">.php</span> &gt; <span class="selector-tag">logs_from_rabbit</span><span class="selector-class">.log</span></div></pre></td></tr></table></figure>
<p>如果想在屏幕上查看日志，新打开一个终端并运行：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">php</span> <span class="selector-tag">receive_logs</span><span class="selector-class">.php</span></div></pre></td></tr></table></figure>
<p>发送日志：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">php</span> <span class="selector-tag">emit_log</span><span class="selector-class">.php</span></div></pre></td></tr></table></figure>
<p>使用 rabbitmqctl list_bindings 可以确认代码确实创建了绑定和队列，当两个receive_logs.php在运行的时候会看到类似这样的：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">sudo rabbitmqctl list_bindings</div><div class="line">Listing bindings ...</div><div class="line">logs    exchange        amq<span class="selector-class">.gen-JzTY20BRgKO-HjmUJj0wLg</span>  queue           []</div><div class="line">logs    exchange        amq<span class="selector-class">.gen-vso0PVvyiRIL2WoV3i48Yg</span>  queue           []</div><div class="line">..<span class="selector-class">.done</span>.</div></pre></td></tr></table></figure>
<p>对于结果的解释很简单，logs交换器中的数据发送到两个服务器指定的队列，而这正是我们要实现的。</p>
<p>想要弄明白怎样去监听部分消息，转到第四部分。</p>
<p>原文地址：<a href="https://www.rabbitmq.com/tutorials/tutorial-three-php.html" target="_blank" rel="external">Publish/Subscribe</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.qichengzx.com/2016/04/23/php-rabbitmq-tutorial-three.html" data-id="ciwt84yam0022hw0r0bwh01oz" class="article-share-link">Share</a>
      
        <a href="http://www.qichengzx.com/2016/04/23/php-rabbitmq-tutorial-three.html#comments" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/php/">php</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/rabbitmq/">rabbitmq</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-php-rabbitmq-tutorial-two" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/04/17/php-rabbitmq-tutorial-two.html" class="article-date">
  <time datetime="2016-04-17T06:39:30.000Z" itemprop="datePublished">2016-04-17</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/php/">php</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/04/17/php-rabbitmq-tutorial-two.html">PHP RabbitMQ 教程（二） - 工作队列</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="工作队列">工作队列</h3><h5 id="（使用php-amqplib库）">（使用<a href="https://github.com/php-amqplib/php-amqplib" target="_blank" rel="external">php-amqplib</a>库）</h5><p><img src="/images/rabbitmq/python-two.png" alt=""></p>
<p>在本教程<a href="/2016/02/28/php-rabbitmq-tutorial-one.html">第一部分</a> 我们已经写完了从一个指定队列发送和接收消息的程序。在这一章节中，我们会创建一个工作队列（Work Queue）来分发耗时的任务给多个工作者（worker）。</p>
<p>工作队列（也被称为 任务队列-task queue）主要是避免立即执行资源密集型任务并且还要等待它执行完毕。相反，需要让任务稍后执行，我们把一个任务当做一条信息发送给队列，后台运行的工作者（worker）会取出任务并执行，当运行多个worker时任务会在它们之间共享。</p>
<p>这个概念在web应用中非常有用，可以在短暂的HTTP请求期间处理一些复杂的任务。</p>
<h3 id="准备工作">准备工作</h3><p>在前面的部分我们发送了一条内容为“Hello World”的信息，现在我们会发送一些字符串，把这些字符串当做复杂的任务，我们并没有一个实际的任务，像是图片缩放，或者转换PDF文件，所以我们使用sleep方法来假设任务很繁忙。我们会在字符串中加入一些“.”来表示复杂复杂程度；每一个“.”表示需要耗时1秒，比如，“Hello …”代表需要耗时3秒。</p>
<p>我们从上一节的基础上稍微改动了一下send.php，来允许消息可以从命令行发送，这个程序会发送任务到队列中，把它命名为new_task.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$data = impllode(<span class="string">' '</span>,array_slice($argv,<span class="number">1</span>));</div><div class="line"><span class="keyword">if</span>(<span class="keyword">empty</span>($data))$data = <span class="string">"Hello World"</span>;</div><div class="line">$msg = <span class="keyword">new</span> AMQPMessage($data,</div><div class="line">	<span class="keyword">array</span>(<span class="string">'delivery_mode'</span>=&gt;<span class="number">2</span>)<span class="comment">#设置消息持久化，下边会讲到。</span></div><div class="line">);</div><div class="line">$channel-&gt;basic_publish($msg,<span class="string">''</span>,<span class="string">'task_queue'</span>);</div><div class="line"><span class="keyword">echo</span> <span class="string">"[x] Sent "</span>,$data,<span class="string">"\n"</span>;</div></pre></td></tr></table></figure>
<p>上一节的receive.php也需要一些改动：需要为消息中的每一个“.”模拟1秒的工作。它会从队列中取出消息并运行，把它命名为worker.php：</p>
<figure class="highlight xl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">$callback = function($msg)&#123;</div><div class="line">	<span class="function"><span class="title">echo</span> "[x] Received ",$msg-&gt;</span>body,<span class="string">"\n"</span>;</div><div class="line">	<span class="function"><span class="title">sleep</span>(substr_count($msg-&gt;</span>body,<span class="string">'.'</span>));</div><div class="line">	echo <span class="string">"[x] Done"</span>,<span class="string">"\n"</span>;</div><div class="line">	$<span class="function"><span class="title">msg</span>-&gt;</span><span class="function"><span class="title">delivery_info</span>['channel]-&gt;</span><span class="function"><span class="title">basic_ack</span>($msg-&gt;</span>delivery_info[<span class="string">'delivery_tag'</span>]);</div><div class="line">&#125;;</div><div class="line"></div><div class="line">$<span class="function"><span class="title">channel</span>-&gt;</span>basic_gos(null,<span class="number">1</span>,null);</div><div class="line">$<span class="function"><span class="title">channel</span>-&gt;</span>basic_consume(<span class="string">'task_queue'</span>,<span class="string">''</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">false</span>,$callback);</div></pre></td></tr></table></figure>
<p>注意我们伪造的任务需要花费时间（即发送的字符串中要有一些”.”）</p>
<p>然后运行：</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">php <span class="keyword">new</span><span class="type">_task</span>.php <span class="string">"A very hard task which takes two seconds.."</span></div><div class="line">php wordker.php</div></pre></td></tr></table></figure>
<h3 id="轮询分发">轮询分发</h3><p>使用工作队列的一个好处就是它能够并行的处理队列。如果有太多工作需要处理，只需要添加新的worker就可以了。</p>
<p>首先，我们试着同时运行两个worker.php，它们都会从队列接收到消息，但是到底是不是这样呢？我们看一下。</p>
<p>此时需要打开3个终端，其中两个运行worker.php，这两个就是我们的消费者 - C1和C2。</p>
<p>shell1</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">php worker.php</div><div class="line">[*] Waiting <span class="keyword">for</span> messages. To <span class="keyword">exit</span> press CTRL+C</div></pre></td></tr></table></figure>
<p>shell2</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">php worker.php</div><div class="line">[*] Waiting <span class="keyword">for</span> messages. To <span class="keyword">exit</span> press CTRL+C</div></pre></td></tr></table></figure>
<p>在第三个终端中我们会发送新的任务，消费者程序开始运行后就可以发送一些消息了。</p>
<p>shell3</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">php <span class="keyword">new</span><span class="type">_task</span>.php First message.</div><div class="line">php <span class="keyword">new</span><span class="type">_task</span>.php Second message..</div><div class="line">php <span class="keyword">new</span><span class="type">_task</span>.php Third message...</div><div class="line">php <span class="keyword">new</span><span class="type">_task</span>.php Fourth message....</div><div class="line">php <span class="keyword">new</span><span class="type">_task</span>.php Fifth message.....</div></pre></td></tr></table></figure>
<p>我们看一下发送给worker的是什么:</p>
<p>shell1</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">php worker.php</div><div class="line">[*] Waiting <span class="keyword">for</span> messages.To <span class="keyword">exit</span> press CTRL+C</div><div class="line">[x]Received <span class="string">'First message.'</span></div><div class="line">[x]Received <span class="string">'Third message...'</span></div><div class="line">[x]Received <span class="string">'Fifth message.....'</span></div></pre></td></tr></table></figure>
<p>shell2</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">php worker.php</div><div class="line">[*] Waiting <span class="keyword">for</span> messages.To <span class="keyword">exit</span> press CTRL+C</div><div class="line">[x]Received <span class="string">'Second message.'</span></div><div class="line">[x]Received <span class="string">'Fourth message...'</span></div></pre></td></tr></table></figure>
<p>RabbitMQ会默认按顺序把消息发送给下一个消费者，平均每个消费者都会得到一样多数量的消息，这种分发消息的方式叫做轮询。试着添加三个或更多个worker来运行。</p>
<h3 id="消息响应">消息响应</h3><p>执行一个任务会消耗一定的时间，也许你想知道如果一个消费者在执行一个耗时较长的任务时但是在执行一部分的时候挂掉会发生什么。在我们当前的代码中，一旦RabbitMQ把消息分发给消费者便会立即从内存中移除。这种情况下，如果停止一个worker，它正在处理的消息就会丢失。同时其他所有发送给这个worker的还没有处理的消息也会丢失。</p>
<p>但是我们不想丢失任何任务，如果一个worker挂掉，需要把任务发送到另一个worker。</p>
<p>为了确保消息永不丢失，RabbitMQ支持消息响应（message acknowledgements），消费者会发送一个响应告诉RabbitMQ已经收到了某条消息，并且已经处理，这样RabbitMQ就可以删掉它了。</p>
<p>如果一个消费者程序在未发送响应之前挂掉了（频道关闭，链接关闭，或者TCP连接丢失），RabbitMQ会认为消息没有完全处理然后会重新推送到队列中。如果此时有其他的消费者程序在运行，RabbitMQ会很快把消息发送给另一个消费者。这样就可以确保消息不会丢失，即使worker偶尔挂掉。</p>
<p>消息是没有超时的概念的，当worker断开连接的时候，RabbitMQ会重新发送消息，这样在处理一个耗时较长的消息任务时就不会出现问题了。</p>
<p>消息响应默认是关闭的。可以通过设置basic_consume的第四个参数为false(true表示不开启应答)，然后在处理完任务的时候从worker发送一个正确的响应内容。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$callback = <span class="function"><span class="keyword">function</span><span class="params">($msg)</span></span>&#123;</div><div class="line">	<span class="keyword">echo</span> <span class="string">"[x] Received "</span>,$msg-&gt;body,<span class="string">"\n"</span>;</div><div class="line">	sleep(substr_count($msg-&gt;body,<span class="string">'.'</span>));</div><div class="line">	<span class="keyword">echo</span> <span class="string">"[x] Done"</span>,<span class="string">"\n"</span>;</div><div class="line">	$msg-&gt;delivery_info[<span class="string">'channel]-&gt;basic_ack($msg-&gt;delivery_info['</span>delivery_tag]);</div><div class="line">&#125;;</div><div class="line">$channel-&gt;basic_consume(<span class="string">'task_queue'</span>,<span class="string">''</span>,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">false</span>,$callback);</div></pre></td></tr></table></figure>
<p>这样我们就可以确保当你CTRL+C杀掉一个正在处理消息的worker的时候，消息并不会丢失。在这个worker挂掉之后，所有未响应的消息就会发送。</p>
<h3 id="忘了响应">忘了响应</h3><p>一个很容易犯的错误就是忘了basic_ack，后果很严重。消息会在程序退出后重新发送（可能看起来像是随机返还 原文：which may look like random redelivery），但是如果它不释放未响应的消息，RabbitMQ就会占用越来越多的内存。</p>
<p>为了排除这种错误可以使用rabbitmqctl来打印messages_unacknowledges字段：</p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">sudo rabbitmqctl list_queues name messages_ready messages_unacknowledged</div><div class="line"></div><div class="line">Listing queues ...</div><div class="line">hello    <span class="number">0</span>       <span class="number">0</span></div><div class="line">...done.</div></pre></td></tr></table></figure>
<h3 id="消息持久化">消息持久化</h3><p>我们已经学习了确保即使消费者程序挂掉，任务也不会丢失。但是任务还是会在RabbitMQ服务停止的时候丢失。</p>
<p>当RabbitMQ退出或崩溃，它会丢失之前所有的队列和消息，除非你特意告诉它。所以我们必须把队列和消息设为持久化。</p>
<p>首先，为了队列不丢失，需要把它声明为<i>持久化（durable）</i>，所以修改queue_declare的第三个参数为true：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$channel</span>-&gt;queue_declare(<span class="string">'hello'</span>,<span class="keyword">false</span>,<span class="keyword">true</span>,<span class="keyword">false</span>,<span class="keyword">false</span>);</div></pre></td></tr></table></figure>
<p>尽管这行代码本身是正确的，但是仍然不会正确运行。因为在之前已经定义过一个非持久化的 hello 队列。RabbitＭＱ不允许使用不同参数重新定义一个已经存在的队列，它会返回一个错误。但是可以用一个快捷的方法去解决，定义一个不同名字的队列，比如 task_queue：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$channel</span>-&gt;queue_declare(<span class="string">'task_queue'</span>,<span class="keyword">false</span>,<span class="keyword">true</span>,<span class="keyword">false</span>,<span class="keyword">false</span>);</div></pre></td></tr></table></figure>
<p>需要把生产者和消费者程序都设置为 true。</p>
<p>这时候，我们就可以确保在RabbitMQ重启之后task_queue队列不会丢失。现在需要设置消息持久化了 - 通过设置AMQPMessage的属性数组中消息属性 delivery_mode = 2来达到。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$msg = <span class="keyword">new</span> AMQPMessage($data,</div><div class="line">		<span class="keyword">array</span>(<span class="string">'delivery_mode'</span>=&gt;<span class="number">2</span>) <span class="comment">//设置消息持久化</span></div><div class="line">	);</div></pre></td></tr></table></figure>
<h3 id="关于消息持久化的说明">关于消息持久化的说明</h3><p>设置消息持久化并不能完全保证消息不会丢失。这只是告诉让RabbitMQ要把消息保存到硬盘，但是从RabbitMQ接收到消息到保存完成仍然还有一个短暂的间隔时间。因为RabbitMQ并不是每一条消息都会使用fsync(2)，可能只是保存到缓存中而不是真正的写到磁盘里。并不能保证消息真正的持久化，但是对于简单的工作队列已经足够了。如果你需要更健壮的持久化，可以使用<a href="https://www.rabbitmq.com/confirms.html" target="_blank" rel="external">publisher confirms</a>机制。</p>
<h3 id="公平分发">公平分发</h3><p>也许你注意到它仍没有像我们想的那样去派发任务，比如在两个worker的情况下，处理奇数消息的比较繁忙，处理偶数消息的比较轻松，一个worker不断的忙碌而另一个几乎不需要工作，但是RabbitmQ并不知道这些，并且继续一如既往的派发消息。</p>
<p>这是因为RabbitMQ在消息进入队列的时候只管去派发，并不管消费者未做出响应的消息数。它只是把每第n条消息发送给第n个消费者。</p>
<p>我们可以使用basic_qos方法，并设置prefetch_count = 1。这样是告诉RabbitMQ在同一时刻不要发送超过1条消息给一个worker，或者说，不要发送新的消息给worker直到它已处理完上一条消息并作出了响应。这样，它就会把消息发送给下一个空闲的worker了。</p>
<p><img src="/images/rabbitmq/prefetch-count.png" alt=""></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$channel-&gt;basic_qos(<span class="keyword">null</span>,<span class="number">1</span>,<span class="keyword">null</span>);</div></pre></td></tr></table></figure>
<h3 id="注意队列长度">注意队列长度</h3><p>如果所有的worker都处于忙碌状态，队列就会填满，你需要留意，添加更多的worker，或者使用其他的策略。</p>
<h3 id="整合">整合</h3><p>最终，new_task.php的代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">require_once</span> <span class="keyword">__DIR__</span> .<span class="string">'/verdor/autoload.php'</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">PhpAmqpLib</span>\<span class="title">Connection</span>\<span class="title">AMQPStreamConnection</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">PhpAmqpLib</span>\<span class="title">Message</span>\<span class="title">AMQPMessage</span>;</div><div class="line"></div><div class="line">$connection = <span class="keyword">new</span> AMQPStreamConnection(<span class="string">'localhost'</span>,<span class="number">5672</span>,<span class="string">'guest'</span>,<span class="string">'guest'</span>);</div><div class="line">$channel = $connection-&gt;channel();</div><div class="line"></div><div class="line">$channel-&gt;queue_declare(<span class="string">'task_queue'</span>,<span class="keyword">false</span>,<span class="keyword">true</span>,<span class="keyword">false</span>,<span class="keyword">false</span>);</div><div class="line"></div><div class="line">$data = implode(<span class="string">' '</span>,array_slice($argv,<span class="number">1</span>));</div><div class="line"></div><div class="line"><span class="keyword">if</span>(<span class="keyword">empty</span>($data)) $data = <span class="string">"Hello World!"</span>;</div><div class="line"></div><div class="line">$msg = <span class="keyword">new</span> AMQPMessage($data,</div><div class="line">	<span class="keyword">array</span>(<span class="string">'delivery_mode'</span>=&gt;<span class="number">2</span>) <span class="comment">// 消息持久化</span></div><div class="line">);</div><div class="line">$channel-&gt;basic_publish($msg,<span class="string">''</span>,<span class="string">'task_queue'</span>);</div><div class="line"></div><div class="line"><span class="keyword">echo</span> <span class="string">"[x]Sent "</span>, $data, <span class="string">"\n"</span>;</div><div class="line"></div><div class="line">$channel-&gt;close();</div><div class="line">$connection-&gt;close();</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
<p><a href="https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/php/new_task.php" target="_blank" rel="external">new_task.php源码</a></p>
<p>worker.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">require_once</span> <span class="keyword">__DIR__</span> .<span class="string">'/vendor/autoload.php'</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">PhpAmqpLib</span>\<span class="title">Connection</span>\<span class="title">AMQPStreamConnection</span>;</div><div class="line"></div><div class="line">$connection = <span class="keyword">new</span> AMQPStreamConnection(<span class="string">'localhost'</span>,<span class="number">5672</span>,<span class="string">'guest'</span>,<span class="string">'guest'</span>);</div><div class="line">$channel = $connection-&gt;channel();</div><div class="line"></div><div class="line">$channel-&gt;queue_declare(<span class="string">'task_queue'</span>,<span class="keyword">false</span>,<span class="keyword">true</span>,<span class="keyword">false</span>,<span class="keyword">false</span>);</div><div class="line"></div><div class="line"><span class="keyword">echo</span> <span class="string">'[*] Waiting for messages.To exit press CTRL+C'</span>,<span class="string">"\n"</span>;</div><div class="line"></div><div class="line">$callback = <span class="function"><span class="keyword">function</span><span class="params">($msg)</span></span>&#123;</div><div class="line">	<span class="keyword">echo</span> <span class="string">"[x]Received "</span>,$msg-&gt;body,<span class="string">"\n"</span>;</div><div class="line">	sleep(substr_count($msg-&gt;body,<span class="string">'.'</span>));</div><div class="line">	<span class="keyword">echo</span> <span class="string">"[x]Done"</span>,<span class="string">"\n"</span>;</div><div class="line">	$msg-&gt;delivery_info[<span class="string">'chennel'</span>]-&gt;basic_ack($msg-&gt;delivery_info[<span class="string">'delivery_tag'</span>]);</div><div class="line">&#125;;</div><div class="line"></div><div class="line">$channel-&gt;basic_qos(<span class="keyword">null</span>,<span class="number">1</span>,<span class="keyword">null</span>);</div><div class="line">$channel-&gt;basic_consume(<span class="string">'task_queue'</span>,<span class="string">''</span>,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">false</span>,$callback);</div><div class="line"></div><div class="line"><span class="keyword">while</span>(count($channel-&gt;callbacks))&#123;</div><div class="line">	$channel-&gt;wait();</div><div class="line">&#125;</div><div class="line"></div><div class="line">$channel-&gt;close();</div><div class="line">$connection-&gt;close();</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
<p><a href="http://github.com/rabbitmq/rabbitmq-tutorials/blob/master/php/worker.php" target="_blank" rel="external">worker.php</a></p>
<p>使用消息应答和prefetch_count=1后，就可以运行一个工作队列了，持久模式选项会在即使RabbitMQ重启的情况下保留任务。</p>
<p>现在我们可以继续学习第三部分的内容，学习如何发送相同的消息给多个消费者。</p>
<p>原文地址：<a href="https://www.rabbitmq.com/tutorials/tutorial-two-php.html" target="_blank" rel="external">Work queues</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.qichengzx.com/2016/04/17/php-rabbitmq-tutorial-two.html" data-id="ciwt84yas0028hw0r4eha4mj0" class="article-share-link">Share</a>
      
        <a href="http://www.qichengzx.com/2016/04/17/php-rabbitmq-tutorial-two.html#comments" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/php/">php</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/rabbitmq/">rabbitmq</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-php-rabbitmq-tutorial-one" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/02/28/php-rabbitmq-tutorial-one.html" class="article-date">
  <time datetime="2016-02-28T03:10:03.000Z" itemprop="datePublished">2016-02-28</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/php/">php</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/02/28/php-rabbitmq-tutorial-one.html">PHP RabbitMQ 教程（一） - 介绍</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="准备工作">准备工作</h2><h3 id="先决条件">先决条件</h3><p>本教程先决条件是RabbitMQ已经安装并正在以5672端口运行在 localhost，如果你使用了不同的域，端口，用户，密码，连接配置需要适当改变。</p>
<h3 id="获得帮助">获得帮助</h3><p>如果在本教程中遇到问题，可以通过邮件列表进行联系。</p>
<h3 id="介绍">介绍</h3><p>RabbitMQ是一个消息代理，它的本质是，从producers（生产者）接收消息，然后发送给consumers（消费者），在这个过程中，可以根据自己的配置规则使用路由，缓冲区，保存消息。</p>
<p>通常的，RabbitMQ，信息传送（messaging），使用一些专业术语。（RabbitMQ, and messaging in general, uses some jargon.）</p>
<pre><code>&gt;生产（Producing）仅仅意味着发送，发送信息的程序叫做生产者（producers），以下图表示：
</code></pre><p><img src="/images/rabbitmq/producer.png" alt=""></p>
<pre><code>&gt;队列就是一个信箱的名字，存在于RabbitMQ内部，虽然消息在RabbitMQ和你的应用之间传输，但是只能存在于队列里，队列没有大小限制，它可以存储尽可能多的消息，本质上它是一个无限大的缓冲区，多个producers（生产者）可以通过一个队列发送消息，多个consumers（消费者）也可以尝试从一个队列接收消息，队列以下图表示，队列的名字在图的上边：
</code></pre><p><img src="/images/rabbitmq/queue.png" alt="">    </p>
<pre><code>&gt;consumers（消费者）的意思与接收相似，消费者主要是等待接收消息的程序，以下图表示：
</code></pre><p><img src="/images/rabbitmq/consumer.png" alt="">    </p>
<p>需要注意的是，生产者，消费者，和代理，不需要一定在一台机器上，事实上在大多数情况下他们确实不在一台机器上。</p>
<h3 id="“Hello_World”">“Hello World”</h3><p>（使用<a href="https://github.com/php-amqplib/php-amqplib" target="_blank" rel="external">php-amqplib</a>库）</p>
<p>在这一部分，我们使用PHP写两段程序，一个生产者发送一条消息，一个消费者接收消息并打印出来。我们会忽略一些php-amqplib API的细节，从简单的事情开始学习，这是一段内容为“Hello World”的消息。</p>
<p>在下边的示意图中，“P”是生产者，“C”是消费者，中间的盒子是队列 — 一个RabbitMQ代表消费者的消息缓冲区。</p>
<p><img src="/images/rabbitmq/python-one.png" alt=""></p>
<h4 id="php-amqplib库">php-amqplib库</h4><p>RabbitMQ支持很多协议，本教程包含AMQP 0-9-1，一个开放，通用信息协议，RabbitMQ支持Python、Ruby、.NET、Java、JMS、C、PHP、ActionScript、XMPP、STOMP等多种语言（详见<a href="http://www.rabbitmq.com/devtools.html" target="_blank" rel="external">这里</a>），在本教程中我们使用php-amqplib，使用<a href="https://getcomposer.org/doc/00-intro.md" target="_blank" rel="external">Composer</a> 管理依赖。</p>
<p>添加一个composer.json文件到你的项目目录。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="attr">"require"</span>: &#123;</div><div class="line">        <span class="attr">"php-amqplib/php-amqplib"</span>: <span class="string">"2.5.*"</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果你已经安装了 Composer ，可以运行如下的代码：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">composer<span class="selector-class">.phar</span> install</div></pre></td></tr></table></figure>
<p>这是一个Windows系统下的Composer安装文件。</p>
<p>现在我们已经安装了php-amqplib，可以写程序了。</p>
<h3 id="发送">发送</h3><p><img src="/images/rabbitmq/sending.png" alt=""></p>
<p>新建一个send.php作为发送端，receive.php作为接收端，发送端会连接RabbitMQ，发送一条信息，然后退出。</p>
<p>在send.php中，需要引用php-amqplib库，和使用其中的一些必要的类。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">require_once</span> <span class="keyword">__DIR__</span> . <span class="string">'/vendor/autoload.php'</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">PhpAmqpLib</span>\<span class="title">Connection</span>\<span class="title">AMQPStreamConnection</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">PhpAmqpLib</span>\<span class="title">Message</span>\<span class="title">AMQPMessage</span>;</div></pre></td></tr></table></figure>
<p>接下来，建立到RabbitMQ服务器的连接：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$connection = <span class="keyword">new</span> AMQPStreamConnection(<span class="string">'localhost'</span>, <span class="number">5672</span>, <span class="string">'guest'</span>, <span class="string">'guest'</span>);</div><div class="line">$channel = $connection-&gt;channel();</div></pre></td></tr></table></figure>
<p>这里我们使用socket进行连接，处理协议和鉴定，这样就已经连接到了本机的代理，如果想要连接不同的主机，只要更改localhost为该主机的名称或IP地址即可。</p>
<p>下一步，建立频道，大部分API的工作都在这完成。</p>
<p>要想发送信息，需要声明一个队列，之后可以向这个队列里发布消息。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$channel-&gt;queue_declare(<span class="string">'hello'</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>);</div><div class="line"></div><div class="line">$msg = <span class="keyword">new</span> AMQPMessage(<span class="string">'Hello World!'</span>);</div><div class="line">$channel-&gt;basic_publish($msg, <span class="string">''</span>, <span class="string">'hello'</span>);</div><div class="line"></div><div class="line"><span class="keyword">echo</span> <span class="string">" [x] Sent 'Hello World!'\n"</span>;</div></pre></td></tr></table></figure>
<p>声明队列是幂等的 — 它仅在不存在的时候才会被创建，如果存在也不会受影响。消息内容是一个字节数组（byte array），所以可以发送任何内容。</p>
<p>最后，关闭频道和连接。</p>
<figure class="highlight cos"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">$channel</span>-&gt;<span class="keyword">close</span>()<span class="comment">;</span></div><div class="line"><span class="built_in">$connection</span>-&gt;<span class="keyword">close</span>()<span class="comment">;</span></div></pre></td></tr></table></figure>
<p><a href="https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/php/send.php" target="_blank" rel="external">这是send.php类的完整内容。</a></p>
<h3 id="发送失败">发送失败</h3><p>如果这是第一次使用RabbitMQ，并且没有看到“Sent”信息（即“ [x] Sent ‘Hello World!”），也许你抓耳挠腮的想知道为什么出错了，也许是代理没有足够的硬盘空间（默认情况下需要至少1G的空间）导致拒绝接收信息。检查日志文件，有必要的花调低限值。<a href="http://www.rabbitmq.com/configure.html#config-items" target="_blank" rel="external">这个配置文件</a>文档将会展示给你如何设置disk_free_limit。</p>
<h3 id="接收">接收</h3><p>收件人，与发送者只发送一条消息不同，接收者会一直运行以监听信息并输出。</p>
<p><img src="/images/rabbitmq/receiving.png" alt=""></p>
<p>receive.php中与send.php中的 include和use 部分的代码一样。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">require_once</span> <span class="keyword">__DIR__</span> . <span class="string">'/vendor/autoload.php'</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">PhpAmqpLib</span>\<span class="title">Connection</span>\<span class="title">AMQPStreamConnection</span>;</div></pre></td></tr></table></figure>
<p>设置连接与send.php一样，打开连接和频道，命名一个队列，需要注意的是，队列名需要与send.php所发布的队列的名字一致。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$connection = <span class="keyword">new</span> AMQPStreamConnection(<span class="string">'localhost'</span>, <span class="number">5672</span>, <span class="string">'guest'</span>, <span class="string">'guest'</span>);</div><div class="line">$channel = $connection-&gt;channel();</div><div class="line"></div><div class="line">$channel-&gt;queue_declare(<span class="string">'hello'</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>);</div><div class="line"></div><div class="line"><span class="keyword">echo</span> <span class="string">' [*] Waiting for messages. To exit press CTRL+C'</span>, <span class="string">"\n"</span>;</div></pre></td></tr></table></figure>
<p>注意，我们在此声明了一个队列，因为有可能会在send程序开启前先开启receive程序，我们想要确保在试着接收消息之前队列就已经存在了。</p>
<p>下一步，告诉服务器去从队列传送消息，我们会定义一个用于从服务器接收消息的函数，记住，消息会异步的从服务器发送到客户端。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">$callback = <span class="function"><span class="keyword">function</span><span class="params">($msg)</span> </span>&#123;</div><div class="line">  <span class="keyword">echo</span> <span class="string">" [x] Received "</span>, $msg-&gt;body, <span class="string">"\n"</span>;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">$channel-&gt;basic_consume(<span class="string">'hello'</span>, <span class="string">''</span>, <span class="keyword">false</span>, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, $callback);</div><div class="line"></div><div class="line"><span class="keyword">while</span>(count($channel-&gt;callbacks)) &#123;</div><div class="line">    $channel-&gt;wait();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>此处使用while方法，当收到消息时，会把收到的消息传入到$callback方法里。</p>
<p><a href="https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/php/receive.php" target="_blank" rel="external">这是receive.php类的全部内容。</a></p>
<p>现在我们可以运行两段脚本了，在命令行里，执行sender程序。</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">php <span class="built_in">send</span>.php</div></pre></td></tr></table></figure>
<p>然后，执行receiver程序</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">php</span> <span class="selector-tag">receive</span><span class="selector-class">.php</span></div></pre></td></tr></table></figure>
<p>receiver程序会把通过sender程序发送的内容打印出来，receiver程序会一直运行，监听新消息（使用ctrl+c停止），所以试着运行sender程序从另一个命令行。</p>
<p>如果想查看队列，可以运行rabbitmqctl list_queues。</p>
<p>Hello World！</p>
<p>查看第二部分，建立一个简单的队列。</p>
<p>原文地址：<a href="https://www.rabbitmq.com/tutorials/tutorial-one-php.html" target="_blank" rel="external">“Hello World!”</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.qichengzx.com/2016/02/28/php-rabbitmq-tutorial-one.html" data-id="ciwt84yah001whw0r2r1jm5ah" class="article-share-link">Share</a>
      
        <a href="http://www.qichengzx.com/2016/02/28/php-rabbitmq-tutorial-one.html#comments" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/php/">php</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/rabbitmq/">rabbitmq</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-a-piece-of-interesting-code-of-js-for-function" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/02/25/a-piece-of-interesting-code-of-js-for-function.html" class="article-date">
  <time datetime="2016-02-25T09:10:43.000Z" itemprop="datePublished">2016-02-25</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/javascript/">javascript</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/02/25/a-piece-of-interesting-code-of-js-for-function.html">一段有意思的JS For循环代码</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">var a =<span class="number">0</span><span class="comment">;</span></div><div class="line">for (var i =<span class="number">0</span>,<span class="keyword">j </span>=<span class="number">0</span><span class="comment">; i &lt;10,j&lt;6;i++,j++) &#123;</span></div><div class="line">	a = i+<span class="keyword">j;</span></div><div class="line">	console.log(<span class="string">"i="</span>+i)<span class="comment">;</span></div><div class="line">	console.log(<span class="string">"j="</span>+<span class="keyword">j);</span></div><div class="line">	console.log(<span class="string">"a="</span>+a)<span class="comment">;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>朋友面试，遇到的面试题，电话跟我说完就回来写下来试了一下，结果与自己预想的一样。</p>
<p>没写之前，电话里说的思路是，因为 j 限制了 小于 6，那么应该只循环6次，实际上也确实是这样。</p>
<p>所以最终结果，a = 10。</p>
<h6 id="但是想不明白为什么会有这样的面试题，或者说，什么样的情况会需要写这样的代码呢？">但是想不明白为什么会有这样的面试题，或者说，什么样的情况会需要写这样的代码呢？</h6>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.qichengzx.com/2016/02/25/a-piece-of-interesting-code-of-js-for-function.html" data-id="ciwt84y8y0006hw0ro8cxkwfa" class="article-share-link">Share</a>
      
        <a href="http://www.qichengzx.com/2016/02/25/a-piece-of-interesting-code-of-js-for-function.html#comments" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/js/">js</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-MySql-row_number-part-2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/02/24/MySql-row_number-part-2.html" class="article-date">
  <time datetime="2016-02-24T09:58:24.000Z" itemprop="datePublished">2016-02-24</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/mysql/">mysql</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/02/24/MySql-row_number-part-2.html">MySQL实现row_number第二部分</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>接上篇：<a href="https://www.qichengzx.com/2016/02/03/MySQL%E5%AE%9E%E7%8E%B0row_number%20.html">MySQL实现row_number</a></p>
<h3 id="为分组增加row_number">为分组增加row number</h3><p>row_number的分析函数怎么样？（原文：How about  row_number “over partition by” functionality? ），比如，如果想为每一个组增加row number，并且在每一个新的分组重置它。</p>
<p>查看下图中payments表。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span></div><div class="line">    customerNumber, paymentDate, amount</div><div class="line"><span class="keyword">FROM</span></div><div class="line">    payments</div><div class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> customerNumber;</div></pre></td></tr></table></figure>
<p><img src="/images/mysql-row-number/mysql-row_number-payments-table.jpg" alt=""></p>
<p>设想下，为每一条customer数据增加一个当前行的编号，并且每当customer的number字段变化的时候行编号都被重置。</p>
<p>为了实现这个，需要使用两个临时变量，一个作为当前行编号，另一个用来存 上一条customer number与当前行的number进行对比，查询语句如下。（这句有点绕，可能翻译的不太准确，请以原文为准。To achieve this, you have to use two session variables, one for the row number and the other for storing the old customer number to compare it with the current one as the following query:）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> </div><div class="line">    @row_number:=<span class="keyword">CASE</span></div><div class="line">        <span class="keyword">WHEN</span> @customer_no = customerNumber <span class="keyword">THEN</span> @row_number + <span class="number">1</span></div><div class="line">        <span class="keyword">ELSE</span> <span class="number">1</span></div><div class="line">    <span class="keyword">END</span> <span class="keyword">AS</span> <span class="keyword">num</span>,</div><div class="line">    @customer_no:=customerNumber <span class="keyword">as</span> CustomerNumber,</div><div class="line">    paymentDate,</div><div class="line">    amount</div><div class="line"><span class="keyword">FROM</span></div><div class="line">    payments</div><div class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> customerNumber;</div></pre></td></tr></table></figure>
<p>在这段查询代码中，我们使用了CASE声明，如果customer的number不变，就给row_number变量+1，否则，重置为1，结果如下：</p>
<p><img src="/images/mysql-row-number/mysql-row_number-per-group.jpg" alt=""></p>
<p>与为每一行记录生成row_number一样，也可以使用派生表（derived table）和交叉连接（cross join）生成同样的结果。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> </div><div class="line">    @row_number:=<span class="keyword">CASE</span></div><div class="line">        <span class="keyword">WHEN</span> @customer_no = customerNumber <span class="keyword">THEN</span> @row_number + <span class="number">1</span></div><div class="line">        <span class="keyword">ELSE</span> <span class="number">1</span></div><div class="line">    <span class="keyword">END</span> <span class="keyword">AS</span> <span class="keyword">num</span>,</div><div class="line">    @customer_no:=customerNumber <span class="keyword">as</span> CustomerNumber,</div><div class="line">    paymentDate,</div><div class="line">    amount</div><div class="line"><span class="keyword">FROM</span></div><div class="line">    payments,(<span class="keyword">SELECT</span> @customer_no:=<span class="number">0</span>,@row_number:=<span class="number">0</span>) <span class="keyword">as</span> t</div><div class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> customerNumber;</div></pre></td></tr></table></figure>
<p>本教程中，我们展示了如何在MySQL中模仿row_number方法。</p>
<p>原文地址：<a href="http://www.mysqltutorial.org/mysql-row_number/" target="_blank" rel="external">MySQL row_number, This Is How You Emulate It</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.qichengzx.com/2016/02/24/MySql-row_number-part-2.html" data-id="ciwt84y8v0004hw0r27n498hw" class="article-share-link">Share</a>
      
        <a href="http://www.qichengzx.com/2016/02/24/MySql-row_number-part-2.html#comments" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mysql/">mysql</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-MySQL实现row_number " class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/02/03/MySQL实现row_number .html" class="article-date">
  <time datetime="2016-02-03T10:25:26.000Z" itemprop="datePublished">2016-02-03</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/mysql/">mysql</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/02/03/MySQL实现row_number .html">MySQL实现row_number</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>在本教程中，我们将在MySQL中实现一个非常实用的row_number功能。</p>
<p>row_number是一个返回数据排序编号的排名方法，从1开始。我们经常需要用到row_number去生成某些报表，不幸的是，MySQL并不像MSSQL，Oracle一样支持这个方法。在MySQL中如果想实现这个功能需要临时变量。</p>
<p>为了在MySQL中实现row_number，需要在查询中实用临时变量，下图中从employees表中查询出5条数据，并且从1开始，为每一行添加了编号(row number)。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SET</span> @row_number = <span class="number">0</span>;</div><div class="line"> </div><div class="line"><span class="keyword">SELECT</span> </div><div class="line">    (@row_number:=@row_number + <span class="number">1</span>) <span class="keyword">AS</span> <span class="keyword">num</span>, firstName, lastName</div><div class="line"><span class="keyword">FROM</span></div><div class="line">    employees</div><div class="line"><span class="keyword">LIMIT</span> <span class="number">5</span>;</div></pre></td></tr></table></figure>
<p><img src="/images/mysql-row_number-session-variables.jpg" alt=""></p>
<p>在上面的查询中：</p>
<pre><code>首先，我们定义了一个变量叫做row_number,初始值为<span class="number">0</span>，row_number是以@为前缀的一个临时变量。

然后，在查询中，我们为这个变量每次+<span class="number">1</span>，LIMIT分句是为了限制返回的结果数，此处设为<span class="number">5.</span>
</code></pre><p>另一个方法是使用临时变量作为派生表，联合主表。看下边的查询语句：</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">SELECT</span> </div><div class="line">    (<span class="variable">@row_number</span>:=<span class="variable">@row_number</span> + <span class="number">1</span>) <span class="selector-tag">AS</span> <span class="selector-tag">num</span>, <span class="selector-tag">firstName</span>, <span class="selector-tag">lastName</span></div><div class="line"><span class="selector-tag">FROM</span></div><div class="line">    <span class="selector-tag">employees</span>,(SELECT <span class="variable">@row_number</span>:=<span class="number">0</span>) <span class="selector-tag">AS</span> <span class="selector-tag">t</span></div><div class="line"><span class="selector-tag">LIMIT</span> <span class="selector-tag">5</span>;</div></pre></td></tr></table></figure>
<p>需要注意，派生表必须使用别名，以使查询语句在语法上没有问题。</p>
<p>由于时间关系（回家过年），暂时到这里，文中部分内容可能翻译的有点不太顺，可以直接看下原文，原文中还有一部分讲分组查询中实用row_number。</p>
<p>这个之后再写。</p>
<p>原文地址：<a href="http://www.mysqltutorial.org/mysql-row_number/" target="_blank" rel="external">MySQL row_number, This Is How You Emulate It</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.qichengzx.com/2016/02/03/MySQL实现row_number .html" data-id="ciwt84y8p0001hw0rn1y20jeo" class="article-share-link">Share</a>
      
        <a href="http://www.qichengzx.com/2016/02/03/MySQL实现row_number .html#comments" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mysql/">mysql</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-echarts-pie" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/01/19/echarts-pie.html" class="article-date">
  <time datetime="2016-01-19T13:27:00.000Z" itemprop="datePublished">2016-01-19</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/javascript/">javascript</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/01/19/echarts-pie.html">ECharts饼图示例</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="/images/BEEC6560-EC03-4027-969D-DBB584A47E69.png" alt=""></p>
<p>今天写一个做地区分布的饼图的东西。</p>
<p>由于数据库里本身没有存储地区数据，只有IP，所以也用到了<a href="http://www.ipip.net/" target="_blank" rel="external">高春辉老师目前的项目</a>里提供的IP地址数据库。可以在数据库下载页面下载到免费的数据库文件和一个PHP处理类。</p>
<p>还用到了百度团队开源的<a href="http://echarts.baidu.com/index.html" target="_blank" rel="external">ECharts</a>，很简单很好用。</p>
<p>其实事情本身并没有难度。</p>
<h3 id="约定">约定</h3><p>默认为：此时已有一个静态页面，并且已引入echarts的js文件。</p>
<h3 id="先读取数据">先读取数据</h3><figure class="highlight elixir"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="variable">$sql</span> = <span class="string">"SELECT id,ips FROM table order by id desc limit 100000"</span>;</div><div class="line"></div><div class="line"><span class="variable">$pdo</span> = new PDO(<span class="string">'mysql:host=127.0.0.1;dbname=db1'</span>,<span class="string">'root'</span>,<span class="string">'root'</span>);</div><div class="line"></div><div class="line"><span class="variable">$query</span> = <span class="variable">$pdo</span> -&gt; query(<span class="variable">$sql</span>);</div><div class="line"><span class="variable">$query</span>-&gt;setFetchMode(<span class="symbol">PDO:</span><span class="symbol">:FETCH_ASSOC</span>);</div><div class="line"><span class="variable">$rs</span> = <span class="variable">$query</span>-&gt;fetchAll();</div></pre></td></tr></table></figure>
<h3 id="根据IP得出所在地信息">根据IP得出所在地信息</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">include</span> <span class="string">'./IP.class.php'</span>;<span class="comment">//ipip.net提供的IP处理类</span></div><div class="line">$IP = <span class="keyword">new</span> IP();</div><div class="line"><span class="keyword">foreach</span> ($rs <span class="keyword">as</span> $key =&gt; $value) &#123;</div><div class="line">	$a = $IP-&gt;find($value[<span class="string">"ips"</span>]);</div><div class="line">	$arr[$key] = $a[<span class="number">1</span>].$a[<span class="number">2</span>]; <span class="comment">//正确的IP返回的数据为:Array ( [0] =&gt; 中国 [1] =&gt; 黑龙江 [2] =&gt; 鹤岗 [3] =&gt; ) ,这里根据实际情况取对应字段即可。</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="生成echarts所需的数据">生成echarts所需的数据</h3><figure class="highlight haskell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$<span class="class"><span class="keyword">data</span> = array_count_values($<span class="title">arr</span>);</span></div></pre></td></tr></table></figure>
<p>嗯，一个非常简单粗暴的把同名地区数量算出来的方法。这样就生成了如array(‘北京’=&gt;2,’天津’=&gt;3)这样的数据。正是echarts所需的。</p>
<h3 id="饼图区域">饼图区域</h3><figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;<span class="keyword">div</span> <span class="built_in">id</span>=<span class="string">"main"</span> style=<span class="string">"width: 1400px;height:1400px;"</span>&gt;&lt;/<span class="keyword">div</span>&gt;</div></pre></td></tr></table></figure>
<h3 id="正经的JS来了">正经的JS来了</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> myChart = echarts.init(document.getElementById(<span class="string">'main'</span>));</div><div class="line"></div><div class="line"><span class="keyword">var</span> option = &#123;</div><div class="line">      </div><div class="line">       title : &#123;</div><div class="line">        text: <span class="string">'IP分布地区'</span>,</div><div class="line">        x:<span class="string">'center'</span></div><div class="line">    &#125;,</div><div class="line">    tooltip : &#123;</div><div class="line">        trigger: <span class="string">'item'</span>,</div><div class="line">        formatter: <span class="string">"&#123;a&#125; &lt;br/&gt;&#123;b&#125; : &#123;c&#125; (&#123;d&#125;%)"</span></div><div class="line">    &#125;,</div><div class="line">    legend: &#123;</div><div class="line">        orient: <span class="string">'vertical'</span>,</div><div class="line">        left: <span class="string">'left'</span>,</div><div class="line">        <span class="comment">//简单起见此处直接foreach了</span></div><div class="line">        data: [<span class="meta">&lt;?php</span> <span class="keyword">foreach</span> ($keys <span class="keyword">as</span> $key =&gt; $value) &#123; <span class="keyword">echo</span> <span class="string">'"'</span>.$value.<span class="string">'",'</span>; &#125;<span class="meta">?&gt;</span>]</div><div class="line">    &#125;,</div><div class="line">    series : [</div><div class="line">        &#123;</div><div class="line">            name: <span class="string">'IP所在地区'</span>,</div><div class="line">            type: <span class="string">'pie'</span>,</div><div class="line">            radius : <span class="string">'40%'</span>,</div><div class="line">            center: [<span class="string">'50%'</span>, <span class="string">'60%'</span>],</div><div class="line">            data:[</div><div class="line">            	<span class="comment">//同上，</span></div><div class="line">            	<span class="meta">&lt;?php</span> </div><div class="line">            		<span class="comment">//reset($data);</span></div><div class="line">					<span class="keyword">while</span> (<span class="keyword">list</span>($key, $val) = each($data))&#123;</div><div class="line">						<span class="keyword">echo</span> <span class="string">'&#123;value:'</span>.$val.<span class="string">',name:"'</span>.$key.<span class="string">'"&#125;,'</span>;</div><div class="line">					&#125;</div><div class="line">            	<span class="meta">?&gt;</span></div><div class="line">            ],</div><div class="line">            itemStyle: &#123;</div><div class="line">                emphasis: &#123;</div><div class="line">                    shadowBlur: <span class="number">10</span>,</div><div class="line">                    shadowOffsetX: <span class="number">0</span>,</div><div class="line">                    shadowColor: <span class="string">'rgba(0, 0, 0, 0.5)'</span></div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    ]</div><div class="line">   &#125;;</div><div class="line">   </div><div class="line">   <span class="comment">// 使用刚指定的配置项和数据显示图表。</span></div><div class="line">   myChart.setOption(option);</div></pre></td></tr></table></figure>
<p>打开页面看一下吧。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.qichengzx.com/2016/01/19/echarts-pie.html" data-id="ciwt84y9s0011hw0rk9asy11e" class="article-share-link">Share</a>
      
        <a href="http://www.qichengzx.com/2016/01/19/echarts-pie.html#comments" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ECharts/">ECharts</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/javascript/">javascript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/php/">php</a></li></ul>

    </footer>
  </div>
  
</article>


  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/3/">Next &raquo;</a>
    </nav>
  
</section>
        
          <aside id="sidebar">
  
      <div class="widget-wrap">
    <h3 class="widget-title">Time</h3>
    <div class="widget time">
      <style id="clock-animations"></style>
      <div class="clock-wrapper">
        <div class="clock-base">
            <div class="clock-indicator">
              <div></div>
              <div></div>
              <div></div>
              <div></div>
              <div></div>
              <div></div>
              <div></div>
              <div></div>
              <div></div>
              <div></div>
              <div></div>
              <div></div>
            </div>
            <div class="clock-hour"></div>
            <div class="clock-minute"></div>
            <div class="clock-second"></div>
            <div class="clock-center"></div>
        </div>
      </div>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/golang/">golang</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/javascript/">javascript</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/mysql/">mysql</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/php/">php</a><span class="category-list-count">11</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/ECharts/">ECharts</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/crontab/">crontab</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/discuz/">discuz</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dropbox/">dropbox</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/excel/">excel</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/fetch/">fetch</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gin/">gin</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/">git</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/go/">go</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/goquery/">goquery</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/">hexo</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/https/">https</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/input/">input</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/javascript/">javascript</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/js/">js</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/laravel/">laravel</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/">linux</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/">mysql</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/node/">node</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pdo/">pdo</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/php/">php</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rabbitmq/">rabbitmq</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/react-native/">react-native</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/redis/">redis</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ssl/">ssl</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/time/">time</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vps/">vps</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/widget/">widget</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/今日头条/">今日头条</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/标识符/">标识符</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/爱奇艺/">爱奇艺</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/糗百/">糗百</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/网络请求/">网络请求</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/队列/">队列</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/ECharts/" style="font-size: 10px;">ECharts</a> <a href="/tags/crontab/" style="font-size: 10px;">crontab</a> <a href="/tags/discuz/" style="font-size: 10px;">discuz</a> <a href="/tags/dropbox/" style="font-size: 12px;">dropbox</a> <a href="/tags/excel/" style="font-size: 10px;">excel</a> <a href="/tags/fetch/" style="font-size: 10px;">fetch</a> <a href="/tags/gin/" style="font-size: 10px;">gin</a> <a href="/tags/git/" style="font-size: 10px;">git</a> <a href="/tags/go/" style="font-size: 16px;">go</a> <a href="/tags/goquery/" style="font-size: 12px;">goquery</a> <a href="/tags/hexo/" style="font-size: 14px;">hexo</a> <a href="/tags/https/" style="font-size: 10px;">https</a> <a href="/tags/input/" style="font-size: 10px;">input</a> <a href="/tags/javascript/" style="font-size: 14px;">javascript</a> <a href="/tags/js/" style="font-size: 12px;">js</a> <a href="/tags/laravel/" style="font-size: 10px;">laravel</a> <a href="/tags/linux/" style="font-size: 10px;">linux</a> <a href="/tags/mysql/" style="font-size: 18px;">mysql</a> <a href="/tags/node/" style="font-size: 10px;">node</a> <a href="/tags/pdo/" style="font-size: 10px;">pdo</a> <a href="/tags/php/" style="font-size: 20px;">php</a> <a href="/tags/rabbitmq/" style="font-size: 18px;">rabbitmq</a> <a href="/tags/react-native/" style="font-size: 10px;">react-native</a> <a href="/tags/redis/" style="font-size: 12px;">redis</a> <a href="/tags/ssl/" style="font-size: 10px;">ssl</a> <a href="/tags/time/" style="font-size: 10px;">time</a> <a href="/tags/vps/" style="font-size: 10px;">vps</a> <a href="/tags/widget/" style="font-size: 10px;">widget</a> <a href="/tags/今日头条/" style="font-size: 10px;">今日头条</a> <a href="/tags/标识符/" style="font-size: 10px;">标识符</a> <a href="/tags/爱奇艺/" style="font-size: 10px;">爱奇艺</a> <a href="/tags/糗百/" style="font-size: 10px;">糗百</a> <a href="/tags/网络请求/" style="font-size: 10px;">网络请求</a> <a href="/tags/队列/" style="font-size: 10px;">队列</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">October 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">May 2016</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">February 2016</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">January 2016</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">November 2015</a><span class="archive-list-count">7</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2016/12/14/toutiao-images-spider-by-golang.html">Go 福利小爬虫 爬取今日头条美女图</a>
          </li>
        
          <li>
            <a href="/2016/12/04/go-qiubai.html">Go语言写爬取糗百热门帖子</a>
          </li>
        
          <li>
            <a href="/2016/11/02/install-yaf-on-mac.html">Mac brew php7.1环境下安装Yaf</a>
          </li>
        
          <li>
            <a href="/2016/10/21/beego-in-docker.html">用Docker部署Golang Beego框架应用</a>
          </li>
        
          <li>
            <a href="/2016/09/28/custom-data-pagination-in-laravel-with-arrays.html">Laravel 手动创建分页</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 qichengzx<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
      Hosted by <a href="https://www.digitalocean.com/?refcode=2cb067f6a1f0" target="_blank">DigitalOcean</a>
    </div>
  </div>
</footer>
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?199f8980952ead3f1af440507b4b2a7c";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
<script src="//tajs.qq.com/stats?sId=59998269"></script>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>