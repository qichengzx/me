<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>启程</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta http-equiv="Access-Control-Allow-Origin" content="*">
  <meta name="description" content="记录写代码过程中的成长，不要把你仅知道的那一点点东西当成全世界">
<meta property="og:type" content="website">
<meta property="og:title" content="启程">
<meta property="og:url" content="http://www.qichengzx.com/index.html">
<meta property="og:site_name" content="启程">
<meta property="og:description" content="记录写代码过程中的成长，不要把你仅知道的那一点点东西当成全世界">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="启程">
<meta name="twitter:description" content="记录写代码过程中的成长，不要把你仅知道的那一点点东西当成全世界">
<meta name="twitter:creator" content="@qichengzx">
  
    <link rel="alternative" href="/atom.xml" title="启程" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <!-- <link href="//fonts.useso.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css"> -->
  <link rel="stylesheet" href="/css/style.css">
  

</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">启程</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://www.qichengzx.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-go-qiubai" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/12/04/go-qiubai.html" class="article-date">
  <time datetime="2016-12-04T07:49:04.000Z" itemprop="datePublished">2016-12-04</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/12/04/go-qiubai.html">Go语言写爬取糗百热门帖子</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>闲来无事，想着也用Go来写个爬虫之类的东西，我并不知道这算不算严格意义上的爬虫。</p>
<p>思前想后，觉得写个爬糗百热门的脚本吧，一来足够简单，二来大概熟悉下流程。</p>
<p>首先，选了<a href="https://github.com/PuerkitoBio/goquery" target="_blank" rel="external">goquery</a>这个包来解析HTML，声称与jquery相似的用法，事实上也确实是这样，非常方便。</p>
<p>定个目标，只爬取列表页的帖子内容，作者和回帖都不管。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"github.com/PuerkitoBio/goquery"</span></div><div class="line">	<span class="string">"log"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="comment">//定义结构体</span></div><div class="line"><span class="keyword">type</span> Qb <span class="keyword">struct</span> &#123;</div><div class="line">	Id <span class="keyword">int</span> <span class="string">`json:"id"`</span></div><div class="line">	Content <span class="keyword">string</span> <span class="string">`json:"content"`</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> url = <span class="string">"http://www.qiushibaike.com/hot"</span></div><div class="line"></div><div class="line">	doc, err := goquery.NewDocument(url)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		log.Fatal(err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">var</span> qb []Qb</div><div class="line">	doc.Find(<span class="string">"#content-left .article"</span>).Each(<span class="function"><span class="keyword">func</span><span class="params">(i <span class="keyword">int</span>, s *goquery.Selection)</span></span> &#123;</div><div class="line">		<span class="comment">//s即为当前的 .article 元素，查找下级中的span元素的内容。</span></div><div class="line">		content := s.Find(<span class="string">".content span"</span>).Text()</div><div class="line">		qb = <span class="built_in">append</span>(qb, Qb&#123;Id: i, Content: content&#125;)</div><div class="line">	&#125;)</div><div class="line"></div><div class="line">	log.Println(qb)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>“#content-left .article” 即每一条帖子作为元素的class。</p>
<p>将会输出：<br><figure class="highlight clojure"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[</div><div class="line">	&#123;<span class="number">0</span> 结婚十三周年那天，老婆望着一大桌子菜不禁泪流满面。我帮她拭去泪水:瞧你，都激动的哭了!老婆却说:我激动个屁!想想这十三年跟着你受的罪，我实在忍不住啊!&#125; </div><div class="line">	&#123;<span class="number">1</span> 前几天天冷，就给妹妹买了条围巾，然后她说谢谢哥，本人本着组织精神说你应该谢谢你嫂子，她惊讶的对我说:哥，你谈女朋友了。我说:没有，你应该感谢她一直到现在都没出现，哥才有钱给你买东西&#125; </div><div class="line">	&#123;<span class="number">2</span> 跟哥们去理发，剪头的是个妹纸。。妹纸:“你有女朋友么？”哥们一听，突然兴奋的说:“没有！”妹纸:“我是个实习生，本来想给你换大工的，看你没有女朋友，我就随意剪了！”哥们你别看我，我就是一口水没忍住，喷你脸上了而已！&#125; </div><div class="line">	&#123;<span class="number">3</span> 老妈比较胖，小时候每次打我我都是撒腿就跑，老妈没一次抓到我的。直到老妈学会骑自行车以后，那鞭子挥得………真像套马杆的汉子，威武雄壮……&#125;</div><div class="line">]</div></pre></td></tr></table></figure></p>
<p>那么如何展示到页面中呢。</p>
<p>我选择了 <a href="https://github.com/gin-gonic/gin" target="_blank" rel="external">gin</a> 框架。</p>
<p>修改一下代码。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	r := gin.Default()</div><div class="line">	r.LoadHTMLGlob(<span class="string">"public/*"</span>)</div><div class="line">	r.GET(<span class="string">"/"</span>, Index)</div><div class="line">	r.Run()</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Index</span><span class="params">(c *gin.Context)</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> url = <span class="string">"http://www.qiushibaike.com/hot"</span></div><div class="line"></div><div class="line">	doc, err := goquery.NewDocument(url)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		log.Fatal(err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">var</span> result []Qb</div><div class="line">	doc.Find(<span class="string">"#content-left .article"</span>).Each(<span class="function"><span class="keyword">func</span><span class="params">(i <span class="keyword">int</span>, s *goquery.Selection)</span></span> &#123;</div><div class="line">		content := s.Find(<span class="string">".content span"</span>).Text()</div><div class="line">		result = <span class="built_in">append</span>(result, Qb&#123;Id: i, Content: content&#125;)</div><div class="line">	&#125;)</div><div class="line"></div><div class="line">	c.HTML(http.StatusOK, <span class="string">"index.html"</span>, gin.H&#123;</div><div class="line">		<span class="string">"items"</span>: result,</div><div class="line">		<span class="string">"title"</span>: <span class="string">"糗百热门"</span></div><div class="line">	&#125;)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到，<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">r := gin.Default()</div><div class="line">r.LoadHTMLGlob(<span class="string">"public/*"</span>)</div><div class="line">r.GET(<span class="string">"/"</span>, Index)</div></pre></td></tr></table></figure></p>
<p>这里加载了public目录中的模板，然后下一行，表示，接收到 “/“ 的请求时，调用Index方法去处理。</p>
<p>到这里，文档的抓取，解析，构造数据就已经完成，下一步，看一下怎么显示到页面中。</p>
<figure class="highlight twig"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name">raw</span> %&#125;</span><span class="xml"></span></div><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-12"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">h2</span>&gt;</span><span class="template-variable">&#123;&#123; .title &#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></div><div class="line">    <span class="tag">&lt;<span class="name">table</span> <span class="attr">class</span>=<span class="string">"table table-striped table-bordered table-hover"</span>&gt;</span></div><div class="line">        <span class="template-variable">&#123;&#123; <span class="name">range</span> $item := .items &#125;&#125;</span><span class="xml"></span></div><div class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="template-variable">&#123;&#123; $item.Content &#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span></div><div class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></div><div class="line">        <span class="template-variable">&#123;&#123; end &#125;&#125;</span><span class="xml"></span></div><div class="line">    <span class="tag">&lt;/<span class="name">table</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"><span class="template-tag">&#123;% <span class="name">endraw</span> %&#125;</span><span class="xml"></span></div></pre></td></tr></table></figure>
<p>使用 “{{ }}“ 输出后端发送过来的数据。使用 range 迭代数据。与</p>
<figure class="highlight axapta"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> pos, <span class="keyword">char</span> := range <span class="keyword">str</span> &#123;</div><div class="line">...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>一样。</p>
<p>完整的模板代码：</p>
<figure class="highlight twig"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name">raw</span> %&#125;</span><span class="xml"></span></div><div class="line"><span class="comment">&lt;!-- public/index.html --&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"content-type"</span> <span class="attr">content</span>=<span class="string">"text/html; charset=utf-8"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span>糗百<span class="tag">&lt;/<span class="name">title</span>&gt;</span></div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"https://cdn.bootcss.com/bootstrap/3.3.6/css/bootstrap.min.css"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span>  <span class="attr">href</span>=<span class="string">"https://cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css"</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"row"</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-12"</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">h2</span>&gt;</span><span class="template-variable">&#123;&#123; .title &#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></div><div class="line">                    <span class="tag">&lt;<span class="name">table</span> <span class="attr">class</span>=<span class="string">"table table-striped table-bordered table-hover"</span>&gt;</span></div><div class="line">                        <span class="template-variable">&#123;&#123; <span class="name">range</span> $item := .items &#125;&#125;</span><span class="xml"></span></div><div class="line">                        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></div><div class="line">                            <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="template-variable">&#123;&#123; $item.Content &#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span></div><div class="line">                        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></div><div class="line">                        <span class="template-variable">&#123;&#123; end &#125;&#125;</span><span class="xml"></span></div><div class="line">                    <span class="tag">&lt;/<span class="name">table</span>&gt;</span></div><div class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div><div class="line"><span class="template-tag">&#123;% <span class="name">endraw</span> %&#125;</span><span class="xml"></span></div></pre></td></tr></table></figure>
<p>这样，运行一下，就可以了。</p>
<p>gin框架默认使用8080端口，打开<a href="http://localhost:8080就可以看到一个极简版的糗百热门了。" target="_blank" rel="external">http://localhost:8080就可以看到一个极简版的糗百热门了。</a></p>
<p>问题来了，怎么增加一个分页呢？</p>
<p>完整代码见:</p>
<p><a href="https://github.com/qichengzx/goqiubai" target="_blank" rel="external">Github地址</a></p>
<h4 id="后记">后记</h4><p>其实早就写完了这篇，但是hexo生成的时候由于 <a href="https://hexo.io/docs/troubleshooting.html#Escape-Contents" target="_blank" rel="external">“{{“的问题</a>，生成一直失败，一直拖到现在。</p>
<p>实际代码中需要去掉 “{ % raw % }” 相关部分。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.qichengzx.com/2016/12/04/go-qiubai.html" data-id="ciwcxcujb00137p3gw1rgblzf" class="article-share-link">Share</a>
      
        <a href="http://www.qichengzx.com/2016/12/04/go-qiubai.html#comments" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/gin/">gin</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/go/">go</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/goquery/">goquery</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/糗百/">糗百</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-install-yaf-on-mac" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/11/02/install-yaf-on-mac.html" class="article-date">
  <time datetime="2016-11-02T09:57:38.000Z" itemprop="datePublished">2016-11-02</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/php/">php</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/11/02/install-yaf-on-mac.html">Mac brew php7.1环境下安装Yaf</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="/images/php/think201-emergence-of-php7.jpg" alt=""></p>
<p>开发机一直使用brew来安装PHP及其他的环境，今天把PHP升到7.1，由于7.1版本下还没有<a href="http://www.laruence.com/manual/" target="_blank" rel="external">yaf</a>的源，所以无法使用brew安装，只能编译安装了。</p>
<p>首先下载yaf，解压，进入目录。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">git clone git<span class="meta">@github</span>.<span class="string">com:</span>laruence/yaf.git</div><div class="line"></div><div class="line">$(brew --prefix homebrew<span class="regexp">/php/</span>php71)<span class="regexp">/bin/</span>phpize</div><div class="line"></div><div class="line">.<span class="regexp">/configure --with-php-config=$(brew --prefix homebrew/</span>php<span class="regexp">/php71)/</span>bin/php-config</div><div class="line"></div><div class="line">make &amp;&amp; make install</div><div class="line"></div><div class="line">make test</div></pre></td></tr></table></figure>
<p>$(brew –prefix homebrew/php/php71) 即 brew info php71结果中的path值。</p>
<p>由于brew安装PHP会在php.ini同级目录创建conf.d目录，并把扩展的配置文件写在这里，一目了然知道都安装了哪些扩展，所以也以同样方式在此目录创建ext-yaf.ini。</p>
<p>make install 后会显示，具体路径可能会不一样。</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Installing shared <span class="symbol">extensions:</span>     /usr/local/Cellar/php71/<span class="number">7.1</span>.<span class="number">0</span>-rc.<span class="number">5_9</span>/<span class="class"><span class="keyword">lib</span>/<span class="title">php</span>/<span class="title">extensions</span>/<span class="title">no</span>-<span class="title">debug</span>-<span class="title">non</span>-<span class="title">zts</span>-20160303/</span></div></pre></td></tr></table></figure>
<p>这个目录即扩展.so的存放目录。下边会用到。</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[yaf]</div><div class="line"><span class="attribute">extension</span>=<span class="string">"/usr/local/opt/php71/lib/php/extensions/no-debug-non-zts-20160303/yaf.so"</span></div><div class="line">yaf.environ=<span class="string">"dev"</span></div><div class="line"><span class="comment">;yaf.use_namespace = 1</span></div></pre></td></tr></table></figure>
<p>至此，重启php-fpm就可以了。</p>
<p>####<br>图片来自：<a href="https://think201.com/blog/2016/emergence-of-php7/" target="_blank" rel="external">Emergence of PHP7</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.qichengzx.com/2016/11/02/install-yaf-on-mac.html" data-id="ciwcxcujh00177p3gfkh6gs7o" class="article-share-link">Share</a>
      
        <a href="http://www.qichengzx.com/2016/11/02/install-yaf-on-mac.html#comments" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/php/">php</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-beego-in-docker" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/10/21/beego-in-docker.html" class="article-date">
  <time datetime="2016-10-21T02:02:02.000Z" itemprop="datePublished">2016-10-21</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/golang/">golang</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/10/21/beego-in-docker.html">用Docker部署Golang Beego框架应用</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Docker是什么就不说了。<br>Golang是什么也不说了。<br>Beego是什么就更不用说了。</p>
<p>最近Beego项目完成，研究怎么部署。因为Docker部署起来更简单更快速，所以就说下怎么在docker里部署beego应用。</p>
<h4 id="写在前面">写在前面</h4><p>假设你的应用路径为 /go/app；<br>假设已配置好docker的相关东西。<br>假设使用 <a href="https://github.com/tools/godep" target="_blank" rel="external">godep</a> 作为依赖管理工具<br>示例中开放端口为80，需要与app.conf中的端口一致，可以自行修改。</p>
<h4 id="配置">配置</h4><p>在 /go/app 目录新建Dockerfile。</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">FROM golan<span class="variable">g:1</span>.<span class="number">7.1</span>-alpine</div><div class="line"></div><div class="line">MAINTAINER youremail &lt;youremail@xxx.<span class="keyword">com</span>&gt;</div><div class="line"></div><div class="line">RUN apk <span class="built_in">add</span> --<span class="keyword">update</span> <span class="keyword">go</span> git</div><div class="line"></div><div class="line">ADD ./ /<span class="keyword">go</span>/src/app</div><div class="line"></div><div class="line">RUN <span class="keyword">cd</span> /<span class="keyword">go</span>/src/app \</div><div class="line">	&amp;&amp; <span class="keyword">go</span> <span class="built_in">get</span> github.<span class="keyword">com</span>/astaxie/beego \</div><div class="line">	&amp;&amp; <span class="keyword">go</span> <span class="built_in">get</span> github.<span class="keyword">com</span>/tools/godep \</div><div class="line">	&amp;&amp; godep <span class="keyword">update</span> -goversion \</div><div class="line">	&amp;&amp; godep <span class="built_in">get</span> \</div><div class="line">	&amp;&amp; godep save \</div><div class="line">	&amp;&amp; <span class="keyword">go</span> build</div><div class="line"></div><div class="line">EXPOSE <span class="number">80</span></div><div class="line"></div><div class="line">EXTRYPOINT /<span class="keyword">go</span>/src/app/app</div></pre></td></tr></table></figure>
<p>本例使用 golang:1.7.1-alpine 作为基础镜像。golang的所有镜像见<a href="https://hub.docker.com/_/golang/" target="_blank" rel="external">这里</a>。</p>
<h4 id="构建">构建</h4><figure class="highlight armasm"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="symbol">docker</span> <span class="keyword">build </span>-t app .</div></pre></td></tr></table></figure>
<h4 id="运行">运行</h4><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker <span class="keyword">run</span><span class="bash"> <span class="_">-d</span> -p 8080:80 app</span></div></pre></td></tr></table></figure>
<h4 id="访问">访问</h4><p>使用nginx反向代理访问docker中的go应用。</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">    listen       80;</div><div class="line">    server_name  <span class="keyword">app</span>.com;</div><div class="line"></div><div class="line">    charset utf-8;</div><div class="line">    access_log  logs/<span class="keyword">app</span>.access.<span class="keyword">log</span>;</div><div class="line"></div><div class="line">    location / &#123;</div><div class="line">        try_files /_not_exists_ @backend;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (!-<span class="keyword">e</span> <span class="variable">$request_filename</span>) &#123;</div><div class="line">        <span class="keyword">return</span> 404;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    location @backend &#123;</div><div class="line">        proxy_set_header X-Forwarded-<span class="keyword">For</span> <span class="variable">$remote_addr</span>;</div><div class="line">        proxy_set_header Host            <span class="variable">$http_host</span>;</div><div class="line"></div><div class="line">        proxy_pass http:<span class="comment">//192.168.99.100:8080; // 192.168.99.100为docker machine的ip,8080为 docker run 时指定的本地端口。</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="相关资料">相关资料</h4><p><a href="https://yq.aliyun.com/articles/57247" target="_blank" rel="external">如何使用Docker快速部署go-web应用程序</a><br><a href="https://blog.golang.org/docker" target="_blank" rel="external">Deploying Go servers with Docker</a><br><a href="http://www.infoq.com/cn/articles/how-to-deploy-a-go-web-application-with-docker?utm_source=infoq&amp;utm_medium=related_content_link&amp;utm_campaign=relatedContent_articles_clk" target="_blank" rel="external">如何使用Docker部署Go Web应用程序</a><br><a href="https://www.iron.io/the-easiest-way-to-develop-with-go%E2%80%8A-%E2%80%8Aintroducing-a-docker-based-go-tool/" target="_blank" rel="external">The Easiest Way to Develop with Go — Introducing a Docker Based Go Tool</a><br><a href="https://semaphoreci.com/community/tutorials/how-to-deploy-a-go-web-application-with-docker" target="_blank" rel="external">How To Deploy a Go Web Application with Docker</a><br><a href="https://beego.me/docs/deploy/nginx.md" target="_blank" rel="external">nginx 部署</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.qichengzx.com/2016/10/21/beego-in-docker.html" data-id="ciwcxcuij000a7p3gjtrayewv" class="article-share-link">Share</a>
      
        <a href="http://www.qichengzx.com/2016/10/21/beego-in-docker.html#comments" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/go/">go</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-custom-data-pagination-in-laravel-with-arrays" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/09/28/custom-data-pagination-in-laravel-with-arrays.html" class="article-date">
  <time datetime="2016-09-28T07:43:13.000Z" itemprop="datePublished">2016-09-28</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/php/">php</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/09/28/custom-data-pagination-in-laravel-with-arrays.html">Laravel 手动创建分页</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>有些情况下会从接口读取数据，数据较多时会用到分页，Laravel为这种需求提供了很方便的方法。</p>
<p><a href="https://laravel.com/docs/5.2/pagination" target="_blank" rel="external">官方文档</a>里几句略过，并没有详细说明，经过查找资料，发现如下方法可行。</p>
<h3 id="首先use_LengthAwarePaginator">首先use LengthAwarePaginator</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Pagination</span>\<span class="title">LengthAwarePaginator</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">Collection</span>;</div></pre></td></tr></table></figure>
<p>假设原内容是：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">$result = [</div><div class="line">    <span class="string">'item1'</span>,</div><div class="line">    <span class="string">'item2'</span>,</div><div class="line">    <span class="string">'item3'</span>,</div><div class="line">    <span class="string">'item4'</span>,</div><div class="line">    <span class="string">'item5'</span>,</div><div class="line">    <span class="string">'item6'</span>,</div><div class="line">];</div></pre></td></tr></table></figure>
<p>对于一个列表来说，item一般会是个array，这里忽略。</p>
<h3 id="情况1，已知总数，只有部分数据">情况1，已知总数，只有部分数据</h3><p>由于本人所使用的接口有页码和每页数量的参数，所以每次查询返回的其实就是每一页的内容了，而接口又返回了符合条件的总数count，所以使用如下方式即可：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">$perPage = <span class="number">10</span>;</div><div class="line">$count = <span class="number">100</span>;<span class="comment">//假设这里是接口返回的总数</span></div><div class="line"><span class="comment">//创建collection</span></div><div class="line">$collection = <span class="keyword">new</span> Collection($data);</div><div class="line"></div><div class="line">$currentPageResults = $collection-&gt;all();</div><div class="line"></div><div class="line"><span class="comment">//生成分页</span></div><div class="line">$data = <span class="keyword">new</span> LengthAwarePaginator($currentPageResults, $count, $perPage);</div><div class="line"><span class="comment">//设置分页的链接</span></div><div class="line">$data-&gt;setPath($request-&gt;url());</div></pre></td></tr></table></figure>
<h3 id="情况2，未知总数，有全部数据">情况2，未知总数，有全部数据</h3><p>而如果$data是全部数据呢，比如100条数据全部返回，然后要生成一个每页10条记录的分页，可以这样做：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//获取当前页码</span></div><div class="line">$currentPage = LengthAwarePaginator::resolveCurrentPage();</div><div class="line"></div><div class="line"><span class="comment">//从数组创建一个laravel collection</span></div><div class="line">$collection = <span class="keyword">new</span> Collection($searchResults);</div><div class="line"></div><div class="line"><span class="comment">//设置每页数量</span></div><div class="line">$perPage = <span class="number">10</span>;</div><div class="line"></div><div class="line"><span class="comment">//从collection分割数据</span></div><div class="line">$currentPageSearchResults = $collection-&gt;slice($currentPage * $perPage, $perPage)-&gt;all();</div><div class="line"></div><div class="line"><span class="comment">//生成分页</span></div><div class="line">$paginatedSearchResults= <span class="keyword">new</span> LengthAwarePaginator($currentPageSearchResults, count($collection), $perPage);</div><div class="line"><span class="comment">//设置分页的链接</span></div><div class="line">$data-&gt;setPath($request-&gt;url());</div></pre></td></tr></table></figure>
<h3 id="区别">区别</h3><p>其实两者只是相差了一次分割数据。</p>
<h3 id="最后">最后</h3><p>在视图里依然使用</p>
<figure class="highlight erlang-repl"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;!! $data-&gt;render() !!&#125;</div></pre></td></tr></table></figure>
<p>输出分页组件。</p>
<p>看起来还挺简单的。</p>
<h3 id="参考链接：">参考链接：</h3><p><a href="https://laravel.com/docs/5.2/pagination" target="_blank" rel="external">官方文档pagination</a></p>
<p><a href="http://psampaz.github.io/custom-data-pagination-with-laravel-5/" target="_blank" rel="external">Custom data pagination with Laravel 5</a></p>
<p><a href="http://www.acekyd.com/2016/02/28/custom-pagination-view-in-laravel-5-with-arrays/" target="_blank" rel="external">CUSTOM PAGINATION VIEW IN LARAVEL 5 WITH ARRAYS</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.qichengzx.com/2016/09/28/custom-data-pagination-in-laravel-with-arrays.html" data-id="ciwcxcuiw000l7p3gj6hd63qq" class="article-share-link">Share</a>
      
        <a href="http://www.qichengzx.com/2016/09/28/custom-data-pagination-in-laravel-with-arrays.html#comments" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/laravel/">laravel</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/php/">php</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-convert-xml-to-json-in-golang" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/09/16/convert-xml-to-json-in-golang.html" class="article-date">
  <time datetime="2016-09-16T03:28:20.000Z" itemprop="datePublished">2016-09-16</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/golang/">golang</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/09/16/convert-xml-to-json-in-golang.html">Golang XMl 转 JSON</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="/images/golang.png" alt=""></p>
<h4 id="起因">起因</h4><p>某个上古时代的API，依然在返回XML格式的数据，更奇葩的是，GBK格式的。</p>
<p>用Go顺利的写到了发送数据，接收数据，然后取值有点麻烦啊。。。。</p>
<p>各种Google后，终于解决，但是不保证是唯一，正确，最合适的答案。</p>
<h4 id="说在前边">说在前边</h4><p>本文假设要解析的XMl数据为：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"GBK"</span> <span class="meta">?&gt;</span></span></div><div class="line"><span class="tag">&lt;<span class="name">response</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">status</span>&gt;</span>200<span class="tag">&lt;/<span class="name">status</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">response</span>&gt;</span></div></pre></td></tr></table></figure>
<p>要解决的问题是取出“200”这个状态值。</p>
<h4 id="导入包">导入包</h4><p>解析XML使用了”encoding/xml”这个包。</p>
<p>所以先导入这个包。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> <span class="string">"encoding/xml"</span></div></pre></td></tr></table></figure>
<h4 id="定义struct">定义struct</h4><p>定义一个自定义类型的Response</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Response <span class="keyword">struct</span> &#123;</div><div class="line">    Status <span class="keyword">int</span> <span class="string">`xml:"status" json:"status"`</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>定义一个Response类型的变量</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> result Response</div></pre></td></tr></table></figure>
<h4 id="偷懒转格式">偷懒转格式</h4><p>因为”encoding/xml”不支持GBK格式的XML，而返回的内容又固定标明了编码是GBK，所以这里偷懒，直接把GBK替换成UTF-8，本例中不影响结果。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">xmlstr := <span class="string">`?xml version="1.0" encoding="GBK" ?&gt;</span></div><div class="line">&lt;response&gt;</div><div class="line">    &lt;status&gt;200&lt;/status&gt;</div><div class="line">&lt;/response&gt;</div><div class="line">`</div><div class="line">xmlstr = strings.Replace(xmlstr, <span class="string">"GBK"</span>, <span class="string">"UTF-8"</span>, <span class="number">-1</span>)</div></pre></td></tr></table></figure>
<p>使用strings包，替换“GBK”，相信根据参数顺序能看出各个参数的意义，最后一个参数：-1，为替换全部，即字符串中所有出现的第二个参数全部替换。</p>
<h4 id="解析，转换，取值">解析，转换，取值</h4><p>使用encoding/jon，go-simplejson包</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//解析XML</span></div><div class="line">err := xml.Unmarshal([]<span class="keyword">byte</span>(xmlstr), &amp;result)</div><div class="line"></div><div class="line"><span class="keyword">if</span> <span class="literal">nil</span> != err &#123;</div><div class="line">  log.Fatal(err)</div><div class="line">&#125;</div><div class="line">log.Printf(<span class="string">"XML:%v \n"</span>, result) </div><div class="line"></div><div class="line"><span class="comment">//转换成JSON</span></div><div class="line">res, err := json.Marshal(result)</div><div class="line"></div><div class="line"><span class="keyword">if</span> <span class="literal">nil</span> != err &#123;</div><div class="line">  log.Fatal(err)</div><div class="line">&#125;</div><div class="line">log.Printf(<span class="string">"JSON:%s \n"</span>, res)</div><div class="line"></div><div class="line">js, err := simplejson.NewJson([]<span class="keyword">byte</span>(res))</div><div class="line"></div><div class="line"><span class="keyword">if</span> <span class="literal">nil</span> != err &#123;</div><div class="line">  log.Fatal(err)</div><div class="line">&#125;</div><div class="line">status, err := js.Get(<span class="string">"status"</span>).Int()</div><div class="line"></div><div class="line">log.Printf(<span class="string">"STATUS:%v \n"</span>, status)</div></pre></td></tr></table></figure>
<p>以上是本人在处理XML 转 JSON 时的解决办法，应该还有更简单更合适的方案。仅供参考。</p>
<h4 id="完整代码：">完整代码：</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"encoding/xml"</span></div><div class="line">    <span class="string">"encoding/json"</span></div><div class="line">    <span class="string">"log"</span></div><div class="line">    <span class="string">"strings"</span></div><div class="line">    simplejson <span class="string">"github.com/bitly/go-simplejson"</span></div><div class="line">)</div><div class="line"><span class="keyword">type</span> Response <span class="keyword">struct</span> &#123;</div><div class="line">    Status <span class="keyword">int</span> <span class="string">`xml:"status" json:"status"`</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    </div><div class="line">    <span class="keyword">var</span> result Response</div><div class="line"></div><div class="line">    <span class="comment">//多行字符串，使用反引号`</span></div><div class="line">    xmlstr := <span class="string">`&lt;?xml version="1.0" encoding="GBK" ?&gt;</span></div><div class="line">&lt;response&gt;</div><div class="line">    &lt;status&gt;200&lt;/status&gt;</div><div class="line">&lt;/response&gt;`</div><div class="line"></div><div class="line">    xmlstr = strings.Replace(xmlstr, <span class="string">"GBK"</span>, <span class="string">"UTF-8"</span>, <span class="number">-1</span>)</div><div class="line"></div><div class="line">    err := xml.Unmarshal([]<span class="keyword">byte</span>(xmlstr), &amp;result)</div><div class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">        log.Fatal(err)</div><div class="line">    &#125;</div><div class="line">    log.Printf(<span class="string">"XML:%v"</span>,result)</div><div class="line"></div><div class="line">    r, err := json.Marshal(result)</div><div class="line">    <span class="keyword">if</span> <span class="literal">nil</span> != err &#123;</div><div class="line">        log.Fatal(err)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    log.Printf(<span class="string">"JSON:%s"</span>, r)</div><div class="line"></div><div class="line">    js, err := simplejson.NewJson([]<span class="keyword">byte</span>(r))</div><div class="line"></div><div class="line">    <span class="keyword">if</span> <span class="literal">nil</span> != err &#123;</div><div class="line">        log.Fatal(err)</div><div class="line">    &#125;</div><div class="line">    status, err := js.Get(<span class="string">"status"</span>).Int()</div><div class="line">    log.Printf(<span class="string">"VALUE:%v"</span>,status)</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="发现问题：">发现问题：</h4><p>今天（2016-09-18），再看这段代码，发现跟另一个程序里有些不一样。</p>
<p>另一个程序里是这样的：<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">type</span> <span class="title">Response</span></span> <span class="class"><span class="keyword">struct</span> &#123;</span></div><div class="line">    Status <span class="keyword">int</span> `xml:<span class="string">"status"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>也可以正常返回值，但是在本文中的示例却不能正常输出status值，而是会输出空，看了半天发现，使用 log 时：<br><figure class="highlight maxima"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">log</span>.Printf(<span class="string">"VALUE:%v"</span>,<span class="built_in">status</span>)</div></pre></td></tr></table></figure></p>
<p>如果struct没有写<br>“json:”status””，就不能输出，如果换成fmt，struct就可以不写“json:”status”。结果是一样的，其中的原因还要再查资料研究下。</p>
<p>参考文章：</p>
<p><a href="http://blog.studygolang.com/2012/12/%e6%a0%87%e5%87%86%e5%ba%93-xml%e5%a4%84%e7%90%86%ef%bc%88%e4%b8%80%ef%bc%89/" target="_blank" rel="external">标准库—XML处理（一）</a></p>
<p><a href="https://play.golang.org/p/7HNLEUnX-m" target="_blank" rel="external">https://play.golang.org/p/7HNLEUnX-m</a></p>
<p><a href="https://play.golang.org/p/m99B12RaLe" target="_blank" rel="external">https://play.golang.org/p/m99B12RaLe</a></p>
<p><a href="https://astaxie.gitbooks.io/build-web-application-with-golang/content/zh/07.1.html" target="_blank" rel="external">XML处理</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.qichengzx.com/2016/09/16/convert-xml-to-json-in-golang.html" data-id="ciwcxcuit000i7p3giw4j1jqs" class="article-share-link">Share</a>
      
        <a href="http://www.qichengzx.com/2016/09/16/convert-xml-to-json-in-golang.html#comments" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/go/">go</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Hello-Go" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/09/11/Hello-Go.html" class="article-date">
  <time datetime="2016-09-11T09:21:03.000Z" itemprop="datePublished">2016-09-11</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/golang/">golang</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/09/11/Hello-Go.html">Hello Go</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h5 id="Mac_安装_GO">Mac 安装 GO</h5><p>本人使用了Brew来安装。</p>
<h5 id="安装前首先更新Brew。">安装前首先更新Brew。</h5><figure class="highlight armasm"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">brew </span>update &amp;&amp; <span class="keyword">brew </span>upgrade</div></pre></td></tr></table></figure>
<h5 id="安装Go">安装Go</h5><p>使用brew安装go</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">brew </span><span class="keyword">install </span>go</div></pre></td></tr></table></figure>
<h5 id="设置$GOPATH">设置$GOPATH</h5><p>Go从1.1版本开始必须设置这个变量，也就是说通过以上方式安装后就必须要设置$GOPATH了。</p>
<p>这个目录用来存放Go源码，可运行文件，和编译之后的包文件。</p>
<p>Mac系统设置</p>
<p>在bash中加入：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">export GOPATH=/your/path</div></pre></td></tr></table></figure>
<p>以上目录需要存在，不存在就自己手动创建一个。</p>
<p>然后运行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">source ~/.zshrc</div></pre></td></tr></table></figure>
<p>替换成你自己使用的shell，如.bashrc等。</p>
<p>然后，需要在/your/path目录下，新建 pkg，bin，src目录。</p>
<p>​    src目录存放源代码，如hello.go</p>
<p>​    pkg目录存放编译后的文件，如hello.a</p>
<p>​    bin目录存放生成后的可执行文件</p>
<p>src目录就是主要开发目录。如hello项目，则在src下新建hello目录。</p>
<p>到这里，就可以开始Go之旅了。</p>
<h5 id="Hello_Go">Hello Go</h5><p>需要注意的是，在Go中，包名和文件名是可以不同的，包名为main的时候即为可以独立运行的包。</p>
<p>在src目录新建hello目录，创建hello.go文件。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main <span class="comment">//包名</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span> <span class="comment">//导入一个系统级别的fmt包</span></div><div class="line"></div><div class="line"><span class="comment">//使用func定义函数</span></div><div class="line"><span class="comment">//main函数没有参数，没有返回值</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">  fmt.Println(<span class="string">"Hello Go"</span>) <span class="comment">//调用包函数的方法为 pkgName.funcName</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>一个hello.go就写好了，在命令行输入</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">go</span> run hello.<span class="keyword">go</span></div></pre></td></tr></table></figure>
<p>就可以看到输出Hello Go了。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.qichengzx.com/2016/09/11/Hello-Go.html" data-id="ciwcxcuhl00007p3gfocva2we" class="article-share-link">Share</a>
      
        <a href="http://www.qichengzx.com/2016/09/11/Hello-Go.html#comments" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/go/">go</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-php-post-file-with-curl" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/07/02/php-post-file-with-curl.html" class="article-date">
  <time datetime="2016-07-02T15:11:30.000Z" itemprop="datePublished">2016-07-02</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/php/">php</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/07/02/php-post-file-with-curl.html">PHP Curl 上传文件</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>有时候会遇到上传文件给第三方服务的情况，比如本身程序并不需要存储附件，而是把附件发送给一个公共的服务。</p>
<p>最近正好碰到这个问题，记录一下。</p>
<p>上代码。</p>
<h4 id="发送端：">发送端：</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="comment">// 接口地址</span></div><div class="line">$api = <span class="string">'http://api.example.com/uploadfile'</span>;</div><div class="line">$file = $_FILES[<span class="string">'file'</span>];<span class="comment">//保存$_FILES到变量中。</span></div><div class="line"></div><div class="line"><span class="comment">// 此处可能存在上传失败等问题，需验证$_FILES["file"]["error"]。</span></div><div class="line"><span class="comment">// 做业务对应的规则验证，如文件格式，文件大小等。</span></div><div class="line"></div><div class="line"><span class="comment">// 创建一个 cURL 句柄</span></div><div class="line">$ch = curl_init($api);</div><div class="line"></div><div class="line"><span class="comment">// 创建一个 CURLFile 对象</span></div><div class="line"><span class="comment">// 上传文件的路径，文件的Mimetype，文件名</span></div><div class="line">$cfile = curl_file_create($file[<span class="string">'tmp_name'</span>],$file[<span class="string">'type'</span>],$file[<span class="string">'name'</span>]);</div><div class="line"></div><div class="line">$data = [</div><div class="line">	<span class="string">'type'</span>=&gt;<span class="string">'image'</span>,</div><div class="line">	<span class="string">'data'</span>=&gt;$cfile</div><div class="line">];</div><div class="line"></div><div class="line"><span class="comment">// 设置 POST 数据</span></div><div class="line">curl_setopt($ch, CURLOPT_POST,<span class="number">1</span>);</div><div class="line">curl_setopt($ch, CURLOPT_POSTFIELDS, $data);</div><div class="line"></div><div class="line">$resp = curl_exec($ch);</div><div class="line"></div><div class="line"><span class="keyword">if</span>(!$resp) &#123;</div><div class="line">  <span class="keyword">die</span>(<span class="string">'Error: "'</span> . curl_error($ch) . <span class="string">'" - Code: '</span> . curl_errno($ch));</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">  <span class="keyword">echo</span> <span class="string">"Response HTTP Status Code : "</span> . curl_getinfo($ch, CURLINFO_HTTP_CODE);</div><div class="line">  <span class="keyword">echo</span> <span class="string">"\nResponse HTTP Body : "</span> . $resp;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Close request to clear up some resources</span></div><div class="line">curl_close($ch);</div></pre></td></tr></table></figure>
<h4 id="接收端：">接收端：</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span> </div><div class="line">var_dump($_FILES);<span class="comment">// 接收文件内容</span></div><div class="line">va_dump($_POST);<span class="comment">// 接收type</span></div></pre></td></tr></table></figure>
<h4 id="前端：">前端：</h4><p>前端可使用Form或其他Ajax方式上传。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.qichengzx.com/2016/07/02/php-post-file-with-curl.html" data-id="ciwcxcuk3001k7p3gi3k1czom" class="article-share-link">Share</a>
      
        <a href="http://www.qichengzx.com/2016/07/02/php-post-file-with-curl.html#comments" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/php/">php</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-a-sample-redis-queue" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/05/15/a-sample-redis-queue.html" class="article-date">
  <time datetime="2016-05-15T06:19:52.000Z" itemprop="datePublished">2016-05-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/php/">php</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/05/15/a-sample-redis-queue.html">一个简单的php+redis队列示例</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="/images/redis/redis-300dpi.png" alt=""></p>
<p>虽然RabbitMQ的坑年前就开始填了，但是并没有机会在项目中实际使用，机缘巧合，换工作后第一个比较重要的事就是做一个直播的页面，如果数据直接插入或读取自数据库，数据库端的压力就太大了，当时RabbitMQ还没看完，而其他的队列程序更是没有用过，只是稍微对Redis熟悉些，于是就使用了Redis做。</p>
<p><a href="http://redis.io/" target="_blank" rel="external">Redis</a>比较常见的是作为数据缓存工具使用，数据存储在内存中，减少了数据库的连接和查询，效率高，又方便。</p>
<p>而其实Redis也可以用来做消息队列。</p>
<h3 id="发送">发送</h3><p>发送端首先当然是做好数据的接收和检测，比如为空的情况下给个默认值或返回错误。</p>
<p>特殊的情况下可能还要正则处理。</p>
<p>处理完插入到Redis的list(<a href="http://www.redis.cn/topics/data-types-intro.html#lists" target="_blank" rel="external">列表</a>)中。如果插入失败抛出异常。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line">$redis = <span class="keyword">new</span> Redis();</div><div class="line">$redis-&gt;connect(<span class="string">'127.0.0.1'</span>);</div><div class="line"></div><div class="line"><span class="comment">//如果redis需要认证</span></div><div class="line">$redis-&gt;auth(<span class="string">'redispasswd'</span>);</div><div class="line"></div><div class="line"><span class="comment">//命令行中使用，可以使用把信息作为参数的方式</span></div><div class="line">$data = $argv[<span class="number">1</span>];</div><div class="line"><span class="keyword">if</span>(<span class="keyword">empty</span>($data)) $data = <span class="string">"Hello World..!"</span>:</div><div class="line"></div><div class="line"><span class="keyword">try</span>&#123;</div><div class="line">	<span class="comment">//便于调试，在信息后边加上当前时间</span></div><div class="line">	$data .= <span class="string">'-at-'</span>.date(<span class="string">'Y-m-d H:i:s'</span>);</div><div class="line">	$redis-&gt;LPUSH(<span class="string">'redis_queue_1'</span>,json_encode($data));</div><div class="line">&#125;<span class="keyword">catch</span>(<span class="keyword">Exception</span> $e)&#123;</div><div class="line">	<span class="keyword">echo</span> $e-&gt;getMessage().<span class="string">"\n"</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="执行">执行</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">php push.php &quot;testinfo&quot;</div></pre></td></tr></table></figure>
<h3 id="接收">接收</h3><p>由于消息是源源不断发送到队列中，所以接收端程序一般会以后台进程的方式运行。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line">$redis = <span class="keyword">new</span> Redis();</div><div class="line">$redis-&gt;connect(<span class="string">'127.0.0.1'</span>);</div><div class="line"></div><div class="line">$redis-&gt;auth(<span class="string">'redispasswd'</span>);</div><div class="line"></div><div class="line"><span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line"></div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">		$data = $redis-&gt;rPopLPush(<span class="string">'redis_queue_1'</span>,<span class="string">'redis_queue_1_bak'</span>).<span class="string">"\n"</span>;</div><div class="line">		<span class="keyword">if</span>($data)&#123;</div><div class="line">			<span class="keyword">echo</span> $data;</div><div class="line">		&#125;<span class="keyword">else</span>&#123;</div><div class="line">			<span class="keyword">echo</span> <span class="string">"没有数据\n"</span>;</div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">catch</span> (<span class="keyword">Exception</span> $e) &#123;</div><div class="line">		<span class="keyword">echo</span> $e-&gt;getMessage().<span class="string">"\n"</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//每秒读取1次</span></div><div class="line">	sleep(<span class="number">1</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="执行-1">执行</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">php get.php</div></pre></td></tr></table></figure>
<h3 id="更进一步">更进一步</h3><p>如果想把数据写入到MySQL中，该怎么办？</p>
<p>大多数情况下数据最终是需要持久化的，仅仅存在于redis中，也许内存会不够呢。</p>
<p>改造一下get.php。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line">$redis = <span class="keyword">new</span> Redis();</div><div class="line">$redis-&gt;connect(<span class="string">'127.0.0.1'</span>);</div><div class="line"></div><div class="line">$redis-&gt;auth(<span class="string">'redispasswd'</span>);</div><div class="line"></div><div class="line">$dsn = <span class="string">'mysql:dbname=test;host=127.0.0.1'</span>;</div><div class="line"></div><div class="line"><span class="keyword">try</span>&#123;</div><div class="line">	$pdo = <span class="keyword">new</span> PDO($dsn,<span class="string">'root'</span>,<span class="string">'mysqlpasswd'</span>,<span class="keyword">array</span>(PDO::MYSQL_ATTR_INIT_COMMAND =&gt; <span class="string">'SET NAMES utf8'</span>));</div><div class="line">&#125;<span class="keyword">catch</span>(PDOExcetion $e)&#123;</div><div class="line">	<span class="keyword">echo</span> $e-&gt;getMessage().<span class="string">"\n"</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</div><div class="line">	$data = $redis-&gt;rPopLPush(<span class="string">'redis_queue_1'</span>,<span class="string">'redis_queue_1_bak'</span>);</div><div class="line">	<span class="keyword">if</span>($data)&#123;</div><div class="line">		$sth = $pdo-&gt;prepare(<span class="string">"INSERT INTO tb_test(msg,time) VALUES (:msg,:time)"</span>);</div><div class="line">		</div><div class="line">		$time = time();</div><div class="line">		</div><div class="line">		$sth-&gt;bindParam(<span class="string">':msg'</span>,$data,PDO::PARAM_STR);</div><div class="line">		$sth-&gt;bindParam(<span class="string">':time'</span>,$time,PDO::PARAM_INT);</div><div class="line">		</div><div class="line">		$sth-&gt;execute();</div><div class="line">		$id = $pdo-&gt;lastInsertId();</div><div class="line">      </div><div class="line">		<span class="keyword">echo</span> <span class="string">"插入成功，ID=$id \n"</span>;</div><div class="line">	&#125;<span class="keyword">else</span>&#123;</div><div class="line">		<span class="keyword">echo</span> <span class="string">"没有数据 \n"</span>;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="comment">//实际任务中可能需要尽可能快的把数据导入到MySQL中</span></div><div class="line">	sleep(<span class="number">1</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="注意">注意</h4><p>​    这里使用了<a href="http://php.net/manual/zh/book.pdo.php" target="_blank" rel="external">PDO</a>;</p>
<p>​    <a href="http://php.net/manual/zh/pdostatement.bindparam.php" target="_blank" rel="external">bindParam</a>方法的第一个参数对应insert语句中的对应顺序的值，如第一个bindParam方法对应第一个value值。</p>
<p>​    bindParam方法第二个参数为实际的值，传入变量或固定值，传入方法调用时如time()会提示：</p>
<p>Strict standards: Only variables should be passed by reference in /www/get.php on line 24。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.qichengzx.com/2016/05/15/a-sample-redis-queue.html" data-id="ciwcxcuir000f7p3gita4fw35" class="article-share-link">Share</a>
      
        <a href="http://www.qichengzx.com/2016/05/15/a-sample-redis-queue.html#comments" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/php/">php</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/redis/">redis</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/队列/">队列</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-cant-post-iqiyi-video-to-discuz" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/05/08/cant-post-iqiyi-video-to-discuz.html" class="article-date">
  <time datetime="2016-05-08T10:57:24.000Z" itemprop="datePublished">2016-05-08</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/javascript/">javascript</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/05/08/cant-post-iqiyi-video-to-discuz.html">解决Discuz无法发布爱奇艺视频的问题</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="/images/discuz/201510148054_136.jpg" alt=""></p>
<p>最近碰到需要在Discuz论坛中插入爱奇艺视频的问题，之前没关注过，搜索后有些答案说DZ不支持爱奇艺，有些说爱奇艺不支持DZ，并没有真正能解决问题的。</p>
<p>下午突然想到也许是DZ根据粘贴进来的flash地址生成的标签代码不对，试验后发现果然是这个原因。</p>
<p>打卡/static/js/editor.js 文件第1299行查看这段代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">case</span> <span class="string">'vid'</span>:</div><div class="line">	<span class="keyword">var</span> mediaUrl = $(ctrlid + <span class="string">'_param_1'</span>).value;</div><div class="line">	<span class="keyword">var</span> auto = <span class="string">''</span>;</div><div class="line">	<span class="keyword">var</span> posque = mediaUrl.lastIndexOf(<span class="string">'?'</span>);</div><div class="line">	posque = posque === <span class="number">-1</span> ? mb_strlen(mediaUrl) : posque;</div><div class="line">	<span class="keyword">var</span> ext = mediaUrl.lastIndexOf(<span class="string">'.'</span>) === <span class="number">-1</span> ? <span class="string">''</span> : mediaUrl.substring(mediaUrl.lastIndexOf(<span class="string">'.'</span>) + <span class="number">1</span>, posque).toLowerCase();</div><div class="line">	ext = in_array(ext, [<span class="string">'mp3'</span>, <span class="string">'wma'</span>, <span class="string">'ra'</span>, <span class="string">'rm'</span>, <span class="string">'ram'</span>, <span class="string">'mid'</span>, <span class="string">'asx'</span>, <span class="string">'wmv'</span>, <span class="string">'avi'</span>, <span class="string">'mpg'</span>, <span class="string">'mpeg'</span>, <span class="string">'rmvb'</span>, <span class="string">'asf'</span>, <span class="string">'mov'</span>, <span class="string">'flv'</span>, <span class="string">'swf'</span>]) ? ext : <span class="string">'x'</span>;</div><div class="line">	<span class="keyword">if</span>(ext == <span class="string">'x'</span>) &#123;</div><div class="line">		<span class="keyword">if</span>(<span class="regexp">/^mms:\/\//</span>.test(mediaUrl)) &#123;</div><div class="line">			ext = <span class="string">'mms'</span>;</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="regexp">/^(rtsp|pnm):\/\//</span>.test(mediaUrl)) &#123;</div><div class="line">			ext = <span class="string">'rtsp'</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">var</span> str = <span class="string">'[media='</span> + ext + <span class="string">','</span> + $(ctrlid + <span class="string">'_param_2'</span>).value + <span class="string">','</span> + $(ctrlid + <span class="string">'_param_3'</span>).value + <span class="string">']'</span> + squarestrip(mediaUrl) + <span class="string">'[/media]'</span>;</div><div class="line">	insertText(str, str.length, <span class="number">0</span>, <span class="literal">false</span>, sel);</div><div class="line">	<span class="keyword">break</span>;</div></pre></td></tr></table></figure>
<p>Discuz根据主流的视频网站的视频地址格式写的规则，生成discuz专用的[media]标签，在前台输出的时候再解析成embed这样的HTML代码。</p>
<p>解析之后的差不多就是这样：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">embed</span> <span class="attr">src</span>=<span class="string">"http://player.video.qiyi.com/7b42a1a27ff121c201ee5e6c6d757817/0/0/v_19rrklq2bs.swf-albumId=406283300-tvId=406283300-isPurchase=2-cnId=1"</span> <span class="attr">allowFullScreen</span>=<span class="string">"true"</span> <span class="attr">quality</span>=<span class="string">"high"</span> <span class="attr">width</span>=<span class="string">"480"</span> <span class="attr">height</span>=<span class="string">"350"</span> <span class="attr">align</span>=<span class="string">"middle"</span> <span class="attr">allowScriptAccess</span>=<span class="string">"always"</span> <span class="attr">type</span>=<span class="string">"application/x-shockwave-flash"</span>&gt;</span><span class="tag">&lt;/<span class="name">embed</span>&gt;</span></div></pre></td></tr></table></figure>
<p>而不那么主流的爱奇艺的flash地址则是：”<a href="http://player.video.qiyi.com/7b42a1a27ff121c201ee5e6c6d757817/0/0/v_19rrklq2bs.swf-albumId=406283300-tvId=406283300-isPurchase=2-cnId=1”，查看上一段代码可以看到，discuz会用正则去看粘贴的地址最后一个&quot;.&quot;后的后缀，如果这个后缀不在自己的已知flash格式数组中，就把类型设为&quot;x&quot;，也就是生成的标签成了[media=x,500,350]。" target="_blank" rel="external">http://player.video.qiyi.com/7b42a1a27ff121c201ee5e6c6d757817/0/0/v_19rrklq2bs.swf-albumId=406283300-tvId=406283300-isPurchase=2-cnId=1”，查看上一段代码可以看到，discuz会用正则去看粘贴的地址最后一个&quot;.&quot;后的后缀，如果这个后缀不在自己的已知flash格式数组中，就把类型设为&quot;x&quot;，也就是生成的标签成了[media=x,500,350]。</a></p>
<p>再到了前台解析，不认识，直接生成一个a标签。</p>
<p>所以，我的解决办法是：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span>(ext == <span class="string">'x'</span>) &#123;</div><div class="line">	<span class="keyword">if</span>(<span class="regexp">/^mms:\/\//</span>.test(mediaUrl)) &#123;</div><div class="line">		ext = <span class="string">'mms'</span>;</div><div class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="regexp">/^(rtsp|pnm):\/\//</span>.test(mediaUrl)) &#123;</div><div class="line">		ext = <span class="string">'rtsp'</span>;</div><div class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (mediaUrl.indexOf(<span class="string">'player.video.qiyi.com'</span>)) &#123;</div><div class="line">  		ext = <span class="string">'swf'</span>;	</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>增加一个else if 判断是否包含爱奇艺播放器的域名，当用户粘贴的flash地址包含这个字符串时，就认为是粘贴了一个爱奇艺的视频，存储的格式也就成了[media=swf]。</p>
<p>但是这里其实不是十分严谨，如果一个非法的flash地址很巧合的包含了这个字符串，也会认为是flash了，那这种情况下就会出错了。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.qichengzx.com/2016/05/08/cant-post-iqiyi-video-to-discuz.html" data-id="ciwcxcuj0000o7p3grrz5qlza" class="article-share-link">Share</a>
      
        <a href="http://www.qichengzx.com/2016/05/08/cant-post-iqiyi-video-to-discuz.html#comments" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/discuz/">discuz</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/js/">js</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/爱奇艺/">爱奇艺</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-php-rabbitmq-tutorial-six" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/05/03/php-rabbitmq-tutorial-six.html" class="article-date">
  <time datetime="2016-05-03T06:35:20.000Z" itemprop="datePublished">2016-05-03</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/php/">php</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/05/03/php-rabbitmq-tutorial-six.html">PHP RabbitMQ 教程（六） - 远程调用</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="远程调用">远程调用</h3><p>在<a href="/2016/04/17/php-rabbitmq-tutorial-two.html">第二节</a>中，我们学习了如何使用工作队列在多个worker中分发耗时任务。</p>
<p>但是如果我们需要在远程运行一个函数并等待返回结果怎么办？这是两码事，这个模式通常被称为远程过程调用（Remote Procedure Call，RPC）。</p>
<p>在本节中我们准备使用RabbitMQ构建一个RPC系统：一个客户端和一个可扩展的RPC服务端。由于我们没有值得分发的耗时任务，我们准备创建一个假的返回<a href="https://en.wikipedia.org/wiki/Fibonacci_number" target="_blank" rel="external">斐波那契数列</a>的RPC服务。</p>
<h3 id="客户端接口">客户端接口</h3><p>我们创建一个简单的客户端类来说明RPC服务如何使用。这个类会展示call方法如何发送一个RPC请求并且阻塞，直到接收到返回值。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$fibonacci_rpc = <span class="keyword">new</span> FibonacciRpcClient();</div><div class="line">$response = $fibonacci_rpc-&gt;call(<span class="number">30</span>);</div><div class="line"><span class="keyword">echo</span> <span class="string">"[.] Got "</span>, $response, <span class="string">"\n"</span>;</div></pre></td></tr></table></figure>
<h4 id="RPC注意事项">RPC注意事项</h4><p>尽管RPC在计算机学中很常见，但它十分挑剔。当程序员不知道是否是调用一个本地的方法还是一个很慢的RPC会出现这个问题。这样的困惑便导致不可预测的系统并增加不必要的调试复杂性。比起简化的软件，误用RPC会导致不可维护的无头绪代码。</p>
<p>记住刚才的内容，考虑下面的建议：</p>
<p>​    确保可以明显的看出哪个方法调用的是本地的哪个是远程的。</p>
<p>​    系统文档化。让组件之间的依赖变得清晰可见。</p>
<p>​    错误处理。当RPC服务长时间关闭客户端该作何反应？</p>
<p>如果有疑问，则尽量避免使用RPC。如果可以话，你应该使用异步管道——而不是RPC——像阻塞，结果被异步推送到下个计算阶段。</p>
<h3 id="回调队列">回调队列</h3><p>通常在RabbitMQ上做RPC很简单。客户端发送请求消息，服务端回复消息。为了接收响应消息，我们需要在请求中附带一个”callback”队列地址，我们可以使用默认的队列。来试一试：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">list</span>($queue_name, ,) = $channel-&gt;queue_declare(<span class="string">""</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">true</span>, <span class="keyword">false</span>);</div><div class="line"></div><div class="line">$msg = <span class="keyword">new</span> AMQPMessage(</div><div class="line">	$payload,</div><div class="line">	<span class="keyword">array</span>(<span class="string">'reply_to'</span> =&gt; $queue_name));</div><div class="line"></div><div class="line">$channel-&gt;basic_publish($msg, <span class="string">''</span>, <span class="string">'rpc_queue'</span>);</div><div class="line"></div><div class="line"><span class="comment"># ... then code to read a response message from the callback_queue</span></div></pre></td></tr></table></figure>
<h4 id="消息属性">消息属性</h4><p>AMQP协议定义了14个消息属性。大部分不常用，下面的除外：</p>
<p>​    delivery_mode：值为2时表示持久化，1为临时的。也许你还记得这个属性来自第二节。</p>
<p>​    content_type：编码格式，比如经常用的JSON格式，良好的做法是设置为：application/json。</p>
<p>​    reply_to：通常用来定义回调队列名称。</p>
<p>​    correlation_id：用来关联RPC的响应和请求。</p>
<h3 id="Correlation_Id">Correlation Id</h3><p>在上面的方法中我们建议为每一个RPC请求创建一个回调队列。这样非常低效，但是幸运的是有更好的办法 - 我们可以为每一个客户端创建一个单独的回调队列。</p>
<p>这样又带来一个新的问题，在队列接收到响应时，并不知道属于哪个请求。这也正是correlation_id属性要发挥的作用。我们为每一个请求的设定一个唯一的correlation_id值，然后，当在回调队列接收到消息时会查看它的属性，基于此，我们就可以把响应和请求进行匹配。如果发现一个未知的correlation_id值，可以安全的忽略掉这条消息 - 因为它不属于任何请求。</p>
<p>也许你会问，为什么应该忽略回调队列里的未知消息，而不是返回一个错误？因为服务可能会出现紊乱的情况，虽然不太可能，但是如果发生这种情况，RPC服务会在发送完响应后挂掉，但是还没有进行消息确认。如果发生了，重启RPC服务后会再次处理这个请求。这就是为什么在客户端我们必须适当的处理重复请求，而RPC服务最好的幂等的。</p>
<h3 id="总结">总结</h3><p><img src="/images/rabbitmq/python-six.png" alt=""></p>
<p>RPC工作流程：</p>
<p>​    当客户端开始运行时会创建一个匿名独有回调队列。</p>
<p>​    RPC请求中，客户端消息带有两个属性：reply_to用来设置回调队列，correlation_id用来唯一标识每一个请求。</p>
<p>​    请求被发送到rpc_queue队列。</p>
<p>​    RPC worker（又称worker）在队列中守护，等待新请求。当请求到达，它会进行处理，然后把结果以消息的形式发送回客户端的队列，队列名便是客户端消息带有的reply_to的值。</p>
<p>​    客户端等待回调队列中的数据。当消息到达，检查它的correlation_id的值。如果符合客户端发送给RPC服务器中请求的值，客户端会返回响应内容到应用中。</p>
<h3 id="整合">整合</h3><p>斐波那契方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">fib</span><span class="params">($n)</span></span>&#123;</div><div class="line">  <span class="keyword">if</span>($n == <span class="number">0</span>)</div><div class="line">  	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">  <span class="keyword">if</span>($n == <span class="number">1</span>)</div><div class="line">  	<span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">  <span class="keyword">return</span> fib($n<span class="number">-1</span>) + fib($n<span class="number">-2</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>定义完斐波那契方法。假定它仅接受数字类型的输入。（别期望它能处理大的数字，它很可能非常慢的处理完。）</p>
<p>RPC服务处理程序rpc_server.php：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">require_once</span> <span class="keyword">__DIR__</span> . <span class="string">'/vendor/autoload.php'</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">PhpAmqpLib</span>\<span class="title">Connection</span>\<span class="title">AMQPStreamConnection</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">PhpAmqpLib</span>\<span class="title">Message</span>\<span class="title">AMQPMessage</span>;</div><div class="line"></div><div class="line">$connection = <span class="keyword">new</span> AMQPStreamConnection(<span class="string">'localhost'</span>, <span class="number">5672</span>, <span class="string">'guest'</span>, <span class="string">'guest'</span>);</div><div class="line">$channel = $connection-&gt;channel();</div><div class="line"></div><div class="line">$channel-&gt;queue_declare(<span class="string">'rpc_queue'</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>);</div><div class="line"></div><div class="line">fuction fib($n)&#123;</div><div class="line">  <span class="keyword">if</span>($n == <span class="number">0</span>)</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">  <span class="keyword">if</span>($n == <span class="number">1</span>)</div><div class="line">    <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">  </div><div class="line">  <span class="keyword">return</span> fib($n<span class="number">-1</span>) + fib($n<span class="number">-2</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">echo</span> <span class="string">" [x] Awaiting RPC requests\n"</span>;</div><div class="line"></div><div class="line">$callback = <span class="function"><span class="keyword">function</span><span class="params">($req)</span></span>&#123;</div><div class="line">  $n = intval($req-&gt;body);</div><div class="line">  <span class="keyword">echo</span> <span class="string">" [.] fib("</span>,$n,<span class="string">")\n"</span>;</div><div class="line">  </div><div class="line">  $msg = <span class="keyword">new</span> AMQPMessage(</div><div class="line">  	(string)fib($n),</div><div class="line">    <span class="keyword">array</span>(<span class="string">'correlation_id'</span> =&gt; $req-&gt;get(<span class="string">'correlation_id'</span>))</div><div class="line">  );</div><div class="line">  </div><div class="line">  $req-&gt;delivery_info[<span class="string">'channel'</span>]-&gt;basic_publish($msg, <span class="string">''</span>, $req-&gt;get(<span class="string">'reply_to'</span>));</div><div class="line">  $req-&gt;delivery_info[<span class="string">'channel'</span>]-&gt;basic_ack($req-&gt;delivery_info[<span class="string">'delivery_tag'</span>]);</div><div class="line">&#125;;</div><div class="line"></div><div class="line">$channel-&gt;basic_qos(<span class="keyword">null</span>, <span class="number">1</span>, <span class="keyword">null</span>);</div><div class="line">$channel-&gt;basic_consume(<span class="string">'rpc_queue'</span>, <span class="string">''</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, $callback);</div><div class="line"></div><div class="line"><span class="keyword">while</span>(count($channel-&gt;callbacks))&#123;</div><div class="line">  $channel-&gt;wait();</div><div class="line">&#125;</div><div class="line"></div><div class="line">$channel-&gt;close();</div><div class="line">$connection-&gt;close();</div><div class="line"></div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
<p>服务端代码相当简单：</p>
<p>​    和以往一样我们会从创建连接，频道，和声明队列开始</p>
<p>​    也许我们想要运行更多的进程。为了在多个服务器之间负载均衡，需要在$channel.basic_qos中设置prefech_count；</p>
<p>​    我们使用basic_consume访问队列。然后进入while循环等待请求消息，处理，然后返回响应消息。</p>
<p>RPC客户端 rpc_client.php：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">require_once</span> <span class="keyword">__DIR__</span> . <span class="string">'/vendor/autoload.php'</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">PhpAmqpLib</span>\<span class="title">Connection</span>\<span class="title">AMQPStreamConnection</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">PhpAmqpLib</span>\<span class="title">Message</span>\<span class="title">AMQPMessage</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">FibonacciRpcClient</span></span>&#123;</div><div class="line">	<span class="keyword">private</span> $connection;</div><div class="line">	<span class="keyword">private</span> $channel;</div><div class="line">	<span class="keyword">private</span> $callback_queue;</div><div class="line">	<span class="keyword">private</span> $response;</div><div class="line">	<span class="keyword">private</span> $corr_id;</div><div class="line">  </div><div class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</div><div class="line">		<span class="keyword">$this</span>-&gt;connection = <span class="keyword">new</span> AMQPStreamConnection(</div><div class="line">		  <span class="string">'localhost'</span>, <span class="number">5672</span>, <span class="string">'guest'</span>, <span class="string">'guest'</span></div><div class="line">		);</div><div class="line">		<span class="keyword">$this</span>-&gt;channel = <span class="keyword">$this</span>-&gt;connection-&gt;channel();</div><div class="line">		<span class="keyword">list</span>(<span class="keyword">$this</span>-&gt;callback_queue, ,) = <span class="keyword">$this</span>-&gt;channel-&gt;queue_declare(<span class="string">""</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">true</span>, <span class="keyword">false</span>);</div><div class="line">		<span class="keyword">$this</span>-&gt;channel-&gt;basic_consume(</div><div class="line">			<span class="keyword">$this</span>-&gt;callback_queue, <span class="string">''</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>,</div><div class="line">			<span class="keyword">array</span>(<span class="keyword">$this</span>, <span class="string">'on_response'</span>));</div><div class="line">	&#125;</div><div class="line">  </div><div class="line"> 	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">on_response</span><span class="params">($req)</span></span>&#123;</div><div class="line"> 		<span class="keyword">if</span>($req-&gt;get(<span class="string">'correlation_id'</span>) == <span class="keyword">$this</span>-&gt;corr_id)&#123;</div><div class="line"> 			<span class="keyword">$this</span>-&gt;response = $req-&gt;body;</div><div class="line"> 		&#125;</div><div class="line"> 	&#125;</div><div class="line">  	</div><div class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">call</span><span class="params">($n)</span></span>&#123;</div><div class="line">		<span class="keyword">$this</span>-&gt;response = <span class="keyword">null</span>;</div><div class="line">		<span class="keyword">$this</span>-&gt;corr_id = uniqid();</div><div class="line"></div><div class="line">		$msg = <span class="keyword">new</span> AMQPMessage(</div><div class="line">  		(string) $n,</div><div class="line">  		<span class="keyword">array</span>(</div><div class="line">  			<span class="string">'correlation_id'</span> =&gt; <span class="keyword">$this</span>-&gt;corr_id,</div><div class="line">  			<span class="string">'reply_to'</span> =&gt; <span class="keyword">$this</span>-&gt;callback_queue)</div><div class="line">  		);</div><div class="line">    )</div><div class="line">      </div><div class="line">    <span class="keyword">$this</span>-&gt;channel-&gt;basic_publish($msg, <span class="string">''</span>, <span class="string">'rpc_queue'</span>);</div><div class="line">    <span class="keyword">while</span>(!<span class="keyword">$this</span>-&gt;response)&#123;</div><div class="line">    	<span class="keyword">$this</span>-&gt;channel-&gt;wait();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> intval(<span class="keyword">$this</span>-&gt;response);</div><div class="line">  &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">$fibonacci_rpc = <span class="keyword">new</span> FibonacciRpcClient();</div><div class="line">$response = $fibonacci_rpc-&gt;call(<span class="number">30</span>);</div><div class="line"><span class="keyword">echo</span> <span class="string">" [.] Got "</span>, $response, <span class="string">"\n"</span>;</div><div class="line"></div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
<p>现在可以查看示例的完整代码了。<a href="https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/php/rpc_client.php" target="_blank" rel="external">rpc_client.php</a> 和 <a href="https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/php/rpc_server.php" target="_blank" rel="external">rpc_server.php</a>。</p>
<p>现在RPC服务端可以运行了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">php rpc_server.php</div><div class="line">[x] Awiting RPC resquests</div></pre></td></tr></table></figure>
<p>接收斐波那契数列运行：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">php</span> <span class="selector-tag">rpc_client</span><span class="selector-class">.php</span></div><div class="line"><span class="selector-attr">[x]</span> <span class="selector-tag">Requesting</span> <span class="selector-tag">fib</span>(30)</div></pre></td></tr></table></figure>
<p>这里展现的并不是RPC服务的唯一可能实现，但它有一些重要的优势：</p>
<p>​    如果RPC服务太慢，可以按比例增加运行数量。试试在新控制台裕兴第二个rpc_server.php服务。</p>
<p>​    在客户端，RPC要求只发送和接收一条消息。不能有像队列声明一样的异步调用。结果就是，对于单一的RPC请求，客户端仅需要一个网络往返。</p>
<p>现在的代码还是过于简单，并没有想解决更复杂（更重要）的问题，比如：</p>
<p>​    要是没有服务端守护运行，客户端作何反应？</p>
<p>​    RPC客户端是否需要设置超时？</p>
<p>​    如果服务端引发异常，是否该把它发送到客户端？</p>
<p>​    处理前阻止无效消息（如检查范围，类型）进入？</p>
<p>如果想尝试，可以在<a href="https://www.rabbitmq.com/plugins.html" target="_blank" rel="external">rabbitmq-management</a> 里找到一些有用的查看队列的插件。</p>
<p>原文地址：<a href="https://www.rabbitmq.com/tutorials/tutorial-six-php.html" target="_blank" rel="external">Remote procedure call (RPC)</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.qichengzx.com/2016/05/03/php-rabbitmq-tutorial-six.html" data-id="ciwcxcuki001u7p3gww60718d" class="article-share-link">Share</a>
      
        <a href="http://www.qichengzx.com/2016/05/03/php-rabbitmq-tutorial-six.html#comments" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/php/">php</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/rabbitmq/">rabbitmq</a></li></ul>

    </footer>
  </div>
  
</article>


  
  
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
    </nav>
  
</section>
        
          <aside id="sidebar">
  
    	<div class="widget-wrap">
		<h3 class="widget-title">Time</h3>
		<div class="widget time">
			<style id="clock-animations"></style>
			<div class="clock-wrapper">
				<div class="clock-base">
						<div class="clock-indicator">
							<div></div>
							<div></div>
							<div></div>
							<div></div>
							<div></div>
							<div></div>
							<div></div>
							<div></div>
							<div></div>
							<div></div>
							<div></div>
							<div></div>
						</div>
						<div class="clock-hour"></div>
						<div class="clock-minute"></div>
						<div class="clock-second"></div>
						<div class="clock-center"></div>
				</div>
			</div>
		</div>
	</div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/golang/">golang</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/javascript/">javascript</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/mysql/">mysql</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/php/">php</a><span class="category-list-count">11</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/ECharts/">ECharts</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/crontab/">crontab</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/discuz/">discuz</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dropbox/">dropbox</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/excel/">excel</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/fetch/">fetch</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gin/">gin</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/">git</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/go/">go</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/goquery/">goquery</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/">hexo</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/https/">https</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/input/">input</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/javascript/">javascript</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/js/">js</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/laravel/">laravel</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/">linux</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/">mysql</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/node/">node</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pdo/">pdo</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/php/">php</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rabbitmq/">rabbitmq</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/react-native/">react-native</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/redis/">redis</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ssl/">ssl</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/time/">time</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vps/">vps</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/widget/">widget</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/标识符/">标识符</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/爱奇艺/">爱奇艺</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/糗百/">糗百</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/网络请求/">网络请求</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/队列/">队列</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/ECharts/" style="font-size: 10px;">ECharts</a> <a href="/tags/crontab/" style="font-size: 10px;">crontab</a> <a href="/tags/discuz/" style="font-size: 10px;">discuz</a> <a href="/tags/dropbox/" style="font-size: 12px;">dropbox</a> <a href="/tags/excel/" style="font-size: 10px;">excel</a> <a href="/tags/fetch/" style="font-size: 10px;">fetch</a> <a href="/tags/gin/" style="font-size: 10px;">gin</a> <a href="/tags/git/" style="font-size: 10px;">git</a> <a href="/tags/go/" style="font-size: 16px;">go</a> <a href="/tags/goquery/" style="font-size: 10px;">goquery</a> <a href="/tags/hexo/" style="font-size: 14px;">hexo</a> <a href="/tags/https/" style="font-size: 10px;">https</a> <a href="/tags/input/" style="font-size: 10px;">input</a> <a href="/tags/javascript/" style="font-size: 14px;">javascript</a> <a href="/tags/js/" style="font-size: 12px;">js</a> <a href="/tags/laravel/" style="font-size: 10px;">laravel</a> <a href="/tags/linux/" style="font-size: 10px;">linux</a> <a href="/tags/mysql/" style="font-size: 18px;">mysql</a> <a href="/tags/node/" style="font-size: 10px;">node</a> <a href="/tags/pdo/" style="font-size: 10px;">pdo</a> <a href="/tags/php/" style="font-size: 20px;">php</a> <a href="/tags/rabbitmq/" style="font-size: 18px;">rabbitmq</a> <a href="/tags/react-native/" style="font-size: 10px;">react-native</a> <a href="/tags/redis/" style="font-size: 12px;">redis</a> <a href="/tags/ssl/" style="font-size: 10px;">ssl</a> <a href="/tags/time/" style="font-size: 10px;">time</a> <a href="/tags/vps/" style="font-size: 10px;">vps</a> <a href="/tags/widget/" style="font-size: 10px;">widget</a> <a href="/tags/标识符/" style="font-size: 10px;">标识符</a> <a href="/tags/爱奇艺/" style="font-size: 10px;">爱奇艺</a> <a href="/tags/糗百/" style="font-size: 10px;">糗百</a> <a href="/tags/网络请求/" style="font-size: 10px;">网络请求</a> <a href="/tags/队列/" style="font-size: 10px;">队列</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">October 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">May 2016</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">February 2016</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">January 2016</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">November 2015</a><span class="archive-list-count">7</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2016/12/04/go-qiubai.html">Go语言写爬取糗百热门帖子</a>
          </li>
        
          <li>
            <a href="/2016/11/02/install-yaf-on-mac.html">Mac brew php7.1环境下安装Yaf</a>
          </li>
        
          <li>
            <a href="/2016/10/21/beego-in-docker.html">用Docker部署Golang Beego框架应用</a>
          </li>
        
          <li>
            <a href="/2016/09/28/custom-data-pagination-in-laravel-with-arrays.html">Laravel 手动创建分页</a>
          </li>
        
          <li>
            <a href="/2016/09/16/convert-xml-to-json-in-golang.html">Golang XMl 转 JSON</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 qichengzx<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
      Hosted by <a href="https://www.digitalocean.com/?refcode=2cb067f6a1f0" target="_blank">DigitalOcean</a>
    </div>
  </div>
</footer>
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?199f8980952ead3f1af440507b4b2a7c";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>